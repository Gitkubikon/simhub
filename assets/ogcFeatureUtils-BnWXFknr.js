import{b as e,fy as n,fz as t,bZ as i,ff as a,fe as s,aY as r,I as o,fA as l,fj as c,fi as u,bh as d,fd as f,ej as m,n as g,fB as p}from"./index-DSIPxOWi.js";import{E as y,I as w,N as b}from"./geojson-CFL0cZN1.js";import{o as h}from"./clientSideDefaults-Cn_svm8L.js";import{p as j}from"./sourceUtils-BFIlJ45V.js";const F=()=>g.getLogger("esri.layers.ogc.ogcFeatureUtils"),I="startindex",T=new Set([I,"offset"]),k="http://www.opengis.net/def/crs/",x=`${k}OGC/1.3/CRS84`;var S,J;async function v(o,l,c={},u=5){const{links:d}=o,f=L(d,"items",S.geojson)||L(d,"http://www.opengis.net/def/rel/ogc/1.0/items",S.geojson);if(null==f)throw new e("ogc-feature-layer:missing-items-page","Missing items url");const{apiKey:g,customParameters:p,signal:b}=c,j=n(f.href,o.landingPage.url),k={limit:u,...p,token:g},x=t(j,k),J={accept:S.geojson},{data:z}=await i(x,{signal:b,headers:J}),B=function A(e,n,t){var i;if(!t)return;const a=L(t,"next",S.geojson),s=null==(i=m(null==a?void 0:a.href))?void 0:i.query;if(!s)return;const r=m(e).query,o=Object.keys(r??{}),l=Object.entries(s).filter((([e])=>!o.includes(e))).find((([e,t])=>T.has(e.toLowerCase())&&Number.parseInt(t,10)===n)),c=null==l?void 0:l[0];return c}(x,u,z.links)??I;y(z);const E=w(z,{geometryType:l.geometryType}),_=l.fields||E.fields||[],Q=null!=l.hasZ?l.hasZ:E.hasZ,V=E.geometryType,Y=l.objectIdField||E.objectIdFieldName||"OBJECTID";let H=l.timeInfo;const X=_.find((({name:e})=>e===Y));if(X)X.editable=!1,X.nullable=!1;else{if(!E.objectIdFieldType)throw new e("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");_.unshift({name:Y,alias:Y,type:"number"===E.objectIdFieldType?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if(Y!==E.objectIdFieldName){const e=_.find((({name:e})=>e===E.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}_===E.fields&&E.unknownFields.length>0&&F().warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:E.unknownFields}});for(const n of _){if(null==n.name&&(n.name=n.alias),null==n.alias&&(n.alias=n.name),"esriFieldTypeOID"!==n.type&&"esriFieldTypeGlobalID"!==n.type&&(n.editable=null==n.editable||!!n.editable,n.nullable=null==n.nullable||!!n.nullable),!n.name)throw new e("ogc-feature-layer:invalid-field-name","field name is missing",{field:n});if(!a.jsonValues.includes(n.type))throw new e("ogc-feature-layer:invalid-field-type",`invalid type for field "${n.name}"`,{field:n})}if(H){const e=new s(_);if(H.startTimeField){const n=e.get(H.startTimeField);n?(H.startTimeField=n.name,n.type="esriFieldTypeDate"):H.startTimeField=null}if(H.endTimeField){const n=e.get(H.endTimeField);n?(H.endTimeField=n.name,n.type="esriFieldTypeDate"):H.endTimeField=null}if(H.trackIdField){const n=e.get(H.trackIdField);n?H.trackIdField=n.name:(H.trackIdField=null,F().warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:H}}))}H.timeReference||(H.timeReference={timeZoneIANA:r}),H.startTimeField||H.endTimeField||(F().warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:H}}),H=void 0)}return{drawingInfo:V?h(V):null,extent:K(o),geometryType:V,fields:_,hasZ:!!Q,objectIdField:Y,paginationParameter:B,timeInfo:H}}async function N(t,a={}){const{links:s,url:r}=t,o=L(s,"data",S.json)||L(s,"http://www.opengis.net/def/rel/ogc/1.0/data",S.json);if(null==o)throw new e("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:l,customParameters:c,signal:u}=a,d=n(o.href,r),{data:f}=await i(d,{signal:u,headers:{accept:S.json},query:{...c,token:l}});for(const e of f.collections)e.landingPage=t;return f}async function O(t,a={}){const{links:s,url:r}=t,o=L(s,"conformance",S.json)||L(s,"http://www.opengis.net/def/rel/ogc/1.0/conformance",S.json);if(null==o)throw new e("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:l,customParameters:c,signal:u}=a,d=n(o.href,r),{data:f}=await i(d,{signal:u,headers:{accept:S.json},query:{...c,token:l}});return f}async function P(e,n={}){const{apiKey:t,customParameters:a,signal:s}=n,{data:r}=await i(e,{signal:s,headers:{accept:S.json},query:{...a,token:t}});return r.url=e,r}async function q(e,t={}){const{links:a,url:s}=e,r=L(a,"service-desc",S.openapi);if(null==r)return F().warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:o,customParameters:l,signal:c}=t,u=n(r.href,s),{data:d}=await i(u,{signal:c,headers:{accept:S.openapi},query:{...l,token:o}});return d}function C(e){const n=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),t=null==n?void 0:n.groups;if(!t)return null;const{authority:i,code:a}=t;switch(i.toLowerCase()){case"ogc":switch(a.toLowerCase()){case"crs27":return o.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return o.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(a,10);return Number.isNaN(e)?null:e}default:return null}}async function R(e,n,t){const i=await $(e,n,t);return l(i)}async function $(t,a,r){const{collection:{links:l,landingPage:{url:m}},layerDefinition:g,maxRecordCount:y,queryParameters:{apiKey:w,customParameters:h},spatialReference:I,supportedCrs:T}=t,k=L(l,"items",S.geojson)||L(l,"http://www.opengis.net/def/rel/ogc/1.0/items",S.geojson);if(null==k)throw new e("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:x,num:J,start:z,timeExtent:B,where:E}=a;if(a.objectIds)throw new e("ogc-feature-layer:query-by-objectids-not-supported","Queries with object ids are not supported");const _=o.fromJSON(I),Q=a.outSpatialReference??_,V=Q.isWGS84?null:W(Q,T),Y=function U(e,n){if(!function G(e){return null!=e&&"extent"===e.type}(e))return null;const{spatialReference:t}=e;if(!t||t.isWGS84)return{bbox:D(e)};const i=W(t,n);return null!=i?{bbox:D(e),"bbox-crs":i}:t.isWebMercator?{bbox:D(d(e,o.WGS84))}:null}(x,T),H=function M(e){if(null==e)return null;const{start:n,end:t}=e;return`${null!=n?n.toISOString():".."}/${null!=t?t.toISOString():".."}`}(B),X=function Z(e){return null!=e&&e&&"1=1"!==e?e:null}(E),ee=J??(null==z?y:10),ne=0===z?void 0:z,{fields:te,geometryType:ie,hasZ:ae,objectIdField:se,paginationParameter:re}=g,oe=n(k.href,m),{data:le}=await i(oe,{...r,query:{...h,...Y,crs:V,datetime:H,query:X,limit:ee,[re]:ne,token:w},headers:{accept:S.geojson}}),ce=b(le,{geometryType:ie,hasZ:ae,objectIdField:se}),ue=ce.length===ee&&!!L(le.links??[],"next",S.geojson),de=new s(te);for(const e of ce){const n={};j(de,n,e.attributes),n[se]=e.attributes[se],e.attributes=n}if(!V&&Q.isWebMercator)for(const e of ce)if(null!=e.geometry&&null!=ie){const n=c(e.geometry,ie,ae,!1);n.spatialReference=o.WGS84,e.geometry=u(d(n,Q))}for(const e of ce)e.objectId=e.attributes[se];const fe=V||!V&&Q.isWebMercator?Q.toJSON():f,me=new p;return me.exceededTransferLimit=ue,me.features=ce,me.fields=te,me.geometryType=ie,me.hasZ=ae,me.objectIdFieldName=se,me.spatialReference=fe,me}function W(e,n){const{isWebMercator:t,wkid:i}=e;if(!i)return null;const a=t?n[3857]??n[102100]??n[102113]??n[900913]:n[e.wkid];return a?`${k}${a}`:null}function D(e){if(null==e)return"";const{xmin:n,ymin:t,xmax:i,ymax:a}=e;return`${n},${t},${i},${a}`}function K(e){var n;const t=null==(n=e.extent)?void 0:n.spatial;if(!t)return null;const i=t.bbox[0],a=4===i.length,[s,r]=i,l=a?void 0:i[2];return{xmin:s,ymin:r,xmax:a?i[2]:i[3],ymax:a?i[3]:i[4],zmin:l,zmax:a?void 0:i[5],spatialReference:o.WGS84.toJSON()}}function L(e,n,t){return e.find((({rel:e,type:i})=>e===n&&i===t))??e.find((({rel:e,type:t})=>e===n&&!t))}(J=S||(S={})).json="application/json",J.geojson="application/geo+json",J.openapi="application/vnd.oai.openapi+json;version=3.0";export{$,C,N,O,P,R,k,q,v,x};
