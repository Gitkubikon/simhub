import{mc as t,md as n,me as o,mf as s,b as l,gU as u,bZ as i,bJ as c,mg as f,mh as m,ak as d,mi as p,mj as g,mk as x,ml as y,cj as T,cv as v,mm as h,kc as b,mn as w,mo as B,lm as C,mp as S,mq as A,mr as E,ms as M,mt as R,ly as _,mu as j,lz as $,mv as F,lA as O,lC as I,lB as z,mw as P,mx as L,lD as k,hq as q,br as D,bM as G,my as U,lE as N,mz as V,ge as le,mA as ue}from"./index-DSIPxOWi.js";import{M as ie}from"./vertexSpaceConversion-C_GU75pR.js";function r(n,o){return new n(new ArrayBuffer(o*n.ElementCount*t(n.ElementType)))}async function K(t,g,x){const y=new n(function Q(t){const n=null==t?void 0:t.resolveFile;return n?{busy:!1,request:async(t,o,s)=>{const l=(null==n?void 0:n(t))??t,u="image"===o?"image":"binary"===o||"image+type"===o?"array-buffer":"json";return(await i(l,{responseType:u,signal:null==s?void 0:s.signal,timeout:0})).data}}:null}(x)),T=(await o(y,g,x,!0)).model,v=T.lods.shift(),h=new Map,b=new Map;T.textures.forEach(((t,n)=>h.set(n,function X(t){return new f({data:(m(t.data),t.data),wrap:re(t.parameters.wrap)})}(t)))),T.materials.forEach(((t,n)=>b.set(n,function Y(t,n){const o=new d(function se(t,n){return D(ne(t[0]),ne(t[1]),ne(t[2]),n)}(t.color,t.opacity)),s=t.emissiveFactor?new d(function ae(t){return G(ne(t[0]),ne(t[1]),ne(t[2]))}(t.emissiveFactor)):null,a=t=>t?new V({scale:t.scale?[t.scale[0],t.scale[1]]:[1,1],rotation:le(t.rotation??0),offset:t.offset?[t.offset[0],t.offset[1]]:[0,0]}):null;return new p({color:o,colorTexture:n.get(t.textureColor),normalTexture:n.get(t.textureNormal),emissiveColor:s,emissiveTexture:n.get(t.textureEmissive),occlusionTexture:n.get(t.textureOcclusion),alphaMode:te(t.alphaMode),alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,metallic:t.metallicFactor,roughness:t.roughnessFactor,metallicRoughnessTexture:n.get(t.textureMetallicRoughness),colorTextureTransform:a(t.colorTextureTransform),normalTextureTransform:a(t.normalTextureTransform),occlusionTextureTransform:a(t.occlusionTextureTransform),emissiveTextureTransform:a(t.emissiveTextureTransform),metallicRoughnessTextureTransform:a(t.metallicRoughnessTextureTransform)})}(t,h))));const w=function W(t){let n=0;const o={color:!1,tangent:!1,normal:!1,texCoord0:!1},s=new Map,l=new Map,u=[];for(const i of t.parts){const{attributes:{position:t,normal:f,color:m,tangent:d,texCoord0:p}}=i,g=`\n      ${H(t,s)}/\n      ${H(f,s)}/\n      ${H(m,s)}/\n      ${H(d,s)}/\n      ${H(p,s)}/\n      ${J(i.transform)}\n    `;let x=!1;const y=c(l,g,(()=>(x=!0,{start:n,length:t.count})));x&&(n+=t.count),f&&(o.normal=!0),m&&(o.color=!0),d&&(o.tangent=!0),p&&(o.texCoord0=!0),u.push({gltf:i,writeVertices:x,region:y})}return{vertexAttributes:{position:r(U,n),normal:o.normal?r(z,n):null,tangent:o.tangent?r(_,n):null,color:o.color?r($,n):null,texCoord0:o.texCoord0?r(N,n):null},parts:u,components:[]}}(v);for(const n of w.parts)Z(w,n,b);const{position:B,normal:C,tangent:S,color:A,texCoord0:E}=w.vertexAttributes,M=s(t,x),R=t.spatialReference.isGeographic?s(t):M,j=ie({vertexAttributes:{position:B.typedBuffer,normal:null==C?void 0:C.typedBuffer,tangent:null==S?void 0:S.typedBuffer},vertexSpace:R,spatialReference:t.spatialReference},M,{allowBufferReuse:!0,sourceUnit:"meters"});if(!j)throw new l("loadGLTFMesh()","Failed to load mesh from glTF due to projection errors");return{transform:null,vertexSpace:M,components:w.components,spatialReference:t.spatialReference,vertexAttributes:new u({...j,color:null==A?void 0:A.typedBuffer,uv:null==E?void 0:E.typedBuffer})}}function H(t,n){if(null==t)return"-";const o=t.typedBuffer;return`${c(n,o.buffer,(()=>n.size))}/${o.byteOffset}/${o.byteLength}`}function J(t){return null!=t?t.toString():"-"}function Z(t,n,o){n.writeVertices&&function ee(t,n){const{position:o,normal:s,tangent:l,color:u,texCoord0:i}=t.vertexAttributes,c=n.region.start,{attributes:f,transform:m}=n.gltf,d=f.position.count;if(y(o.slice(c,d),f.position,m),null!=f.normal&&null!=s){const t=T(v(),m),n=s.slice(c,d);h(n,f.normal,t),b(t)&&w(n,n)}else null!=s&&B(s,0,0,1,{dstIndex:c,count:d});if(null!=f.tangent&&null!=l){const t=C(v(),m),n=l.slice(c,d);S(n,f.tangent,t),b(t)&&A(n,n)}else null!=l&&E(l,0,0,1,1,{dstIndex:c,count:d});if(null!=f.texCoord0&&null!=i?M(i.slice(c,d),f.texCoord0):null!=i&&R(i,0,0,{dstIndex:c,count:d}),null!=f.color&&null!=u){const t=f.color,n=u.slice(c,d);if(4===t.elementCount)t instanceof _?j(n,t,255):t instanceof $?F(n,t):t instanceof O&&j(n,t,1/256);else{E(n,255,255,255,255);const o=I.fromTypedArray(n.typedBuffer,n.typedBufferStride);t instanceof z?P(o,t,255):t instanceof I?L(o,t):t instanceof k&&P(o,t,1/256)}}else null!=u&&E(u.slice(c,d),255,255,255,255)}(t,n);const{indices:s,attributes:l,primitiveType:u,material:i}=n.gltf;let c=g(s||l.position.count,u);const f=n.region.start;if(f){const t=new Uint32Array(c);for(let n=0;n<c.length;n++)t[n]+=f;c=t}t.components.push(new x({name:n.gltf.name,faces:c,material:o.get(i),shading:l.normal?"source":"flat",trustSourceNormals:!0}))}function te(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function re(t){return{horizontal:oe(t.s),vertical:oe(t.t)}}function oe(t){switch(t){case q.CLAMP_TO_EDGE:return"clamp";case q.MIRRORED_REPEAT:return"mirror";case q.REPEAT:return"repeat"}}function ne(t){return t**(1/ue)*255}Object.freeze(Object.defineProperty({__proto__:null,copy:function e$1(t,n,o){const s=t.typedBuffer,l=t.typedBufferStride,u=n.typedBuffer,i=n.typedBufferStride,c=o?o.count:n.count;let f=((null==o?void 0:o.dstIndex)??0)*l,m=((null==o?void 0:o.srcIndex)??0)*i;for(let d=0;d<c;++d){for(let t=0;t<9;++t)s[f+t]=u[m+t];f+=l,m+=i}}},Symbol.toStringTag,{value:"Module"})),Object.freeze(Object.defineProperty({__proto__:null,copy:function e(t,n,o){const s=t.typedBuffer,l=t.typedBufferStride,u=n.typedBuffer,i=n.typedBufferStride,c=o?o.count:n.count;let f=((null==o?void 0:o.dstIndex)??0)*l,m=((null==o?void 0:o.srcIndex)??0)*i;for(let d=0;d<c;++d){for(let t=0;t<16;++t)s[f+t]=u[m+t];f+=l,m+=i}}},Symbol.toStringTag,{value:"Module"}));export{K as loadGLTFMesh};
