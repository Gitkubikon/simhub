import{q2 as e,ak as t,q3 as i,lf as n,q4 as u,b as f,q5 as v,q6 as y,hX as x,b3 as S,q7 as M,dL as O,oz as E,cj as T,bE as V,i9 as $,q8 as q,cv as G,e as U,y as j,a as B,S as z,gT as Q,a8 as J,a0 as K,m as X,as as Z,q9 as Y,W as ee,fD as te,qa as ie,qb as se,ip as ne,bq as re,qc as oe,bo as ae,lx as le,hq as de,qd as he,qe as ue,aM as ce,qf as ge,hp as _e,le as me,lw as fe,d5 as pe,er as ve,hr as be,qg as ye,qh as xe,fy as Ne,bn as Ce,qi as Ie,qj as we,qk as Se,ql as Me,Q as Re,ce as De,ec as Pe,qm as Fe,lM as Le,qn as Oe,e2 as Ae,qo as Ee,hv as Te,qp as Ve,N as $e,gi as ke,dB as qe,hM as Ge,qq as Ue,dN as je,e1 as Be,qr as ze,kH as He,du as Qe,iq as Je,pP as We,qs as Ke,qt as Xe,qu as Ze,qv as Ye,dC as et,mW as tt,oT as it,qw as st,qx as nt,p3 as rt,e6 as ot,dt as at,hP as lt,cx as dt,dD as ht,qy as ut,dy as ct,bb as gt,qz as _t,qA as mt,a9 as ft,qB as pt,g as vt,P as bt,i as yt,pX as xt,n as Nt,cG as Ct,qC as It,pc as wt,qD as St,qE as Mt,qF as Rt,pN as Dt,V as Pt,ac as Ft,u as Lt,z as Ot,a7 as At,gQ as Et,G as Tt,aC as Vt,qG as $t,qH as kt,mJ as qt,mK as Gt,qI as Ut,qJ as jt,bZ as Bt,oW as zt,eX as Ht}from"./index-DSIPxOWi.js";import{a as Qt,s as Jt}from"./RenderTexture-DbJC7CTU.js";import{d as Wt,s as Kt,h as Xt,o as Zt,r as Yt,l as ei,c as ti,a as ii}from"./I3SNode-mlgend4K.js";import{s as si}from"./ReactiveSet-XbWJTkHf.js";import{assetMapFromAssetMapsJSON as ni,extractMesh as ri}from"./meshFeatureSet-BNHS2qnT.js";import oi from"./FeatureLayerView3D-C33G2_Ur.js";var ai,li,di;async function m$1(e,t,i,n){if(null==e)return-1;const x=i.length,S=e.data,M=e.url;if(null!=S){if(S instanceof HTMLImageElement||S instanceof HTMLCanvasElement){const e=u(S);return i.push({id:x,usage:n,data:e,encoding:ai.PNG,downsampled:!1}),t.push({id:x,usage:n,encodings:[{name:void 0,encoding:ai.PNG}]}),x}if(S instanceof HTMLVideoElement)return-1;if(S instanceof ImageData)throw new f("ImageData textures not supported yet for client side I3S nodes");if(S instanceof v)throw new f("EncodedMeshTexture textures not supported yet for client side I3S nodes")}else if(null!=M){const e=new Image;e.src=M;const f=await y(e,e.src,!1,void 0),v=u(f);return i.push({id:x,usage:n,data:v,encoding:ai.PNG,downsampled:!1}),t.push({id:x,usage:n,encodings:[{name:void 0,encoding:ai.PNG}]}),x}return-1}(di=ai||(ai={}))[di.KTX2=1]="KTX2",di[di.Basis=2]="Basis",di[di.DDS_S3TC=4]="DDS_S3TC",di[di.PNG=8]="PNG",di[di.JPG=16]="JPG",di[di.KTX_ETC2=32]="KTX_ETC2",function(e){e[e.None=0]="None",e[e.Color=1]="Color",e[e.MetallicRoughness=2]="MetallicRoughness",e[e.Normal=4]="Normal",e[e.Occlusion=8]="Occlusion",e[e.Emissive=16]="Emissive",e[e.AlphaMask=32]="AlphaMask",e[e.ColorTextures=19]="ColorTextures",e[e.GeometryTextures=36]="GeometryTextures",e[e.GeometryTexturesPBR=44]="GeometryTexturesPBR",e[e.AllTextures=37]="AllTextures",e[e.AllTexturesPBR=63]="AllTexturesPBR"}(li||(li={}));let hi=class h{constructor(e,t,i,n){this._uid=e,this._worker=n,this._id2Meta=new Map,this._oid2Meta=new Map,this._indexSR=t.indexSR,this._vertexSR=t.vertexSR,this._renderSR=t.renderSR,this._localMode=t.localMode,this._memCache=i.newCache(`sl-client-mesh-data-${this._uid}`)}get uid(){return this._uid}get worker(){return this._worker}get indexSR(){return this._indexSR}get renderSR(){return this._renderSR}createMeshNodeInfo(e,t){const i=`mesh${t}`,n=e.extent,u=n.spatialReference,f=this._indexSR,v=function p(e,t){const{spatialReference:i}=e,n=[1,-1],u=[.5*e.width,.5*e.height,e.hasZ?.5*(e.zmax-e.zmin):0],f=i.isGeographic?i.metersPerUnit:1,v=e.center;let y=0;if(e.hasZ)for(let x=0;x<2;++x)for(let e=0;e<2;++e)for(let i=0;i<2;++i){const S=(v.x+n[x]*u[0]-t.x)*f,M=(v.y+n[e]*u[1]-t.y)*f,O=v.z+n[i]*u[2]-t.z;y=Math.max(S*S+M*M+O*O,y)}else for(let x=0;x<2;++x)for(let e=0;e<2;++e){const i=(v.x+n[x]*u[0]-t.x)*f,S=(v.y+n[e]*u[1]-t.y)*f;y=Math.max(i*i+S*S,y)}return M([t.x,t.y,t.z],Math.sqrt(y))}(n,e.origin);return Qt(v,u,v,f),{type:"mesh",id:i,version:M$3(e),oid:t,mbs:v,componentNodeIds:[],unloadedMesh:e,nodeIndex:null,loadMeshPromise:null}}addMeshNode(e,t){if(null!=this.getMeshNodeIndex(t.oid))throw new f(`I3SClientNodeLoader: client side mesh for feature oid=${t.oid} already exists`);t.nodeIndex=e,this._id2Meta.set(t.id,t),this._oid2Meta.set(t.oid,t)}getMeshNodeIndex(e){const t=this._oid2Meta.get(e);return null==t||"mesh"!==t.type?null:t.nodeIndex}getMeshNodeInfo(e){const t=this._oid2Meta.values();for(const i of t)if("mesh"===i.type&&i.id===e)return i;return null}removeNode(e){const t=this._id2Meta.get(e);null!=t&&(this._id2Meta.delete(e),"mesh"===t.type&&this._oid2Meta.delete(t.oid))}async loadNodeJSON(e){const t=this._id2Meta.get(e);if(null==t)throw new f(`I3SClientNodeLoader::loadNodeJSON unable to find node ${e}`);switch(t.type){case"mesh":return this._loadMeshNodeJSON(t);case"mesh-component":return async function f$1(e){return{id:e.id,version:e.meshNodeInfo.version,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null,isEmpty:!1}}(t);default:throw new f(`I3SClientNodeLoader::loadNodeJSON unable to handle node ${e}`)}}async _loadMeshNodeJSON(e){const t=e.id,i=(await this._getMeshData(e)).loadedMesh;if(null==i.components||0===i.components.length)return{id:t,version:null,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null};const n=[],u=i.components;for(let f=0;f<u.length;++f){const i=`${t}-component${f}`,u={type:"mesh-component",id:i,mbs:e.mbs,componentIndex:f,meshNodeInfo:e,textureData:new Map};this._id2Meta.set(u.id,u),e.componentNodeIds.push(i),n.push({id:u.id,href:null,mbs:u.mbs,obb:null})}return{id:t,version:null,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:n}}updateNodeIndex(e,t,i){const n=this._id2Meta.get(e);n&&"mesh"===n.type&&(n.nodeIndex=i)}async loadNodeData(u,v){const y=this._id2Meta.get(u);if(null==y||"mesh-component"!==y.type)throw new f(`Failed to load client node data for node ${u} (unexpected node info)`);const M=y.meshNodeInfo,V=await this._getMeshData(M),$=V.loadedMesh,q=M.oid;if(null==$.components)throw new f(`Failed to load client node data for node ${u} (unexpected null reference)`);const U=$.components[y.componentIndex],{material:j,requiredTextures:B,textureData:z}=await async function c$2(u){const f=[],v=[];if(null==u)return{material:{alphaMode:"opaque",alphaCutoff:.1,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[1,1,1,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6000000238418579},wrapTextures:!1,hasParametersFromSource:!0},requiredTextures:f,textureData:v};const y=function d$1(e){return e.hasOwnProperty("metallicRoughnessTexture")}(u);u.alphaMode;const x=e({normalTexture:u.normalTexture,emissiveTexture:y?u.emissiveTexture:null,emissiveFactor:y?t.toUnitRGB(u.emissiveColor):null,occlusionTexture:y?u.occlusionTexture:null,metallicRoughnessTexture:y?u.metallicRoughnessTexture:null,metallicFactor:y?u.metallic:null,roughnessFactor:y?u.roughness:null}),S=x?i[0]:y?u.metallic:0,M=x?i[1]:y?u.roughness:0;return{material:{alphaMode:"auto"===u.alphaMode?"blend":u.alphaMode,alphaCutoff:u.alphaCutoff,doubleSided:u.doubleSided,cullFace:u.doubleSided?n.None:n.Back,normalTextureId:await m$1(u.normalTexture,f,v,li.Normal),emissiveTextureId:y?await m$1(u.emissiveTexture,f,v,li.Emissive):-1,occlusionTextureId:y?await m$1(u.occlusionTexture,f,v,li.Occlusion):-1,emissiveFactor:y&&null!=u.emissiveColor?t.toUnitRGB(u.emissiveColor):[0,0,0],metallicRoughness:{baseColorFactor:null!=u.color?t.toUnitRGBA(u.color):[1,1,1,1],baseColorTextureId:await m$1(u.colorTexture,f,v,li.Color),metallicRoughnessTextureId:y?await m$1(u.metallicRoughnessTexture,f,v,li.MetallicRoughness):-1,metallicFactor:S,roughnessFactor:M},wrapTextures:!0,hasParametersFromSource:x},requiredTextures:f,textureData:v}}(U.material);if(null!=z)for(const e of z)null!=e&&y.textureData.set(e.id,e);const Q={params:{material:j},type:"ArrayBufferView"},{vertexSpace:J,origin:K,transform:X}=$,Z=[K.x,K.y,K.z??0];V.projectionPromise||(x(this._worker,"SceneLayerWorker is needed to project mesh"),V.projectionPromise=this._worker.project({positions:$.vertexAttributes.position,localMatrix:null==X?void 0:X.localMatrix,vertexSpace:J.toJSON(),origin:Z,inSpatialReference:$.spatialReference.toJSON(),outSpatialReference:this._vertexSR.toJSON(),localMode:this._localMode},v));const{projected:Y,original:ee,projectedOrigin:te}=await V.projectionPromise;$.vertexAttributes.position=ee;const{transformed:ie,original:se}=await async function x$2(e,t,i,n){const{transform:u,vertexAttributes:f}=t.loadedMesh,v="source"===e.shading?f.normal:null;if(null==v||null==u||0===u.rotationAngle&&O(u.scale,E))return{transformed:v,original:f.normal};if(!t.normalsTransformPromise){x(i,"SceneLayerWorker is needed to transform mesh normals");const e=G();T(e,u.localMatrix),t.normalsTransformPromise=i.transformNormals({normalMatrix:e,normals:v},n)}return t.normalsTransformPromise}(U,V,this._worker,v);$.vertexAttributes.normal=se,S(v);const{geometryBuffer:ne,geometryDescriptor:re}=function y$1(e,t,i,n,u,f){const v=1,y=t.length/3,x=3*y;let S=0,M=0,O=!1,E=0,T=!1,V=0,$=!1,q=0,G=0,U=0;S+=ui,S+=ui,M=S,S+=3*x*ci,null!=i&&(O=!0,E=S,S+=3*x*ci),null!=n&&(T=!0,V=S,S+=2*x*ci),null!=u&&($=!0,q=S,S+=4*x*gi),G=S,S+=v*_i,U=S,S+=2*v*ui;const j=new ArrayBuffer(S),B=new Uint8Array(j);g$1(B,0,x),g$1(B,ui,v);const z=new Float32Array(j,M),Q=null!=i?new Float32Array(j,E):null,J=null!=n?new Float32Array(j,V):null,K=null!=u?new Uint8Array(j,q):null;for(let X=0;X<y;++X){const f=3*X;for(let v=0;v<3;++v){const y=t[f+v],x=3*y,S=9*X+3*v;if(z[S]=e[x],z[S+1]=e[x+1],z[S+2]=e[x+2],null!=Q&&(Q[S]=i[x],Q[S+1]=i[x+1],Q[S+2]=i[x+2]),null!=J){const e=2*y,t=6*X+2*v;J[t]=n[e],J[t+1]=n[e+1]}if(null!=K){const e=4*y,t=12*X+4*v;K[t]=u[e],K[t+1]=u[e+1],K[t+2]=u[e+2],K[t+3]=u[e+3]}}}return g$1(B,G,f),g$1(B,G+ui,f/2**32),g$1(B,U,0),g$1(B,U+ui,y-1),{geometryBuffer:j,geometryDescriptor:{isDraco:!1,isLegacy:!0,color:$,normal:O,uv0:T,uvRegion:!1,featureIndex:!0}}}(Y,U.faces,ie,$.vertexAttributes.uv,$.vertexAttributes.color,q);return{geometryData:{featureDataPosition:te,featureIds:[],geometries:[Q]},attributeDataInfo:{attributeData:{},loadedAttributes:[]},geometryBuffer:ne,geometryDescriptor:re,requiredTextures:B,textureData:z,normalReferenceFrame:this._vertexSR.isGeographic?"east-north-up":"vertex-reference-frame"}}async loadAttributes(e,t,i){const n=e.numFeatures,u={};for(const{field:{name:f}}of t)u[f]=new Array(n);return u}async loadTextures(e,t,i){const n=e.id,u=this._id2Meta.get(n);if(null==u||"mesh-component"!==u.type)throw new Error(`Failed to load textures for node ${e.id} (unexpected node info)`);const f=[];for(const v of t)f.push(u.textureData.get(v.id)||null);return f}async _getMeshData(e){const t=e.version,i=this._memCache.get(t);if(null==i){if(null!=e.loadMeshPromise)return e.loadMeshPromise;const r3=async(i,n)=>{const u=e.unloadedMesh.clone();try{await u.load()}catch(y){n(y)}const f=u.memoryUsage,v={loadedMesh:u,projectionPromise:null,normalsTransformPromise:null,usedMemoryInBytes:f};this._memCache.put(t,v,f,q),e.loadMeshPromise=null,i(v)};return e.loadMeshPromise=new Promise(((e,t)=>r3(e,t))),e.loadMeshPromise}return i}};function g$1(e,t,i){e[t]=255&i,e[t+1]=255&i>>8,e[t+2]=255&i>>16,e[t+3]=255&i>>24}function M$3(e){var t,i;const n=null==(t=e.metadata.displaySource)?void 0:t.source;if(null==n||!Array.isArray(n)||!n.length||n[0]instanceof File)return V();const u=n;let f="";for(const v of u)f+=v.makeHash();return f+JSON.stringify((null==(i=e.transform)?void 0:i.toJSON())??"")+($(e.vertexSpace)?JSON.stringify(e.vertexSpace.origin):"")+JSON.stringify(e.spatialReference)}const ui=4,ci=4,gi=1,_i=8;let mi=class a extends z{constructor(){super(),this.referenceCount=0,this.callbacks=new Array,this.runIndex=0}get running(){return this.callbacks.some((e=>e.running))}runTask(e){this._sort();const t=this.callbacks,i={numIndexLoading:0,numNodesLoading:0};for(let n=0;n<t.length&&!e.done;++n)t[n].priority=t[n].runTask(e,i),this.runIndex=n}_sort(){const e=this.callbacks;let t=e.length;for(let i=this.runIndex;i>0;i--){const n=e[i-1];let u=i;for(;u<e.length&&n.priority<=e[u].priority&&(u!==t||n.priority<e[u].priority);)e[u-1]=e[u],u++;e[u-1]=n,t=u-1}this.runIndex=0}add(e){this._sort(),e.priority=1/0,this.callbacks.unshift(e),this.notifyChange("running")}remove(e){Q(this.callbacks,e),this.runIndex=this.callbacks.length,this._sort(),this.notifyChange("running")}};U([j({readOnly:!0})],mi.prototype,"running",null),mi=U([B("esri.views.3d.layers.i3s.I3SFrameTask")],mi);class l{constructor(e,t){this.task=e,this.handle=t}}const fi=new Map;function h$2(e,t){let i=fi.get(e);if(null==i){const t=new mi,n=e.registerTask(J.I3S_CONTROLLER,t);i=new l(t,n),fi.set(e,i)}return i.task.add(t),K((()=>{null!=i&&(i.task.remove(t),i.task.callbacks.length>0||(fi.delete(e),i.handle.remove(),i.task.destroy()),i=null)}))}class s{constructor(e,t,i,n,u,f,v,y){this.id=e,this.mbs=t,this.obb=i,this.version=n,this.resources=u,this.children=f,this.lodSelection=v,this.numFeatures=y}}let pi=class N{constructor(e,t,i,n,u){this.childOffset=e,this.childCount=t,this.visibilityCache=i,this.ref=n,this.node=u,this.useAsHole=0,this.filterImpact=Zt.NotChecked,this.traversalState=null,this.parent=-1}invalidateBounds(){var e,t;null==(e=this.node)||e.invalidateServiceBVsInRenderSR(),null==(t=this.ref)||t.invalidateServiceBVsInRenderSR()}},vi=class b{constructor(e=new Array,t=new Array){this.nodes=e,this.children=t,this.lastTraversed=0,this.numNodesWithLoadedChildren=0}};class I{get _useNodePages(){return this._pageSize>0}constructor(e,t,i,n,u,f,v,y,x,S,M,O,E,T,V,$){var q,G;this.viewingMode=e,this._layer=t,this._streamDataController=n,this._clientNodeLoader=u,this._viewportQueries=f,this._logger=v,this.holeFilling=y,this._isLoaded=x,this._isReloading=S,this._isSelected=M,this._enable=O,this._needsUpdate=E,this._canRequest=T,this._computeVisibilityObb=V,this._computeNodeFiltering=$,this._dirty=!0,this._nodePages=new Map,this._clientNodePage=null,this._pageSize=0,this._rootIndex=0,this._lodMetric=Wt.None,this._lodConversion=e=>e,this._isEditable=!1,this._urlPrefix="",this._loadingNodes=new Set,this._loadingPages=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._version=R$2(0),this._visibilityCacheVersion=R$2(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missingPagesAndNodes=new Z({deallocator:null}),this._prefetchNodes=new Z({deallocator:null}),this._updates=new yi(this._missingPagesAndNodes),this._imModificationUncategorized=new Z({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=new Array,this._newPages=new Array,this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this._frameNumber=0,this._traverseDescendantsQueue=[0],this._traverseDescendantsNestingLevel=0,this._isEditable=Y()&&null!=(null==(q=t.associatedLayer)?void 0:q.infoFor3D),(null==(G=t.serviceUpdateTimeStamp)?void 0:G.lastUpdate)&&(this._lastUpdate=`${t.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1,this._init(i)}_init(e){if("page"===e.type){const t=e.rootPage;switch(this._urlPrefix=e.urlPrefix,this._pageSize=e.pageSize,e.lodMetric){case"maxScreenThreshold":this._lodMetric=Wt.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this._lodMetric=Wt.MaxScreenThreshold,this._lodConversion=k$3}if(this._isEditable){this._rootIndex=-1;const i=M$2(e.rootIndex,e.pageSize),n=t.nodes[i],u={nodes:[{index:this._rootIndex,children:[e.rootIndex],mesh:void 0,obb:n.obb,lodThreshold:n.lodThreshold}]};this._addPage(E$1(this._rootIndex,this._pageSize),u),this.getNode(-1).serviceObbInIndexSR=void 0}else this._rootIndex=e.rootIndex;this._addPage(E$1(e.rootIndex,this._pageSize),t),this._updateParentsAndLevel()}else if("node"===e.type){this._urlPrefix=e.urlPrefix;const t=new vi;if(this._nodePages.set(0,t),this._isEditable){this._clientNodePage=new vi;const t={id:"-1",version:null,mbs:e.rootNode.mbs,obb:e.rootNode.obb,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:[{id:"root",href:"../root",mbs:e.rootNode.mbs,obb:e.rootNode.obb}]};this._rootIndex=this._makeClientRefNode(new Kt(t.id,null),-1);const i=this._validateNode(t.id,t);i&&this._addNode(i,this._rootIndex)}else this._rootIndex=this._makeRefNode(new Kt(e.rootNode.id,null),-1);const i=this._validateNode(e.rootNode.id,e.rootNode);i&&this._addNode(i,0)}}addClientNodeToIndex(e,t){const i=new Kt(e,t),n=this._makeClientRefNode(i,-1);return this._linkChildToParentNode(-1,n),this.requestUpdate(),n}removeClientNodeFromIndex(e,t,i){this._destroyClientRefNode(e,t,i),this.requestUpdate()}_loadPage(e){this._loadingPages.add(e);const t=this._urlPrefix+e;this._streamDataController.request(t,"json").then((t=>{this._pageQueue.push({pageIndex:e,page:t})})).catch((t=>{this._loadingPages.delete(e),ee(t)||(this._failedPages.add(e),this._logger.error("#loadPage()",this._layer,`Error when loading page ${e}`,t))}))}_addQueuedPages(e){for(;this._pageQueue.length>0&&!e.done;){const{pageIndex:t,page:i}=this._pageQueue.shift();this._addPage(t,i),this._loadingPages.delete(t),e.madeProgress(),this.needNodeElevationRange&&this._newPages.push(t)}this._updateParentsAndLevel()}_invalidateElevationRangeForNewPages(e){if(this.needNodeElevationRange)for(;this._newPages.length>0&&!e.done;){const e=this._nodePages.get(this._newPages.shift());null==e||e.nodes.forEach((e=>{let t=e.parent;for(;null!=t&&t!==this._rootIndex;){const e=this.getNode(t);e&&!Number.isNaN(null==e?void 0:e.elevationRangeMin)&&(e.invalidateElevationRange(),this.invalidateBoundingVolumeCache(t)),t=this.getParentIndex(t)}}))}}_addPage(e,t){const i=[],n=[],u=t.nodes.map(((t,u)=>{var f,v,y;const x=i.length,S=t.children?t.children.length:0;n.push(this._rootIndex);for(let e=0;e<S;e++)i.push(t.children[e]);const O=`${t.index}`,E=te.fromJSON(t.obb),T=M(E.center,E.radius),V=null==(f=t.mesh)?void 0:f.attribute,$=null==(v=t.mesh)?void 0:v.geometry,q=null==(y=t.mesh)?void 0:y.material,G={hasSharedResource:!1,isEmpty:null==$,attributes:null!=(null==V?void 0:V.resource)?`${V.resource}`:void 0,geometry:null!=(null==$?void 0:$.resource)?`${$.resource}`:void 0,texture:null!=(null==q?void 0:q.resource)?`${q.resource}`:void 0,geometryDefinition:$?$.definition:-1,materialDefinition:q?q.definition:-1},U=new Xt(O,V$1(u,e,this._pageSize),T,S,0,G,this._lastUpdate,this._lodMetric,this._lodConversion(t.lodThreshold),$?$.featureCount:null);return U.serviceObbInIndexSR=E,U.visibilityObbInRenderSR=this._computeVisibilityObb(U),U.vertexCount=$?$.vertexCount:0,new pi(x,S,x$1(this._visibilityCacheVersion),null,U)})),f=new vi(u,i);-1===e?this._clientNodePage=f:this._nodePages.set(e,f)}_updateParentsAndLevel(){const e=new Array,t2=(t,i,n)=>{const u=this._getPage(t);if(null!=u){const f=M$2(t,this._pageSize),v=u.nodes[f];v.parent=null!=i?i:-1;const y=v.node;null!=y&&(y.level=n,e.push(t))}};for(t2(this._rootIndex,null,0);e.length;){const t=e.pop(),i=this.getNode(t);if(null!=i)for(let e=0;e<i.childCount;e++)t2(this.getChildIndex(i.index,e),t,i.level+1),this._maxLevel=Math.max(this._maxLevel,i.level+1)}}_getPage(e){const t=E$1(e,this._pageSize);return this._getPageFromPageIndex(t)}_getPageFromPageIndex(e){return e<0?this._clientNodePage:this._nodePages.get(e)}_getNodeInternal(e){const t=this._getPage(e);return null==t?null:(t.lastTraversed=this._frameNumber,t.nodes[M$2(e,this._pageSize)])}_addNode(e,t){e.children&&this.populateChildren(t,e.children);const i=this.getParent(t),n=null!=i?i.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?n+1:n);const{lodMetric:u,maxError:f}=function A(e){if(e)for(let t=0;t<e.length;t++)for(const i of xi)if(i[0]===e[t].metricType)return{lodMetric:i[1],maxError:e[t].maxError};return{lodMetric:Wt.None,maxError:0}}(e.lodSelection),v=this._getNodeInternal(t),y=new Xt(e.id,t,e.mbs,v.childCount,n,e.resources,e.version,u,f,e.numFeatures);v.node=y,e.obb&&(y.serviceObbInIndexSR=te.fromJSON(e.obb)),y.visibilityObbInRenderSR=this._computeVisibilityObb(y);const x=v.ref;return null!=x&&(null==x.serviceMbsInIndexSR&&(x.serviceMbsInIndexSR=e.mbs),y.shareServiceBVsInRenderSRWith(x),x.visibilityObbInRenderSR=y.visibilityObbInRenderSR),y}_makeRefNode(e,t){const i=this._nodePages.get(0);if(t<-1)return this._makeClientRefNode(e,t);if(null==i)return-1;const n=i.nodes.length,u=new pi(0,0,x$1(this._visibilityCacheVersion),e,null);return i.nodes.push(u),u.parent=t,e.invalidateServiceBVsInRenderSR(),n}_makeClientRefNode(e,t){const i=this._clientNodePage;if(null==i)return-1;if(t>=0)throw new Error("I3SIndex::client side nodes can not be made children of service side nodes.");const n=-(i.nodes.length+1),u=new pi(0,0,x$1(this._visibilityCacheVersion),e,null);return i.nodes.push(u),u.parent=t,e.invalidateServiceBVsInRenderSR(),n}_linkChildToParentNode(e,t){const i=this._clientNodePage;if(null==i||e>=0)return;const n=M$2(e,this._pageSize),u=M$2(t,this._pageSize),f=i.nodes[n],v=f.childOffset;i.children.splice(f.childOffset+f.childCount,0,t);f.childCount+=1,null!=f.node&&(f.node.childCount+=1);for(const y of i.nodes)y.childOffset>v&&(y.childOffset+=1);i.nodes[u].parent=e,this._updateParentBoundingInformation(e)}_destroyClientRefNode(e,t,i){var n,u;const f=this._clientNodePage;if(null==f)return;const v=this.getParentIndex(e);if(null==v)return;const y=new Set,x=new Map,a3=e=>{var i,n;const u=M$2(e,this._pageSize),v=f.nodes[u];if(v.childCount>0)for(let t=v.childOffset;t<v.childOffset+v.childCount;++t)a3(f.children[t]);const x=(null==(i=v.node)?void 0:i.id)??(null==(n=v.ref)?void 0:n.id);if(null==x)throw new Error("Node has no id");t(x,e),y.add(v)};a3(e);const S=f.nodes,M=f.children,O=f.nodes.map((()=>-1)),E=[],T=[];for(let V=0;V<S.length;++V){const e=S[V];if(y.has(e))continue;const t=E.length,f=V$1(V,-1,this._pageSize),v=V$1(t,-1,this._pageSize);if(e.node&&(e.node.index=v),O[V]=v,E.push(e),f!==v){const t=(null==(n=e.node)?void 0:n.id)??(null==(u=e.ref)?void 0:u.id);if(null==t)throw new Error("Node has no id");i(t,f,v),x.set(f,v)}}for(let V=0;V<E.length;++V){const e=V$1(V,-1,this._pageSize),t=E[V],i=T.length;for(let n=t.childOffset;n<t.childOffset+t.childCount;++n){const t=M[n];if(t>=0)T.push(t);else{const i=M$2(t,this._pageSize),n=S[i];if(y.has(n))continue;const u=O[i];T.push(u),n.parent=e}}t.childOffset=i,t.childCount=T.length-i,t.node&&(t.node.childCount=t.childCount)}f.nodes=E,f.children=T,this._updateParentBoundingInformation(O[M$2(v,this._pageSize)])}_updateParentBoundingInformation(e){let t=e;do{let e=null;const i=this._clientNodeLoader.indexSR,n=this._clientNodeLoader.renderSR,u=this._getNodeInternal(t);if(null==u)return;for(let v=0;v<u.childCount;v++){const u=this.getChildIndex(t,v),f=this._getNodeInternal(u),y=null!=f?f.ref||f.node:null;if(null!=y&&y.serviceMbsInIndexSR[3]>0)if(null==e)e=ie(y.serviceMbsInIndexSR,Ni);else{const t=Ci,u=Ii,f=wi;Qt(y.serviceMbsInIndexSR,i,t,n),Qt(e,i,u,n),se(t,u,f),Qt(f,n,e,i)}}const f=u.ref||u.node;null!=f&&(null!=e?(f.serviceMbsInIndexSR??(f.serviceMbsInIndexSR=ne()),ie(e,f.serviceMbsInIndexSR)):re(f.serviceMbsInIndexSR),f.invalidateServiceBVsInRenderSR(),f.geometryObbInRenderSR=null),this.invalidateNodeVisibilityCacheInternal(u),t=this.getParentIndex(t)}while(null!=t)}populateChildren(e,t){const i=this._getNodeInternal(e),n=this._getPage(e);i.childOffset=n.children.length,i.childCount=t.length;for(let u=0;u<t.length;u++){const i=this._makeRefNode(t[u],e);n.children.push(i)}}getNode(e){const t=this._getNodeInternal(e);return null!=t?t.node:null}getIndexById(e){let t;return this._forAllNodes(((i,n)=>{(null!=i.node&&i.node.id===e||null!=i.ref&&i.ref.id===e)&&(t=n)})),t}getNodeById(e){const t=this.getIndexById(e);return null!=t&&t>=0?this.getNode(t):null}getChildIndex(e,t){const i=this._getPage(e);if(null==i)return-1;const n=i.nodes[M$2(e,this._pageSize)];return i.children[n.childOffset+t]}getParentIndex(e){const t=this._getPage(e);return null!=t&&e!==this._rootIndex?t.nodes[M$2(e,this._pageSize)].parent:null}getParent(e){const t=this.getParentIndex(e);return null!=t?this.getNode(t):null}isLeaf(e){const t=this._getNodeInternal(e);return null!=t&&0===t.childCount}get rootNode(){return this.getNode(this._rootIndex)}get isEditable(){return this._isEditable}removeAllGeometryObbs(){this._forAllNodes((e=>{null!=e.node&&(e.node.geometryObbInRenderSR=null)}))}invalidateVisibilityCache(){this._visibilityCacheVersion=R$2(this._visibilityCacheVersion)}invalidateNodeVisibilityCache(e){const t=this._getNodeInternal(e);null!=t&&this.invalidateNodeVisibilityCacheInternal(t)}invalidateNodeVisibilityCacheInternal(e){e.visibilityCache=x$1(this._visibilityCacheVersion)}invalidateBoundingVolumeCache(e){const t=this._getNodeInternal(e);null!=t&&(null==t||t.invalidateBounds(),this.invalidateNodeVisibilityCacheInternal(t))}updateElevationChanged(e){const t=this._getNodeInternal(e);if(null==t)return;if(!this.needNodeElevationRange)return void this.invalidateBoundingVolumeCache(e);const i=null!=t.node?t.node:t.ref;null!=i&&i.invalidateElevationRange()}invalidateGeometryVisibility(e){const t=this._getNodeInternal(e),i=null==t?void 0:t.node;i&&(i.geometryObbInRenderSR=null,i.invalidateServiceBVsInRenderSR())}invalidateVisibilityObbs(){null!=this.rootNode&&this.traverse(this.rootNode,(e=>(e.visibilityObbInRenderSR=this._computeVisibilityObb(e),e.geometryObbInRenderSR=null,!0)))}_isElevationRangeUpToDate(e){if(!this.needNodeElevationRange)return!0;const t=(null==e?void 0:e.node)??(null==e?void 0:e.ref);return!t||t.elevationRangeValid}updateElevationRange(e){this._updateElevationRangeInternal(e,null)}_updateElevationRangeInternal(e,t){var i,n,u;const f=this._getNodeInternal(e);if(!f)return!1;const v=(null==f?void 0:f.node)??(null==f?void 0:f.ref);if(!v)return!1;if(v.elevationRangeValid)return null==t||t.expandElevationRange(v),!0;const y=new ae;let x=!1;for(let O=0;O<f.childCount;O++){const t=this.getChildIndex(e,O),i=this._updateElevationRangeInternal(t,y);x=x||!i}if(0===f.childCount||x){const e=!(null==(i=f.node)?void 0:i.resources.isEmpty);this._viewportQueries.expandElevationRange(v,e,y)}const S=v.elevationRangeMin,M=v.elevationRangeMax;return S===y.elevationRangeMin&&M===y.elevationRangeMax?(null==t||t.expandElevationRange(v),!0):(null==(n=f.node)||n.setElevationRange(y),null==(u=f.ref)||u.setElevationRange(y),this.invalidateBoundingVolumeCache(e),null==t||t.expandElevationRange(v),!0)}isNodeVisible(e){const t=this._getNodeInternal(e);if(null==t)return!0;const i=t.ref;if(null!=i&&!i.serviceMbsInIndexSR)return!0;if(this._isElevationRangeUpToDate(t)&&C$1(t.visibilityCache,this._visibilityCacheVersion))return w$1(t.visibilityCache);const n=t.node,u=this._viewportQueries;if(n){const e=u.ensureElevationAgnosticBoundingVolume(n),i=u.isElevationAgnosticBoundingVolumeVisible(e);let f=i;if(this.needNodeElevationRange&&i){const t=u.getNodeObbInRenderSRIndependentOfElevationOffset(n);null!=t&&(f=u.isObbVisibleIndependentOfElevation(e,t))}if(!f)return t.visibilityCache=S$1(!1,this._visibilityCacheVersion),!1}if(this._layerHasFilter&&this._computeNodeFiltering&&(null!=n||null!=i)&&t.filterImpact===Zt.NotChecked){const e=null!=n?n.serviceMbsInIndexSR:null!=i?i.serviceMbsInIndexSR:null;t.filterImpact=null!=e?this._computeNodeFiltering(e):Zt.Unmodified}const f=null!=n&&t.filterImpact===Zt.Culled;let v=!(null!=n&&n.imModificationImpact===Yt.Culled||f);if(v){const t=!n||i&&!n.visibilityObbInRenderSR?i??null:n;null!=t&&(this.needNodeElevationRange&&this.updateElevationRange(e),v=u.isNodeVisible(t))}return t.visibilityCache=S$1(v,this._visibilityCacheVersion),v}isGeometryVisible(e){var t;if(!this.isNodeVisible(e))return!1;const i=this._getNodeInternal(e);return!!(null==(null==(t=null==i?void 0:i.node)?void 0:t.geometryObbInRenderSR)||this.layerHasModifications&&i.node.imModificationImpact===Yt.NotChecked)||this._viewportQueries.isGeometryVisible(i.node)}_traverseCoverage(e,t,i,n,u){const f=this._getPage(e);if(null==f||0===t.childCount)return;const v=t.childOffset+t.childCount,y=new Array;for(let x=t.childOffset;x<v;++x){const e=f.children[x],t=this._getNodeInternal(e);null!=(null==t?void 0:t.node)&&this.isGeometryVisible(e)&&y.push(t)}n/=y.length;for(const x of y){const e=x.node.index;this._isLoaded(e)||this._isReloading(e)?(u.delta=Math.max(u.delta,i),u.coverage+=n):this._traverseCoverage(e,x,i+1,n,u)}}useNodeAsHole(e){if("off"===this.holeFilling)return!1;const t=this._getNodeInternal(e);if(null==t)return!1;if("always"===this.holeFilling)return!0;if(C$1(t.useAsHole,this._version))return w$1(t.useAsHole);const i={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,i);const n=i.delta*i.coverage<=.5;return t.useAsHole=S$1(n,this._version),n}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune(),this._updates.update.prune()}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=R$2(this._version)}imModificationsChanged(e){this.layerHasModifications=e,this._forAllNodes((({node:e})=>{null!=e&&(e.imModificationImpact=Yt.NotChecked,e.visibilityObbInRenderSR=this._computeVisibilityObb(e),e.hasModifications&&this.invalidateGeometryVisibility(e.index))})),this.invalidateVisibilityCache()}layerFilterChanged(e){this._layerHasFilter=e,this._forAllNodes((e=>{if(null!=e){e.filterImpact=Zt.NotChecked;const t=e.node;null!=t&&this.invalidateNodeVisibilityCache(t.index)}})),this.invalidateVisibilityCache()}update(e,t,i){if(!this._dirty)return;this._pageQueue.length>0&&this._addQueuedPages(t),this._invalidateElevationRangeForNewPages(t),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missingPagesAndNodes.clear(),this._prefetchNodes.clear(),this._updates.reset(e),bi.clear();let n=!0;const u=new L,f=new L,v=this._imModificationUncategorized;v.clear();const y=new Set;let x=0;this.traverseVisible(((y,S,M)=>{const O=E$1(y,this._pageSize);if(null==S){let e=this._entryPriority(y);return e===1/0&&(e=this._entryPriority(M)),bi.set(O,Math.max(e,bi.get(O)||0)),this._loadingPages.has(O)||this._failedPages.has(O)||(this._missingPagesAndNodes.push(O),++x),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const E=S.node;if(this._updateNodeFeatureEstimate(E,f),null==E){const e=this._entryPriority(y);return this._loadingNodes.has(y)||this._failedNodes.has(y)||(this._missingPagesAndNodes.push(y),bi.set(y,e)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const T=this._getPage(y);if(0===this._missingPagesAndNodes.length&&!this._useNodePages)for(let e=0;e<S.childCount;e++){const t=T.children[S.childOffset+e],i=this._getNodeInternal(t);null==i||i.node||this._loadingNodes.has(t)||this._failedNodes.has(t)||(bi.set(t,this._entryPriority(t)),this._prefetchNodes.push(t))}if(E.failed||E.resources.isEmpty)return void(n&&S.childCount>0&&this._isSelected(E)&&(n=!1));if(this._isLoaded(y)){if(u.known+=E.memory,++u.knownNodes,this._isSelected(E)?S.childCount>0&&(n=!1):(u.unremoved+=E.memory,n=!1),this._needsUpdate(E)){const e=this._entryPriority(y);bi.set(y,e),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e),this._updates.update.push(y)}return}if(E.memory&&(u.known+=E.memory,++u.knownNodes),!this._isSelected(E))return void(this._isReloading(y)&&this._updates.remove.push(y));if(S.childCount>0&&(n=!1),E.memory?(u.missing+=E.memory,u.known+=E.memory,++u.knownNodes):++u.missingNodes,e.includes(E.index))return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(y)),void(this._updates.cancel=this._updates.cancel.filter((e=>e!==E.index)));if(!t.done&&this._enable(E))return void t.madeProgress();const V=this._entryPriority(y);bi.set(y,V),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,V),this._updates.add.push(y),this.layerHasModifications&&i&&null!=E&&E.imModificationImpact===Yt.NotChecked&&v.push(y)}),y),this._frameNumber++,this._missingPagesAndNodes.sort(((e,t)=>e-t)),this._missingPagesAndNodes.filterInPlace(((e,t)=>t<1||this._missingPagesAndNodes.data[t-1]!==e)),this._missingPagesAndNodes.sort(((e,t)=>bi.get(e)-bi.get(t))),this._missingPagesAndNodes.length>0&&(this._maxUnloadedPrio=bi.get(this._missingPagesAndNodes.back()),this._prefetchNodes.clear()),this._removeUnusedNodePages(y,x);const S=this._updates.add;S.length>0&&this.layerHasModifications&&(v.length>0&&(null==i||i(v)),S.filterInPlace((e=>{const t=this._getNodeInternal(e),i=null==(null==t?void 0:t.node)||t.node.imModificationImpact!==Yt.Culled;return i||this.invalidateNodeVisibilityCache(e),i}))),this._unloadedMemoryEstimate=u.missing-u.unremoved,u.knownNodes>3&&u.missingNodes>0&&(this._unloadedMemoryEstimate+=u.known/u.knownNodes*u.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(f),this._featureEstimate.leavesReached=n,this._updates.add.filterInPlace((e=>bi.get(e)>=this._maxUnloadedPrio)).sort(((e,t)=>bi.get(e)-bi.get(t))),this._updates.update.sort(((e,t)=>bi.get(e)-bi.get(t))),this._indexMissing=this._loadingPages.size+this._loadingNodes.size+this._missingPagesAndNodes.length,this._dirty=this._indexMissing>0,bi.clear()}checkFeatureTarget(e,t){const i=this._viewportQueries.updateScreenSpaceErrorBias(t);let n=t,u=t,f=i,v=10;for(;v--;){const i=new L;if(this._updateFeatureEstimate(n,i),this._computeFeatureEstimate(i)<=e){if(n>=t||i.missingNodes>0||0===v)break;f=n,n=.5*(n+u)}else u=n,n=.5*(n+f)}return this._version=R$2(this._version),this._viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,n)}_removeUnusedNodePages(e,t){if(!this._useNodePages)return;const i=e.size,n=this._nodePages,u=n.size+this._loadingPages.size+t;if(u>Si&&u>i){const t=new Array;for(const[i,u]of n)0!==u.numNodesWithLoadedChildren||e.has(i)||t.push([u.lastTraversed,i]);t.sort(((e,t)=>e[0]-t[0])).some((e=>{const t=e[1];return this._deleteNodePage(t),n.size<=Si}))}}_updateFeatureEstimate(e,t){this._version=R$2(this._version),this._viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible(((e,i)=>this._updateNodeFeatureEstimate(null!=i?i.node:void 0,t)))}_updateNodeFeatureEstimate(e,t){null==e||e.failed||null==e.numFeatures||this._isSelected(e)&&(null!=e.numFeatures?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes)}_computeFeatureEstimate(e){let t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}load(){return this._load(this._missingPagesAndNodes)}prefetch(){return this._prefetchNodes.sort(((e,t)=>bi.get(e)-bi.get(t))),this._load(this._prefetchNodes)}_load(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();){const t=e.pop();this._useNodePages&&t>=0?this._loadPage(t):this._loadNode(t)}return!0}get isLoading(){return this._indexMissing>0}get isPrefetching(){return this._prefetchNodes.length>0}get indexLoading(){return this._loadingPages.size+this._loadingNodes.size}get indexMissing(){return this._indexMissing}get unloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}get maxPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}nodeTraversalState(e){if(null==e)return null;const t=e.index,i=this._getNodeInternal(t);if(!i)return null;let n=null==i?void 0:i.traversalState;if(n&&C$1(n.version,this._version))return n;const u=this._viewportQueries.getLodLevel(e),f=this._viewportQueries.hasLOD(e);let v=!0;if(f){const e=this.getParentIndex(t);if(null!=e){const t=this._getNodeInternal(e),i=null==t?void 0:t.traversalState;v=!!i&&u>i.lodLevel}else v=u>0}else v=0===e.childCount;return n?(n.lodLevel=u,n.isChosen=v,n.version=S$1(!0,this._version),n):(n=new ei(f,v,u,S$1(!0,this._version)),i.traversalState=n,n)}async _loadNode(e){this._loadingNodes.add(e);const t=this._getNodeInternal(e).ref;if(null==t)return void this._failedNodes.add(e);const i=t.id,n=this._urlPrefix+i,o2=()=>{this._loadingNodes.delete(e),0===this._missingPagesAndNodes.length&&0===this._loadingNodes.size&&this.requestUpdate()};let u=null;try{u=e>=0?await this._streamDataController.request(n,"json"):await this._clientNodeLoader.loadNodeJSON(i)}catch(y){return o2(),void(ee(y)||(this._logger.error("#loadNode()",this._layer,"Error loading node: "+n),this._failedNodes.add(e)))}o2();const f=this._validateNode(i,u);if(null==f)return;f.obb&&this.invalidateNodeVisibilityCache(e);const v=this._addNode(f,e);this.nodeTraversalState(v)}_validateNode(e,t){var i;if(null==t||"object"!=typeof t||t.id!==e)return this._logger.error("#validateNode()",this._layer,`Invalid node. Wrong type or wrong id "${e}"`),null;if(!Array.isArray(t.mbs))return this._logger.error("#validateNode()",this._layer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this._logger.warn("#validateNode()",this._layer,`Invalid shared resource href on node "${e}"`);const n=t.geometryData;null==n||Array.isArray(n)&&0===n.length||Array.isArray(n)&&1===n.length&&"./geometries/0"===n[0].href||this._logger.warn("#validateNode()",this._layer,`Invalid geometry data on node "${e}"`);const u=t.attributeData,f=this._layer.attributeStorageInfo;null==u||Array.isArray(u)&&!u.some(((e,t)=>{var i;return e.href!==`./attributes/${(null==(i=null==f?void 0:f[t])?void 0:i.key)??`f_${t}`}/0`}))||this._logger.warn("#validateNode()",this._layer,`Invalid attribute data on node "${e}"`),t.featureData&&t.featureData.length>1&&this._logger.warn("#validateNode()",this._layer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const v=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:void 0,y=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:void 0,x=Array.isArray(t.children)?t.children.map((t=>{if(null==t)return null;const i3=t=>this._logger.error("#validateNode()",this._layer,`Invalid node reference on node ${e}: ${t}`);if("number"==typeof t.id)i3(`id ${t.id} is a number instead of a string.`);else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i3("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i3(`Invalid bounding volume on reference ${t.id}.`),null;t.href&&t.href!=="../"+t.id&&this._logger.error("#validateNode()",this._layer,`Invalid node href on node "${e}"`);const i=new Kt(`${t.id}`,t.mbs);return i.serviceObbInIndexSR=!this.ignoreServiceObb&&t.hasOwnProperty("obb")&&t.obb?te.fromJSON(t.obb):null,i.visibilityObbInRenderSR=this._computeVisibilityObb(i),i})).filter((e=>null!=e)):null,S=(null==(i=t.featureData)?void 0:i.length)??!1,M=!0===t.isEmpty;return new s(e,t.mbs,v,"string"==typeof t.version?t.version:null,{isEmpty:!S&&M,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:void 0,texture:t.textureData&&t.textureData.length>0?e:void 0,geometry:null!=t.geometryData?e:void 0},x,Array.isArray(t.lodSelection)?t.lodSelection:null,y)}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes((e=>{null!=e.node&&(e.node.failed=!1)}))}_entryPriority(e){const t=this._getNodeInternal(e),i=this.getParentIndex(e);if(null==t||null==i&&null==t.node)return null==i?1/0:this._entryPriority(i);let n=0;if(t.node&&null!=i){const e=this._getNodeInternal(i).traversalState;null!=e&&(n=e.lodLevel)}let u=this.progressiveLoadPenalty;for(let v=e;null!=v;v=this.getParentIndex(v))if(this._isLoaded(v)){u=0;break}const f=null!=t.ref?this._viewportQueries.distToPOI(t.ref):null!=t.node?this._viewportQueries.distToPOI(t.node):0;return-f-n*(f+this.progressiveLoadPenalty)+u}traverseVisible(e,t){const i=this._getNodeInternal(this._rootIndex);null!=i?this._traverseVisible(this._rootIndex,null,i,e,t):e(this._rootIndex,null,null)}_traverseVisible(e,t,i,n,u){const f=E$1(e,this._pageSize);if(u&&u.add(f),i.node&&0===i.childCount)return void(this.isGeometryVisible(e)&&n(e,i,t));if(!this.isNodeVisible(e))return;if(n(e,i,t),null==i.node)return;const v=this.nodeTraversalState(i.node);if((null==v?void 0:v.nodeHasLOD)&&v.lodLevel===this._maxLodLevel)return;const y=this._getPageFromPageIndex(f);for(let x=0;x<i.childCount;x++){const t=y.children[i.childOffset+x],f=this._getNodeInternal(t);if(f)this._traverseVisible(t,e,f,n,u);else{if(u){const e=E$1(t,this._pageSize);u.add(e)}n(t,null,e)}}}traverse(e,t){t(e)&&this.traverseDescendants(e,t)}traverseDescendants(e,t){++this._traverseDescendantsNestingLevel;const i=e.index,n=this._pageSize,u=E$1(i,n),f=this._getPageFromPageIndex(u);if(null==f)return;const v=this._frameNumber,y=this._nodePages;f.lastTraversed=v;const x=M$2(i,n),S=f.nodes[x],{childCount:M}=S;if(0===M)return;const O=1===this._traverseDescendantsNestingLevel?this._traverseDescendantsQueue:[0];let E=0;const T=[];{const{childOffset:e,childCount:t}=S,{children:i}=f;O.length=2**Math.ceil(Math.log2(E+t));for(let n=e;n<e+t;++n){const e=i[n];e>=0?(O[E]=e,++E):T.push(e)}}if(T.length>0){const e=this._clientNodePage;if(e){const i=e.children;let n=0;for(;n<T.length;){const u=T[n];++n;const f=-u-1,v=e.nodes[f],y=v.node;if(!y)continue;if(!t(y))continue;const{childCount:x}=v;if(0===x)continue;const{childOffset:S}=v,M=S+x;for(let e=S;e<M;++e)T.push(i[e])}}}if(E>0){let e=0;if(n>0){let i=u*n,x=f,S=x.nodes;for(;e<E;){const u=O[e];let f;if(++e,i<=u&&u<i+n)f=x;else{const e=u/n|0,t=y.get(e);if(void 0===t)continue;f=t,f.lastTraversed=v,x=f,S=x.nodes,i=n*e}const M=S[u-i],T=M.node;if(null==T)continue;if(!1===t(T))continue;const{childCount:V}=M;if(0===V)continue;const $=E+V;for(O.length<$&&(O.length=2**Math.ceil(Math.log2(E+V)));O.length<E+V;)O.length+=O.length;const q=f.children,{childOffset:G}=M,U=G+V;for(let e=G;e<U;++e)O[E]=q[e],++E}}else{const i=y.get(0);if(i)for(;e<E;){const n=O[e];++e;const u=i.nodes[n],f=u.node;if(!f)continue;if(!t(f))continue;const{childCount:v}=u;if(0===v)continue;O.length=Math.max(O.length,2**Math.ceil(Math.log2(E+v)));const y=i.children,{childOffset:x}=u,S=x+v;for(let e=x;e<S;++e)O[E]=y[e],++E}}}--this._traverseDescendantsNestingLevel}updateChildrenLoaded(e,t){let i=this.getNode(e);for(;null!=i;){const e=i.childrenLoaded,n=e+t;i.childrenLoaded=n;const u=0===e?1:0===n?-1:0,f=i.index;0!==u&&(this._getPage(f).numNodesWithLoadedChildren+=u),i=this.getParent(f)}}checkChildrenLoadedInvariant(){if(null==this.rootNode)return!0;const e=[],t2=t=>{let i=this._isLoaded(t.index)||this._isReloading(t.index)?1:0;return this.traverseDescendants(t,(e=>(i+=t2(e),!1))),t.childrenLoaded!==i&&e.push(t.index),i};return t2(this.rootNode),e.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+e.join(",")),e.length>0}updateElevationInfo(e,t){this.needNodeElevationRange=t&&!!e&&("relative-to-ground"===e.mode||"relative-to-scene"===e.mode||"on-the-ground"===e.mode),this._viewportQueries.updateElevationInfo(e),this.invalidateAllElevationRanges()}invalidateAllElevationRanges(){this._forAllNodes((e=>{var t,i;null==e||e.invalidateBounds(),null==(t=e.node)||t.invalidateElevationRange(),null==(i=e.ref)||i.invalidateElevationRange()}))}_forAllNodes(e){if(null!=this._clientNodePage){const t=this._clientNodePage;for(let i=0;i<t.nodes.length;i++)e(t.nodes[i],-(i+1))}for(const[t,i]of this._nodePages){const n=t*this._pageSize;for(let t=0;t<i.nodes.length;t++)e(i.nodes[t],n+t)}}clearCaches(){if(this._useNodePages){const e=this._nodePages,t=new Set;this.traverseVisible((e=>t.add(E$1(e,this._pageSize))));for(const[i,n]of e)if(0!==n.numNodesWithLoadedChildren||t.has(i))for(const e of n.nodes)e.traversalState=null;else this._deleteNodePage(i)}}_deleteNodePage(e){this._nodePages.delete(e)}get test(){}}const bi=new Map;let yi=class P{constructor(e){this.missing=e,this.update=new Z({deallocator:null}),this.add=new Z({deallocator:null}),this.remove=new Z({deallocator:null}),this.cancel=[]}reset(e){this.add.clear(),this.update.clear(),this.cancel=e}};function x$1(e){return oe(e,-2)}function R$2(e){return oe(e,2)}function S$1(e,t){return t+(e?1:0)}function C$1(e,t){return(-2&e)===t}function w$1(e){return!(1&~e)}function E$1(e,t){return e<0?-1:t>0?e/t|0:0}function M$2(e,t){return e<0?-e-1:0===t?e:e%t}function V$1(e,t,i){return-1===t?-(e+1):0===i?e:t*i+e}const xi=[["maxScreenThreshold",Wt.MaxScreenThreshold],["screenSpaceRelative",Wt.ScreenSpaceRelative],["removedFeatureDiameter",Wt.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",Wt.DistanceRangeFromDefaultCamera]];class L{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}function k$3(e){return Math.sqrt(e*(4/Math.PI))}const Ni=ne(),Ci=ne(),Ii=ne(),wi=ne(),Si=X("esri-mobile")?100:300;var Mi,Ri;(Ri=Mi||(Mi={}))[Ri.FadeIn=0]="FadeIn",Ri[Ri.FadeOut=1]="FadeOut";class o{constructor(e){this._layerView=e,this._lodGlobalDirty=!1}startNodeLoading(e,t,i){this._maxLodLevel=i.maxLodLevel,this._index=t,this._removeNodes=e}shouldLoadNode(e){if(null==e)return!1;const t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const t=this._layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(t-1)));Di.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1,!!this._layerView.nodeCrossfadingEnabled);const n=Di.length;this._removeNodes(Di,e);const u=Di.length<n;return 0!==Di.length&&(this._lodGlobalDirty=!0),Di.clear(),u}_lodGlobalHandling(e,t,i,n){if(null==e)return!1;const u=e.index,f=this._index,v=this._layerView,y=f.nodeTraversalState(e),x=this._isChosenMaxLOD(y),S=e.resources.isEmpty;if(x&&S)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const M=v.isNodeLoaded(u);if(n&&M&&x){const t=!i&&this.hasNoVisibleChildren(e);v.fadeNode(u,Mi.FadeIn,!t)}const O=M&&(!v.isNodeFullyFadedIn||v.isNodeFullyFadedIn(u));if(M&&(v.updateNodeState(u,x?ti.Leaf:ti.Hole),x))return O&&this._removeChildrenRecursive(e),O;const E=e.childCount>0;let T=E;if(E)for(let q=0;q<e.childCount;q++){const e=f.getChildIndex(u,q),v=f.getNode(e);null!=v?!f.isGeometryVisible(e)||this._lodGlobalHandling(v,t,i||O,n)||(T=!1):f.isNodeVisible(e)&&(T=!1)}const V=M&&!x&&(T||Di.length<t);V&&Di.push(u),!n||V||!M||i||T||v.fadeNode(u,Mi.FadeIn,!1);const $=e.resources.isEmpty;return T||O&&!V||$}_removeChildrenRecursive(e){this._index.traverseDescendants(e,(e=>((this._layerView.isNodeLoaded(e.index)||this._layerView.isNodeReloading(e.index))&&Di.push(e.index),e.childrenLoaded>0)))}hasNoVisibleChildren(e){let t=!0;return this._index.traverseDescendants(e,(e=>!(!t||!this._index.isNodeVisible(e.index))&&(this._layerView.isNodeLoaded(e.index)?(t=!1,!1):e.childrenLoaded>0))),t}_childrenRequireLoading(e){let t=!1,i=!0;return this._index.traverseDescendants(e,(e=>{if(!i||!this._index.isNodeVisible(e.index))return!1;const n=this._index.nodeTraversalState(e);return this._isChosenMaxLOD(n)&&this._index.isGeometryVisible(e.index)&&(t=!0),this._layerView.isNodeLoaded(e.index)?(i=!1,!1):e.childrenLoaded>0})),i&&t}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}const Di=new Z({deallocator:null});function T$1(e){return e.sort(((e,t)=>e.encoding-t.encoding))}const Pi={ktx2:ai.KTX2,basis:ai.Basis,dds:ai.DDS_S3TC,png:ai.PNG,jpg:ai.JPG,"ktx-etc2":ai.KTX_ETC2},Fi={[le.KTX2_ENCODING]:ai.Basis,[le.BASIS_ENCODING]:ai.Basis,[le.DDS_ENCODING]:ai.DDS_S3TC,"image/png":ai.PNG,"image/jpg":ai.JPG,"image/jpeg":ai.JPG,"image/ktx":ai.KTX_ETC2};const b2=()=>({alphaMode:"opaque",alphaCutoff:ge,doubleSided:!0,cullFace:n.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0});function C(e,t,i,n){if(null==(null==e?void 0:e.data))return null;const u=e.data,f=n.renderingContext.parameters.maxMaxAnisotropy,v=f>1,y=i||!t.wrapTextures?Li:Oi,x=function N2(e){switch(e){case ai.KTX2:return le.KTX2_ENCODING;case ai.Basis:return le.BASIS_ENCODING;case ai.DDS_S3TC:return le.DDS_ENCODING;case ai.PNG:return"image/png";case ai.JPG:return"image/jpeg";case ai.KTX_ETC2:return"image/ktx";default:return""}}(e.encoding),S=e.usage&li.Color?"opaque"===t.alphaMode?3:4:3;return new _e(u,{mipmap:v,maxAnisotropy:f,encoding:x,wrap:y,components:S,noUnpackFlip:!0})}const Li={s:de.CLAMP_TO_EDGE,t:de.CLAMP_TO_EDGE},Oi={s:de.REPEAT,t:de.REPEAT};function M$1(e,t,n,u,f,v){const y=v.rendererTextureUsage,h3=e=>function w(e,t,i){if(null==e||i===li.None)return null;for(let n=0;n<e.length;n++){const u=e[n];if(null!=u&&u.usage&i){const e=t[n];return null!=e?e.id:null}}return null}(u,n,e&y),x=t.metallicRoughness.baseColorFactor,S=ce(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[x[0],x[1],x[2],S],e.hasParametersFromSource=!!t.hasParametersFromSource,e.usePBR=v.usePBR,e.mrrFactors=[t.metallicRoughness.metallicFactor,t.metallicRoughness.roughnessFactor,t.hasParametersFromSource?i[2]:ue[2]],e.emissiveFactor=t.emissiveFactor,e.isIntegratedMesh=v.isIntegratedMesh,e.textureAlphaCutoff="mask"===t.alphaMode?t.alphaCutoff:ge,e.alphaDiscardMode="opaque"===t.alphaMode?me.Opaque:"mask"===t.alphaMode?me.Mask:me.MaskBlend;const M=[],O=h3(li.Color|li.AlphaMask);null!=O&&(e.baseColorTexture=new Jt(f,O),M.push(e.baseColorTexture.loadPromise));const E=h3(li.MetallicRoughness);null!=E&&(e.metallicRoughnessTexture=new Jt(f,E),M.push(e.metallicRoughnessTexture.loadPromise));const T=h3(li.Emissive);null!=T&&(e.emissionTexture=new Jt(f,T),M.push(e.emissionTexture.loadPromise));const V=h3(li.Occlusion);null!=V&&(e.occlusionTexture=new Jt(f,V),M.push(e.occlusionTexture.loadPromise));const $=h3(li.Normal);return null!=$&&(e.normalTexture=new Jt(f,$),M.push(e.normalTexture.loadPromise)),e.commonMaterialParameters.hasSlicePlane=v.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,e.ellipsoidMode=fe(v.viewSpatialReference),Promise.all(M)}function R$1(e){const t=!!e.compressedTextureS3TC,i=!!e.compressedTextureETC,n=X("disable-feature:i3s-basis")?0:ai.Basis|ai.KTX2,u=ai.JPG|ai.PNG,f=n|ai.DDS_S3TC;return u|(t?f:0)|(i?n:0)}function D$1(e,t){if(null!=t)return e.find((e=>!!(e.encoding&t)))}class d{constructor(t,u,f,v,y,x){if(this._streamDataController=u,this._logger=f,this._defaultGeometrySchema=v,this._requiredAttributes=y,this._options=x,this._logLayer=t,this._layerUrl=t.parsedUrl.path,this._geometryDefinitions=t.geometryDefinitions,t.materialDefinitions){const u=t.textureSetDefinitions;this._materialAndTextures=t.materialDefinitions.map((f=>function h$1(t,u,f){const v=new Map,t2=(e,t)=>{if(null==e)return-1;const i=v.get(e.id);if(i)return i.usage|=t,i.id;const n=v.size;return v.set(e.id,{id:n,usage:t}),n},y=u.pbrMetallicRoughness,x=null==y?void 0:y.baseColorFactor,S=u.emissiveFactor,M=X("disable-feature:diffuse-rendering-i3s")||f?he({normalTexture:u.normalTexture,emissiveTexture:u.emissiveTexture,emissiveFactor:u.emissiveFactor,occlusionTexture:u.occlusionTexture,metallicRoughnessTexture:null==y?void 0:y.metallicRoughnessTexture,metallicFactor:null==y?void 0:y.metallicFactor,roughnessFactor:null==y?void 0:y.roughnessFactor}):e({normalTexture:u.normalTexture,emissiveTexture:u.emissiveTexture,emissiveFactor:u.emissiveFactor,occlusionTexture:u.occlusionTexture,metallicRoughnessTexture:null==y?void 0:y.metallicRoughnessTexture,metallicFactor:null==y?void 0:y.metallicFactor,roughnessFactor:null==y?void 0:y.roughnessFactor}),O=M?i[0]:(null==y?void 0:y.metallicFactor)??ue[0],E=M?i[1]:(null==y?void 0:y.roughnessFactor)??ue[1],T="mask"===u.alphaMode?li.Color|li.AlphaMask:li.Color,V={baseColorFactor:x?[x[0],x[1],x[2],x[3]]:[1,1,1,1],baseColorTextureId:t2(null==y?void 0:y.baseColorTexture,T),metallicRoughnessTextureId:t2(null==y?void 0:y.metallicRoughnessTexture,li.MetallicRoughness),metallicFactor:O,roughnessFactor:E},$={alphaMode:u.alphaMode,alphaCutoff:u.alphaCutoff,doubleSided:u.doubleSided,cullFace:"none"===u.cullFace?n.None:"back"===u.cullFace?n.Back:"front"===u.cullFace?n.Front:n.None,normalTextureId:t2(u.normalTexture,li.Normal),emissiveTextureId:t2(u.emissiveTexture,li.Emissive),occlusionTextureId:t2(u.occlusionTexture,li.Occlusion),emissiveFactor:S?[S[0],S[1],S[2]]:[0,0,0],metallicRoughness:V,wrapTextures:!1,hasParametersFromSource:M},q=[];return v.forEach((({usage:e},i)=>{const n=null!=t&&t[i]&&t[i].formats,u=n?T$1(n.map((({name:e,format:t})=>({name:e,encoding:Pi[t]})))):[];q.push({id:i,usage:e,encodings:u})})),{material:$,textures:q}}(u,f,"integrated-mesh"===t.type)))}}_load(e,t,i){return this._streamDataController.request(e,t,i)}_loadAttribute(e,t,i){const n=`${this._layerUrl}/nodes/${e.resources.attributes}/attributes/${t.key}/0`;return this._load(n,"binary",i).then((e=>pe(t,e)))}async loadAttributes(e,t,i){const n=await Promise.allSettled(t.map((t=>this._loadAttribute(e,t.attributeStorageInfo,i)))),u={};for(let f=0;f<t.length;++f){const i=n[f],v=t[f];if("fulfilled"===i.status){const e=i.value;u[v.name]=e}else{const t=i.reason;ve(t),this._logger.error("#loadAttributes",this._logLayer,`Failed to load attributeData for '${v.name}' on node '${e.id}'`,t)}}return u}async loadNodeData(e,t){const i=null!=this._requiredAttributes&&e.resources.attributes?be(this.loadAttributes(e,this._requiredAttributes,t)):null,{bufferDefinition:u,bufferIndex:f}=function _(e,t){const i={bufferDefinition:null,bufferIndex:0},n=t.resources.geometryDefinition;if(null==e||null==n||n<0)return i;const u=n>=0?e[n].geometryBuffers:null;if(null==u)return i;for(let f=0;f<u.length;f++){const e=u[f];if(null==e.compressedAttributes)i.bufferIndex=f,i.bufferDefinition=u[f];else if("draco"===e.compressedAttributes.encoding&&!X("disable-feature:i3s-draco"))return i.bufferIndex=f,i.bufferDefinition=e,i}return i}(this._geometryDefinitions,e),v=!!e.resources.geometry,y=v?be(this._loadGeometry(e.resources.geometry,f,t)):null,x=e.resources.hasSharedResource?await this._loadShared(e,t):null,S=e.resources.materialDefinition,M=this._materialAndTextures&&null!=S&&S>=0?this._materialAndTextures[S]:null!=x?function F(e){var t,i;const u=(null==e?void 0:e.materialDefinitions)?Object.keys(e.materialDefinitions)[0]:null,f=(null==e?void 0:e.textureDefinitions)?Object.keys(e.textureDefinitions)[0]:null,v=u?null==(t=e.materialDefinitions)?void 0:t[u]:null,y=f?null==(i=e.textureDefinitions)?void 0:i[f]:null,x=b2();if(null!=v){const e=v.params;e.diffuse&&(x.metallicRoughness.baseColorFactor=[e.diffuse[0],e.diffuse[1],e.diffuse[2],1]),null!=e.doubleSided&&(x.doubleSided=e.doubleSided,x.cullFace=e.doubleSided?n.None:n.Back),"none"!==e.cullFace&&"front"!==e.cullFace&&"back"!==e.cullFace||(x.cullFace="none"===e.cullFace?n.None:"back"===e.cullFace?n.Back:n.Front),e.transparency&&(x.metallicRoughness.baseColorFactor[3]=ce(1-e.transparency,0,1)),(e.useVertexColorAlpha||x.metallicRoughness.baseColorFactor[3]<1)&&(x.alphaMode="blend")}const S=[];if(null!=y){const e=0;!y.wrap||"repeat"!==y.wrap[0]&&"repeat"!==y.wrap[1]||(x.wrapTextures=!0);let t=li.Color;"rgba"===y.channels&&(x.alphaMode="blend",t|=li.AlphaMask);const i=y.images.length-1,n=y.images[i],t3=e=>null==e?void 0:e.split("/").pop(),u=Array.isArray(y.encoding)?T$1(y.encoding.map(((e,t)=>({name:t3(n.href[t]),encoding:Fi[e]||0})))):[{name:t3(n.href),encoding:Fi[y.encoding]||0}];S.push({id:e,usage:t,encodings:u}),x.metallicRoughness.baseColorTextureId=e}return{material:x,textures:S}}(x):null,O=null==M?void 0:M.material,E=(null==M?void 0:M.textures)??[],T=`${e.id}`,V=!v&&this._options.loadFeatureData,$=V?await this._loadFeatureData(T,t):null,q=V?function m(e){if(!e)return null;for(const t of e.featureData){const e=t.geometries;if(null!=e)for(const i of e)return{featureIds:[t.id],featureDataPosition:t.position,geometries:[i]}}return null}($):function c(e){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}}(O),G=null==q?function h2(e){if(!e)return null;const t=new Array;for(const i of e.featureData)null!=i.position&&t.push({featureIds:[i.id],featureDataPosition:i.position,geometries:[]});return t}($):null,U=E.length>0?be(this.loadTextures(e,E,t)):null;let j=null,B=null;if(y){j=ye(await y);const e=function g(e,t){if(!e||!(null==t?void 0:t.materialDefinitions))return e;const i=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[i].params.vertexRegions&&e.vertexAttributes.region&&delete(e=Ce(e)).vertexAttributes.region,e}(this._defaultGeometrySchema,x);B=xe(u,e)}const z=U?ye(await U):null,Q=i?ye(await i):{},J=Q?{attributeData:Q,loadedAttributes:this._requiredAttributes}:null;if(null!=q)return{geometryData:q,attributeDataInfo:J,geometryBuffer:j,geometryDescriptor:B,requiredTextures:E,textureData:z};if(null!=G)return{pointData:G,attributeDataInfo:J,geometryBuffer:j,geometryDescriptor:B,requiredTextures:E,textureData:z};throw new Error}static _addAbsoluteHrefTexture(e,t){const i=e.textureDefinitions;if(null!=i)for(const n of Object.keys(i))for(const e of i[n].images)Array.isArray(e.href)?e.hrefConcat=e.href.map((e=>Ne(e,t))):e.hrefConcat=Ne(e.href,t)}static _fixTextureEncodings(e){const t=e.textureDefinitions;if(null!=t)for(const i in t){const e=t[i];if(Array.isArray(e.encoding))for(let t=0;t<e.encoding.length;t++){const i=e.encoding[t];"data:"===i.substring(0,5)&&(e.encoding[t]=i.substring(5))}else{const t=e.encoding;"data:"===t.substring(0,5)&&(e.encoding=t.substring(5))}}}async _loadShared(e,t){if(null==e.resources.geometry)return{};const i=`${this._layerUrl}/nodes/${e.resources.geometry}/shared`,n=await this._load(i,"json",t);return d._fixTextureEncodings(n),d._addAbsoluteHrefTexture(n,i),n}_loadTexture(e,t,i,n,u,f){let v=!1;return u===ai.DDS_S3TC||u===ai.KTX2||u===ai.Basis?this._load(e,"binary",f).then((e=>({id:t,usage:i,data:e,encoding:u,downsampled:v}))):this._load(e,"image",f).then((e=>{let f=e;if(n&&e.width*e.height>=4096){const t=Math.ceil(e.width/2),i=Math.ceil(e.height/2),n=document.createElement("canvas");n.width=t,n.height=i,n.getContext("2d").drawImage(e,0,0,t,i),f=n,v=!0}return{id:t,usage:i,data:f,encoding:u,downsampled:v}}))}loadTextures(e,t,i){const n=!!this._options.uncompressedTextureDownsamplingEnabled,u=this._options.textureUsageMask;return Promise.all(t.map((t=>{if(!(t.usage&u))return null;const f=D$1(t.encodings,this._options.textureEncodings);if(null==f)return this._logger.error("#loadTextures",this._logLayer,`No known encoding for texture found on node ${e.id}`),Promise.reject();const v=e.resources.texture||e.id,y=`${this._layerUrl}/nodes/${v}/textures/${f.name}`;return this._loadTexture(y,t.id,t.usage,n,f.encoding,i)})))}_loadFeatureData(e,t){const i=`${this._layerUrl}/nodes/${e}/features/0`;return this._load(i,"json",t)}_loadGeometry(e,t,i){const n=`${this._layerUrl}/nodes/${e}/geometries/${t}`;return this._load(n,"binary",i)}}class r{constructor(e,t,i){this._requester=e,this._customParameters=t,this._apiKey=i,this._activeRequests=new Set}get busy(){return this._requester.busy}request(e,t,i){const n=new AbortController,u=Ie(i,(()=>n.abort())),f={signal:n.signal,query:{...this._customParameters,token:this._apiKey}},v=this._requester.request(e,t,f),y={response:v,abortController:n,abortHandle:u};return this._activeRequests.add(y),we(v,(()=>{var e;y.abortController=null,null==(e=y.abortHandle)||e.remove(),y.abortHandle=null,this._activeRequests.delete(y)})),v}cancelAll(){this._activeRequests.forEach((e=>{var t,i;null==(t=e.abortController)||t.abort(),e.abortController=null,null==(i=e.abortHandle)||i.remove()})),this._activeRequests.clear()}}const Ai=1e5;let Ei=class H{get _frustumMbsCenter(){return this._frustumMbs}get _frustumMbsRadius(){return this._frustumMbs[3]}get _frustumPlanes(){return this._frustum}constructor(e,t,i,n,u,f,v,y,x={}){this._indexSR=e,this._renderCoordsHelper=t,this._clippingArea=u,this._elevationProvider=f,this._viewingMode=v,this._options=x,this._frustum=Se(),this._frustumMbs=Me(),this._useFrustumCulling=!1,this._poi=Re(),this._elevationContext=null,this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=new te,this._tmp1=Re(),this._tmp2=Re(),this._tmp3=Re(),this._tmp0=Re(),this._screenspaceErrorBias=x.screenspaceErrorBias||1,this._progressiveLoadFactor=x.progressiveLoadFactor||1,this.updateCamera(i,n);const S=this._renderCoordsHelper.spatialReference;this._renderSR=S,this._renderSRSphericalPCPF=De(S),this._isGlobalMode=S===this._renderSRSphericalPCPF,this.updateElevationInfo(y),this._tmpPoint=Pe(0,0,0,e),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(S.isWebMercator||Fe(S)),this._indexSREllipsoidRadius=Le(this._indexSR).radius,this._indexSRSphericalPCPF=De(e),this._projectorIndexSRToIndexSRSphericalPCPF=Oe(this._indexSR,this._indexSRSphericalPCPF)}updateElevationInfo(e){null!=e?(this._elevationContext=Ae.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(Ee(Te(e,!1)))):this._elevationContext=null}updateCamera(e,t){if(this._useFrustumCulling=t,t){Ve(e.viewMatrix,e.projectionMatrix,this._frustum,Vi);{const t=e.eye,i=Ti;$e(i,e.viewForward);const n=$i;ke(n,Vi[4],t);const u=.5*qe(n,n)/qe(i,n),f=this._frustumMbs;Ge(f,t,i,u);const v=1+u;f[3]=v}}this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(e){this._poi=e}updateScreenSpaceErrorBias(e){const t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t}updateClippingArea(e){this._clippingArea=e}expandElevationRange(e,t,i){var n,u;if(null==this._elevationContext)return;const f=e.serviceMbsInIndexSR;if(!f)return;const v="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds){const e=this._elevationProvider.getSphereElevationBounds(f,this._indexSR,v);return void(e&&i.expandElevationRange(e))}const y=f[0],x=f[1],S=f[2],M=this._elevationProvider.getElevation(y,x,S,this._indexSR,v);M&&i.expandElevationRangeValues(M,M);const O=t?null:null==(u=(n=this._elevationProvider).getRootElevationBounds)?void 0:u.call(n);O&&i.expandElevationRange(O)}getServiceMbsInRenderSR(e){const t=e.serviceMbsInRenderSR;if(Ue(t))return t;e.serviceMbsInIndexSR&&je(t,e.serviceMbsInIndexSR);const i=e.elevationRangeMin;if(this._elevationContext&&Number.isFinite(i)){let n=0,u=0;const f=e.elevationRangeMax;switch(this._elevationContext.mode){case"relative-to-ground":case"relative-to-scene":n=this._elevationContext.geometryZWithOffset(t[2],this._renderCoordsHelper)+i-t[2],u=f-i;break;case"on-the-ground":n=i-t[2],u=f-i}t[2]+=n+.5*u,t[3]+=.5*u}else this._elevationContext&&t[3]<Ai&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=Be(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper));return Qt(t,this._indexSR,t,this._renderSR),t}getAndUpdateVisibilityObbInRenderSR(e){{const t=e.visibilityObbInRenderSR;if(t)return t}const t=.01*this._indexSREllipsoidRadius,{serviceMbsInIndexSR:i,serviceObbInIndexSR:n}=e;if(null==n||!i||!n.isValid||this._isECEFOBBInLocalMode&&(n.halfSizeX>t||n.halfSizeY>t||n.halfSizeZ>t))return null;{let t=e.serviceObbInRenderSR;if(null==t)t=new te,e.serviceObbInRenderSR=t;else if(t.isValid)return t;const u=i[3];let f=0,v=0;const y=n.centerZ,x=this._renderCoordsHelper,S=this._elevationContext;if(S&&e.elevationRangeValid){const t=e.elevationRangeMin,i=e.elevationRangeMax;switch(S.mode){case"relative-to-ground":case"relative-to-scene":f=S.geometryZWithOffset(y,x)+t-y,v=i-t;break;case"on-the-ground":f=t-y,v=i-t}}else if(S&&u<Ai){const e=this._tmpPoint;e.x=n.centerX,e.y=n.centerY,e.z=y,f=Be(e,this._elevationProvider,S,x)-y}const M=v>0,O=M?this._tmpObb:t;return n.transform(O,this._indexSR,this._renderSR,f,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),M&&ze(O,0,v,this._viewingMode,t),t}}getNodeObbInRenderSRIndependentOfElevationOffset(e){{const t=e.visibilityObbInRenderSR??e.serviceObbInRenderSR??null;if(null==t?void 0:t.isValid)return t}const t=e.serviceObbInIndexSR;return t?(t.transform(ji,this._indexSR,this._renderSR,void 0,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),ji):null}ensureElevationAgnosticBoundingVolume(e){return-1===e.elevationAgnosticBoundingVolume[3]&&e.level>0&&(this._viewingMode===He.Global?this._updateElevationAgnosticBoundingVolumeGlobal(e):this._updateElevationAgnosticBoundingVolumeLocal(e)),e.elevationAgnosticBoundingVolume}_updateElevationAgnosticBoundingVolumeGlobal(e){const t=this.getNodeObbInRenderSRIndependentOfElevationOffset(e),i=e.elevationAgnosticBoundingVolume;let n,u=-1;if(t){const e=Bi;t.getCenter(e),$e(e,e),n=e,t.getCorners(zi);for(const t of zi){$e(t,t);const n=qe(t,e);if(n<=0)return void(i[3]=-1);const f=Math.sqrt(1-n*n);u=Math.max(u,f)}}else{const t=e.serviceMbsInRenderSR;if(!Ue(t))return void(i[3]=-1);{const e=Qe(Bi,Je(t)),f=t[3],v=We(e);if(v<f)return void(i[3]=-1);u=f/v,$e(e,e),n=e}}Ke(i,n);i[3]=u+.001}_updateElevationAgnosticBoundingVolumeLocal(e){const t=e.elevationAgnosticBoundingVolume,i=this.getNodeObbInRenderSRIndependentOfElevationOffset(e);if(i){const e=i.getCenter(Bi);e[2]=0,Ke(t,e);let n=0;const u=Hi;i.getCorners(zi);for(const t of zi){t[2]=0;const e=Xe(u,t);n=Math.max(n,e)}t[3]=Math.sqrt(n)}else{const i=e.serviceMbsInRenderSR;if(Ue(i)){const e=Qe(Bi,Je(i));e[2]=0,Ke(t,e),t[3]=i[3]}}}isNodeVisible(e){const t=this.getServiceMbsInRenderSR(e);if(!this._isMBSinClippingArea(t))return!1;if(!this._useFrustumCulling)return!0;const i=this.getAndUpdateVisibilityObbInRenderSR(e);return i?i.doesIntersectFrustumConservativeApproximation(this._frustum):Ze(this._frustum,Ye(t))}isElevationAgnosticBoundingVolumeVisible(e){return!this._useFrustumCulling||-1===e[3]||(this._viewingMode===He.Global?this._isConeVisibleInFrustum(e):this._isCylinderVisibleInFrustum(e))}_isConeVisibleInFrustum(e){if(!this._isConeVisibleInFrustumMbs(e))return!1;const t=e[3];if(-1===t||t>.9)return!0;const i=this._frustumPlanes,n=this._frustumMbsCenter,u=e,f=qe(u,n),v=this._frustumMbsRadius,y=f-v,x=f+v;if(y<=0)return!0;const S=et(qi,u,y),M=et(Gi,u,x),O=t/Math.sqrt(1-t*t);for(const E of i){const e=ct(E),t=$e(Ui,e),i=qe(t,u);if(Math.abs(1-i)<.01)continue;const n=Qi;et(n,u,i),ke(n,n,t),$e(n,n);const f=Ji;if(Ge(f,S,n,y*O),!(tt(E,f)<=0||(Ge(f,M,n,x*O),tt(E,f)<=0)))return!1}return!0}_isConeVisibleInFrustumMbs(e){const t=e[3];if(t>.9)return!0;const i=this._frustumMbsRadius,n=this._frustumMbsCenter,u=We(n);if(u<=i)return!0;const f=e,v=qe(f,n);{const e=et(ki,f,v);if(it(e,n)<i)return!0}const y=v/u;if(v<=0)return-y<i;const x=Math.sqrt(1-y*y);if(x<t)return!0;const S=i/u;return x*Math.sqrt(1-S*S)-S*y<t}isObbVisibleIndependentOfElevation(e,t){if(!this._useFrustumCulling)return!0;if(-1===e[3])return!0;const i=this._frustumMbsRadius,n=this._frustumMbsCenter,u=this._frustumPlanes,f=zi;if(t.getCorners(f),this._viewingMode===He.Global){const t=e,v=qe(t,n),y=v-i,x=v+i;if(y<=0)return!0;for(const e of u){let i=!0;for(const n of f){const u=qe(n,t),f=Wi;if(et(f,n,y/u),tt(e,f)<=0){i=!1;break}const v=Wi;if(et(v,n,x/u),tt(e,v)<=0){i=!1;break}}if(i)return!1}}else{const e=n[2]-i,t=n[2]+i;for(const i of u){let n=!0;const u=ct(i),v=u[0],y=u[1],x=u[2],S=i[3];for(const i of f){const u=v*i[0]+y*i[1]+S;if(u+x*e<=0||u+x*t<=0){n=!1;break}}if(n)return!1}}return!0}_isCylinderVisibleInFrustum(e){const t=this._frustumMbsCenter,i=this._frustumMbsRadius,n=Qe(ki,t);n[2]=0;const u=e[3];return it(n,e)<=u+i}isGeometryVisible(e){if(!this._useFrustumCulling)return!0;const t=e.geometryObbInRenderSR;return(null==t?void 0:t.doesIntersectFrustumConservativeApproximation(this._frustum))??this.isNodeVisible(e)}_isMBSinClippingArea(e){return null==this._clippingArea||st(this._clippingArea,e)!==nt.OUTSIDE}_screenSpaceDiameterMbs(e,t){const i=this.getServiceMbsInRenderSR(e),n=Math.sqrt(rt(Je(i),this._camPos)),u=n-i[3];return this._updateMinMaxDistance(n),u<0?.5*Number.MAX_VALUE:t/u*this._screenSizeFactor}calcCameraDistance(e){return this.calcCameraDistanceToCenter(e)-this.getServiceMbsInRenderSR(e)[3]}calcCameraDistanceToCenter(e){const t=this.getServiceMbsInRenderSR(e),i=ot(Je(t),this._camPos);return this._updateMinMaxDistance(i),i}calcAngleDependentLoD(e){const t=this.getServiceMbsInRenderSR(e),i=t[3],n=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/at(Je(t))+i)/ot(Je(t),this._camPos);return Math.min(1,n)}hasLOD(e){return e.lodMetric!==Wt.None}_getDistanceGlobeMode(e,t){const i=at(Je(t)),n=at(e)-i;et(this._tmp0,e,qe(e,Je(t))/lt(e));const u=rt(Je(t),this._tmp0),f=t[3];if(u<=f*f)return Math.abs(n);{const u=et(this._tmp0,Je(t),1/i),v=i,y=f*f/2/v,x=et(this._tmp1,u,v-y),S=e,M=dt(this._tmp2,S,x),O=dt(this._tmp2,M,et(this._tmp3,u,qe(u,M))),E=ht(this._tmp2,x,et(this._tmp2,O,f/at(O)));let T=ot(S,E);if(n>=2e5){const e=dt(this._tmp1,S,E);let t=qe(e,u)/at(e);t<.08&&(t=1e-4),T/=t}return T}}_getDistance(e,t){return this._isGlobalMode?this._getDistanceGlobeMode(e,t):function W(e,t){const i=e[0]-t[0],n=e[1]-t[1],u=e[2]-t[2],f=i*i+n*n,v=t[3];if(f<=v*v)return Math.abs(u);const y=Math.sqrt(f)-v;return Math.sqrt(u*u+y*y)}(e,t)}_updateMinMaxDistance(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}getLodLevel(e){if(e.lodMetric===Wt.None)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){const t=this._progressiveLoadFactor*this._screenspaceErrorBias,i=this._screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(e,t){switch(e.lodMetric){case Wt.ScreenSpaceRelative:{const i=this.getServiceMbsInRenderSR(e),n=this._getDistance(this._camPos,i),u=2*n/this._screenSizeFactor,f=n+i[3];return this._updateMinMaxDistance(f),e.maxError*t<=u}case Wt.MaxScreenThreshold:{let i=this._screenSpaceDiameterMbs(e,e.serviceMbsInIndexSR[3]*t);return this._options.angleDependentLoD&&(i*=this.calcAngleDependentLoD(e)),i<e.maxError}case Wt.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case Wt.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(e)>e.maxError*t}return!1}distToPOI(e){const t=this.getServiceMbsInRenderSR(e);return ot(Je(t),this._poi)-t[3]}distCameraToPOI(){return ot(this._camPos,this._poi)}};const Ti=Re(),Vi=ut(),$i=Re(),ki=Re(),qi=Re(),Gi=Re(),Ui=Re(),ji=new te,Bi=Re(),zi=[Re(),Re(),Re(),Re(),Re(),Re(),Re(),Re()],Hi=Re(),Qi=Re(),Ji=Re(),Wi=Re(),Ki=1e-4;let Xi=class extends(gt(z)){get isMeshPyramid(){var e;return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===(null==(e=this.layer.store)?void 0:e.lodType)}get isGraphics3D(){return"points"===this.layer.profile}get useMaximumNumberOfFeatures(){return!this.isMeshPyramid&&(null==this.layer.priority||"High"===this.layer.priority)}get indexStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(_t.I3S_INDEX);return new r(e,this.layer.customParameters,this.layer.apiKey)}get dataStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(_t.I3S_DATA);return new r(e,this.layer.customParameters,this.layer.apiKey)}get crsVertex(){return mt(this.layer)}get crsIndex(){return ft(this.layer)}get layer(){return this.layerView.i3slayer}get running(){return this.updating}get rootNodeVisible(){if(this._index){const e=this._index.rootNode;if(e)return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}get index(){return this._index}get requiredAttributes(){return this._requiredAttributes}constructor(e){super(e),this.screenSizeFactor=0,this.featureTarget=5e4,this.fixedFeatureTarget=!1,this.updating=!0,this.updatingProgress=1,this.leavesReached=!1,this.worker=null,this._featureLOD=1,this._stableFeatureLOD=!1,this._isIdle=!1,this._cameraDirty=!0,this._invisibleDirty=!1,this._idleStateCallbacks=null,this._newLoadingNodes=new Z({deallocator:null}),this._modificationsNodeFilteringArray=new Z,this._downloadingCount=0,this._loadingNodes=new Map,this._updatingNodes=new Map,this._progressMaxNumNodes=1,this._requiredAttributes=new Array,this._requiredAttributesDirty=!0,this._updatesDisabled=!1,this.disableIDBCache=!1,this._disableMemCache=!1,this._restartNodeLoading=!1,this._fields=null,this._attributeStorageInfo=null,this._idleQueue=new pt,this._elevationUpdateNodes=new Z({deallocator:null}),this._errorCount=0}initialize(){const{layerView:e,layer:t}=this;this._disableMemCache=!e.loadCachedGPUData||!e.addCachedGPUData,this._lodHandling=new o(e),this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=X("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo),this.addResolvingPromise(Promise.all([t.indexInfo,t.when(),e.when()]).then((([i])=>{if(this.destroyed||!e||e.destroyed||!i)return;const{view:n,clientGeometry:u}=e,{resourceController:f}=n;if(this._setClippingArea(n.clippingArea),this.addHandles([vt((()=>{var e,t;return null==(t=null==(e=null==n?void 0:n.pointsOfInterest)?void 0:e.focus)?void 0:t.renderLocation}),(e=>this._pointOfInterestChanged(e)),bt),vt((()=>n.quality),(()=>this._setCameraDirty()),yt),vt((()=>e.contentVisible),(e=>{const t=e?()=>this._updateIdleState(!0):()=>this._updateViewData(),i=e?()=>this._updateIdleState(!1):()=>{};e&&null!=this._index&&this._index.invalidateAllElevationRanges(),this._idleStateCallbacks?(e||this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=t,this._idleStateCallbacks.idleEnd=i):this._idleStateCallbacks=f.scheduler.registerIdleStateCallbacks(t,i)}),bt),h$2(e.view.resourceController.scheduler,this),vt((()=>e.uncompressedTextureDownsamplingEnabled),(()=>this.restartNodeLoading())),vt((()=>[this.featureTarget,this.fixedFeatureTarget]),(()=>{this._setCameraDirty(),this._stableFeatureLOD=!1})),vt((()=>{var e;return null==(e=n.state)?void 0:e.contentCamera}),(()=>this._setCameraDirty())),vt((()=>t.elevationInfo),(e=>this._elevationInfoChanged(e))),vt((()=>e.lodFactor),(()=>this._setCameraDirty())),vt((()=>e.availableFields),(()=>this._requiredFieldsChange())),vt((()=>e.holeFilling),(e=>null!=this._index&&(this._index.holeFilling=e)))]),this._viewportQueries=new Ei(this.crsIndex,n.renderCoordsHelper,n.state.contentCamera,!n.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,this.isMeshPyramid?n.basemapTerrain:n.elevationProvider,xt(n.viewingMode),this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this._lod,angleDependentLoD:this._lod<.5}),this._clientNodeLoader=new hi(this.layer.uid,{indexSR:this.crsIndex,vertexSR:this.crsVertex,renderSR:n.renderCoordsHelper.spatialReference,localMode:"local"===n.viewingMode},n.resourceController.memoryController,this.worker),this._index=new I(xt(n.viewingMode),t,i,this.indexStreamController,this._clientNodeLoader,this._viewportQueries,Nt.getLogger(this),e.holeFilling,(t=>e.isNodeLoaded(t)),(t=>e.isNodeReloading(t)),(e=>this._shouldLoadNode(e)),(e=>this._enableFromGPUCache(e,ti.Leaf)),(e=>this._needsUpdate(e)),(()=>!this.indexStreamController.busy),(t=>{var i;return(null==(i=e.computeVisibilityObb)?void 0:i.call(e,t))??null}),(null==e?void 0:e.computeNodeFiltering)?t=>e.computeNodeFiltering(t):void 0),this._index.updateElevationInfo(this.layer.elevationInfo,this.isMeshPyramid||this.isGraphics3D),this._index.imModificationsChanged(!!e.hasModifications),this._index.layerFilterChanged(!!e.hasGeometryFilter),null!=u){for(const e of u)this._addMesh(e.mesh,e.oid);this.addHandles(u.on("change",(e=>{for(const t of e.removed)this._removeMesh(t.oid);for(const t of e.added)this._addMesh(t.mesh,t.oid)})))}this._startNodeLoading()})))}updateNodeModificationStatus(e){const t=this._index,i=this.layerView;null!=t&&(null==i?void 0:i.updateNodeModificationStatus)&&(this._modificationsNodeFilteringArray.clear(),e.forAll((e=>{const i=t.getNode(e);null!=i&&this._modificationsNodeFilteringArray.push(i)})),i.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}destroy(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._nodeLoader=null,Zi.prune(),null!=Yi&&(Yi.hide(),Yi=null)}get viewportQueries(){return this._viewportQueries}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((i=>{const n=H2(e,i),u=H2(t,i);return n>=0&&u>=0?{index:n,name:t[u].name,field:t[u],attributeStorageInfo:e[n]}:null})).filter((e=>null!=e&&e.name!==i))}_requiredFieldsChange(){const e=this._getRequiredAttributes();R(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}requestUpdate(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}_setClippingArea(e){const t=Ct();It(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}_pointOfInterestChanged(e){null!=this._viewportQueries&&(this._viewportQueries.setPointOfInterest(e),null!=this._index&&(this._index.progressiveLoadPenalty=es.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}updateClippingArea(e){this._setClippingArea(e),null!=this._viewportQueries&&null!=this._index&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}_setCameraDirty(){this._cameraDirty=!0,this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}_addMesh(e,t){if(null==this._index)return;const i=this._clientNodeLoader.createMeshNodeInfo(e,t),n=this._index.addClientNodeToIndex(i.id,i.mbs);this._clientNodeLoader.addMeshNode(n,i),this._evaluateUpdating(),this.notifyChange("rootNodeVisible")}_removeMesh(e){const t=this._clientNodeLoader.getMeshNodeIndex(e);if(null!=t){if(null==this._index)throw new Error("delayed removal of client side i3s node geometry not supported yet.");{const e3=(e,t)=>{var i,n,u,f;this.layerView.removeNode(t),this._clientNodeLoader.removeNode(e),this.layerView.deleteCachedNodeData&&null!=e&&this.layerView.deleteCachedNodeData(e),null==(f=(u=this.layerView).deleteCachedGPUData)||f.call(u,null==(n=(i=this.layerView).loadCachedGPUData)?void 0:n.call(i,t))},i2=(e,t,i)=>{this._clientNodeLoader.updateNodeIndex(e,t,i),this.layerView.updateNodeIndex&&this.layerView.updateNodeIndex(t,i)};this._index.removeClientNodeFromIndex(t,e3,i2),this.notifyChange("rootNodeVisible")}}}updateElevationChanged(e,t){const i=this._index;if(null==(null==i?void 0:i.rootNode)||null==t)return null;this.crsIndex.equals(t)||(wt(e,t,ts,this.crsIndex),e=ts);const n=this._elevationUpdateNodes;return n.clear(),St(e,i.rootNode,i,(e=>n.push(e.index))),n.length&&(n.forAll((e=>i.updateElevationChanged(e))),this._setCameraDirty()),n}removeAllGeometryObbs(){null!=this._index&&this._index.removeAllGeometryObbs()}getRenderMbs(e){return null!=this._viewportQueries?this._viewportQueries.getServiceMbsInRenderSR(e):null}_elevationInfoChanged(e){null!=this._index&&(this._index.updateElevationInfo(e,this.isMeshPyramid||this.isGraphics3D),this._setCameraDirty())}restartNodeLoading(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}schedule(e,t){return this._idleQueue.push(e,t)}reschedule(e,t){return this._idleQueue.unshift(e,t)}get _isIntegratedMesh(){return"integrated-mesh"===this.layer.type}get unloadedMemoryEstimate(){return null!=this._index&&this.layerView.contentVisible?this._index.unloadedMemoryEstimate*this._lodDropFactor:0}async _loadNodeData(e,t){return e.index<0?this._clientNodeLoader.loadNodeData(e.id,t):this._nodeLoader.loadNodeData(e,t)}async _loadAttributes(e,t,i){return(e.index<0?this._clientNodeLoader:this._nodeLoader).loadAttributes(e,t,i)}get indexDepth(){return null!=this._index?this._index.maxLevel:0}set disableMemCache(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData?this._disableMemCache=e:this._disableMemCache=!0}runTask(e,t){return this.layerView.contentVisible?this.layerView.visible&&null!=this._index?(this._processWithErrorLogging(e,t),this._index.maxPriority):-1/0:(this._updateViewData(),this._evaluateUpdating(),-1/0)}_processWithErrorLogging(e,t){try{this._process(e,t)}catch(i){this._errorCount<50?Nt.getLogger(this).error(`Error during processing: ${i} at ${i.stack}`):50===this._errorCount&&Nt.getLogger(this).error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}_process(e,t){this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&null!=this._index&&(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this._isIntegratedMesh&&(e.enabled=!1),e.run((()=>this._processIndex(e))),this._updateFeatureLOD(),e.run((()=>this._processCache(e))),this._isIntegratedMesh&&(e.enabled=!0),e.run((()=>this._processNodes(e,t))),this._idleQueue.runTask(e),e.run((()=>this._prefetchIndex())),t.numIndexLoading+=this._index.indexLoading,t.numNodesLoading+=this._downloadingCount,e.run((()=>this._lodHandling.lodGlobalHandling(e))),this._evaluateUpdating())}_processIndex(e){if(null==this._index)return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),e,(e=>this.updateNodeModificationStatus(e))),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));const t=this._index.featureEstimate.leavesReached;this._index.isLoading||t===this._get("leavesReached")||this._set("leavesReached",t)}return this._index.load()}_prefetchIndex(){return!(null==this._index||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}_updateFeatureLOD(){if(!this.useMaximumNumberOfFeatures||null==this._index||null==this._viewportQueries)return;const e=!this._index.isLoading,t=this.featureTarget*this._baseLOD,i=this._index.featureEstimate;if(i.estimate=i.estimate||t/2,this._index.indexMissing>500){if(this._featureLOD<=Ki)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;const e=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=e;const n=this._lod,u=this._index.checkFeatureTarget(t,n);u!==n&&(this._featureLOD=u/this._baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*t||e&&i.estimate>t))return;if(this._featureLOD<=Ki)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(Ki,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.requestUpdate()}_processCache(e){const t=this._index;if(null==t)return!1;for(;this._newLoadingNodes.length>0&&!e.done;){const i=this._newLoadingNodes.pop();for(let n=t.getParent(i);null!=n&&!this.layerView.isNodeLoaded(n.index);n=t.getParent(n.index))if(this._enableFromGPUCache(n,ti.Hole)){e.madeProgress();break}}return e.hasProgressed}_processNodes(e,t){if(null==this._index)return!1;let i=(this._isIdle?100:2)-this._loadingNodes.size;const n=this._index.updates;for(n.cancel.forEach(this._cancelNode,this),n.cancel=[];n.remove.length>0&&!e.done;)this.layerView.removeNode(n.remove.pop()),e.madeProgress();for(;n.update.length>0&&!e.done;){const t=this._index.getNode(n.update.pop());null!=t&&(this._updateLoadedNode(t),e.madeProgress())}for(;n.add.length>0&&!e.done&&i>0;){--i;const u=this._index.getNode(n.add.back());if(null==u||u.cacheState!==ii.Cached&&!this._hasNodeLoadToken(t))break;n.add.pop(),this._loadNode(u),e.madeProgress()}return e.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach((e=>e.abort())),this._loadingNodes.clear(),this._updatingNodes.forEach((e=>e.abort())),this._updatingNodes.clear()}_cancelNode(e){const t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}_hasNodeLoadToken(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<Mt&&!this.dataStreamController.busy}_evaluateUpdating(){let e=!1,t=0;if(this.layerView){if(this.layerView.contentVisible){const i=(null!=this._index?this._index.indexMissing:0)+3*(null!=this._index?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling||null!=this._index&&this._index.isPrefetching),0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),t=1-i/this._progressMaxNumNodes}else e=this._cameraDirty,t=e?0:1;this.updating=e,this.updatingProgress=t}}_updateViewData(){if(!this._cameraDirty||null==this._index||null==this._viewportQueries)return;const e=this.layerView.view,{contentCamera:t,fixedContentCamera:i}=e.state;this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._viewportQueries.updateCamera(t,!i||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=es.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}_getProgressiveLoadFactor(){return this.layerView.view.quality<1?1:this.layerView.progressiveLoadFactor}get _lod(){return this._featureLOD*this._baseLOD}get _baseLOD(){const e=this.layerView.lodFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*this.layerView.view.quality}get _lodDropFactor(){return this.fixedFeatureTarget?1:(Math.min(this.layerView.view.quality,.5)-Rt)/(.5-Rt)}isGeometryVisible(e){var t;return!!(null==(t=this._index)?void 0:t.isGeometryVisible(e.index))}updateVisibility(e){var t;null==(t=this._index)||t.invalidateNodeVisibilityCache(e)}invalidateGeometryVisibility(e){var t;null==(t=this._index)||t.invalidateGeometryVisibility(e)}invalidateVisibilityObbs(){var e;null==(e=this._index)||e.invalidateVisibilityObbs()}modificationsChanged(){var e;null==(e=this._index)||e.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0}_shouldLoadNode(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||null==this._index||!this._index.isGeometryVisible(e.index))}_shouldDropNode(e){if(null==this._viewportQueries)return!1;const t=this._lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}_startNodeLoading(){this._restartNodeLoading=!1;const e=this._index;if(this._updatesDisabled||null==e||null==this._viewportQueries)return;this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);const t={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures};this._nodeLoader=new d(this.layer,this.dataStreamController,Nt.getLogger(this),this._defaultGeometrySchema,this._requiredAttributes,t),e.requestUpdate(),this._lodHandling.startNodeLoading(((e,t)=>this._removeNodes(e,t,is.fadeout)),e,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}_removeInvisibleNodes(e){const t=this._index;if(null==t||null==this._viewportQueries)return!1;Zi.clear(),this.layerView.getLoadedNodeIndices(Zi);const i=0===this._viewportQueries.maxDistance,n=i?()=>!1:e=>this._shouldDropNode(e);return Zi.filterInPlace((e=>{const i=t.getNode(e);return null==i||!t.isGeometryVisible(e)||n(i)})),Zi.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(Zi,e,is.pop),!(i&&this._lodDropFactor<1||0!==Zi.length&&(Zi.clear(),1))}markNodeToRemove(e){Zi.push(e)}removeMarkedNodes(){this._removeNodes(Zi,Dt,is.pop)}_removeNodes(e,t,i){if(0!==e.length&&!t.done)for(null!=this._index&&this._index.requestUpdate();e.length>0&&!t.done;){const n=e.pop(),u=this._index;i===is.fadeout&&this.layerView.nodeFadeoutEnabled&&null!=u&&u.isGeometryVisible(n)?this.layerView.fadeNode(n,Mi.FadeOut,!0):this.layerView.removeNode(n),t.madeProgress()}}_needsUpdate(e){if(e.resources.isEmpty||this._updatingNodes.has(e.index))return!1;const t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}async _updateLoadedNode(e){const t=new AbortController;this._updatingNodes.set(e.index,t),this._evaluateUpdating();try{const i=R(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes);let n=null;n=i?this.layerView.getAttributeData(e.index):await this._loadAttributes(e,this._requiredAttributes,t.signal),await this.schedule((()=>this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:n},t.signal)),t.signal)}catch(i){if(!ee(i))return this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},t.signal)}this._updatingNodes.delete(e.index),this._evaluateUpdating()}_loadNode(e){if(this._loadingNodes.has(e.index))return void Nt.getLogger(this).error("already loading node "+e.index);const t=new AbortController;this._loadingNodes.set(e.index,t),this._evaluateUpdating(),this._loadAndAddNode(e,t.signal).then((i=>{i&&null!=this._index&&this._loadingNodes.get(e.index)===t&&(this._loadingNodes.delete(e.index),this._index.requestUpdate())})).catch((e=>{if(!ee(e))throw e})).finally((()=>{this._loadingNodes.get(e.index)===t&&this._loadingNodes.delete(e.index),this._evaluateUpdating()}))}_loadAndAddNode(e,t){return e.cacheState===ii.Uncached?this._loadUncached(e,t).then((()=>!1)):this._loadCached(e,t).then((t=>!t&&(e.cacheState=ii.Uncached,!0))).catch((t=>!ee(t)&&(e.cacheState=ii.Uncached,!0)))}_enableFromGPUCache(e,t){if(this._disableMemCache||null==this._index)return!1;if(t===ti.Hole&&!this._index.useNodeAsHole(e.index))return!0;const i=this._loadCachedGPUData(e);return!!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)}_loadCachedGPUData(e){const t=this.layerView.loadCachedGPUData(e.index);return null!=(null==t?void 0:t.attributeInfo)&&R(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}_nodeAdded(){null!=this._index&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateLoadStatus(e,t){const i=this._index;null!=i&&i.updateChildrenLoaded(e,t?1:-1)}async _loadCached(e,t){if(this._enableFromGPUCache(e,ti.Leaf))return!0;const i=this.layerView;if(this.disableIDBCache||!i.loadCachedNodeData||!i.addCachedNodeData)return!1;const n=e.index>=0?(t,i)=>this._nodeLoader.loadTextures(e,t,i):(t,i)=>this._clientNodeLoader.loadTextures(e,t,i),u=await this.schedule((()=>i.loadCachedNodeData(e,t,n)),t);if(null==u)return!1;const f=this._requiredAttributes,v=await this.reschedule((()=>this._loadAttributes(e,f,t)),t);return await this.reschedule((()=>i.addCachedNodeData(e,u,{loadedAttributes:f,attributeData:v},t)),t),this._nodeAdded(),!0}_loadUncached(e,t){return this._downloadingCount++,this._loadNodeData(e,t).catch((e=>{throw this._downloadingCount--,e})).then((i=>(this._downloadingCount--,this.schedule((()=>this.layerView.addNode(e,i,t)),t)))).then((()=>{this._nodeAdded(),e.cacheState=ii.Cached})).catch((t=>{if(!ee(t))throw Nt.getLogger(this).error("#loadNodeData()",this.layer,`Failed to load node '${e.id}'`,t),e.failed=!0,null!=this._index&&this._index.requestUpdate(),t}))}_updateIdleState(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&null!=this._index&&this._index.resetFailedNodes())}get test(){}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),null!=this._index&&this._index.requestUpdate()}geometryFilterChanged(e){const t=this._index;null!=t&&t.layerFilterChanged(e),this._setCameraDirty()}};U([j({readOnly:!0})],Xi.prototype,"isMeshPyramid",null),U([j({readOnly:!0})],Xi.prototype,"isGraphics3D",null),U([j({readOnly:!0})],Xi.prototype,"useMaximumNumberOfFeatures",null),U([j({readOnly:!0})],Xi.prototype,"indexStreamController",null),U([j({readOnly:!0})],Xi.prototype,"dataStreamController",null),U([j({readOnly:!0})],Xi.prototype,"crsVertex",null),U([j({readOnly:!0})],Xi.prototype,"crsIndex",null),U([j()],Xi.prototype,"screenSizeFactor",void 0),U([j()],Xi.prototype,"featureTarget",void 0),U([j()],Xi.prototype,"fixedFeatureTarget",void 0),U([j()],Xi.prototype,"layerView",void 0),U([j()],Xi.prototype,"layer",null),U([j()],Xi.prototype,"updating",void 0),U([j({readOnly:!0})],Xi.prototype,"running",null),U([j()],Xi.prototype,"updatingProgress",void 0),U([j({readOnly:!0})],Xi.prototype,"leavesReached",void 0),U([j({constructOnly:!0})],Xi.prototype,"worker",void 0),U([j({readOnly:!0,dependsOn:[]})],Xi.prototype,"rootNodeVisible",null),Xi=U([B("esri.layers.graphics.controllers.I3SOnDemandController")],Xi);const Zi=new Z({deallocator:null});let Yi;function R(e,t){return null!=e&&e.length===t.length&&e.every((e=>H2(t,e.name)>=0))}function H2(e,t){const i=t.toLowerCase();for(let n=0;n<e.length;n++)if(e[n].name.toLowerCase()===i)return n;return-1}const es={factorIM:.2,factor3dObject:.05,distancePenalty:10},ts=Ct();var is;!function(e){e[e.pop=0]="pop",e[e.fadeout=1]="fadeout"}(is||(is={}));const ss=Xi;let ns=class extends z{constructor(e){super(e),this._warnMaximumChangedObjectsExceeded=!1,this._maximumNumberOfEditOVerrides=os,this._original3DOFLDefinitionExpression=null,this._interactiveEditingSessions=new Pt,this.geometryOverrides=new Pt,this._clientGeometryCache=new Map,this._associatedLayerView=null,this._attributeChangedObjectIds=new si,this._geometryChangedObjectIds=new si,this._pendingFetchChangedObjectIds=null,this._pendingFetchAbortController=new AbortController,this._featureIdLocks=new Map}initialize(){var e;this._memCache=this.memoryController.newCache(`i3s-attribute-overrides-${this.layer.uid}`),this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(null==(e=this._pendingFetchAbortController)?void 0:e.signal),this._pendingFetchChangedObjectIds.finally((()=>{this._pendingFetchAbortController=null,this._pendingFetchChangedObjectIds=null})),this.is3DOFL&&null!=this._associatedLayer&&(Ft()?this._associatedLayer.load().then((e=>{this.destroyed||(this._original3DOFLDefinitionExpression=e.definitionExpression,this.addHandles(vt((()=>this._definitionExpression),(t=>e.definitionExpression=t),bt)),this._associatedLayerView=new oi({layer:this._associatedLayer,view:this.view}))})):Y())}destroy(){this.is3DOFL&&null!=this._associatedLayer&&(Ft()?null!=this._associatedLayerView&&(this._associatedLayer.definitionExpression=this._original3DOFLDefinitionExpression):Y()),this._set("layer",null),this._memCache=Lt(this._memCache),this._pendingFetchAbortController=Ot(this._pendingFetchAbortController),this._pendingFetchChangedObjectIds=null,this._featureIdLocks.clear()}get is3DOFL(){var e;return At()&&null!=(null==(e=this._associatedLayer)?void 0:e.infoFor3D)}get sortedGeometryChangedObjectIds(){return this.is3DOFL?[...this._geometryChangedObjectIds].sort(((e,t)=>e-t)):[]}get _associatedLayer(){return null==this.layer?null:this.layer.associatedLayer}get hasGeometryChanges(){return this._geometryChangedObjectIds.size>0}get _definitionExpression(){const e=this.sortedGeometryChangedObjectIds;return 0===e.length?"1 = 0":`OBJECTID IN (${e.join(",")})`}get updating(){return!!this.is3DOFL&&(!!this._pendingFetchChangedObjectIds||!!Ft()&&(!(null!=this._associatedLayerView)||null!=this._associatedLayerView&&this._associatedLayerView.updating))}get isEmpty(){return null==this._pendingFetchChangedObjectIds&&0===this._attributeChangedObjectIds.size&&0===this._geometryChangedObjectIds.size}featureHasGeometryChanges(e){return this._geometryChangedObjectIds.has(e)}featureHasAttributeChanges(e){return this._attributeChangedObjectIds.has(e)}createInteractiveEditSession(e){this._attributeChangedObjectIds.add(e);const t=this._interactiveEditingSessions,i=new D(e,(()=>{t.remove(i)}));return t.unshift(i),i}async applyAttributeOverrides(e,t,i,n=[]){if(this._pendingFetchChangedObjectIds&&await Et(this._pendingFetchChangedObjectIds,i),null==t)return;const{attributeData:u,loadedAttributes:f}=t;if(null==f||null==u||0===this._attributeChangedObjectIds.size)return;const v=new Set;for(const x of f)v.add(x.index);for(const x of n)v.has(x.index)||(f.push(x),u[x.name]=new Array(e.length));const y=await this._lockFeatureIds(e);try{const t={attributeData:u,loadedAttributes:f},n=this._getOverridesFromCache(e,t,this._attributeChangedObjectIds),{objectIds:v,fieldNames:y}=n;if(0===v.length||0===y.length)return;const x=await this._queryAttributeOverridesFromAssociatedLayer(v,y,i);if(null==x)return;this._processOverridesFromAssociatedLayer(e,x,y,t)}finally{y.remove()}}updateGeometry(e,t){this._geometryChangedObjectIds.add(e);const i=this._clientGeometryCache.get(e);if(null!=i&&(this.geometryOverrides.remove(i),this._clientGeometryCache.delete(e)),null!=t){const i={oid:e,mesh:t};this.geometryOverrides.add(i),this._clientGeometryCache.set(e,i)}}updateAttributeValue(e,t,i){this._attributeChangedObjectIds.add(e),this._cacheAttributeValue(e,t,i)}featureAdded(e){this.is3DOFL&&Y()&&this._geometryChangedObjectIds.add(e),this._attributeChangedObjectIds.add(e)}_cacheAttributeValue(e,t,i){this._memCache.put(this._getAttributeCacheKey(e,t),i,this._memCacheAttributeValueSize(i))}_getOverridesFromCache(e,{loadedAttributes:t,attributeData:i},n){const u=new Set,f=new Array;for(const y of t)f[y.index]=i[y.name];const v=new Set;for(let y=0;y<e.length;y++){const i=e[y];if(n.has(i))for(const e of t){const t=this._attributeFromCache(i,e.index);void 0===t?(u.add(i),v.add(e.name)):f[e.index][y]=t}}return{objectIds:Array.from(u),fieldNames:Array.from(v)}}_attributeFromCache(e,t){const i=this._fromInteractiveEditingSession(e,t);if(void 0!==i)return i;const n=this._getAttributeCacheKey(e,t);return this._memCache.get(n)}_fromInteractiveEditingSession(e,t){if(null!=this._interactiveEditingSessions)for(const i of this._interactiveEditingSessions){if(i.objectId!==e)continue;const n=i.getAttribute(t);if(void 0!==n)return n}}_getAttributeCacheKey(e,t){return`${e}-${t}`}async _queryAttributeOverridesFromAssociatedLayer(e,t,i){if(0===e.length)return null;this._logWarningIfMaximumObjectsExceeded();const{associatedLayer:n}=this.layer;if(null==n)return null;const u=n.createQuery(),{objectIdField:f}=n,v=[f,...t];u.where="1=1",u.returnGeometry=!1,u.outFields=v,u.cacheHint=!0;const y=await this._executeBatchQuery(n,e,u,i),x=[];for(const S of y)if(S.ok)for(const e of S.value.features)x.push(e);return x}async _queryGeometryOverridesFromAssociatedLayer(e,t){if(0===e.length||!this.is3DOFL||!Y())return null;const i=this.layer.associatedLayer,n=i.infoFor3D,{spatialReference:u}=i,{state:{viewingMode:f},spatialReference:v}=this.view,y=f===He.Global,x=u.isGeographic;if(y&&!x)return Nt.getLogger(this).warn("unsupported-pcs-edits-in-global-view",this.layer.title,k(u,v,this.view.viewingMode,as.Mode)),null;if(!y&&x)return Nt.getLogger(this).warn("unsupported-gcs-edits-in-local-view",this.layer.title,k(u,v,this.view.viewingMode,as.Mode)),null;if(!(Tt(u,v)||y&&v.isWebMercator&&u.isWGS84))return Nt.getLogger(this).warn("unsupported-mismatched-spatial-reference-edits",this.layer.title,k(u,v,this.view.viewingMode,as.SpatialReference)),null;this._logWarningIfMaximumObjectsExceeded();const{objectIdField:S,globalIdField:M}=i,O=[S,...null!=M?[M]:[]],E=i.createQuery();E.where="1=1",E.returnGeometry=!0,E.outFields=O,E.cacheHint=!0,E.returnZ=i.hasZ,E.returnM=i.hasM;const T=await this._executeBatchQuery(i,e,E,t),V=[];for(const $ of T){if(!$.ok)continue;const e=$.value,{assetMaps:t,features:i,globalIdFieldName:f}=e;if(null==t)continue;const v=ni(n,t);for(const y of i){const e=ri(y,f,u,n,v),t=y;null!=e?(t.geometry=e,V.push(t)):t.geometry=null}}return V}_logWarningIfMaximumObjectsExceeded(){if(!this._warnMaximumChangedObjectsExceeded)return;this._warnMaximumChangedObjectsExceeded=!1;let e=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${Vt(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const t=this.layer.portalItem;e+=(null==t?void 0:t.loaded)?` (${t.portal.url}/home/item.html?id=${t.id}#settings)`:` (${this.layer.parsedUrl.path})`,Nt.getLogger(this).warn("#queryOverrides()",this.layer.title,`${e}.`)}async _executeBatchQuery(e,t,i,n){if(0===t.length)return[];const u=$t(e);t=[...t].sort(((e,t)=>e-t));const f=kt(t,u).map((t=>{const u=i.clone();return u.objectIds=t,qt(Gt(e,u,{signal:n}))}));return Promise.all(f)}_processOverridesFromAssociatedLayer(e,t,i,{loadedAttributes:n,attributeData:u}){const f=this._associatedLayer;if(null==f)return;const v=f.objectIdField,y=i.map((t=>(t in u||(u[t]=new Array(e.length)),u[t]))),x=new Map(n.map((e=>[e.name,e.index]))),S=i.map((e=>x.get(e))),M=new Map(Array.from(e,((e,t)=>[e,t])));for(const O of t){const e=O.attributes[v];for(let t=0;t<i.length;t++){const n=S[t],u=M.get(e),f=O.attributes[i[t]];y[t][u]=f,this._cacheAttributeValue(e,n,f)}}}_memCacheAttributeValueSize(e){return"string"==typeof e?Ut(e):jt()}async _fetchChangedObjectIds(e){var t,i,n,u;const f=this.layer;await f.load({signal:e}),this._geometryChangedObjectIds.clear(),this._attributeChangedObjectIds.clear();const{associatedLayer:v}=f;if(null==v||!(null==(i=null==(t=v.capabilities)?void 0:t.operations)?void 0:i.supportsChangeTracking))return;const y=this._getFetchChangedObjectIdsServerGen();if(null==y)return;const x=v.layerId,S=this.is3DOFL,M={f:"json",returnIdsOnly:!0,layers:`[${x}]`,returnUpdates:!0,returnDeletes:S,returnInserts:S,layerServerGens:JSON.stringify([{id:x,serverGen:y}])};if(S){const e=v.infoFor3D;M.fieldsToCompare=JSON.stringify({fields:[...Object.values(e.transformFieldRoles),e.sourceHashField]})}const O=await be(Bt(`${v.url}/extractChanges`,{method:"post",query:M,timeout:rs,signal:e}));if(!O.ok&&zt(O.error)){const e=this.layer.title;Nt.getLogger(this).warn("extractChanges:timeout",e,`${e} could not obtain edited features that are not cached in the scene service. Display of features may not be up to date with the latest edits. Consider re-caching the scene service.`)}if(O.ok&&1===(null==(u=null==(n=O.value.data)?void 0:n.edits)?void 0:u.length)){const t=O.value.data.edits[0],i=null==t?void 0:t.objectIds,n=null==t?void 0:t.fieldUpdates,u=(null==i?void 0:i.adds)??[],f=(null==i?void 0:i.updates)??[],y=(null==i?void 0:i.deletes)??[],x=[...u,...f,...y],M=S?[...u,...n??f,...y]:[],E=Math.min(this._maximumNumberOfEditOVerrides,x.length);E<x.length&&(this._warnMaximumChangedObjectsExceeded=!0);const T=x.sort(((e,t)=>e-t));for(let e=0;e<E;++e){const t=T[e];this._attributeChangedObjectIds.add(t)}for(const e of M)this._geometryChangedObjectIds.add(e);if(this.is3DOFL&&Y()&&this._geometryChangedObjectIds.size>0){const t=await this._queryGeometryOverridesFromAssociatedLayer(Array.from(this._geometryChangedObjectIds),e);if(null!=t)for(const e of t)null!=e.geometry&&this.updateGeometry(e.attributes[v.objectIdField],e.geometry)}}}_getFetchChangedObjectIdsServerGen(){var e,t;const i=this.layer;if(null!=(null==(e=i.serviceUpdateTimeStamp)?void 0:e.lastUpdate))return i.serviceUpdateTimeStamp.lastUpdate;const n=i.associatedLayer;return null!=(null==(t=null==n?void 0:n.serverGens)?void 0:t.minServerGen)?n.serverGens.minServerGen:null}async _lockFeatureIds(e){const t=this._featureIdLocks;let i=!0;for(;i;){const n=new Array;for(const i of e){const e=t.get(i);e&&n.push(e)}0===n.length?i=!1:await Promise.all(n)}const n=Ht(),u=n.promise;for(const f of e)t.set(f,u);return K((()=>{for(const i of e)t.delete(i);n.resolve()}))}get test(){}};U([j({constructOnly:!0})],ns.prototype,"view",void 0),U([j({constructOnly:!0})],ns.prototype,"layer",void 0),U([j({readOnly:!0})],ns.prototype,"is3DOFL",null),U([j()],ns.prototype,"_interactiveEditingSessions",void 0),U([j({readOnly:!0})],ns.prototype,"sortedGeometryChangedObjectIds",null),U([j({readOnly:!0})],ns.prototype,"geometryOverrides",void 0),U([j()],ns.prototype,"_clientGeometryCache",void 0),U([j()],ns.prototype,"_associatedLayer",null),U([j()],ns.prototype,"_associatedLayerView",void 0),U([j({constructOnly:!0})],ns.prototype,"memoryController",void 0),U([j()],ns.prototype,"_attributeChangedObjectIds",void 0),U([j()],ns.prototype,"_geometryChangedObjectIds",void 0),U([j()],ns.prototype,"hasGeometryChanges",null),U([j()],ns.prototype,"_pendingFetchChangedObjectIds",void 0),U([j()],ns.prototype,"_pendingFetchAbortController",void 0),U([j()],ns.prototype,"_definitionExpression",null),U([j()],ns.prototype,"updating",null),U([j()],ns.prototype,"isEmpty",null),ns=U([B("esri.views.3d.layers.i3s.I3SOverrides")],ns);class D{constructor(e,t){this.objectId=e,this._remove=t,this._updates=new Map,this._isActive=!0}getAttribute(e){return this._updates.get(e)}setAttribute(e,t){this.isActive&&this._updates.set(e,t)}remove(){this.isActive&&(this._isActive=!1,this._remove())}get isActive(){return this._isActive}}const rs=1e4,os=5e4;var as;function k(e,t,i,n){return`Displaying the edits of a SceneLayer with a${n===as.Mode?e.isGeographic?" geographic ":" projected ":" "}spatial reference (wkid:${e.wkid}) in ${i} viewing mode${n===as.SpatialReference?` with spatial reference (wkid:${t.wkid}) `:" "}is not supported. No geometry edits will be displayed for this layer.\nPlease consider re-caching the scene service or changing the ${n===as.Mode?"viewing mode":"view spatial reference"} to display edits.`}!function(e){e[e.Mode=0]="Mode",e[e.SpatialReference=1]="SpatialReference"}(as||(as={}));export{C,D$1 as D,ns as G,ss as K,M$1 as M,R$1 as R,Mi as a,b2 as b,ai as e,li as s};
