import{e,y as n,a as o,S as i,h as s,lc as l,P as a,cD as d,j as p,aw as c,fO as h,d8 as u,n6 as m,bc as y,g,i as v,cw as _,e6 as f,Q as w,A as C,bd as E}from"./index-DSIPxOWi.js";import{E as P}from"./EditGeometryOperations-sseMUvB1.js";import{b,a as O}from"./VideoElement-BA4EzDol.js";import"./geometry2dUtils-4c9qUvJ6.js";import"./resourceExtension-BScMZjEL.js";import"./MediaElementView-DU1VM6lV.js";import"./normalizeUtilsSync-B5F66Zka.js";import"./normalizeUtilsCommon-BU8xfl77.js";let H=class extends i{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new s}initialize(){this.addHandles([l(this._updatingHandles),this._updatingHandles.add((()=>{const e=this.element.georeference;return"control-points"===(null==e?void 0:e.type)?e.controlPoints:null}),(e=>this._elementControlPointsChanged(e)),a)])}_elementControlPointsChanged(e){if(this._updatedElementControlPoints===e)return;const n=null==e?void 0:e.map((({mapPoint:e})=>e)).filter(d),o=this.view.spatialReference;this._updatingHandles.addPromise(this._whenProjected(n,o,(e=>{if(!e)return void this._replaceOperations(null);const{_operations:n}=this,i=new p({rings:[e.map((({x:e,y:n})=>[e,n]))],spatialReference:o});(null==n?void 0:n.trySetGeometry(i))?this.onModifiedExternally():this._replaceOperations(P.fromGeometry(i,this.view.state.viewingMode))})))}_operationsGeometryChanged(){var e;const{element:{georeference:n},_operations:o}=this;if(!o||!n||"control-points"!==n.type||!n.controlPoints)return;const i=o.data.geometry,s=n.controlPoints.map((({mapPoint:e})=>e)).filter(d);if((null==(e=i.rings[0])?void 0:e.length)!==s.length)return void this._updateElementControlPoints(null);const l=i.rings[0].map((([e,n])=>new c({x:e,y:n,spatialReference:i.spatialReference}))),a=s.map((({spatialReference:e})=>e));this._updatingHandles.addPromise(this._whenProjected(l,a,(e=>this._updateElementControlPoints(e))))}_updateElementControlPoints(e){var n;const{georeference:o}=this.element;if(!o||!e||"control-points"!==o.type||(null==(n=o.controlPoints)?void 0:n.length)!==(null==e?void 0:e.length))return;e||(o.controlPoints=null);const i=o.controlPoints;if((null==i?void 0:i.length)===e.length)for(let s=0;s<i.length;s++)i[s].mapPoint=e[s]}async _whenProjected(e,n,o){if(!e)return void o(e);const{_operations:i,element:{georeference:s}}=this,l=e.map((({spatialReference:e})=>e)),a=Array.isArray(n)?n:new Array(l.length).fill(n);await h(Array.from(l).map(((e,n)=>({source:e,dest:a[n]}))));const d=e.map(((e,n)=>u(e,a[n])));i===this._operations&&s===this.element.georeference&&o(d)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e,e&&this.addHandles(e.data.on("change",(()=>this._operationsGeometryChanged())),e)}};e([n({constructOnly:!0})],H.prototype,"view",void 0),e([n({constructOnly:!0})],H.prototype,"layer",void 0),e([n({constructOnly:!0})],H.prototype,"element",void 0),e([n({constructOnly:!0})],H.prototype,"onModifiedExternally",void 0),e([n()],H.prototype,"_operations",void 0),e([n()],H.prototype,"operations",null),e([n()],H.prototype,"updating",null),H=e([o("esri.views.3d.interactive.editingTools.media.MediaElementControllerControlPoints")],H);let M=class extends i{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new s}initialize(){this.addHandles([l(this._updatingHandles),this._updatingHandles.add((()=>{var e;return null==(e=this.element.georeference)?void 0:e.coords}),(e=>this._elementCoordinatesChanged(e)),a)])}_elementCoordinatesChanged(e){this._updatedElementCoordinates!==e&&this._updatingHandles.addPromise(this._whenProjected(e,this.view.spatialReference,(e=>{if(!e)return void this._replaceOperations(null);const{_operations:n}=this;(null==n?void 0:n.trySetGeometry(e))?this.onModifiedExternally():this._replaceOperations(P.fromGeometry(e,this.view.state.viewingMode))})))}_operationsGeometryChanged(){const{element:{georeference:e},_operations:n}=this;if(!n||!e)return;const o=n.data.geometry;if(!e.coords)return void this._updateElementCoordinates(o);const i=e.coords.spatialReference;this._updatingHandles.addPromise(this._whenProjected(o,i,(e=>this._updateElementCoordinates(e))))}_updateElementCoordinates(e){const{georeference:n}=this.element;n&&(n.coords=e,this._updatedElementCoordinates=n.coords)}async _whenProjected(e,n,o){if(!e)return void o(e);const{_operations:i,element:{georeference:s}}=this,l=await m(e,n);i===this._operations&&s===this.element.georeference&&o(l)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e,e&&this.addHandles(e.data.on("change",(()=>this._operationsGeometryChanged())),e),this.onModifiedExternally()}};function t(e,n){if(!e||"media-3d"!==e.type||e.suspended)return!1;const o=e.layer.source;return!!o&&(o instanceof b||o instanceof O?o===n:"hasElement"in o&&o.hasElement(n))}e([n({constructOnly:!0})],M.prototype,"view",void 0),e([n({constructOnly:!0})],M.prototype,"layer",void 0),e([n({constructOnly:!0})],M.prototype,"element",void 0),e([n({constructOnly:!0})],M.prototype,"onModifiedExternally",void 0),e([n()],M.prototype,"_operations",void 0),e([n()],M.prototype,"operations",null),e([n()],M.prototype,"updating",null),M=e([o("esri.views.3d.interactive.editingTools.media.MediaElementControllerShape")],M);let j=class extends i{grabbableForEvent(){return!0}constructor(e){super(e),this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.grabbing=!1,this.dragging=!1,this.hovering=!0,this.selected=!1,this.cursor=null,this.consumesClicks=!0,this.events=new y.EventEmitter,this.addHandles(g((()=>this.selected),(e=>this.events.emit("select-changed",{action:e?"select":"deselect"})),v))}destroy(){this._set("view",null)}intersectionDistance(e){const{view:n,layer:o,element:i}=this;if(!function r(e,n,o){return t(e.allLayerViews.find((e=>e.layer===n)),o)}(n,o,i))return null;const s=n.toMap(e,{include:{layer:o,element:i}});return s&&_(s,x,n.renderSpatialReference)?f(x,n.state.camera.eye):null}onElevationChange(){}onViewChange(){}};e([n({constructOnly:!0,nonNullable:!0})],j.prototype,"element",void 0),e([n({constructOnly:!0,nonNullable:!0})],j.prototype,"layer",void 0),e([n({constructOnly:!0,nonNullable:!0})],j.prototype,"view",void 0),e([n()],j.prototype,"interactive",void 0),e([n()],j.prototype,"selectable",void 0),e([n()],j.prototype,"grabbable",void 0),e([n()],j.prototype,"grabbing",void 0),e([n()],j.prototype,"dragging",void 0),e([n()],j.prototype,"hovering",void 0),e([n()],j.prototype,"selected",void 0),e([n()],j.prototype,"cursor",void 0),j=e([o("esri.views.3d.interactive.editingTools.media.MediaElementManipulator3D")],j);const x=w(),G=Symbol();let R=class extends y.EventedAccessor{get operations(){var e;return null==(e=this._controller)?void 0:e.operations}get elevationInfo(){return{mode:"on-the-ground",offset:0}}get _layerView(){const e=this.view.allLayerViews.find((e=>e.layer===this.layer));return"media-3d"===(null==e?void 0:e.type)?e:null}get visible(){return t(this._layerView,this.element)}get isDraped(){return!0}get origin(){return null}get updating(){var e;return!!(null==(e=this._controller)?void 0:e.updating)}get _controllerClass(){var e;return"transform"===this.tool||"control-points"!==(null==(e=this.element.georeference)?void 0:e.type)?M:H}constructor(e){super(e),this.tool="transform"}initialize(){this.addHandles([g((()=>this._controllerClass),(e=>this._updateController(e)),C),E((()=>this._layerView),"element-render-changed",(({element:e})=>{this.element===e&&this.emit("committed")}))])}toMap(e){const{layer:n,element:o}=this;return this.view.toMap(e,{include:{layer:n,element:o}})}createManipulator(e){const{view:n,layer:o,element:i}=this;return new j({view:n,layer:o,element:i,...e})}_updateController(e){if(this._controller&&this._controller instanceof e)return;this.removeHandles(G);const{view:n,layer:o,element:i}=this,l$1=()=>{this.emit("modified-externally")};this._controller=new e({view:n,layer:o,element:i,onModifiedExternally:l$1}),l$1(),this.addHandles(l(this._controller),G)}};e([n({constructOnly:!0})],R.prototype,"view",void 0),e([n({constructOnly:!0})],R.prototype,"layer",void 0),e([n({constructOnly:!0})],R.prototype,"element",void 0),e([n()],R.prototype,"tool",void 0),e([n()],R.prototype,"_controller",void 0),e([n()],R.prototype,"elevationInfo",null),e([n()],R.prototype,"_layerView",null),e([n()],R.prototype,"visible",null),e([n()],R.prototype,"updating",null),e([n()],R.prototype,"_controllerClass",null),R=e([o("esri.views.3d.interactive.editingTools.ManipulatedObject3DMediaElement")],R);export{R as ManipulatedObject3DMediaElement};
