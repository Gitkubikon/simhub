const __vite__fileDeps=["assets/I3STreeDebugger-D_wyOLU3.js","assets/index-DSIPxOWi.js","assets/index-B_7YxLDX.css","assets/TileTreeDebugger-CDFY3SV7.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{nx as t,cC as l,hi as d,fE as u,pM as _,kT as g,e0 as p,or as m,hB as f,dD as y,Q as b,bc as v,jR as I,e as M,y as C,a as E,S as w,al as x,C as O,g as S,U as R,u as N,ik as T,qV as A,qW as F,cb as P,ec as j,d as V,as as H,J as L,n as U,H as k,a0 as B,gT as q,a8 as z,hS as $,iu as W,dG as K,kH as Y,dk as Q,qX as X,lg as Z,qq as J,kL as ee,qY as te,aG as se,b as ie,hm as re,b3 as ae,cG as ne,fD as oe,ak as le,w as de,h as he,v as ce,qZ as ue,q_ as _e,m as ge,q$ as pe,r0 as me,P as fe,_ as ye,hl as be,r1 as ve,r2 as Ie,aj as Me,W as Ce,r3 as Ee,r4 as we,lt as xe,k0 as Oe,F as Se,jU as Re,cD as Ne,O as De,cy as Te,lr as Ae,r5 as Fe,r6 as Pe,r7 as je,r8 as Ve,r9 as He,ra as Ge,bV as Le,ch as Ue,lq as ke,lm as Be,cv as qe,ln as ze,gi as $e,br as We,ls as Ke,iq as Ye,eX as Qe,qC as Xe,k5 as Ze,k2 as Je,qw as et,lN as tt,hh as st,qx as it,qc as rt,c4 as at,rb as nt,jV as ot,rc as lt,rd as dt,mL as ht,n8 as ct,re as ut,rf as _t,rg as gt,rh as pt,ri as mt,rj as ft,V as yt,gI as bt,bp as vt,fC as It,bo as Mt,dC as Ct,cx as wt,pP as xt,rk as Ot}from"./index-DSIPxOWi.js";import{x as St,f as Rt,t as Nt,i as Tt}from"./Transform-A6X0mfYo.js";import{a as Ft}from"./RenderTexture-DbJC7CTU.js";import{a as Pt,s as Vt,R as Ht,e as Gt,G as Ut,K as Yt,D as Qt,b as Xt,C as Zt,M as Jt}from"./I3SOverrides-CXcxzPSI.js";import{f as es}from"./SceneModification-yCQPZUfb.js";import{z as ts,u as ss,b as is}from"./Graphics3DObjectStates-B77mD6jz.js";import{h as rs}from"./WorkerHandle-Bq2affGI.js";import{e as as,_ as ns,E as os,L as ls,A as ds}from"./SceneLayerWorker-B2gy9gVB.js";import{r as hs,c as cs}from"./I3SNode-mlgend4K.js";import{n as us}from"./HeatmapDensity.glsl-jGaN0eX9.js";import{e as _s}from"./makeScheduleFunction-Cc-EjyuG.js";function u$1(t,l,f){const y=d(24);return d=>{let b=d.meta.featureExtents;if(null==b){b=new Float64Array(6*d.meta.featureIds.length),d.meta.featureExtents=b;for(let t=0;t<b.length;t+=6)b[t]=Number.POSITIVE_INFINITY}const v=new Float64Array(b.buffer,6*d.index*Float64Array.BYTES_PER_ELEMENT,6);return v[0]===Number.POSITIVE_INFINITY&&(c$2(d.index,f,d.meta.objectHandle,y,0),u(y,l,0,y,t,0,8)?(_(v,g),p(v,y,0,8)):_(v,m)),v}}function c$2(t,l,d,u,_){const g=l.getComponentAabb(d,t,gs),p=l.getObjectTransform(d);for(let m=0;m<8;++m)ps[0]=1&m?g[0]:g[3],ps[1]=2&m?g[1]:g[4],ps[2]=4&m?g[2]:g[5],f(ps,ps,p.rotationScale),y(ps,ps,p.position),u[_++]=ps[0],u[_++]=ps[1],u[_++]=ps[2];return u}const gs=l(),ps=b();class r extends v{constructor(){super(...arguments),this._map=new Map}clear(){if(this._map.size>0){const t=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:t})}}get length(){return this._map.size}get(t){return this._map.get(t)}addMany(t){if(0===t.length)return;const l=new Set;for(let u=0;u<t.length;u++){const d=t[u],_=d.objectId,g=this._map.get(_);g?(l.add(_),d!==g&&(t[u]=g),g.refCount||(g.refCount=0),++g.refCount):(d.refCount=1,this._map.set(_,d))}const d=l.size>0?t.filter((t=>!l.has(t.objectId))):t;d.length>0&&this.emit("change",{added:d,removed:[]})}removeMany(t){const l=[];for(const d of t){const t=d.objectId,u=this._map.get(t);null!=u&&(!u.refCount||--u.refCount<=0)&&(this._map.delete(t),l.push(d))}l.length>0&&this.emit("change",{added:[],removed:l})}removeManyByObjectId(t){const l=[];for(const d of t){const t=this._map.get(d);null!=t&&(!t.refCount||--t.refCount<=0)&&(this._map.delete(d),l.push(t))}l.length>0&&this.emit("change",{added:[],removed:l})}toArray(){return[...this._map.values()]}find(t){let l;return I(this._map,(d=>!!t(d)&&(l=d,!0))),l}forEach(t){this._map.forEach((l=>t(l)))}}let ms=class i extends v{constructor(t){super(),this._limit=t,this._all=new r,this._active=new ys(this),this._pending=new Map,this._handle=this._all.on("change",(t=>this._handleChanges(t)))}destroy(){this._handle.remove()}get length(){return this._active.length}toArray(){return this._active.toArray()}find(t){return this._active.find(t)}forEach(t){this._active.forEach(t)}addMany(t){this._all.addMany(t)}removeManyByObjectId(t){this._all.removeManyByObjectId(t)}_handleChanges(t){let l=t.removed;if(this._pending.size>0){l=new Array;for(const d of t.removed)this._pending.delete(d.objectId)||l.push(d)}let d=this._limit-this._active.length+l.length;d<t.added.length&&(this._active.removeMany(l),l=[],fs.reset(1-this._limit/(this._active.length+t.added.length)),this._active.forEach((t=>{fs.sample()&&(l.push(t),this._pending.set(t.objectId,t))})),d=this._limit-this._active.length+l.length);let u=t.added;if(d<t.added.length){u=new Array,fs.reset(d/t.added.length);for(const l of t.added)fs.sample()?u.push(l):this._pending.set(l.objectId,l)}const _=d-u.length;_>0&&this._pending.size>0&&(fs.reset(_/this._pending.size),this._pending.forEach((t=>{fs.sample()&&(u.push(t),this._pending.delete(t.objectId))}))),this._active.addAndRemove(u,l)}};const fs=new class n{constructor(){this._percentage=1,this._last=-1,this._index=0}reset(t){this._percentage=t,this._last=-1}sample(){const t=Math.floor(this._index*this._percentage);return++this._index,t!==this._last&&(this._last=t,!0)}};let ys=class a{constructor(t){this._parent=t,this._map=new Map}get length(){return this._map.size}forEach(t){this._map.forEach((l=>t(l)))}find(t){let l;return I(this._map,(d=>!!t(d)&&(l=d,!0))),l}toArray(){return[...this._map.values()]}addAndRemove(t,l){for(const d of t)this._map.set(d.objectId,d);for(const d of l)this._map.delete(d.objectId);(t.length>0||l.length>0)&&this._parent.emit("change",{added:t,removed:l})}removeMany(t){for(const l of t)this._map.delete(l.objectId);t.length>0&&this._parent.emit("change",{added:[],removed:t})}};class G{constructor(t,l){this.meta=t,this.index=l}}class D{constructor(t,l){this.graphic=t,this.geometry=l,this.components=[],this.overridesDirty=!1}}let bs=class extends w{get updating(){var t;return(null==(t=this._graphicsCore)?void 0:t.updating)??!1}constructor(t){super(t),this.loadedGraphics=new ms(5e4),this.slicePlaneEnabled=!1,this._renderingInfo={symbol:new x},this._featuresMap=new Map}initialize(){const t=this.view.basemapTerrain;this._graphicsCore=new ts({owner:this,layer:this.layer,preferredUpdatePolicy:O.ASYNC,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1,componentFactories:{deconflictor:t=>this.view.deconflictor.addGraphicsOwner(t),labeler:(t,l)=>this.view.labeler.addGraphicsOwner(t,l,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),scaleVisibility:(l,d)=>new ss({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:d,graphicsCore:l,basemapTerrain:t,layerScaleEnabled:!1})}}),this._graphicsCore.initializePromise.then((()=>this._graphicsCore.startCreateGraphics())).catch((()=>{})),this.addHandles(S((()=>this.layer.labelingInfo),((t,l)=>{R(t,l)&&this._graphicsCore.updateLabelingInfo()})))}destroy(){this._graphicsCore=N(this._graphicsCore),this.loadedGraphics=N(this.loadedGraphics),this.view=null}addNodeMeta(t,l){let d=0;const u=t.filteredIds,_=this.view.spatialReference,g=[];for(let p=0;p<t.featureIds.length;p++){const m=t.featureIds[p];let f=null==u;if(u&&d<u.length&&m===u[d]&&(f=!0,d++),!this._enabledForFeatureInNode(t,p))continue;const y=this._featuresMap.get(m);if(y){y.components.push(new G(t,p)),this._updateLabelPosition(m);continue}const b=l(p,t),v=j(0,0,0,_),I={objectId:m,uid:T(),attributes:b,visible:f,geometry:v},M=new D(I,v);M.components.push(new G(t,p)),this._featuresMap.set(m,M),this._updateLabelGeometry(m),g.push(I)}this.loadedGraphics.addMany(g)}updateLabelPositions(t){const l=this.view.renderCoordsHelper;this._forEachGraphic(t,((d,u,_)=>{const g=this._graphicsCore.getGraphics3DGraphicById(u.uid);null!=g&&this._updateLabelGeometry(t.featureIds[d])&&g.alignWithAbsoluteElevation(_.z??0,l,!1)}))}setNodeMetaAttributes(t,l){const d=new Array;this._forEachGraphic(t,((u,_)=>{const g=l(u,t);A(_.attributes,g)||(_.attributes=g,d.push(_.uid))})),this._graphicsCore.updateLabelingInfo(d)}applyFilterChange(t){this._forEachFeature(t,((l,d,u)=>{if(!this._enabledForFeatureInNode(t,l)){const u=t.featureIds[l];switch(this._removeFeature(d,t,l)){case Is.REMOVED:this.loadedGraphics.removeManyByObjectId([u]);break;case Is.MODIFIED:this._updateLabelPosition(u)}return}const _=d.graphic,g=_.visible;g!==u&&(_.visible=u,vs.graphic=_,vs.property="visible",vs.oldValue=g,vs.newValue=u,this._graphicsCore.graphicUpdateHandler(vs))}))}removeNodeMeta(t){const l=[];this._forEachGraphic(t,(d=>{const u=t.featureIds[d],_=this._featuresMap.get(u);if(_)switch(this._removeFeature(_,t,d)){case Is.MODIFIED:this._updateLabelPosition(u);break;case Is.REMOVED:l.push(u)}})),this.loadedGraphics.removeManyByObjectId(l)}_removeFeature(t,l,d){const u=t.components.length;return F(t.components,(t=>!(t.meta===l&&t.index===d))),0===t.components.length?(this._featuresMap.delete(l.featureIds[d]),Is.REMOVED):u!==t.components.length?Is.MODIFIED:Is.UNMODIFIED}getRenderingInfo(){return this._renderingInfo}notifyGraphicGeometryChanged(){}notifyGraphicVisibilityChanged(){}_updateLabelPosition(t){const l=this._featuresMap.get(t);l&&this._updateLabelGeometry(t)&&(this.loadedGraphics.removeManyByObjectId([t]),this.loadedGraphics.addMany([l.graphic]))}_updateLabelGeometry(t){const l=this._featuresMap.get(t);if(!l)return!1;const m=l.geometry,f=this.view.spatialReference,y=this.view.renderCoordsHelper,b=m.x,v=m.y,I=m.z??0,M=l.components.length,C=d(24*M);let E=0;for(const{meta:d,index:u}of l.components)c$2(u,this.collection,d.objectHandle,C,E),E+=24;return u(C,y.spatialReference,0,C,f,0,C.length/3),_(Cs,g),p(Cs,C),m.x=(Cs[0]+Cs[3])/2,m.y=(Cs[1]+Cs[4])/2,m.z=Cs[5],!P(m.x,b)||!P(m.y,v)||!P(m.z,I)}_forEachGraphic(t,l){this._forEachFeature(t,((d,{graphic:u,geometry:_},g)=>{this._enabledForFeatureInNode(t,d)&&l(d,u,_,g)}))}_forEachFeature(t,l){let d=0;for(let u=0;u<t.featureIds.length;u++){const _=this._featuresMap.get(t.featureIds[u]);let g=null==t.filteredIds;t.filteredIds&&t.filteredIds[d]===t.featureIds[u]&&(g=!0,d++),_&&l(u,_,g)}}_enabledForFeatureInNode(t,l){var d;return t.node.index<0||!(null==(d=this.overrides)?void 0:d.featureHasGeometryChanges(t.featureIds[l]))}get updatePolicy(){return this._graphicsCore.effectiveUpdatePolicy}get usedMemory(){return this._graphicsCore.usedMemory}get unloadedMemoryEstimate(){return this._graphicsCore.unprocessedMemoryEstimate}get test(){}};M([C()],bs.prototype,"view",void 0),M([C()],bs.prototype,"layer",void 0),M([C()],bs.prototype,"collection",void 0),M([C()],bs.prototype,"loadedGraphics",void 0),M([C()],bs.prototype,"overrides",void 0),M([C()],bs.prototype,"updating",null),M([C()],bs.prototype,"slicePlaneEnabled",void 0),M([C()],bs.prototype,"_graphicsCore",void 0),bs=M([E("esri.views.3d.layers.I3SMeshViewLabeler")],bs);const vs={graphic:null,property:null,oldValue:null,newValue:null};var Is,Ms;(Ms=Is||(Is={}))[Ms.UNMODIFIED=0]="UNMODIFIED",Ms[Ms.MODIFIED=1]="MODIFIED",Ms[Ms.REMOVED=2]="REMOVED";const Cs=l(),Es=bs;class e extends V{constructor(t,l,d,u,_,g,p){super(t,0,0,0,l),this.gpuMB=d,this.geometryMB=u,this.textureMB=_,this.unloadedMB=g,this.idbHitRate=p}}let ws=class h extends rs{constructor(t){super("SceneLayerWorker","process",{process:t=>[t.geometryBuffer],project:t=>[t.positions.buffer],transformNormals:t=>[t.normals.buffer]},t,{hasInitialize:!0})}setModifications(t,l,d,u){const _={context:t,modifications:a$2(l,d,u),isGeodetic:u.isGeographic};this.broadcast(_,"setModifications")}setLegacySchema(t,l){const d=JSON.stringify(l);return this.broadcast({context:t,jsonSchema:d},"setLegacySchema")}destroyContext(t){return this.broadcast(t,"destroyContext")}project(t,l){return this.invokeMethod("project",t,l)}transformNormals(t,l){return this.invokeMethod("transformNormals",t,l)}};const xs=new H({deallocator:null}),Os=b();function a$2(t,l,d){xs.clear();let u=1/0,_=1/0,g=-1/0,p=-1/0,m=!1;for(const y of l){const t="clip"===y.type?as.Inside:"mask"===y.type?as.Outside:as.Replace,l=y.geometry;let m3=t=>t;if(l.spatialReference){if(!L(l.spatialReference,d)){U.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}m3=t=>(k(t,l.spatialReference,Os,d),Os)}else l.hasZ||(Os[2]=0,m3=t=>(Os[0]=t[0],Os[1]=t[1],Os));m=m||t===as.Outside,xs.push(t),xs.push(l.rings.length);for(const d of l.rings){xs.push(d.length);for(const t of d){const l=m3(t);xs.push(l[0]),xs.push(l[1]),xs.push(l[2]),u=Math.min(u,l[0]),_=Math.min(_,l[1]),g=Math.max(g,l[0]),p=Math.max(p,l[1])}}}if(null!=t)if(m){const l=1e-4;xs.push(as.Inside),xs.push(2),xs.push(4),xs.push(u-l),xs.push(_-l),xs.push(0),xs.push(g+l),xs.push(_-l),xs.push(0),xs.push(g+l),xs.push(p+l),xs.push(0),xs.push(u-l),xs.push(p+l),xs.push(0),xs.push(4),xs.push(t[0]),xs.push(t[1]),xs.push(0),xs.push(t[2]),xs.push(t[1]),xs.push(0),xs.push(t[2]),xs.push(t[3]),xs.push(0),xs.push(t[0]),xs.push(t[3]),xs.push(0)}else xs.push(as.Outside),xs.push(1),xs.push(4),xs.push(t[0]),xs.push(t[1]),xs.push(0),xs.push(t[2]),xs.push(t[1]),xs.push(0),xs.push(t[2]),xs.push(t[3]),xs.push(0),xs.push(t[0]),xs.push(t[3]),xs.push(0);xs.push(as.Finished);const f=new Float64Array(xs.length);for(let y=0;y<xs.length;++y)f[y]=xs.at(y);return f}var Ss,Rs,Ns,Ds;(Ds=Ss||(Ss={}))[Ds.VISIBLE_ONLY=0]="VISIBLE_ONLY",Ds[Ds.ALL=1]="ALL",Ds[Ds.QUERYABLE=2]="QUERYABLE",function(t){t[t.EXIT=0]="EXIT",t[t.CONTINUE=1]="CONTINUE",t[t.SKIP=2]="SKIP"}(Rs||(Rs={})),function(t){t[t.Absolute=0]="Absolute",t[t.RelativeToGround=1]="RelativeToGround",t[t.OnTheGround=2]="OnTheGround"}(Ns||(Ns={}));let Ts=class s{constructor(){this.ids=new Set}};class h2{constructor({collection:t,forAllFeatures:l,forAllFeaturesOfNode:d}){this._highlights=[],this._collection=t,this._forAllFeatures=l,this._forAllFeaturesOfNode=d}destroy(){this._highlights.forEach((t=>this._releaseSet(t))),this._highlights=null}acquireSet(){const t=new Ts;this._highlights.push(t);const l=B((()=>{this._highlights&&(this._releaseSet(t),q(this._highlights,t))}));return{set:t,handle:l}}setFeatureIds(t,l){l.forEach((l=>t.ids.add(l))),this._initializeSet(t)}_initializeSet(t){this._forAllFeatures(((l,d,u)=>(t.ids.has(l)&&this._collection.addComponentHighlight(u.objectHandle,d),Rs.CONTINUE)))}_releaseSet(t){this._forAllFeatures(((l,d,u)=>(t.ids.has(l)&&this._collection.removeComponentHighlight(u.objectHandle,d),Rs.CONTINUE)))}objectCreated(t){this._highlights.forEach((l=>{this._forAllFeaturesOfNode(t,((d,u)=>(l.ids.has(d)&&this._collection.addComponentHighlight(t.objectHandle,u),Rs.CONTINUE)))}))}objectDeleted(t){this._collection.clearHighlights(t.objectHandle)}}let As=class a2 extends w{constructor(t,l,d,u){super({}),this._updateExtent=l,this._updateNode=d,this._getElevationMode=u,this.running=!1,this._extentSet=new is,this._nodeSet=new Set;const _=this._taskPriority,g=t.registerTask(this._taskPriority,this);this.addHandles(g),this._task=g,this._lastTaskPriority=_}get _taskPriority(){const t=this._getElevationMode();return t&&t===Ns.RelativeToGround?z.ELEVATION_ALIGNMENT_SCENE:z.ELEVATION_ALIGNMENT}_updateTaskPriority(){const t=this._taskPriority;t!==this._lastTaskPriority&&(this._task.priority=t,this._lastTaskPriority=t)}normalizeCtorArgs(){return{}}addExtent(t){this._extentSet.add(t),this._updateTaskPriority(),this.running=!0}schedule(t){this._nodeSet.add(t),this._updateTaskPriority(),this.running=!0}remove(t){this._nodeSet.delete(t),this._updateRunning()}runTask(t){const l=this._extentSet;for(t.run((()=>l.merge(t)));!l.empty&&!t.done;){const d=this._updateExtent(l.pop());null!=d&&d.forAll((t=>this.schedule(t))),t.madeProgress()}if(t.done)return;const d=this._nodeSet;for(const u of d)if(d.delete(u),this._updateNode(u),t.madeProgress(),t.done)break;this._updateRunning()}_updateRunning(){this.running=this._nodeSet.size>0||this._extentSet.size>0}};M([C()],As.prototype,"running",void 0),As=M([E("esri.views.3d.layers.i3s.I3SAsyncElevationUpdater")],As);let Fs=class o{constructor(){this.lodCrossfadeSignedDuration=0}},Ps=class i2{constructor(t){this._view=t,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}destroy(){var t;null==(t=this._preRenderFrameTaskHandle)||t.remove(),this._preRenderFrameTaskHandle=null,this._view=null}get updating(){return this._numFadingNodes>0}stopNodeFading(t){null!=t.lodCrossfadeProgress&&(this._numFadingNodes--,t.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=$(this._preRenderFrameTaskHandle)),this._view.notifyLODUpdate(),this._view.notifyUpdate()))}_startNodeFading(t,l,d){0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=W({preRender:t=>this._updateAllNodeFading(t)}),this._view.notifyLODUpdate()),null==t.lodCrossfadeProgress&&(this._numFadingNodes++,this._view.notifyUpdate()),t.lodCrossfadeSignedDuration=d,t.lodCrossfadeProgress=l}_updateAllNodeFading(t){const l=this._view.nodeCrossfadingEnabled;this._view.foreachCrossfadeNode(((d,u)=>{if(null!=(null==d?void 0:d.lodCrossfadeProgress)){const _=d.lodCrossfadeSignedDuration,g=_>0?this._view.fullOpacity:0,p=t.deltaTime/_,m=d.lodCrossfadeProgress+Math.abs(p),f=!l||m>=1||0===_,y=g-(f?0:_>0?1:-1)*(1-m);f?(this.stopNodeFading(d),_<0&&this._view.markNodeToRemove(u)):d.lodCrossfadeProgress=m,this._view.setNodeOpacityByIndex(u,y)}})),this._view.removeMarkedNodes()}stopAllNodeFading(){this._view.foreachCrossfadeNode(((t,l)=>{if(null!=(null==t?void 0:t.lodCrossfadeProgress)){this.stopNodeFading(t);const d=t.lodCrossfadeSignedDuration;d<0&&this._view.markNodeToRemove(l);const u=d>0?this._view.fullOpacity:0;this._view.setNodeOpacityByIndex(l,u)}})),this._view.removeMarkedNodes()}fadeNode(t,l,d,u){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());const _=this._view,g=_.nodeCrossfadingEnabled,p=d===Pt.FadeIn?_.fullOpacity:0,m=g?u?d===Pt.FadeIn?_.lodCrossfadeinDuration:_.lodCrossfadeoutDuration:_.lodCrossfadeUncoveredDuration:0,f=this._view.getNodeOpacityByIndex(t);if(g&&f!==p&&m>0){const t=1-Math.abs(p-f);this._startNodeFading(l,t,function t$1(t){return t===Pt.FadeIn?1:-1}(d)*m)}else this.stopNodeFading(l),this._view.setNodeOpacityByIndex(t,p),d===Pt.FadeOut&&this._view.removeNode(t)}isNodeFullyFadedIn(t){const l=this._view.getNodeCrossfadeMetaData(t);return null==l||null==l.lodCrossfadeProgress&&this._view.getNodeOpacityByIndex(t)===this._view.fullOpacity}};let js=class c{constructor(t){this.type=K.I3S,this._needVerticalOffset=!1,this.layerUid=t.layerUid,this.sublayerUid=t.sublayerUid,this._collection=t.collection,this._traverseNodeHierarchy=t.traverseNodeHierarchy,this.slicePlaneEnabled=t.slicePlaneEnabled,this.isGround=t.isGround}updateElevationAlignState(t,l){this._needVerticalOffset=t&&l===Y.Global}intersect(t,l,d,u,_,g){const p=g??!1,m=t.results,f=t.options.store===Q.ALL,y=t.ray.direction,b=t.tolerance;let R2=t=>t,g2=t=>t;const v=X(t.verticalOffset??(this._needVerticalOffset?0:null));null!=t.verticalOffset&&null!=v&&(R2=t=>v.applyToMbs(t),g2=t=>v.applyToObb(t));const I=new Z(p,t.options.normalRequired);this._traverseNodeHierarchy(((_,g)=>{var p;if(0===_.childrenLoaded)return!1;const M=(null==(p=_.serviceObbInRenderSR)?void 0:p.isValid)?_.serviceObbInRenderSR:null;return!(M&&!g2(M).intersectRay(d,y,b)||(!g||!M&&J(_.serviceMbsInRenderSR)&&!function a3(t,l,d,u=0){const _=t[3]+u,g=l[0]-t[0],p=l[1]-t[1],m=l[2]-t[2],f=d[0],y=d[1],b=d[2],v=f*g+y*p+b*m;return v*v-(f*f+y*y+b*b)*(g*g+p*p+m*m-_*_)>=0}(R2(_.serviceMbsInRenderSR),d,y,b)||null!=_.geometryObbInRenderSR&&!g2(_.geometryObbInRenderSR).intersectRay(d,y,b)||this._collection.intersect(g,d,u,b,v,I,((g,p,y,b)=>{if(p<0||null!=l&&!l(d,u,p))return;const u3=t=>{const l=new te(this.layerUid,this.sublayerUid,_.index,g,b);t.set(this.type,l,p,y)};if(this.isGround&&(null==m.ground.dist||p<m.ground.dist)&&u3(m.ground),!t.options.isFiltered&&((null==m.min.dist||p<m.min.dist)&&u3(m.min),(null==m.max.dist||p>m.max.dist)&&u3(m.max),f)){const l=ee(t.ray);u3(l),t.results.all.push(l)}})),0))}))}};class i3{constructor(t,l,d=14){this._version=d,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=se.GIGABYTES,this.quotaReductionFactor=.2,this._dbName=t,this._storeName=l}init(){return Promise.resolve().then((()=>{const t=indexedDB.open(this._dbName,this._version);return t.onupgradeneeded=l=>{const d=t.result,u=t.transaction,_=d.objectStoreNames.contains(this._storeName)?u.objectStore(this._storeName):d.createObjectStore(this._storeName),g=d.objectStoreNames.contains("last_access")?u.objectStore("last_access"):d.createObjectStore("last_access");g.indexNames.contains("date")||g.createIndex("date","date",{unique:!1}),g.indexNames.contains("byteSize")||g.createIndex("byteSize","byteSize",{unique:!1}),l.oldVersion<this._version&&(_.clear(),g.clear())},c2(t)})).then((t=>{this._destroyed?t.close():this._db=t}))}destroy(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0}get initialized(){return null!=this._db}getHitRate(){return this._hit/(this._hit+this._miss)}put(t,l){return null==this._db?Promise.reject(new ie("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:Promise.resolve()).then((()=>this._put(t,l))).catch((d=>{if(d&&"QuotaExceededError"===d.name)return null==this._quotaReductionPromise&&(this._quotaReductionPromise=this._getCacheSize().then((t=>this._removeLeastRecentlyAccessed(l.byteSize+Math.ceil(t*this.quotaReductionFactor)))),this._quotaReductionPromise.then((()=>this._quotaReductionPromise=null),(()=>this._quotaReductionPromise=null))),this._quotaReductionPromise.then((()=>this._put(t,l)));throw d})).then((()=>{this._gcCounter--,this._gcCounter<0&&null!=this._db&&(this._gcCounter=this.gcFrequency,this._getCacheSize().then((t=>this._removeLeastRecentlyAccessed(t-this.maxByteSize))))}))}get(t,l){const d=this._db;if(null==d)return Promise.resolve(void 0);let u=null;return Promise.resolve().then((()=>{const _=d.transaction(this._storeName,"readonly");return u=re(l,(()=>{_.abort()})),c2(_.objectStore(this._storeName).get(t))})).then((l=>(null==l?++this._miss:this._db&&(++this._hit,this._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:l.byteSize},t)),null!=u&&u.remove(),l))).catch((()=>{++this._miss,ae(l),null!=u&&u.remove()}))}remove(t){const l=this._db;return null==l?Promise.resolve():Promise.resolve().then((async()=>{const d=l.transaction([this._storeName,"last_access"],"readwrite"),u=d.objectStore(this._storeName),_=d.objectStore("last_access"),g=u.delete(t),p=_.delete(t);await Promise.all([c2(g),c2(p),n2(d)])}))}_put(t,l){const d=this._db;if(null==d)return Promise.resolve();const u=d.transaction([this._storeName,"last_access"],"readwrite"),_=u.objectStore(this._storeName),g=u.objectStore("last_access"),p=_.put(l,t),m=g.put({date:Date.now(),byteSize:l.byteSize},t);return Promise.all([c2(p),c2(m),n2(u)])}_removeLeastRecentlyAccessed(t){if(t<=0||!this._db)return Promise.resolve();const l=this._db.transaction([this._storeName,"last_access"],"readwrite"),d=l.objectStore(this._storeName),u=l.objectStore("last_access");let _=0;const g=u.index("date").openCursor(null,"next");return g.onsuccess=()=>{const l=g.result;null!=l&&(null!=l.value.byteSize&&(_+=l.value.byteSize),d.delete(l.primaryKey),u.delete(l.primaryKey),_<t&&l.continue())},n2(l)}_getCacheSize(){const t=this._db;if(null==t)return Promise.resolve(0);const l=t.transaction("last_access"),d=l.objectStore("last_access");let u=0;const _=d.index("byteSize").openKeyCursor();return _.onsuccess=()=>{const t=_.result;if(!t)return;const l=t.key;null!=l&&(u+=l),t.continue()},n2(l).then((()=>u))}}function n2(t){return new Promise(((l,d)=>{t.oncomplete=()=>l(),t.onerror=()=>d(t.error),t.onabort=()=>d(t.error)}))}function c2(t){return new Promise(((l,d)=>{"done"===t.readyState?null!=t.error?d(t.error):l(t.result):(t.onsuccess=()=>l(t.result),t.onerror=()=>d(t.error))}))}const Vs=new WeakMap;class s2{constructor(t,l){switch(this._miss=0,this._hit=0,this.initialized=!0,l){case"layer":this._data=new Map;break;case"view":{const l=Vs.get(t);if(l){this._data=l;break}const d=new Map;this._data=d,Vs.set(t,d)}}}init(){return Promise.resolve()}async get(t,l){if(this._data.has(t))return this._hit++,this._data.get(t)??void 0;this._miss++}destroy(){}put(t,l){return this._data.set(t,l),Promise.resolve()}remove(t){return this._data.delete(t),Promise.resolve()}getHitRate(){return this._hit/(this._hit+this._miss)}}const Hs="esri.views.3d.layers.I3SMeshView3D",Et=()=>U.getLogger(Hs),Gs=[1,1,1,1];class jt extends Fs{constructor(t,l,d,u,_,g,p,m,f){super(),this.node=t,this.featureIds=l,this.objectHandle=d,this.cachedRendererVersion=u,this.attributeInfo=_,this.material=g,this.textures=p,this.anchorIds=m,this.anchors=f,this.cachedElevationAnchors=null,this.cachedEdgeMaterials=new Array,this.edgeMemoryUsage=0}}var Ls;!function(t){t[t.CastShadows=4]="CastShadows",t[t.Pickable=5]="Pickable"}(Ls||(Ls={}));const Us=100*se.MEGABYTES,At=l=>{let _=class extends l{constructor(){super(...arguments),this._needsNormals=!0,this._updatingHandles=new he,this._nodeId2Meta=new Map,this._nodeId2MetaReloading=new Map,this._i3sWasmLoaded=!1,this._snappingSourcesTrackers=[],this._hasLoadedPBRTextures=!1,this._asyncModuleLoading=0,this._addTasks=new Map,this._currentRenderer=null,this._rendererVersion=0,this._colorVariable=null,this._opacityVariable=null,this._rendererFields=null,this._symbologyFields=null,this._symbologyOverride=null,this._symbologyOverrideFields=null,this._symbolInfos=new Map,this._visibleGeometryChangedSchedulerHandle=null,this._hasComponentData=!1,this._hasVertexColors=!1,this._nodeColorOverride=null,this.updating=!0,this.holeFilling="auto",this._hasColors=!1,this._hasTextures=!1,this._hasData=!1,this.slicePlaneEnabled=!1,this._modifications=new Array,this.ignoresMemoryFactor=!1,this._layerUrl="",this._cacheKeySuffix=null,this._planetRadiusInGlobalMode=0,this._elevationTask=null,this._filters=[],this._arcade=null,this._tmpAttributeOnlyGraphic=new ce,this._crossfadeHelper=new Ps(this)}get lodCrossfadeoutDuration(){return 0}get lodCrossfadeinDuration(){return 0}get lodCrossfadeUncoveredDuration(){return 0}get layerUid(){return this.i3slayer&&this.i3slayer.uid}get sublayerUid(){return null}get layerId(){return this.i3slayer&&this.i3slayer.id}get sublayerId(){return null}get contentVisible(){var t;return!this.suspended&&(null==(t=this._controller)?void 0:t.rootNodeVisible)}get legendEnabled(){var t;return this.contentVisible&&!0===(null==(t=this.i3slayer)?void 0:t.legendEnabled)}get updatingProgressValue(){var t;return(null==(t=this._controller)?void 0:t.updatingProgress)??0}get hasTexturesOrVertexColors(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"}get rendererTextureUsage(){return ue(this._currentRenderer)?this._usePBR||this._hasLoadedPBRTextures?Vt.AllTexturesPBR:Vt.AllTextures:this._usePBR||this._hasLoadedPBRTextures?Vt.GeometryTexturesPBR:Vt.GeometryTextures}get elevationOffset(){const t=null!=this.i3slayer?this.i3slayer.elevationInfo:null;return null!=t&&"absolute-height"===t.mode?_e(t,this.i3slayer.spatialReference):0}get elevationInfo(){const t=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null==t)return new $t(Ns.Absolute,0);const l=_e(t,this.i3slayer.spatialReference);switch(t.mode){case"absolute-height":return new $t(Ns.Absolute,l);case"relative-to-ground":return new $t(Ns.RelativeToGround,l);case"on-the-ground":return new $t(Ns.OnTheGround,0);default:return new $t(Ns.Absolute,0)}}get supportedTextureEncodings(){return Ht(this.view._stage.renderView.capabilities)}get uncompressedTextureDownsamplingEnabled(){var t;const l=null==(t=this.view)?void 0:t.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled,d=!(this.supportedTextureEncodings&Gt.DDS_S3TC);return l&&d}get clientGeometry(){return this.i3sOverrides.geometryOverrides}get elevationRange(){const t=this._nodeId2Meta,l=new Mt;for(const d of t.values()){if(null==d)continue;const{node:{serviceMbsInIndexSR:t}}=d,[u,_,g,p]=t;l.expandElevationRangeValues(g-p,g+p)}return l.elevationRangeValid?l:null}get fullExtent(){return this.i3slayer.fullExtent}initialize(){var t;const l=ge("enable-feature:idb-mock-cache");this._idbCache=l?new s2(this.view,l):new i3("esri-scenelayer-cache","geometries"),this._preLoadBasis(),this.addResolvingPromise(this.i3slayer.indexInfo);const d=this.view.resourceController,u=d.memoryController;this.i3sOverrides=new Ut({view:this.view,layer:this.i3slayer,memoryController:u}),this._worker=new ws(_s(d)),this.addResolvingPromise(this._worker.promise);const _=this.i3slayer.store;this._worker.setLegacySchema(this.uid,_.defaultGeometrySchema),pe(this.i3slayer),me(this.i3slayer,this.view),this._layerUrl=this.i3slayer.parsedUrl.path,this._controller=new Yt({layerView:this,worker:this._worker}),this._gpuMemoryEstimate=0,this._texMemoryEstimate=0,this._geoMemoryEstimate=0,this._stage=this.view._stage,this._collection=this._stage.renderView.componentObjectCollection,this.resetHighlights();const g=_.defaultGeometrySchema;if(this._isIntegratedMesh||!g)this._hasComponentData=!1;else{const t=g.featureAttributes;this._hasComponentData=!!(t&&t.faceRange&&t.id)}this._hasVertexColors=null!=((null==g?void 0:g.vertexAttributes.color)??null)&&!(null==(t=this.i3slayer.cachedDrawingInfo)?void 0:t.color);const p=this.view.resourceController.memoryController.newCache(`sl-${this.uid}`,(t=>this._deleteComponentObject(t)));this._memCache=p;const m=this._controller,f=this._nodeId2Meta,y=this._nodeId2MetaReloading;this._intersectionHandler=new js({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,traverseNodeHierarchy:t=>{const l=m.index;if(!l)return;const d=l.rootNode;if(!d)return;l.traverse(d,(l=>{const d=l.index,u=f.get(d)||y.get(d);return t(l,(null==u?void 0:u.objectHandle)??null)}))}}),this._updatingHandles.add((()=>this.layerUid),(t=>this._intersectionHandler.layerUid=t)),this._updatingHandles.add((()=>this.sublayerUid),(t=>this._intersectionHandler.sublayerUid=t)),this._elevationProvider=new St({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this._hasLoadedPBRTextures=this._usePBR,this._updatingHandles.add((()=>this.view.clippingArea),(()=>this._clippingAreaChanged()),fe),this._updatingHandles.add((()=>this.fullOpacity),(t=>this._opacityChange(t))),this._updatingHandles.add((()=>this.slicePlaneEnabled),(t=>this._slicePlaneEnabledChange(t))),this._updatingHandles.add((()=>this.elevationOffset),((t,l)=>{this._reloadAll(l),this._controller.invalidateVisibilityObbs()})),this._updatingHandles.add((()=>this.elevationInfo),((t,l)=>this._elevationInfoChanged(t,l)),fe),this._updatingHandles.add((()=>!this.suspended&&this.elevationInfo.mode!==Ns.Absolute),((t,l)=>{t?this.addHandles(this.view.basemapTerrain.on("elevation-change",(({extent:t})=>this._ensureElevationTask().addExtent(t))),Zs):l&&this.removeHandles(Zs)}),fe),this._updatingHandles.add((()=>this._usePBR),(t=>this._updatePBR(t)));const c3=()=>{this._reloadAll(),this.clearMemCache()};this._updatingHandles.add((()=>this.rendererTextureUsage),c3),this._updatingHandles.add((()=>this.uncompressedTextureDownsamplingEnabled),c3),this._updatingHandles.add((()=>this.contentVisible),(t=>this._contentVisibleChanged(t)),fe),this._updatingHandles.add((()=>this.i3slayer.labelsVisible),(()=>this._labelingChanged()),fe),this._updatingHandles.add((()=>this.i3slayer.labelingInfo),(()=>this._labelingChanged()),fe),this._updatingHandles.add((()=>this._modifications),(()=>this._modificationsChanged()),fe),this.addHandles([S((()=>be.I3S_TREE_SHOW_TILES),(t=>{if(t&&!this._treeDebugger){const t=this._controller.crsIndex;ye((()=>import("./I3STreeDebugger-D_wyOLU3.js")),__vite__mapDeps([0,1,2,3])).then((({I3STreeDebugger:l})=>{!this._treeDebugger&&be.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new l({lv:this,view:this.view,nodeSR:t}))}))}else t||be.I3S_TREE_SHOW_TILES||(this._treeDebugger=N(this._treeDebugger))}),fe),S((()=>be.I3S_SHOW_MODIFICATIONS),(()=>this._showModifications()),fe)]),this._cacheKeySuffix=ve(this.i3slayer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch((t=>Et().warn(`Failed to initialize IndexedDB cache: ${t}`)));const{view:b}=this,{viewingMode:v,renderCoordsHelper:I}=b;this._planetRadiusInGlobalMode="local"===v?0:I.referenceEllipsoid.radius}destroy(){this._clearAddTasks(),this._elevationTask=N(this._elevationTask),this.i3sOverrides=N(this.i3sOverrides),this._elevationProvider&&(this._elevationProvider.objectsChanged(this.getVisibleObbs()),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);const t=this._worker;t&&(t.destroyContext(this.uid).then((()=>t.destroy())),this._worker=null),this._removeAllNodeDataFromStage(),this._memCache=N(this._memCache),this._collection=null,this._stage=null,this._edgeView=null,this._labeler=N(this._labeler),this._treeDebugger=N(this._treeDebugger),this._controller=N(this._controller),this._highlights.destroy(),this._nodeId2Meta.clear(),this._nodeId2MetaReloading.clear(),this._crossfadeHelper=N(this._crossfadeHelper),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null),this._updatingHandles=N(this._updatingHandles)}_memEstimateTextureAdded(t){const l=t.memoryEstimate;return this._gpuMemoryEstimate+=l,this._texMemoryEstimate+=l,l}_memEstimateTextureRemoved(t){if(null!=t){const l=t.memoryEstimate;this._gpuMemoryEstimate-=l,this._texMemoryEstimate-=l}}_memEstimateGeometryAdded(t){const l=this._collection.getObjectGPUMemoryUsage(t);return this._gpuMemoryEstimate+=l,this._geoMemoryEstimate+=l,l}_memEstimateGeometryRemoved(t){const l=this._collection.getObjectGPUMemoryUsage(t);this._gpuMemoryEstimate-=l,this._geoMemoryEstimate-=l}isNodeLoaded(t){return this._nodeId2Meta.has(t)}isNodeReloading(t){return this._nodeId2MetaReloading.has(t)}get usedMemory(){let t=null!=this._labeler?this._labeler.usedMemory:0;return this._nodeId2Meta.forEach((l=>t+=null!=l?l.node.memory:0)),this._nodeId2MetaReloading.forEach((l=>t+=null!=l?l.node.memory:0)),t}get unloadedMemory(){return(null!=this._controller?this._controller.unloadedMemoryEstimate:0)+(null!=this._labeler?this._labeler.unloadedMemoryEstimate:0)}_labelingChanged(){if(!Ie(this.i3slayer)||!this._supportsLabeling)return void(null!=this._labeler&&(this._labeler.destroy(),this._labeler=null));if(null!=this._labeler)return;const t=new Es({view:this.view,layer:this.i3slayer,collection:this._collection,overrides:this.i3sOverrides});this._nodeId2Meta.forEach((l=>null!=l&&this._addMetaToLabeler(t,l))),this._labeler=t}_loadAsyncModule(t){return++this._asyncModuleLoading,t.then((t=>(--this._asyncModuleLoading,t)),(t=>{throw--this._asyncModuleLoading,t}))}_modificationsChanged(){if(!this._i3sWasmLoaded&&this.hasModifications)return this._i3sWasmLoaded=ns().then((()=>{this._i3sWasmLoaded=!0,this._modificationsChanged(),this.notifyUpdate()})),void this.notifyUpdate();if(!0!==this._i3sWasmLoaded)return;const t=this.uid,l=this.i3slayer.spatialReference;this._worker.setModifications(t,this._layerClippingArea,this._modifications,l);const d=a$2(this._layerClippingArea,this._modifications,l);os({context:t,modifications:d,isGeodetic:l.isGeographic}),this._controller.modificationsChanged();const u=this.hasModifications?new H:null;this._nodeId2Meta.forEach(((t,l)=>{null==t?(this._nodeId2Meta.delete(l),this._controller.updateLoadStatus(l,!1)):t.node.hasModifications?(this._nodeId2Meta.delete(l),this._nodeId2MetaReloading.set(l,t)):null!=u&&u.push(t.node)})),this.notifyChange("elevationRange"),null!=u&&this._nodeId2MetaReloading.forEach((t=>u.push(t.node))),null!=u&&u.length>0&&(this.updateNodeModificationStatus(u),u.forAll((t=>{if(t.imModificationImpact!==hs.Culled){const l=this._nodeId2Meta.get(t.index);this._controller.invalidateGeometryVisibility(t.index),null!=l?(this._nodeId2Meta.delete(t.index),this._nodeId2MetaReloading.set(t.index,l),this.notifyChange("elevationRange")):this._nodeId2Meta.has(t.index)&&(this._nodeId2Meta.delete(t.index),this._controller.updateLoadStatus(t.index,!1))}}))),this.clearMemCache(),this._controller.restartNodeLoading(),this._showModifications()}_showModifications(){if(null!=this._modificationGraphics&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null),!be.I3S_SHOW_MODIFICATIONS||0===this._modifications.length)return;const t={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},l={outline:{color:[255,255,255],width:1}};this._modificationGraphics=new Array;for(const d of this._modifications){const u=d.geometry;u.spatialReference=this.i3slayer.spatialReference;const _=new Me({...l,color:t[d.type]});this._modificationGraphics.push(new ce({geometry:u,symbol:_}))}this.view.graphics.addMany(this._modificationGraphics)}_addMetaToLabeler(t,l){t.addNodeMeta(l,((t,l)=>this._createAttributes(t,l)))}_contentVisibleChanged(t){t?(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler)):(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler))}getLoadedAttributes(t){const l=this._nodeId2Meta.get(t);if(null!=(null==l?void 0:l.attributeInfo))return l.attributeInfo.loadedAttributes}getAttributeData(t){const l=this._nodeId2Meta.get(t);if(null!=(null==l?void 0:l.attributeInfo))return l.attributeInfo.attributeData}setAttributeData(t,l){const d=this._nodeId2Meta.get(t);null!=(null==d?void 0:d.attributeInfo)&&(d.attributeInfo.attributeData=l,this._attributeValuesChanged(d))}async updateAttributes(t,l,d){const u=this._nodeId2Meta.get(t);null!=u&&(await this.i3sOverrides.applyAttributeOverrides(u.featureIds,l,d,this._controller.requiredAttributes),u.attributeInfo=l,this._controller.reschedule((()=>this._attributeValuesChanged(u)),d).catch((t=>{Ce(t)||Et().warn("Error while updating attribute values. Layer might not display correctly.",t)})))}_attributeValuesChanged(t){t.cachedRendererVersion=this._getInvalidRendererVersion(),t.filteredIds=null,null!=this._labeler&&this._labeler.setNodeMetaAttributes(t,((t,l)=>this._createAttributes(t,l))),this._updateEngineObject(t)}clearMemCache(){null!=this._memCache&&this._memCache.clear()}getVisibleNodes(){const t=new Array;return this._nodeId2Meta.forEach((l=>null!=l&&t.push(l.node))),t}getVisibleObbs(){const t=new Array;return this._nodeId2Meta.forEach((l=>{if(null!=l){const d=this.getNodeComponentObb(l.node);null!=d&&t.push(d)}})),t}getNodeComponentObb(t){const l=this._nodeId2Meta.get(t.index)??this._nodeId2MetaReloading.get(t.index);return null!=l?this._collection.getComponentObb(l.objectHandle):null}getLoadedNodeIndices(t){this._nodeId2Meta.forEach(((l,d)=>t.push(d))),this._nodeId2MetaReloading.forEach(((l,d)=>t.push(d)))}_preLoadBasis(){var t;!ge("disable-feature:i3s-basis")&&this.supportedTextureEncodings&Gt.Basis&&(null==(t=this.i3slayer.textureSetDefinitions)?void 0:t.some((t=>t.formats.some((t=>"basis"===t.format||"ktx2"===t.format)))))&&Ee()}_getVertexBufferLayout(t,l){const d={hasTexture:Lt(t.params.material),hasNormals:l.normal,hasRegions:l.uvRegion};return we(xe(this._getGeometryParameters(d)))}_getObjectIdField(){return this.i3slayer.objectIdField||Oe}_getGlobalIdField(){var t;return null==(t=this.i3slayer.associatedLayer)?void 0:t.globalIdField}_findGraphicNodeAndIndex(t){const l=us(this.i3slayer.fieldsIndex,t.attributes,this._getObjectIdField());let d=null;return I(this._nodeId2Meta,(t=>{if(null==t)return!1;const u=t.featureIds.indexOf(l);return-1!==u&&(d={node:t.node,index:u},!0)})),d}_getGraphicIndices(t,l){const d=this._nodeId2Meta.get(t.index);if(null==d)return[];const u=[],_=this._getObjectIdField(),g=this.i3slayer.fieldsIndex;for(const p of l){const t=us(g,p.attributes,_),l=d.featureIds.indexOf(t);-1!==l&&u.push(l)}return u}whenGraphicBounds(t){const l=this._findGraphicNodeAndIndex(t);if(!l)return Promise.reject();const d=this._getAABB(l.node.index,l.index);return null==d?Promise.reject():Promise.resolve({boundingBox:d,screenSpaceObjects:[]})}getAABBFromIntersectorTarget(t){return null==t.nodeIndex||null==t.componentIndex?null:this._getAABB(t.nodeIndex,t.componentIndex)}_getAABB(t,l){const _=this._nodeId2Meta.get(t);if(null==(null==_?void 0:_.featureIds)||l>=_.featureIds.length)return null;const g=_.objectHandle,m=c$2(l,this._collection,g,d(24),0),f=this.view.renderSpatialReference,y=this.view.spatialReference;if(!u(m,f,0,m,y,0,8))return null;const b=Se();return p(b,m,0,8),b}whenGraphicAttributes(t,l){return Re(this.i3slayer,t,this._getObjectIdField(),l,(()=>[...this._nodeId2Meta.values()].filter(Ne)))}getGraphicFromIntersectorTarget(t){if(null==t.nodeIndex||null==t.componentIndex)return null;const l=this._nodeId2Meta.get(t.nodeIndex);return null==(null==l?void 0:l.featureIds)||t.componentIndex>=l.featureIds.length?null:this._createGraphic(t.componentIndex,l)}_getCacheKey(t){return`${this._layerUrl}/v24/${t}${this._cacheKeySuffix}`}_getMemCacheKey(t,l=this.elevationOffset){return t+"#"+l}get _idbCacheEnabled(){return!this._controller.disableIDBCache&&!this.hasModifications&&0===this.elevationOffset&&null!=this._cacheKeySuffix}loadCachedGPUData(t){return null!=this._memCache?this._memCache.pop(this._getMemCacheKey(t)):null}deleteCachedGPUData(t){null!=t&&this._deleteComponentObject(t)}_cacheGPUData(t,l=this.elevationOffset){if(null==this._memCache)return void this._deleteComponentObject(t);const d=this._controller.indexDepth-t.node.level;this._memCache.put(this._getMemCacheKey(t.node.index,l),t,t.node.memory,d)}loadMissingTextures(t,l,d,u){const _=(null==t?void 0:t.filter(((t,d)=>{if(!(t.usage&this.rendererTextureUsage))return!1;if(null==l)return!0;const u=Qt(t.encodings,this.supportedTextureEncodings),_=l[d];return!!(null==(null==_?void 0:_.data)||u&&_.encoding!==u.encoding)})))??[];return 0===_.length?Promise.resolve(!1):d(_,u).then((d=>{let u=0;for(let _=0;_<t.length;_++)u<d.length&&d[u].id===t[_].id&&(l[_]=d[u],u++);return!0}))}loadCachedNodeData(t,l,d){return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(t.id),l).then((u=>null==u?null:u.nodeVersion!==t.version?(this._idbCache.remove(this._getCacheKey(t.id)),null):(this.elevationInfo.mode===Ns.Absolute&&(t.geometryObbInRenderSR=oe.fromData(u.geometryObbData)),this.loadMissingTextures(u.requiredTextures,u.textureData,d,l).then((d=>(d&&this._idbCache.initialized&&null!=u.textureData&&(u.byteSize=qt(u.transformedGeometry,u.textureData),u.textureData.every(Bt)&&Wt(t,u)&&this._idbCache.put(this._getCacheKey(t.id),u).catch((l=>Et().warn(`Failed to update node with textures in IndexedDB cache: ${t.id}: ${l}`)))),ae(l),u)))))):Promise.resolve(null)}addNode(t,l,d){return function kt(t){return"geometryData"in t}(l)?null==l.geometryBuffer?(this._addNodeMeta(t.index,null),Promise.resolve()):this._addData(t,l.attributeDataInfo,(()=>this._transformNode(t,l,d).then((u=>this._safeReschedule((()=>{if(null==u)return t.hasModifications=!1,this._addCachedNodeData(t,null,d);t.hasModifications=u.transformedGeometry.hasModifications;const{obb:_,componentOffsets:g,featureIds:p,anchorIds:m,anchors:f,transformedGeometry:y,globalTrafo:b}=u,v=De(Qs,_.center.x,_.center.y,_.center.z);Te(v,v,b);const I=new oe(v,[_.extents.x,_.extents.y,_.extents.z],Ae(_.orientation.x,_.orientation.y,_.orientation.z,_.orientation.w));this.elevationInfo.mode===Ns.Absolute&&(t.geometryObbInRenderSR=I),l.geometryData.componentOffsets=g,p&&(l.geometryData.featureIds=Array.from(p)),l.geometryData.anchorIds=m,l.geometryData.anchors=f;const M={nodeVersion:t.version,geometryData:l.geometryData,requiredTextures:l.requiredTextures,textureData:l.textureData,transformedGeometry:y,globalTrafo:b,geometryObbData:I.data,byteSize:qt(y,l.textureData)};if(this._idbCacheEnabled&&this._idbCache.initialized&&Wt(t,M)){const l=null!=M.textureData?M.textureData.map((t=>Bt(t)?t:null)):null;this._idbCache.put(this._getCacheKey(t.id),{...M,textureData:l}).catch((l=>Et().warn(`Failed to store node in IndexedDB cache: ${t.id}: ${l}`)))}return this._addCachedNodeData(t,M,d)}),d))))):Promise.reject()}getElevationRange(t){const l=new Mt,d=this._controller,{index:u}=d;if(!u)return l;const{rootNode:_}=u;if(!_)return l;const g=this._nodeId2Meta,p=t[3],m=d.viewportQueries,f=this._planetRadiusInGlobalMode,{view:y}=this,{renderCoordsHelper:b}=y,v=b.referenceEllipsoid.radius,I=this._collection;return u.traverse(_,(d=>{const{childrenLoaded:u}=d;if(0===u)return!1;const _=m.getAndUpdateVisibilityObbInRenderSR(d);let y=null,M=-1;if(_){if(M=_.radius,!_.intersectSphereWithMBS(t,M))return!1}else y=m.getServiceMbsInRenderSR(d),y&&(M=y[3]);if(M>=0&&p>=1*M)return null!=_?ei(l,_,f):null!=y&&y[3]>=0&&ti(l,y,f),!1;const C=si;if(C.elevationRangeMin=1/0,C.elevationRangeMax=-1/0,(null!=_||null!=y)&&(null!=_?ei(C,_,f):null!=y&&ti(C,y,f),C.elevationRangeMin>=l.elevationRangeMin&&C.elevationRangeMax<=l.elevationRangeMax))return!1;const E=g.get(d.index);if(E){const{geometryObbInRenderSR:u}=d;if(!u||u.intersectSphereWithMBS(t)){if(u&&p>0*u.radius)return ei(l,u,f),!1;const{objectHandle:t}=E,d=I.getObjectTransform(t),_=b.getAltitude(d.position);I.expandRangeWithComponentObjectElevationRange(t,_,v,l)}}return u-(E?1:0)>0})),l}computeVisibilityObb(t){return Fe(t,this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications,this.view.renderCoordsHelper.sphericalPCPF)}_transformNode(t,l,d){var u;const _=l.geometryData.geometries??[],g=new Array(_.length);for(let x=0;x<_.length;++x)g[x]=this._getVertexBufferLayout(_[x],l.geometryDescriptor);const p=this.i3slayer.normalReferenceFrame,m=l.normalReferenceFrame??p??"none",f=t.serviceMbsInIndexSR,y=this.elevationOffset,b=this._controller.crsIndex,v=this._controller.crsVertex,I=this.view.renderSpatialReference,M=Pe(f,y,m,b,I),C=je(b,v),E=je(v,I);if(null==C||null==E)return Promise.resolve(null);const w={context:this.uid,geometryBuffer:l.geometryBuffer,geometryData:l.geometryData,geometryDescriptor:l.geometryDescriptor,layouts:g,globalTrafo:M,mbs:f,obbData:null==(u=t.serviceObbInIndexSR)?void 0:u.data,elevationOffset:y,needNormals:this._needsNormals&&this._controller.isMeshPyramid,normalReferenceFrame:m,indexToVertexProjector:C,vertexToRenderProjector:E};return this._worker.invoke(w,d)}get _supportsNodeCrossFading(){var t,l;return!(null==(l=null==(t=this.view)?void 0:t._stage)?void 0:l.renderer.shadowsEnabled)}get nodeCrossfadingEnabled(){return this._supportsNodeCrossFading&&(this.lodCrossfadeinDuration>0||this.lodCrossfadeoutDuration>0||this.lodCrossfadeUncoveredDuration>0)}get nodeFadeoutEnabled(){return this._supportsNodeCrossFading&&this.lodCrossfadeoutDuration>0}_setNewNodeOpacity(t){const l=this.nodeCrossfadingEnabled?0:this.fullOpacity;this._setNodeOpacity(t,l)}addCachedGPUData(t,l,d){if(this.elevationInfo.mode===Ns.Absolute&&(t.geometryObbInRenderSR=this._collection.getComponentObb(l.objectHandle).clone()),!this._controller.isGeometryVisible(t))return void this._cacheGPUData(l);null!=this._labeler&&this._addMetaToLabeler(this._labeler,l);const u=t.index;this._addNodeMeta(u,l),this.updateNodeState(u,d),this._collection.setObjectVisibility(l.objectHandle,!0),this._updateMaterial(l),this._setNewNodeOpacity(l),this.elevationInfo.mode!==Ns.Absolute&&this._ensureElevationTask().schedule(u),this._updateEngineObject(l),this._highlights.objectCreated(l),null!=this._treeDebugger&&this._treeDebugger.update()}addCachedNodeData(t,l,d,u){return this._addData(t,d,(()=>this._addCachedNodeData(t,l,u)))}async deleteCachedNodeData(t){if(this._idbCacheEnabled)return this._idbCache.remove(this._getCacheKey(t))}async _addCachedNodeData(t,l,d){var u;if(!this.contentVisible||!this._controller.isGeometryVisible(t))return void this._removeNodeStageData(t.index,this.elevationOffset,this._nodeId2MetaReloading);if(null==l)return void this._addNodeMeta(t.index,null);const _=this._addTasks.get(t.index),{geometryData:g,transformedGeometry:p,globalTrafo:m}=l;await this.i3sOverrides.applyAttributeOverrides(g.featureIds,_.attributeInfo,d,this._controller.requiredAttributes);const y=null!=l.textureData?l.textureData.filter((t=>null!=t&&!!(t.usage&this.rendererTextureUsage))):[];!ge("disable-feature:i3s-basis")&&y.some((t=>null!=t&&(t.encoding===Gt.Basis||t.encoding===Gt.KTX2)))&&await Ee(),t.memory=0;const{componentOffsets:v,geometries:I,featureIds:M,anchorIds:C,anchors:E}=g,w=this._collection,x=I[0],{layout:O,indices:S,interleavedVertexData:R,positionData:N,hasColors:T}=p,{material:A,geometryParameters:F}=this._materialParameters(x,O),P=v||new Uint32Array([0,S?S.length:R.byteLength/O[0].stride]),j={vertices:{data:R,count:R.byteLength/O[0].stride,layoutParameters:F},positionData:{positions:Ve(N.data),indices:He(N.indices)},indices:S,componentOffsets:P},V=x.transformation?Ge(x.transformation):Le();Ue(V,m,V);const H=ke(b(),V),L=Be(qe(),V),U=this.view.renderSpatialReference,B=this.view.basemapTerrain.spatialReference,q=oe.fromData(l.geometryObbData).center,z=[1,1,1];Rt(q,U,z,B)||Et().errorOnce("Unsupported coordinate system for IM overlay");const $=b();k(q,U,$,B);const W=qe();ze(W,L);const K=b();f(K,$e(K,q,H),W);const Y=$[0]-K[0]*z[0],Q=$[1]-K[1]*z[1],X=w.createObject(new Nt(We(Y,Q,z[0],z[1]),new Tt(H,L),oe.fromData(l.geometryObbData),j)),Z=F.textureCoordinates===Ke.Atlas,{textures:J,texturePromise:ee}=this._initMaterialAndTextures(X,A,y,Z);t.memory+=this._memEstimateGeometryAdded(X),t.memory+=J.reduce(((t,l)=>t+(null!=l?this._memEstimateTextureAdded(l):0)),0);const te=!!A.hasParametersFromSource,se="blend"!==A.alphaMode&&A.metallicRoughness.baseColorFactor[3]>=1,ie=new jt(t,M,X,this._getInvalidRendererVersion(),_.attributeInfo,{hasParametersFromSource:te,isOpaque:se},J,C,E);_.meta=ie,!this._hasTextures&&(null==(u=l.requiredTextures)?void 0:u.some((({usage:t})=>!!(t&Vt.ColorTextures))))&&(this._hasTextures=!0),this._hasData=!0,this._hasColors=this._hasColors||T,this._hasTextures=this._hasTextures||!!t.resources.texture,this.notifyChange("hasTexturesOrVertexColors");const re=this.slicePlaneEnabled;return Promise.all([this._addOrUpdateEdgeRendering(ie),ee]).then((([l,u])=>(this._addTasks.has(t.index)&&(null==l||l.updateObjectVisibility(ie.objectHandle,!1).catch((t=>Dt(t,this.i3slayer.title)))),this._safeReschedule((()=>{const d=this._addTasks.get(t.index);if(!d)return;if(this._addNodeMeta(t.index,ie),d.meta=null,!this.contentVisible)return void this._removeNodeStageData(t.index,this.elevationOffset);w.setObjectVisibility(X,!0),null==l||l.updateObjectVisibility(ie.objectHandle,!0).catch((t=>Dt(t,this.i3slayer.title))),ie.attributeInfo=d.attributeInfo;const u=ie.cachedRendererVersion!==this._rendererVersion,_=re!==this.slicePlaneEnabled;this._updateElevationOffsets(ie);const g=ie.elevationOffsets;this._updateComponentData(ie);const p=this._applyFiltersToNode(ie);(u||null!=l&&(_||p||g))&&this._addOrUpdateEdgeRendering(ie),null!=this._labeler&&this._addMetaToLabeler(this._labeler,ie),this._visibleGeometryChanged(ie,ks.ADD),this._highlights.objectCreated(ie),this._updateMaterial(ie),this._setNewNodeOpacity(ie),null!=this._treeDebugger&&this._treeDebugger.update()}),d)))).catch((t=>{throw null!=_.meta&&(this._cacheGPUData(_.meta),_.meta=null),t}))}_addNodeMeta(t,l){if(this._removeNodeStageData(t,this.elevationOffset,this._nodeId2MetaReloading),this._nodeId2Meta.has(t)){Et().error("Removing duplicated node");const l=this._nodeId2Meta.get(t);null!=l&&this._deleteComponentObject(l)}else this._controller.updateLoadStatus(t,!0);null!=l&&(l.lodCrossfadeProgress=null,this.nodeCrossfadingEnabled&&Kt(l.cachedEdgeMaterials,0)),this._nodeId2Meta.set(t,l),this.notifyChange("elevationRange")}_updateElevationOffsets(t){const l=this.view.renderSpatialReference,u=this._controller.crsIndex,_=this.elevationInfo,g=this.view.basemapTerrain,p=g.spatialReference,m=_.mode;if(null==l||null==p||m===Ns.Absolute)return void(t.elevationOffsets=null);const b=this._collection.getObjectTransform(t.objectHandle);t.elevationOffsets=t.elevationOffsets??[];const v=Qs,I=Xs,M=m===Ns.OnTheGround,C=this.view.renderCoordsHelper,E=t.featureIds.length,w=(()=>{var _;if(t.cachedElevationAnchors)return t.cachedElevationAnchors;const g=d(3*E);t.cachedElevationAnchors=g;for(let d=0;d<E;d++){const m=3*d,M=(null==(_=t.anchorIds)?void 0:_.indexOf(d))??-1;t.anchors&&M>=0?(De(v,t.anchors[3*M],t.anchors[3*M+1],t.anchors[3*M+2]),y(v,v,Ye(t.node.serviceMbsInIndexSR)),k(v,u,v,p),g[m]=v[0],g[m+1]=v[1],g[m+2]=C.getAltitude(v)):(this._collection.getComponentAabb(t.objectHandle,d,I,!0),De(v,(I[0]+I[3])/2,(I[1]+I[4])/2,I[2]),f(v,v,b.rotationScale),y(v,v,b.position),g[m+2]=C.getAltitude(v),k(v,l,v,p),g[m]=v[0],g[m+1]=v[1])}return g})(),x=_.offset,O=t.elevationOffsets;g.getElevations(w,E,((t,l)=>{const d=M?w[3*t+2]:0;O[t]=x+(null!=l?l-d:0)}))}_ensureElevationTask(){return null!=this._elevationTask||(this._elevationTask=new As(this.view.resourceController.scheduler,(t=>{const l=this._controller.updateElevationChanged(t,this.view.basemapTerrain.spatialReference);return null!=l?l.filterInPlace((t=>null!=this._nodeId2Meta.get(t))):null}),(t=>{const l=this._nodeId2Meta.get(t);this._nodeElevationAlignmentChanged(l)}),(()=>{var t;return null==(t=this.elevationInfo)?void 0:t.mode}))),this._elevationTask}_elevationInfoChanged(t,l){const d=t.mode!==Ns.Absolute,u=!!l&&l!==t&&l.mode!==Ns.Absolute;this._intersectionHandler.updateElevationAlignState(d,this.view.state.viewingMode),d&&!u&&this._controller.removeAllGeometryObbs(),this._nodeId2Meta.forEach((t=>this._nodeElevationAlignmentChanged(t)))}_nodeElevationAlignmentChanged(t){null!=t&&(this._updateElevationOffsets(t),this._updateComponentData(t),this._updateEdgeRendering(t),null!=this._labeler&&this._labeler.updateLabelPositions(t),this._updateSnappingSources(t,ks.UPDATE))}_safeReschedule(t,l){return ae(l),this._controller.reschedule(t,l)}_materialParameters(t,l){const d=null!=t.params.material?t.params.material:Xt(),u=l.some((t=>"uvRegion"===t.name)),_=l.some((t=>"normalCompressed"===t.name)),g=Lt(d);return{geometryParameters:this._getGeometryParameters({hasTexture:g,hasNormals:_,hasRegions:u}),material:d}}_initMaterialAndTextures(t,l,d,u){const _=this._stage.renderView,g=d.map((t=>Zt(t,l,u,_)));this._stage.addMany(g);let p=null;return this._collection.updateMaterial(t,(t=>{p=Jt(t,l,g,d,this.view._stage.renderView.textures,{rendererTextureUsage:this.rendererTextureUsage,usePBR:this._usePBR,isIntegratedMesh:this._isIntegratedMesh,slicePlaneEnabled:this.slicePlaneEnabled,viewSpatialReference:this.view.spatialReference}),this._updateMaterialOverlay(t)})),{textures:g,texturePromise:p}}_getGeometryParameters(t){return{textureCoordinates:t.hasTexture?t.hasRegions?Ke.Atlas:Ke.Default:Ke.None,colors:this._hasVertexColors,hasNormals:t.hasNormals&&this._needsNormals,needsNormals:this._needsNormals}}_addData(t,l,d){let u=this._addTasks.get(t.index);return u?u.attributeInfo=l:(u={...Qe(),attributeInfo:l,meta:null},this._addTasks.set(t.index,u),d().then(u.resolve,u.reject).then((()=>this._addTasks.delete(t.index))).catch((l=>{throw this._addTasks.delete(t.index),l}))),u.promise}_clearAddTasks(){this._addTasks.forEach((t=>{null!=t.meta&&(this._cacheGPUData(t.meta),t.meta=null)})),this._addTasks.clear()}_clippingAreaChanged(){const t=this.view.renderSpatialReference,l=this.i3slayer.spatialReference,d=ne();this._renderClippingArea=Xe(this.view.clippingArea,d,t)?d:null;const u=ne();this._layerClippingArea=Xe(this.view.clippingArea,u,l)?u:null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea),this._isIntegratedMesh&&this._modificationsChanged()}get hasGeometryFilter(){return!1}_geometryFilterChange(){const t=this.hasGeometryFilter;this._controller.geometryFilterChanged(t),this._applyFilters(t)}_filterChange(){this._applyFilters(this.hasGeometryFilter)}_applyFilters(t){this._filters=this.getFilters(),t?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach((t=>{null!=t&&this._applyFiltersToNode(t)&&(this._addOrUpdateEdgeRendering(t),this._visibleGeometryChanged(t,ks.UPDATE))}))}getFilters(){const t=[],l=this._renderClippingArea;return null!=l&&t.push(((t,d)=>this._boundingRectFilter(t,d,l))),t}addSqlFilter(t,l,d){if(null!=l){const u=l.fieldNames;t.push(((t,_)=>this._sqlFilter(t,_,l,u,d)))}}_sqlFilter(t,l,d,u,_){var g;const p={},m=this._createLayerGraphic(p),f=this.i3slayer.objectIdField,y=l.featureIds,b=null==(g=l.attributeInfo)?void 0:g.attributeData;u.every((t=>t===f||null!=(null==b?void 0:b[t])))&&Ze(t,y,(t=>{p[f]=y[t];for(const d of u)d!==f&&(p[d]=b?Je(b[d],t):null);try{return d.testFeature(m)}catch(l){return _(l),!1}}))}_boundingRectNodeTest(t,l){return Ft(t.node.serviceMbsInIndexSR,this._controller.crsIndex,Ys,this.view.renderSpatialReference),et(l,Ys)}_boundingRectFeatureTest(t,l,d){return this._collection.getComponentAabb(t.objectHandle,l,Bs),tt(Bs,qs),st(d,qs)}_boundingRectFilter(t,l,d){const u=this._collection,_=this._boundingRectNodeTest(l,d);if(_===it.INSIDE)return;if(_===it.OUTSIDE)return void(t.length=0);const g=u.getComponentCount(l.objectHandle);if(g.invisible+g.visible!==l.featureIds.length)return;const p=this._transformClippingArea(zs,d,l.objectHandle);Ze(t,l.featureIds,(t=>this._boundingRectFeatureTest(l,t,p)))}_transformClippingArea(t,l,d){const u=this._collection.getObjectTransform(d),_=u.position,g=u.rotationScale;return t[0]=(l[0]-_[0])/g[0],t[1]=(l[1]-_[1])/g[4],t[2]=(l[2]-_[0])/g[0],t[3]=(l[3]-_[1])/g[4],t}async _addOrUpdateEdgeRendering(t,l=!0){const d=t.objectHandle,{hasEdges:u,perFeatureEdgeMaterials:_}=this._getFilteredEdgeMaterials(t),g={hasSlicePlane:this.slicePlaneEnabled};u&&!this._edgeView&&(this._edgeView=await this._stage.renderer.loadEdgeView());const p=this._edgeView;if(!p)return null;const m=p.hasObject(d);if(u){if(m)return this.nodeCrossfadingEnabled&&Kt(_,this.getNodeOpacity(t)),p.updateAllComponentMaterials(d,_,g,l).catch((t=>Dt(t,this.i3slayer.title))),p.updateObjectVisibility(d,!0).catch((t=>Dt(t,this.i3slayer.title))),p.updateAllVerticalOffsets(d,t.elevationOffsets).catch((t=>Dt(t,this.i3slayer.title))),p;const u=await this._collection.addEdges(d,p,_,g,t.elevationOffsets);return t.edgeMemoryUsage=u,t.node.memory+=u,p}return m&&(t.node.memory-=t.edgeMemoryUsage,t.edgeMemoryUsage=0,p.removeObject(d)),null}_applyFiltersToNode(t){return!!this._applyFiltersToNodeComponents(t)&&(null!=this._labeler&&this._labeler.applyFilterChange(t),!0)}_applyFiltersToNodeComponents(t){const l=this._collection,d=l.getComponentCount(t.objectHandle),u=null!=t.filteredIds,_=0===d.invisible;if(l.setAllComponentVisibilities(t.objectHandle,"all"),0===this._filters.length)return t.filteredIds=null,!_;if(this._updateCachedFilteredIds(t),u&&t.filteredIds===t.featureIds)return!_;const g=this._computeFilteredComponentIndices(t);return l.setAllComponentVisibilities(t.objectHandle,g),!0}_updateCachedFilteredIds(t){null!=t.filteredIds&&t.appliedFilters===this._filters||(t.filteredIds=this._computeFilteredIds(t),t.appliedFilters=this._filters)}_computeFilteredIds(t){const l=t.featureIds.slice();for(const d of this._filters)if(d(l,t),0===l.length)break;return l.length===t.featureIds.length?t.featureIds:l}_computeFilteredComponentIndices(t){const l=new Array,d=t.filteredIds;return null!=d&&t.featureIds.forEach(((t,u)=>{d[l.length]===t&&l.push(u)})),l}_removeAllNodeDataFromStage(t=this.elevationOffset){this._nodeId2Meta.forEach(((l,d)=>this._removeNodeStageData(d,t))),this._nodeId2MetaReloading.forEach(((l,d)=>this._removeNodeStageData(d,t,this._nodeId2MetaReloading))),this._elevationTask=N(this._elevationTask)}removeNode(t){const l=this.elevationOffset;this._removeNodeStageData(t,l),this._removeNodeStageData(t,l,this._nodeId2MetaReloading),null!=this._elevationTask&&this._elevationTask.remove(t)}_removeNodeStageData(t,l,d=this._nodeId2Meta){d.has(t)&&this._controller.updateLoadStatus(t,!1);const u=d.get(t);null!=u?(this._collection.setObjectVisibility(u.objectHandle,!1),null!=this._edgeView&&this._edgeView.hasObject(u.objectHandle)&&this._edgeView.updateObjectVisibility(u.objectHandle,!1).catch((t=>Dt(t,this.i3slayer.title))),this._visibleGeometryChanged(u,ks.REMOVE),null!=this._labeler&&this._labeler.removeNodeMeta(u),d.delete(t),this._highlights.objectDeleted(u),d===this._nodeId2Meta?(this._cacheGPUData(u,l),this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopNodeFading(u)):this._deleteComponentObject(u),null!=this._treeDebugger&&this._treeDebugger.update()):d.delete(t)}_deleteComponentObject(t){if(null!=this._edgeView&&this._edgeView.removeObject(t.objectHandle),this._memEstimateGeometryRemoved(t.objectHandle),this._collection.destroyObject(t.objectHandle),t.textures)for(const l of t.textures)this._memEstimateTextureRemoved(l),this._stage.remove(l)}updateNodeState(t,l){const d=this._nodeId2Meta.get(t);null!=d&&this._collection.updateMaterial(d.objectHandle,(t=>t.polygonOffsetEnabled=l===cs.Hole))}updateNodeIndex(t,l){if(this._nodeId2Meta.has(t)){const d=this._nodeId2Meta.get(t);this._nodeId2Meta.delete(t),this._nodeId2Meta.set(l,d),this.notifyChange("elevationRange")}const d=this._nodeId2MetaReloading.get(t);d&&(this._nodeId2MetaReloading.delete(t),this._nodeId2MetaReloading.set(l,d))}_invalidateAllSymbols(){this._rendererVersion=rt(this._rendererVersion,1),this._controller&&this._controller.requestUpdate()}_getInvalidRendererVersion(){return rt(this._rendererVersion,-1)}async _rendererChange(t){if(this._currentRenderer=t,this.notifyChange("rendererTextureUsage"),this._rendererVersion=rt(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,this._invalidateAllSymbols(),t&&(this._rendererFields=await t.getRequiredFields(this.i3slayer.fieldsIndex)),this._updateSymbologyFields(),!this._arcade&&t&&"arcadeRequired"in t&&t.arcadeRequired&&(this._arcade=await at()),t&&"visualVariables"in t&&t.visualVariables)for(const l of t.visualVariables)"color"===l.type?this._colorVariable=l:"opacity"===l.type?this._opacityVariable=l:Et().warn(`Unsupported visual variable type for 3D Object Scene Services: ${l.type}`);if(t)for(const l of t.getSymbols())"mesh-3d"!==l.type&&Et().error(`Symbols of type '${l.type}' are not supported for 3D Object Scene Services.`);this._controller&&this._controller.requestUpdate()}_getCachedEdgeMaterials(t){return this._hasComponentData&&t.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(t),t.cachedEdgeMaterials}_getComponentParameters(t){this._hasComponentData&&t.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(t);const l=t.cachedSymbology;return(d,u)=>{var _;const g=5*d;if(nt(u.externalColor,l[g]/255,l[g+1]/255,l[g+2]/255,l[g+3]/255),null!=this._stage.renderView.objectAndLayerIdRenderHelper){const l=t.featureIds[d],_=ot(this.view.map,this.layerUid);this._stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(l,l,this.layerId,this.layerUid+"_"+this.sublayerId,this.layerPopupEnabledAndHasTemplate&&!_,t.node.resources.attributes,d,this.sublayerId),u.objectAndLayerIdColor=this._stage.renderView.getObjectAndLayerIdColor({graphicUid:l,layerUid:this.layerUid+"_"+this.sublayerId})}u.externalColorMixMode=l[g+4]&(1<<Ls.CastShadows)-1,u.castShadows=!!(l[g+4]&1<<Ls.CastShadows),u.pickable=!!(l[g+4]&1<<Ls.Pickable),u.elevationOffset=(null==(_=t.elevationOffsets)?void 0:_[d])??0}}_getSymbolInfo(t,l){const d=null==t?void 0:t.getSymbol(l,{arcade:this._arcade});if(!(d instanceof lt))return null;const u=d.id;if(this._symbolInfos.has(u))return this._symbolInfos.get(u);const _=dt(d);return this._symbolInfos.set(u,_),_}_setSymbologyOverride(t,l){this._symbologyOverride!==t&&(this._symbologyOverride=t,this._symbologyOverrideFields=l,this._invalidateAllSymbols(),this._updateSymbologyFields())}_updateSymbologyFields(){this._symbologyFields=null!=this._symbologyOverrideFields&&this._symbologyOverrideFields.length>0?null!=this._rendererFields&&this._rendererFields.length>0?ht(this.i3slayer.fieldsIndex,[...this._rendererFields,...this._symbologyOverrideFields]):this._symbologyOverrideFields:this._rendererFields}_updateCachedRendererData(l){var d;if(l.cachedRendererVersion=this._rendererVersion,!this._hasComponentData)return;const u=this._tmpAttributeOnlyGraphic,_={};u.attributes=_;const g=this._currentRenderer,p=null==(d=l.attributeInfo)?void 0:d.attributeData,m=null!=l.featureIds?this.i3slayer.objectIdField:null,f=null!=p&&null!=this._symbologyFields&&this._symbologyFields.length>0;let y=null,b=null;if(f&&null!=this._symbologyFields){y=[],b=[];for(const t of this._symbologyFields){const l=p[t];l&&(y.push(t),b.push(l))}}l.cachedSymbology||(l.cachedSymbology=function e$1(l,d=!1){return l<=t?d?new Array(l).fill(0):new Array(l):new Uint8Array(l)}(5*l.featureIds.length));const v={color:Ws,castShadows:!0,pickable:!0,colorMixMode:ct.Multiply,edgeMaterial:null},I=this.fullOpacity,M=this.nodeCrossfadingEnabled?this.getNodeOpacity(l):I;let C=null,E=ut.OPAQUE,w=mt,x=0;for(let t=0;t<l.featureIds.length;t++){if(null!=m&&(_[m]=l.featureIds[t]),f&&y)for(let l=0;l<y.length;l++)_[y[l]]=Je(b[l],t);const d=g?this._getSymbolInfo(g,u):null;let p=null,I=null;if(g&&"visualVariables"in g){if(this._colorVariable){const t=_t(this._colorVariable,u,{color:Ks,arcade:this._arcade});t&&(p=Ws,p[0]=t.r/255,p[1]=t.g/255,p[2]=t.b/255,this._opacityVariable||null===t.a||(I=t.a))}this._opacityVariable&&(I=gt(this._opacityVariable,u,{arcade:this._arcade}))}if(null==d?void 0:d.material){const t=d.material;p=null==p||null==I?pt(p,I,t.color,t.alpha,Gs,Ws):pt(p,I,null,null,Gs,Ws)}if(null==p&&(p=Ws,p[0]=1,p[1]=1,p[2]=1,p[3]=1),v.pickable=!0,v.castShadows=!d||d.castShadows,v.colorMixMode=(null==d?void 0:d.material)?d.material.colorMixMode:ct.Multiply,v.edgeMaterial=d?d.edgeMaterial:null,null!=this._symbologyOverride&&(v.color=p,this._symbologyOverride(u,v),p=v.color),null!=this._nodeColorOverride&&(this._nodeColorOverride(l.node,p),v.colorMixMode=ct.Replace),null!=v.edgeMaterial){const d=p[3]<=0?ut.INVISIBLE:p[3]>=1&&(l.material.isOpaque||v.colorMixMode===ct.Replace)?ut.OPAQUE:ut.TRANSPARENT;v.edgeMaterial===C&&d===E||(w={...v.edgeMaterial,opacity:M,objectTransparency:d},C=v.edgeMaterial,E=d),l.cachedEdgeMaterials[t]=w}else l.cachedEdgeMaterials[t]=mt;l.cachedSymbology[x++]=Math.round(255*p[0]),l.cachedSymbology[x++]=Math.round(255*p[1]),l.cachedSymbology[x++]=Math.round(255*p[2]),l.cachedSymbology[x++]=Math.round(255*p[3]),l.cachedSymbology[x++]=v.colorMixMode|+v.castShadows<<Ls.CastShadows|+v.pickable<<Ls.Pickable}}_getFilteredEdgeMaterials(t){const l=this._getCachedEdgeMaterials(t);this.nodeCrossfadingEnabled||Kt(l,this.fullOpacity);const d=t.filteredIds;if(null==d)return{hasEdges:l.some((t=>t!==mt)),perFeatureEdgeMaterials:l};let u=0,_=!1;const g=l.map(((l,g)=>t.featureIds[g]!==d[u]?mt:(_=_||l!==mt,u++,l)));return{hasEdges:_,perFeatureEdgeMaterials:g}}_updateComponentData(t){if(!this._hasComponentData)return;const l=t.objectHandle,d=this._getComponentParameters(t);this._collection.setComponentData(l,d),this._stage.renderView.requestRender()}_reloadAll(t=this.elevationOffset){this._removeAllNodeDataFromStage(t),null!=this._controller&&this._controller.restartNodeLoading()}_opacityChange(t){this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopAllNodeFading(),this._nodeId2Meta.forEach((l=>{null!=l&&(this._collection.updateMaterial(l.objectHandle,(l=>l.objectOpacity=t)),Kt(l.cachedEdgeMaterials,t),this._updateEdgeRendering(l))}))}_updateMaterial(t){this._collection.updateMaterial(t.objectHandle,(t=>{t.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,t.usePBR=this._usePBR,this._updateMaterialOverlay(t)}))}_updateMaterialOverlay(t){}_updateEngineObject(t){this._updateComponentData(t),this._applyFiltersToNode(t),this._addOrUpdateEdgeRendering(t),this._visibleGeometryChanged(t,ks.UPDATE)}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),null!=this._labeler&&(this._labeler.slicePlaneEnabled=t),this._nodeId2Meta.forEach((l=>{null!=l&&(this._collection.updateMaterial(l.objectHandle,(l=>l.commonMaterialParameters.hasSlicePlane=t)),this._updateEdgeRendering(l,!1))}))}_updatePBR(t){this._nodeId2Meta.forEach((l=>{null!=l&&this._collection.updateMaterial(l.objectHandle,(l=>l.usePBR=t))})),this._hasLoadedPBRTextures=!0}get _usePBR(){return this._needsNormals&&this.view.qualitySettings.physicallyBasedRenderingEnabled}_updateEdgeRendering(t,l=!0){null!=this._edgeView&&this._edgeView.hasObject(t.objectHandle)&&this._addOrUpdateEdgeRendering(t,l)}_forAllNodes(t){this._nodeId2Meta.forEach(t)}_ignoreClientNodeOverriddenFeatures(t){return this.i3sOverrides.hasGeometryChanges?(l,d,u)=>u.node.index>=0&&this.i3sOverrides.featureHasGeometryChanges(l)?Rs.CONTINUE:t(l,d,u):t}_forAllFeatures(t,l,d){I(this._nodeId2Meta,(u=>{if(null==u)return!1;if(null!=l)switch(l(u)){case Rs.EXIT:return!0;case Rs.SKIP:return!1}let _=Rs.CONTINUE;switch(d){case Ss.ALL:_=this._forAllFeaturesOfNode(u,t);break;case Ss.VISIBLE_ONLY:_=this._forAllVisibleFeaturesOfNode(u,t);break;case Ss.QUERYABLE:_=this._forAllQueryableFeaturesOfNode(u,t)}return _===Rs.EXIT}))}_forAllFeaturesOfNode(t,l){let d=Rs.CONTINUE;const u=t.featureIds;for(let _=0;_<u.length;_++)if(d=l(u[_],_,t),d===Rs.EXIT)return d;return d}_forAllVisibleFeaturesOfNode(t,l){let d=Rs.CONTINUE;const u=t.featureIds;return this._collection.forEachVisibleComponent(t.objectHandle,(_=>(d=l(u[_],_,t),d===Rs.CONTINUE))),d}_forAllQueryableFeaturesOfNode(t,l){const d=this._ignoreClientNodeOverriddenFeatures(l);if(null==this._renderClippingArea)return this._forAllFeaturesOfNode(t,d);const u=this._boundingRectNodeTest(t,this._renderClippingArea);if(u===it.OUTSIDE)return Rs.CONTINUE;if(u===it.INSIDE)return this._forAllFeaturesOfNode(t,d);const _=Rs.CONTINUE,g=t.featureIds,p=t.objectHandle,m=ft(this._renderClippingArea,this._collection.getObjectTransform(p));for(let f=0;f<g.length;f++){if(!this._boundingRectFeatureTest(t,f,m))continue;const l=d(g[f],f,t);if(l===Rs.EXIT)return l}return _}_createAttributes(t,l){var d;const u={};null!=l.featureIds&&(u[this._getObjectIdField()]=l.featureIds[t]);const _=null==(d=l.attributeInfo)?void 0:d.attributeData;if(null!=_)for(const g of Object.keys(_))u[g]=Je(_[g],t);return u}_createGraphic(t,l){return this._createLayerGraphic(this._createAttributes(t,l))}highlight(t){if("number"==typeof t||t instanceof ce?t=[t]:t instanceof yt&&(t=t.toArray()),Array.isArray(t)&&t.length>0){if(t[0]instanceof ce){const l=t,d=this.i3slayer.fieldsIndex,u=this._getObjectIdField(),_=l.map((t=>us(d,t.attributes,u))),{set:g,handle:p}=this._highlights.acquireSet();return this._highlights.setFeatureIds(g,_),p}if("number"==typeof t[0]){const l=t,{set:d,handle:u}=this._highlights.acquireSet();return this._highlights.setFeatureIds(d,l),u}}return B()}resetHighlights(){N(this._highlights),this._highlights=new h2({collection:this._collection,forAllFeatures:t=>this._forAllFeatures(t,null,Ss.ALL),forAllFeaturesOfNode:(t,l)=>this._forAllFeaturesOfNode(t,l)})}_visibleGeometryChanged(t,l){if(!this._elevationProvider)return;const d=this.getNodeComponentObb(t.node);d&&this._elevationProvider.objectChanged(d),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=bt((()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))),this._updateSnappingSources(t,l)}get performanceInfo(){return new e(this.usedMemory,this._nodeId2Meta.size,Math.round(this._gpuMemoryEstimate/1048576),Math.round(this._geoMemoryEstimate/1048576),Math.round(this._texMemoryEstimate/1048576),Math.round(this.unloadedMemory/1048576),this._idbCacheEnabled?Math.round(100*this._idbCache.getHitRate()):0)}get test(){}getNodeOpacityByIndex(t){const l=this._nodeId2Meta.get(t);return this.getNodeOpacity(l)}getNodeOpacity(t){return null!=t?this._collection.getMaterial(t.objectHandle).objectOpacity:0}isNodeFullyFadedIn(t){return this._crossfadeHelper.isNodeFullyFadedIn(t)}getNodeCrossfadeMetaData(t){return this._nodeId2Meta.get(t)}markNodeToRemove(t){this._controller&&this._controller.markNodeToRemove(t)}removeMarkedNodes(){this._controller&&this._controller.removeMarkedNodes()}foreachCrossfadeNode(t){this._nodeId2Meta.forEach(t)}fadeNode(t,l,d){if(!this.nodeCrossfadingEnabled)return;const u=this._nodeId2Meta.get(t);null!=u&&this._crossfadeHelper.fadeNode(t,u,l,d)}setNodeOpacityByIndex(t,l){const d=this._nodeId2Meta.get(t);null!=d&&this._setNodeOpacity(d,l)}_setNodeOpacity(t,l){this._collection.updateMaterial(t.objectHandle,(t=>t.objectOpacity=l)),this._setNodeEdgeOpacity(t,l)}_setNodeEdgeOpacity(t,l){if(null==this._edgeView||!t.cachedEdgeMaterials)return;Kt(t.cachedEdgeMaterials,l);const d=t.objectHandle;this._edgeView.hasObject(d)&&this._edgeView.updateAllComponentOpacities(d,l).catch((t=>Dt(t,this.i3slayer.title)))}get hasModifications(){return this._isIntegratedMesh&&null!=this._layerClippingArea||this._modifications&&this._modifications.length>0}updateNodeModificationStatus(t){const l=t.length;if(!this.hasModifications||l<=0||!0!==this._i3sWasmLoaded)return;const d=this.uid,u=function zt(t){if(0===t.length)return;const l=10*t.length,d=new Float64Array(l);let u=0;return t.forAll((t=>{let l=t.serviceObbInIndexSR;null==l&&(l=$s,l.center=Ye(t.serviceMbsInIndexSR),l.halfSize=[t.serviceMbsInIndexSR[3],t.serviceMbsInIndexSR[3],t.serviceMbsInIndexSR[3]]);const _=l.data;d[u++]=_[0],d[u++]=_[1],d[u++]=_[2],d[u++]=_[3],d[u++]=_[4],d[u++]=_[5],d[u++]=_[6],d[u++]=_[7],d[u++]=_[8],d[u++]=_[9]})),d}(t);if(u){const l={context:d,buffer:u.buffer};ls(l);const _=new Float64Array(u.buffer);t.forAll(((t,l)=>{const d=_[l],u=ds(d);t.imModificationImpact=u,u!==hs.Unmodified&&this._controller.invalidateGeometryVisibility(t.index)}))}}notifyUpdate(){this.notifyChange("updating")}notifyLODUpdate(){this._controller.notifyLODUpdate()}isUpdating(){var t;return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||null!=this._labeler&&this._labeler.updating||(null==(t=this._crossfadeHelper)?void 0:t.updating)||this._i3sWasmLoaded instanceof Promise||this._asyncModuleLoading>0||null!=this._elevationTask&&this._elevationTask.running}trackSnappingSources(t){const l={events:t,fetchEdgeLocations:async(t,l,d)=>{const u=this._nodeId2Meta.get(t);if(null==u)throw new Error("invalid-node");const{origin:_,buffer:g}=await this._collection.extractEdgeInformation(u.objectHandle,l,d);return this._snappingLocationsApplyElevation(u,g,_),{type:"components",objectIds:u.featureIds,locations:g,origin:_}},remove:()=>q(this._snappingSourcesTrackers,l)};return this._snappingSourcesTrackers.push(l),this._nodeId2Meta.forEach(((l,d)=>{if(null==l)return;const u=this._controller.getRenderMbs(l.node);u&&t.add(d,u)})),l}_snappingLocationsApplyElevation(t,l,d){if(!t.elevationOffsets||this.elevationInfo.mode===Ns.Absolute)return;const u=l.position0,_=l.position1,g=l.componentIndex,p=b(),m=b(),l2=(t,l)=>{y(t,t,d),this.view.renderCoordsHelper.worldUpAtPosition(t,m),y(t,t,Ct(m,m,l)),wt(t,t,d)};for(let f=0;f<u.count;f++){const l=t.elevationOffsets[g.get(f)];u.getVec(f,p),l2(p,l),u.setVec(f,p),_.getVec(f,p),l2(p,l),_.setVec(f,p)}}_updateSnappingSources(t,l){const{index:d}=t.node,u=this._controller.getRenderMbs(t.node);if(null!=u)for(const _ of this._snappingSourcesTrackers)l!==ks.REMOVE&&l!==ks.UPDATE||_.events.remove(d),l!==ks.ADD&&l!==ks.UPDATE||_.events.add(d,u)}};return M([C()],_.prototype,"_hasLoadedPBRTextures",void 0),M([C()],_.prototype,"_asyncModuleLoading",void 0),M([C()],_.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),M([C()],_.prototype,"view",void 0),M([C()],_.prototype,"i3slayer",void 0),M([C()],_.prototype,"_controller",void 0),M([C()],_.prototype,"_labeler",void 0),M([C()],_.prototype,"updating",void 0),M([C()],_.prototype,"suspended",void 0),M([C()],_.prototype,"contentVisible",null),M([C({readOnly:!0})],_.prototype,"legendEnabled",null),M([C()],_.prototype,"holeFilling",void 0),M([C(de)],_.prototype,"updatingProgress",void 0),M([C()],_.prototype,"updatingProgressValue",null),M([C()],_.prototype,"hasTexturesOrVertexColors",null),M([C()],_.prototype,"rendererTextureUsage",null),M([C()],_.prototype,"elevationOffset",null),M([C()],_.prototype,"elevationInfo",null),M([C({type:Boolean})],_.prototype,"slicePlaneEnabled",void 0),M([C()],_.prototype,"supportedTextureEncodings",null),M([C()],_.prototype,"uncompressedTextureDownsamplingEnabled",null),M([C({type:[es]})],_.prototype,"_modifications",void 0),M([C({readOnly:!0})],_.prototype,"clientGeometry",null),M([C()],_.prototype,"elevationRange",null),M([C()],_.prototype,"fullExtent",null),M([C()],_.prototype,"_elevationTask",void 0),M([C({readOnly:!0})],_.prototype,"_usePBR",null),_=M([E(Hs)],_),_};function Dt(t,l){Ce(t)||Et().warn("Error while processing edges. Edges on this layer might not display correctly",l,t)}var ks;!function(t){t[t.ADD=0]="ADD",t[t.REMOVE=1]="REMOVE",t[t.UPDATE=2]="UPDATE"}(ks||(ks={}));const Bs=l(),qs=ne(),zs=ne(),$s=new oe,Ws=[0,0,0,0],Ks=new le([0,0,0,0]),Ys=vt(0,0,0,0);function Lt(t){if(null==t)return!1;const l=t.metallicRoughness;return l&&l.baseColorTextureId>=0||l&&l.metallicRoughnessTextureId>=0||t.normalTextureId>=0||t.emissiveTextureId>=0||t.occlusionTextureId>=0}function Bt(t){return null!=t&&It(t.data)}function qt(t,l){let d=1024+t.interleavedVertexData.byteLength+(t.indices?t.indices.byteLength:0)+t.positionData.data.byteLength+t.positionData.indices.byteLength;if(null!=l)for(const u of l)null!=u&&It(u.data)&&(d+=u.data.byteLength);return d}function Wt(t,l){return l.byteSize>Us?(Et().warn(`Node is too big to store in IndexedDB cache: ${t.id} (${l.byteSize} bytes)`),!1):l.byteSize>0}function Kt(t,l){t.forEach((t=>t.opacity=l))}class $t{constructor(t,l){this.mode=t,this.offset=l}}const Qs=b(),Xs=l(),Zs="elevation-change",Js=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],si=new Mt;function ei(t,l,d){let u=t.elevationRangeMin,_=t.elevationRangeMax;const g=d;if(g>0){l.getCorners(Js);for(const t of Js){const l=xt(t)-g;u=Math.min(u,l),_=Math.max(_,l)}}else{l.getCorners(Js);for(const t of Js){const l=t[2];u=Math.min(u,l),_=Math.max(_,l)}}t.expandElevationRangeValues(u,_)}function ti(t,l,d){const u=Ye(l),_=d>0?xt(u)-d:u[2],g=Ot(l);t.expandElevationRangeValues(_-g,_+g)}export{At as A,Ss as n,Rs as o,u$1 as u};
