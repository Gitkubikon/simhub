import{fi as e,gM as t,fq as n,b as i,bZ as r,bJ as a,e as s,y as l,a as d,S as u,n as y,a2 as c,fO as m,fd as f,d8 as g,az as T,nH as w,j as b,iU as v,iF as I,iG as N,g2 as D,iE as M,gp as S,g4 as L,g3 as R,eq as _,nI as k,fP as j,fQ as C,iH as O,nJ as x,I as q,iJ as F,a_ as G,ax as $,bn as Q,nK as J,nL as P,nM as U,nN as B,iK as Y,iL as H,iM as V,g7 as W,jj as K,jk as z,iN as Z,nO as X,iO as ae,iP as se,iQ as le,bj as pe,nP as de,be as ue,Z as ye}from"./index-DSIPxOWi.js";import{m as he}from"./FeatureStore-Dpo5Syxq.js";import{$ as ce}from"./QueryEngine-DAD9skS_.js";import{l as me,o as fe}from"./clientSideDefaults-Cn_svm8L.js";import{T as ge,r as Te}from"./knowledgeGraphService-qQQwd7TJ.js";import{s as we}from"./GraphQueryStreaming-DGarY5EH.js";class o{constructor(){this._featureLookup=new Map}static getInstance(){return o.instance||(o.instance=new o),o.instance}static resetInstance(){o.instance&&(o.instance=null)}deleteFromStore(e){e.forEach((e=>{this._featureLookup.delete(e)}))}readFromStoreByList(e){const t=[];return e.forEach((e=>{const n=this.readFromStoreById(e);n&&t.push(n)})),t}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(i,r,a){const s=[];return i.forEach((i=>{if(!(null==i?void 0:i.id))return;i.properties||(i.properties=[]);let l,d=null;if(a&&i.properties[a]&&(d=e(i.properties[a])),"originId"in i&&"destinationId"in i&&(i.properties.ESRI__ORIGIN_ID=i.originId,i.properties.ESRI__DESTINATION_ID=i.destinationId),i.properties[r]=i.id,i.id&&this._featureLookup.has(i.id)&&this._featureLookup.get(i.id).attributes){const e=this._featureLookup.get(i.id),s=JSON.parse(JSON.stringify(Object.assign(e.attributes,i.properties)));a&&i.properties[a]&&(s[a]=t(i.properties[a])),l=new n(d?JSON.parse(JSON.stringify(d)):(null==e?void 0:e.geometry)?JSON.parse(JSON.stringify(e.geometry)):null,s,null,i.properties[r])}else l=new n(d?JSON.parse(JSON.stringify(d)):null,i.properties,null,i.properties[r]);this._featureLookup.set(i.id,l),s.push(l)})),s}}var be,ve,Ie,Ee,Ne,De,Me,Se,Le;function w$1(e){if(!e.spatialReference.isWGS84)throw new i("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");return e.clone().normalize().map((e=>[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]))}async function h(e,t){var n,i;const r=[],a=new Map,s=[];if(null==(n=t.dataModel)?void 0:n.relationshipTypes)for(const l of t.dataModel.relationshipTypes)l.name&&a.set(l.name,[]);for(const l of e)a.has(l.typeName)&&(null==(i=a.get(l.typeName))||i.push(l.id));for(const[l,d]of a){if(d.length<1)continue;const e=new we({openCypherQuery:`MATCH (n)-[r:${l}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:d}});s.push(ge(t,e).then((async e=>{const t=e.resultRowsStream.getReader();for(;;){const{done:e,value:n}=await t.read();if(e)break;for(const t of n)r.push({id:t[0],typeName:t[1]}),r.push({id:t[2],typeName:t[3]})}})))}return await Promise.all(s),r}async function T$1(e,t){t??(t=!1);const n={generateAllSublayers:t,namedTypeDefinitions:new Map};return await async function I$1(e){const t=await r(e,{responseType:"array-buffer"}),n=await t.data;return async function A(e){const t=new((await Te()).MapOfObjectIdentifierSetsDecoder),n=t.decode(new Uint8Array(e)),r=new Map;if(0!==n.error_code)throw new i("knowledge-graph:layer-support-utils",n.error_message);const a=t.get_map_of_identifier_sets(),s=a.keys,l=s.size();for(let d=0;d<l;d++){const e=s.get(d),t=a.query_identifier_set(e),n=[];if(t.id_array_type.value===Se.GLOBALID_ARRAY){const e=t.get_globalid_array(),i=e.count();for(let t=0;t<i;t++)n.push(e.get_globalid_at(t))}else{if(t.id_array_type.value!==Se.IDENTIFIER_ARRAY)throw new i("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const e=t.get_identifier_array(),i=e.count();for(let t=0;t<i;t++)n.push(e.get_identifier_at(t).toString())}}r.set(e,n)}return t.delete(),r}(new Uint8Array(n))}(e).then((e=>{!function D$1(e,t){for(const[n,i]of e){const e=a(t.namedTypeDefinitions,n,(()=>({useAllData:!1,members:new Map})));for(const t of i)e.members.has(t)||e.members.set(t,{id:t})}return t}(e,n)})),n}async function E(e){const t=await Te(),n=new t.MapOfObjectIdentifierSets;!function M$1(e,t,n){for(const[i,r]of n.namedTypeDefinitions){if(!r.members||r.useAllData)continue;const n=r.members.keys(),a=new t.GlobalIdArray,s=new t.ObjectIdentifierSet;for(const e of n)a.add_globalid(e);s.set_globalid_array(a),a.delete(),e.put_identifier_set(i,s),s.delete()}return e}(n,t,e);const r=new t.MapOfObjectIdentifierSetsEncoder;try{r.set_map_of_identifier_sets(n),r.encode();const e=r.get_encoding_result();if(0!==e.error.error_code)throw new i("knowledge-graph:layer-support-utils",e.error.error_message);const t=structuredClone(e.get_byte_buffer());return r.delete(),t}finally{n.delete()}}(ve=be||(be={})).ELEMENTUID="ELEMENTUID",ve.TYPENAME="TYPENAME",be.ELEMENTUID,be.TYPENAME,function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"}(Ie||(Ie={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(Ee||(Ee={})),(Le=Ne||(Ne={}))[Le.featureResult=0]="featureResult",Le[Le.countResult=1]="countResult",Le[Le.idsResult=2]="idsResult",function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(De||(De={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(Me||(Me={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(Se||(Se={}));const Re="ESRI__ID",_e="ESRI__ORIGIN_ID",ke="ESRI__DESTINATION_ID",je="ESRI__LAYOUT_GEOMETRY",Ce="ESRI__AGGREGATION_COUNT";let Oe=class extends u{constructor(e){var t,n,i;super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const r=new Map;null==(t=e.knowledgeGraph.dataModel.entityTypes)||t.forEach((t=>{var n,i;t.name&&(r.set(t.name,"entity"),this._processingCacheUpdatesLookup.set(t.name,[]),e.inclusionModeDefinition&&!(null==(n=e.inclusionModeDefinition)?void 0:n.generateAllSublayers)||this.entityTypeNames.add(t.name),null==(i=t.properties)||i.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(t.name,{name:e.name??"",geometryType:e.geometryType})})))})),null==(n=e.knowledgeGraph.dataModel.relationshipTypes)||n.forEach((t=>{var n,i;t.name&&(r.set(t.name,"relationship"),this._processingCacheUpdatesLookup.set(t.name,[]),e.inclusionModeDefinition&&!(null==(n=e.inclusionModeDefinition)?void 0:n.generateAllSublayers)||this.relationshipTypeNames.add(t.name),null==(i=t.properties)||i.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(t.name,{name:e.name??"",geometryType:e.geometryType})})))})),null==(i=e.inclusionModeDefinition)||i.namedTypeDefinitions.forEach(((t,n)=>{var i,s;if("entity"===r.get(n))this.entityTypeNames.add(n);else{if("relationship"!==r.get(n))return y.getLogger(this).warn(`A named type, ${n}, was in the inclusion list that wasn't in the data model and will be removed`),void(null==(i=e.inclusionModeDefinition)||i.namedTypeDefinitions.delete(n));this.relationshipTypeNames.add(n)}const l=new Map;null==(s=t.members)||s.forEach((e=>{a(this.memberIdTypeLookup,e.id,(()=>new Set)).add(n);const t=this.getById(e.id);t&&l.set(e.id,t)})),this.sublayerCaches.set(n,l)}))}addToLayer(e){e.forEach((({typeName:e,id:t})=>{if(!this.inclusionModeDefinition)throw new i("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){const n=this.inclusionModeDefinition.namedTypeDefinitions.get(e);n.members||(n.members=new Map),n.members.set(t,{id:t}),a(this.memberIdTypeLookup,t,(()=>new Set)).add(e)}}else{const n=new Map;n.set(t,{id:t}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:n}),a(this.memberIdTypeLookup,t,(()=>new Set)).add(e)}}))}getById(e){return o.getInstance().readFromStoreById(e)}async getData(e,t,n){var i,r;if(t.objectType.name&&(null==(i=this.inclusionModeDefinition)?void 0:i.namedTypeDefinitions)&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let a;if(a=e||new c({where:"1=1",outFields:["*"]}),"link-chart"===t.parentCompositeLayer.type){const e=t.parentCompositeLayer,n=this._processingCacheUpdatesLookup.get(t.objectType.name??""),i=a.outFields;i&&1===i.length&&i[0]===Re&&"1=1"===a.where||await Promise.all(n??[]);const s=this.sublayerCaches.has(t.objectType.name??"")?Array.from(null==(r=this.sublayerCaches.get(t.objectType.name))?void 0:r.values()):[],l=[];return s.forEach((n=>{this.relationshipTypeNames.has(t.objectType.name)?n.geometry=e.relationshipLinkChartDiagramLookup.get(n.attributes[t.objectIdField]):n.geometry=e.entityLinkChartDiagramLookup.get(n.attributes[t.objectIdField]),n.attributes[je]=n.geometry,l.push(n)})),l}return this.retrieveDataFromService(a,t,n)}async getConnectedRecordIds(e,t){const n=[];let i="";const r=[],a=new Map;if(e.forEach((e=>{var t;if(this.memberIdTypeLookup.has(e))for(const n of this.memberIdTypeLookup.get(e)){if(!this.entityTypeNames.has(n))return;a.has(n)?null==(t=a.get(n))||t.push(e):a.set(n,[e])}})),t&&0!==(null==t?void 0:t.length)){for(const e of t)i=i+e+"|";i=i.slice(0,-1)}return a.forEach(((e,a)=>{let s;s=t&&0!==(null==t?void 0:t.length)?`MATCH (n:${a})-[r:${i}]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`:`MATCH (n:${a})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`;const l=new Promise((t=>{(async()=>{const t=(await ge(this.knowledgeGraph,new we({openCypherQuery:s,bindParameters:{ids:e}}))).resultRowsStream.getReader();try{for(;;){const{done:e,value:i}=await t.read();if(e)break;for(let t=0;t<i.length;t++){const e=i[t];n.push({id:e[0],typeName:e[1]}),n.push({id:e[2],typeName:e[3]})}}}catch(i){if("AbortError"!==i.name)throw i;y.getLogger(this).info("Request aborted as expected")}})().then((()=>{t()}))}));r.push(l)})),this.refreshCacheContent(),await Promise.all(r),n}async getAttachedRelationships(e,t){const n=[],i=(await ge(this.knowledgeGraph,new we({openCypherQuery:"MATCH (n)-[r]->(m) WHERE id(n) IN $nodeIds AND id(m) in $nodeIds AND NOT id(r) IN $relationshipExclusionIds return id(r), type(r)",bindParameters:{nodeIds:e,relationshipExclusionIds:t}}))).resultRowsStream.getReader();try{for(;;){const{done:e,value:t}=await i.read();if(e)break;for(let i=0;i<t.length;i++){const e=t[i];n.push({id:e[0],typeName:e[1]})}}}catch(r){if("AbortError"!==r.name)throw r;y.getLogger(this).info("Request aborted as expected")}return n}async refreshCacheContent(e,t,n,r=!0){var s,l,d,u,y,c,m;const f=o.getInstance(),g=[],T=new Map,w=new Map;null==(s=this.knowledgeGraph.dataModel.entityTypes)||s.forEach((e=>{e.name&&w.set(e.name,e)})),null==(l=this.knowledgeGraph.dataModel.relationshipTypes)||l.forEach((e=>{e.name&&w.set(e.name,e)})),e||this.inclusionModeDefinition?e?e.forEach((e=>{var t;if(this.memberIdTypeLookup.has(e))for(const n of this.memberIdTypeLookup.get(e))T.has(n)?null==(t=T.get(n))||t.push(e):T.set(n,[e])})):null==(u=null==(d=this.inclusionModeDefinition)?void 0:d.namedTypeDefinitions)||u.forEach(((e,t)=>{e.useAllData?T.set(t,null):e.members&&e.members.forEach((e=>{var n;T.has(t)&&null!==T.get(t)?null==(n=T.get(t))||n.push(e.id):T.set(t,[e.id])}))})):(null==(y=this.knowledgeGraph.dataModel.entityTypes)||y.forEach((e=>{e.name&&T.set(e.name,null)})),null==(c=this.knowledgeGraph.dataModel.entityTypes)||c.forEach((e=>{e.name&&T.set(e.name,null)})));for(const[b,v]of T){const e=new Promise((e=>{(async()=>{var e,s,l,d,u,y,c;const m=new Set,g=[];let T,I="",N=!1;if(t||(null==(s=null==(e=w.get(b))?void 0:e.properties)||s.forEach((e=>{e.name&&m.add(e.name)}))),n&&this.geographicLookup.has(b)){const e=null==(l=this.geographicLookup.get(b))?void 0:l.name;e&&m.add(e)}if(this.entityTypeNames.has(b))I=`MATCH (n:${b}) ${v?"WHERE id(n) IN $ids ":""}return ID(n)`,m.forEach((e=>{I+=`, n.${e}`,g.push(e)}));else{if(!this.relationshipTypeNames.has(b))throw new i("knowledge-graph:layer-data-manager",`The graph type of ${b} could not be determined. Was this type set in the KG data model and inclusion definition?`);N=!0,I=`MATCH ()-[n:${b}]->() ${v?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,m.forEach((e=>{I+=`, n.${e}`,g.push(e)}))}T=new we(v?{openCypherQuery:I,bindParameters:{ids:v}}:{openCypherQuery:I});const D=(await ge(this.knowledgeGraph,T)).resultRowsStream.getReader();for(;;){const{done:e,value:t}=await D.read();if(e)break;const n=[];for(let r=0;r<t.length;r++){const e=t[r];let i=0,s=0;const l={properties:{}};for(l.id=e[i],i++,s++,N&&(l.originId=e[i],i++,s++,l.destinationId=e[i],i++,s++,a(this.nodeConnectionsLookup,l.originId,(()=>new Set)).add(l.id),a(this.nodeConnectionsLookup,l.destinationId,(()=>new Set)).add(l.id),a(this.relationshipConnectionsLookup,l.id,(()=>[l.originId,l.destinationId])));i<e.length;i++)l.properties[g[i-s]]=e[i];n.push(l)}const i=f.writeToStore(n,Re,null==(d=this.geographicLookup.get(b))?void 0:d.name);this.sublayerCaches.has(b)||this.sublayerCaches.set(b,new Map),r&&!(null==(u=this.inclusionModeDefinition)?void 0:u.namedTypeDefinitions.has(b))&&(null==(y=this.inclusionModeDefinition)||y.namedTypeDefinitions.set(b,{useAllData:!1,members:new Map})),r&&!(null==(c=this.inclusionModeDefinition)?void 0:c.namedTypeDefinitions.get(b).members)&&(this.inclusionModeDefinition.namedTypeDefinitions.get(b).members=new Map);const s=this.sublayerCaches.get(b);i.forEach((e=>{var t,n;null==s||s.set(e.attributes[Re],e),r&&!(null==(t=this.inclusionModeDefinition)?void 0:t.namedTypeDefinitions.get(b).members.has(e.attributes[Re]))&&(null==(n=this.inclusionModeDefinition)||n.namedTypeDefinitions.get(b).members.set(e.attributes[Re],{id:e.attributes[Re]}),a(this.memberIdTypeLookup,e.attributes[Re],(()=>new Set)).add(b))}))}})().then((()=>{e(null)}))}));g.push(e),null==(m=this._processingCacheUpdatesLookup.get(b))||m.push(e)}await Promise.all(g)}removeFromLayer(e){var t,n,i;const r=new Set,a=new Set(e.map((e=>e.id)));for(const s of e)r.add(s.typeName),1===(null==(t=this.memberIdTypeLookup.get(s.id))?void 0:t.size)?this.memberIdTypeLookup.delete(s.id):null==(n=this.memberIdTypeLookup.get(s.id))||n.delete(s.typeName),null==(i=this.inclusionModeDefinition)||i.namedTypeDefinitions.forEach(((e,t)=>{var n;t===s.typeName&&(null==(n=e.members)?void 0:n.has(s.id))&&e.members.delete(s.id)}));r.forEach((e=>{var t;null==(t=this.sublayerCaches.get(e))||t.forEach(((t,n)=>{var i;a.has(n)&&(null==(i=this.sublayerCaches.get(e))||i.delete(n))}))}))}async retrieveDataFromService(e,t,n){var r,a,s,l,d,u,y,c,v,I,N,D,M,S,L,R,_;const k=o.getInstance(),j=new Set,C=[];let O,x="",q=[];const F="relationship"===t.graphType,G=null==(s=null==(a=null==(r=this.inclusionModeDefinition)?void 0:r.namedTypeDefinitions)?void 0:a.get(t.objectType.name))?void 0:s.useAllData,$=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let Q=!G&&$?Array.from($).sort():null;if(null==(u=null==(d=null==(l=this.inclusionModeDefinition)?void 0:l.namedTypeDefinitions)?void 0:d.get(t.objectType.name))?void 0:u.useAllData)(null==(v=null==(c=null==(y=this.inclusionModeDefinition)?void 0:y.namedTypeDefinitions)?void 0:c.get(t.objectType.name))?void 0:v.useAllData)&&null!=e.objectIds&&(Q=e.objectIds);else if(null!=e.objectIds&&Q&&Q.length>0){const t=e.objectIds;e.objectIds=Q.filter((e=>t.includes(e)))}else if(null!=e.objectIds)Q=e.objectIds;else{if((null==(I=this.inclusionModeDefinition)?void 0:I.namedTypeDefinitions.has(t.objectType.name))&&(!(null==(N=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))?void 0:N.members)||(null==(M=null==(D=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))?void 0:D.members)?void 0:M.size)<1))return e.objectIds=[],[];e.objectIds=Q}if(null!=e.outFields){const n=e.outFields;n.includes("*")?t.fields.forEach((e=>{j.add(e.name)})):n.forEach((e=>{e!==Re&&e!==t.geometryFieldName&&j.add(e)}))}if(null!=e.geometry){const n=e.geometry;let r;const a=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,s=null==a?void 0:a.spatialReference,l=null==(S=null==a?void 0:a.serviceCapabilities)?void 0:S.geometryCapabilities;let d=null==l?void 0:l.geometryMaxBoundingRectangleSizeX,u=null==l?void 0:l.geometryMaxBoundingRectangleSizeY;if((null==(L=null==n?void 0:n.extent)?void 0:L.spatialReference)&&!(null==(R=n.spatialReference)?void 0:R.isWGS84)?(await m(n.extent.spatialReference,f),r=g(n.extent,f)):r=n.extent,d&&u&&s){if(4326!==s.wkid){const e=new T({spatialReference:s,xmax:d,ymax:u}),t=g(e,f);d=t.xmax,u=t.ymax}if(r.xmax-r.xmin>d)throw new i("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${d}° latitude, limit exceeded`);if(r.ymax-r.ymin>u)throw new i("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${u}° longitude, limit exceeded`)}if(null!=e.where&&"1=1"!==e.where){const n=await w(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach((e=>{n.fieldNames.includes(e.name)&&j.add(e.name)}))}x=F?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&j.add(t.geometryFieldName),j.forEach((e=>{x+=`, n.${e}`,C.push(e)})),O=new we({openCypherQuery:x,bindParameters:{param_filter_geom:new b({rings:w$1(r)})}})}else{let n="";if(null!=e.where&&"1=1"!==e.where){const i=await w(e.where,t.fieldsIndex);t.fields.forEach((e=>{i.fieldNames.includes(e.name)&&j.add(e.name)}));const r=new Set(["column-reference","string","number","binary-expression"]),a=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let s=!1;const d2=e=>{if("column-reference"===e.type)return`n.${e.column}`;if("string"===e.type)return`'${e.value}'`;if("number"===e.type)return`${e.value}`;if("binary-expression"===e.type&&r.has(e.left.type)&&r.has(e.right.type)&&a.has(e.operator))return`${d2(e.left)} ${e.operator} ${d2(e.right)}`;if("binary-expression"===e.type&&"LIKE"===e.operator){let t="";if("function"===e.left.type&&"column-reference"===e.left.args.value[0].type)t+=`lower(n.${e.left.args.value[0].column})`;else{if("column-reference"!==e.left.type)return s=!0,"";t+=`lower(n.${e.left.column})`}if(t+=" CONTAINS (","string"!==e.right.type)return s=!0,"";{let n=e.right.value;"%"===n.charAt(0)&&(n=n.slice(1)),"%"===n.charAt(n.length-1)&&(n=n.slice(0,-1)),t+=`'${n.toLowerCase()}')`}return t}return s=!0,""};n=d2(i.parseTree),s&&(n="")}let i="";i=F?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let r=!1;Q&&(r=!0,i+=" WHERE ID(n) IN $ids"),n&&(i+=r?" AND":" WHERE",i+=` ${n}`),i+=" return ID(n)",F&&(i+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&j.add(t.geometryFieldName),j.forEach((e=>{i+=`, n.${e}`,C.push(e)})),O=new we(Q?{openCypherQuery:i,bindParameters:{ids:Q}}:{openCypherQuery:i})}const J=(await ge(t.parentCompositeLayer.dataManager.knowledgeGraph,O,n)).resultRowsStream.getReader();for(;;){const{done:e,value:n}=await J.read();if(e)break;const i=[];for(let t=0;t<n.length;t++){const e=n[t];let r=0,a=0;const s={properties:{}};for(s.id=e[r],r++,a++,F&&(s.originId=e[r],r++,a++,s.destinationId=e[r],r++,a++);r<e.length;r++)s.properties[C[r-a]]=e[r];i.push(s)}q=q.concat(k.writeToStore(i,Re,null==(_=t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name))?void 0:_.name))}return q}};s([l()],Oe.prototype,"knowledgeGraph",void 0),s([l()],Oe.prototype,"inclusionModeDefinition",void 0),s([l()],Oe.prototype,"entityTypeNames",void 0),s([l()],Oe.prototype,"relationshipTypeNames",void 0),s([l()],Oe.prototype,"geographicLookup",void 0),s([l()],Oe.prototype,"sublayerCaches",void 0),s([l()],Oe.prototype,"nodeConnectionsLookup",void 0),s([l()],Oe.prototype,"relationshipConnectionsLookup",void 0),s([l()],Oe.prototype,"memberIdTypeLookup",void 0),Oe=s([d("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],Oe);const xe=v(),p=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return s([l(xe.fields)],t.prototype,"fields",void 0),s([l(xe.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=s([d("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],t),t};function ee(e){if(!e.json)return e;e.json.write=te(e.json.write);const t=e.json.origins;if(!t)return e;let n;for(n in t){const e=t[n];e&&(e.write=te(e.write))}return e}function te(e){return"object"==typeof e&&e?(!1!==e.enabled&&(e.overridePolicy=function re(e){const{target:t,writer:n,overridePolicy:i,...r}=e;return function(e,t){const n=ie.call(this,e,t);return n.enabled?{...r,...n}:n}}(e)),e):!0===e?oe():e}function oe(){return{overridePolicy:ie}}function ie(e,t){const n=!!this.geometryType;let i={enabled:n};return n&&(i={...i,...ne.call(this,e,t)}),i}function ne(e,t){return{ignoreOrigin:this.originIdOf(t)>ue.DEFAULTS}}let qe=class extends(p(I(N(D(M(S(L(R(_(ye)))))))))){constructor(e){super(e),this.blendMode="normal",this.capabilities=me(!1,!1),this.charts=null,this.definitionExpression=null,this.displayField="",this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.labelingInfo=null,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=Re,this.objectType=null,this.opacity=1,this.orderBy=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then((()=>{const e=new MessageChannel;return new k(e.port1,{channel:e,client:{queryFeatures:(e,t={})=>{const n=c.fromJSON(e);return this.queryFeaturesJSON(n,t)}}}),[e.port2]}))},this.title=null,this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(e){const t=this._normalizeFeatureReduction(e);this._set("featureReduction",t)}get fields(){var e,t;const n=[];return null==(t=null==(e=this.objectType)?void 0:e.properties)||t.forEach((e=>{const t="esriFieldTypeOID"===e.fieldType?"esriFieldTypeInteger":e.fieldType;n.push(j.fromJSON({name:e.name,type:t,alias:e.alias,defaultValue:e.defaultValue,editable:e.editable,nullable:e.nullable}))})),n.push(j.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),j.fromJSON({name:Ce,type:"esriFieldTypeInteger",alias:Ce,editable:!1})),n}get geometryType(){var e,t,n;if("link-chart"===(null==(e=this.parentCompositeLayer)?void 0:e.type))return"relationship"===this.graphType?"polyline":"point";const i=null==(n=this.parentCompositeLayer)?void 0:n.dataManager.geographicLookup.get(null==(t=this.objectType)?void 0:t.name),r=null==i?void 0:i.geometryType;return r&&"esriGeometryNull"!==r?C.fromJSON(r):null}get geometryFieldName(){var e,t,n;if("link-chart"===(null==(e=this.parentCompositeLayer)?void 0:e.type))return je;const i=null==(n=this.parentCompositeLayer)?void 0:n.dataManager.geographicLookup.get(null==(t=this.objectType)?void 0:t.name);return(null==i?void 0:i.name)??null}get graphTypeName(){var e;return null==(e=this.objectType)?void 0:e.name}get hasM(){var e,t,n,i;const r=null==(t=this.parentCompositeLayer)?void 0:t.dataManager.geographicLookup.get(null==(e=this.objectType)?void 0:e.name),a=null==r?void 0:r.name,s=a?null==(i=null==(n=this.objectType)?void 0:n.properties)?void 0:i[a]:null;return(null==s?void 0:s.hasM)??!1}get hasZ(){var e,t,n,i;const r=null==(t=this.parentCompositeLayer)?void 0:t.dataManager.geographicLookup.get(null==(e=this.objectType)?void 0:e.name),a=null==r?void 0:r.name,s=a?null==(i=null==(n=this.objectType)?void 0:n.properties)?void 0:i[a]:null;return(null==s?void 0:s.hasZ)??!1}set renderer(e){O(e,this.fieldsIndex),this._set("renderer",e)}get renderer(){var e;return this._isOverridden("renderer")?this._get("renderer"):"link-chart"===(null==(e=this.parentCompositeLayer)?void 0:e.type)?"relationship"===this.graphType?x(fe(C.toJSON("polyline")).renderer):x(fe(C.toJSON("point")).renderer):x(fe(C.toJSON(this.geometryType)).renderer)}get spatialReference(){var e,t,n,i;return(null==(i=null==(n=null==(t=null==(e=this.parentCompositeLayer)?void 0:e.dataManager)?void 0:t.knowledgeGraph)?void 0:n.dataModel)?void 0:i.spatialReference)??q.WGS84}writeTitle(e,t){t.title=e??"Layer"}createPopupTemplate(e){return F(this,e)}createQuery(){return new c({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];return null}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e),r=G.fromJSON(await i.executeQuery(n.toJSON(),null==t?void 0:t.signal));return r.features.forEach((e=>{e.sourceLayer=this})),r}async queryFeaturesJSON(e,t){const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e);return await i.executeQuery(n.toJSON(),null==t?void 0:t.signal)}async queryFeatureCount(e,t){const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e);return i.executeQueryForCount(n.toJSON(),null==t?void 0:t.signal)}async queryExtent(e={},t){var n,i,r,a;const s={...e,returnGeometry:!0},{resolvedQuery:l,queryEngine:d}=await this._setupQueryObjects(s),u=await d.executeQueryForExtent(l.toJSON(),null==t?void 0:t.signal);let y;return y=null!=(null==(n=u.extent)?void 0:n.xmin)&&null!=(null==(i=u.extent)?void 0:i.xmax)&&null!=(null==(r=u.extent)?void 0:r.ymin)&&null!=(null==(a=u.extent)?void 0:a.ymax)?new T(u.extent):new T,{count:u.count,extent:y}}async queryObjectIds(e,t){const n=c.from(e);let i;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(n,this,t);i=this.loadQueryEngine(e)}return i.executeQueryForIds(n.toJSON(),null==t?void 0:t.signal)}loadQueryEngine(e){const t=new he({geometryType:C.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),n=new ce({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:C.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return n.featureStore.addMany(e),n}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new c({where:"1=1",outFields:[Re]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){var n;const i=c.from(e),r=i.geometry;let a;if(r&&!(null==(n=r.spatialReference)?void 0:n.isWGS84)&&(await m(r.spatialReference,f),i.geometry=g(r instanceof b||r instanceof $?r:r.extent,f)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)a=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(i,this,t);a=this.loadQueryEngine(e)}return{resolvedQuery:i,queryEngine:a}}};s([l(ee(Q(J)))],qe.prototype,"blendMode",void 0),s([l()],qe.prototype,"capabilities",void 0),s([l({json:{origins:{"web-scene":{write:!1}},write:oe()}})],qe.prototype,"charts",void 0),s([l({readOnly:!0})],qe.prototype,"defaultPopupTemplate",null),s([l({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],qe.prototype,"definitionExpression",void 0),s([l()],qe.prototype,"displayField",void 0),s([l(ee(Q(P)))],qe.prototype,"effect",void 0),s([l()],qe.prototype,"elevationInfo",void 0),s([l(ee(Q(U)))],qe.prototype,"featureEffect",void 0),s([l(ee(Q(B)))],qe.prototype,"featureReduction",null),s([l()],qe.prototype,"fields",null),s([l()],qe.prototype,"geometryType",null),s([l()],qe.prototype,"geometryFieldName",null),s([l({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],qe.prototype,"graphType",void 0),s([l({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],qe.prototype,"graphTypeName",null),s([l()],qe.prototype,"hasM",null),s([l()],qe.prototype,"hasZ",null),s([l({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],qe.prototype,"id",void 0),s([l(ee(Q(Y)))],qe.prototype,"labelsVisible",void 0),s([l({type:[H],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:V,write:oe()}})],qe.prototype,"labelingInfo",void 0),s([l({readOnly:!0,json:{read:!1,write:{writer(e,t){t.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],qe.prototype,"layerType",void 0),s([l(ee(Q(W)))],qe.prototype,"legendEnabled",void 0),s([l(ee(Q(K)))],qe.prototype,"maxScale",void 0),s([l(ee(Q(z)))],qe.prototype,"minScale",void 0),s([l()],qe.prototype,"objectIdField",void 0),s([l()],qe.prototype,"objectType",void 0),s([l(ee(Q(Z)))],qe.prototype,"opacity",void 0),s([l(ee(Q(X)))],qe.prototype,"orderBy",void 0),s([l()],qe.prototype,"parentCompositeLayer",void 0),s([l(ee(Q(ae)))],qe.prototype,"popupEnabled",void 0),s([l({type:se,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],qe.prototype,"popupTemplate",void 0),s([l({type:Number,json:{write:{overridePolicy:ne}}})],qe.prototype,"refreshInterval",void 0),s([l({types:le,json:{name:"layerDefinition.drawingInfo.renderer",write:oe()}})],qe.prototype,"renderer",null),s([l()],qe.prototype,"source",void 0),s([l()],qe.prototype,"spatialReference",null),s([l({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],qe.prototype,"title",void 0),s([pe("title")],qe.prototype,"writeTitle",null),s([l({json:{read:!1}})],qe.prototype,"type",void 0),s([l(ee(Q(de)))],qe.prototype,"useViewTime",void 0),s([l({type:Boolean,json:{name:"visibility",write:oe()}})],qe.prototype,"visible",void 0),qe=s([d("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],qe);const Ae=qe;export{je as D,E,Ce as I,Oe as M,T$1 as T,Ae as a,_e as b,ke as c,h,Re as w};
