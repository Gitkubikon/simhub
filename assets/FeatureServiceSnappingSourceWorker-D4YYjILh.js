import{e,y as s,a as i,S as n,cG as a,x as o,mJ as l,hH as h,hh as d,nn as c,no as p,np as _,h as f,bY as g,i as y,p as m,gG as v,a2 as I,az as O,er as A,n as R,a0 as H,nq as P,nr as D,ns as N,ef as U,aG as M,nt as z,cF as B,gE as q,nu as k,nv as J,nw as G,hY as L,bc as V,eX as Q,b3 as W,I as Z,ji as K,g as X,ae as Y,gM as $}from"./index-DSIPxOWi.js";import{m as ee}from"./FeatureStore-Dpo5Syxq.js";import{$ as te}from"./QueryEngine-DAD9skS_.js";import{i as se,r as ie,n as re}from"./symbologySnappingCandidates-Cl8kN1ha.js";import{a as ne}from"./pbfQueryUtils-DUjEbwA9.js";import{x as ae,f as oe,c as le,S as ue}from"./query-C2USZ63O.js";import{o as he}from"./BoundsStore-BQ0MOdb7.js";import"./optimizedFeatureQueryEngineAdapter--U1rvwBV.js";import"./normalizeUtils-BrH-PrZy.js";import"./normalizeUtilsCommon-BU8xfl77.js";import"./WhereClause-DYd7Xwn9.js";import"./TimeOnly-C5lZbbIX.js";import"./json-omtrO2vq.js";import"./QueryEngineCapabilities-CTDe3LlQ.js";import"./utils-B-uQJqPz.js";import"./utils-DEUXBrCj.js";import"./utils-1_4Re7um.js";import"./ClassBreaksDefinition-Dt1HCCB7.js";import"./pbf-B53Txr8m.js";import"./PooledRBush-DOZnXWx2.js";import"./quickselect-D9ta8ndX.js";let de=class r extends n{constructor(){super(...arguments),this.updating=!1,this._pending=[]}push(e,s){this._pending.push({promise:e,callback:s}),1===this._pending.length&&this._process()}_process(){if(!this._pending.length)return void(this.updating=!1);this.updating=!0;const e=this._pending[0];e.promise.then((s=>e.callback(s))).catch((()=>{})).then((()=>{this._pending.shift(),this._process()}))}};e([s()],de.prototype,"updating",void 0),de=e([i("esri.core.AsyncSequence")],de);class r2{constructor(e,s){this.data=e,this.resolution=s,this.state={type:ce.CREATED},this.alive=!0}process(e){switch(this.state.type){case ce.CREATED:return this.state=this._gotoFetchCount(this.state,e),this.state.task.promise.then(e.resume,e.resume);case ce.FETCH_COUNT:break;case ce.FETCHED_COUNT:return this.state=this._gotoFetchFeatures(this.state,e),this.state.task.promise.then(e.resume,e.resume);case ce.FETCH_FEATURES:break;case ce.FETCHED_FEATURES:this.state=this._goToDone(this.state,e);case ce.DONE:}return null}get debugInfo(){return{data:this.data,featureCount:this._featureCount,state:this._stateToString}}get _featureCount(){switch(this.state.type){case ce.CREATED:case ce.FETCH_COUNT:return 0;case ce.FETCHED_COUNT:return this.state.featureCount;case ce.FETCH_FEATURES:return this.state.previous.featureCount;case ce.FETCHED_FEATURES:return this.state.features.length;case ce.DONE:return this.state.previous.features.length}}get _stateToString(){switch(this.state.type){case ce.CREATED:return"created";case ce.FETCH_COUNT:return"fetch-count";case ce.FETCHED_COUNT:return"fetched-count";case ce.FETCH_FEATURES:return"fetch-features";case ce.FETCHED_FEATURES:return"fetched-features";case ce.DONE:return"done"}}_gotoFetchCount(e,s){return{type:ce.FETCH_COUNT,previous:e,task:o((async e=>{const i=await l(s.fetchCount(this,e));this.state.type===ce.FETCH_COUNT&&(this.state=function u(e,s){return{type:ce.FETCHED_COUNT,featureCount:s,previous:e}}(this.state,i.ok?i.value:1/0))}))}}_gotoFetchFeatures(e,s){return{type:ce.FETCH_FEATURES,previous:e,task:o((async i=>{const n=await l(s.fetchFeatures(this,e.featureCount,i));this.state.type===ce.FETCH_FEATURES&&(this.state=function T$1(e,s){return{type:ce.FETCHED_FEATURES,previous:e,features:s}}(this.state,n.ok?n.value:[]))}))}}_goToDone(e,s){return s.finish(this,e.features),{type:ce.DONE,previous:e}}reset(){const e=this.state;switch(this.state={type:ce.CREATED},e.type){case ce.CREATED:case ce.FETCHED_COUNT:case ce.FETCHED_FEATURES:case ce.DONE:break;case ce.FETCH_COUNT:case ce.FETCH_FEATURES:e.task.abort()}}intersects(e){return null==e||!this.data.extent||(h(e,_e),d(this.data.extent,_e))}}var ce,pe;(pe=ce||(ce={}))[pe.CREATED=0]="CREATED",pe[pe.FETCH_COUNT=1]="FETCH_COUNT",pe[pe.FETCHED_COUNT=2]="FETCHED_COUNT",pe[pe.FETCH_FEATURES=3]="FETCH_FEATURES",pe[pe.FETCHED_FEATURES=4]="FETCHED_FEATURES",pe[pe.DONE=5]="DONE";const _e=a();let fe=class x extends n{get _minimumVerticesPerFeature(){var e;switch(null==(e=this.store)?void 0:e.featureStore.geometryType){case"esriGeometryPoint":case"esriGeometryMultipoint":return 1;case"esriGeometryPolygon":return 4;case"esriGeometryPolyline":return 2}}get _mandatoryOutFields(){const e=new Set;return this.objectIdField&&e.add(this.objectIdField),this.globalIdField&&e.add(this.globalIdField),e}set outFields(e){const s=this._get("outFields"),i=c(e,this._mandatoryOutFields);p(i,s)||(this._set("outFields",i),_(i,s)||this.refresh())}get outFields(){return this._get("outFields")??this._mandatoryOutFields}set filter(e){const s=this._get("filter"),i=this._filterProperties(e);JSON.stringify(s)!==JSON.stringify(i)&&this._set("filter",i)}set customParameters(e){const s=this._get("customParameters");JSON.stringify(s)!==JSON.stringify(e)&&this._set("customParameters",e)}get _configuration(){return{filter:this.filter,customParameters:this.customParameters,tileInfo:this.tileInfo,tileSize:this.tileSize}}set tileInfo(e){const s=this._get("tileInfo");s!==e&&(null!=e&&null!=s&&JSON.stringify(e)===JSON.stringify(s)||(this._set("tileInfo",e),this.store.tileInfo=e))}set tileSize(e){this._get("tileSize")!==e&&this._set("tileSize",e)}get updating(){return this.updatingExcludingEdits||this._pendingEdits.updating}get updatingExcludingEdits(){return this._updatingHandles.updating}get hasZ(){return this.store.featureStore.hasZ}constructor(e){super(e),this.suspended=!0,this.tilesOfInterest=[],this.availability=0,this._pendingTiles=new Map,this._updatingHandles=new f,this._pendingEdits=new de,this._pendingEditsAbortController=new AbortController}initialize(){this._initializeFetchExtent(),this._updatingHandles.add((()=>this._configuration),(()=>this.refresh())),this._updatingHandles.add((()=>this.tilesOfInterest),((e,s)=>{g(e,s,(({id:e},{id:s})=>e===s))||this._process()}),y),this.addHandles(m((()=>!this.suspended),(()=>this._process())))}destroy(){this._pendingTiles.forEach((e=>this._deletePendingTile(e))),this._pendingTiles.clear(),this.store.destroy(),this.tilesOfInterest.length=0,this._pendingEditsAbortController.abort(),this._pendingEditsAbortController=null,this._updatingHandles.destroy()}refresh(){this.store.refresh(),this._pendingTiles.forEach((e=>this._deletePendingTile(e))),this._process()}applyEdits(e){this._pendingEdits.push(e,(async e=>{if(0===e.addedFeatures.length&&0===e.updatedFeatures.length&&0===e.deletedFeatures.length)return;for(const[,i]of this._pendingTiles)i.reset();const s={...e,deletedFeatures:e.deletedFeatures.map((({objectId:e,globalId:s})=>e&&-1!==e?e:this._lookupObjectIdByGlobalId(s)))};await this._updatingHandles.addPromise(this.store.processEdits(s,((e,s)=>this._queryFeaturesById(e,s)),this._pendingEditsAbortController.signal)),this._processPendingTiles()}))}_initializeFetchExtent(){if(!this.capabilities.query.supportsExtent||!v(this.url))return;const e=o((async e=>{var s;try{const i=await ae(this.url,new I({where:"1=1",outSpatialReference:this.spatialReference,cacheHint:this.capabilities.query.supportsCacheHint??void 0}),{query:this._configuration.customParameters,signal:e});this.store.extent=O.fromJSON(null==(s=i.data)?void 0:s.extent)}catch(pe){A(pe),R.getLogger(this).warn("Failed to fetch data extent",pe)}}));this._updatingHandles.addPromise(e.promise.then((()=>this._process()))),this.addHandles(H((()=>e.abort())))}get debugInfo(){return{numberOfFeatures:this.store.featureStore.numFeatures,tilesOfInterest:this.tilesOfInterest,pendingTiles:Array.from(this._pendingTiles.values()).map((e=>e.debugInfo)),storedTiles:this.store.debugInfo}}_process(){this._markTilesNotAlive(),this._createPendingTiles(),this._deletePendingTiles(),this._processPendingTiles()}_markTilesNotAlive(){for(const[,e]of this._pendingTiles)e.alive=!1}_createPendingTiles(){if(this.suspended)return;const e=this._collectMissingTilesInfo();if(this._setAvailability(null==e?1:e.coveredArea/e.fullArea),null!=e)for(const{data:s,resolution:i}of e.missingTiles){const e=this._pendingTiles.get(s.id);e?(e.resolution=i,e.alive=!0):this._createPendingTile(s,i)}}_collectMissingTilesInfo(){let e=null;for(let s=this.tilesOfInterest.length-1;s>=0;s--){const i=this.tilesOfInterest[s],n=this.store.process(i,((e,s)=>this._verifyTileComplexity(e,s)),this.outFields);null==e?e=n:e.prepend(n)}return e}_deletePendingTiles(){for(const[,e]of this._pendingTiles)e.alive||this._deletePendingTile(e)}_processPendingTiles(){const e={fetchCount:(e,s)=>this._fetchCount(e,s),fetchFeatures:(e,s,i)=>this._fetchFeatures(e,s,i),finish:(e,s)=>this._finishPendingTile(e,s),resume:()=>this._processPendingTiles()};if(this._ensureFetchAllCounts(e))for(const[,s]of this._pendingTiles)this._verifyTileComplexity(this.store.getFeatureCount(s.data),s.resolution)&&this._updatingHandles.addPromise(s.process(e))}_verifyTileComplexity(e,s){return this._verifyVertexComplexity(e)&&this._verifyFeatureDensity(e,s)}_verifyVertexComplexity(e){return e*this._minimumVerticesPerFeature<me}_verifyFeatureDensity(e,s){if(null==this.tileInfo)return!1;const i=this.tileSize*s;return e*(Fe/(i*i))<Ee}_ensureFetchAllCounts(e){let s=!0;for(const[,i]of this._pendingTiles)i.state.type<ce.FETCHED_COUNT&&this._updatingHandles.addPromise(i.process(e)),i.state.type<=ce.FETCH_COUNT&&(s=!1);return s}_finishPendingTile(e,s){this.store.add(e.data,s),this._deletePendingTile(e),this._updateAvailability()}_updateAvailability(){const e=this._collectMissingTilesInfo();this._setAvailability(null==e?1:e.coveredArea/e.fullArea)}_setAvailability(e){this._set("availability",e)}_createPendingTile(e,s){const i=new r2(e,s);return this._pendingTiles.set(e.id,i),i}_deletePendingTile(e){e.reset(),this._pendingTiles.delete(e.data.id)}async _fetchCount(e,s){return this.store.fetchCount(e.data,this.url,this._createCountQuery(e),{query:this.customParameters,timeout:ye,signal:s})}async _fetchFeatures(e,s,i){let n=0;const a=[];let o=0,l=s;for(;;){const h=this._createFeaturesQuery(e),d=this._setPagingParameters(h,n,l),{features:c,exceededTransferLimit:p}=await this._queryFeatures(h,i);d&&(n+=h.num),o+=c.length;for(const e of c)a.push(e);if(l=s-o,!d||!p||l<=0)return a}}_filterProperties(e){return null==e?{where:"1=1",gdbVersion:void 0,timeExtent:void 0}:{where:e.where||"1=1",timeExtent:e.timeExtent,gdbVersion:e.gdbVersion}}_lookupObjectIdByGlobalId(e){const s=this.globalIdField,i=this.objectIdField;if(null==s)throw new Error("Expected globalIdField to be defined");let n=null;if(this.store.featureStore.forEach((a=>{e===a.attributes[s]&&(n=a.objectId??a.attributes[i])})),null==n)throw new Error(`Expected to find a feature with globalId ${e}`);return n}_queryFeaturesById(e,s){const i=this._createFeaturesQuery();return i.objectIds=e,this._queryFeatures(i,s)}_queryFeatures(e,s){return this.capabilities.query.supportsFormatPBF?this._queryFeaturesPBF(e,s):this._queryFeaturesJSON(e,s)}async _queryFeaturesPBF(e,s){const{sourceSpatialReference:i}=this,{data:n}=await oe(this.url,e,new ne({sourceSpatialReference:i}),{query:this._configuration.customParameters,timeout:ye,signal:s});return P(n)}async _queryFeaturesJSON(e,s){const{sourceSpatialReference:i}=this,{data:n}=await le(this.url,e,i,{query:this._configuration.customParameters,timeout:ye,signal:s});return D(n,this.objectIdField)}_createCountQuery(e){const s=this._createBaseQuery(e);return this.capabilities.query.supportsCacheHint&&(s.cacheHint=!0),s}_createFeaturesQuery(e=null){var s;const i=this._createBaseQuery(e),n=null!=(null==e?void 0:e.data)?this.store.getAttributesForTile(null==(s=null==e?void 0:e.data)?void 0:s.id):null,a=c(N(this.outFields,n??new Set),this._mandatoryOutFields);return i.outFields=Array.from(a),i.returnGeometry=!0,null!=e&&(this.capabilities.query.supportsResultType?i.resultType="tile":this.capabilities.query.supportsCacheHint&&(i.cacheHint=!0)),i}_createBaseQuery(e){const s=new I({returnZ:this.hasZ,returnM:!1,geometry:null!=this.tileInfo&&null!=e?U(e.data.extent,this.tileInfo.spatialReference):void 0}),i=this._configuration.filter;return null!=i&&(s.where=i.where,s.gdbVersion=i.gdbVersion,s.timeExtent=i.timeExtent),s.outSpatialReference=this.spatialReference,s}_setPagingParameters(e,s,i){if(!this.capabilities.query.supportsPagination)return!1;const{supportsMaxRecordCountFactor:n,supportsCacheHint:a,tileMaxRecordCount:o,maxRecordCount:l,supportsResultType:h}=this.capabilities.query,d=n?I.MAX_MAX_RECORD_COUNT_FACTOR:1,c=d*((h||a)&&o?o:l||ge);return e.start=s,n?(e.maxRecordCountFactor=Math.min(d,Math.ceil(i/c)),e.num=Math.min(i,e.maxRecordCountFactor*c)):e.num=Math.min(i,c),!0}};e([s({constructOnly:!0})],fe.prototype,"url",void 0),e([s({constructOnly:!0})],fe.prototype,"objectIdField",void 0),e([s({constructOnly:!0})],fe.prototype,"globalIdField",void 0),e([s({constructOnly:!0})],fe.prototype,"capabilities",void 0),e([s({constructOnly:!0})],fe.prototype,"sourceSpatialReference",void 0),e([s({constructOnly:!0})],fe.prototype,"spatialReference",void 0),e([s({constructOnly:!0})],fe.prototype,"store",void 0),e([s({readOnly:!0})],fe.prototype,"_minimumVerticesPerFeature",null),e([s()],fe.prototype,"_mandatoryOutFields",null),e([s()],fe.prototype,"outFields",null),e([s()],fe.prototype,"suspended",void 0),e([s()],fe.prototype,"filter",null),e([s()],fe.prototype,"customParameters",null),e([s({readOnly:!0})],fe.prototype,"_configuration",null),e([s()],fe.prototype,"tileInfo",null),e([s()],fe.prototype,"tileSize",null),e([s()],fe.prototype,"tilesOfInterest",void 0),e([s({readOnly:!0})],fe.prototype,"updating",null),e([s({readOnly:!0})],fe.prototype,"updatingExcludingEdits",null),e([s({readOnly:!0})],fe.prototype,"availability",void 0),e([s()],fe.prototype,"hasZ",null),fe=e([i("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher")],fe);const ge=2e3,ye=6e5,me=1e6,Fe=25,Ee=1;class t{constructor(){this._store=new Map,this._byteSize=0}set(e,s){this.delete(e),this._store.set(e,s),this._byteSize+=s.byteSize}delete(e){const s=this._store.get(e);return!!this._store.delete(e)&&(null!=s&&(this._byteSize-=s.byteSize),!0)}get(e){return this._used(e),this._store.get(e)}has(e){return this._used(e),this._store.has(e)}clear(){this._store.clear()}applyByteSizeLimit(e,s){for(const[i,n]of this._store){if(this._byteSize<=e)break;this.delete(i),s(n)}}values(){return this._store.values()}[Symbol.iterator](){return this._store[Symbol.iterator]()}_used(e){const s=this._store.get(e);s&&(this._store.delete(e),this._store.set(e,s))}}let Te=class extends n{constructor(e){super(e),this.tileInfo=null,this.extent=null,this.maximumByteSize=10*M.MEGABYTES,this._tileBounds=new he,this._tiles=new t,this._refCounts=new Map,this._tileFeatureCounts=new Map,this._tmpBoundingRect=a()}add(e,s){var i;for(const o of s)this._referenceFeature(o.objectId);const n=this.featureStore.upsertMany(s),a=n.map((e=>new Set(Object.keys(e.attributes)))).reduce(((e,s)=>z(e,s)),new Set(Object.keys((null==(i=n[0])?void 0:i.attributes)??[])));this._addTileStorage(e,new Set(n.map((e=>e.objectId))),function S(e){return e.reduce(((e,s)=>e+function E(e){return 32+function T(e){if(null==e)return 0;const s=J(e.lengths,4);return 32+J(e.coords,8)+s}(e.geometry)+k(e.attributes)}(s)),0)}(n),a),this._tiles.applyByteSizeLimit(this.maximumByteSize,(e=>this._removeTileStorage(e)))}getAttributesForTile(e){var s;return e?null==(s=this._tiles.get(e))?void 0:s.attributeKeys:null}destroy(){this.clear(),this._tileFeatureCounts.clear()}clear(){this.featureStore.clear(),this._tileBounds.clear(),this._tiles.clear(),this._refCounts.clear()}refresh(){this.clear(),this._tileFeatureCounts.clear()}processEdits(e,s,i){return this._processEditsDelete(e.deletedFeatures.concat(e.updatedFeatures)),this._processEditsRefetch(e.addedFeatures.concat(e.updatedFeatures),s,i)}_addTileStorage(e,s,i,n){const a=e.id;this._tiles.set(a,new Ce(e,s,i,n)),this._tileBounds.set(a,e.extent),this._tileFeatureCounts.set(a,s.size)}_remove({id:e}){const s=this._tiles.get(e);s&&this._removeTileStorage(s)}_removeTileStorage(e){const s=[];for(const n of e.objectIds)this._unreferenceFeature(n)===Ie.REMOVED&&s.push(n);this.featureStore.removeManyById(s);const i=e.data.id;this._tiles.delete(i),this._tileBounds.delete(i)}_processEditsDelete(e){this.featureStore.removeManyById(e);for(const[,s]of this._tiles){for(const i of e)s.objectIds.delete(i);this._tileFeatureCounts.set(s.data.id,s.objectIds.size)}for(const s of e)this._refCounts.delete(s)}async _processEditsRefetch(e,s,i){const n=(await s(e,i)).features,{hasZ:a,hasM:o}=this.featureStore;for(const l of n){const e=B(this._tmpBoundingRect,l.geometry,a,o);null!=e&&this._tileBounds.forEachInBounds(e,(e=>{const s=this._tiles.get(e);this.featureStore.add(l);const i=l.objectId;s.objectIds.has(i)||(s.objectIds.add(i),this._referenceFeature(i),this._tileFeatureCounts.set(s.data.id,s.objectIds.size))}))}}process(e,s=()=>!0,i){if(null==this.tileInfo||!e.extent||null!=this.extent&&!d(h(this.extent,this._tmpBoundingRect),e.extent))return new ve(e);const n=this.getAttributesForTile(e.id);if(_(i,n))return new ve(e);const a=this._createTileTree(e,this.tileInfo);return this._simplify(a,s,null,0,1),this._collectMissingTiles(e,a,this.tileInfo,i)}get debugInfo(){return Array.from(this._tiles.values()).map((({data:e})=>({data:e,featureCount:this._tileFeatureCounts.get(e.id)||0})))}getFeatureCount(e){return this._tileFeatureCounts.get(e.id)??0}async fetchCount(e,s,i,n){const a=this._tileFeatureCounts.get(e.id);if(null!=a)return a;const o=await ue(s,i,n);return this._tileFeatureCounts.set(e.id,o.data.count),o.data.count}_createTileTree(e,s){const i=new F(e.level,e.row,e.col);return s.updateTileInfo(i,q.ExtrapolateOptions.POWER_OF_TWO),this._tileBounds.forEachInBounds(e.extent,(n=>{var a;const o=null==(a=this._tiles.get(n))?void 0:a.data;o&&function C(e,s){if(!e||!s)return!1;if(e.level===s.level)return e.row===s.row&&e.col===s.col;const i=e.level<s.level,n=i?e:s,a=i?s:e,o=1<<a.level-n.level;return Math.floor(a.row/o)===n.row&&Math.floor(a.col/o)===n.col}(e,o)&&this._populateChildren(i,o,s,this._tileFeatureCounts.get(o.id)||0)})),i}_populateChildren(e,s,i,n){const a=s.level-e.level-1;if(a<0)return void(e.isLeaf=!0);const o=s.row>>a,l=s.col>>a,h=e.row<<1,d=l-(e.col<<1)+(o-h<<1),c=e.children[d];if(null!=c)this._populateChildren(c,s,i,n);else{const a=new F(e.level+1,o,l);i.updateTileInfo(a,q.ExtrapolateOptions.POWER_OF_TWO),e.children[d]=a,this._populateChildren(a,s,i,n)}}_simplify(e,s,i,n,a){const o=a*a;if(e.isLeaf)return s(this.getFeatureCount(e),a)?0:(this._remove(e),null!=i&&(i.children[n]=null),o);const l=a/2,h=l*l;let d=0;for(let c=0;c<e.children.length;c++){const i=e.children[c];d+=null!=i?this._simplify(i,s,e,c,l):h}return 0===d?this._mergeChildren(e):1-d/o<be&&(this._purge(e),null!=i&&(i.children[n]=null),d=o),d}_mergeChildren(e){const s=new Set;let i,n=0;this._forEachLeaf(e,(e=>{const a=this._tiles.get(e.id);if(a){i=i?z(i,a.attributeKeys):new Set(a.attributeKeys),n+=a.byteSize;for(const e of a.objectIds)s.has(e)||(s.add(e),this._referenceFeature(e));this._remove(e)}})),this._addTileStorage(e,s,n,i??new Set),e.isLeaf=!0,e.children[0]=e.children[1]=e.children[2]=e.children[3]=null,this._tileFeatureCounts.set(e.id,s.size)}_forEachLeaf(e,s){for(const i of e.children)null!=i&&(i.isLeaf?s(i):this._forEachLeaf(i,s))}_purge(e){if(null!=e)if(e.isLeaf)this._remove(e);else for(let s=0;s<e.children.length;s++){const i=e.children[s];this._purge(i),e.children[s]=null}}_collectMissingTiles(e,s,i,n){const a=new Se(i,e,this.extent);return this._collectMissingTilesRecurse(s,a,1,n),a.info}_collectMissingTilesRecurse(e,s,i,n){const a=this.getAttributesForTile(e.id),o=a&&!_(n,a);if(o&&s.addMissing(e.level,e.row,e.col,i),e.isLeaf)return;if(!e.hasChildren)return void(o||s.addMissing(e.level,e.row,e.col,i));const l=i/2;for(let h=0;h<e.children.length;h++){const i=e.children[h];null==i?s.addMissing(e.level+1,(e.row<<1)+((2&h)>>1),(e.col<<1)+(1&h),l):this._collectMissingTilesRecurse(i,s,l,n)}}_referenceFeature(e){const s=(this._refCounts.get(e)||0)+1;return this._refCounts.set(e,s),1===s?Ie.ADDED:Ie.UNCHANGED}_unreferenceFeature(e){const s=(this._refCounts.get(e)||0)-1;return 0===s?(this._refCounts.delete(e),Ie.REMOVED):(s>0&&this._refCounts.set(e,s),Ie.UNCHANGED)}get test(){}};e([s({constructOnly:!0})],Te.prototype,"featureStore",void 0),e([s()],Te.prototype,"tileInfo",void 0),e([s()],Te.prototype,"extent",void 0),e([s()],Te.prototype,"maximumByteSize",void 0),Te=e([i("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTileStore")],Te);let Ce=class w{constructor(e,s,i,n){this.data=e,this.objectIds=s,this.byteSize=i,this.attributeKeys=n}};class F{constructor(e,s,i){this.level=e,this.row=s,this.col=i,this.isLeaf=!1,this.extent=null,this.children=[null,null,null,null]}get hasChildren(){return!this.isLeaf&&(null!=this.children[0]||null!=this.children[1]||null!=this.children[2]||null!=this.children[3])}}let ve=class j{constructor(e,s=[]){this.missingTiles=s,this.fullArea=0,this.coveredArea=0,this.fullArea=G(e.extent),this.coveredArea=this.fullArea}prepend(e){this.missingTiles=e.missingTiles.concat(this.missingTiles),this.coveredArea+=e.coveredArea,this.fullArea+=e.fullArea}},Se=class b{constructor(e,s,i){this._tileInfo=e,this._extent=null,this.info=new ve(s),null!=i&&(this._extent=h(i))}addMissing(e,s,i,n){const a=new L(null,e,s,i);this._tileInfo.updateTileInfo(a,q.ExtrapolateOptions.POWER_OF_TWO),null==a.extent||null!=this._extent&&!d(this._extent,a.extent)||(this.info.missingTiles.push({data:a,resolution:n}),this.info.coveredArea-=G(a.extent))}};const be=.18751;var Ie,we;(we=Ie||(Ie={}))[we.ADDED=0]="ADDED",we[we.REMOVED=1]="REMOVED",we[we.UNCHANGED=2]="UNCHANGED";let Oe=class extends V.EventedAccessor{constructor(){super(...arguments),this._isInitializing=!0,this.remoteClient=null,this._whenSetup=Q(),this._elevationAligner=se(),this._elevationFilter=ie(),this._symbologyCandidatesFetcher=re(),this._updatingHandles=new f,this._editsUpdatingHandles=new f,this._pendingApplyEdits=new Map,this._alignPointsInFeatures=async(e,s)=>{const i={query:e},n=await this.remoteClient.invoke("alignElevation",i,{signal:s});return W(s),n},this._getSymbologyCandidates=async(e,s)=>{const i={candidates:e,spatialReference:this._spatialReference.toJSON()},n=await this.remoteClient.invoke("getSymbologyCandidates",i,{signal:s});return W(s),n}}get updating(){return this.updatingExcludingEdits||this._editsUpdatingHandles.updating||this._featureFetcher.updating}get updatingExcludingEdits(){return this._featureFetcher.updatingExcludingEdits||this._isInitializing||this._updatingHandles.updating}destroy(){var e,s,i;null==(e=this._featureFetcher)||e.destroy(),null==(s=this._queryEngine)||s.destroy(),null==(i=this._featureStore)||i.clear()}async setup(e){if(this.destroyed)return{result:{}};const{geometryType:s,objectIdField:i,timeInfo:n,fieldsIndex:a}=e.serviceInfo,{hasZ:o}=e,l=Z.fromJSON(e.spatialReference);this._spatialReference=l,this._featureStore=new ee({...e.serviceInfo,hasZ:o,hasM:!1}),this._queryEngine=new te({spatialReference:e.spatialReference,featureStore:this._featureStore,geometryType:s,fieldsIndex:a,hasZ:o,hasM:!1,objectIdField:i,timeInfo:n}),this._featureFetcher=new fe({store:new Te({featureStore:this._featureStore}),url:e.serviceInfo.url,objectIdField:e.serviceInfo.objectIdField,globalIdField:e.serviceInfo.globalIdField,capabilities:e.serviceInfo.capabilities,spatialReference:l,sourceSpatialReference:Z.fromJSON(e.serviceInfo.spatialReference),customParameters:e.configuration.customParameters});const h="3d"===e.configuration.viewType;return this._elevationAligner=se(h,{elevationInfo:null!=e.elevationInfo?K.fromJSON(e.elevationInfo):null,alignPointsInFeatures:this._alignPointsInFeatures}),this._elevationFilter=ie(h),this.addHandles([X((()=>this._featureFetcher.availability),(e=>this.emit("notify-availability",{availability:e})),y),X((()=>this.updating),(()=>this._notifyUpdating()))]),this._whenSetup.resolve(),this._isInitializing=!1,this.configure(e.configuration)}async configure(e){return await this._updatingHandles.addPromise(this._whenSetup.promise),this._updateFeatureFetcherConfiguration(e),xe}async setSuspended(e,s){return await this._updatingHandles.addPromise(this._whenSetup.promise),W(s),this._featureFetcher.suspended=e,xe}async updateOutFields(e,s){return await this._updatingHandles.addPromise(this._whenSetup.promise),W(s),this._featureFetcher.outFields=new Set(e??[]),xe}async fetchCandidates(e,s){await this._whenSetup.promise,W(s);const i=function b2(e){if(!e.filter)return{...e,query:{where:"1=1"}};const{distance:s,units:i,spatialRel:n,where:a,timeExtent:o,objectIds:l}=e.filter,h={geometry:e.filter.geometry?$(e.filter.geometry):void 0,distance:s,units:i,spatialRel:n,timeExtent:o,objectIds:l,where:a??"1=1"};return{...e,query:h}}(e),n=null==s?void 0:s.signal,a=await this._queryEngine.executeQueryForSnapping(i,n);W(n);const o=await this._elevationAligner.alignCandidates(a.candidates,Z.fromJSON(e.point.spatialReference)??Z.WGS84,n);W(n);const l=await this._symbologyCandidatesFetcher.fetch(o,n);W(n);const h=0===l.length?o:o.concat(l);return{result:{candidates:this._elevationFilter.filter(i,h)}}}async updateTiles(e,s){return await this._updatingHandles.addPromise(this._whenSetup.promise),W(s),this._featureFetcher.tileSize=e.tileSize,this._featureFetcher.tilesOfInterest=e.tiles,this._featureFetcher.tileInfo=null!=e.tileInfo?q.fromJSON(e.tileInfo):null,xe}async refresh(e,s){return await this._updatingHandles.addPromise(this._whenSetup.promise),W(s),this._featureFetcher.refresh(),xe}async whenNotUpdating(e,s){return await this._updatingHandles.addPromise(this._whenSetup.promise),W(s),await Y((()=>!this.updatingExcludingEdits),s),W(s),xe}async getDebugInfo(e,s){return W(s),{result:this._featureFetcher.debugInfo}}async beginApplyEdits(e,s){this._updatingHandles.addPromise(this._whenSetup.promise),W(s);const i=Q();return this._pendingApplyEdits.set(e.id,i),this._featureFetcher.applyEdits(i.promise),this._editsUpdatingHandles.addPromise(i.promise),xe}async endApplyEdits(e,s){const i=this._pendingApplyEdits.get(e.id);return i&&i.resolve(e.edits),W(s),xe}async notifyElevationSourceChange(e,s){return this._elevationAligner.notifyElevationSourceChange(),xe}async notifySymbologyChange(e,s){return this._symbologyCandidatesFetcher.notifySymbologyChange(),xe}async setSymbologySnappingSupported(e){return this._symbologyCandidatesFetcher=re(e,this._getSymbologyCandidates),xe}_updateFeatureFetcherConfiguration(e){this._featureFetcher.filter=null!=e.filter?I.fromJSON(e.filter):null,this._featureFetcher.customParameters=e.customParameters}_notifyUpdating(){this.emit("notify-updating",{updating:this.updating})}};e([s({readOnly:!0})],Oe.prototype,"updating",null),e([s({readOnly:!0})],Oe.prototype,"updatingExcludingEdits",null),e([s()],Oe.prototype,"_isInitializing",void 0),Oe=e([i("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorker")],Oe);const Ae=Oe;const xe={result:{}};export{Ae as default};
