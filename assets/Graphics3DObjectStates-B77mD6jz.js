import{b as t,rO as n,rP as l,cD as h,cC as c,e as p,y as _,a as m,S as b,bc as f,nG as v,dw as S,fr as C,fq as G,rQ as w,rR as x,hr as E,b3 as I,u as R,rS as D,bg as O,a0 as P,m as A,cE as L,dj as U,dk as V,rT as F,k8 as j,kv as T,n as M,F as z,lN as H,du as k,K as B,lS as N,Q as W,C as q,rU as Y,rV as $,rW as Q,az as Z,om as X,qB as J,as as K,rX as ee,rY as te,rZ as ie,r_ as se,r$ as re,hv as ae,hw as ne,g as le,p as oe,bd as he,A as de,pN as ce,a8 as pe,hS as ue,kn as ye,jR as ge,s0 as _e,s1 as me,eX as be,s2 as fe,ae as ve,O as Se,H as Ce,dD as Ge,dC as we,aw as xe,s3 as Ee,U as Ie,s4 as Re,s5 as De,G as Oe,s6 as Pe,m7 as Ae,W as Le,s7 as Ue,jV as Ve,a6 as Fe,s8 as je,h6 as Te,s9 as Me,aq as ze,J as He,$ as ke,sa as Be,sb as Ne,sc as qe,sd as Ye,c4 as $e,Z as Qe,jq as Ze,se as Xe,gI as Je,cG as Ke,qC as et,kW as tt,q8 as it,fE as st,h as rt,pc as at,nS as nt,hn as lt,nw as ot,gy as ht,hZ as dt,sf as ct,i as pt,P as ut,lM as yt,a1 as gt}from"./index-DSIPxOWi.js";import{o as _t}from"./optimizedFeatureQueryEngineAdapter--U1rvwBV.js";import{h as mt}from"./PooledRBush-DOZnXWx2.js";function t$2(t){return null==t||"simple"===t.type||"unique-value"===t.type||"class-breaks"===t.type||"dictionary"===t.type||"heatmap"===t.type}function s$3(c,p){if(null==c)return null;if(!t$2(c))return new t("renderer-conversion-3d:unsupported-renderer",`Unsupported renderer of type '${c.type||c.declaredClass}'`,{renderer:c});switch(c.type){case"simple":return function a$2(t,h){const c={...n,...h,cimFallbackEnabled:!0};return l$1(t,l(t.symbol,c).error)}(c,p);case"unique-value":return function u$4(t,c){var p;const _={...n,...c,cimFallbackEnabled:!0},m=null==(p=t.uniqueValueInfos)?void 0:p.map((t=>l(t.symbol,_).error)).filter(h),b=l(t.defaultSymbol,_);return b.error&&(null==m||m.unshift(b.error)),l$1(t,m)}(c,p);case"class-breaks":return function i$1(t,c){const p={...n,...c,cimFallbackEnabled:!0},_=t.classBreakInfos.map((t=>l(t.symbol,p).error)).filter(h),m=l(t.defaultSymbol,p);return m.error&&_.unshift(m.error),l$1(t,_)}(c,p);case"dictionary":case"heatmap":return null}return null}function l$1(n,l){if(!l)return null;let h;if(h=Array.isArray(l)?l:[l],h.length>0){const l=h.map((t=>t.details.symbol.type||t.details.symbol.declaredClass)).filter((t=>!!t));l.sort();const c=[];return l.forEach(((t,n)=>{0!==n&&t===l[n-1]||c.push(t)})),new t("renderer-conversion-3d:unsupported-symbols",`Renderer contains symbols (${c.join(", ")}) which are not supported in 3D`,{renderer:n,symbolErrors:h})}return null}let bt=class e{constructor(t,n,l){this.maximumTotalNumberOfVertices=t,this.maximumNumberOfFeatures=n,this.averageSymbolComplexity=l}};const ft=c();let vt=class extends b{constructor(t){super(t),this.events=new f,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.featureAdapter={getAttribute:(t,n)=>"graphic"in t?t.graphic.attributes[n]:_t.getAttribute(t,n),getAttributes:t=>"graphic"in t?t.graphic.attributes:_t.getAttributes(t),getObjectId:t=>"graphic"in t?v(t.graphic,this.objectIdField)??void 0:_t.getObjectId(t),getGeometry:t=>"graphic"in t?t.getAsOptimizedGeometry(this.hasZ,this.hasM):_t.getGeometry(t),getCentroid:(t,n)=>{if("graphic"in t){let l=null;null!=t.centroid?l=t.centroid:"point"===t.graphic.geometry.type&&S(t.graphic.geometry,St,this.viewSpatialReference)&&(l=St);const h=new Array(2+(n.hasZ?1:0)+(n.hasM?1:0));return null==l?(h[0]=0,h[1]=0,h[2]=0,h[3]=0):(h[0]=l.x,h[1]=l.y,n.hasZ&&(h[2]=l.hasZ?l.z:0),n.hasM&&(h[n.hasZ?3:2]=l.hasM?l.m:0)),new C([],h)}return _t.getCentroid(t,n)},cloneWithGeometry:(t,n)=>"graphic"in t?new G(n,this.featureAdapter.getAttributes(t),null,this.featureAdapter.getObjectId(t)):_t.cloneWithGeometry(t,n)}}forEachInBounds(t,n){this.getSpatialIndex().forEachInBounds(t,n)}forEachBounds(t,n){const l=this.getSpatialIndex();for(const h of t){const t=this.featureAdapter.getObjectId(h);null!=l.getBounds(t,ft)&&n(ft)}}};p([_({constructOnly:!0})],vt.prototype,"getSpatialIndex",void 0),p([_({constructOnly:!0})],vt.prototype,"forEach",void 0),p([_({constructOnly:!0})],vt.prototype,"hasZ",void 0),p([_({constructOnly:!0})],vt.prototype,"hasM",void 0),p([_({constructOnly:!0})],vt.prototype,"objectIdField",void 0),p([_({constructOnly:!0})],vt.prototype,"viewSpatialReference",void 0),p([_({constructOnly:!0})],vt.prototype,"featureSpatialReference",void 0),vt=p([m("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],vt);const St={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null};let Ct=class s extends w{constructor(t,n,l){super(t,n,l),this._calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this._calloutSymbolLayer=x(this.symbol,n))}async doLoad(t){var n;const l=this._calloutSymbolLayer?E(this._calloutSymbolLayer.load()):null;try{await super.doLoad(t),I(t)}catch(h){throw null==(n=this._calloutSymbolLayer)||n.abortLoad(),h}l&&await l}destroy(){super.destroy(),this._calloutSymbolLayer=R(this._calloutSymbolLayer)}createGraphics3DGraphic(t,n){const l=super.createGraphics3DGraphic(t,n);if(null!=this._calloutSymbolLayer&&null!=l){const n=this._createCalloutGraphic(t);n&&l.setCalloutGraphic(n)}return l}globalPropertyChanged(t,n){return!!super.globalPropertyChanged(t,n)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(t,n,(t=>t.calloutLayer)))}updateGeometry(t,n){const l=super.updateGeometry(t,n);if(l&&this._calloutSymbolLayer){const l=t.calloutLayer;if(l)return this._calloutSymbolLayer.updateGeometry(l,n)}return l}_createCalloutGraphic(t){const n=t.renderingInfo;return t.renderingInfo=new D(n.renderer,n.symbol),this._calloutSymbolLayer.createGraphics3DGraphic(t)}};let Gt=class s2{constructor(t,n,l){this.visible=t,this.missing=n,this.pending=l}},wt=class e2{constructor(t){var n;this._graphicsCore=t,this._idToState=new Map,this._states=new Set;const l=null==(n=t.owner.layer)?void 0:n.objectIdField;l?(this._getGraphicId=t=>v(t,l),this._getGraphics3DGraphicById=t=>this._graphicsCore.getGraphics3DGraphicByObjectId(t)):(this._getGraphicId=t=>t.uid,this._getGraphics3DGraphicById=t=>this._graphicsCore.getGraphics3DGraphicById(t))}destroy(){this._idToState.clear(),this._states.forEach(((t,n)=>this.remove(n)))}add(t){const n=P((()=>this.remove(t)));if(this._states.has(t))return n;const l=this._getGraphicId(t.graphic),h=this._getGraphics3DGraphicById(l);return this._states.has(t)||this._states.add(t),this._ensureStateList(l).push(t),t.displaying=null!=h&&h.isVisible(),t.isDraped=null!=h&&h.isDraped,t.tracking=!0,null!=h&&t.emit("changed"),n}remove(t){if(this._states.has(t)){if(this._idToState.size){const n=this._getGraphicId(t.graphic),l=this._idToState.get(n);l&&(O(l,t),0===l.length&&this._idToState.delete(n))}this._states.delete(t),t.tracking=!1,t.displaying=!1}}addGraphic(t){this._forEachState(t,(n=>{n.displaying=t.isVisible(),n.isDraped=t.isDraped,n.emit("changed")}))}removeGraphic(t){this._forEachState(t,(t=>{t.displaying=!1,t.isDraped=!1}))}updateGraphicGeometry(t){this._forEachState(t,(t=>t.emit("changed")))}updateGraphicVisibility(t){this._forEachState(t,(n=>n.displaying=t.isVisible()))}allGraphicsDeleted(){this._states.forEach((t=>t.displaying=!1))}_ensureStateList(t){const n=this._idToState.get(t);if(n)return n;const l=new Array;return this._idToState.set(t,l),l}_forEachState(t,n){if(0===this._states.size||0===this._idToState.size)return;const l=this._getGraphicId(t.graphic),h=this._idToState.get(l);null!=h&&h.forEach(n)}},xt=class d extends b{constructor(t){super(t),this._index=new mt(9,A("esri-csp-restrictions")?t=>({minX:t.extent[0],minY:t.extent[1],maxX:t.extent[2],maxY:t.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(t){this._addMany(t)}destroy(){this._missing.clear(),this._index=R(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(t,n,l){null!=n&&n.equals(this.spatialReference)&&(Et.minX=t[0],Et.minY=t[1],Et.maxX=t[2],Et.maxY=t[3],this.update(),this._index.search(Et,(t=>l(t.graphic.uid))))}add(t){this._missing.add(t),this.updating=!0}remove(t){if(this._missing.delete(t))return void(this.updating=this._missing.size>0);if(!t.extent)return;this._index.remove(t);const n=v(t.graphic,this._get("objectIdField"));null!=n&&this._boundsByFeature.delete(n)}_addMany(t){if(0===t.length)return;const n=this._get("objectIdField");for(const l of t){l.computeExtent(this.spatialReference);const t=v(l.graphic,n);null!=t&&this._boundsByFeature.set(t,l.extent)}this._index.load(t)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(t,n){Et.minX=t[0],Et.minY=t[1],Et.maxX=t[2],Et.maxY=t[3],this.update(),this._index.search(Et,(t=>{n(t)}))}getBounds(t,n){this.update();const l=this._boundsByFeature.get(t);return l?L(n,l):null}};p([_({constructOnly:!0})],xt.prototype,"spatialReference",void 0),p([_({constructOnly:!0})],xt.prototype,"hasZ",void 0),p([_({constructOnly:!0})],xt.prototype,"hasM",void 0),p([_({constructOnly:!0})],xt.prototype,"objectIdField",void 0),p([_()],xt.prototype,"updating",void 0),p([_({readOnly:!0})],xt.prototype,"updatingRemaining",null),xt=p([m("esri.views.3d.layers.graphics.SpatialIndex2D")],xt);const Et={minX:0,minY:0,maxX:0,maxY:0};const It=Symbol("layerHandles");let Rt=class y extends(f.EventedMixin(b)){get spatialReference(){var t;return null==(t=this.view)?void 0:t.spatialReference}constructor(t){super(t),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=U(this.view.state.viewingMode),this._intersector.options.store=V.MIN;const t=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=t[2],this._zmax=t[5];const n=this.stageLayer.events;this.addHandles([n.on(["layerObjectAdded","layerObjectRemoved","geometryAdded","geometryRemoved"],(({object:t})=>this._objectChanged(t))),n.on("attributesChanged",(({attribute:t,object:n})=>F(t)&&this._objectChanged(n))),n.on(["transformationChanged","shaderTransformationChanged"],(t=>this._objectChanged(t)))],It)}dispose(){this.removeHandles(It)}elevationInfoChanged(){const t=null!=this.layer?this.layer.elevationInfo:null;if(null!=t&&"on-the-ground"!==t.mode){const n=j(this.layer.spatialReference),l=T(t.unit??"meters");this._elevationOffset=(t.offset??0)*l/n}else this._elevationOffset=0}getElevation(t,n,l,h){if(Pt[0]=t,Pt[1]=n,Pt[2]=l,!this._renderCoordsHelper.toRenderCoords(Pt,h,Pt))return M.getLogger(this).error("could not project point for elevation alignment"),null;const c=this._elevationOffset,p=this._zmin+c,_=this._zmax+c;this._renderCoordsHelper.setAltitude(At,_,Pt),this._renderCoordsHelper.setAltitude(Lt,p,Pt);return this._intersector.reset(At,Lt,null),this._intersector.intersect(this._intersectLayers,null,1,null,(t=>!!t.lastValidElevationBB)),this._intersector.results.min.getIntersectionPoint(Pt)?this._renderCoordsHelper.getAltitude(Pt):null}_objectChanged(t){const n=this.spatialReference;if(!t.lastValidElevationBB||!n)return;z(Dt);const l=t.lastValidElevationBB;l.isEmpty()||this._expandExtent(n,l.min,l.max,Dt);const{min:h,max:c}=t.boundingVolumeWorldSpace;this._expandExtent(n,h,c,Dt),H(Dt,Ot.extent),this._zmin=Math.min(this._zmin,Dt[2]),this._zmax=Math.max(this._zmax,Dt[5]),Ot.spatialReference=n,this.emit("elevation-change",Ot),k(l.min,h),k(l.max,c)}_computeLayerExtent(t,n){return z(Dt),null!=t&&n.objects.forAll((n=>this._expandExtent(t,n.boundingVolumeWorldSpace.min,n.boundingVolumeWorldSpace.max,Dt))),Dt}_expandExtent(t,n,l,h){for(let c=0;c<8;++c)Pt[0]=1&c?n[0]:l[0],Pt[1]=2&c?n[1]:l[1],Pt[2]=4&c?n[2]:l[2],this._renderCoordsHelper.fromRenderCoords(Pt,Pt,t),B(h,Pt);return h}};p([_({constructOnly:!0})],Rt.prototype,"layer",void 0),p([_({constructOnly:!0})],Rt.prototype,"stageLayer",void 0),p([_({constructOnly:!0})],Rt.prototype,"view",void 0),p([_()],Rt.prototype,"spatialReference",null),Rt=p([m("esri.views.3d.layers.support.StageLayerElevationProvider")],Rt);const Dt=z(),Ot=new N,Pt=W(),At=W(),Lt=W();var Ut;const Vt=W(),Ft=c();let jt=Ut=class extends b{get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){var t;return this._spatialIndex||(this._spatialIndex=new xt({objectIdField:null==(t=this.owner.layer)?void 0:t.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get deconflictor(){return this._deconflictor}get labeler(){return this._labeler}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){return null!=this.currentRenderer&&"dictionary"===this.currentRenderer.type?q.ASYNC:this._forcedUpdatePolicy??this.preferredUpdatePolicy}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){var t,n,l;return!!(this.dataUpdating||(null==(t=this._elevationAlignment)?void 0:t.updating)||(null==(n=this._scaleVisibility)?void 0:n.updating)||(null==(l=this._filterVisibility)?void 0:l.updating)||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._frameTaskHandle.updating||this.running)}get dataUpdating(){var t;return!!(this._graphicsWaitingForSymbol.size>0||this._pendingUpdates.size>0||(null==(t=this._spatialIndex)?void 0:t.updating)||this._updatingPendingLoadedGraphicsChange||this._dataUpdateQueue.running||this._loadingSymbols>0)}get running(){var t;return this._pendingUpdates.size>0||!!(null==(t=this._spatialIndex)?void 0:t.updating)||this._dataUpdateQueue.running||this._updateQueue.running}get suspendedOrOutsideOfView(){var t;return this.owner.suspended||!!(null==(t=this.owner.suspendInfo)?void 0:t.outsideOfView)}get updatingRemaining(){var t,n;return this.updating?this._pendingUpdates.size+.1*((null==(t=this._spatialIndex)?void 0:t.updatingRemaining)||0)+.1*((null==(n=this._elevationAlignment)?void 0:n.updatingRemaining)||0):0}get displayFeatureLimit(){const t=this.owner&&this.owner.view&&this.owner.view.qualitySettings,n=(null==t?void 0:t.graphics3D.minTotalNumberOfFeatures)??0,l=(null==t?void 0:t.graphics3D.maxTotalNumberOfFeatures)??0,h=(null==t?void 0:t.graphics3D.maxNumberOfDrawCalls)??0,c=(null==t?void 0:t.graphics3D.maxTotalNumberOfVertices)??0,p=this.averageSymbolComplexity,_=Math.max(1,(null==p?void 0:p.verticesPerFeature)??1),m=p&&p.drawCallsPerFeature>0&&h>0?h/p.drawCallsPerFeature:l,b=Math.ceil(c/_),f=Math.max(n,Math.min(l,b,m)),v=this._get("displayFeatureLimit");return v&&v.maximumTotalNumberOfVertices===c&&v.averageSymbolComplexity===p&&v.maximumNumberOfFeatures===f?v:new bt(c,f,p)}get averageSymbolComplexity(){const t=Y(this._symbolComplexities),n=this._get("averageSymbolComplexity");return 0===t.numComplexities||null!=n&&(t.estimated&&(n.verticesPerFeature>=t.verticesPerFeature||n.verticesPerCoordinate>=t.verticesPerCoordinate||n.drawCallsPerFeature>=t.drawCallsPerFeature)||n.verticesPerFeature===t.verticesPerFeature&&n.verticesPerCoordinate===t.verticesPerCoordinate&&n.drawCallsPerFeature===t.drawCallsPerFeature)?n:t}get usedMemory(){const t=null!=this.averageSymbolComplexity&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,n=this._getSymbolComplexitiesUsed().reduce(((t,n)=>t+n.memory.resourceBytes),0);if(null==this._symbolMaterials){this._symbolMaterials=[];for(const t of this._symbols.values())if(null!=t)for(const n of t.symbolLayers)if(n)for(const t of n.materials)t&&this._symbolMaterials.push(t)}const l=this.owner.view._stage.renderer.plugins,h=this.owner.view.basemapTerrain.overlayManager.renderer,c=this._symbolMaterials.reduce(((t,n)=>{var c;return t+((null==(c=l.getMaterialRenderer(n)||h.getMaterialRenderer(n))?void 0:c.usedMemory)??0)}),0);return this._usedMemory+t+n+c}get usedMemoryPerGraphic(){if(this._usedMemory&&this._numberOfGraphics){const t=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*t}if(null!=this.averageSymbolComplexity){const t=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+t}return 0}get unprocessedMemoryEstimate(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(t){var n;if("web-style"===t.type)return t.clone();const h=this._symbolConversionCache.get(t.id);if(null!=h)return h;const c=l(t,{geometryType:(null==(n=this.layer)?void 0:n.geometryType)??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(t),cimFallbackEnabled:!0}),p=c.symbol||null;return null==p&&c.error&&M.getLogger(this).error(c.error.message),this._symbolConversionCache.set(t.id,p),p}_getSymbolComplexitiesUsedOrRenderer(t){if(null==t)return[];const n=t.getSymbols(),l="backgroundFillSymbol"in t?t.backgroundFillSymbol:null;if(!l&&!(null==n?void 0:n.length))return[];const h=[],c=this._getSymbolComplexityUsedOrRenderer(l);null!=c&&h.push(c);for(const p of n){const t=this._getSymbolComplexityUsedOrRenderer(p);null!=t&&h.push(t)}return h}_getSymbolComplexityUsedOrRenderer(t){if(null==t)return null;const n=this._symbols.get(t.id);if(null!=n)return n.complexity;const l=this._getConvertedSymbol(t);return null!=l?$(l):null}_getSymbolComplexitiesUsed(){const t=[];return this._symbols.forEach((n=>{null!=n&&t.push(n.complexity)})),t}get _objectIdField(){return this.layer.objectIdField}constructor(t){super(t),this._propertiesPool=new Q({computedExtent:Z},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this._graphicStateTracking=null,this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this._graphicsDrapedUids=new Set,this._graphicsBySymbol=new Map,this._symbolConversionCache=new Map,this._symbols=new Map,this._graphicsWithoutSymbol=new Map,this._graphicsWaitingForSymbol=new Map,this._graphicsUpdateId=0,this._frameTaskHandle=X,this._dataUpdateQueue=new J,this._updateQueue=new J,this._suspendSymbolCleanup=!1,this._arcadeOnDemand=null,this._rendererChangeAbortController=null,this._elevationInfoChangeAbortController=null,this._initializeAbortController=null,this._elevationAlignment=null,this._scaleVisibility=null,this._filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this._featureStore=null,this._deconflictor=null,this._labeler=null,this._objectStates=null,this._viewElevationProvider=null,this._stageLayerElevationProvider=null,this._sharedSymbolResourcesOwnerHandle=null,this._whenGraphics3DGraphicRequests={},this._pendingUpdates=new Map,this._numberOfGraphics=0,this._numberOfGraphicsProvidingElevation=0,this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this._loadingSymbols=0,this._pendingUpdatesPool=new K({allocator:t=>t||new We,deallocator:t=>(t.clear(),t)}),this._symbolWarningLogged=!1,this._geometryWarningLogged=!1,this._objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new K,this.preferredUpdatePolicy=q.SYNC,this._forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.setUidToIdOnAdd=!0,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=!1,this._startCreateGraphics=!1,this._unusedSymbolsCache=t.owner.view.resourceController.memoryController.newCache("graphics-3d-unused-symbols",(t=>t.destroy())),this.symbolCreationContext=new ee(t.owner.view.resourceController.scheduler,((t,n)=>this._updateQueue.push(t,n)))}initialize(){var t,n,l,h,c,p,_;this._featureStore=new vt({objectIdField:null==(t=this.owner.layer)?void 0:t.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:t=>this.graphics3DGraphics.forEach(t)});const e4=(t,n,l)=>this.spatialIndex.queryGraphicUIDsInExtent(t,n,l),{componentFactories:m}=this;this._elevationAlignment=null==(n=m.elevationAlignment)?void 0:n.call(m,this,e4),this._scaleVisibility=null==(l=m.scaleVisibility)?void 0:l.call(m,this,e4),this._filterVisibility=null==(h=m.filterVisibility)?void 0:h.call(m,{featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:t=>this.modifyGraphics3DGraphicVisibilities((n=>n.setVisibilityFlag(te.GRAPHIC,ie.FILTER,t(v(n.graphic,this._objectIdField))))),setAllFeaturesVisibility:t=>this.modifyGraphics3DGraphicVisibilities((n=>n.setVisibilityFlag(te.GRAPHIC,ie.FILTER,t))),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities((t=>t.setVisibilityFlag(te.GRAPHIC,ie.FILTER,!0)))}),this._deconflictor=null==(c=m.deconflictor)?void 0:c.call(m,this),this._labeler=null==(p=m.labeler)?void 0:p.call(m,this,this._scaleVisibility),this._objectStates=null==(_=m.objectStates)?void 0:_.call(m,this),this._initializeAbortController=new AbortController,this._initializePromise=this._initializeAsync()}async _initializeAsync(){var t,n,l,h;const c=null==(t=this._initializeAbortController)?void 0:t.signal,p=this.owner.view;this._viewElevationProvider=new se(this._viewSpatialReference,p),this._initializeStage(p,this.layer.uid);const _=p.sharedSymbolResources;this.symbolCreationContext.sharedResources=_,this._sharedSymbolResourcesOwnerHandle=_.addGraphicsOwner(this.owner),null!=this.currentRenderer&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=_.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=p.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new re(p.renderSpatialReference),this.symbolCreationContext.elevationProvider=p.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=t=>this.notifyGraphicGeometryChanged(t),this.symbolCreationContext.notifyGraphicVisibilityChanged=t=>this.notifyGraphicVisibilityChanged(t);const m=ae(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);if(this.symbolCreationContext.featureExpressionInfoContext=await ne(m,this._viewSpatialReference,c,M.getLogger(this)),I(c),this.symbolCreationContext.screenSizePerspectiveEnabled=p.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!(null==(n=this.owner.view.qualitySettings)?void 0:n.physicallyBasedRenderingEnabled),this.symbolCreationContext.skipHighSymbolLods=!!(null==(h=null==(l=this.owner.view.qualitySettings)?void 0:l.graphics3D)?void 0:h.skipHighSymbolLods),"drapeSourceType"in this.owner){const{owner:t}=this;this.symbolCreationContext.drapeSourceRenderer=p.basemapTerrain.overlayManager.registerGeometryDrapeSource(t),this.addHandles(P((()=>p.basemapTerrain.overlayManager.unregisterDrapeSource(t))))}this.addHandles([le((()=>this.suspendedOrOutsideOfView),(()=>this._updateQueue.unshift((()=>this._updateLayerVisibility()),null).catch(Te))),le((()=>{var t,n;return[null==(t=this.layer)?void 0:t.screenSizePerspectiveEnabled,null==(n=this.owner.view)?void 0:n.screenSizePerspectiveEnabled]}),(()=>{var t;const n=p.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;n!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=n,null==(t=this._labeler)||t.reset(),this.recreateAllGraphicsAndSymbols())})),le((()=>this.owner.slicePlaneEnabled),(t=>this._slicePlaneEnabledChange(!!t))),le((()=>{var t;return null==(t=this.owner.view.state)?void 0:t.rasterPixelRatio}),(()=>this._pixelRatioChange())),le((()=>{var t;return!!(null==(t=this.owner.view.qualitySettings)?void 0:t.physicallyBasedRenderingEnabled)}),(t=>this._physicalBasedRenderingChange(t))),le((()=>{var t,n;return!!(null==(n=null==(t=this.owner.view.qualitySettings)?void 0:t.graphics3D)?void 0:n.skipHighSymbolLods)}),(t=>this._skipHighSymbolLoDsChange(t))),oe((()=>{var t;return null==(t=p.basemapTerrain)?void 0:t.tilingScheme}),(t=>{if(t.spatialReference.equals(this.symbolCreationContext.overlaySR)||null==p.basemapTerrain.spatialReference||(this.symbolCreationContext.overlaySR=p.basemapTerrain.spatialReference),this.hasHandles("loaded-graphics"))this.recreateAllGraphics();else{const e6=()=>{var t;return null==(t=this.owner)?void 0:t.loadedGraphics};this.addHandles([he(e6,"change",(t=>{this._graphicsCollectionChanged(t),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}),{onListenerAdd:()=>{this.recreateAllGraphics(),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")}}),{initial:!0}),le((()=>this.effectiveUpdatePolicy),(t=>{null!=this.stageLayer&&(this.stageLayer.updatePolicy=t),this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===q.ASYNC,t===q.SYNC&&this.runTask(ce)}),de)]),this._frameTaskHandle=p.resourceController.scheduler.registerTask(pe.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this.addHandles(le((()=>this.layer.featureReduction),(()=>{var t;return null==(t=this._deconflictor)?void 0:t.featureReductionChange()}))),this.notifyChange("averageSymbolComplexity"),this.rendererChange(this.owner.renderer).catch((()=>{})),this._initializeAbortController=null}_abortInitialize(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=null)}destroy(){this._unusedSymbolsCache.destroy(),this._abortInitialize(),this._abortRendererChange(),this._abortElevationInfoChange(),this._frameTaskHandle.remove(),this._frameTaskHandle=X,this._dataUpdateQueue.cancelAll(),this._updateQueue.cancelAll(),this._deconflictor=ue(this._deconflictor),this._labeler=ue(this._labeler),this._elevationAlignment=R(this._elevationAlignment),this._scaleVisibility=R(this._scaleVisibility),this._filterVisibility=R(this._filterVisibility),this._objectStates=R(this._objectStates),this.clear(),this._featureStore=R(this._featureStore),this._updatingPendingLoadedGraphicsChange=ue(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=R(this._graphicStateTracking),this.stage&&(this.stageLayer=R(this.stageLayer),this.stage=null),this._set("owner",null);for(const n in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[n].reject(new t("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null,this._sharedSymbolResourcesOwnerHandle=ue(this._sharedSymbolResourcesOwnerHandle),this._propertiesPool=R(this._propertiesPool),this._pendingUpdatesPool=null,this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=R(this._spatialIndex)}clear(){var t,n;null==(t=this._objectStates)||t.allGraphicsDeleted(),null!=this._graphicStateTracking&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((t=>t.destroy())),null==(n=this._spatialIndex)||n.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(R),this._symbols.clear(),this._symbolMaterials=null,this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingUpdatesPool.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange("dataUpdating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this._featureStore.events.emit("changed")}_initializeStage(t,n){this.stage=t._stage,this.stageLayer=new ye(this.stage,{pickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},n);const l=this.stageLayer.events;l.on("transformationChanged",(t=>this.notifyGraphicGeometryChanged(t.graphicUid))),l.on("shaderTransformationChanged",(t=>this.notifyGraphicGeometryChanged(t.graphicUid))),l.on("visibilityChanged",(t=>this.notifyGraphicVisibilityChanged(t.graphicUid))),l.on("geometryAdded",(t=>this.notifyGraphicGeometryChanged(t.object.graphicUid))),l.on("geometryRemoved",(t=>this.notifyGraphicGeometryChanged(t.object.graphicUid))),l.on("attributesChanged",(t=>F(t.attribute)&&this.notifyGraphicGeometryChanged(t.object.graphicUid)))}notifyGraphicGeometryChanged(t){if(null==this._graphicStateTracking||null==t)return;const n=this.graphics3DGraphics.get(t);n&&this._graphicStateTracking.updateGraphicGeometry(n)}notifyGraphicVisibilityChanged(t){if(null==this._graphicStateTracking||null==t)return;const n=this.graphics3DGraphics.get(t);n&&this._graphicStateTracking.updateGraphicVisibility(n)}_updateLayerVisibility(){const t=this.displayFeatureLimit.maximumNumberOfFeatures,n=this._numberOfGraphics>t*zt,l=!this.suspendedOrOutsideOfView&&!n;l!==this._visible&&(this._visible=l,l?(this.stageLayer.pickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.pickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())}_updateStageLayerVisibility(){this.stageLayer.visible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)}getGraphics3DGraphicById(t){return null!=t?this.graphics3DGraphics.get(t):void 0}getGraphics3DGraphicByObjectId(t){var n;return(null==(n=this.owner.layer)?void 0:n.objectIdField)?this._findGraphics3DGraphicByObjectId(t):null}_getGraphicObjectID(t,n=(t=>null==(t=this.owner.layer)?void 0:t.objectIdField)()){return v(t,n)}get graphics3DGraphicsByObjectID(){var t;const n=null==(t=this.owner.layer)?void 0:t.objectIdField;if(!n)return;const l=new Map;return this.graphics3DGraphics.forEach((t=>{if(!t)return;const h=t.graphic,c=this._getGraphicObjectID(h,n);null!=c&&l.set(c,t)})),l}get labelsEnabled(){var t;return!!(null==(t=this._labeler)?void 0:t.layerLabelsEnabled())}async updateLabelingInfo(t){var n,l;const h=null==(n=this._deconflictor)?void 0:n.labelingInfoChange(t),c=null==(l=this._labeler)?void 0:l.labelingInfoChange(t);await Promise.allSettled([h,c])}updateVisibilityInfo(){var t,n;null==(t=this._deconflictor)||t.labelingInfoChange(),null==(n=this._labeler)||n.visibilityInfoChange()}get symbolUpdateType(){if(this._pendingUpdates.size>0)return"unknown";let t=0,n=0;return ge(this._symbols,((l,h)=>{if(null!=l){const c=l.getFastUpdateStatus();if(c.loading>0)return!0;this._graphicsBySymbol.has(h)&&(n+=c.fast,t+=c.slow)}return!1}))?"unknown":n>=0&&0===t?"fast":t>=0&&0===n?"slow":"mixed"}runTask(t){if(this._dataUpdateQueue.runTask(t),this._updateQueue.runTask(t),this._applyPendingUpdates(t),this.notifyChange("running"),this.running||this.notifyChange("dataUpdating"),this.notifyChange("updatingRemaining"),!t.hasProgressed)return _e}setObjectIdVisibility(t,n){n?this._objectIdInvisibleSet.delete(t):this._objectIdInvisibleSet.add(t);const l=this._findGraphics3DGraphicByObjectId(t);null!=l&&this._updateUserVisibility(l)}_findGraphics3DGraphicByObjectId(t){return me(this.graphics3DGraphics,(n=>this._getGraphicObjectID(n.graphic)===t))}_updateUserVisibility(t){if(null==t)return!1;const n=t.graphic,l=this._getGraphicObjectID(n),h=n.visible&&!this.owner.suspended&&(null==l||!this._objectIdInvisibleSet.has(l));return t.setVisibilityFlag(te.GRAPHIC,ie.USER,h)}_whenGraphics3DGraphic(t){const n=this.graphics3DGraphics.get(t.uid);if(n)return Promise.resolve(n);const l=this._whenGraphics3DGraphicRequests[t.uid];if(l)return l.promise;const h=be();return this._whenGraphics3DGraphicRequests[t.uid]=h,h.promise}async _boundsForGraphics3DGraphic(t,n){const l=this._viewSpatialReference,h=this.owner.view.renderSpatialReference,c=this.owner.view.basemapTerrain.spatialReference,p=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:null!=n&&!!n.useViewElevation,minDemResolution:null!=n?n.minDemResolution:null,minDemResolutionForPoints:this.owner.view.resolution}:null,_=await t.getProjectedBoundingBox(((t,n,c)=>st(t,h,n,t,l,n,c)),((t,n,h)=>st(t,c,n,t,l,n,h)),p,null==n?void 0:n.signal);if(!_)return null;const m=_.boundingBox;if(_.requiresDrapedElevation){const t=this.symbolCreationContext.elevationProvider;if(t){fe(m,Vt);const n=t.getElevation(Vt[0],Vt[1],0,l,"ground")??0;m[2]=Math.min(m[2],n),m[5]=Math.max(m[5],n)}}return{boundingBox:m,screenSpaceObjects:_.screenSpaceObjects}}async whenGraphicBounds(n,l){var h;await ve((()=>{var t;return null==(t=this.owner)?void 0:t.loadedGraphics}));const c=null==(h=this.owner.layer)?void 0:h.objectIdField,p=this.owner.loadedGraphics.find((t=>t===n||null!=c&&null!=t.attributes&&n.attributes&&t.attributes[c]===n.attributes[c]));if(!p)throw new t("internal:graphic-not-part-of-view","Graphic is not part of this view");const _=await this._whenGraphics3DGraphic(p);return this._boundsForGraphics3DGraphic(_,l)}computeAttachmentOrigin(t,n){const l=this.graphics3DGraphics.get(t.uid);if(!l)return null;const h=l.computeAttachmentOrigin();if(0===h.render.num&&0===h.draped.num)return null;Se(Ht,0,0,0);let c=0;if(h.render.num>0){if(!Ce(h.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,kt,n))return null;Ge(Ht,Ht,kt),c++}if(h.draped.num>0){const[t,l]=h.draped.origin,p=this._viewElevationProvider.getElevation(t,l,"ground")??0;if(Se(kt,t,l,p),!Ce(kt,this._viewElevationProvider.spatialReference,kt,n))return null;Ge(Ht,Ht,kt),c++}return c>1&&we(Ht,Ht,1/c),new xe({x:Ht[0],y:Ht[1],z:Ht[2],spatialReference:n})}getSymbolLayerSize(n,l){const h=this._symbols.get(n.id);if(null==h)throw new t("internal:symbol-not-part-of-view","Symbol is not part of this view");const c=n.symbolLayers.indexOf(l);if(-1===c)throw new t("internal:missing-symbol-layer","Symbol layer is not in symbol");const p=h.getSymbolLayerSize(c);if(null==p)throw new t("internal:missing-size","Symbol layer has no valid size");return p}_graphicsCollectionChanged(t){this._startCreateGraphics&&(this.add(t.added),this.remove(t.removed))}graphicUpdateHandler(t){const n=t.graphic.uid,l=this.graphics3DGraphics.get(n);if(null!=l||null!=this._graphicsWithoutSymbol.get(n))switch(t.property){case"visible":this._graphicUpdateVisibleHandler(l);break;case"geometry":this._graphicUpdateGeometryHandler(l,t);break;case"symbol":this._graphicUpdateSymbolHandler(l,t);break;case"attributes":break;case"origin-transform":this._graphicUpdateTransformHandler(l,t)}}_graphicUpdateGeometryHandler(t,n){this._graphicUpdateGeometryOrTransformHandler(t,n,(()=>{var l,h;return!(null==n.newValue||null==t||!t.graphics3DSymbol.updateGeometry(t,n.newValue)||!((null==(l=this._labeler)?void 0:l.updateGraphicGeometry(t))??1)||(null==(h=this._labeler)||h.setDirty(),0))}));const l=n.graphic.geometry;null!=l&&this._expandComputedExtent(l)}_graphicUpdateTransformHandler(t,n){const l=n.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(t,n,(()=>null!=n.newValue&&null!=t&&null!=l&&t.graphics3DSymbol.updateTransform(t,l.spatialReference,n.newValue,n.action)))}_graphicUpdateGeometryOrTransformHandler(t,n,l){var h;if(null!=n.graphic.geometry)if(null!=t)l()||this._recreateGraphic(t.graphic);else{const t=null==(h=n.graphic.symbol)?void 0:h.id;if(t){const n=this._symbols.get(t);if(null!=n&&n.loadStatus===Ee.LOADING)return}this._recreateGraphic(n.graphic)}else this._recreateGraphic(n.graphic)}_graphicUpdateSymbolHandler(t,n){const l=n.graphic,h=null!=t?t.graphics3DSymbol:null!=n.oldValue?this._symbols.get(n.oldValue.id):null;if(null==h||null==n.newValue)return void this._recreateGraphic(l);const c=h.symbol,p=this._getConvertedSymbol(n.newValue);if(null!=p&&(p.type!==c.type||"web-style"===p.type)||"web-style"===c.type)return void this._recreateGraphic(l);const _=this._graphicsBySymbol.get(c.id);if(_&&1!==_.size)return void this._recreateGraphic(l);const m=Ie(c,p);if(null==m)return void this._updateSymbolMapping(c.id,p);const b={diff:m,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(h.prepareSymbolPatch(b),!Re(b.diff))return void this._recreateGraphic(l);const f=this._getRenderingInfo(l);if(null==f)return void this._recreateGraphic(l);const v=h.extentPadding;for(const S of b.symbolStatePatches)S();if(v!==h.extentPadding&&this._recomputeExtentPadding(),null!=t)for(const S of b.graphics3DGraphicPatches)S(t,f);this._updateSymbolMapping(c.id,p)}_graphicUpdateVisibleHandler(t){var n,l;this._updateUserVisibility(t)&&(null==(n=this._labeler)||n.setDirty(),null==(l=this._deconflictor)||l.setDirty())}recreateGraphics(t){this._suspendSymbolCleanup=!0,this.remove(t),this.add(t),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===q.SYNC&&this._cleanupSymbols()}_recreateGraphic(t){this.recreateGraphics([t])}_beginGraphicUpdate(t){const n=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(t.uid,n),1===this._graphicsWaitingForSymbol.size&&this.notifyChange("dataUpdating"),n}_endGraphicUpdate(t){t&&(this._graphicsWaitingForSymbol.delete(t.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating")))}_recomputeExtentPadding(){let t=0;this._symbols.forEach((n=>{null!=n&&(t=Math.max(t,n.extentPadding))})),this._set("extentPadding",t)}_expandComputedExtent(t){const n=Ft,l=t.spatialReference;De(t,n);const h=this._viewSpatialReference,c=Ut.tmpVec;if(Oe(l,h)||Pe(n[0],n[1],0,l,c,h)&&(n[0]=c[0],n[1]=c[1],Pe(n[3],n[4],0,l,c,h),n[3]=c[0],n[4]=c[1]),!(isFinite(n[0])&&isFinite(n[3])&&isFinite(n[1])&&isFinite(n[4])))return;const p=this.computedExtent;let _=null;const m=isFinite(n[2])&&isFinite(n[5]),b=m&&(null==(null==p?void 0:p.zmin)||n[2]<p.zmin),f=m&&(null==(null==p?void 0:p.zmax)||n[5]>p.zmax);p?(n[0]<p.xmin||n[1]<p.ymin||n[3]>p.xmax||n[4]>p.ymax||b||f)&&(_=this._propertiesPool.get("computedExtent"),_.xmin=Math.min(n[0],p.xmin),_.ymin=Math.min(n[1],p.ymin),_.xmax=Math.max(n[3],p.xmax),_.ymax=Math.max(n[4],p.ymax),_.spatialReference=h):(_=this._propertiesPool.get("computedExtent"),_.xmin=n[0],_.ymin=n[1],_.xmax=n[3],_.ymax=n[4],_.spatialReference=h),_&&(b&&(_.zmin=n[2]),f&&(_.zmax=n[5]),this._set("computedExtent",_))}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)}async elevationInfoChange(){var t,n;this._abortElevationInfoChange();const l=new AbortController;this._elevationInfoChangeAbortController=l;const h=ae(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await ne(h,this._viewSpatialReference,l.signal,M.getLogger(this)),I(l.signal),this._elevationInfoChangeAbortController=null,null==(t=this._labeler)||t.elevationInfoChange(),this.forEachGraphics3DSymbol(((t,n,l)=>{t.globalPropertyChanged("elevationInfo",n)?n.forEach((t=>{const n=t.graphic,l=t.labelLayers;for(const h of l)h.graphics3DSymbolLayer.updateGraphicElevationContext(n,h)})):this._recreateSymbol(l)})),this.updateStageLayerElevationProvider(),null==(n=this._elevationAlignment)||n.elevationInfoChange()}updateStageLayerElevationProvider(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=Ae(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new Rt({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){var t,n,l,h;this.clear(),null!=this._filterVisibility&&this._filterVisibility.clear(),null==(t=this._labeler)||t.reset(),null==(n=this._deconflictor)||n.clear(),null==(l=this._elevationAlignment)||l.clear(),null==(h=this.stageLayer)||h.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=Ae(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(t=!1){if(!this._startCreateGraphics)return;const{loadedGraphics:n,view:l}=this.owner,h=l.basemapTerrain.tilingScheme&&(null==n?void 0:n.length)?n.toArray():null;!t&&h||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),h&&(t?this.add(h):this.recreateGraphics(h))}_recreateSymbol(t){const n=this._graphicsBySymbol.get(t),l=[];n&&(n.forEach(((t,n)=>{var h;const c=t.usedMemory;this._conditionalRemove(t,n),null==(h=this._spatialIndex)||h.remove(t),l.push(t.graphic),t.destroy(),this._removeGraphics3DGraphic(n,c),this._updateLayerVisibility(),this._featureStore.events.emit("changed")})),this._graphicsBySymbol.set(t,new Map));const h=this._symbols.get(t);R(h),this._symbols.delete(t),this._symbolMaterials=null,this.add(l)}_recreateGraphicsForSymbol(t){const n=this._graphicsBySymbol.get(t);if(n){const t=[];n.forEach((n=>t.push(n.graphic))),this.recreateGraphics(t)}}_conditionalRemove(t,n){var l,h,c;this._graphicsDrapedUids.delete(n),null==(l=this._objectStates)||l.removeGraphic(t),null==(h=this._labeler)||h.removeGraphic(t),null==(c=this._deconflictor)||c.removeGraphic(t),null!=this._graphicStateTracking&&this._graphicStateTracking.removeGraphic(t)}add(t){var n;t&&0!==t.length&&((null==(n=this.owner.view.basemapTerrain)?void 0:n.tilingScheme)?(this._updatePolicyForGraphics(t)===q.ASYNC?this._addDelayed(t):this._addImmediate(t),this.notifyChange("dataUpdating")):M.getLogger(this).error("#add()","Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(t){if(this.effectiveUpdatePolicy===q.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const n of t)if(null!=n.geometry&&"mesh"===n.geometry.type&&!n.geometry.loaded)return q.ASYNC;return this.effectiveUpdatePolicy}_addImmediate(t){var n,l;this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(const h of t)this._addGraphic(h,this._getRenderingInfo(h,M.getLogger(this)),q.SYNC);this._cleanupSymbols(),null==(n=this._labeler)||n.setDirty(),null==(l=this._deconflictor)||l.setDirty()}_addDelayed(t){var n;for(const l of t){const t=l.uid;let h=this._pendingUpdates.get(t);h?h.add?h.state!==Tt.NEW&&(null==(n=h.abortController)||n.abort()):this._pendingAdds++:(h=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(t,h)),h.add=l}this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}remove(t){this.effectiveUpdatePolicy===q.ASYNC?this._removeDelayed(t):this._removeImmediate(t),this.notifyChange("dataUpdating")}_removeImmediate(t){var n,l;for(const h of t)this._removeGraphic(h);this._cleanupSymbols(),null==(n=this._labeler)||n.setDirty(),null==(l=this._deconflictor)||l.setDirty()}_removeDelayed(t){var n;for(const l of t){const t=l.uid,h=this._pendingUpdates.get(t);if(h)h.add&&(h.remove?h.add=null:this._pendingUpdates.delete(t),h.state===Tt.LOADING&&(null==(n=h.abortController)||n.abort()),this._pendingAdds--);else{const n=this._pendingUpdatesPool.pushNew();n.remove=l,this._pendingUpdates.set(t,n),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}0===this._pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}_finishPendingUpdates(){this._pendingUpdatesPool.clear(),this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&M.getLogger(this).warn("pendingAdds/Removes in inconsistent state!"),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1}_applyPendingUpdates(t){var n;if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,0===this._pendingUpdates.size&&(null==(n=this._spatialIndex)?void 0:n.updating))return this._spatialIndex.update(),void t.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(const[n,l]of this._pendingUpdates){if(t.done){this._applyPendingRemovesFirst=!0;break}if(l.remove&&!l.add&&(this._pendingRemoves--,t.madeProgress(),this._removeGraphic(l.remove),l.remove=null,this._pendingUpdates.delete(n),0===this._pendingRemoves))break}}for(const[l,h]of this._pendingUpdates){if(t.done)break;h.add&&h.state===Tt.NEW&&this._processPendingUpdateNew(h);let n=this.effectiveUpdatePolicy;if(!h.remove||h.add&&h.state!==Tt.READY||(this._pendingRemoves--,t.madeProgress(),this._removeGraphic(h.remove),h.remove=null,n=q.SYNC),h.add)switch(h.state){case Tt.READY:this._addGraphic(h.add,h.renderingInfo,n),h.add=null,this._pendingAdds--,t.madeProgress();break;case Tt.REJECTED:h.add=null,this._pendingAdds--;case Tt.LOADING:}null==h.remove&&null==h.add&&this._pendingUpdates.delete(l)}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("dataUpdating"))}_processPendingUpdateNew(t){if(!t.add)return void(t.state=Tt.READY);const n=t.add.geometry;null==n||"mesh"!==n.type||n.loaded?this._processPendingUpdateNewRenderingInfo(t):this._processPendingUpdateNewMesh(t,n)}async _processPendingUpdateNewMesh(t,n){t.state=Tt.LOADING,t.abortController=new AbortController;const l=t.abortController.signal;try{await n.load({signal:l})}catch(h){return this._processPendingUpdateNewError(t,h)}t.abortController=null,this._processPendingUpdateNewRenderingInfo(t)}_processPendingUpdateNewError(t,n){t.abortController=null,Le(n)?t.state=Tt.NEW:t.state=Tt.REJECTED}async _processPendingUpdateNewRenderingInfo(t){if(null==this.layer.renderer||"dictionary"!==this.layer.renderer.type)return t.renderingInfo=this._getRenderingInfo(t.add,M.getLogger(this)),void(t.state=Tt.READY);t.state=Tt.LOADING,t.abortController=new AbortController;let n=null;try{n=await this._getRenderingInfoAsync(t.add,{signal:t.abortController.signal})}catch(l){return t.abortController=null,void(Le(l)?t.state=Tt.NEW:t.state=Tt.REJECTED)}null==(null==n?void 0:n.symbol)?(this._symbolWarningLogged||(this._symbolWarningLogged=!0,M.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),t.renderingInfo=null):t.renderingInfo=n,t.state=Tt.READY}_addGraphic(t,n,l){var h;if(this._graphicsWithoutSymbol.set(t.uid,t),null==(null==n?void 0:n.symbol)||!Ue(t))return;if(null!=this.stage.renderView.objectAndLayerIdRenderHelper&&this.setUidToIdOnAdd){const n=Ve(this.owner.view.map,this.layer.uid);this.stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(t.objectId,t.uid,this.layer.id,this.layer.uid,!!this.layer.popupEnabled&&!n&&Fe(this.layer,null==(h=this.owner.view.popup)?void 0:h.defaultPopupTemplateEnabled))}const c=n.symbol,p=this.getOrCreateGraphics3DSymbol(c,n.renderer);if(null==p)return;this._expandComputedExtent(t.geometry);const _=this._beginGraphicUpdate(t),m=new je(t,n,this.layer);let b=!1;const l2=t=>{t===p.symbol.id&&(b=!0)};this._whenSymbolRemoved.push(l2);const h2=()=>{var n;if(--this._loadingSymbols,!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(l2),this._graphicsWaitingForSymbol.get(t.uid)!==_||b||p.destroyed||this.graphicSymbolSupported&&t.symbol&&t.symbol.id!==p.symbol.id)--p.referenced,this._cleanupSymbols();else{const n=this._createGraphics3DGraphic(p,m);this._spatialIndex&&null!=n&&this._spatialIndex.add(n),--p.referenced,this._endGraphicUpdate(t)}this._featureStore.events.emit("changed"),null==(n=this._labeler)||n.setDirty()}},d3=n=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(l2),b||(Le(n)?this.add([t]):p.destroyed||this._endGraphicUpdate(t)))};++this._loadingSymbols,l===q.ASYNC?p.load((()=>this._dataUpdateQueue.push(h2,null).catch(Te)),(t=>this._dataUpdateQueue.push((()=>d3(t)),null).catch(Te))):p.load(h2,d3)}_removeGraphic(t){var n,l;const h=t.uid,c=this.graphics3DGraphics.get(h);if(c){c.graphics3DSymbol.onRemoveGraphic(c);const t=c.usedMemory,p=c.isElevationSource;this._conditionalRemove(c,h),null==(n=this._spatialIndex)||n.remove(c);const _=c.graphics3DSymbol.symbol.id;null==(l=this._graphicsBySymbol.get(_))||l.delete(h),this._graphicsWithoutSymbol.delete(h),this._removeGraphics3DGraphic(h,t,p),c.destroy(),this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(h),this._graphicsWaitingForSymbol.delete(h),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating"))}_hasLabelingContext(t){if(t instanceof Me||t instanceof ze){const n=this.symbolCreationContext.layer;return!!n.labelingInfo&&n.labelingInfo.some((n=>n.symbol===t))}return!1}_hasValidSymbolCreationContext(t){return!(t instanceof Me&&!this._hasLabelingContext(t)&&(M.getLogger(this).error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),1))}_getRenderingInfo(t,n){const l=t.geometry;if(null==l)return n&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,n.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!He(l.spatialReference,this._viewSpatialReference))return n&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,n.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&null!=t.symbol)return n&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,n.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const h=this.rendererHasGeometryOperations?ke(t,this.layer):t;let c;return c=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||null!=this.currentRenderer)?this.owner.getRenderingInfo(h,this.currentRenderer,this._arcadeOnDemand):{symbol:h.symbol||Be(h.geometry)},null==(null==c?void 0:c.symbol)?(n&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,n.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):c}_getRenderingInfoAsync(t,n){if(null==t.geometry)return this._geometryWarningLogged||(this._geometryWarningLogged=!0,M.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&null!=t.symbol)return this._symbolWarningLogged||(this._symbolWarningLogged=!0,M.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const l=this.rendererHasGeometryOperations?ke(t,this.layer):t;return this.owner.getRenderingInfoAsync(l,this.currentRenderer,this._arcadeOnDemand,n)}_createGraphics3DSymbol(t,n){if(!this._hasValidSymbolCreationContext(t))return null;const h=this._getConvertedSymbol(t);if(!h)return null;let c;if(null!=n&&"backgroundFillSymbol"in n&&n.backgroundFillSymbol){const t=l(n.backgroundFillSymbol,{ignoreDrivers:!0});null!=t.symbol&&(c=t.symbol.symbolLayers)}const p=function t$1(t,n,l){return"point-3d"===t.type?new Ct(t,n,l):new w(t,n,l)}(h,this.symbolCreationContext,c);return p.load((()=>{const t=p.extentPadding;t>this.extentPadding&&this._set("extentPadding",t),this.notifyChange("averageSymbolComplexity")}),(()=>{})),p}getOrCreateGraphics3DSymbol(t,n){let l=this._symbols.get(t.id);if(void 0===l){const h=this._unusedSymbolsCache.pop(t.id);l=null!=h?h:t instanceof Ne?new qe(t,(t=>this._dataUpdateQueue.push(t,null)),(t=>this._createGraphics3DSymbol(t,n))):this._createGraphics3DSymbol(t,n),this._symbols.set(t.id,l),this._symbolMaterials=null}return null!=l&&++l.referenced,l}trackGraphicState(t){return null==this._graphicStateTracking&&(this._graphicStateTracking=new wt(this)),this._graphicStateTracking.add(t)}_addGraphics3DGraphic(t){this._usedMemory+=t.usedMemory,this.graphics3DGraphics.set(t.graphic.uid,t),this._numberOfGraphics++,t.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_removeGraphics3DGraphic(t,n,l=!1){this._usedMemory-=n,this.graphics3DGraphics.delete(t),this._numberOfGraphics--,l&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_createGraphics3DGraphic(t,n){var l,h,c;const p=n.graphic;if(this._graphicsWithoutSymbol.delete(p.uid),!this._symbols.has(t.symbol.id))return this.add([p]),null;if(this.graphics3DGraphics.has(p.uid))return null;const _=t.createGraphics3DGraphic(n);if(null==_)return null;this._addGraphics3DGraphic(_);const m=t.symbol.id;if(this._graphicsBySymbol.has(m)||this._graphicsBySymbol.set(m,new Map),this._graphicsBySymbol.get(m).set(p.uid,_),_.isDraped&&this._graphicsDrapedUids.add(p.uid),_.centroid=null,null!=p.geometry&&"point"!==p.geometry.type&&(_.centroid=Ye(p.geometry,this._viewSpatialReference)),this._updateUserVisibility(_),null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(_),null!=this._filterVisibility){const{defaultVisibility:t}=this._filterVisibility;_.setVisibilityFlag(te.GRAPHIC,ie.FILTER,t),t||this._filterVisibility.reapply()}null==(l=this._deconflictor)||l.addGraphic(_),null==(h=this._labeler)||h.addGraphic(_),null==(c=this._objectStates)||c.addGraphic(_),_.initialize(this.stageLayer,this.owner),null!=this._graphicStateTracking&&this._graphicStateTracking.addGraphic(_);const b=this._whenGraphics3DGraphicRequests[p.uid];return b&&(delete this._whenGraphics3DGraphicRequests[p.uid],b.resolve(_)),this._symbolMaterials=null,_}_abortRendererChange(){this._rendererChangeAbortController&&(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null)}async rendererChange(t){if(this._abortRendererChange(),t!==this.currentRenderer)if(this._validateRenderer(t),null==t&&this._currentRendererChange(null,!1),t$2(t))if(null==t?void 0:t.arcadeRequired){const n=new AbortController;this._rendererChangeAbortController=n;const{arcadeUtils:l}=await this._ensureArcade();I(n);const h=l.hasGeometryOperations(t);h&&(await l.enableGeometryOperations(),I(n)),this.effectiveUpdatePolicy===q.ASYNC?await this._updateQueue.push((()=>this._currentRendererChange(t,h)),n.signal):this._currentRendererChange(t,h),this._rendererChangeAbortController=null}else if(this.effectiveUpdatePolicy===q.ASYNC){const n=new AbortController;this._rendererChangeAbortController=n,await this._updateQueue.push((()=>this._currentRendererChange(t,!1)),n.signal),this._rendererChangeAbortController=null}else this._currentRendererChange(t,!1);else this._currentRendererChange(t,!1)}async _ensureArcade(){return null==this._arcadeOnDemand?(this._arcadeOnDemand=await $e(),this._arcadeOnDemand):this._arcadeOnDemand}_currentRendererChange(t,n){var l;this.currentRenderer=t,this.rendererHasGeometryOperations=n,this.symbolCreationContext.arcade=this._arcadeOnDemand;const h=this.symbolCreationContext.renderer;if(t===h)return;if(this._symbolConversionCache.clear(),this._unusedSymbolsCache.clear(),null==t)return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();const c=Ie(h,t);this._updateUnchangedSymbolMappings(c,t,h),this.symbolCreationContext.renderer=t,null!=c&&("complete"===c.type?this.recreateAllGraphicsAndSymbols():"partial"===c.type&&(this._applyRendererDiff(c,t,h)?null==(l=this._labeler)||l.reset():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}_diffHasSymbolChange(t){for(const n in t.diff)switch(n){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"uniqueValueGroups":case"authoringInfo":case"fieldDelimiter":delete t.diff[n];break;default:return!0}return!1}_applySymbolSetDiff(t,n,l){var h,c;t=t||[],n=n||[];const p=[];for(const _ of n){const n=this._graphicsBySymbol.get(_.id);n&&n.forEach(((h,c)=>{const m=h.graphic,b=this.layer instanceof Qe?this.layer:null,f=this._arcadeOnDemand;if(_===l.defaultSymbol&&l.getSymbol(ke(m,b),{arcade:f})===l.defaultSymbol)return;const v=h.usedMemory;t.length||l.defaultSymbol?p.push(m):this._graphicsWithoutSymbol.set(c,m);const S=this.graphics3DGraphics.get(c);this._conditionalRemove(S,c),h.destroy(),n.delete(c),this._removeGraphics3DGraphic(c,v),this._updateLayerVisibility()})),this._whenSymbolRemoved.forAll((t=>t(_.id)))}(t.length||p.length)&&(this._graphicsWithoutSymbol.forEach((t=>p.push(t))),this._graphicsWithoutSymbol.clear(),this.add(p)),this._cleanupSymbols(),null==(h=this._labeler)||h.setDirty(),null==(c=this._deconflictor)||c.setDirty()}_applyUniqueValueRendererDiff(t,n,l){const c=t.diff.defaultSymbol,p=t.diff.uniqueValueInfos;if(c||p){const _=p?p.added.map((t=>t.symbol)).filter(h):[],m=p?p.removed.map((t=>t.symbol)).filter(h):[];if(p)for(let t=0;t<p.changed.length;t++)_.push(p.changed[t].newValue.symbol),m.push(p.changed[t].oldValue.symbol);return c?(l.defaultSymbol&&m.push(l.defaultSymbol),n.defaultSymbol&&_.push(n.defaultSymbol)):l.defaultSymbol&&_.length&&m.push(n.defaultSymbol),this._applySymbolSetDiff(_,m,n),delete t.diff.defaultSymbol,delete t.diff.uniqueValueInfos,!0}return!1}_calculateUnchangedSymbolMapping(t,n,l){var h;if("unique-value"!==(null==n?void 0:n.type)||"unique-value"!==(null==l?void 0:l.type)||null!=t&&"partial"!==t.type)return[];const r2=t=>null!=t?t.id:null,c=t&&t.diff,p=null==c?void 0:c.defaultSymbol,_=c&&c.uniqueValueInfos;let m;if(_)m=_.unchanged.map((t=>({oldId:r2(t.oldValue.symbol),newId:r2(t.newValue.symbol)})));else{m=[];for(const t of l.uniqueValueInfos??[]){const l=r2(t.symbol),c=null==(h=n.uniqueValueInfos)?void 0:h.find((n=>n.value===t.value));c&&l!==r2(c.symbol)&&m.push({oldId:l,newId:r2(c.symbol)})}}return!p&&l.defaultSymbol&&m.push({oldId:r2(l.defaultSymbol),newId:r2(n.defaultSymbol)}),m}_updateSymbolMapping(t,n){const l=null!=n&&n?"string"==typeof n?n:n.id:null;if(null==t||t===l)return;const h=this._graphicsBySymbol.get(t);this._graphicsBySymbol.delete(t),void 0!==h&&this._graphicsBySymbol.set(l,h);const c=this._symbols.get(t);if(void 0!==c&&(this._symbols.delete(t),this._symbols.set(l,c),this._symbolMaterials=null,null!=c)){const t="string"==typeof n?null:n;null!=t?c.symbol=t:c.symbol.id=l}}_updateUnchangedSymbolMappings(t,n,l){const h=this._calculateUnchangedSymbolMapping(t,n,l);for(const{oldId:c,newId:p}of h)this._updateSymbolMapping(c,p)}_applyRendererDiff(t,n,l){if(this._diffHasSymbolChange(t))return!1;if(n instanceof Ze&&l instanceof Ze&&this._applyUniqueValueRendererDiff(t,n,l)&&0===Object.keys(t.diff).length)return!0;for(const[h]of this._graphicsBySymbol){const l=this._symbols.get(h);if(null!=l)switch(l.applyRendererDiff(t,n)){case Xe.RecreateSymbol:this._recreateSymbol(h);break;case Xe.RecreateGraphics:this._recreateGraphicsForSymbol(h);case Xe.FastUpdate:}}return!0}opacityChange(){this.forEachGraphics3DSymbol(((t,n)=>t.globalPropertyChanged("opacity",n))),this._updateStageLayerVisibility()}_slicePlaneEnabledChange(t){var n,l;t!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=t,this.stageLayer.sliceable=t,this.forEachGraphics3DSymbol(((t,n)=>t.globalPropertyChanged("slicePlaneEnabled",n))),null==(n=this._deconflictor)||n.slicePlaneEnabledChange(),null==(l=this._labeler)||l.slicePlaneEnabledChange())}_physicalBasedRenderingChange(t){this.symbolCreationContext.physicalBasedRenderingEnabled=t,this.forEachGraphics3DSymbol(((t,n,l)=>{t.globalPropertyChanged("physicalBasedRenderingEnabled",n)||this._recreateSymbol(l)}))}_skipHighSymbolLoDsChange(t){this.symbolCreationContext.skipHighSymbolLods=t,this.forEachGraphics3DSymbol(((t,n,l)=>{t.globalPropertyChanged("skipHighSymbolLods",n)||this._recreateSymbol(l)}))}_pixelRatioChange(){this.forEachGraphics3DSymbol(((t,n,l)=>{t.globalPropertyChanged("pixelRatio",n)||this._recreateSymbol(l)}))}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=Je((()=>{this._updatingPendingLoadedGraphicsChange=null}))}setClippingExtent(t,n){const l=this.symbolCreationContext.clippingExtent,h=Ke();return et(t,h,n)?this.symbolCreationContext.clippingExtent=L(c(),h):this.symbolCreationContext.clippingExtent=null,!tt(this.symbolCreationContext.clippingExtent,l)}modifyGraphics3DGraphicVisibilities(t){var n,l;if(this.destroyed)return;let h=!1;this.graphics3DGraphics.forEach((n=>{t(n)&&(h=!0)})),h&&(null==(n=this._labeler)||n.setDirty(),null==(l=this._deconflictor)||l.setDirty())}forEachGraphics3DSymbol(t){for(const[n,l]of this._symbols){if(null==l)return;t(l,this._graphicsBySymbol.get(n)||Bt,n)}}updateAllGraphicsVisibility(){null!=this._filterVisibility&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities((t=>{const n=this._updateUserVisibility(t),l=null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(t);return n||l}))}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities((t=>t.setVisibilityFlag(te.GRAPHIC,ie.USER,!1)))}_validateRenderer(t){var n;const t2=()=>`'${this.layer.title?`${this.layer.title}, `:""}id:${this.layer.id}'`,l=s$3(t,{geometryType:null==(n=this.layer)?void 0:n.geometryType,logWarning:t=>M.getLogger(this).warn(`Symbology conversion for layer ${t2()}: ${t}`)});if(l){const t=`Renderer for layer ${t2} is not supported in a SceneView`;M.getLogger(this).warn(t,l.message)}}_cleanupSymbols(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let t=!1;this._symbols.forEach(((n,l)=>{if(null==n||n.referenced>0)return;const h=this._graphicsBySymbol.get(l);h&&0!==h.size||(this._graphicsBySymbol.delete(l),this._symbols.delete(l),this._symbolMaterials=null,this._unusedSymbolsCache.put(l,n,function r$1(t){return 2216+4096*t.symbolLayers.length+t.complexity.memory.resourceBytes}(n),it),t=!0)})),t&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}get test(){}get performanceInfo(){return new Gt(this.graphics3DGraphics.size,this._graphicsWithoutSymbol.size,this._pendingUpdates.size)}};var Tt,Mt;jt.tmpVec=W(),p([_({readOnly:!0})],jt.prototype,"computedExtent",void 0),p([_()],jt.prototype,"currentRenderer",void 0),p([_()],jt.prototype,"rendererHasGeometryOperations",void 0),p([_()],jt.prototype,"_frameTaskHandle",void 0),p([_()],jt.prototype,"_dataUpdateQueue",void 0),p([_()],jt.prototype,"_updateQueue",void 0),p([_({readOnly:!0})],jt.prototype,"_viewSpatialReference",null),p([_()],jt.prototype,"_rendererChangeAbortController",void 0),p([_()],jt.prototype,"_elevationInfoChangeAbortController",void 0),p([_()],jt.prototype,"_initializeAbortController",void 0),p([_()],jt.prototype,"_elevationAlignment",void 0),p([_()],jt.prototype,"_scaleVisibility",void 0),p([_()],jt.prototype,"_filterVisibility",void 0),p([_()],jt.prototype,"_initializePromise",void 0),p([_()],jt.prototype,"_spatialIndex",void 0),p([_({readOnly:!0})],jt.prototype,"extentPadding",void 0),p([_()],jt.prototype,"_updatingPendingLoadedGraphicsChange",void 0),p([_()],jt.prototype,"_featureStore",void 0),p([_()],jt.prototype,"_objectStates",void 0),p([_()],jt.prototype,"_loadingSymbols",void 0),p([_()],jt.prototype,"preferredUpdatePolicy",void 0),p([_()],jt.prototype,"_forcedUpdatePolicy",void 0),p([_({readOnly:!0})],jt.prototype,"effectiveUpdatePolicy",null),p([_({constructOnly:!0})],jt.prototype,"elevationFeatureExpressionEnabled",void 0),p([_({constructOnly:!0})],jt.prototype,"owner",void 0),p([_({constructOnly:!0})],jt.prototype,"layer",void 0),p([_({constructOnly:!0})],jt.prototype,"graphicSymbolSupported",void 0),p([_({constructOnly:!0})],jt.prototype,"getRenderingInfoWithoutRenderer",void 0),p([_({constructOnly:!0})],jt.prototype,"componentFactories",void 0),p([_({constructOnly:!0})],jt.prototype,"setUidToIdOnAdd",void 0),p([_()],jt.prototype,"featureStore",null),p([_()],jt.prototype,"initializePromise",null),p([_()],jt.prototype,"scaleVisibility",null),p([_()],jt.prototype,"elevationAlignment",null),p([_()],jt.prototype,"objectStates",null),p([_()],jt.prototype,"filterVisibility",null),p([_({readOnly:!0})],jt.prototype,"updating",null),p([_({readOnly:!0})],jt.prototype,"dataUpdating",null),p([_({readOnly:!0})],jt.prototype,"running",null),p([_({readOnly:!0})],jt.prototype,"suspendedOrOutsideOfView",null),p([_({readOnly:!0,dependsOn:[]})],jt.prototype,"updatingRemaining",null),p([_({readOnly:!0})],jt.prototype,"displayFeatureLimit",null),p([_({readOnly:!0,dependsOn:[]})],jt.prototype,"averageSymbolComplexity",null),p([_({constructOnly:!0})],jt.prototype,"hasZ",void 0),p([_({constructOnly:!0})],jt.prototype,"hasM",void 0),p([_()],jt.prototype,"_objectIdField",null),jt=Ut=p([m("esri.views.3d.layers.graphics.Graphics3DCore")],jt),(Mt=Tt||(Tt={}))[Mt.NEW=0]="NEW",Mt[Mt.LOADING=1]="LOADING",Mt[Mt.READY=2]="READY",Mt[Mt.REJECTED=3]="REJECTED";class We{constructor(){this.add=null,this.renderingInfo=null,this.state=Tt.NEW,this.abortController=null,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=Tt.NEW,this.abortController=null,this.remove=null}}const zt=10,Ht=W(),kt=W(),Bt=new Map;let Nt=class u extends b{constructor(t){super(t),this._scaleRangeActive=!1,this._layerScaleRangeVisibilityQuery=!1,this._extent=null,this._updatingHandles=new rt,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this._dirty=!0}initialize(){this.updateScaleRangeActive();const t=this.graphicsCoreOwner.view.resourceController.scheduler;this.addHandles(t.registerTask(pe.SCALE_VISIBILITY,this)),this._updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this.layerMinMaxScaleChangeHandler()))}destroy(){this._updatingHandles.destroy(),this.removeHandles(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}get updating(){return this._dirty||this._updatingHandles.updating}_setDirty(){this._dirty=!0}setExtent(t){const n=this.graphicsCoreOwner.view.spatialReference,l=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(n===l)this._extent=t??null;else{const h=Ke();at(t,n,h,l)?this._extent=h:this._extent=null}this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const t=this.layer,n=t.effectiveScaleRange;let l=this.layerScaleEnabled&&null!=n&&g(n.minScale,n.maxScale);t.labelingInfo&&!l&&(l=t.labelingInfo.some((t=>t&&g(t.minScale??0,t.maxScale??0))));const h=this._scaleRangeActive!==l;return this._scaleRangeActive=l,l&&!this.hasHandles(Wt)&&this.basemapTerrain?(this.addHandles(this.basemapTerrain.on("scale-change",(t=>this._scaleUpdateHandler(t))),Wt),this.layerScaleEnabled&&this.addHandles(this.basemapTerrain.on("tiles-visibility-changed",(()=>this._setDirty())),Wt)):!l&&this.hasHandles(Wt)&&this.removeHandles(Wt),h}get running(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(t){const n=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&n&&n.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return _e;{this._layerScaleRangeVisibilityQuery=!0;const{minScale:t,maxScale:l}=this.layer.effectiveScaleRange;n.queryVisibleScaleRange(this._extent,t,l,(t=>this._finishUpdate(t)))}}else this._finishUpdate(!0);t.madeProgress()}_finishUpdate(t){this._layerScaleRangeVisibilityQuery=!1,this._set("suspended",!t),this._dirty=!1}_visibleAtLayerScale(t){const n=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||nt(t,n.minScale||0,n.maxScale||0)}_visibleAtLabelScale(t,n){return nt(t,n.minScale||0,n.maxScale||0)}_graphicScale(t){let n;return null!=t.centroid?n=t.centroid:null!=t.graphic.geometry&&"point"===t.graphic.geometry.type&&(n=t.graphic.geometry),n?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(n):1:null}_graphicVisible(t){if(!this.layerScaleEnabled)return!0;const n=this._graphicScale(t);return this._visibleAtLayerScale(n)}updateVisibility(t){if(this._scaleRangeActive){const n=this._graphicVisible(t);return t.setVisibilityFlag(te.GRAPHIC,ie.SCALE_RANGE,n)}return!1}updateGraphicLabelScaleVisibility(t){var n,l;if(!this._scaleRangeActive)return!1;if(!t.labelLayers||0===t.labelLayers.length)return!1;const h=this._graphicScale(t),c=this._updateLabelScaleVisibility(t,h);return c&&(null==(n=this.graphicsCore.deconflictor)||n.setDirty(),null==(l=this.graphicsCore.labeler)||l.setDirty()),c}_updateLabelScaleVisibility(t,n){if(!t.labelLayers||0===t.labelLayers.length)return!1;const l=t.labelLayers[0]._labelClass;if(null!=(null==l?void 0:l.minScale)&&null!=l.maxScale){const h=this._visibleAtLabelScale(n,l);if(t.setVisibilityFlag(te.LABEL,ie.SCALE_RANGE,h))return!0}return!1}_scaleUpdateHandler(t){var n,l;if(this._setDirty(),!this.graphicsCore.visible)return;const h=t.extent,c=t.scale,p=this._visibleAtLayerScale(c);let _=!1;const m=this.graphicsCoreOwner.view.spatialReference,b=t.spatialReference;if(null==b)return void M.getLogger(this).error("scaleUpdate: Internal error, no SpatialReference given for tiles");const f=!b.equals(m);if(f&&!at(h,b,qt,m))return void M.getLogger(this).error("scaleUpdate: Internal error, cannot project AABR from "+b+" to wkid "+m);const v=f?qt:h;this.queryGraphicUIDsInExtent(v,m,(t=>{const n=this.graphicsCore.getGraphics3DGraphicById(t);if(null==n)return;const l=n.centroid;null!=l&&(h[0]>l.x||h[1]>l.y||h[2]<l.x||h[3]<l.y)||(n.setVisibilityFlag(te.GRAPHIC,ie.SCALE_RANGE,p)&&(_=!0),this._updateLabelScaleVisibility(n,c)&&(_=!0))})),_&&(null==(n=this.graphicsCore.deconflictor)||n.setDirty(),null==(l=this.graphicsCore.labeler)||l.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((t=>t.setVisibilityFlag(te.GRAPHIC,ie.SCALE_RANGE,!0))):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()}};function g(t,n){return t>0||n>0}p([_()],Nt.prototype,"graphicsCoreOwner",void 0),p([_()],Nt.prototype,"layer",void 0),p([_()],Nt.prototype,"queryGraphicUIDsInExtent",void 0),p([_()],Nt.prototype,"graphicsCore",void 0),p([_()],Nt.prototype,"basemapTerrain",void 0),p([_({constructOnly:!0})],Nt.prototype,"layerScaleEnabled",void 0),p([_({readOnly:!0})],Nt.prototype,"suspended",void 0),p([_({readOnly:!0})],Nt.prototype,"updating",null),p([_()],Nt.prototype,"_dirty",void 0),Nt=p([m("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],Nt);const Wt="terrain-events",qt=Ke();let Yt=class a{constructor(){this._extents=new K({allocator:t=>t||Ke()}),this._tmpExtent=Ke(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(t){this._contains(t)||(this._removeContained(t),lt(this._extents.pushNew(),t),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(t){return this._mergeTight(t),t.hasProgressed}_mergeTight(t=ce){const n=this._extents,l=new Set;let h=0;for(;h!==n.length;){n.sort(((t,n)=>t[0]-n[0])),h=n.length,l.clear();for(let h=0;h<n.length;++h){if(t.done)return;const c=n.at(h);if(c){for(let t=h+1;t<n.length;++t){const h=n.at(t);if(null==h||h[0]>=c[2])break;l.add(h)}l.forEach((h=>{if(c===h)return;if(h[2]<=c[0])return void l.delete(h);const p=ot(c),_=ot(h),m=this._tmpExtent;ht(c,h,m);const b=p+_;(ot(m)-b)/b<.05&&(lt(c,m),l.delete(h),n.remove(h),t.madeProgress())})),l.add(c)}}}this._dirty=!1}_contains(t){return this._extents.some((n=>dt(n,t)))}_removeContained(t){this._extents.filterInPlace((n=>!dt(t,n)))}get test(){}},$t=class extends b{constructor(t){super(t),this._dirtyExtents=new Yt,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new f}initialize(){var t;const n=this.elevationProvider,l=this.graphicsCoreOwner.view.resourceController.scheduler;this._task=l.registerTask(d2(null==(t=this.graphicsCore.layer.elevationInfo)?void 0:t.mode),this),this.addHandles([n.on("elevation-change",(t=>this._elevationChanged(t))),le((()=>this.graphicsCoreOwner.suspended),(()=>this._suspendedChange())),this._task,le((()=>{var t;return d2(null==(t=this.graphicsCore.layer.elevationInfo)?void 0:t.mode)}),(t=>this._task.priority=t))])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(t){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,t.madeProgress()),t.run((()=>this._dirtyExtents.merge(t)));this.running&&!t.done;)this._updateDirtyGraphics(t),this._updateDirtyExtents(t);this.notifyChange("updating")}_updateDirtyGraphics(t){var n;const l=this.graphicsCoreOwner.view.renderCoordsHelper,h=this.graphicsCore.effectiveUpdatePolicy===q.ASYNC;for(const c of this._dirtyGraphicsSet.keys()){const p=this.graphicsCore.getGraphics3DGraphicById(c);if(this._dirtyGraphicsSet.delete(c),null!=p&&(p.alignWithElevation(this.elevationProvider,l,h),null==(n=this.graphicsCore.deconflictor)||n.setDirty(),t.madeProgress()),t.done)return}}_updateDirtyExtents(t){for(;!this._dirtyExtents.empty&&!t.done;){const n=this._dirtyExtents.pop(),l=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:n,spatialReference:l});const h=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(n,l,(t=>{const n=this.graphicsCore.getGraphics3DGraphicById(t);null!=n&&n.needsElevationUpdates()&&this._dirtyGraphicsSet.add(t)})),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-h)+.9*this._averageExtentUpdateSize,t.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((t,n)=>this._dirtyGraphicsSet.add(n)))}_elevationChanged(t){if("scene"===t.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const n=t.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const t=this.graphicsCore.computedExtent;t&&n[2]>t.xmin&&n[0]<t.xmax&&n[3]>t.ymin&&n[1]<t.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",t)}else n[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(n),this.notifyChange("updating")}};function d2(t){return null==t?pe.ELEVATION_ALIGNMENT:"relative-to-scene"===t?pe.ELEVATION_ALIGNMENT_SCENE:pe.ELEVATION_ALIGNMENT}p([_()],$t.prototype,"graphicsCoreOwner",void 0),p([_()],$t.prototype,"graphicsCore",void 0),p([_()],$t.prototype,"queryGraphicUIDsInExtent",void 0),p([_()],$t.prototype,"elevationProvider",void 0),p([_({readOnly:!0})],$t.prototype,"updating",null),p([_({readOnly:!0})],$t.prototype,"updatingRemaining",null),$t=p([m("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],$t);let Qt=class extends b{constructor(t){super(t),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){const{graphicsCoreOwner:t}=this;this._extentIntersection=new ct({renderCoordsHelper:t.view.renderCoordsHelper});const n=t.view,l=n.basemapTerrain,h=n.resourceController.scheduler;this.addHandles([n.on("resize",(()=>this._viewChange())),le((()=>n.state.camera),(()=>this._viewChange()),pt),h.registerTask(pe.FRUSTUM_VISIBILITY,this),le((()=>l.visibleElevationBounds),(()=>this._elevationBoundsChange()))]),"local"===n.viewingMode?this._isVisibleBelowSurface=!0:this.addHandles([le((()=>{var t,h,c;return[l.baseOpacity,l.wireframe,null==(c=null==(h=null==(t=n.map)?void 0:t.ground)?void 0:h.navigationConstraint)?void 0:c.type]}),(()=>this._updateIsVisibleBelowSurface()),ut)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(t){this._extent=t,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(t){this._isVisibleBelowSurfaceInternal=t,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){var t,n;const l=this.graphicsCoreOwner.view,h=l.basemapTerrain,c="local"===l.viewingMode,p="none"===(null==(n=null==(t=l.map.ground)?void 0:t.navigationConstraint)?void 0:n.type);this._isVisibleBelowSurface=c||!h.opaque||p}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const t=this.graphicsCoreOwner.view;let n;if(this._isVisibleBelowSurfaceInternal)n=-.3*yt(t.spatialReference).radius;else{const{min:l,max:h}=t.basemapTerrain.visibleElevationBounds;n=l-Math.max(1,(h-l)*(1.2-1))}this._extentIntersection.update(this._extent,t.spatialReference,n)}get running(){return this.updating}runTask(t){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),_e;this._updateExtentIntersection();const n=this.graphicsCoreOwner.view.frustum,l=yt(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(n,l)),t.madeProgress()}};var Zt;p([_({readOnly:!0})],Qt.prototype,"suspended",void 0),p([_({constructOnly:!0})],Qt.prototype,"graphicsCoreOwner",void 0),p([_({readOnly:!0})],Qt.prototype,"updating",void 0),Qt=p([m("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],Qt),function(t){t[t.Object=0]="Object",t[t.RenderGeometry=1]="RenderGeometry",t[t.External=2]="External",t[t.COUNT=3]="COUNT"}(Zt||(Zt={}));class r{constructor(){this._items=[]}addObject(t,n){this._items.push({type:Zt.Object,objectStateId:n,object:t})}addRenderGeometry(t,n,l){this._items.push({type:Zt.RenderGeometry,objectStateId:n,renderGeometry:t,owner:l})}addExternal(t,n){this._items.push({type:Zt.External,objectStateId:n,remove:t})}remove(t){for(let n=this._items.length-1;n>=0;--n){const l=this._items[n];l.objectStateId===t&&(o(l),this._items.splice(n,1))}}removeObject(t){for(let n=this._items.length-1;n>=0;--n){const l=this._items[n];l.type===Zt.Object&&l.object===t&&(o(l),this._items.splice(n,1))}}removeRenderGeometry(t){for(let n=this._items.length-1;n>=0;--n){const l=this._items[n];l.type===Zt.RenderGeometry&&l.renderGeometry===t&&(o(l),this._items.splice(n,1))}}removeAll(){this._items.forEach((t=>{o(t)})),this._items=[]}}function o(t){switch(t.type){case Zt.Object:t.objectStateId.channel===gt.Highlight?t.object.removeHighlight(t.objectStateId):t.objectStateId.channel===gt.MaskOccludee&&t.object.removeOcclude(t.objectStateId);break;case Zt.RenderGeometry:t.owner.removeRenderGeometryObjectState(t.renderGeometry,t.objectStateId);break;case Zt.External:t.remove(t.objectStateId)}}class e3{constructor(t,n){this.stateType=t,this.objectIdField=n,this.objectStateSet=new r,this.ids=new Set,this.paused=!1}hasGraphic(t){if(this.objectIdField){const n=t.graphic.attributes[this.objectIdField];return this.ids.has(n)}return this.ids.has(t.graphic.uid)}}class s3{constructor(t){this._graphicsCore=t,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach((t=>t.objectStateSet.removeAll())),this._stateSets.length=0)}acquireSet(t,n){const l=new e3(t,n);this._stateSets.push(l);const h=P((()=>this.releaseSet(l)));return{set:l,handle:h}}releaseSet(t){t.objectStateSet.removeAll();const n=this._stateSets?this._stateSets.indexOf(t):-1;-1!==n&&this._stateSets.splice(n,1)}setUid(t,n){t.ids.add(n);const l=this._graphicsCore.graphics3DGraphics.get(n);l&&a2(l,t)}setUids(t,n){n.forEach((n=>this.setUid(t,n)))}setObjectIds(t,n){n.forEach((n=>t.ids.add(n))),this._initializeSet(t)}addGraphic(t){this._stateSets.forEach((n=>{!n.paused&&n.hasGraphic(t)&&a2(t,n)}))}removeGraphic(t){this._stateSets.forEach((n=>{n.hasGraphic(t)&&function i(t,n){t.removeObjectState(n.objectStateSet)}(t,n)}))}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach((t=>t.objectStateSet.removeAll()))}_initializeSet(t){const n=this._graphicsCore.graphics3DGraphics;t.objectIdField?n.forEach((n=>{n&&t.hasGraphic(n)&&a2(n,t)})):t.ids.forEach((l=>{const h=n.get(l);h&&a2(h,t)}))}get test(){}}function a2(t,n){t.addObjectStateSet(n.stateType,n.objectStateSet)}export{Qt as a,Yt as b,Gt as c,bt as e,$t as p,s3 as s,Nt as u,jt as z};
