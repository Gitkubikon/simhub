const __vite__fileDeps=["assets/calcite-button-BNKeIR-C.js","assets/index-DSIPxOWi.js","assets/index-B_7YxLDX.css","assets/form-BR8JUNQO.js","assets/dom-CG95YN3b.js","assets/guid-DBupVat2.js","assets/interactive-Dv2N9_bt.js","assets/label-B0K2ZKoz.js","assets/component-BaDXbCam.js","assets/loadable-TuT7-EDA.js","assets/t9n-Dkvwz2Wg.js","assets/key-Bjfr4614.js","assets/observers-4D3dvPBC.js","assets/icon-DN35inCc.js","assets/loader-DnD0exo2.js","assets/calcite-input-Ch73Rboo.js","assets/input2-FN40mhAY.js","assets/calcite-label-DNI5l2NF.js","assets/calcite-modal-yg3DDtmz.js","assets/conditionalSlot-CDvqoXHX.js","assets/focusTrapComponent-BWL-aVr7.js","assets/openCloseComponent-DPRdqyP2.js","assets/scrim-DRbAIrdV.js","assets/calcite-notice-B5LcMWxf.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{e as t,y as s,nb as i,a as n,nc as o,nd as a,_ as l,ne as h,nf as c,bk as d,bc as u,ng as p,ej as _,eX as f,hm as v,b as g,c as m,fL as w,jc as I,bZ as S,nh as y,ni as k,nj as A,es as U,nk as T,g5 as x,jf as O,nl as P,aB as b,fy as D,fz as j,jP as E,nm as N}from"./index-DSIPxOWi.js";import{s as V}from"./substitute-DBNnxKeF.js";const L="esri-identity-modal",z={base:L,info:`${L}__info`,notice:`${L}__notice`};let M=class extends o{constructor(t,s){super(t,s),this.container=document.createElement("div"),this.error=null,this.oAuthPrompt=!1,this.open=!1,this.signingIn=!1,this.server=null,this.resource=null,this._usernameInputNode=null,this._passwordInputNode=null,document.body.appendChild(this.container)}loadDependencies(){return a({button:()=>l((()=>import("./calcite-button-BNKeIR-C.js")),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14])),input:()=>l((()=>import("./calcite-input-Ch73Rboo.js")),__vite__mapDeps([15,16,1,2,4,5,3,6,11,7,8,9,10,12,13])),label:()=>l((()=>import("./calcite-label-DNI5l2NF.js")),__vite__mapDeps([17,1,2,7,4,5,8])),modal:()=>l((()=>import("./calcite-modal-yg3DDtmz.js")),__vite__mapDeps([18,1,2,19,12,4,5,20,9,21,10,11,8,13,14,22])),notice:()=>l((()=>import("./calcite-notice-B5LcMWxf.js")),__vite__mapDeps([23,1,2,19,12,4,5,9,10,11,21,8,13]))})}get title(){var t;return null==(t=this.commonMessages)?void 0:t.auth.signIn}render(){var t;const{open:s,title:i,messages:n,signingIn:o,oAuthPrompt:a,server:l,resource:d,error:u}=this,{info:p,oAuthInfo:_,lblItem:f,invalidUser:v,noAuthService:g,lblUser:m,lblPwd:w,lblCancel:I,lblSigning:S,lblOk:y}=n;return h("div",{class:this.classes(z.base,c())},h("form",{bind:this,onsubmit:this._submit},h("calcite-modal",{bind:this,open:s,outsideCloseDisabled:!0,scale:"s",widthScale:"s",onCalciteModalClose:this._cancel,onCalciteModalOpen:this._focusUsernameInput},h("div",{slot:"header"},i),h("div",{slot:"content"},h("div",{class:z.info},V(a?_:p,{server:l&&/\.arcgis\.com/i.test(l)?"ArcGIS Online":l,resource:`(${d||f})`})),u?h("calcite-notice",{class:z.notice,icon:"exclamation-mark-triangle",kind:"danger",open:!0},h("div",{slot:"message"},(null==(t=u.details)?void 0:t.httpStatus)?v:g)):null,a?null:[h("calcite-label",null,m,h("calcite-input",{afterCreate:t=>this._usernameInputNode=t,autocomplete:"off",bind:this,name:"username",required:!0,spellcheck:!1,type:"text",value:""})),h("calcite-label",null,w,h("calcite-input",{afterCreate:t=>this._passwordInputNode=t,bind:this,name:"password",required:!0,type:"password",value:""}))]),h("calcite-button",{appearance:"outline",bind:this,onclick:this._cancel,slot:"secondary",type:"button",width:"full"},I),h("calcite-button",{loading:!!o,slot:"primary",type:"submit",width:"full"},o?S:y))))}_focusUsernameInput(){requestAnimationFrame((()=>{var t;null==(t=this._usernameInputNode)||t.setFocus()}))}_cancel(){this._set("signingIn",!1),this.open=!1,this._usernameInputNode&&(this._usernameInputNode.value=""),this._passwordInputNode&&(this._passwordInputNode.value=""),this.emit("cancel")}_submit(t){var s,i;t.preventDefault(),this._set("signingIn",!0);const n=this.oAuthPrompt?{}:{username:null==(s=this._usernameInputNode)?void 0:s.value,password:null==(i=this._passwordInputNode)?void 0:i.value};this.emit("submit",n)}};t([s({readOnly:!0})],M.prototype,"container",void 0),t([s(),i("esri/t9n/common")],M.prototype,"commonMessages",void 0),t([s()],M.prototype,"error",void 0),t([s(),i("esri/identity/t9n/identity")],M.prototype,"messages",void 0),t([s()],M.prototype,"oAuthPrompt",void 0),t([s()],M.prototype,"open",void 0),t([s()],M.prototype,"signingIn",void 0),t([s()],M.prototype,"server",void 0),t([s({readOnly:!0})],M.prototype,"title",null),t([s()],M.prototype,"resource",void 0),M=t([n("esri.identity.IdentityModal")],M);const B=M,F="esriJSAPIOAuth";class e{constructor(t,s){this.oAuthInfo=null,this.storage=null,this.appId=null,this.codeVerifier=null,this.expires=null,this.refreshToken=null,this.ssl=null,this.stateUID=null,this.token=null,this.userId=null,this.oAuthInfo=t,this.storage=s,this._init()}isValid(){let t=!1;if(this.oAuthInfo&&this.userId&&(this.refreshToken||this.token))if(null==this.expires&&this.refreshToken)t=!0;else if(this.expires){const s=Date.now();this.expires>s&&(this.expires-s)/1e3>60*this.oAuthInfo.minTimeUntilExpiration&&(t=!0)}return t}save(){if(!this.storage)return!1;const t=this._load(),s=this.oAuthInfo;if((null==s?void 0:s.authNamespace)&&s.portalUrl){let n=t[s.authNamespace];n||(n=t[s.authNamespace]={}),this.appId||(this.appId=s.appId),n[s.portalUrl]={appId:this.appId,codeVerifier:this.codeVerifier,expires:this.expires,refreshToken:this.refreshToken,ssl:this.ssl,stateUID:this.stateUID,token:this.token,userId:this.userId};try{this.storage.setItem(F,JSON.stringify(t))}catch(i){return!1}return!0}return!1}destroy(){const t=this._load(),s=this.oAuthInfo;if((null==s?void 0:s.appId)&&(null==s?void 0:s.portalUrl)&&(null==this.expires||this.expires>Date.now())&&(this.refreshToken||this.token)){const t=s.portalUrl.replace(/^http:/i,"https:")+"/sharing/rest/oauth2/revokeToken",i=new FormData;if(i.append("f","json"),i.append("auth_token",this.refreshToken||this.token),i.append("client_id",s.appId),i.append("token_type_hint",this.refreshToken?"refresh_token":"access_token"),"function"==typeof navigator.sendBeacon)navigator.sendBeacon(t,i);else{const s=new XMLHttpRequest;s.open("POST",t),s.send(i)}}if((null==s?void 0:s.authNamespace)&&s.portalUrl&&this.storage){const n=t[s.authNamespace];if(n){delete n[s.portalUrl];try{this.storage.setItem(F,JSON.stringify(t))}catch(i){}}}s&&(s._oAuthCred=null,this.oAuthInfo=null)}_init(){const t=this._load(),s=this.oAuthInfo;if((null==s?void 0:s.authNamespace)&&s.portalUrl){let i=t[s.authNamespace];i&&(i=i[s.portalUrl],i&&(this.appId=i.appId,this.codeVerifier=i.codeVerifier,this.expires=i.expires,this.refreshToken=i.refreshToken,this.ssl=i.ssl,this.stateUID=i.stateUID,this.token=i.token,this.userId=i.userId))}}_load(){let t={};if(this.storage){const i=this.storage.getItem(F);if(i)try{t=JSON.parse(i)}catch(s){}}return t}}var $;e.prototype.declaredClass="esri.identity.OAuthCredential";let H=$=class extends d{constructor(t){super(t),this._oAuthCred=null,this.appId=null,this.authNamespace="/",this.expiration=20160,this.flowType="auto",this.forceLogin=!1,this.forceUserId=!1,this.locale=null,this.minTimeUntilExpiration=30,this.popup=!1,this.popupCallbackUrl="oauth-callback.html",this.popupWindowFeatures="height=490,width=800,resizable,scrollbars,status",this.portalUrl="https://www.arcgis.com",this.preserveUrlHash=!1,this.userId=null}clone(){return $.fromJSON(this.toJSON())}};t([s({json:{write:!0}})],H.prototype,"appId",void 0),t([s({json:{write:!0}})],H.prototype,"authNamespace",void 0),t([s({json:{write:!0}})],H.prototype,"expiration",void 0),t([s({json:{write:!0}})],H.prototype,"flowType",void 0),t([s({json:{write:!0}})],H.prototype,"forceLogin",void 0),t([s({json:{write:!0}})],H.prototype,"forceUserId",void 0),t([s({json:{write:!0}})],H.prototype,"locale",void 0),t([s({json:{write:!0}})],H.prototype,"minTimeUntilExpiration",void 0),t([s({json:{write:!0}})],H.prototype,"popup",void 0),t([s({json:{write:!0}})],H.prototype,"popupCallbackUrl",void 0),t([s({json:{write:!0}})],H.prototype,"popupWindowFeatures",void 0),t([s({json:{write:!0}})],H.prototype,"portalUrl",void 0),t([s({json:{write:!0}})],H.prototype,"preserveUrlHash",void 0),t([s({json:{write:!0}})],H.prototype,"userId",void 0),H=$=t([n("esri.identity.OAuthInfo")],H);const J=H;let W=class extends d{constructor(t){super(t),this.adminTokenServiceUrl=null,this.currentVersion=null,this.hasPortal=null,this.hasServer=null,this.owningSystemUrl=null,this.owningTenant=null,this.server=null,this.shortLivedTokenValidity=null,this.tokenServiceUrl=null,this.webTierAuth=null}};t([s({json:{write:!0}})],W.prototype,"adminTokenServiceUrl",void 0),t([s({json:{write:!0}})],W.prototype,"currentVersion",void 0),t([s({json:{write:!0}})],W.prototype,"hasPortal",void 0),t([s({json:{write:!0}})],W.prototype,"hasServer",void 0),t([s({json:{write:!0}})],W.prototype,"owningSystemUrl",void 0),t([s({json:{write:!0}})],W.prototype,"owningTenant",void 0),t([s({json:{write:!0}})],W.prototype,"server",void 0),t([s({json:{write:!0}})],W.prototype,"shortLivedTokenValidity",void 0),t([s({json:{write:!0}})],W.prototype,"tokenServiceUrl",void 0),t([s({json:{write:!0}})],W.prototype,"webTierAuth",void 0),W=t([n("esri.identity.ServerInfo")],W);const G=W,X={},R=t=>{const s=new I(t.owningSystemUrl).host,i=new I(t.server).host,n=/.+\.arcgis\.com$/i;return n.test(s)&&n.test(i)},C=(t,s)=>!!(R(t)&&s&&s.some((s=>s.test(t.server))));let K=null,Y=null;try{K=window.localStorage,Y=window.sessionStorage}catch{}class q extends u{constructor(){super(),this._portalConfig=globalThis.esriGeowConfig,this.serverInfos=[],this.oAuthInfos=[],this.credentials=[],this._soReqs=[],this._xoReqs=[],this._portals=[],this._defaultOAuthInfo=null,this._defaultTokenValidity=60,this.dialog=null,this.tokenValidity=null,this.normalizeWebTierAuth=!1,this._appOrigin="null"!==window.origin?window.origin:window.location.origin,this._appUrlObj=_(window.location.href),this._busy=null,this._rejectOnPersistedPageShow=!1,this._oAuthLocationParams=null,this._gwTokenUrl="/sharing/rest/generateToken",this._agsRest="/rest/services",this._agsPortal=/\/sharing(\/|$)/i,this._agsAdmin=/(https?:\/\/[^/]+\/[^/]+)\/admin\/?(\/.*)?$/i,this._adminSvcs=/\/rest\/admin\/services(\/|$)/i,this._gwDomains=[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:dev|[a-z\d-]+\.mapsdev)\.arcgis\.com/i,customBaseUrl:"mapsdev.arcgis.com",tokenServiceUrl:"https://dev.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:devext|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:"mapsdevext.arcgis.com",tokenServiceUrl:"https://devext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:qaext|[a-z\d-]+\.mapsqa)\.arcgis\.com/i,customBaseUrl:"mapsqa.arcgis.com",tokenServiceUrl:"https://qaext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/[a-z\d-]+\.maps\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"}],this._legacyFed=[],this._regexSDirUrl=/http.+\/rest\/services\/?/gi,this._regexServerType=/(\/(FeatureServer|GPServer|GeoDataServer|GeocodeServer|GeoenrichmentServer|GeometryServer|GlobeServer|ImageServer|KnowledgeGraphServer|MapServer|MissionServer|MobileServer|NAServer|NetworkDiagramServer|OGCFeatureServer|ParcelFabricServer|RelationalCatalogServer|SceneServer|StreamServer|UtilityNetworkServer|ValidationServer|VectorTileServer|VersionManagementServer|VideoServer)).*/gi,this._gwUser=/http.+\/users\/([^/]+).*/i,this._gwItem=/http.+\/items\/([^/]+).*/i,this._gwGroup=/http.+\/groups\/([^/]+).*/i,this._rePortalTokenSvc=/\/sharing(\/rest)?\/generatetoken/i,this._createDefaultOAuthInfo=!0,this._hasTestedIfAppIsOnPortal=!1,this._getPlatformSelfError=null,this._getOAuthLocationParams(),window.addEventListener("pageshow",(t=>{this._pageShowHandler(t)}))}registerServers(t){const s=this.serverInfos;s?(t=t.filter((t=>!this.findServerInfo(t.server))),this.serverInfos=s.concat(t)):this.serverInfos=t,t.forEach((t=>{t.owningSystemUrl&&this._portals.push(t.owningSystemUrl),t.hasPortal&&this._portals.push(t.server)}))}registerOAuthInfos(t){const s=this.oAuthInfos;if(s){for(const i of t){const t=this.findOAuthInfo(i.portalUrl);t&&s.splice(s.indexOf(t),1)}this.oAuthInfos=s.concat(t)}else this.oAuthInfos=t}registerToken(t){t={...t};const s=this._sanitizeUrl(t.server),i=this._isServerRsrc(s);let n,o=this.findServerInfo(s),a=!0;o||(o=new G,o.server=this._getServerInstanceRoot(s),i?o.hasServer=!0:(o.tokenServiceUrl=this._getTokenSvcUrl(s),o.hasPortal=!0),this.registerServers([o])),n=this._findCredential(s),n?(delete t.server,Object.assign(n,t),a=!1):(n=new Q({userId:t.userId,server:o.server??void 0,token:t.token,expires:t.expires,ssl:t.ssl,scope:i?"server":"portal"}),n.resources=[s],this.credentials.push(n)),n.emitTokenChange(!1),a||n.refreshServerTokens()}toJSON(){return p({serverInfos:this.serverInfos.map((t=>t.toJSON())),oAuthInfos:this.oAuthInfos.map((t=>t.toJSON())),credentials:this.credentials.map((t=>t.toJSON()))})}initialize(t){if(!t)return;"string"==typeof t&&(t=JSON.parse(t));const s=t.serverInfos,i=t.oAuthInfos,n=t.credentials;if(s){const t=[];s.forEach((s=>{s.server&&s.tokenServiceUrl&&t.push(s.declaredClass?s:new G(s))})),t.length&&this.registerServers(t)}if(i){const t=[];i.forEach((s=>{s.appId&&t.push(s.declaredClass?s:new J(s))})),t.length&&this.registerOAuthInfos(t)}n&&n.forEach((t=>{t.server&&t.token&&t.expires&&t.expires>Date.now()&&((t=t.declaredClass?t:new Q(t)).emitTokenChange(),this.credentials.push(t))}))}findServerInfo(t){let s;t=this._sanitizeUrl(t);for(const i of this.serverInfos)if(this._hasSameServerInstance(i.server,t)){s=i;break}return s}findOAuthInfo(t){let s;t=this._sanitizeUrl(t);for(const i of this.oAuthInfos)if(this._hasSameServerInstance(i.portalUrl,t)){s=i;break}return s}findCredential(t,s){if(!t)return;let i;t=this._sanitizeUrl(t);const n=this._isServerRsrc(t)?"server":"portal";if(s){for(const o of this.credentials)if(this._hasSameServerInstance(o.server,t)&&s===o.userId&&o.scope===n){i=o;break}}else for(const o of this.credentials)if(this._hasSameServerInstance(o.server,t)&&-1!==this._getIdenticalSvcIdx(t,o)&&o.scope===n){i=o;break}return i}getCredential(t,s){let i,n,o=!0;s&&(i=!!s.token,n=s.error,o=!1!==s.prompt),s={...s},t=this._sanitizeUrl(t);const a=new AbortController,l=f();if(s.signal&&v(s.signal,(()=>{a.abort()})),v(a,(()=>{l.reject(new g("identity-manager:user-aborted","ABORTED"))})),m(a))return l.promise;s.signal=a.signal;const h=this._isAdminResource(t),c=i?this.findCredential(t):null;let d;if(c&&n&&n.details&&498===n.details.httpStatus)c.destroy();else if(c)return d=new g("identity-manager:not-authorized","You are currently signed in as: '"+c.userId+"'. You do not have access to this resource: "+t,{error:n}),l.reject(d),l.promise;const u=this._findCredential(t,s);if(u)return l.resolve(u),l.promise;let p=this.findServerInfo(t);if(p)!p.hasPortal&&p.server&&p.owningSystemUrl&&this._hasSameServerInstance(p.server,p.owningSystemUrl)&&(p.hasPortal=!0),!p.hasServer&&this._isServerRsrc(t)&&(p._restInfoPms=this._getTokenSvcUrl(t),p.hasServer=!0);else{const s=this._getTokenSvcUrl(t);if(!s)return d=new g("identity-manager:unknown-resource","Unknown resource - could not find token service endpoint."),l.reject(d),l.promise;p=new G,p.server=this._getServerInstanceRoot(t),"string"==typeof s?(p.tokenServiceUrl=s,p.hasPortal=!0):(p._restInfoPms=s,p.hasServer=!0),this.registerServers([p])}return p.hasPortal&&void 0===p._selfReq&&(o||w(p.tokenServiceUrl,this._appOrigin)||this._gwDomains.some((t=>t.tokenServiceUrl===p.tokenServiceUrl)))&&(p._selfReq={owningTenant:null==s?void 0:s.owningTenant,selfDfd:this._getPortalSelf(p.tokenServiceUrl.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),t)}),this._enqueue(t,p,s,l,h)}getResourceName(t){return this._isRESTService(t)?t.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(t)&&t.replace(this._gwUser,"$1")||this._gwItem.test(t)&&t.replace(this._gwItem,"$1")||this._gwGroup.test(t)&&t.replace(this._gwGroup,"$1")||""}generateToken(t,s,i){const n=this._rePortalTokenSvc.test(t.tokenServiceUrl),o=new I(this._appOrigin),a=t.shortLivedTokenValidity;let l,h,c,d,u,p,_,f;s&&(f=this.tokenValidity||a||this._defaultTokenValidity,f>a&&a>0&&(f=a)),i&&(l=i.isAdmin,h=i.serverUrl,c=i.token,p=i.signal,_=i.ssl,t.customParameters=i.customParameters),l?d=t.adminTokenServiceUrl:(d=t.tokenServiceUrl,u=new I(d.toLowerCase()),t.webTierAuth&&(null==i?void 0:i.serverUrl)&&!_&&"http"===o.scheme&&(w(o.uri,d,!0)||"https"===u.scheme&&o.host===u.host&&"7080"===o.port&&"7443"===u.port)&&(d=d.replace(/^https:/i,"http:").replace(/:7443/i,":7080")));const v={query:{request:"getToken",username:null==s?void 0:s.username,password:null==s?void 0:s.password,serverUrl:h,token:c,expiration:f,referer:l||n?this._appOrigin:null,client:l?"referer":null,f:"json",...t.customParameters},method:"post",authMode:"anonymous",useProxy:this._useProxy(t,i),signal:p,...null==i?void 0:i.ioArgs};return n||(v.withCredentials=!1),S(d,v).then((i=>{const n=i.data;if(!(null==n?void 0:n.token))return new g("identity-manager:authentication-failed","Unable to generate token");const o=t.server;return X[o]||(X[o]={}),s&&(X[o][s.username]=s.password),n.validity=f,n}))}isBusy(){return!!this._busy}async checkSignInStatus(t){return(await this.checkAppAccess(t,"")).credential}checkAppAccess(t,s,i){let n=!1;return this.getCredential(t,{prompt:!1}).then((o=>{let a;const l={f:"json"};if("portal"===o.scope)if(s&&(this._doPortalSignIn(t)||(null==i?void 0:i.force)))a=o.server+"/sharing/rest/oauth2/validateAppAccess",l.client_id=s;else{if(!o.token)return{credential:o};a=o.server+"/sharing/rest"}else{if(!o.token)return{credential:o};a=o.server+"/rest/services"}return o.token&&(l.token=o.token),S(a,{query:l,authMode:"anonymous"}).then((t=>{if(!1===t.data.valid)throw new g("identity-manager:not-authorized",`You are currently signed in as: '${o.userId}'.`,t.data);return n=!!t.data.viewOnlyUserTypeApp,{credential:o}})).catch((t=>{var s;if("identity-manager:not-authorized"===t.name)throw t;const i=null==(s=t.details)?void 0:s.httpStatus;if(498===i)throw o.destroy(),new g("identity-manager:not-authenticated","User is not signed in.");if(400===i)throw new g("identity-manager:invalid-request");return{credential:o}}))})).then((t=>({credential:t.credential,viewOnly:n})))}setOAuthResponseHash(t){t&&("#"===t.charAt(0)&&(t=t.substring(1)),this._processOAuthPopupParams(y(t)))}setOAuthRedirectionHandler(t){this._oAuthRedirectFunc=t}setProtocolErrorHandler(t){this._protocolFunc=t}signIn(t,s,i={}){const n=f(),o2=()=>{var t;null==a||a.remove(),null==l||l.remove(),null==(t=this.dialog)||t.destroy(),this.dialog=a=l=null},n2=()=>{o2(),this._oAuthDfd=null,n.reject(new g("identity-manager:user-aborted","ABORTED"))};i.signal&&v(i.signal,(()=>{n2()}));const o=new B({open:!0,resource:this.getResourceName(t),server:s.server});this.dialog=o,this.emit("dialog-create");let a=o.on("cancel",n2),l=o.on("submit",(t=>{this.generateToken(s,t,{isAdmin:i.isAdmin,signal:i.signal}).then((o=>{o2();const a=new Q({userId:t.username,server:s.server??void 0,token:o.token,expires:null!=o.expires?Number(o.expires):null,ssl:!!o.ssl,isAdmin:i.isAdmin,validity:o.validity});n.resolve(a)})).catch((t=>{o.error=t,o.signingIn=!1}))}));return n.promise}oAuthSignIn(t,s,i,n){this._oAuthDfd=f();const o=this._oAuthDfd;let a;(null==n?void 0:n.signal)&&v(n.signal,(()=>{const t=this._oAuthDfd&&this._oAuthDfd.oAuthWin_;t&&!t.closed?t.close():this.dialog&&u2()})),o.resUrl_=t,o.sinfo_=s,o.oinfo_=i;const l=i._oAuthCred;if(l.storage&&("authorization-code"===i.flowType||"auto"===i.flowType&&s.currentVersion>=8.4)){let t=crypto.getRandomValues(new Uint8Array(32));a=k(t),l.codeVerifier=a,t=crypto.getRandomValues(new Uint8Array(32)),l.stateUID=k(t),l.save()||(l.codeVerifier=a=null)}else l.codeVerifier=null;let h,c;this._getCodeChallenge(a).then((o=>{const a=!n||!1!==n.oAuthPopupConfirmation;if(!i.popup||!a)return void this._doOAuthSignIn(t,s,i,o);const l=new B({oAuthPrompt:!0,server:s.server,open:!0});this.dialog=l,this.emit("dialog-create"),h=l.on("cancel",u2),c=l.on("submit",(()=>{p2(),this._doOAuthSignIn(t,s,i,o)}))}));const u2=()=>{p2(),this._oAuthDfd=null,o.reject(new g("identity-manager:user-aborted","ABORTED"))},p2=()=>{var t;null==h||h.remove(),null==c||c.remove(),null==(t=this.dialog)||t.destroy(),this.dialog=null};return o.promise}destroyCredentials(){this.credentials&&this.credentials.slice().forEach((t=>{t.destroy()})),this.emit("credentials-destroy")}enablePostMessageAuth(t="https://www.arcgis.com/sharing/rest"){this._postMessageAuthHandle&&this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=A(window,"message",(s=>{var i;if((s.origin===this._appOrigin||s.origin.endsWith(".arcgis.com"))&&"arcgis:auth:requestCredential"===(null==(i=s.data)?void 0:i.type)){const i=s.source;this.getCredential(t).then((t=>{i.postMessage({type:"arcgis:auth:credential",credential:{expires:t.expires,server:t.server,ssl:t.ssl,token:t.token,userId:t.userId}},s.origin)})).catch((t=>{i.postMessage({type:"arcgis:auth:error",error:{name:t.name,message:t.message}},s.origin)}))}}))}disablePostMessageAuth(){this._postMessageAuthHandle&&(this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=null)}_getOAuthLocationParams(){var t,s;let i=window.location.hash;if(i){"#"===i.charAt(0)&&(i=i.substring(1));const s=y(i);let n=!1;if(s.access_token&&s.expires_in&&s.state&&s.hasOwnProperty("username"))try{s.state=JSON.parse(s.state),s.state.portalUrl&&(this._oAuthLocationParams=s,n=!0)}catch{}else if(s.error&&s.error_description&&"access_denied"===s.error&&(n=!0,s.state))try{s.state=JSON.parse(s.state)}catch{}n&&(window.location.hash=(null==(t=s.state)?void 0:t.hash)||"")}let n=window.location.search;if(n){"?"===n.charAt(0)&&(n=n.substring(1));const t=y(n);let i=!1;if(t.code&&t.state)try{t.state=JSON.parse(t.state),t.state.portalUrl&&t.state.uid&&(this._oAuthLocationParams=t,i=!0)}catch{}else if(t.error&&t.error_description&&"access_denied"===t.error&&(i=!0,t.state))try{t.state=JSON.parse(t.state)}catch{}if(i){const i={...t};["code","error","error_description","message_code","persist","state"].forEach((t=>{delete i[t]}));const n=U(i),o=window.location.pathname+(n?`?${n}`:"")+((null==(s=t.state)?void 0:s.hash)||"");window.history.replaceState(window.history.state,"",o)}}}_getOAuthToken(t,s,i,n,o){return t=t.replace(/^http:/i,"https:"),S(`${t}/sharing/rest/oauth2/token`,{authMode:"anonymous",method:"post",query:n&&o?{grant_type:"authorization_code",code:s,redirect_uri:n,client_id:i,code_verifier:o}:{grant_type:"refresh_token",refresh_token:s,client_id:i}}).then((t=>t.data))}async _getCodeChallenge(t){if(t&&globalThis.isSecureContext){const s=(new TextEncoder).encode(t),i=await crypto.subtle.digest("SHA-256",s);return k(new Uint8Array(i))}return null}_pageShowHandler(t){if(t.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow){const t=new g("identity-manager:user-aborted","ABORTED");this._errbackFunc(t)}}_findCredential(t,s){let i,n,o,a,l=-1;const h=null==s?void 0:s.token,c=null==s?void 0:s.resource,d=this._isServerRsrc(t)?"server":"portal",u=this.credentials.filter((s=>this._hasSameServerInstance(s.server,t)&&s.scope===d));if(t=c||t,u.length)if(1===u.length){if(i=u[0],o=this.findServerInfo(i.server),n=null==o?void 0:o.owningSystemUrl,a=n?this.findCredential(n,i.userId):void 0,l=this._getIdenticalSvcIdx(t,i),!h)return-1===l&&i.resources.push(t),this._addResource(t,a),i;-1!==l&&(i.resources.splice(l,1),this._removeResource(t,a))}else{let s,i;if(u.some((h=>(i=this._getIdenticalSvcIdx(t,h),-1!==i&&(s=h,o=this.findServerInfo(s.server),n=null==o?void 0:o.owningSystemUrl,a=n?this.findCredential(n,s.userId):void 0,l=i,!0)))),h)s&&(s.resources.splice(l,1),this._removeResource(t,a));else if(s)return this._addResource(t,a),s}}_findOAuthInfo(t){let s=this.findOAuthInfo(t);if(!s)for(const i of this.oAuthInfos)if(this._isIdProvider(i.portalUrl,t)){s=i;break}return s}_addResource(t,s){s&&-1===this._getIdenticalSvcIdx(t,s)&&s.resources.push(t)}_removeResource(t,s){let i=-1;s&&(i=this._getIdenticalSvcIdx(t,s),i>-1&&s.resources.splice(i,1))}_useProxy(t,s){return(null==s?void 0:s.isAdmin)&&!w(t.adminTokenServiceUrl,this._appOrigin)||!this._isPortalDomain(t.tokenServiceUrl)&&"10.1"===String(t.currentVersion)&&!w(t.tokenServiceUrl,this._appOrigin)}_getOrigin(t){const s=new I(t);return s.scheme+"://"+s.host+(null!=s.port?":"+s.port:"")}_getServerInstanceRoot(t){const s=t.toLowerCase();let i=s.indexOf(this._agsRest);return-1===i&&this._isAdminResource(t)&&(i=this._agsAdmin.test(t)?t.replace(this._agsAdmin,"$1").length:t.search(this._adminSvcs)),-1!==i||T(s)||(i=s.indexOf("/sharing")),-1===i&&s.endsWith("/")&&(i=s.length-1),i>-1?t.substring(0,i):t}_hasSameServerInstance(t,s){return t.endsWith("/")&&(t=t.slice(0,-1)),t=t.toLowerCase(),s=this._getServerInstanceRoot(s).toLowerCase(),t=this._normalizeAGOLorgDomain(t),s=this._normalizeAGOLorgDomain(s),(t=t.substring(t.indexOf(":")))===s.substring(s.indexOf(":"))}_normalizeAGOLorgDomain(t){const s=/^https?:\/\/(?:cdn|[a-z\d-]+\.maps)\.arcgis\.com/i,i=/^https?:\/\/(?:cdndev|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,n=/^https?:\/\/(?:cdnqa|[a-z\d-]+\.mapsqa)\.arcgis\.com/i;return s.test(t)?t=t.replace(s,"https://www.arcgis.com"):i.test(t)?t=t.replace(i,"https://devext.arcgis.com"):n.test(t)&&(t=t.replace(n,"https://qaext.arcgis.com")),t}_sanitizeUrl(t){const s=(x.request.proxyUrl||"").toLowerCase(),i=s?t.toLowerCase().indexOf(s+"?"):-1;return-1!==i&&(t=t.substring(i+s.length+1)),t=O(t),_(t).path}_isRESTService(t){return t.includes(this._agsRest)}_isAdminResource(t){return this._agsAdmin.test(t)||this._adminSvcs.test(t)}_isServerRsrc(t){return this._isRESTService(t)||this._isAdminResource(t)}_isIdenticalService(t,s){let i=!1;if(this._isRESTService(t)&&this._isRESTService(s)){const n=this._getSuffix(t).toLowerCase(),o=this._getSuffix(s).toLowerCase();if(i=n===o,!i){const t=/(.*)\/(MapServer|FeatureServer|UtilityNetworkServer).*/gi;i=n.replaceAll(t,"$1")===o.replaceAll(t,"$1")}}else this._isAdminResource(t)&&this._isAdminResource(s)?i=!0:this._isServerRsrc(t)||this._isServerRsrc(s)||!this._isPortalDomain(t)||(i=!0);return i}_isPortalDomain(t){const s=new I(t.toLowerCase()),i=this._portalConfig;let n=this._gwDomains.some((t=>t.regex.test(s.uri)));return!n&&i&&(n=this._hasSameServerInstance(this._getServerInstanceRoot(i.restBaseUrl),s.uri)),n||x.portalUrl&&(n=w(s,x.portalUrl,!0)),n||(n=this._portals.some((t=>this._hasSameServerInstance(t,s.uri)))),n=n||this._agsPortal.test(s.path),n}_isIdProvider(t,s){let i=-1,n=-1;this._gwDomains.forEach(((o,a)=>{-1===i&&o.regex.test(t)&&(i=a),-1===n&&o.regex.test(s)&&(n=a)}));let o=!1;if(i>-1&&n>-1&&(0===i||4===i?0!==n&&4!==n||(o=!0):1===i?1!==n&&2!==n||(o=!0):2===i?2===n&&(o=!0):3===i&&3===n&&(o=!0)),!o){const i=this.findServerInfo(s),n=null==i?void 0:i.owningSystemUrl;n&&R(i)&&this._isPortalDomain(n)&&this._isIdProvider(t,n)&&(o=!0)}return o}_getIdenticalSvcIdx(t,s){let i=-1;for(let n=0;n<s.resources.length;n++){const o=s.resources[n];if(this._isIdenticalService(t,o)){i=n;break}}return i}_getSuffix(t){return t.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1")}_getTokenSvcUrl(t){let s,i,n;if(this._isRESTService(t)||this._isAdminResource(t)){const n=this._getServerInstanceRoot(t);return s=n+"/admin/generateToken",i=S(t=n+"/rest/info",{query:{f:"json"}}).then((t=>t.data)),{adminUrl:s,promise:i}}if(this._isPortalDomain(t)){let s="";if(this._gwDomains.some((i=>(i.regex.test(t)&&(s=i.tokenServiceUrl),!!s))),s||this._portals.some((i=>(this._hasSameServerInstance(i,t)&&(s=i+this._gwTokenUrl),!!s))),s||(n=t.toLowerCase().indexOf("/sharing"),-1!==n&&(s=t.substring(0,n)+this._gwTokenUrl)),s||(s=this._getOrigin(t)+this._gwTokenUrl),s){const i=new I(t).port;/^http:\/\//i.test(t)&&"7080"===i&&(s=s.replace(/:7080/i,":7443")),s=s.replace(/http:/i,"https:")}return s}}_processOAuthResponseParams(t,s,i){const n=s._oAuthCred;if(t.code){const o=n.codeVerifier;return n.codeVerifier=null,n.stateUID=null,n.save(),this._getOAuthToken(i.server,t.code,s.appId,this._getRedirectURI(s,!0),o).then((o=>{const a=new Q({userId:o.username,server:i.server??void 0,token:o.access_token,expires:Date.now()+1e3*o.expires_in,ssl:o.ssl,oAuthState:t.state,_oAuthCred:n});return s.userId=a.userId,n.storage=o.persist?K:Y,n.refreshToken=o.refresh_token,n.token=null,n.expires=o.refresh_token_expires_in?Date.now()+1e3*o.refresh_token_expires_in:null,n.userId=a.userId,n.ssl=a.ssl,n.save(),a}))}const o=new Q({userId:t.username,server:i.server??void 0,token:t.access_token,expires:Date.now()+1e3*Number(t.expires_in),ssl:"true"===t.ssl,oAuthState:t.state,_oAuthCred:n});return s.userId=o.userId,n.storage=t.persist?K:Y,n.refreshToken=null,n.token=o.token,n.expires=o.expires,n.userId=o.userId,n.ssl=o.ssl,n.save(),Promise.resolve(o)}_processOAuthPopupParams(t){var s;const i=this._oAuthDfd;if(this._oAuthDfd=null,i)if(clearInterval(this._oAuthIntervalId),null==(s=this._oAuthOnPopupHandle)||s.remove(),t.error){const s="access_denied"===t.error,n=new g(s?"identity-manager:user-aborted":"identity-manager:authentication-failed",s?"ABORTED":"OAuth: "+t.error+" - "+t.error_description);i.reject(n)}else this._processOAuthResponseParams(t,i.oinfo_,i.sinfo_).then((t=>{i.resolve(t)})).catch((t=>{i.reject(t)}))}_setOAuthResponseQueryString(t){t&&("?"===t.charAt(0)&&(t=t.substring(1)),this._processOAuthPopupParams(y(t)))}async _exchangeToken(t,s,i){return(await S(`${t}/sharing/rest/oauth2/exchangeToken`,{authMode:"anonymous",method:"post",query:{f:"json",client_id:s,token:i}})).data.token}async _getPlatformSelf(t,s){var i;if(this._getPlatformSelfError&&Date.now()-this._getPlatformSelfError[1]<1e3)throw this._getPlatformSelfError[0];t=t.replace(/^http:/i,"https:");try{const i=await S(`${t}/sharing/rest/oauth2/platformSelf`,{authMode:"anonymous",headers:{"X-Esri-Auth-Client-Id":s,"X-Esri-Auth-Redirect-Uri":window.location.href.replace(/#.*$/,"")},method:"post",query:{f:"json",expiration:30},withCredentials:!0});return this._getPlatformSelfError=null,i.data}catch(n){throw"OAUTH_0066"===(null==(i=n.details)?void 0:i.messageCode)&&(this._getPlatformSelfError=[n,Date.now()]),n}}_getPortalSelf(t,s){let i;return this._gwDomains.some((s=>(s.regex.test(t)&&(i=s.customBaseUrl),!!i))),i?Promise.resolve({allSSL:!0,currentVersion:"8.4",customBaseUrl:i,portalMode:"multitenant",supportsOAuth:!0}):(this._appOrigin.startsWith("https:")?t=t.replace(/^http:/i,"https:").replace(/:7080/i,":7443"):/^http:/i.test(s)&&(t=t.replace(/^https:/i,"http:").replace(/:7443/i,":7080")),S(t,{query:{f:"json"},authMode:"anonymous",withCredentials:!0}).then((t=>t.data)))}_doPortalSignIn(t){const s=this._portalConfig,i=window.location.href,n=this.findServerInfo(t);return!(!s&&!this._isPortalDomain(i)||!(n?n.hasPortal||n.owningSystemUrl&&this._isPortalDomain(n.owningSystemUrl):this._isPortalDomain(t))||!(this._isIdProvider(i,t)||s&&(this._hasSameServerInstance(this._getServerInstanceRoot(s.restBaseUrl),t)||this._isIdProvider(s.restBaseUrl,t))||w(i,t,!0)))}_checkProtocol(t,s,i,n){let o=!0;const a=n?s.adminTokenServiceUrl:s.tokenServiceUrl;return a.trim().toLowerCase().startsWith("https:")&&!this._appOrigin.startsWith("https:")&&P(a)&&(o=!!this._protocolFunc&&!!this._protocolFunc({resourceUrl:t,serverInfo:s}),!o)&&i(new g("identity-manager:aborted","Aborted the Sign-In process to avoid sending password over insecure connection.")),o}_enqueue(t,s,i,n,o,a){return n||(n=f()),n.resUrl_=t,n.sinfo_=s,n.options_=i,n.admin_=o,n.refresh_=a,this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(t),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(n)):this._xoReqs.push(n):this._doSignIn(n),n.promise}_doSignIn(t){this._busy=t,this._rejectOnPersistedPageShow=!1;const t2=s=>{var i;const n=null==(i=t.options_)?void 0:i.resource,o=t.resUrl_,a=t.refresh_;let l=!1;this.credentials.includes(s)||(a&&this.credentials.includes(a)?(a.userId=s.userId,a.token=s.token,a.expires=s.expires,a.validity=s.validity,a.ssl=s.ssl,a.creationTime=s.creationTime,l=!0,s=a):this.credentials.push(s)),s.resources||(s.resources=[]),s.resources.includes(n||o)||s.resources.push(n||o),s.scope=this._isServerRsrc(o)?"server":"portal",s.emitTokenChange();const h=this._soReqs,c={};this._soReqs=[],h.forEach((t=>{if(!this._isIdenticalService(o,t.resUrl_)){const i=this._getSuffix(t.resUrl_);c[i]||(c[i]=!0,s.resources.push(t.resUrl_))}})),t.resolve(s),h.forEach((t=>{this._hasSameServerInstance(this._getServerInstanceRoot(o),t.resUrl_)?t.resolve(s):this._soReqs.push(t)})),this._busy=t.resUrl_=t.sinfo_=t.refresh_=null,l||this.emit("credential-create",{credential:s}),this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},r2=s=>{t.reject(s),this._busy=t.resUrl_=t.sinfo_=t.refresh_=null,this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},s2=(s,i,n,o)=>{var a,l,h;const c=t.sinfo_,d=!t.options_||!1!==t.options_.prompt,u=c.hasPortal&&this._findOAuthInfo(t.resUrl_);let p,_;if(s)t2(new Q({userId:s,server:c.server??void 0,token:n??void 0,expires:null!=o?Number(o):null,ssl:!!i}));else if(window!==window.parent&&(null==(a=this._appUrlObj.query)?void 0:a["arcgis-auth-origin"])&&(null==(l=this._appUrlObj.query)?void 0:l["arcgis-auth-portal"])&&this._hasSameServerInstance(this._getServerInstanceRoot(this._appUrlObj.query["arcgis-auth-portal"]),t.resUrl_)){window.parent.postMessage({type:"arcgis:auth:requestCredential"},this._appUrlObj.query["arcgis-auth-origin"]);const s=A(window,"message",(t=>{t.source===window.parent&&t.data&&("arcgis:auth:credential"===t.data.type?(s.remove(),t.data.credential.expires<Date.now()?r2(new g("identity-manager:credential-request-failed","Parent application's token has expired.")):t2(new Q(t.data.credential))):"arcgis:auth:error"===t.data.type&&(s.remove(),"tokenExpiredError"===t.data.error.name?r2(new g("identity-manager:credential-request-failed","Parent application's token has expired.")):r2(g.fromJSON(t.data.error))))}));v(null==(h=t.options_)?void 0:h.signal,(()=>{s.remove()}))}else if(u){let s=u._oAuthCred;if(!s){const t=new e(u,K),i=new e(u,Y);t.isValid()&&i.isValid()?t.expires>i.expires?(s=t,i.destroy()):(s=i,t.destroy()):s=t.isValid()?t:i,u._oAuthCred=s}if(s.isValid()){p=new Q({userId:s.userId??void 0,server:c.server??void 0,token:s.token??void 0,expires:s.expires,ssl:s.ssl??void 0,_oAuthCred:s});const i=u.appId!==s.appId&&this._doPortalSignIn(t.resUrl_);i||s.refreshToken?(t._pendingDfd=s.refreshToken?this._getOAuthToken(c.server,s.refreshToken,s.appId).then((t=>(p.expires=Date.now()+1e3*t.expires_in,p.token=t.access_token,p))):Promise.resolve(p),t._pendingDfd.then((t=>i?this._exchangeToken(t.server,u.appId,t.token).then((s=>(t.token=s,t))).catch((()=>t)):t)).then((t=>{t2(t)})).catch((()=>{null==s||s.destroy(),s2()}))):t2(p)}else if(this._oAuthLocationParams&&this._hasSameServerInstance(u.portalUrl,this._oAuthLocationParams.state.portalUrl)&&(this._oAuthLocationParams.access_token||this._oAuthLocationParams.code&&this._oAuthLocationParams.state.uid===s.stateUID&&s.codeVerifier)){const s=this._oAuthLocationParams;this._oAuthLocationParams=null,t._pendingDfd=this._processOAuthResponseParams(s,u,c).then((t=>{t2(t)})).catch(r2)}else{const s3=()=>{d?t._pendingDfd=this.oAuthSignIn(t.resUrl_,c,u,t.options_).then(t2,r2):(_=new g("identity-manager:not-authenticated","User is not signed in."),r2(_))};this._doPortalSignIn(t.resUrl_)?t._pendingDfd=this._getPlatformSelf(c.server,u.appId).then((t=>{w(t.portalUrl,this._appOrigin,!0)?(p=new Q({userId:t.username,server:c.server??void 0,expires:Date.now()+1e3*t.expires_in,token:t.token}),t2(p)):s3()})).catch(s3):s3()}}else if(d){if(this._checkProtocol(t.resUrl_,c,r2,t.admin_)){let s=t.options_;t.admin_&&(s=s||{},s.isAdmin=!0),t._pendingDfd=this.signIn(t.resUrl_,c,s).then(t2,r2)}}else _=new g("identity-manager:not-authenticated","User is not signed in."),r2(_)},o2=()=>{const s=t.sinfo_,i=s.owningSystemUrl,n=t.options_;let o,a,l,h;if(n&&(o=n.token,a=n.error,l=n.prompt),h=this._findCredential(i,{token:o,resource:t.resUrl_}),!h)for(const t of this.credentials)if(this._isIdProvider(i,t.server)){h=t;break}if(h){const i=this.findCredential(t.resUrl_,h.userId);if(i)t2(i);else if(C(s,this._legacyFed)){const t=h.toJSON();t.server=s.server,t.resources=null,t2(new Q(t))}else(t._pendingDfd=this.generateToken(this.findServerInfo(h.server),null,{serverUrl:t.resUrl_,token:h.token,signal:t.options_.signal,ssl:h.ssl})).then((i=>{t2(new Q({userId:null==h?void 0:h.userId,server:s.server??void 0,token:i.token,expires:null!=i.expires?Number(i.expires):null,ssl:!!i.ssl,isAdmin:t.admin_,validity:i.validity}))}),r2)}else this._busy=null,o&&(t.options_.token=null),(t._pendingDfd=this.getCredential(i.replace(/\/?$/,"/sharing"),{resource:t.resUrl_,owningTenant:s.owningTenant,signal:t.options_.signal,token:o,error:a,prompt:l})).then((()=>{this._enqueue(t.resUrl_,t.sinfo_,t.options_,t,t.admin_)}),(s=>{t.resUrl_=t.sinfo_=t.refresh_=null,t.reject(s)}))};this._errbackFunc=r2;const s=t.sinfo_.owningSystemUrl,i=this._isServerRsrc(t.resUrl_),n=t.sinfo_._restInfoPms;n?n.promise.then((s=>{const n=t.sinfo_;if(n._restInfoPms){n.adminTokenServiceUrl=n._restInfoPms.adminUrl,n._restInfoPms=null,n.tokenServiceUrl=(b("authInfo.tokenServicesUrl",s)||b("authInfo.tokenServiceUrl",s)||b("tokenServiceUrl",s))??null,n.shortLivedTokenValidity=b("authInfo.shortLivedTokenValidity",s)??null,n.currentVersion=s.currentVersion,n.owningTenant=s.owningTenant;const t=n.owningSystemUrl=s.owningSystemUrl;t&&this._portals.push(t)}i&&n.owningSystemUrl?o2():s2()}),(()=>{t.sinfo_._restInfoPms=null;const s=new g("identity-manager:server-identification-failed","Unknown resource - could not find token service endpoint.");r2(s)})):i&&s?o2():t.sinfo_._selfReq?t.sinfo_._selfReq.selfDfd.then((s=>{var i;const n={};let o,a,l,h;return s&&(o=null==(i=s.user)?void 0:i.username,n.username=o,n.allSSL=s.allSSL,a=s.supportsOAuth,h=parseFloat(s.currentVersion),"multitenant"===s.portalMode&&(l=s.customBaseUrl),t.sinfo_.currentVersion=h),t.sinfo_.webTierAuth=!!o,o&&this.normalizeWebTierAuth?this.generateToken(t.sinfo_,null,{ssl:n.allSSL}).catch((()=>null)).then((t=>(n.portalToken=null==t?void 0:t.token,n.tokenExpiration=null==t?void 0:t.expires,n))):!o&&a&&h>=4.4&&!this._findOAuthInfo(t.resUrl_)?this._generateOAuthInfo({portalUrl:t.sinfo_.server,customBaseUrl:l,owningTenant:t.sinfo_._selfReq.owningTenant}).catch((()=>null)).then((()=>n)):n})).catch((()=>null)).then((s=>{t.sinfo_._selfReq=null,s?s2(s.username,s.allSSL,s.portalToken,s.tokenExpiration):s2()})):s2()}_generateOAuthInfo(t){let s,i=null,n=t.portalUrl;const o=t.customBaseUrl,a=t.owningTenant,l=!this._defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal;if(l){i=window.location.href;let t=i.indexOf("?");t>-1&&(i=i.slice(0,t)),t=i.search(/\/(apps|home)\//),i=t>-1?i.slice(0,t):null}return l&&i?(this._hasTestedIfAppIsOnPortal=!0,s=S(i+"/sharing/rest",{query:{f:"json"}}).then((()=>{this._defaultOAuthInfo=new J({appId:"arcgisonline",popupCallbackUrl:i+"/home/oauth-callback.html"})}))):s=Promise.resolve(),s.then((()=>{if(this._defaultOAuthInfo)return n=n.replace(/^http:/i,"https:"),S(n+"/sharing/rest/oauth2/validateRedirectUri",{query:{accountId:a,client_id:this._defaultOAuthInfo.appId,redirect_uri:D(this._defaultOAuthInfo.popupCallbackUrl),f:"json"}}).then((t=>{if(t.data.valid){const s=this._defaultOAuthInfo.clone();t.data.urlKey&&o?s.portalUrl="https://"+t.data.urlKey.toLowerCase()+"."+o:s.portalUrl=n,s.popup=window!==window.top||!(w(n,this._appOrigin)||this._gwDomains.some((t=>t.regex.test(n)&&t.regex.test(this._appOrigin)))),this.oAuthInfos.push(s)}}))}))}_doOAuthSignIn(t,s,i,n){const o=i._oAuthCred,a={portalUrl:i.portalUrl};!i.popup&&i.preserveUrlHash&&window.location.hash&&(a.hash=window.location.hash),o.stateUID&&(a.uid=o.stateUID);const l={client_id:i.appId,response_type:o.codeVerifier?"code":"token",state:JSON.stringify(a),expiration:i.expiration,locale:i.locale,redirect_uri:this._getRedirectURI(i,!!o.codeVerifier)};i.forceLogin&&(l.force_login=!0),i.forceUserId&&i.userId&&(l.prepopulatedusername=i.userId),!i.popup&&this._doPortalSignIn(t)&&(l.redirectToUserOrgUrl=!0),o.codeVerifier&&(l.code_challenge=n||o.codeVerifier,l.code_challenge_method=n?"S256":"plain");const h=i.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",c=h+"?"+U(l);if(i.popup){const t=window.open(c,"esriJSAPIOAuth",i.popupWindowFeatures);if(t)t.focus(),this._oAuthDfd.oAuthWin_=t,this._oAuthIntervalId=setInterval((()=>{if(t.closed){clearInterval(this._oAuthIntervalId),this._oAuthOnPopupHandle.remove();const t=this._oAuthDfd;if(t){const s=new g("identity-manager:user-aborted","ABORTED");t.reject(s)}}}),500),this._oAuthOnPopupHandle=A(window,["arcgis:auth:hash","arcgis:auth:location:search"],(t=>{"arcgis:auth:hash"===t.type?this.setOAuthResponseHash(t.detail):this._setOAuthResponseQueryString(t.detail)}));else{const t=new g("identity-manager:popup-blocked","ABORTED");this._oAuthDfd.reject(t)}}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:l,authorizeUrl:h,resourceUrl:t,serverInfo:s,oAuthInfo:i}):window.location.href=c}_getRedirectURI(t,s){const i=window.location.href.replace(/#.*$/,"");if(t.popup)return D(t.popupCallbackUrl);if(s){const t=_(i);return t.query&&["code","error","error_description","message_code","persist","state"].forEach((s=>{delete t.query[s]})),j(t.path,t.query)}return i}}q.prototype.declaredClass="esri.identity.IdentityManagerBase";let Q=class extends u.EventedAccessor{constructor(t){super(t),this._oAuthCred=null,this.tokenRefreshBuffer=2,(null==t?void 0:t._oAuthCred)&&(this._oAuthCred=t._oAuthCred)}initialize(){this.resources=this.resources||[],null==this.creationTime&&(this.creationTime=Date.now())}refreshToken(){const t=E,s=t.findServerInfo(this.server),i=null==s?void 0:s.owningSystemUrl,n=!!i&&"server"===this.scope,o=n&&C(s,t._legacyFed),a=s.webTierAuth,l=a&&t.normalizeWebTierAuth,h=X[this.server],c=null==h?void 0:h[this.userId];let d,u=this.resources&&this.resources[0],p=n?t.findServerInfo(i):null,_={username:this.userId,password:c};if(a&&!l)return;n&&!p&&t.serverInfos.some((s=>(t._isIdProvider(i,s.server)&&(p=s),!!p)));const f=p?t.findCredential(p.server,this.userId):null;if(!n||f){if(!o){if(n)d={serverUrl:u,token:null==f?void 0:f.token,ssl:null==f?void 0:f.ssl};else if(l)_=null,d={ssl:this.ssl};else{if(!c){let i;return u&&(u=t._sanitizeUrl(u),this._enqueued=1,i=t._enqueue(u,s,null,null,this.isAdmin,this),i.then((()=>{this._enqueued=0,this.refreshServerTokens()})).catch((()=>{this._enqueued=0}))),i}this.isAdmin&&(d={isAdmin:!0})}return t.generateToken(n?p:s,n?null:_,d).then((t=>{this.token=t.token,this.expires=null!=t.expires?Number(t.expires):null,this.creationTime=Date.now(),this.validity=t.validity,this.emitTokenChange(),this.refreshServerTokens()})).catch((()=>{}))}null==f||f.refreshToken()}}refreshServerTokens(){if("portal"===this.scope){const t=E;t.credentials.forEach((s=>{const i=t.findServerInfo(s.server),n=null==i?void 0:i.owningSystemUrl;s!==this&&s.userId===this.userId&&n&&"server"===s.scope&&(t._hasSameServerInstance(this.server,n)||t._isIdProvider(n,this.server))&&(C(i,t._legacyFed)?(s.token=this.token,s.expires=this.expires,s.creationTime=this.creationTime,s.validity=this.validity,s.emitTokenChange()):s.refreshToken())}))}}emitTokenChange(t){clearTimeout(this._refreshTimer);const s=E,i=this.server?s.findServerInfo(this.server):null,n=null==i?void 0:i.owningSystemUrl,o=n?s.findServerInfo(n):null;!1===t||n&&"portal"!==this.scope&&(!(null==o?void 0:o.webTierAuth)||s.normalizeWebTierAuth)||null==this.expires&&null==this.validity||this._startRefreshTimer(),this.emit("token-change")}destroy(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null,this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);const t=E,s=t.credentials.indexOf(this);s>-1&&t.credentials.splice(s,1),this.emitTokenChange(),this.emit("destroy")}toJSON(){const t=p({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),s=this.resources;return s&&s.length>0&&(t.resources=s.slice()),t}_startRefreshTimer(){clearTimeout(this._refreshTimer);const t=6e4*this.tokenRefreshBuffer,s=2**31-1;let i=(this.validity?this.creationTime+6e4*this.validity:this.expires)-Date.now();i<0?i=0:i>s&&(i=s),this._refreshTimer=setTimeout(this.refreshToken.bind(this),i>t?i-t:i)}};t([s()],Q.prototype,"creationTime",void 0),t([s()],Q.prototype,"expires",void 0),t([s()],Q.prototype,"isAdmin",void 0),t([s()],Q.prototype,"oAuthState",void 0),t([s()],Q.prototype,"resources",void 0),t([s()],Q.prototype,"scope",void 0),t([s()],Q.prototype,"server",void 0),t([s()],Q.prototype,"ssl",void 0),t([s()],Q.prototype,"token",void 0),t([s()],Q.prototype,"tokenRefreshBuffer",void 0),t([s()],Q.prototype,"userId",void 0),t([s()],Q.prototype,"validity",void 0),Q=t([n("esri.identity.Credential")],Q);class r extends q{}r.prototype.declaredClass="esri.identity.IdentityManager";const Z=new r;N(Z);export{Z as default};
