import{gY as e,ej as n,bZ as r,bF as i,gr as a,fk as l}from"./index-DSIPxOWi.js";import{R as o}from"./normalizeUtils-BrH-PrZy.js";import{t as u}from"./pbfQueryUtils-DUjEbwA9.js";function t(e){const n={};for(const r in e){if("declaredClass"===r)continue;const i=e[r];if(null!=i&&"function"!=typeof i)if(Array.isArray(i)){n[r]=[];for(let e=0;e<i.length;e++)n[r][e]=t(i[e])}else"object"==typeof i?i.toJSON&&(n[r]=JSON.stringify(i)):n[r]=i}return n}const s="Layer does not support extent calculation.";function y(e,n){var r;const i=e.geometry,o=e.toJSON();delete o.compactGeometryEnabled,delete o.defaultSpatialReferenceEnabled;const u=o;let s,d,S;if(null!=i&&(d=i.spatialReference,S=a(d),u.geometryType=l(i),u.geometry=function m(e,n){if(n&&"extent"===e.type)return`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`;if(n&&"point"===e.type)return`${e.x},${e.y}`;const r=e.toJSON();return delete r.spatialReference,JSON.stringify(r)}(i,e.compactGeometryEnabled),u.inSR=S),o.groupByFieldsForStatistics&&(u.groupByFieldsForStatistics=o.groupByFieldsForStatistics.join(",")),o.objectIds&&(u.objectIds=o.objectIds.join(",")),o.orderByFields&&(u.orderByFields=o.orderByFields.join(",")),!o.outFields||!o.returnDistinctValues&&((null==n?void 0:n.returnCountOnly)||(null==n?void 0:n.returnExtentOnly)||(null==n?void 0:n.returnIdsOnly))?delete u.outFields:o.outFields.includes("*")?u.outFields="*":u.outFields=o.outFields.join(","),o.outSR?(u.outSR=a(o.outSR),s=e.outSpatialReference):i&&(o.returnGeometry||o.returnCentroid)&&(u.outSR=u.inSR,s=d),o.returnGeometry&&delete o.returnGeometry,o.outStatistics&&(u.outStatistics=JSON.stringify(o.outStatistics)),o.fullText&&(u.fullText=JSON.stringify(o.fullText)),o.pixelSize&&(u.pixelSize=JSON.stringify(o.pixelSize)),o.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&null!=d&&null!=(null==(r=e.quantizationParameters)?void 0:r.extent)&&d.equals(e.quantizationParameters.extent.spatialReference)&&delete o.quantizationParameters.extent.spatialReference,u.quantizationParameters=JSON.stringify(o.quantizationParameters)),o.parameterValues&&(u.parameterValues=JSON.stringify(o.parameterValues)),o.rangeValues&&(u.rangeValues=JSON.stringify(o.rangeValues)),o.dynamicDataSource&&(u.layer=JSON.stringify({source:o.dynamicDataSource}),delete o.dynamicDataSource),o.timeExtent){const e=o.timeExtent,{start:n,end:r}=e;null==n&&null==r||(u.time=n===r?n:`${n??"null"},${r??"null"}`),delete o.timeExtent}return e.defaultSpatialReferenceEnabled&&null!=d&&null!=s&&d.equals(s)&&(u.defaultSR=u.inSR,delete u.inSR,delete u.outSR),u}async function c(n,r,i,a){const l=null!=r.timeExtent&&r.timeExtent.isEmpty?{data:{features:[]}}:await E(n,r,"json",a);return e(r,i,l.data),l}async function f(e,n,r,i){if(null!=n.timeExtent&&n.timeExtent.isEmpty)return{data:r.createFeatureResult()};const a=await d$1(e,n,i),l=a;return l.data=u(a.data,r),l}function d$1(e,n,r){return E(e,n,"pbf",r)}function p(e,n,r){return null!=n.timeExtent&&n.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):E(e,n,"json",r,{returnIdsOnly:!0})}function S$1(e,n,r){return null!=n.timeExtent&&n.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):E(e,n,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})}async function x$1(e,n,r){if(null!=n.timeExtent&&n.timeExtent.isEmpty)return{data:{count:0,extent:null}};const i=await E(e,n,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}),a=i.data;if(a.hasOwnProperty("extent"))return i;if(a.features)throw new Error(s);if(a.hasOwnProperty("count"))throw new Error(s);return i}async function E(e,a,l,u={},s={}){const d="string"==typeof e?n(e):e,S=a.geometry?[a.geometry]:[],x=await o(S,null,{signal:u.signal}),O=null==x?void 0:x[0];null!=O&&((a=a.clone()).geometry=O);const j=t({...d.query,f:l,...s,...y(a,s)});return r(i(d.path,function g(e,n){return null!=e.formatOf3DObjects&&!(n.returnCountOnly||n.returnExtentOnly||n.returnIdsOnly)}(a,s)?"query3d":"query"),{...u,responseType:"pbf"===l?"array-buffer":"json",query:{...j,...u.query}})}export{E,S$1 as S,c,d$1 as d,f,p,t,x$1 as x};
