import{d as c,dB as _,ce as f,cC as m,wI as b,wJ as S,e as x,y as v,a as w,v as z,a0 as A,wK as C,a1 as R,wL as I,wM as M,wN as k,w5 as E,wf as D,w9 as V,dW as F,wO as L,ch as q,e9 as W,wP as H,wQ as B,hD as U,wR as T,wS as te,O as ie,ul as re,w8 as ne,wT as oe,wU as ae,bV as le,Q as de,c_ as he,wg as ue,_ as ce,wj as pe,wk as ge,wV as fe,wl as be,kA as ye,wp as Se,ws as Pe,wt as xe,wv as ve,wW as we,wi as Ne,wx as ze,wX as Ae,pk as Ce,wY as Re,dG as Ie,kz as Oe,wZ as Me,as as ke,dx as Ee,cx as De,dt as Ve,dC as Fe,cd as Le,rb as qe,w_ as We,w$ as Qe,hP as He,dk as Be,dK as $e,kL as Ue,ld as Te,pM as Ge,kW as je,m7 as Je,x0 as Ye,t3 as Ke,t4 as Xe,x1 as Ze,qB as et,ag as tt,x2 as it,q_ as st,x3 as rt,x4 as nt,qz as ot,P as at,g as lt,i as dt,a8 as ht,u as ut,z as ct,x5 as pt,hr as _t,x6 as gt,x7 as ft,cD as mt,V as bt,r as yt,fD as St,x8 as Pt,W as xt,n as vt,gR as wt,b3 as Nt,du as zt,fF as At,j$ as Ct,fC as Rt,w as It,c5 as Ot,hk as Mt}from"./index-DSIPxOWi.js";import{l as kt}from"./LayerView3D-ApO6iJqK.js";import{h as Et}from"./WorkerHandle-Bq2affGI.js";import{c as Dt,u as Vt,a as Ft}from"./PointCloudWorkerUtil-BvnCwL7b.js";import{i as Lt}from"./PopupSceneLayerView-Cv6_Wug9.js";import{y as qt}from"./LayerView-DMoB2q_T.js";import"./PointCloudUniqueValueRenderer-CAfl8sj6.js";let Wt=class e extends c{constructor(c,_,f,m,b){super(c,_,-1,f,m),this.queue=b}},Qt=class o{constructor(c,_,f,m){this.loading=c,this.indexLoading=_,this.processing=f,this.idleProcessing=m}},Ht=class r extends Et{constructor(c){super("PointCloudWorker","transform",{transform:c=>function u$2(c){const _=[c.geometryBuffer];if(null!=c.primaryAttributeData&&c.primaryAttributeData.buffer&&_.push(c.primaryAttributeData.buffer),null!=c.modulationAttributeData&&c.modulationAttributeData.buffer&&_.push(c.modulationAttributeData.buffer),null!=c.filterAttributesData)for(const f of c.filterAttributesData)null!=f&&f.buffer&&_.push(f.buffer);for(const f of c.userAttributesData)f.buffer&&_.push(f.buffer);return _}(c)},c)}};const Bt=[!1],$t=[null],Ut=[!1],Tt=[null];function h$2(c,_,f){let m=c;for(;m>0;){const c=_.indexOf(m);if(c>=0)return c;m=f.getParentId(m)}return _.indexOf(m)}function d$1(c,_,f){const m=[_.remove[0]],b=[];for(;1===m.length;){const c=m.pop();b.length=0;for(let S=0;S<_.load.length;S++){let x=_.load[S],v=f.getParentId(x);for(;v!==c;)x=v,v=f.getParentId(x);let w=m.indexOf(x);w<0&&(w=m.length,m.push(x),b.push([])),b[w].push(_.load[S])}}_.load=m;for(let S=0;S<m.length;S++)b[S].length>1?c.push({remove:[m[S]],load:b[S]}):m[S]=b[S][0]}class i{constructor(c,_,m){this._pages=[],this.pageSize=0,this._nodeSR=c,this._renderSR=_,this._renderSRSphericalPCPF=f(_),this.pageSize=m}addPage(c,_,f=0){for(;this._pages.length<c;)this._pages.push(null);(function r$2(c,_,f,m,b){for(let S=0;S<c.length;S++){const x=c[S];x.obb.transform(x.obbInRenderSR,_,f,m,b)}})(_,this._nodeSR,this._renderSR,f,this._renderSRSphericalPCPF),this._pages[c]={nodes:_,parents:new Uint32Array(this.pageSize)},function p(c,_){const f=[0];for(;f.length;){const m=f.pop(),b=c[a(m,_)].nodes[h$1(m,_)];for(let S=0;S<b.childCount;S++){const x=b.firstChild+S;null!=c[a(x,_)]&&(c[a(x,_)].parents[h$1(x,_)]=m,f.push(x))}}}(this._pages,this.pageSize)}hasPage(c){return!!this._pages[c]}getNode(c){const _=this.pageSize;return this._pages[a(c,_)].nodes[h$1(c,_)]}getRenderObb(c){const _=this.pageSize;return this._pages[a(c,_)].nodes[h$1(c,_)].obbInRenderSR}setRenderObb(c,_){const f=this.pageSize;this._pages[a(c,f)].nodes[h$1(c,f)].obbInRenderSR.copy(_)}getParentId(c){const _=this.pageSize;return this._pages[a(c,_)].parents[h$1(c,_)]}hasNodes(c,_){const f=a(c,this.pageSize),m=a(c+_-1,this.pageSize);for(let b=f;b<=m;b++)if(null==this._pages[b])return!1;return!0}forEachNodeId(c){for(let _=0;_<this._pages.length;_++){const f=this._pages[_];if(f)for(let m=0;m<f.nodes.length;m++)c(_*this.pageSize+m)}}createVisibilityTraverse(){const c={index:this,queue:[],masks:[],tempAabb:m()};return(_,f)=>function o$1(c,_,f){const m=c.index;if(!m.hasNodes(0,1))return;const x=c.queue;x.length=0,x.push(0);const v=c.masks;for(v.length=0,v.push(0);x.length>0;){const w=x.pop();let z=v.pop();const A=m.getNode(w),C=m.getRenderObb(w);let R=!0;if(null!=_.clippingBox){const f=1<<_.frustum.length;z&f||(C.toAaBoundingBox(c.tempAabb),b(_.clippingBox,c.tempAabb)?z|=f:S(_.clippingBox,c.tempAabb)||(R=!1))}for(let c=0;c<_.frustum.length&&R;c++){const f=1<<c;if(!(z&f)){const m=C.intersectPlane(_.frustum[c]);m>0?R=!1:m<0&&(z|=f)}}if(f.predicate(w,A,R)){const c=A.firstChild,_=A.childCount;let b=!1;const S=a(c,m.pageSize),C=a(c+_-1,m.pageSize);for(let x=S;x<=C;x++)if(!m.hasPage(x)){f.pageMiss(w,x),b=!0;break}if(!b)for(let f=0;f<_;f++)x.push(c+f),v.push(z)}}}(c,_,f)}}function a(c,_){return c/_|0}function h$1(c,_){return c%_}function t(c){const _=c.renderer,f=null==_?void 0:_.type,m=(null==_?void 0:_.toJSON())??null;let b=null,S=!1;const x=c.attributeStorageInfo;"point-cloud-unique-value"===f||"point-cloud-stretch"===f||"point-cloud-class-breaks"===f?b=u(x,_.field):"point-cloud-rgb"===f?(b=r$1(x,_.field),S=null!=b):(b=r$1(x,"RGB"),S=null!=b);let v=null;return(null==_?void 0:_.colorModulation)&&(v=u(x,_.colorModulation.field)),{rendererJSON:m,isRGBRenderer:S,primaryAttribute:b,modulationAttribute:v}}function e$1(c){const _=c.filters;return _?_.map((_=>({filterJSON:_.toJSON(),attributeInfo:u(c.attributeStorageInfo,_.field)}))):[]}function o2(c){const _=null==c?void 0:c.pointSizeAlgorithm;return _&&"fixed-size"===_.type?_:null}function r$1(c,_){for(const f of c??[])if(f.name===_&&null!=f.attributeValues&&"UInt8"===f.attributeValues.valueType&&3===f.attributeValues.valuesPerElement)return{name:_,storageInfo:f,useElevation:!1};return null}function u(c,_){for(const f of c??[])if(f.name===_){const c="embedded-elevation"===f.encoding;return c?{name:_,storageInfo:null,useElevation:c}:{name:_,storageInfo:f,useElevation:c}}return"elevation"===(null==_?void 0:_.toLowerCase())?{name:_,storageInfo:null,useElevation:!0}:null}let Gt=class extends z{constructor(c){super(c),this.pointCloudMetadata=null}};x([v({constructOnly:!0,clonable:"reference"})],Gt.prototype,"pointCloudMetadata",void 0),Gt=x([w("esri.views.3d.layers.i3s.PointGraphic")],Gt);class h{constructor(c){this._context=c,this._highlights=new Set}get empty(){return 0===this._highlights.size}destroy(){this._highlights=null}add(c){const _=new s(c);return this._highlights.add(_),this._enableSet(_),A((()=>this._removeSet(_)))}_removeSet(c){this._disableSet(c),this._highlights.delete(c)}_enableSet(c){c.enabled||(c.enabled=!0,this._context.forEachNode((_=>this._enableSetForNode(c,_))))}_enableSetForNode(c,_){if(!c.enabled)return;const f=c.ids.get(_.id);f&&f.forEach((f=>this._context.addHighlight(_,f,c.id)))}_disableSet(c){c.enabled&&(c.enabled=!1,this._context.forEachNode((_=>this._disableSetForNode(c,_))))}_disableSetForNode(c,_){c.enabled||this._context.removeHighlight(_,c.id)}nodeAdded(c){this._highlights.forEach((_=>this._enableSetForNode(_,c)))}nodeRemoved(c){this._highlights.forEach((_=>this._disableSetForNode(_,c)))}removeAll(){this._highlights.forEach((c=>this._disableSet(c)))}}class s{constructor(c){this.id=new C(R.Highlight),this.ids=new Map,this.enabled=!1;for(const _ of c)null!=_&&this._add(_.nodeId,_.pointId)}_add(c,_){const f=this.ids.get(c);f?f.add(_):this.ids.set(c,new Set([_]))}}class j extends I{constructor(){super(...arguments),this.clipBox=m(M),this.useFixedSizes=!1,this.useRealWorldSymbolSizes=!1,this.scaleFactor=1,this.minSizePx=0,this.size=0,this.sizePx=0}get fixedSize(){return this.drawScreenSpace?this.sizePx:this.size}get screenMinSize(){return this.useFixedSizes?0:this.minSizePx}get drawScreenSpace(){return this.useFixedSizes&&!this.useRealWorldSymbolSizes}}class P extends k{constructor(c,_,f){super(c),this.origin=c,this.isLeaf=_,this.splatSize=f}}function y(c){const _=new E,f=c.output===D.Color,m=c.output===D.Highlight,{vertex:b,fragment:S}=_;return _.include(V,c),_.attributes.add(F.POSITION,"vec3"),_.attributes.add(F.COLOR,"vec3"),b.uniforms.add(new L("modelView",((c,_)=>q(jt,_.camera.viewMatrix,W(jt,c.origin)))),new H("proj",((c,_)=>_.camera.projectionMatrix)),new B("screenMinMaxSize",((c,_,f)=>U(Yt,f.useFixedSizes?0:f.minSizePx*_.camera.pixelRatio,O(c.isLeaf)*_.camera.pixelRatio))),c.useFixedSizes?new T("pointScale",((c,_)=>U(Yt,c.fixedSize*_.camera.pixelRatio,_.camera.fullHeight))):new B("pointScale",((c,_,f)=>U(Yt,c.splatSize*f.scaleFactor*_.camera.pixelRatio,_.camera.fullHeight/_.camera.pixelRatio)))),c.clippingEnabled?b.uniforms.add(new te("clipMin",((c,_,f)=>ie(Jt,f.clipBox[0]-c.origin[0],f.clipBox[1]-c.origin[1],f.clipBox[2]-c.origin[2]))),new te("clipMax",((c,_,f)=>ie(Jt,f.clipBox[3]-c.origin[0],f.clipBox[4]-c.origin[1],f.clipBox[5]-c.origin[2])))):(b.constants.add("clipMin","vec3",[-re,-re,-re]),b.constants.add("clipMax","vec3",[re,re,re])),f&&_.varyings.add("vColor","vec3"),b.code.add(ne`
    void main(void) {
      // Move clipped points outside of clipspace
      if (position.x < clipMin.x || position.y < clipMin.y || position.z < clipMin.z ||
        position.x > clipMax.x || position.y > clipMax.y || position.z > clipMax.z) {
        gl_Position = vec4(0.0,0.0,0.0,2.0);
        gl_PointSize = 0.0;
        return;
      }

      if (rejectBySlice(position)) {
        gl_Position = vec4(0.0,0.0,0.0,2.0);
        gl_PointSize = 0.0;
        return;
      }

      // Position in camera space
      vec4 camera = modelView * vec4(position, 1.0);

      float pointSize = pointScale.x;
      vec4 position = proj * camera;
     ${c.drawScreenSize?ne`
      float clampedScreenSize = pointSize;`:ne`
      float pointRadius = 0.5 * pointSize;
      vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);
      vec4 positionOffset = proj * cameraOffset;
      float radius = abs(positionOffset.y - position.y);
      float viewHeight = pointScale.y;
      // screen diameter = (2 * r / w) * (h / 2)
      float screenPointSize = (radius / position.w) * viewHeight;
      float clampedScreenSize = clamp(screenPointSize, screenMinMaxSize.x, screenMinMaxSize.y);
      // Shift towards camera, to move rendered point out of terrain i.e. to
      // the camera-facing end of the virtual point when considering it as a
      // 3D sphere.
      camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;
      position = proj * camera;`}

     gl_PointSize = clampedScreenSize;
     gl_Position = position;

     ${f?ne`vColor = color;`:""}
    }
  `),S.include(oe,c),m&&_.include(ae,c),S.code.add(ne`
    void main(void) {
        vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);
        float r2 = dot(vOffset, vOffset);

        if (r2 > 0.25) {
          discard;
        }
        ${m?ne`outputHighlight();`:""}
        ${f?ne`fragColor = vec4(vColor, 1.0);`:""}
    }
  `),_}function O(c){return c?256:64}const jt=le(),Jt=de(),Yt=he(),Kt=Object.freeze(Object.defineProperty({__proto__:null,PointRendererDrawParameters:P,PointRendererPassParameters:j,build:y,getMaxPointSizeScreenspace:O},Symbol.toStringTag,{value:"Module"}));class d extends pe{constructor(c,_,f){super(c,_,f)}initializeProgram(c){return new ge(c.rctx,d.shader.get().build(this.configuration),fe)}initializePipeline(){return be({depthTest:{func:ye.LESS},depthWrite:Se,colorWrite:Pe,stencilWrite:this.configuration.hasOccludees?xe:null,stencilTest:this.configuration.hasOccludees?ve:null,drawBuffers:this.configuration.output===D.Depth?{buffers:[we.NONE]}:null})}}d.shader=new ue(Kt,(()=>ce((()=>Promise.resolve().then((()=>ri))),void 0)));class r2 extends ze{constructor(){super(...arguments),this.output=D.Color,this.hasSlicePlane=!1,this.drawScreenSize=!1,this.useFixedSizes=!1,this.hasOccludees=!1,this.clippingEnabled=!1}}x([Ne({count:D.COUNT})],r2.prototype,"output",void 0),x([Ne()],r2.prototype,"hasSlicePlane",void 0),x([Ne()],r2.prototype,"drawScreenSize",void 0),x([Ne()],r2.prototype,"useFixedSizes",void 0),x([Ne()],r2.prototype,"hasOccludees",void 0),x([Ne()],r2.prototype,"clippingEnabled",void 0),x([Ne({constValue:!0})],r2.prototype,"hasSliceInVertexProgram",void 0);const Xt={positions:[new Ae(F.POSITION,3,Ce.FLOAT,0,12)],colors:[new Ae(F.COLOR,3,Ce.UNSIGNED_BYTE,0,3,!0)]};let Zt=class extends Re{constructor(c){super(c),this.type=Ie.PCL,this.isGround=!1,this._passParameters=new j,this._highlights=new h({forEachNode:c=>this.forEachNode(c),addHighlight:(c,_,f)=>this._addHighlight(c,_,f),removeHighlight:(c,_)=>this._removeHighlight(c,_)}),this.produces=new Map([[Oe.OPAQUE_MATERIAL,c=>!(Me(c)||c===D.Highlight&&this._highlights.empty)],[Oe.OPAQUE_NO_SSAO_DEPTH,c=>Me(c)]]),this.layerUid="",this._slicePlaneEnabled=!1,this._techniqueConfig=new r2,this._nodes=new ke}initializeRenderContext(c){this._context=c,c.requestRender()}uninitializeRenderContext(){}intersect(c,f,S,x){const v=de(),w=de(),z=de(),A=de(),C=Ee(),R=c.camera.perScreenPixelRatio/2,I=c.camera.near;De(w,x,S);const M=1/Ve(w);Fe(w,w,M),Le(z,w),qe(C,w[0],w[1],w[2],-_(w,S));const k=new ee,E=new ee,D=new Array,V=m(),F=m(this._passParameters.clipBox);We(F,-S[0],-S[1],-S[2],F),this._nodes.forAll((m=>{const L=m.splatSize*this._passParameters.scaleFactor;let q=m.obb.minimumDistancePlane(C),W=m.obb.maximumDistancePlane(C);q-=J(L,q+I,this._passParameters,R,m.isLeaf),W-=J(L,W+I,this._passParameters,R,m.isLeaf);const H=W<0,B=null!=k.dist&&null!=E.dist&&k.dist<q*M&&E.dist>W*M;if(H||B)return;const U=Y(L,W+I,this._passParameters,R,m.isLeaf);if(!m.obb.intersectRay(S,w,U))return;const T=U*U;m.obb.toAaBoundingBox(V),We(V,-S[0],-S[1],-S[2],V);const te=!b(F,V);De(A,m.origin,S);const ie=m.coordinates.length/3;for(let b=0;b<ie;b++){if(v[0]=A[0]+m.coordinates[3*b],v[1]=A[1]+m.coordinates[3*b+1],v[2]=A[2]+m.coordinates[3*b+2],te&&!Qe(F,v))continue;const C=_(v,w),V=He(v)-C*C;if(V>T)continue;let q=C+I;const W=J(L,q,this._passParameters,R,m.isLeaf);if(C-W<0)continue;q-=W;const H=Y(L,q,this._passParameters,R,m.isLeaf);if(V>H*H)continue;const B=(C-W)*M,S2=c=>(c.point=K(m,b,c.point),c.dist=B,c.normal=z,c.node=m,c.pointId=b,c.layerUid=this.layerUid,c);if((null==k.dist||B<k.dist)&&(null==f||f(S,x,B))&&S2(k),c.options.store!==Be.MIN&&(null==E.dist||B>E.dist)&&(null==f||f(S,x,B))&&S2(E),c.options.store===Be.ALL&&(null==f||f(S,x,B))){const c=new ee;D.push(S2(c))}}}));const N=c=>{const{layerUid:_,node:f,pointId:m}=c;return new Ze(c.point,_,m,(()=>this.createGraphic(f,m,c.point)))},C2=(c,_)=>{const f=N(_);c.set(this.type,f,_.dist,_.normal)};if(se(k)){const _=c.results.min;(null==_.dist||k.dist<_.dist)&&C2(_,k)}if(se(E)&&c.options.store!==Be.MIN){const _=c.results.max;(null==_.dist||E.dist>_.dist)&&C2(_,E)}if(c.options.store===Be.ALL){const _=$e(S,x);for(const f of D){const m=Ue(_);C2(m,f),c.results.all.push(m)}}}prepareTechnique(c){return 0!==this._nodes.length&&(c.output===D.Color||Me(c.output)&&c.bindParameters.slot===Oe.OPAQUE_NO_SSAO_DEPTH||c.output===D.Highlight)?(this._nodes.forAll((_=>{null==_.vao&&this._initNode(c,_)})),this._techniqueConfig.drawScreenSize=this._passParameters.drawScreenSpace,this._techniqueConfig.useFixedSizes=this._passParameters.useFixedSizes,this._techniqueConfig.hasSlicePlane=this._slicePlaneEnabled,this._techniqueConfig.hasOccludees=c.bindParameters.hasOccludees,this._techniqueConfig.clippingEnabled=this._clippingEnabled,this._techniqueConfig.output=c.output,this._context.techniques.releaseAndAcquire(d,this._techniqueConfig,this._technique)):null}renderNode(c,_){const f=c.rctx,m=f.bindTechnique(_,c.bindParameters,this._passParameters),b=c.output===D.Highlight;this._nodes.forAll((_=>{0===_.coordinates.length||b&&!_.highlights||(m.bindDraw(_,c.bindParameters,this._passParameters),f.bindVAO(_.vao),b?this._renderHighlightFragments(f,_):f.drawArrays(Te.POINTS,0,_.coordinates.length/3))}))}_renderHighlightFragments(c,_){const f=_.highlights;if(null==f)return;let m=f[0].component,b=m+1;for(let x=1;x<f.length;x++){const _=f[x].component;if(_!==b){const f=b-m;f>0&&c.drawArrays(Te.POINTS,m,f),m=_}b=_+1}const S=b-m;S>0&&c.drawArrays(Te.POINTS,m,S)}set useFixedSizes(c){this._passParameters.useFixedSizes!==c&&(this._passParameters.useFixedSizes=c,this._requestRender())}get useFixedSizes(){return this._passParameters.useFixedSizes}set scaleFactor(c){this._passParameters.scaleFactor!==c&&(this._passParameters.scaleFactor=c,this._requestRender())}get scaleFactor(){return this._passParameters.scaleFactor}set minSizePx(c){this._passParameters.minSizePx!==c&&(this._passParameters.minSizePx=c,this._requestRender())}get minSizePx(){return this._passParameters.minSizePx}set useRealWorldSymbolSizes(c){this._passParameters.useRealWorldSymbolSizes!==c&&(this._passParameters.useRealWorldSymbolSizes=c,this._requestRender())}get useRealWorldSymbolSizes(){return this._passParameters.useRealWorldSymbolSizes}set size(c){this._passParameters.size!==c&&(this._passParameters.size=c,this._requestRender())}get size(){return this._passParameters.size}set sizePx(c){this._passParameters.sizePx!==c&&(this._passParameters.sizePx=c,this._requestRender())}get sizePx(){return this._passParameters.sizePx}set clippingBox(c){Ge(this._passParameters.clipBox,c||M)}get _clippingEnabled(){return!je(this._passParameters.clipBox,M,((c,_)=>c===_))}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(c){this._slicePlaneEnabled!==c&&(this._slicePlaneEnabled=c,this._requestRender())}addNode(c){this._nodes.push(c),this._highlights.nodeAdded(c),this._requestRender()}removeNode(c){let _=null;return this._nodes.filterInPlace((f=>f.id!==c||(_=f,f.vao=Je(f.vao),this._highlights.nodeRemoved(f),!1))),this._requestRender(),_}forEachNode(c){this._nodes.forAll(c)}removeAll(){this._nodes.forAll((c=>c.vao=Je(c.vao))),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()}highlight(c){return this._highlights.add(c)}_addHighlight(c,_,f){c.highlights=function Z(c,_,f){null==c&&(c=[]);const m={component:_,id:f};c.push(m);const b=X(m);let S=c.length-1;for(;S>0&&b<X(c[S-1]);)[c[S-1],c[S]]=[c[S],c[S-1]],--S;return c}(c.highlights,_,f),this._requestRender()}_removeHighlight(c,_){c.highlights=function $(c,_){if(null==c)return c;const f=c.filter((c=>c.id!==_));return 0===f.length?null:f}(c.highlights,_),this._requestRender()}_initNode(c,_){const f=c.rctx;_.vao=new Ye(f,fe,Xt,{positions:Ke.createVertex(f,Xe.STATIC_DRAW,_.coordinates),colors:Ke.createVertex(f,Xe.STATIC_DRAW,_.rgb)})}_requestRender(){this._context&&this._context.requestRender()}};x([v({constructOnly:!0})],Zt.prototype,"createGraphic",void 0),Zt=x([w("esri.views.3d.layers.i3s.PointRenderer")],Zt);class G extends P{constructor(c,_,f,m,b,S,x,v,w=null,z=null){super(f,b,_),this.id=c,this.obb=m,this.coordinates=S,this.rgb=x,this.attributes=v,this.pointIdFilterMap=w,this.highlights=z}}function Y(c,_,f,m,b){if(f.drawScreenSpace)return f.fixedSize*_*m;const S=O(b)*_*m;return f.useFixedSizes?Math.min(f.fixedSize/2,S):f.screenMinSize>0?Math.min(Math.max(f.screenMinSize*_*m,c/2),S):Math.min(c/2,S)}function J(c,_,f,m,b){return f.drawScreenSpace?0:Y(c,_,f,m,b)}function K(c,_,f){return null==f&&(f=de()),f[0]=c.origin[0]+c.coordinates[3*_],f[1]=c.origin[1]+c.coordinates[3*_+1],f[2]=c.origin[2]+c.coordinates[3*_+2],f}function X(c){return null!=c.component?c.component:-1}class ee{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}}function se(c){return null!=c.dist&&null!=c.point&&null!=c.pointId&&null!=c.node}const ei=Ee();let ti=class extends(Lt(kt(qt))){constructor(){super(...arguments),this.type="point-cloud-3d",this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new et,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[],this.ignoresMemoryFactor=!1}get baseUrl(){var c;return(null==(c=this.layer.parsedUrl)?void 0:c.path)??""}get pointScale(){var c;const _=function n(c){const _=null==c?void 0:c.pointSizeAlgorithm;return _&&"splat"===_.type?_:null}(null==(c=this.layer)?void 0:c.renderer);return null!=(null==_?void 0:_.scaleFactor)?_.scaleFactor:1}get useRealWorldSymbolSizes(){var c;const _=o2(null==(c=this.layer)?void 0:c.renderer);return null!=(null==_?void 0:_.useRealWorldSymbolSizes)&&_.useRealWorldSymbolSizes}get pointSize(){var c;const _=o2(null==(c=this.layer)?void 0:c.renderer);return null!=(null==_?void 0:_.size)?_.size:0}get inverseDensity(){var c;return(null==(c=this.layer)?void 0:c.renderer)?96/this.layer.renderer.pointsPerInch:5}get availableFields(){const c=t(this.layer),_=new Set;c.primaryAttribute&&_.add(c.primaryAttribute.name),c.modulationAttribute&&_.add(c.modulationAttribute.name);const f=e$1(this.layer);if(f)for(const m of f)m.attributeInfo&&_.add(m.attributeInfo.name);if(this.layer.outFields)for(const m of tt(this.layer.fieldsIndex,this.layer.outFields))_.add(m);return Array.from(_)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const c=m(),_=this.view.renderSpatialReference;return it(this.view.clippingArea,c,_)?c:null}get _elevationOffset(){const c=this.layer&&this.layer.elevationInfo;return c&&"absolute-height"===c.mode?st(c,this.layer.spatialReference):0}initialize(){const c=this.view.resourceController,_=function me(c){return _=>c.immediate.schedule(_)}(c);this._worker=new Ht(_),this.addResolvingPromise(this._worker.promise),rt(this.layer),nt(this.layer,this.view),this._indexRequester=c.createStreamDataRequester(ot.I3S_INDEX),this._dataRequester=c.createStreamDataRequester(ot.I3S_DATA),this._initRenderer();const f=this._initNodePages(),m=this.view.resourceController.memoryController;this._memCache=m.newCache(`pcl-${this.layer.uid}`),this._updatingHandles.add((()=>this._clippingBox),(()=>this._setUpdateViewNeeded()),at),this._updatingHandles.add((()=>this._elevationOffset),(()=>this._elevationOffsetChanged()),at),this._updatingHandles.add((()=>this.layer.renderer),(()=>this._rendererChanged()),at),this._updatingHandles.add((()=>this.layer.filters),(()=>this._reload()),at),this._updatingHandles.add((()=>this.layer.outFields),(()=>this._reload()),at),this._updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this._setUpdateViewNeeded())),this._updatingHandles.add((()=>this.view.state.contentCamera),(()=>this._setUpdateViewNeeded())),this.addHandles([lt((()=>this.view.quality),(()=>this._setUpdateViewNeeded()),dt)]),this.addResolvingPromise(f),this.when((()=>{this.addHandles([c.scheduler.registerTask(ht.POINT_CLOUD_LAYER,this),c.scheduler.registerIdleStateCallbacks((()=>this._idleBegin()),(()=>this._idleEnd())),this._updatingHandles.add((()=>this.suspended),(c=>{c?this._clearNodeState():this._setUpdateViewNeeded()}),at)])}),(()=>{this._updatingHandles.removeAll(),this.removeAllHandles()}))}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker=ut(this._worker),this._destroyRenderer(),this._memCache=ut(this._memCache),this._codedDomainPopulationAbortController=ct(this._codedDomainPopulationAbortController),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new Zt({createGraphic:(c,_,f)=>this._createGraphic(c,_,f)}),this._renderer.layerUid=this.layer.uid,this._updatingHandles.add((()=>this._clippingBox),(c=>this._renderer.clippingBox=c),at),this._updatingHandles.add((()=>this.suspended),(c=>this._setPointsVisible(!c)),at),this._updatingHandles.add((()=>this.pointScale),(c=>this._renderer.scaleFactor=c),at),this._renderer.minSizePx=Math.sqrt(2),this._updatingHandles.add((()=>this.useRealWorldSymbolSizes),(c=>this._renderer.useRealWorldSymbolSizes=c),at),this._updatingHandles.add((()=>this.pointSize),(c=>{const _=Ot(c);this._renderer.size=c,this._renderer.sizePx=_}),at),this._updatingHandles.add((()=>this.slicePlaneEnabled),(c=>this._renderer.slicePlaneEnabled=c),at),this._updatingHandles.add((()=>this.inverseDensity),(()=>this._setUpdateViewNeeded()),at),this._updatingHandles.add((()=>this.maximumPointCount),(()=>this._setUpdateViewNeeded()),at),this._updatingHandles.add((()=>this.view.qualitySettings.sceneService.pointCloud.lodFactor),(c=>{this._lodFactor=c,this._setUpdateViewNeeded()}),at)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(c,_,f){const m=null!=c.pointIdFilterMap?c.pointIdFilterMap[_]:_,b=pt(this.view,f),S=this._createGraphicAttributes(c,m);return new Gt({pointCloudMetadata:{nodeId:c.id,pointIndexInNode:_,attributePointIndexInNode:m,epoch:this._nodeLoadEpoch},geometry:b,attributes:S,layer:this.layer,sourceLayer:this.layer})}_createGraphicAttributes(c,_){const f={};for(const m of c.attributes)this._encodeGraphicAttribute(m.attributeInfo,m.values,_,f);return f}_encodeGraphicAttribute(c,_,f,m){var b;const S=null==(b=c.storageInfo)?void 0:b.attributeValues,x=(null==S?void 0:S.valuesPerElement)??1;if(1===x)m[c.name]=_[f];else if("UInt8"===(null==S?void 0:S.valueType)&&x<=4){let b=0;const S=f*x;for(let c=S;c<S+x;c++)b=(b<<8)+_[c];m[c.name]=b}else m[c.name]=void 0}_setPointsVisible(c){c&&!this._rendererAdded?(this.view._stage.addRenderPlugin(this._renderer),this._rendererAdded=!0):!c&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=function l(c){const _=null==c?void 0:c.pointSizeAlgorithm;return!!(null==_?void 0:_.type)&&"fixed-size"===_.type}(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_displayNodes(c){this._workQueue=function t$1(c,_,f){for(let b=0;b<_.length;b++)Ut[b]=!1,Tt[b]=null;for(let b=0;b<c.length;b++)Bt[b]=!1,$t[b]=null;for(let b=0;b<_.length;b++){const m=h$2(_[b],c,f);m>=0&&(Ut[b]=!0,null!=$t[m]?$t[m].push(_[b]):$t[m]=[_[b]])}for(let b=0;b<c.length;b++){const m=h$2(c[b],_,f);m>=0&&(Bt[b]=!0,null!=Tt[m]?Tt[m].push(c[b]):Tt[m]=[c[b]])}const m=[];for(let b=0;b<c.length;b++)null!=$t[b]||Bt[b]||m.push({load:[],remove:[c[b]]});for(let b=0;b<_.length;b++)null!=Tt[b]||Ut[b]||m.push({load:[_[b]],remove:[]});for(let b=0;b<_.length;b++)null!=Tt[b]&&(Tt[b].length>1||Tt[b][0]!==_[b])&&m.push({load:[_[b]],remove:Tt[b]});for(let b=0;b<c.length;b++)null!=$t[b]&&($t[b].length>1||$t[b][0]!==c[b])&&m.push({load:$t[b],remove:[c[b]]});return m}([...this._renderedNodes],c,this._index),function g(c,f,m){return c.sort(((c,b)=>{if(0===c.load.length&&0===b.load.length)return 0;if(0===c.load.length)return-1;if(0===b.load.length)return 1;if(0===c.remove.length&&0===b.remove.length){const S=m.getRenderObb(c.load[0]).center,x=m.getRenderObb(b.load[0]).center;return _(S,f)-_(x,f)}if(0===c.remove.length)return-1;if(0===b.remove.length)return 1;if(1===c.load.length&&1===b.load.length){const S=m.getRenderObb(c.load[0]).center,x=m.getRenderObb(b.load[0]).center;return _(S,f)-_(x,f)}if(1===c.load.length)return-1;if(1===b.load.length)return 1;{const S=m.getRenderObb(c.remove[0]).center,x=m.getRenderObb(b.remove[0]).center;return _(S,f)-_(x,f)}}))}(this._workQueue,this.view.state.contentCamera.viewForward,this._index),function u$1(c,_,f){for(let m=0;m<c.length;++m){const b=c[m];b.load.length>_&&1===b.remove.length&&d$1(c,b,f)}}(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=c.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){const c=new Array;this._loadingNodes.forEach((({abortController:_})=>c.push(_))),this._loadingNodes.clear();for(const _ of c)_.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){const c=new Set;this._workQueue.forEach((_=>_.load.forEach((_=>c.add(_)))));const _=new Array,f=new Map;this._loadingNodes.forEach(((m,b)=>{c.has(b)?f.set(b,m):_.push(m)})),this._loadingNodes=f;for(const{abortController:m}of _)m.abort();this._workQueue=this._workQueue.filter((c=>{for(const _ of c.load)if(this._loadingNodes.has(_))return this._recalcWork=!0,!1;return!0})),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach((({abortController:c})=>c.abort())),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach((c=>this._removeFromRenderer(c))),this._cancelNodeLoading()}_idleBegin(){this._setUpdateViewNeeded()}_idleEnd(){this._setUpdateViewNeeded()}get running(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.running}runTask(c){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const c=this._isRootNodeVisible();c!==this._layerIsVisible&&(this._layerIsVisible=c,this.notifyChange("suspended")),this._updateLoading()}}else{for(c.run((()=>this._updateWorkQueues()));this._indexQueue.length>0&&c.run((()=>this._processIndexQueue())););this._processWorkQueue(c),this._idleQueue.runTask(c)}}_processIndexQueue(){const c=this._indexQueue.shift(),_=this._loadNodePage(c);return this._indexPagesLoading.set(c,_),_.promise.then((_=>{this._index.addPage(c,_,this._elevationOffset),this._setUpdateViewNeeded()})).then((()=>{this._indexPagesLoading.delete(c)}),(()=>{this._indexPagesLoading.delete(c)})),!0}_processWorkQueue(c){for(;!c.done;){const _=this._scheduleWorkEntry();if(null==_)return void c.madeProgress();this._processWorkEntry(_),c.madeProgress()}}_scheduleWorkEntry(){let c=this._workQueue.length;for(;c--;){const c=this._workQueue.shift();if(!c.remove.find((c=>!this._renderedNodes.has(c))))return c;this._workQueue.push(c)}return null}_processWorkEntry(c){if(0!==c.load.length)Promise.all(c.load.map((c=>{const _=new AbortController,f=this._memCache.pop(c.toString());return null!=f?this._loadingNodes.set(c,{abortController:_,promise:Promise.resolve(f)}):this._loadingNodes.has(c)||this._loadingNodes.set(c,{abortController:_,promise:this._loadNode(c,_.signal)}),this._loadingNodes.get(c).promise}))).then((_=>{for(let f=0;f<c.load.length;f++)if(_[f]){const m=this._setupRendererData(c.load[f],_[f]);this._addToRenderer(m)}for(const f of c.remove)this._removeFromRenderer(f)})).catch((()=>{})).then((()=>{for(const _ of c.load)this._loadingNodes.delete(_);this._updateLoading(),this._recalcWork&&!this._idleQueue.running&&0===this._indexQueue.length&&0===this._loadingNodes.size&&(this._recalcWork=!1,this._setUpdateViewNeeded())})),this._updateLoading();else for(const _ of c.remove)this._removeFromRenderer(_)}async _populateClassCodeCodedDomain(c,_){var f,m,b;const S="CLASS_CODE",x=this.layer.fieldsIndex.get(S);if(!x||x.domain)return;if(!c.includes(x.name))return;const v=await _t(this.layer.queryCachedStatistics(S,{signal:_}));if(!1===v.ok)return;const w=null==(b=null==(m=null==(f=v.value)?void 0:f.stats)?void 0:m.labels)?void 0:b.labels;w&&Array.isArray(w)&&(x.domain=new gt({name:"CLASS_CODE",codedValues:w.map((c=>new ft({code:c.value,name:c.label})))}))}async prepareFetchPopupFeatures(c){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=new AbortController,this._codedDomainPopulationPromise=this._populateClassCodeCodedDomain(c,this._codedDomainPopulationAbortController.signal).then((()=>{this._codedDomainPopulationAbortController=null}))),this._codedDomainPopulationPromise}async whenGraphicAttributes(c,_){const f=this._splitGraphicsPerNode(c),m=this.layer.attributeStorageInfo,b=_.map((c=>u(m,c))).filter(mt),a2=async(c,_)=>{const f=this._index.getNode(_);await Mt(b,(async _=>{const m=_.useElevation?await this._loadElevationAttributeFromGeometry(f.resourceId):await this._loadAndParseAttribute(f,_);if(m)for(const f of c)if(this._isValidPointGraphic(f)){const c=f.pointCloudMetadata.attributePointIndexInNode;this._encodeGraphicAttribute(_,m,c,f.attributes)}}))},S=[];return f.forEach(((c,_)=>{S.push(a2(c,_))})),await Promise.allSettled(S),c}_isValidPointGraphic(c){var _;return c instanceof Gt&&(null==(_=c.pointCloudMetadata)?void 0:_.epoch)===this._nodeLoadEpoch}_splitGraphicsPerNode(c){const _=new Map;for(const f of c){if(!this._isValidPointGraphic(f))continue;const c=f.pointCloudMetadata,m=_.get(c.nodeId);m?m.push(f):_.set(c.nodeId,[f])}return _}async _loadAndParseAttribute(c,_){const f=await this._loadAttribute(c.resourceId,_,null);return null!=f?Dt({attributeInfo:_,buffer:f},null,c.vertexCount):null}async _loadElevationAttributeFromGeometry(c){const _=this.layer.store.defaultGeometrySchema,f=Vt(_,await this._loadGeometry(c,null));return Ft(f,f.length/3)}highlight(c){if(!c)return A();const _=bt.isCollection(c)?c.toArray():Array.isArray(c)?c:[c];return this._renderer.highlight(_.map((c=>this._graphicToPointDefinition(c))))}_graphicToPointDefinition(c){if(!this._isValidPointGraphic(c))return null;const{nodeId:_,pointIndexInNode:f}=c.pointCloudMetadata;return null!=_&&null!=f?{nodeId:_,pointId:f}:null}_computeWork(){let c=0;for(const _ of this._workQueue)c+=_.load.length+_.remove.length;return c+=this._loadingNodes.size,c+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,c+=this._loadingInitNodePage?100:0,c+=this._updateViewNeeded?100:0,c}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const c=this._computeWork();return 1-Math.min(this._totalWork,c)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}get visibleAtCurrentScale(){return yt(this.layer.effectiveScaleRange,this.view.terrainScale)}_initNodePages(){const c=this.layer.store.index,_=c.nodesPerPage||c.nodePerIndexBlock;return this._index=new i(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,_),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=c.nodesPerPage?1:c.nodePerIndexBlock,this._loadNodePage(0).promise.then((c=>{this._index.addPage(0,c,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()}))}_loadNodePage(c){const _=new AbortController,f=`${this.baseUrl}/nodepages/${c*this._pageMultiplier}`;return{promise:this._requestNodePage(f,_.signal).then((_=>_.nodes.map(((_,f)=>({resourceId:null!=_.resourceId?_.resourceId:c*this._index.pageSize+f,obb:St.fromJSON(_.obb),obbInRenderSR:new St,firstChild:_.firstChild,childCount:_.childCount,vertexCount:_.vertexCount??_.pointCount,lodThreshold:_.lodThreshold??_.effectiveArea}))))),abortController:_}}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;const c=this.view.quality;let _=this.inverseDensity/this._lodFactor*c;const f=this.maximumPointCount*this._lodFactor*c;let m=this._computeNodesForMinimumDensity(_),b=this._computePointCount(m),S=Math.sqrt(b/(.75*f));for(;b>f;)_*=S,m=this._computeNodesForMinimumDensity(_),b=this._computePointCount(m),S=Math.sqrt(2);return this._displayNodes(m),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(c){let _=0;for(let f=0;f<c.length;f++){const m=this._index.getNode(c[f]);m&&(_+=m.vertexCount)}return _}_isRootNodeVisible(){let c=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(_,f,m)=>(c=m,!1),pageMiss:()=>{}}),c}_computeNodesForMinimumDensity(c){const f=this.view.state.contentCamera,m=f.frustum,b=this._clippingBox,S=f.viewForward,x=_(S,f.eye),v=Pt(S,-x,ei),w=f.perScreenPixelRatio/2,z=c*c,A=this._nodeIdArray;A.length=0;const h2=c=>A.push(c);return this._traverseVisible({frustum:m,clippingBox:b},{predicate:(c,_,f)=>{if(!f)return!1;if(0===_.childCount)return h2(c),!1;const m=this._index.getRenderObb(c);return!(this._computeAveragePixelArea(m,_.lodThreshold,_.vertexCount,v,w)<=z&&(h2(c),1))},pageMiss:(c,_)=>{h2(c),this._indexQueue.includes(_)||this._indexQueue.push(_)}}),A}_computeAveragePixelArea(c,_,f,m,b){const S=Math.max(1e-7,c.minimumDistancePlane(m));return _/(S*S)/(4*b*b)/f}_loadNode(c,_){try{return this._loadNodeAsync(c,_)}catch(f){throw xt(f)||vt.getLogger(this).error(f),f}}async _loadAdditionalUserAttributes(c,_,f){const m=this.layer.outFields;if(!m)return[];const b=tt(this.layer.fieldsIndex,m),S=new Set(c.map((c=>null!=c?c.name:null))),x=this.layer.attributeStorageInfo,v=[];for(const z of b){if(S.has(z))continue;const c=u(x,z);c&&v.push(_(c))}const w=await wt(v);return Nt(f),w.filter(mt)}async _loadNodeAsync(c,_){const f=this._index.getNode(c),m=t(this.layer),b=e$1(this.layer),S=f.resourceId,n2=async c=>{if(!c)return null;if(c.useElevation)return{attributeInfo:c,buffer:null};const f=await this._loadAttribute(S,c,_);return null!=f?{attributeInfo:c,buffer:f}:null};return this._idleQueue.push((async()=>{const f=this._loadGeometry(S,_),{primaryAttribute:x,modulationAttribute:v}=m,w=n2(x),z=n2(v),A=b.map((c=>c.attributeInfo)),C=A.map((c=>n2(c))),R=this._loadAdditionalUserAttributes([x,v,...A],n2,_),[I,M,k,E,D]=await Promise.all([f,w,z,Promise.all(C),R]);Nt(_);const V={geometryBuffer:I,primaryAttributeData:M,modulationAttributeData:k,filterAttributesData:E,userAttributesData:D,schema:this.layer.store.defaultGeometrySchema,rendererInfo:m,filterInfo:b,obbData:this._index.getRenderObb(c).data,elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()};return this._worker.invoke(V,_)}),_)}async _loadGeometry(c,_){return this._requestData(`${this.baseUrl}/nodes/${c}/geometries/0`,_)}async _loadAttribute(c,_,f){if(!(null==_?void 0:_.storageInfo))return null;const m=_.storageInfo.key;return this._requestData(`${this.baseUrl}/nodes/${c}/attributes/${m}`,f)}_requestNodePage(c,_){const f={f:"json",...this.layer.customParameters,token:this.layer.apiKey};return this._indexRequester.request(c,"json",{query:f,signal:_})}_requestData(c,_){return this._dataRequester.request(c,"binary",{query:{...this.layer.customParameters,token:this.layer.apiKey},signal:_})}_removeFromRenderer(c){if(this._renderedNodes.has(c)){const _=this._renderer.removeNode(c);this._renderedNodes.delete(c),this._memCache.put(_.id.toString(),_,function _e(c){return 5*c.coordinates.length+128}(_))}}_addToRenderer(c){this._renderedNodes.has(c.id)||(this._renderedNodes.add(c.id),this._renderer.addNode(c))}_setupRendererData(c,_){const f=this._index.getNode(c),m=Math.sqrt(f.lodThreshold/f.vertexCount),b=this._index.getRenderObb(c);if(function Q(c){return c.hasOwnProperty("splatSize")}(_))return _.splatSize=m,_.obb=b,zt(_.origin,_.obb.center),_;const S=St.fromData(_.obbData),x=S.halfSize,v=b.halfSize,w=.01*Math.max(v[0],v[1],v[2]);if(x[0]>v[0]+w||x[1]>v[1]+w||x[2]>v[2]+w){if(this._maxLoggedBoxWarnings>0){const t3=c=>`[${c.halfSize[0]}, ${c.halfSize[1]}, ${c.halfSize[2]}]`;vt.getLogger(this).warn(`Node ${c} reported bounding box too small. got ${t3(b)} but points cover ${t3(S)}`),0==--this._maxLoggedBoxWarnings&&vt.getLogger(this).warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(c,S)}return new G(c,m,At(b.center),b,0===f.childCount,_.points,_.rgb,_.attributes,_.pointIdFilterMap)}get usedMemory(){let c=0;return this._renderer.forEachNode((_=>{c+=si,c+=Ct(_.coordinates);for(const f of _.attributes){const _=f.values;Rt(_.buffer)&&(c+=Ct(_))}})),c}get unloadedMemory(){const c=this._renderedNodes.size;if(c<4)return 0;const _=[...this._renderedNodes].reduce(((c,_)=>c+this._index.getNode(_).vertexCount));let f=this._loadingNodes.size;for(let m=0;m<this._workQueue.length;m++)f+=this._workQueue[m].load.length,f-=this._workQueue[m].remove.length;return f<0?0:f*_/c*((this.usedMemory-c*si)/_)+f*si}get performanceInfo(){return new Wt(this.usedMemory,this._renderedNodes.size,[...this._renderedNodes].reduce(((c,_)=>c+this._index.getNode(_).vertexCount),0),this.maximumPointCount,new Qt(this._loadingNodes.size,this._indexQueue.length,this._workQueue.length,this._idleQueue.length))}get test(){}};x([v()],ti.prototype,"layer",void 0),x([v()],ti.prototype,"baseUrl",null),x([v()],ti.prototype,"pointScale",null),x([v()],ti.prototype,"useRealWorldSymbolSizes",null),x([v()],ti.prototype,"pointSize",null),x([v()],ti.prototype,"inverseDensity",null),x([v()],ti.prototype,"maximumPointCount",void 0),x([v({readOnly:!0})],ti.prototype,"availableFields",null),x([v({readOnly:!0})],ti.prototype,"_clippingBox",null),x([v({readOnly:!0})],ti.prototype,"_elevationOffset",null),x([v({type:Boolean})],ti.prototype,"slicePlaneEnabled",void 0),x([v()],ti.prototype,"updating",void 0),x([v(It)],ti.prototype,"updatingProgress",void 0),x([v({readOnly:!0})],ti.prototype,"updatingProgressValue",null),x([v({readOnly:!0})],ti.prototype,"visibleAtCurrentScale",null),ti=x([w("esri.views.3d.layers.PointCloudLayerView3D")],ti);const ii=ti;const si=160;const ri=Object.freeze(Object.defineProperty({__proto__:null,PointRendererDrawParameters:P,PointRendererPassParameters:j,build:y,getMaxPointSizeScreenspace:O},Symbol.toStringTag,{value:"Module"}));export{ii as default};
