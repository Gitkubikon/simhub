import{b as e,b3 as t,fe as s,aY as a,x as r,n as o,bl as i,W as n,G as u,fi as l,fj as h}from"./index-DSIPxOWi.js";import{m as c}from"./FeatureStore-Dpo5Syxq.js";import{x as m,$ as p,j as d}from"./QueryEngine-DAD9skS_.js";import{E as g,N as y}from"./geojson-CFL0cZN1.js";import{p as _}from"./sourceUtils-BFIlJ45V.js";import{o as f,e as x,K as C}from"./wfsUtils-fdslda3j.js";import"./BoundsStore-BQ0MOdb7.js";import"./PooledRBush-DOZnXWx2.js";import"./quickselect-D9ta8ndX.js";import"./optimizedFeatureQueryEngineAdapter--U1rvwBV.js";import"./normalizeUtils-BrH-PrZy.js";import"./normalizeUtilsCommon-BU8xfl77.js";import"./WhereClause-DYd7Xwn9.js";import"./TimeOnly-C5lZbbIX.js";import"./json-omtrO2vq.js";import"./QueryEngineCapabilities-CTDe3LlQ.js";import"./utils-B-uQJqPz.js";import"./utils-DEUXBrCj.js";import"./utils-1_4Re7um.js";import"./ClassBreaksDefinition-Dt1HCCB7.js";import"./date-Do_V47iR.js";import"./xmlUtils-DL7icO0w.js";const w="esri.layers.WFSLayer";class R{constructor(){this._customParameters=null,this._queryEngine=null,this._supportsPagination=!0}destroy(){var e;null==(e=this._queryEngine)||e.destroy(),this._queryEngine=null}async load(r,o={}){const{getFeatureUrl:i,getFeatureOutputFormat:n,fields:u,geometryType:l,featureType:h,maxRecordCount:d,maxTotalRecordCount:g,maxPageCount:y,objectIdField:_,customParameters:x}=r,{spatialReference:C,getFeatureSpatialReference:w}=f(i,h,r.spatialReference);try{await m(w,C)}catch{throw new e("unsupported-projection","Projection not supported",{inSpatialReference:w,outSpatialReference:C})}t(o),this._customParameters=x,this._featureType=h,this._fieldsIndex=s.fromLayerJSON({fields:u,dateFieldsTimeReference:u.some((e=>"esriFieldTypeDate"===e.type))?{timeZoneIANA:a}:null}),this._geometryType=l,this._getFeatureUrl=i,this._getFeatureOutputFormat=n,this._getFeatureSpatialReference=w,this._maxRecordCount=d,this._maxTotalRecordCount=g,this._maxPageCount=y,this._objectIdField=_,this._spatialReference=C;let j=await this._snapshotFeatures(o);if(j.errors.length>0&&(this._supportsPagination=!1,j=await this._snapshotFeatures(o),j.errors.length>0))throw j.errors[0];return this._queryEngine=new p({fieldsIndex:this._fieldsIndex,geometryType:l,hasM:!1,hasZ:!1,objectIdField:_,spatialReference:C,timeInfo:null,featureStore:new c({geometryType:l,hasM:!1,hasZ:!1})}),this._queryEngine.featureStore.addMany(j.features),{warnings:T(j),extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async applyEdits(){throw new e("wfs-source:editing-not-supported","applyEdits() is not supported on WFSLayer")}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForSnapping(e,t.signal)}async refresh(e){var t;return this._customParameters=e.customParameters,this._maxRecordCount=e.maxRecordCount,this._maxTotalRecordCount=e.maxTotalRecordCount,this._maxPageCount=e.maxPageCount,null==(t=this._snapshotTask)||t.abort(),this._snapshotTask=r((e=>this._snapshotFeatures({signal:e}))),this._snapshotTask.promise.then((e=>{var t;this._queryEngine.featureStore.clear(),this._queryEngine.featureStore.addMany(e.features);for(const s of T(e))o.getLogger(w).warn(new i("wfs-layer:refresh-warning",s.message,s.details));(null==(t=e.errors)?void 0:t.length)&&o.getLogger(w).warn(new i("wfs-layer:refresh-error","Refresh completed with errors",{errors:e.errors}))}),(()=>{this._queryEngine.featureStore.clear()})),await this._waitSnapshotComplete(),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _snapshotFeatures(e){const s=null==e?void 0:e.signal,a=this._maxTotalRecordCount,r=this._maxPageCount,o=this._supportsPagination?await x(this._getFeatureUrl,this._featureType.typeName,{customParameters:this._customParameters,signal:s}):void 0;let i=[];const u=[];if(null==o)try{i=await this._singleQuery(s)}catch(l){n(l)||u.push(l)}else{const e=Math.min(o,a),t=function*F(e,t,s){for(let a=0;a<t;a++)yield e._pageQuery(a,s)}(this,Math.max(1,Math.min(Math.ceil(e/this._maxRecordCount),r)),s);await Promise.allSettled(Array.from({length:10}).map((()=>async function S(e,t,s){let a=e.next();for(;!a.done;){try{const e=await a.value;t.push(...e)}catch(r){n(r)||s.push(r)}a=e.next()}}(t,i,u))))}return t(s),{features:i,totalRecordCount:o,maxTotalRecordCount:a,maxPageCount:r,errors:u}}async _singleQuery(e){const t=await C(this._getFeatureUrl,this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,signal:e});return this._processGeoJSON(t,{signal:e})}async _pageQuery(e,t){const s=e*this._maxRecordCount,a=await C(this._getFeatureUrl,this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,startIndex:s,count:this._maxRecordCount,signal:t});return this._processGeoJSON(a,{startIndex:s,signal:t})}_processGeoJSON(e,s){g(e,this._getFeatureSpatialReference.wkid);const{startIndex:a,signal:r}=s;t(r);const o=y(e,{geometryType:this._geometryType,hasZ:!1,objectIdField:this._objectIdField});if(!u(this._spatialReference,this._getFeatureSpatialReference))for(const t of o)null!=t.geometry&&(t.geometry=l(d(h(t.geometry,this._geometryType,!1,!1),this._getFeatureSpatialReference,this._spatialReference)));let i=a??1;for(const t of o){const e={};_(this._fieldsIndex,e,t.attributes,!0),t.attributes=e,null==e[this._objectIdField]&&(t.objectId=e[this._objectIdField]=i++)}return o}}function T(e){const t=[];return null!=e.totalRecordCount&&(e.features.length<e.totalRecordCount&&t.push({name:"wfs-layer:maxRecordCount-too-low",message:`Could only fetch ${e.features.length} of ${e.totalRecordCount} in ${e.maxPageCount} queries. Try increasing the value of WFSLayer.maxRecordCount.`,details:{recordCount:e.features.length,totalRecordCount:e.totalRecordCount}}),e.totalRecordCount>e.maxTotalRecordCount&&t.push({name:"wfs-layer:large-dataset",message:`The number of ${e.totalRecordCount} features exceeds the maximum allowed of ${e.maxTotalRecordCount}.`,details:{recordCount:e.features.length,totalRecordCount:e.totalRecordCount,maxTotalRecordCount:e.maxTotalRecordCount}})),t}export{R as default};
