import{O as n,n as r,t as s,s as i,a as l,r as o}from"./WhereClause-DYd7Xwn9.js";import{D as c,ap as _,aq as $,ar as C,as as P,at as N,au as U,av as G,aw as B,ax as H,ay as Y,az as Z,aA as Q,aB as K,aC as j,aD as J,aE as W}from"./arcadeUtils-CHsZDnQG.js";import{n as z,m as V,a as X}from"./TimeOnly-C5lZbbIX.js";import{l8 as ee,I as te,fe as ne,g$ as ae}from"./index-DSIPxOWi.js";import{union as re,geodesicArea as se,planarArea as ie,geodesicLength as le,planarLength as oe,relate as ue,crosses as ce,touches as he,within as de,overlaps as pe,contains as fe,intersects as _e}from"./geometryEngineAsync--5NbEF1a.js";class a{constructor(){this._databaseTypeMetaData={},this._layerInfo={}}clearDatabaseType(n){void 0===this._databaseTypeMetaData[n]&&delete this._databaseTypeMetaData[n]}getDatabaseType(n){return"MUSTBESET"===n||void 0===this._databaseTypeMetaData[n]?null:this._databaseTypeMetaData[n]}setDatabaseType(n,r){this._databaseTypeMetaData[n]=r}getLayerInfo(n){return void 0===this._layerInfo[n]?null:this._layerInfo[n]}setLayerInfo(n,r){this._layerInfo[n]=r}clearLayerInfo(n){void 0!==this._layerInfo[n]&&delete this._layerInfo[n]}}a.applicationCache=null;class e{constructor(n,r){this._lastId=-1,this._progress=r,this._parent=n}reset(){this._lastId=-1}async nextBatchAsArcadeFeatures(n,r){const s=await this.nextBatch(n);return null===s?s:s.map((n=>c.createFromGraphicLikeObject(n.geometry,n.attributes,this._parent,r)))}nextBatch(n){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then((r=>this.nextBatch(n)),(r=>this.nextBatch(n)));const r={returnpromise:null,hasset:!1},s=[];return r.returnpromise=new Promise(((i,l)=>{this._parent._getSet(this._progress).then((o=>{const c=o._known;let _=c.length-1;if("GETPAGES"===c[c.length-1]&&(_-=1),this._lastId+n>_&&c.length>0&&"GETPAGES"===c[c.length-1])return void this._parent._expandPagedSet(o,this._parent._maxQueryRate(),0,0,this._progress).then((s=>{r.hasset=!0,this._parent._mainSetInUse=null,this.nextBatch(n).then(i,l)}),(n=>{r.hasset=!0,this._parent._mainSetInUse=null,l(n)}));const $=o._candidates;if(_>=this._lastId+n||0===$.length){for(let r=0;r<n;r++){const n=r+this._lastId+1;if(n>=c.length)break;s[r]=c[n]}return this._lastId+=s.length,0===s.length&&(r.hasset=!0,this._parent._mainSetInUse=null,i([])),void this._parent._getFeatureBatch(s,this._progress).then((n=>{r.hasset=!0,this._parent._mainSetInUse=null,i(n)}),(n=>{r.hasset=!0,this._parent._mainSetInUse=null,l(n)}))}this._parent._refineSetBlock(o,this._parent._maxProcessingRate(),this._progress).then((()=>{r.hasset=!0,this._parent._mainSetInUse=null,this.nextBatch(n).then(i,l)}),(n=>{r.hasset=!0,this._parent._mainSetInUse=null,l(n)}))}),(n=>{r.hasset=!0,this._parent._mainSetInUse=null,l(n)}))})),!1===r.hasset&&(this._parent._mainSetInUse=r.returnpromise,r.hasset=!0),r.returnpromise}next(){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then((n=>this.next()),(n=>this.next()));const n={returnpromise:null,hasset:!1};return n.returnpromise=new Promise(((r,s)=>{this._parent._getSet(this._progress).then((i=>{const l=i._known;this._lastId<l.length-1?"GETPAGES"===l[this._lastId+1]?this._parent._expandPagedSet(i,this._parent._maxQueryRate(),0,0,this._progress).then((r=>(n.hasset=!0,this._parent._mainSetInUse=null,this.next()))).then(r,s):(this._lastId+=1,this._parent._getFeature(i,l[this._lastId],this._progress).then((s=>{n.hasset=!0,this._parent._mainSetInUse=null,r(s)}),(r=>{n.hasset=!0,this._parent._mainSetInUse=null,s(r)}))):i._candidates.length>0?this._parent._refineSetBlock(i,this._parent._maxProcessingRate(),this._progress).then((()=>{n.hasset=!0,this._parent._mainSetInUse=null,this.next().then(r,s)}),(r=>{n.hasset=!0,this._parent._mainSetInUse=null,s(r)})):(n.hasset=!0,this._parent._mainSetInUse=null,r(null))}),(r=>{n.hasset=!0,this._parent._mainSetInUse=null,s(r)}))})),!1===n.hasset&&(this._parent._mainSetInUse=n.returnpromise,n.hasset=!0),n.returnpromise}async count(){if(-1!==this._parent._totalCount)return this._parent._totalCount;const n=await this._parent._getSet(this._progress),r=await this._refineAllSets(n);return this._parent._totalCount=r._known.length,this._parent._totalCount}async _refineAllSets(n){if(n._known.length>0&&"GETPAGES"===n._known[n._known.length-1])return await this._parent._expandPagedSet(n,this._parent._maxQueryRate(),0,1,this._progress),this._refineAllSets(n);if(n._candidates.length>0){if("GETPAGES"===n._known[n._candidates.length-1])return await this._parent._expandPagedSet(n,this._parent._maxQueryRate(),0,2,this._progress),this._refineAllSets(n);const r=await this._parent._refineSetBlock(n,this._parent._maxProcessingRate(),this._progress);return r._candidates.length>0?this._refineAllSets(r):r}return n}}class t{constructor(n,r,s,i){this._lastFetchedIndex=0,this._ordered=!1,this.pagesDefinition=null,this._candidates=n,this._known=r,this._ordered=s,this.pagesDefinition=i}}function p$1(n,r){return h$1(null==n?void 0:n.parseTree,r,null==n?void 0:n.parameters)}function f$2(n,r,s){return h$1(n,r,s)}function m$1(r,s,i,l){return n.create(h$1(r.parseTree,_.Standardised,r.parameters,s,i),l,r.timeZone)}function g$1(r,s,i="AND"){return n.create("(("+p$1(r,_.Standardised)+")"+i+"("+p$1(s,_.Standardised)+"))",r.fieldsIndex,r.timeZone)}function h$1(n,i,l,o=null,c=null){let G,B,H,Y;switch(n.type){case"interval":return F(h$1(n.value,i,l,o,c),n.qualifier,n.op);case"case-expression":{let r=" CASE ";"simple"===n.format&&(r+=h$1(n.operand,i,l,o,c));for(let s=0;s<n.clauses.length;s++)r+=" WHEN "+h$1(n.clauses[s].operand,i,l,o,c)+" THEN "+h$1(n.clauses[s].value,i,l,o,c);return null!==n.else&&(r+=" ELSE "+h$1(n.else,i,l,o,c)),r+=" END ",r}case"parameter":{const r=l[n.value.toLowerCase()];if("string"==typeof r)return"'"+l[n.value.toLowerCase()].toString().replaceAll("'","''")+"'";if($(r))return w$1(r,i);if(C(r))return w$1(r,i);if(P(r))return E(r,i);if(N(r))return T$1(r,i);if(U(r))return S$1(r,i);if(Array.isArray(r)){const n=[];for(let s=0;s<r.length;s++)"string"==typeof r[s]?n.push("'"+r[s].toString().replaceAll("'","''")+"'"):$(r[s])||C(r[s])?n.push(w$1(r[s],i)):P(r[s])?n.push(E(r[s],i)):N(r[s])?n.push(T$1(r[s],i)):U(r[s])?n.push(S$1(r[s],i)):n.push(r[s].toString());return n}return r.toString()}case"expression-list":B=[];for(const r of n.value)B.push(h$1(r,i,l,o,c));return B;case"unary-expression":return" ( NOT "+h$1(n.expr,i,l,o,c)+" ) ";case"binary-expression":switch(n.operator){case"AND":return" ("+h$1(n.left,i,l,o,c)+" AND "+h$1(n.right,i,l,o,c)+") ";case"OR":return" ("+h$1(n.left,i,l,o,c)+" OR "+h$1(n.right,i,l,o,c)+") ";case"IS":if("null"!==n.right.type)throw new r(s.UnsupportedIsRhs);return" ("+h$1(n.left,i,l,o,c)+" IS NULL )";case"ISNOT":if("null"!==n.right.type)throw new r(s.UnsupportedIsRhs);return" ("+h$1(n.left,i,l,o,c)+" IS NOT NULL )";case"IN":return G=[],"expression-list"===n.right.type?(G=h$1(n.right,i,l,o,c)," ("+h$1(n.left,i,l,o,c)+" IN ("+G.join(",")+")) "):(Y=h$1(n.right,i,l,o,c),Array.isArray(Y)?" ("+h$1(n.left,i,l,o,c)+" IN ("+Y.join(",")+")) ":" ("+h$1(n.left,i,l,o,c)+" IN ("+Y+")) ");case"NOT IN":return G=[],"expression-list"===n.right.type?(G=h$1(n.right,i,l,o,c)," ("+h$1(n.left,i,l,o,c)+" NOT IN ("+G.join(",")+")) "):(Y=h$1(n.right,i,l,o,c),Array.isArray(Y)?" ("+h$1(n.left,i,l,o,c)+" NOT IN ("+Y.join(",")+")) ":" ("+h$1(n.left,i,l,o,c)+" NOT IN ("+Y+")) ");case"BETWEEN":return H=h$1(n.right,i,l,o,c)," ("+h$1(n.left,i,l,o,c)+" BETWEEN "+H[0]+" AND "+H[1]+" ) ";case"NOTBETWEEN":return H=h$1(n.right,i,l,o,c)," ("+h$1(n.left,i,l,o,c)+" NOT BETWEEN "+H[0]+" AND "+H[1]+" ) ";case"LIKE":return""!==n.escape?" ("+h$1(n.left,i,l,o,c)+" LIKE "+h$1(n.right,i,l,o,c)+" ESCAPE '"+n.escape+"') ":" ("+h$1(n.left,i,l,o,c)+" LIKE "+h$1(n.right,i,l,o,c)+") ";case"NOT LIKE":return""!==n.escape?" ("+h$1(n.left,i,l,o,c)+" NOT LIKE "+h$1(n.right,i,l,o,c)+" ESCAPE '"+n.escape+"') ":" ("+h$1(n.left,i,l,o,c)+" NOT LIKE "+h$1(n.right,i,l,o,c)+") ";case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":return" ("+h$1(n.left,i,l,o,c)+" "+n.operator+" "+h$1(n.right,i,l,o,c)+") ";case"||":return" ("+h$1(n.left,i,l,o,c)+" "+(i===_.SqlServer?"+":n.operator)+" "+h$1(n.right,i,l,o,c)+") "}throw new r(s.UnsupportedOperator,{operator:n.operator});case"null":return"null";case"boolean":return!0===n.value?"1":"0";case"string":return"'"+n.value.toString().replaceAll("'","''")+"'";case"timestamp":return`timestamp '${n.value}'`;case"date":return`date '${n.value}'`;case"time":return`time '${n.value}'`;case"number":return n.value.toString();case"current-time":return A("date"===n.mode,i);case"column-reference":return o?o.toLowerCase()===n.column.toLowerCase()?"("+c+")":!0===n.delimited?`"${n.column.split('"').join('""')}"`:n.column:n.column;case"data-type":return n.value;case"function":{const r=h$1(n.args,i,l,o,c);return y$1(n.name,r,i)}}throw new r(s.UnsupportedSyntax,{node:n.type})}function y$1(n,i,l){switch(n.toLowerCase().trim()){case"cos":case"sin":case"tan":case"cosh":case"tanh":case"sinh":case"acos":case"asin":case"atan":case"floor":case"log10":case"log":case"abs":if(1!==i.length)throw new r(s.InvalidFunctionParameters,{function:n.toLowerCase().trim()});return`${n.toUpperCase().trim()}(${i[0]})`;case"ceiling":case"ceil":if(1!==i.length)throw new r(s.InvalidFunctionParameters,{function:"ceiling"});switch(l){case _.Standardised:case _.StandardisedNoInterval:}return"CEILING("+i[0]+")";case"mod":case"power":case"nullif":if(2!==i.length)throw new r(s.InvalidFunctionParameters,{function:n.toLowerCase().trim()});return`${n.toUpperCase().trim()}(${i[0]},${i[1]})`;case"round":if(2===i.length)return"ROUND("+i[0]+","+i[1]+")";if(1===i.length)return"ROUND("+i[0]+")";throw new r(s.InvalidFunctionParameters,{function:"round"});case"truncate":if(i.length<1||i.length>2)throw new r(s.InvalidFunctionParameters,{function:"truncate"});return l===_.SqlServer?"ROUND("+i[0]+(1===i.length?"0":","+i[1])+",1)":"TRUNCATE("+i[0]+(1===i.length?")":","+i[1]+")");case"char_length":case"len":if(1!==i.length)throw new r(s.InvalidFunctionParameters,{function:"char_length"});switch(l){case _.SqlServer:return"LEN("+i[0]+")";case _.Oracle:return"LENGTH("+i[0]+")";default:return"CHAR_LENGTH("+i[0]+")"}case"coalesce":case"concat":{if(i.length<1)throw new r(s.InvalidFunctionParameters,{function:n.toLowerCase()});let l=n.toUpperCase().trim()+"(";for(let n=0;n<i.length;n++)0!==n&&(l+=","),l+=i[n];return l+=")",l}case"lower":case"lcase":if(1!==i.length)throw new r(s.InvalidFunctionParameters,{function:"lower"});return"LOWER("+i[0]+")";case"upper":case"ucase":if(1!==i.length)throw new r(s.InvalidFunctionParameters,{function:"upper"});return"UPPER("+i[0]+")";case"substring":{let n="";switch(l){case _.Oracle:return n="SUBSTR("+i[0]+","+i[1],3===i.length&&(n+=","+i[2]),n+=")",n;case _.SqlServer:return n=3===i.length?"SUBSTRING("+i[0]+","+i[1]+","+i[2]+")":"SUBSTRING("+i[0]+",  "+i[1]+", LEN("+i[0]+") - "+i[1]+")",n;default:return n="SUBSTRING("+i[0]+" FROM "+i[1],3===i.length&&(n+=" FOR "+i[2]),n+=")",n}}case"extract":return"EXTRACT("+i[0].replaceAll("'","")+" FROM "+i[1]+")";case"cast":{let n="";switch(l){case _.Oracle:switch(i[1].type){case"date":n="DATE";break;case"float":n="DOUBLE";break;case"integer":n="INTEGER";break;case"real":n="REAL";break;case"smallint":n="SMALLINT";break;case"timestamp":n="TIMESTAMP";break;case"varchar":n="VARCHAR("+i[1].size.toString()+")"}return`CAST(${i[0]} AS ${n})`;case _.Postgres:switch(i[1].type){case"date":n="DATE";break;case"float":n="DOUBLE PRECISION";break;case"integer":n="INT";break;case"real":n="REAL";break;case"smallint":n="SMALLINT";break;case"timestamp":n="TIMESTAMP";break;case"varchar":n="VARCHAR("+i[1].size.toString()+")"}return`CAST(${i[0]} AS ${n})`;case _.SqlServer:switch(i[1].type){case"date":n="DATE";break;case"float":n="FLOAT";break;case"integer":n="INT";break;case"real":n="REAL";break;case"smallint":n="SMALLINT";break;case"timestamp":n="DATETIME";break;case"varchar":n="VARCHAR("+i[1].size.toString()+")"}return`CAST(${i[0]} AS ${n})`;default:switch(i[1].type){case"date":n="DATE";break;case"float":n="FLOAT";break;case"integer":n="INTEGER";break;case"real":n="REAL";break;case"smallint":n="SMALLINT";break;case"timestamp":n="TIMESTAMP";break;case"varchar":n="VARCHAR("+i[1].size.toString()+")"}return`CAST(${i[0]} AS ${n})`}}}throw new r(s.InvalidFunctionParameters,{function:n})}function T$1(n,r){const s=n.toDateTime(),i=0===s.hour&&0===s.minute&&0===s.second&&0===s.millisecond;switch(r){case _.FILEGDB:case _.Standardised:case _.StandardisedNoInterval:return i?`date '${s.toFormat("yyyy-LL-dd")}'`:`timestamp '${s.toFormat("yyyy-LL-dd HH:mm:ss")}'`;case _.Oracle:return i?`TO_DATE('${s.toFormat("yyyy-LL-dd")}','YYYY-MM-DD')`:`TO_DATE('${s.toFormat("yyyy-LL-dd HH:mm:ss")}','YYYY-MM-DD HH24:MI:SS')`;case _.SqlServer:return`'${s.toFormat(i?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;case _.PGDB:return`#${s.toFormat(i?"LL-dd-yyyy":"LL-dd-yyyy HH:mm:ss")}#`;case _.Postgres:return`TIMESTAMP '${s.toFormat(i?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;default:return`timestamp '${s.toFormat("yyyy-LL-dd HH:mm:ss")}'`}}function S$1(n,r){switch(r){case _.FILEGDB:case _.Standardised:case _.StandardisedNoInterval:return n.toSQLWithKeyword();case _.Oracle:return`TO_DATE('${n.toFormat("Y-MM-DD")}'`;case _.SqlServer:return`'${n.toFormat("Y-MM-DD")}'`;case _.PGDB:return`#${n.toFormat("Y-MM-DD")}#`;case _.Postgres:return`TIMESTAMP '${n.toFormat("Y-MM-DD")}'`;default:return n.toSQLWithKeyword()}}function E(n,r){switch(n instanceof z&&(n=n.toStorageString()),r){case _.Oracle:return`TO_DATE('${n}', 'HH24:MI:SS')`;case _.SqlServer:return`'${n}'`;case _.FILEGDB:case _.Standardised:case _.StandardisedNoInterval:case _.Postgres:default:return`time '${n}'`}}function w$1(n,r){return T$1(V.dateTimeToArcadeDate(C(n)?n:ee.fromJSDate(n)),r)}function A(n,r){switch(r){case _.FILEGDB:case _.Standardised:case _.StandardisedNoInterval:case _.Oracle:return n?"CURRENT_DATE":"CURRENT_TIMESTAMP";case _.SqlServer:return n?"CAST(GETDATE() AS DATE)":"GETDATE()";case _.PGDB:case _.Postgres:default:return n?"CURRENT_DATE":"CURRENT_TIMESTAMP"}}function L(n,r,s={}){const i={},l={},o={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeBigInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeTimeOnly:"time-only",esriFieldTypeDateOnly:"date-only",esriFieldTypeTimestampOffset:"timestamp-offset",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"guid",oid:"integer",long:"integer","small-integer":"integer",integer:"integer","big-integer":"integer",single:"double","time-only":"time-only","date-only":"date-only","timestamp-offset":"timestemp-offset",double:"double",date:"date",guid:"guid","global-id":"guid",string:"string"};for(const c of r){const n=c.type?o[c.type]:void 0;i[c.name.toLowerCase()]=void 0===n?"":n}for(const c in s){const n=o[s[c]];l[c.toLowerCase()]=void 0===n?"":n}switch(I(i,n.parseTree,n.parameters,l)){case"double":return"double";case"integer":return"integer";case"date":return"date";case"date-only":return"date-only";case"time-only":return"time-only";case"timestamp-offset":return"timestamp-offset";case"string":return"string";case"global-id":case"guid":return"guid"}return""}function I(n,i,l,o){var c,_,C,G,B;let H;switch(i.type){case"interval":return"integer";case"case-expression":{const r=[];if("simple"===i.format){for(let s=0;s<i.clauses.length;s++)r.push(I(n,i.clauses[s].value,l,o));null!==i.else&&r.push(I(n,i.else,l,o))}else{for(let s=0;s<i.clauses.length;s++)r.push(I(n,i.else,l,o));null!==i.else&&r.push(I(n,i.else,l,o))}return b(r)}case"parameter":{const n=o[i.value.toLowerCase()];if(void 0===n&&l){const n=l[i.value.toLowerCase()];if(void 0===n)return"";if(null===n)return"";if("string"==typeof n||n instanceof String)return"string";if("boolean"==typeof n)return"boolean";if($(n))return"date";if(N(n))return"date";if(U(n))return"date-only";if(P(n))return"time-only";if("number"==typeof n)return n%1==0?"integer":"double"}return void 0===n?"":n}case"expression-list":{const r=[];for(const s of i.value)r.push(I(n,s,l,o));return r}case"unary-expression":return"boolean";case"binary-expression":switch(i.operator){case"AND":case"OR":case"IN":case"NOT IN":case"BETWEEN":case"NOTBETWEEN":case"LIKE":case"NOT LIKE":case"<>":case"<":case">":case">=":case"<=":case"=":return"boolean";case"IS":case"ISNOT":if("null"!==i.right.type)throw new r(s.UnsupportedIsRhs);return"boolean";case"*":case"-":case"+":case"/":return b([I(n,i.left,l,o),I(n,i.right,l,o)]);case"||":return"string";default:throw new r(s.UnsupportedOperator,{operator:i.operator})}case"null":return"";case"boolean":return"boolean";case"string":return"string";case"number":return null===i.value?"":i.value%1==0?"integer":"double";case"date":return"date";case"timestamp":return i.withtimezone?"timestamp-offset":"date";case"time":return"time-only";case"current-time":return"date";case"column-reference":{const r=n[i.column.toLowerCase()];return void 0===r?"":r}case"function":switch(i.name.toLowerCase()){case"cast":switch((null==(_=null==(c=i.args)?void 0:c.value[1])?void 0:_.value.type)??""){case"integer":case"smallint":return"integer";case"real":case"float":return"double";case"date":case"timestamp":return!0===(null==(B=null==(G=null==(C=i.args)?void 0:C.value[1])?void 0:G.value)?void 0:B.withtimezone)?"timestamp-offset":"date";case"time":return"time-only";case"varchar":return"string";default:return""}case"position":case"extract":case"char_length":case"mod":return"integer";case"round":if(H=I(n,i.args,l,o),Array.isArray(H)){if(H.length<=0)return"double";H=H[0]}return H;case"sign":return"integer";case"ceiling":case"floor":case"abs":return H=I(n,i.args,l,o),Array.isArray(H)&&(H=b(H)),"integer"===H||"double"===H?H:"double";case"area":case"length":case"log":case"log10":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"cosh":case"sinh":case"tanh":case"power":return"double";case"substring":case"trim":case"concat":case"lower":case"upper":return"string";case"truncate":return"double";case"nullif":case"coalesce":return H=I(n,i.args,l,o),Array.isArray(H)?H.length>0?H[0]:"":H}return""}throw new r(s.UnsupportedSyntax,{node:i.type})}const ge={boolean:1,string:2,integer:3,double:4,date:5};function b(n){if(n){let r="";for(const s of n)""!==s&&(r=""===r||ge[r]<ge[s]?s:r);return r}return""}function v$2(n,r){return O$1(n.parseTree,r)}function D(n){return"column-reference"===(null==n?void 0:n.parseTree.type)}function O$1(n,r){if(null==n)return!1;switch(n.type){case"when-clause":return O$1(n.operand,r)||O$1(n.value,r);case"case-expression":for(const s of n.clauses)if(O$1(s,r))return!0;return!("simple"!==n.format||!O$1(n.operand,r))||!(null===n.else||!O$1(n.else,r));case"parameter":case"null":case"boolean":case"date":case"timestamp":case"time":case"string":case"number":return!1;case"expression-list":for(const s of n.value)if(O$1(s,r))return!0;return!1;case"unary-expression":return O$1(n.expr,r);case"binary-expression":return O$1(n.left,r)||O$1(n.right,r);case"column-reference":return r.toLowerCase()===n.column.toLowerCase();case"function":return O$1(n.args,r)}return!1}function R(n){let r="";return r+=n.period.toUpperCase(),r}function F(n,r,s){let i="";return i="interval-period"===r.type?R(r):R(r.start)+" TO "+R(r.end),"INTERVAL "+s+" "+n+" "+i}function f$1(n){let r=0;for(let s=0;s<n.length;s++)r+=n[s];return r/n.length}function h(n){const r=f$1(n);let s=0;for(let i=0;i<n.length;i++)s+=(r-n[i])**2;return s/n.length}function m(n){const r=f$1(n);let s=0;for(let i=0;i<n.length;i++)s+=(r-n[i])**2;return s/(n.length-1)}function g(n){let r=0;for(let s=0;s<n.length;s++)r+=n[s];return r}function w(n){switch(n.toLowerCase()){case"distinct":return"distinct";case"avg":case"mean":return"avg";case"min":return"min";case"sum":return"sum";case"max":return"max";case"stdev":case"stddev":return"stddev";case"var":case"variance":return"var";case"count":return"count"}return""}function d(n,r,s=1e3){switch(n.toLowerCase()){case"distinct":return function p(n,r){const s=[],i={},l=[];for(let o=0;o<n.length;o++){if(void 0!==n[o]&&null!==n[o]){const r=n[o];if(G(r)||B(r))void 0===i[r]&&(s.push(r),i[r]=1);else{let n=!1;for(let s=0;s<l.length;s++)!0===H(l[s],r)&&(n=!0);!1===n&&(l.push(r),s.push(r))}}if(s.length>=r&&-1!==r)return s}return s}(r,s);case"avg":case"mean":return f$1(r);case"min":return Math.min.apply(Math,r);case"sum":return g(r);case"max":return Math.max.apply(Math,r);case"stdev":case"stddev":return Math.sqrt(h(r));case"var":case"variance":return h(r);case"count":return r.length}return 0}async function M(n,r,s){let i="";r&&!D(r)&&(i=L(r,n.fields));const l=await O(n,r,s,!0);if(0===l.length)return null;const o=f$1(l);return null===o?o:"integer"===i?function u$1(n){return n=+n,isFinite(n)?n-n%1||(n<0?-0:0===n?n:0):n}(o):o}async function O(n,r,s,c=!1){const _=n.iterator(s),$=[],C={ticker:0};let P=await _.next();for(;null!==P;){if(C.ticker++,s.aborted)throw new i(l.Cancelled);C.ticker%100==0&&(C.ticker=0,await new Promise((n=>{setTimeout(n,0)})));const n=null==r?void 0:r.calculateValue(P);null===n?!1===c&&($[$.length]=n):$[$.length]=n instanceof X||n instanceof z?n.toNumber():n instanceof o?n.toMilliseconds():n,P=await _.next()}return $}class x{constructor(n){this.recentlyUsedQueries=null,this.featureSetQueryInterceptor=null,this._idstates=[],this._parent=null,this._wset=null,this._mainSetInUse=null,this._maxProcessing=200,this._maxQuery=500,this._totalCount=-1,this._databaseType=_.NotEvaluated,this._databaseTypeProbed=null,this.declaredRootClass="esri.arcade.featureset.support.FeatureSet",this._featureCache=[],this.typeIdField=null,this.types=null,this.subtypeField=null,this.subtypes=null,this.fields=null,this.geometryType="",this.objectIdField="",this.globalIdField="",this.spatialReference=null,this.hasM=!1,this.hasZ=!1,this._transparent=!1,this.loaded=!1,this._loadPromise=null,this._fieldsIndex=null,this.fsetInfo=null,(null==n?void 0:n.lrucache)&&(this.recentlyUsedQueries=n.lrucache),(null==n?void 0:n.interceptor)&&(this.featureSetQueryInterceptor=n.interceptor)}optimisePagingFeatureQueries(n){this._parent&&this._parent.optimisePagingFeatureQueries(n)}_hasMemorySource(){return!0}prop(n,r){return void 0===r?this[n]:(void 0!==this[n]&&(this[n]=r),this)}end(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent}_ensureLoaded(){return this.load()}load(){return null===this._loadPromise&&(this._loadPromise=this.loadImpl()),this._loadPromise}async loadImpl(){var n,r;return!0===(null==(n=this._parent)?void 0:n.loaded)?(this._initialiseFeatureSet(),this):(await(null==(r=this._parent)?void 0:r.load()),this._initialiseFeatureSet(),this)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types,this.subtypeField=this._parent.subtypeField,this.subtypes=this._parent.subtypes):(this.fields=[],this.typeIdField="",this.subtypeField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new te({wkid:4326}),this.geometryType=Y.point)}getField(n,r){let s;return(r=r||this.fields)&&(n=n.toLowerCase(),r.some((r=>(r&&r.name.toLowerCase()===n&&(s=r),!!s)))),s}getFieldsIndex(){return null===this._fieldsIndex&&(this._fieldsIndex=ne.fromLayer({timeInfo:this.timeInfo,editFieldsInfo:this.editFieldsInfo,dateFieldsTimeZone:this.dateFieldsTimeZone,datesInUnknownTimezone:this.datesInUnknownTimezone,fields:this.fields})),this._fieldsIndex}_maxProcessingRate(){return null!==this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())}_maxQueryRate(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery}_checkCancelled(n){if(null!=n&&n.aborted)throw new i(l.Cancelled)}nativeCapabilities(){return this._parent.nativeCapabilities()}async _canDoAggregates(n,r,s,i,l){return null!==this._parent&&this._parent._canDoAggregates(n,r,s,i,l)}async _getAggregatePagesDataSourceDefinition(n,r,s,o,c,_,$){if(null===this._parent)throw new i(l.NeverReach);return this._parent._getAggregatePagesDataSourceDefinition(n,r,s,o,c,_,$)}async _getAgregagtePhysicalPage(n,r,s){if(null===this._parent)throw new i(l.NeverReach);return this._parent._getAgregagtePhysicalPage(n,r,s)}async databaseType(){if(this._databaseType===_.NotEvaluated){if(null!==a.applicationCache){const n=a.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(null!==n)return n}if(null!==this._databaseTypeProbed)return this._databaseTypeProbed;try{this._databaseTypeProbed=this._getDatabaseTypeImpl(),null!==a.applicationCache&&a.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),this._databaseTypeProbed)}catch(n){throw null!==a.applicationCache&&a.applicationCache.clearDatabaseType(this._cacheableFeatureSetSourceKey()),n}return this._databaseTypeProbed}return this._databaseType}async _getDatabaseTypeImpl(){const n=[{thetype:_.SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) = CAST( '2015-01-01' as DATETIME)) AND OBJECTID<0"},{thetype:_.Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') = TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID<0"},{thetype:_.StandardisedNoInterval,testwhere:"(date '2015-01-01 10:10:10' = date '2015-01-01 10:10:10') AND OBJECTID<0"}];for(const r of n)if(!0===await this._runDatabaseProbe(r.testwhere))return r.thetype;return _.StandardisedNoInterval}_cacheableFeatureSetSourceKey(){return"MUSTBESET"}async _runDatabaseProbe(n){if(null!==this._parent)return this._parent._runDatabaseProbe(n);throw new i(l.NotImplemented)}isTable(){var n;return(null==(n=this._parent)?void 0:n.isTable())??!1}_featureFromCache(n){if(void 0!==this._featureCache[n])return this._featureCache[n]}_isInFeatureSet(n){return Z.Unknown}_getSet(n){throw new i(l.NotImplemented)}async _getFeature(n,r,s){if(this._checkCancelled(s),void 0!==this._featureFromCache(r))return this._featureFromCache(r);if(await this._getFeatures(n,r,this._maxProcessingRate(),s),this._checkCancelled(s),void 0!==this._featureFromCache(r))return this._featureFromCache(r);throw new i(l.MissingFeatures)}async _getFeatureBatch(n,r){this._checkCancelled(r);const s=new t([],n,!1,null),i=[];await this._getFeatures(s,-1,n.length,r),this._checkCancelled(r);for(const l of n)void 0!==this._featureFromCache(l)&&i.push(this._featureFromCache(l));return i}async _getFeatures(n,r,s,i){return"success"}_getFilteredSet(n,r,s,o,c){throw new i(l.NotImplemented)}async _refineSetBlock(n,r,s){if(!0===this._checkIfNeedToExpandCandidatePage(n,this._maxQueryRate()))return await this._expandPagedSet(n,this._maxQueryRate(),0,0,s),this._refineSetBlock(n,r,s);this._checkCancelled(s);const i=n._candidates.length;this._refineKnowns(n,r);let l=i-n._candidates.length;if(0===n._candidates.length)return n;if(l>=r)return n;if(await this._refineIfParentKnown(n,r-l,s),this._checkCancelled(s),this._refineKnowns(n,r-l),l=i-n._candidates.length,l<r&&n._candidates.length>0){const i=r-l,o=this._prepareFetchAndRefineSet(n._candidates);return await this._fetchAndRefineFeatures(o,o.length>i?i:n._candidates.length,s),this._checkCancelled(s),this._refineKnowns(n,r-l),n}return n}_fetchAndRefineFeatures(n,r,s){return null}_prepareFetchAndRefineSet(n){const r=[];for(let s=0;s<n.length;s++)this._isPhysicalFeature(n[s])&&r.push(n[s]);return r}_isPhysicalFeature(n){return null===this._parent||this._parent._isPhysicalFeature(n)}_refineKnowns(n,r){let s=0,i=null;const l=[];r=this._maxQueryRate();for(let o=0;o<n._candidates.length&&"GETPAGES"!==n._candidates[o];o++){let c=!1;const _=this._candidateIdTransform(n._candidates[o]);_!==n._candidates[o]&&(c=!0);const $=this._isInFeatureSet(_);if($===Z.InFeatureSet)!0===c?n._known.includes(_)||(n._known.push(_),s+=1):(n._known.push(n._candidates[o]),s+=1),null===i?i={start:o,end:o}:i.end===o-1?i.end=o:(l.push(i),i={start:o,end:o});else if($===Z.NotInFeatureSet)null===i?i={start:o,end:o}:i.end===o-1?i.end=o:(l.push(i),i={start:o,end:o}),s+=1;else if($===Z.Unknown&&(s+=1,!0===n._ordered))break;if(s>=r)break}null!==i&&l.push(i);for(let o=l.length-1;o>=0;o--)n._candidates.splice(l[o].start,l[o].end-l[o].start+1)}_refineIfParentKnown(n,r,s){const i=new t([],[],n._ordered,null);return i._candidates=n._candidates.slice(0),this._parent._refineSetBlock(i,r,s)}_candidateIdTransform(n){return this._parent._candidateIdTransform(n)}_checkIfNeedToExpandKnownPage(n,r){if(null===n.pagesDefinition)return!1;let s=0;for(let i=n._lastFetchedIndex;i<n._known.length;i++){if("GETPAGES"===n._known[i])return!0;if(void 0===this._featureCache[n._known[i]]&&(s+=1,s>=r))break}return!1}_checkIfNeedToExpandCandidatePage(n,r){if(null===n.pagesDefinition)return!1;let s=0;for(let i=0;i<n._candidates.length;i++){if("GETPAGES"===n._candidates[i])return!0;if(s+=1,s>=r)break}return!1}async _expandPagedSet(n,r,s,o,c){if(null===this._parent)throw new i(l.NotImplemented);return this._parent._expandPagedSet(n,r,s,o,c)}async _expandPagedSetFeatureSet(n,r,s,i,l){if(n._known.length>0&&"GETPAGES"===n._known[n._known.length-1]&&(i=1),0===i&&n._candidates.length>0&&"GETPAGES"===n._candidates[n._candidates.length-1]&&(i=2),0===i)return"finished";const o=await this._getPage(n,i,l);return s+o<r?this._expandPagedSet(n,r,s+o,0,l):"success"}async _getPage(n,r,s){const i=1===r?n._known:n._candidates;if(n.pagesDefinition.internal.set.length>n.pagesDefinition.resultOffset||!0===n.pagesDefinition.internal.fullyResolved){i.length=i.length-1;let r=0;for(let l=0;l<n.pagesDefinition.resultRecordCount&&!(n.pagesDefinition.resultOffset+l>=n.pagesDefinition.internal.set.length);l++)i[i.length]=n.pagesDefinition.internal.set[n.pagesDefinition.resultOffset+l],r++;n.pagesDefinition.resultOffset+=r;let s=!1;return!0===n.pagesDefinition.internal.fullyResolved&&n.pagesDefinition.internal.set.length<=n.pagesDefinition.resultOffset&&(s=!0),!1===s&&i.push("GETPAGES"),r}return await this._getPhysicalPage(n,r,s),this._getPage(n,r,s)}_getPhysicalPage(n,r,s){return null}_clonePageDefinition(n){return null===this._parent?null:this._parent._clonePageDefinition(n)}_first(n){return this.iterator(n).next()}first(n){return this._first(n)}async calculateStatistic(n,r,s,i){await this._ensureLoaded();let l=await this._stat(n,r,"",null,null,s,i);return!1===l.calculated&&(l=await this._manualStat(n,r,s,i)),l.result}async _manualStat(n,r,s,c){let _=null;switch(n.toLowerCase()){case"count":return _=await async function q(n,r){return n.iterator(r).count()}(this,c),{calculated:!0,result:_};case"distinct":return _=await async function S(n,r,s=1e3,c=null){const _=n.iterator(c),$=[],C={},P={ticker:0};let N=await _.next();for(;null!==N;){if(P.ticker++,null==c?void 0:c.aborted)throw new i(l.Cancelled);P.ticker%100==0&&(P.ticker=0,await new Promise((n=>{setTimeout(n,0)})));const n=null==r?void 0:r.calculateValue(N);let U=n;if(n instanceof X?U="!!DATEONLY!!-"+n.toString():n instanceof o?U="!!TSOFFSETONLY!!-"+n.toString():n instanceof z?U="!!TIMEONLY!!-"+n.toString():n instanceof Date&&(U="!!DATE!!-"+n.toString()),null!=n&&void 0===C[U]&&($.push(n),C[U]=1),$.length>=s&&-1!==s)return $;N=await _.next()}return $}(this,r,s,c),{calculated:!0,result:_};case"avg":case"mean":return _=await M(this,r,c),{calculated:!0,result:_};case"stdev":return _=await async function T(n,r,s){const i=await O(n,r,s,!0);return 0===i.length?null:Math.sqrt(m(i))}(this,r,c),{calculated:!0,result:_};case"variance":return _=await async function x$1(n,r,s){const i=await O(n,r,s,!0);return 0===i.length?null:m(i)}(this,r,c),{calculated:!0,result:_};case"sum":return _=await async function k(n,r,s){const i=await O(n,r,s,!0);return 0===i.length?null:g(i)}(this,r,c),{calculated:!0,result:_};case"min":return _=await async function v$1(n,r,s){const i=await O(n,r,s,!0);return 0===i.length?null:Math.min.apply(Math,i)}(this,r,c),{calculated:!0,result:_};case"max":return _=await async function y(n,r,s){const i=await O(n,r,s,!0);return 0===i.length?null:Math.max.apply(Math,i)}(this,r,c),{calculated:!0,result:_};default:return{calculated:!0,result:0}}}async _stat(n,r,s,i,l,o,c){const _=await this._parent._stat(n,r,s,i,l,o,c);return!1===_.calculated?null===l&&""===s&&null===i?this._manualStat(n,r,o,c):{calculated:!1}:_}_unionAllGeomSelf(n){const r=this.iterator(this._defaultTracker(n)),s=[];return new Promise(((n,i)=>{this._unionShapeInBatches(s,r,n,i)}))}_unionAllGeom(n){return new Promise(((r,s)=>{const i=this.iterator(this._defaultTracker(n));this._unionShapeInBatches([],i,r,s)}))}_unionShapeInBatches(n,r,s,i){r.next().then((l=>{try{null!==l&&null!==l.geometry&&n.push(l.geometry),n.length>30||null===l&&n.length>1?re(n).then((o=>{try{null===l?s(o):(n=[o],this._unionShapeInBatches(n,r,s,i))}catch(c){i(c)}}),i):null===l?1===n.length?s(n[0]):s(null):this._unionShapeInBatches(n,r,s,i)}catch(o){i(o)}}),i)}iterator(n){return new e(this,n)}intersection(n,r=!1){return x._featuresetFunctions.intersection.bind(this)(n,r)}difference(n,r=!1,s=!0){return x._featuresetFunctions.difference.bind(this)(n,r,s)}symmetricDifference(n,r=!1,s=!0){return x._featuresetFunctions.symmetricDifference.bind(this)(n,r,s)}morphShape(n,r,s="unknown",i=null){return x._featuresetFunctions.morphShape.bind(this)(n,r,s,i)}morphShapeAndAttributes(n,r,s="unknown"){return x._featuresetFunctions.morphShapeAndAttributes.bind(this)(n,r,s)}union(n,r=!1){return x._featuresetFunctions.union.bind(this)(n,r)}intersects(n){return x._featuresetFunctions.intersects.bind(this)(n)}envelopeIntersects(n){return x._featuresetFunctions.envelopeIntersects.bind(this)(n)}contains(n){return x._featuresetFunctions.contains.bind(this)(n)}overlaps(n){return x._featuresetFunctions.overlaps.bind(this)(n)}relate(n,r){return x._featuresetFunctions.relate.bind(this)(n,r)}within(n){return x._featuresetFunctions.within.bind(this)(n)}touches(n){return x._featuresetFunctions.touches.bind(this)(n)}top(n){return x._featuresetFunctions.top.bind(this)(n)}crosses(n){return x._featuresetFunctions.crosses.bind(this)(n)}buffer(n,r,s,i=!0){return x._featuresetFunctions.buffer.bind(this)(n,r,s,i)}filter(n,r=null){return x._featuresetFunctions.filter.bind(this)(n,r)}orderBy(n){return x._featuresetFunctions.orderBy.bind(this)(n)}dissolve(n,r){return x._featuresetFunctions.dissolve.bind(this)(n,r)}groupby(n,r){return x._featuresetFunctions.groupby.bind(this)(n,r)}reduce(n,r=null,s){return new Promise(((i,l)=>{this._reduceImpl(this.iterator(this._defaultTracker(s)),n,r,0,i,l,0)}))}_reduceImpl(n,r,s,i,l,o,c){try{if(++c>1e3)return void setTimeout((()=>{c=0,this._reduceImpl(n,r,s,i,l,o,c)}));n.next().then((_=>{try{if(null===_)l(s);else{const $=r(s,_,i,this);ae($)?$.then((s=>{this._reduceImpl(n,r,s,i+1,l,o,c)}),o):this._reduceImpl(n,r,$,i+1,l,o,c)}}catch($){o($)}}),o)}catch(_){o(_)}}removeField(n){return x._featuresetFunctions.removeField.bind(this)(n)}addField(n,r,s=null){return x._featuresetFunctions.addField.bind(this)(n,r,s)}sumArea(n,r=!1,s){const i=Q(n);return this.reduce(((n,s)=>null===s.geometry?0:r?se(s.geometry,i).then((r=>n+r)):ie(s.geometry,i).then((r=>n+r))),0,s)}sumLength(n,r=!1,s){const i=K(n);return this.reduce(((n,s)=>null===s.geometry?0:r?le(s.geometry,i).then((r=>n+r)):oe(s.geometry,i).then((r=>n+r))),0,s)}async distinct(r,s=1e3,i=null,l){await this.load();const o=n.create(r,this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC);return v(o,i),this.calculateStatistic("distinct",o,s,this._defaultTracker(l))}async min(r,s=null,i){await this.load();const l=n.create(r,this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC);return v(l,s),this.calculateStatistic("min",l,-1,this._defaultTracker(i))}async max(r,s=null,i){await this.load();const l=n.create(r,this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC);return v(l,s),this.calculateStatistic("max",l,-1,this._defaultTracker(i))}async avg(r,s=null,i){await this.load();const l=n.create(r,this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC);return v(l,s),this.calculateStatistic("avg",l,-1,this._defaultTracker(i))}async sum(r,s=null,i){await this.load();const l=n.create(r,this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC);return v(l,s),this.calculateStatistic("sum",l,-1,this._defaultTracker(i))}async stdev(r,s=null,i){await this.load();const l=n.create(r,this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC);return v(l,s),this.calculateStatistic("stdev",l,-1,this._defaultTracker(i))}async variance(r,s=null,i){await this.load();const l=n.create(r,this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC);return v(l,s),this.calculateStatistic("variance",l,-1,this._defaultTracker(i))}async count(r){return await this.load(),this.calculateStatistic("count",n.create("1",this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC),-1,this._defaultTracker(r))}_defaultTracker(n){return n??{aborted:!1}}forEach(n,r){return new Promise(((s,i)=>{this._forEachImpl(this.iterator(this._defaultTracker(r)),n,this,s,i,0)}))}_forEachImpl(n,r,s,i,l,o){try{if(++o>1e3)return void setTimeout((()=>{o=0,this._forEachImpl(n,r,s,i,l,o)}),0);n.next().then((c=>{try{if(null===c)i(s);else{const _=r(c);null==_?this._forEachImpl(n,r,s,i,l,o):ae(_)?_.then((()=>{try{this._forEachImpl(n,r,s,i,l,o)}catch(c){l(c)}}),l):this._forEachImpl(n,r,s,i,l,o)}}catch(_){l(_)}}),l)}catch(c){l(c)}}convertToJSON(n){const r={layerDefinition:{geometryType:this.geometryType,fields:[]},featureSet:{features:[],geometryType:this.geometryType}};for(let s=0;s<this.fields.length;s++)r.layerDefinition.fields.push(j(this.fields[s]));return this.reduce(((n,s)=>{var i;const l={geometry:null==(i=s.geometry)?void 0:i.toJSON(),attributes:{}};for(const r in s.attributes)l.attributes[r]=s.attributes[r];return r.featureSet.features.push(l),1}),0,n).then((()=>r))}castToText(n=!1){return"object, FeatureSet"}queryAttachments(n,r,s,i,l){return this._parent.queryAttachments(n,r,s,i,l)}serviceUrl(){return this._parent.serviceUrl()}subtypeMetaData(){return this.subtypeField&&this.subtypes?{subtypeField:this.subtypeField,subtypes:this.subtypes?this.subtypes.map((n=>({name:n.name,code:n.code}))):[]}:this.typeIdField?{subtypeField:this.typeIdField,subtypes:this.types?this.types.map((n=>({name:n.name,code:n.id}))):[]}:null}relationshipMetaData(){return this._parent.relationshipMetaData()}get gdbVersion(){return this._parent?this._parent.gdbVersion:""}schema(){const n=[];for(const r of this.fields)n.push(j(r));return{objectIdField:this.objectIdField,globalIdField:this.globalIdField,geometryType:void 0===J[this.geometryType]?"esriGeometryNull":J[this.geometryType],fields:n}}async convertToText(n,r){if("schema"===n)return await this._ensureLoaded(),JSON.stringify(this.schema());if("featureset"===n){await this._ensureLoaded();const n=[];await this.reduce(((r,s)=>{const i={geometry:s.geometry?s.geometry.toJSON():null,attributes:s.attributes};return null!==i.geometry&&i.geometry.spatialReference&&delete i.geometry.spatialReference,n.push(i),1}),0,r);const s=this.schema();return s.features=n,s.spatialReference=this.spatialReference.toJSON(),JSON.stringify(s)}return this.castToText()}getFeatureByObjectId(n,r){return this._parent.getFeatureByObjectId(n,r)}getOwningSystemUrl(){return this._parent.getOwningSystemUrl()}getIdentityUser(){return this._parent.getIdentityUser()}getRootFeatureSet(){return null!==this._parent?this._parent.getRootFeatureSet():this}getDataSourceFeatureSet(){return null!==this._parent?this._parent.getDataSourceFeatureSet():this}castAsJson(n=null){return"keeptype"===(null==n?void 0:n.featureset)?this:"none"===(null==n?void 0:n.featureset)?null:{type:"FeatureSet"}}async castAsJsonAsync(n=null,r=null){var s;if("keeptype"===(null==r?void 0:r.featureset))return this;if("schema"===(null==r?void 0:r.featureset))return await this._ensureLoaded(),JSON.parse(JSON.stringify(this.schema()));if("none"===(null==r?void 0:r.featureset))return null;await this._ensureLoaded();const i=[];await this.reduce(((n,s)=>{const l={geometry:s.geometry?!0===(null==r?void 0:r.keepGeometryType)?s.geometry:s.geometry.toJSON():null,attributes:s.attributes};return null!==l.geometry&&l.geometry.spatialReference&&!0!==(null==r?void 0:r.keepGeometryType)&&delete l.geometry.spatialReference,i.push(l),1}),0,n);const l=this.schema();return l.features=i,l.spatialReference=!0===(null==r?void 0:r.keepGeometryType)?this.spatialReference:null==(s=this.spatialReference)?void 0:s.toJSON(),l}fieldTimeZone(n){return this.getFieldsIndex().getTimeZone(n)}get preferredTimeZone(){var n;return(null==(n=this._parent)?void 0:n.preferredTimeZone)??null}get dateFieldsTimeZone(){var n;return(null==(n=this._parent)?void 0:n.dateFieldsTimeZone)??null}get dateFieldsTimeZoneDefaultUTC(){if(this.datesInUnknownTimezone)return"unknown";const n=this.dateFieldsTimeZone??"UTC";return""===n?"UTC":n}get datesInUnknownTimezone(){return this._parent.datesInUnknownTimezone}get editFieldsInfo(){var n;return(null==(n=this._parent)?void 0:n.editFieldsInfo)??null}get timeInfo(){var n;return(null==(n=this._parent)?void 0:n.timeInfo)??null}set featureSetInfo(n){this.fsetInfo=n}async getFeatureSetInfo(){var n;return this.fsetInfo??await(null==(n=this._parent)?void 0:n.getFeatureSetInfo())??null}}function v(n,r){if(null!==r){const s={};for(const n in r)s[n.toLowerCase()]=r[n];n.parameters=s}}x._featuresetFunctions={};class u extends x{constructor(n){super(n),this.declaredClass="esri.layers.featureset.sources.Empty",this._maxProcessing=1e3,this._wset=new t([],[],!1,null),this._parent=n.parentfeatureset,this._databaseType=_.Standardised}async _getSet(){return this._wset}optimisePagingFeatureQueries(){}_isInFeatureSet(){return Z.NotInFeatureSet}async _getFeature(){throw new i(l.NeverReach)}async queryAttachments(){return[]}async _getFeatures(){return"success"}_featureFromCache(){return null}async _fetchAndRefineFeatures(){throw new i(l.NeverReach)}async _getFilteredSet(){return new t([],[],!1,null)}_stat(n,r,s,i,l,o,c){return this._manualStat(n,r,o,c)}async _canDoAggregates(){return!1}}class f extends x{constructor(n){super(n),this._relation="",this._relationGeom=null,this._relationString="",this.declaredClass="esri.arcade.featureset.actions.SpatialFilter",this._relationString=n.relationString,this._parent=n.parentfeatureset,this._maxProcessing=40,this._relation=n.relation,this._relationGeom=n.relationGeom}async _getSet(n){if(null===this._wset){await this._ensureLoaded();const r=await this._parent._getFilteredSet("esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,null,null,n);return this._checkCancelled(n),this._wset=new t(r._candidates.slice(0),r._known.slice(0),r._ordered,this._clonePageDefinition(r.pagesDefinition)),this._wset}return this._wset}_isInFeatureSet(n){let r=this._parent._isInFeatureSet(n);return r===Z.NotInFeatureSet?r:(r=this._idstates[n],void 0===r?Z.Unknown:r)}_getFeature(n,r,s){return this._parent._getFeature(n,r,s)}_getFeatures(n,r,s,i){return this._parent._getFeatures(n,r,s,i)}_featureFromCache(n){return this._parent._featureFromCache(n)}async executeSpatialRelationTest(n){if(null===n.geometry)return!1;switch(this._relation){case"esriSpatialRelEnvelopeIntersects":return _e(W(this._relationGeom),W(n.geometry));case"esriSpatialRelIntersects":return _e(this._relationGeom,n.geometry);case"esriSpatialRelContains":return fe(this._relationGeom,n.geometry);case"esriSpatialRelOverlaps":return pe(this._relationGeom,n.geometry);case"esriSpatialRelWithin":return de(this._relationGeom,n.geometry);case"esriSpatialRelTouches":return he(this._relationGeom,n.geometry);case"esriSpatialRelCrosses":return ce(this._relationGeom,n.geometry);case"esriSpatialRelRelation":return ue(this._relationGeom,n.geometry,this._relationString??"")}}async _fetchAndRefineFeatures(n,r,s){var i;const l=new t([],n,!1,null),o=Math.min(r,n.length);await(null==(i=this._parent)?void 0:i._getFeatures(l,-1,o,s)),this._checkCancelled(s);const c=[];for(let _=0;_<o;_++){const r=this._parent._featureFromCache(n[_]);c.push(await this.executeSpatialRelationTest(r))}for(let _=0;_<r;_++)!0===c[_]?this._idstates[n[_]]=Z.InFeatureSet:this._idstates[n[_]]=Z.NotInFeatureSet;return"success"}async _getFilteredSet(n,r,s,i,l){await this._ensureLoaded();const o=await this._parent._getFilteredSet("esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,s,i,l);let c;return this._checkCancelled(l),c=null!==r?new t(o._candidates.slice(0).concat(o._known.slice(0)),[],o._ordered,this._clonePageDefinition(o.pagesDefinition)):new t(o._candidates.slice(0),o._known.slice(0),o._ordered,this._clonePageDefinition(o.pagesDefinition)),c}async _stat(n,r,s,i,l,o,c){if(""!==s)return{calculated:!1};const _=await this._parent._stat(n,r,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,l,o,c);return!1===_.calculated?null===l&&""===s&&null===i?this._manualStat(n,r,o,c):{calculated:!1}:_}async _canDoAggregates(n,r,s,i,l){return""===s&&null===i&&null!==this._parent&&this._parent._canDoAggregates(n,r,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,l)}async _getAggregatePagesDataSourceDefinition(n,r,s,o,c,_,$){if(null===this._parent)throw new i(l.NeverReach);return this._parent._getAggregatePagesDataSourceDefinition(n,r,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,c,_,$)}static registerAction(){x._featuresetFunctions.intersects=function(n){return null==n?new u({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelIntersects",relationGeom:n})},x._featuresetFunctions.envelopeIntersects=function(n){return null==n?new u({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelEnvelopeIntersects",relationGeom:n})},x._featuresetFunctions.contains=function(n){return null==n?new u({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelContains",relationGeom:n})},x._featuresetFunctions.overlaps=function(n){return null==n?new u({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelOverlaps",relationGeom:n})},x._featuresetFunctions.within=function(n){return null==n?new u({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelWithin",relationGeom:n})},x._featuresetFunctions.touches=function(n){return null==n?new u({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelTouches",relationGeom:n})},x._featuresetFunctions.crosses=function(n){return null==n?new u({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelCrosses",relationGeom:n})},x._featuresetFunctions.relate=function(n,r){return null==n?new u({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelRelation",relationGeom:n,relationString:r})}}getFieldsIndex(){return this._parent.getFieldsIndex()}}export{A,D,E,F,L,S$1 as S,T$1 as T,f$2 as a,w as b,a as c,d,f,g$1 as g,m$1 as m,p$1 as p,t,u,v$2 as v,w$1 as w,x,y$1 as y};
