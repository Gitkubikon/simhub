const __vite__fileDeps=["assets/vxlLayer-_-nEnWHU.js","assets/index-DSIPxOWi.js","assets/index-B_7YxLDX.css"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{_ as t,fS as s,e as r,y as a,a as n,ky as l,kz as o,dG as h,n as d,g as u,P as c,kA as m,kB as g,kC as f,bZ as y,W as x,kD as p,kE as v,kF as b,kG as T,kH as w,kI as R,kJ as S,kK as L,m as V,e6 as C,dk as E,kL as F,v as k,Q as I,kM as P}from"./index-DSIPxOWi.js";var U,B,A,M,W,O,q,D;function i(t){return s(`esri/libs/vxl/${t}`)}(q=U||(U={}))[q.Binary=0]="Binary",q[q.JSON=1]="JSON",function(t){t[t.TreeIndex=0]="TreeIndex",t[t.TreeStats=1]="TreeStats",t[t.TreeData=2]="TreeData",t[t.BrickBundles=3]="BrickBundles",t[t.Section=4]="Section",t[t.VariableStats=5]="VariableStats"}(B||(B={})),function(t){t[t.None=1]="None",t[t.Front=2]="Front",t[t.Back=3]="Back"}(A||(A={})),function(t){t[t.Low=0]="Low",t[t.Medium=1]="Medium",t[t.High=2]="High"}(M||(M={})),function(t){t[t.None=0]="None",t[t.StaticSections=1]="StaticSections",t[t.Slices=2]="Slices",t[t.DynamicSections=4]="DynamicSections",t[t.GhostShell=8]="GhostShell",t[t.Isosurface=16]="Isosurface",t[t.Quality=32]="Quality",t[t.SunLocation=64]="SunLocation",t[t.StaticSectionSelection=128]="StaticSectionSelection",t[t.ExaggerationAndOffset=256]="ExaggerationAndOffset",t[t.CurrentTime=512]="CurrentTime",t[t.CurrentVariable=1024]="CurrentVariable",t[t.DeleteIsosurface=2048]="DeleteIsosurface",t[t.ContainerVisibility=4096]="ContainerVisibility",t[t.RenderMode=8192]="RenderMode",t[t.Optimization=16384]="Optimization",t[t.VariableStyles=32768]="VariableStyles",t[t.VolumeStyles=65536]="VolumeStyles",t[t.AnalysisSlice=131072]="AnalysisSlice"}(W||(W={})),function(t){t[t.Isosurfaces=0]="Isosurfaces",t[t.DynamicSections=1]="DynamicSections",t[t.StaticSections=2]="StaticSections"}(O||(O={})),function(t){t[t.Lifetime=1]="Lifetime",t[t.RequestResponse=2]="RequestResponse",t[t.Rendering=3]="Rendering",t[t.Error=4]="Error"}(D||(D={}));let N=class extends l{constructor(t){super(t),this._halfIntTexturesAvailable=!1,this._textureFloatLinearAvailable=!1,this._havePreparedWithAllLayers=!1,this._renderPluginContext=null,this._vxlPromise=null,this._vxl=null,this._pluginIsActive=!1,this._moreToLoad=!1,this._viewportWidth=-1,this._viewportHeight=-1,this._newLayers=[],this._layers=new Map,this._rctx=null,this._renderTargetToRestore=null,this._lastFrameWasStationary=!1,this._wasmMemBlockSizes=[512,1024,2048,4096,8192,16384,32768,65536],this._wasmMemBlocks=new Map,this._dbgFlags=new Set,this._captureFrustum=!1,this._frustum=null,this._frustumRenderableId=-1,this._renderCoordsHelper=null,this.produces=new Map([[o.VOXEL,()=>!!this._vxl&&"local"===this.view.viewingMode]]),this.type=h.VOXEL,this.slicePlaneEnabled=!0,this.isGround=!1,this.layerUid=[]}_dbg(t,s){this._dbgFlags.has(t)&&(t===D.Error?d.getLogger(this).error(s):d.getLogger(this).warn(s))}_removeRenderPlugin(){this._pluginIsActive&&this.view._stage&&(this._dbg(D.Lifetime,"--removeRenderPlugin--"),this.view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1}initialize(){this._dbg(D.Lifetime,"--initialize--");for(const t of this._wasmMemBlockSizes)this._wasmMemBlocks.set(t,0);this.addHandles([u((()=>this.view.ready),(t=>{t&&"local"===this.view.viewingMode?(this._dbg(D.Lifetime,"view ready status changed to ready on a local view, calling addRenderPlugin"),this.view._stage.addRenderPlugin(this),this._pluginIsActive=!0):(this._dbg(D.Lifetime,"view ready status changed, not ready or not a local view!"),this._removeRenderPlugin())}),c),u((()=>{var t;return null==(t=this.view)?void 0:t.qualityProfile}),(t=>{this._dbg(D.Rendering,"qualityProfile changed to "+t),this._vxl&&this._vxl.set_quality(this._toWasmQuality(t))}),c),u((()=>{var t;return null==(t=this.view)?void 0:t.timeExtent}),(()=>{var t;if(this._vxl){const s=this._getTimeArgs(null==(t=this.view)?void 0:t.timeExtent);this._dbg(D.Rendering,"sceneView timeExtent changed to useTime="+s.hasTime+" st="+s.startTime+" et="+s.endTime),this._vxl.set_scene_time_extent(s.startTime,s.endTime,s.hasTime),this._renderPluginContext.requestRender()}}),c),u((()=>{var t;return null==(t=this.view)?void 0:t.stationary}),(t=>{this._vxl&&t&&!this._lastFrameWasStationary&&this._renderPluginContext.requestRender()}))])}initializeRenderContext(t){this._dbg(D.Lifetime,"--initializeRenderContext--");const s=t.renderContext.rctx;this._renderPluginContext=t,this._rctx=t.renderContext.rctx,this._halfIntTexturesAvailable=!!this._rctx.capabilities.textureNorm16,this._textureFloatLinearAvailable=this._rctx.capabilities.textureFloatLinear,this._initializeWasm(s.gl)}uninitializeRenderContext(){this._renderPluginContext=null,this._rctx=null,this._dbg(D.Lifetime,"--uninitializeRenderContext--")}_restoreFramebuffer(){if(!this._renderTargetToRestore)return;const t=this._renderTargetToRestore.fbo;if(!this._rctx)return void this._dbg(D.Error,"no context in restoreFramebuffer!");this._rctx.bindFramebuffer(t,!0);const s=this._renderTargetToRestore.viewport;this._rctx.setViewport(s.x,s.y,s.width,s.height)}_bindPreviousDepthToSlot(t,s){const r=!!this._rctx,a=!!this._renderTargetToRestore;if(!r||!a)return 0;const n=this._renderTargetToRestore.fbo.depthStencilTexture;return n?(0===s?this._rctx.bindTexture(null,t,!0):this._rctx.bindTexture(n,t,!0),1):(this._dbg(D.Error,"no depth/stencil texture exists!"),0)}_modifyResourceCount(t,s,r){if(!this._rctx)return void this._dbg(D.Error,"modifyAllocation callback has no rendering context!");const a=t;1===r?this._rctx.instanceCounter.increment(a,s):this._rctx.instanceCounter.decrement(a,s)}_setBlendState(t,s,r,a){this._rctx?(this._rctx.setBlendingEnabled(1===t),this._rctx.setBlendFunction(s,r),this._rctx.setBlendEquation(a)):this._dbg(D.Error,"setBlendState callback has no rendering context!")}_setFrontFace(t){this._rctx?this._rctx.setFrontFace(t):this._dbg(D.Error,"setFrontFace callback has no rendering context!")}_setDepthStencilStateFunction(t,s,r){this._rctx?(this._rctx.setDepthFunction(r),this._rctx.setDepthTestEnabled(1===t),this._rctx.setDepthWriteEnabled(1===s),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(m.ALWAYS,0,255),this._rctx.setStencilOpSeparate(g.FRONT,f.KEEP,f.INCR,f.KEEP),this._rctx.setStencilOpSeparate(g.BACK,f.KEEP,f.DECR,f.KEEP)):this._dbg(D.Error,"setDepthStencilStateFunction callback has no rendering context!")}_setRasterizerState(t){if(this._rctx)switch(t){case A.None:this._rctx.setFaceCullingEnabled(!1);break;case A.Back:this._rctx.setCullFace(g.BACK),this._rctx.setFaceCullingEnabled(!0);break;case A.Front:this._rctx.setCullFace(g.FRONT),this._rctx.setFaceCullingEnabled(!0)}else this._dbg(D.Error,"setRasterizerState callback has no rendering context!")}_setViewport(t,s,r,a){this._rctx?this._rctx.setViewport(t,s,r,a):this._dbg(D.Error,"setViewport callback has no rendering context!")}_updateMemoryUsage(){this._layers.forEach(((t,s)=>{if(t.needMemoryUsageUpdate){const r=this._vxl.estimate_memory_usage(s);r>=0&&(t.needMemoryUsageUpdate=!1,t.layerView.setUsedMemory(r))}}))}_syncRequestsResponses(){this._layers.forEach(((t,s)=>{const r=[];t.responses.forEach(((a,n)=>{r.push(n),this._dbg(D.RequestResponse,"responding for requestID:"+n+" size:"+a.size),this._vxl.respond(s,n,a),a.requestType!==B.TreeIndex&&a.requestType!==B.Section||(t.needMemoryUsageUpdate=!0)}));const a=t.responses;for(const o of r)a.delete(o);const n=this._vxl.get_new_requests(s),l=t.abortController.signal;for(const o in n){t.outstandingRequestCount+=1,1===t.outstandingRequestCount&&t.layerView.updatingFlagChanged();const s=n[o],r={responseType:"array-buffer",signal:l,query:{...t.layerView.layer.customParameters,token:t.layerView.layer.apiKey}};this._dbg(D.RequestResponse,"making requestID:"+o+" url:"+s.url),y(s.url,r).then((r=>{t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),this._dbg(D.RequestResponse,"have response for requestID:"+o);let n=0;if(r.data.byteLength>0){n=this._vxl._malloc(r.data.byteLength);const t=new Uint8Array(this._vxl.HEAPU8.buffer,n,r.data.byteLength),s=new Uint8Array(r.data);for(let a=0;a<r.data.byteLength;++a)t[a]=s[a]}a.set(+o,{responseType:s.responseType,ptr:n,size:r.data.byteLength,success:!0,requestType:s.requestType})})).catch((r=>{t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),x(r)||(this._dbg(D.Error,`requestID:${o} failed, error=${r.toString()}`),a.set(+o,{responseType:s.responseType,ptr:0,size:0,success:!1,requestType:s.requestType}))}))}}))}updateWasmCamera(t){this._vxl.set_projection_matrix.apply(this._vxl,t.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,t.viewMatrix),this._vxl.set_near_far(t.near,t.far)}isUpdating(t){if(!this._vxl&&this._vxlPromise)return!0;const s=this._layers.get(t);return!!s&&s.outstandingRequestCount>0}getLayerTimes(t){const s=[];return this._layers.forEach(((r,a)=>{if(r.layerView.wasmLayerId===t.wasmLayerId){const r=this._vxl.get_layer_epoch_times(a,t.layer.currentVariableId);for(let t=0;t<r.length;++t)s.push(r[t])}})),s}getCurrentLayerTimeIndex(t){let s=0;return this._layers.forEach(((r,a)=>{r.layerView.wasmLayerId===t.wasmLayerId&&(s=this._vxl.get_layer_current_time_id(a))})),s}setEnabled(t,s){this._layers.forEach(((r,a)=>{r.layerView.wasmLayerId===t.wasmLayerId&&(this._vxl.set_enabled(a,s),r.needMemoryUsageUpdate=!0,this._renderPluginContext.requestRender())}))}setIsInScaleRange(t,s){const r=this._layers.get(t.wasmLayerId);r&&s!==r.isInScaleRange&&(r.isInScaleRange=s,this._vxl.set_is_in_scale_range(t.wasmLayerId,s),r.needMemoryUsageUpdate=!s,this._renderPluginContext.requestRender())}setStaticSections(t,s){const r={mask:W.StaticSections,staticSections:s};return this._doMaskedUIUpdate(t,r,!0)}setCurrentVariable(t,s){const r={mask:W.CurrentVariable,currentVariable:s};return this._doMaskedUIUpdate(t,r,!0)}setRenderMode(t,s){const r={mask:W.RenderMode,renderMode:s};return this._doMaskedUIUpdate(t,r,!0)}setVerticalExaggerationAndOffset(t,s,r,a){const n={mask:W.ExaggerationAndOffset,volStyleDesc:{volumeId:s,verticalExaggeration:r,verticalOffset:a}};return this._doMaskedUIUpdate(t,n,!0)}setVariableStyles(t,s){const r={mask:W.VariableStyles,variableStyles:s};return this._doMaskedUIUpdate(t,r,!0)}setVolumeStyles(t,s){const r={mask:W.VolumeStyles,volumeStyles:s};return this._doMaskedUIUpdate(t,r,!0)}setEnableDynamicSections(t,s){const r={mask:W.ContainerVisibility,containerIsVisible:s,container:O.DynamicSections};return this._doMaskedUIUpdate(t,r,!0)}setEnableIsosurfaces(t,s){const r={mask:W.ContainerVisibility,containerIsVisible:s,container:O.Isosurfaces};return this._doMaskedUIUpdate(t,r,!0)}setEnableSections(t,s){const r={mask:W.ContainerVisibility,containerIsVisible:s,container:O.StaticSections};return this._doMaskedUIUpdate(t,r,!0)}setAnalysisSlice(t,s,r,a){const n={mask:W.AnalysisSlice,analysisSlice:{point:r,normal:a,enabled:s}};return this._doMaskedUIUpdate(t,n,!0)}updateLayerTimeProperties(t){if(!this._vxl)return;const s=this._layers.get(t.wasmLayerId);if(s){const r=s.layerView.layer;let a=0;r.timeOffset&&(a=p(r.timeOffset.value,r.timeOffset.unit,"seconds"));const n=this._getTimeArgs(r.timeExtent);this._vxl.set_layer_time_properties(t.wasmLayerId,n.startTime,n.endTime,n.hasTime,r.useViewTime,a),this._renderPluginContext.requestRender()}}_doMaskedUIUpdate(t,s,r){if(!this._vxl)return!1;let a=!1;return this._layers.forEach(((r,n)=>{if(r.layerView.wasmLayerId===t.wasmLayerId){const t={str:JSON.stringify(s),byteCount:0,ptr:0,isReusable:!1};this._allocateBlock(t)&&(a=1===this._vxl.handle_masked_ui_update(n,t.ptr,t.byteCount),t.isReusable||this._vxl._free(t.ptr))}})),a&&r&&this._renderPluginContext.requestRender(),a}_addTriangleToWasmBuffer(t,s,r,a,n){return t[3*s]=r[0],t[3*s+1]=r[1],t[3*s+2]=r[2],t[3*(s+=1)]=a[0],t[3*s+1]=a[1],t[3*s+2]=a[2],t[3*(s+=1)]=n[0],t[3*s+1]=n[1],t[3*s+2]=n[2],s+1}_addNormalToWasmBuffer(t,s,r){return t[3*s]=r[0],t[3*s+1]=r[1],t[3*s+2]=r[2],s+1}_doCaptureFrustum(){if(!this._vxl)return;const t=36,s=this._vxl._malloc(108*Float32Array.BYTES_PER_ELEMENT),r=new Float32Array(this._vxl.HEAPF32.buffer,s,108),a=this._vxl._malloc(36*Float32Array.BYTES_PER_ELEMENT),n=new Float32Array(this._vxl.HEAPF32.buffer,a,t),l=this._frustum.points[v.NEAR_BOTTOM_LEFT],o=this._frustum.points[v.NEAR_BOTTOM_RIGHT],h=this._frustum.points[v.NEAR_TOP_RIGHT],d=this._frustum.points[v.NEAR_TOP_LEFT],u=this._frustum.points[v.FAR_BOTTOM_LEFT],c=this._frustum.points[v.FAR_BOTTOM_RIGHT],m=this._frustum.points[v.FAR_TOP_RIGHT],g=this._frustum.points[v.FAR_TOP_LEFT];let f=0,y=0;const x=this._frustum.planes[b.NEAR];f=this._addTriangleToWasmBuffer(r,f,h,o,l),y=this._addNormalToWasmBuffer(n,y,x),f=this._addTriangleToWasmBuffer(r,f,l,d,h),y=this._addNormalToWasmBuffer(n,y,x);const p=this._frustum.planes[b.FAR];f=this._addTriangleToWasmBuffer(r,f,u,c,m),y=this._addNormalToWasmBuffer(n,y,p),f=this._addTriangleToWasmBuffer(r,f,m,g,u),y=this._addNormalToWasmBuffer(n,y,p);const T=this._frustum.planes[b.TOP];f=this._addTriangleToWasmBuffer(r,f,m,h,d),y=this._addNormalToWasmBuffer(n,y,T),f=this._addTriangleToWasmBuffer(r,f,d,g,m),y=this._addNormalToWasmBuffer(n,y,T);const w=this._frustum.planes[b.BOTTOM];f=this._addTriangleToWasmBuffer(r,f,l,o,c),y=this._addNormalToWasmBuffer(n,y,w),f=this._addTriangleToWasmBuffer(r,f,c,u,l),y=this._addNormalToWasmBuffer(n,y,w);const R=this._frustum.planes[b.LEFT];f=this._addTriangleToWasmBuffer(r,f,d,l,u),y=this._addNormalToWasmBuffer(n,y,R),f=this._addTriangleToWasmBuffer(r,f,u,g,d),y=this._addNormalToWasmBuffer(n,y,R);const S=this._frustum.planes[b.RIGHT];f=this._addTriangleToWasmBuffer(r,f,h,m,c),y=this._addNormalToWasmBuffer(n,y,S),f=this._addTriangleToWasmBuffer(r,f,c,o,h),y=this._addNormalToWasmBuffer(n,y,S),-1!==this._frustumRenderableId&&this._vxl.remove_generic_mesh(this._frustumRenderableId),this._frustumRenderableId=this._vxl.add_generic_mesh(s,108,a,t,255,0,0,64),this._vxl._free(s),this._vxl._free(a),this._captureFrustum=!1,this._renderPluginContext.requestRender()}captureFrustum(){null===this._renderCoordsHelper&&(this._renderCoordsHelper=T.create(w.Local,R(!1,this.view.spatialReference))),null===this._frustum&&(this._frustum=new S(this._renderCoordsHelper)),this._captureFrustum=!0,null!==this._renderPluginContext&&this._renderPluginContext.requestRender()}toggleFullVolumeExtentDraw(t){this._vxl&&this._layers.forEach(((s,r)=>{s.layerView.wasmLayerId===t.wasmLayerId&&(this._vxl.toggle_full_volume_extent_draw(r),this._renderPluginContext.requestRender())}))}addVoxelLayer(t){if(!this._vxl){const s={layerView:t,resolveCallback:null,rejectCallback:null},r=new Promise(((t,r)=>{s.resolveCallback=t,s.rejectCallback=r}));return this._newLayers.push(s),r}const s=this._addVoxelLayer(t);return s<0?Promise.reject(-1):Promise.resolve(s)}removeVoxelLayer(t){if(!this._vxl){const s=this._newLayers.findIndex((s=>t.uid===s.layerView.uid));s>=0&&(this._newLayers[s].resolveCallback(-1),this._newLayers.splice(s,1));const r=this._newLayers.length;return 0===r&&(this._dbg(D.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),r}let s=-1;this._layers.forEach(((r,a)=>{if(r.layerView.wasmLayerId===t.wasmLayerId){s=a,r.abortController.abort(),this._vxl.remove_layer(s);const n=this.layerUid.indexOf(t.layer.uid);-1!==n&&this.layerUid.splice(n,1)}})),s>=0&&this._layers.delete(s);const r=this._layers.size;return 0===r&&(this._dbg(D.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),r}_getBlockSize(t){for(const s of this._wasmMemBlockSizes)if(t<s)return s;return-1}_allocateBlock(t){t.byteCount=this._vxl.lengthBytesUTF8(t.str)+1;const s=this._getBlockSize(t.byteCount);return s<0?(t.isReusable=!1,t.ptr=this._vxl._malloc(t.byteCount)):(t.isReusable=!0,t.ptr=this._wasmMemBlocks.get(s),0===t.ptr&&(t.ptr=this._vxl._malloc(s),this._wasmMemBlocks.set(s,t.ptr))),0!==t.ptr&&(this._vxl.stringToUTF8(t.str,t.ptr,t.byteCount),!0)}_getTimeArgs(t){let s=-Number.MAX_VALUE,r=Number.MAX_VALUE,a=!1;return null!=t&&(t.isAllTime?a=!0:(null!=t.start&&(a=!0,s=t.start.getTime()/1e3),null!=t.end&&(a=!0,r=t.end.getTime()/1e3))),{startTime:s,endTime:r,hasTime:a}}_addVoxelLayer(t){var s;const r=t.layer;let a=-1;const n=r.getConfiguration();if(n.length<1)return-1;const l={str:n,byteCount:0,ptr:0,isReusable:!1};if(!this._allocateBlock(l))return-1;const o=this._getTimeArgs(r.timeExtent),h=this.view.spatialReference.isWGS84&&r.spatialReference.isWGS84?111319.49079327357:1;let u=0;if(r.timeOffset&&(u=p(r.timeOffset.value,r.timeOffset.unit,"seconds")),a=this._vxl.add_layer(r.serviceRoot,l.ptr,l.byteCount,h,h,o.startTime,o.endTime,o.hasTime,r.useViewTime,u,this._toWasmQuality(this.view.qualityProfile)),l.isReusable||this._vxl._free(l.ptr),a>=0){(null==(s=r.test)?void 0:s.constantUpscaling)&&(this._setUpscalingLimits(0,.25,.25),this._setUpscalingLimits(1,.5,.5),this._setUpscalingLimits(2,.75,.75));const n=new AbortController;if(this._layers.set(a,{layerView:t,responses:new Map,outstandingRequestCount:0,abortController:n,needMemoryUsageUpdate:!1,isInScaleRange:!0}),this.layerUid.push(t.layer.uid),!this._halfIntTexturesAvailable||V("mac")){const s=[];let r="";for(const a of t.layer.variables)"Int16"!==a.renderingFormat.type&&"UInt16"!==a.renderingFormat.type||(s.push(a.name),a.id===t.layer.currentVariableId&&(r=a.name));""!==r&&d.getLogger(this).error("#addVoxelLayer_error()",t.layer,`The voxel layer '${t.layer.title}' cannot render the current variable '${r}' in this browser`),s.length>0&&d.getLogger(this).warn("#addVoxelLayer_warning()",t.layer,`The voxel layer '${t.layer.title}' cannot render the variables '${s.toString()}' in this browser`)}if(!this._textureFloatLinearAvailable){const s=[];let r="";for(const a of t.layer.variables)"Float32"===a.renderingFormat.type&&(s.push(a.name),a.id===t.layer.currentVariableId&&(r=a.name));""!==r&&d.getLogger(this).error("#addVoxelLayer_error()",t.layer,`The voxel layer '${t.layer.title}' cannot render the current variable '${r}' in this browser`),s.length>0&&d.getLogger(this).warn("#addVoxelLayer_warning()",t.layer,`The voxel layer '${t.layer.title}' cannot render the variables '${s.toString()}' in this browser`)}return V("esri-mobile")&&d.getLogger(this).warnOnce("Mobile support differs across devices. Voxel layer might not display as expected."),a}return-1}prepareRender(t){if(!this._vxl)return;const s=t.bindParameters.camera.viewForward,r=t.bindParameters.camera.eye;this._vxl.update_camera_pos_and_direction(r[0],r[1],r[2],s[0],s[1],s[2]);const a=this._vxl.cull();this._dbg(D.RequestResponse,"missingResourceCount="+a),this._moreToLoad=a>0,this._havePreparedWithAllLayers=0===this._newLayers.length,this._updateMemoryUsage()}renderNode(t){if(!this._vxl)return;for(const r of this._newLayers){const t=this._addVoxelLayer(r.layerView);-1===t?r.rejectCallback(-1):r.resolveCallback(t)}if(this._newLayers=[],0===this._layers.size)return void this._dbg(D.Error,"No voxel layers but RenderPlugin instance is being asked to render!");this._lastFrameWasStationary=this.view.stationary,this._syncRequestsResponses(),this._beforeDraw(),this._vxl.begin_color_frame(!this.view._stage.renderer.isFeatureEnabled(L.HighResolutionVoxel),t.bindParameters.lighting.mainLight.direction[0],t.bindParameters.lighting.mainLight.direction[1],t.bindParameters.lighting.mainLight.direction[2]);const s=this._renderTargetToRestore.viewport;s.width===this._viewportWidth&&s.height===this._viewportHeight||(this._viewportWidth=s.width,this._viewportHeight=s.height,this._vxl.set_viewport(s.width,s.height),this._layers.forEach((t=>{t.needMemoryUsageUpdate=!0}))),0===s.x&&0===s.y||this._dbg(D.Error,"Unsupported viewport parameters detected!"),this.updateWasmCamera(t.bindParameters.camera),this._captureFrustum&&(this._frustum.update(t.bindParameters.camera),this._doCaptureFrustum()),this._vxl.draw(),this._afterDraw(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender()}destroy(){this._dbg(D.Lifetime,"--destroy--"),this._removeRenderPlugin(),this._vxl&&(this._layers.forEach((t=>{t.abortController.abort()})),this._wasmMemBlocks.forEach((t=>{0!==t&&this._vxl._free(t)})),this._vxl.uninitialize_voxel_wasm(),this._vxl=null)}_initializeWasm(s){return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=function e(s){return new Promise((r=>t((()=>import("./vxlLayer-_-nEnWHU.js")),__vite__mapDeps([0,1,2])).then((t=>t.v)).then((({default:t})=>{const a=t({locateFile:i,preinitializedWebGLContext:s,onRuntimeInitialized:()=>r(a)})})))).catch((t=>{throw t}))}(s).then((t=>{var s;if(this._vxl=t,this._vxlPromise=null,this._newLayers.length<=0)return this._dbg(D.Lifetime," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),void this.destroy();const r=this._getTimeArgs(null==(s=this.view)?void 0:s.timeExtent),a=this._vxl.addFunction(this._restoreFramebuffer.bind(this),"v"),n=this._vxl.addFunction(this._setBlendState.bind(this),"viiii"),l=this._vxl.addFunction(this._setFrontFace.bind(this),"vi"),o=this._vxl.addFunction(this._setRasterizerState.bind(this),"vi"),h=this._vxl.addFunction(this._setDepthStencilStateFunction.bind(this),"viii"),d=this._vxl.addFunction(this._setViewport.bind(this),"viiii"),u=this._vxl.addFunction(this._bindPreviousDepthToSlot.bind(this),"iii"),c=this._vxl.addFunction(this._modifyResourceCount.bind(this),"viii"),m=this._halfIntTexturesAvailable&&!V("mac"),g=this._textureFloatLinearAvailable;this._vxl.initialize_voxel_wasm(a,n,l,o,h,d,u,c,r.startTime,r.endTime,r.hasTime,m,g),this._renderPluginContext&&this._renderPluginContext.requestRender()})).catch((()=>{for(const t of this._newLayers)t.rejectCallback(-2);this._dbg(D.Error," WASM failed to download, removing RenderPlugin and destroying"),this.destroy()}))),this._vxlPromise)}pickDepth(t,s,r){if(!this._vxl||!this._rctx||0===this._layers.size)return null;const a=r.viewport[3]-s;if(t<0||t>r.viewport[2]||s<0||s>r.viewport[3])return this._dbg(D.Error,`[js] pickDepth: outOfRange, screenXY=[${t.toFixed(0)}, ${a.toFixed(0)}]]`),null;this._beforeDraw();const n=r.viewForward,l=r.eye;this._vxl.update_camera_pos_and_direction(l[0],l[1],l[2],n[0],n[1],n[2]),this.updateWasmCamera(r),this._vxl.begin_frame();const o=this._vxl.pick_depth(t,a);return this._afterDraw(),o.success?o.distanceToCamera:null}pickObject(t,s,r,a){if(!this._vxl||!this._rctx||0===this._layers.size)return null;const n=Math.round(t),l=Math.round(s);if(n<0||n>r.viewport[2]||l<0||l>r.viewport[3])return this._dbg(D.Error,`[js] pickObject: outOfRange, screenXY=[${n}, ${l}], vp=[${r.viewport.toString()}]`),null;this._beforeDraw();const o=r.viewForward,h=r.eye;this._vxl.update_camera_pos_and_direction(h[0],h[1],h[2],o[0],o[1],o[2]),this.updateWasmCamera(r),this._vxl.begin_frame();let d=null;if(0===a.length)d=this._vxl.pick_object(n,l,0,0);else{const t={str:JSON.stringify({layerIds:a}),byteCount:0,ptr:0,isReusable:!1};this._allocateBlock(t)&&(d=this._vxl.pick_object(n,l,t.ptr,t.byteCount),t.isReusable||this._vxl._free(t.ptr))}return this._afterDraw(),d}_beforeDraw(){this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this._rctx.setPolygonOffsetFillEnabled(!1),this._rctx.setScissorTestEnabled(!1),this._rctx.setColorMask(!0,!0,!0,!0)}_afterDraw(){this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate(),this._rctx.externalProgramUpdate()}intersect(t,s,r,a,n){if(!this._vxl||!this._rctx||0===this._layers.size||!t.options.selectionMode||t.options.isFiltered)return;if(null==n||n[0]<0||n[0]>t.camera.viewport[2]||n[1]<0||n[1]>t.camera.viewport[3])return this._dbg(D.Error,`[js] VoxelWasmPerScene.intersect: outOfRange, screenXY=[${n[0].toFixed(0)}, ${n[1].toFixed(0)}]`),null;const l=[];this._layers.forEach((s=>{t.options.filteredLayerUids.includes(s.layerView.layer.uid)&&l.push(s.layerView.wasmLayerId)}));const o=this.pickObject(n[0],n[1],t.camera,l);if(null==o||-1===o.layerId)return;const h=this._layers.get(o.layerId);if(h){const s=h.layerView.layer.uid,n=o.distanceToCamera/C(r,a),l=I();l[0]=o.worldX,l[1]=o.worldY,l[2]=o.worldZ;const d={};if(null!=o.continuousValue&&null!=o.continuousValueUnits?d["Voxel.ServiceValue"]=`${o.continuousValue.toLocaleString()} ${o.continuousValueUnits}`:null!=o.uniqueValueLabel&&null!=o.uniqueValue?d["Voxel.ServiceValue"]=`${o.uniqueValueLabel} (${o.uniqueValue})`:null!=o.uniqueValue&&(d["Voxel.ServiceValue"]=`${o.uniqueValue}`),d["Voxel.ServiceVariableLabel"]=o.variableLabel,d["Voxel.Position"]=o.voxelSpacePosition,null!=o.epochTime&&null!=o.nativeTime&&null!=o.nativeTimeUnits){const t=new Date(o.epochTime);d["Voxel.ServiceLocalTime"]=t.toString(),d["Voxel.ServiceNativeTime"]=`${o.nativeTime.toLocaleString()} ${o.nativeTimeUnits}`}null!=o.depth&&null!=o.depthUnits&&(d["Voxel.ServiceDepth"]=`${o.depth.toLocaleString()} ${o.depthUnits}`);const u=o.faceNormal;d["Voxel.WorldPosition"]=`[${l[0]}, ${l[1]}, ${l[2]}]`;const _=t=>{const r=new P(l,s,(()=>this._createVoxelGraphic(h.layerView.layer,d)));t.set(this.type,r,n,u)},c=t.results,m=t.options.store===E.ALL;if((null==c.min.dist||n<c.min.dist)&&_(c.min),(null==c.max.dist||n>c.max.dist)&&_(c.max),m){const s=F(t.ray);_(s),t.results.all.push(s)}}}_createVoxelGraphic(t,s){return new k({layer:t,sourceLayer:t,attributes:s})}_toWasmQuality(t){switch(t){case"low":return 0;case"medium":return 1;case"high":return 2}}_setUpscalingLimits(t,s,r){this._vxl&&this._vxl.set_upscaling_limits(t,s,r)}};r([a({constructOnly:!0})],N.prototype,"view",void 0),N=r([n("esri.layers.VoxelWasmPerSceneView")],N);const z=N;export{z as default};
