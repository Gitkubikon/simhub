import{d as e,ld as s,le as i,lf as r,hq as a,dG as n,dk as o,lg as c,kL as d,v as h,lh as u,q as m,b as p,li as b,g,P as f,lj as y,lk as v,u as w,gI as _,iv as x,r as C,kH as T,bo as P,bK as M,cf as E,ll as O,lm as U,cv as A,ln as I,lo as V,lp as H,lq as R,Q as S,fD as F,lr as j,m as L,ls as D,lt as B,jW as k,dD as G,hB as N,dW as W,lu as z,H as q,br as $,lv as J,lw as X,lx as K,hp as Q,ly as Y,lz as Z,lA as ee,lB as te,lC as se,lD as ie,eb as re,lE as ae,lF as ne,lG as oe,lH as le,lI as ce,n as de,e as he,y as ue,a as me,bV as pe}from"./index-DSIPxOWi.js";import{x as be,f as ge,t as fe,i as ye}from"./Transform-A6X0mfYo.js";import{r as ve,a as we,S as _e,N as xe,e as Ce,m as Te,d as Me,g as Ee,t as Ue,n as Ae,i as Ie}from"./ILyr3DWasmPerSceneView-Cbzithql.js";import{l as Ve}from"./LayerView3D-ApO6iJqK.js";import{s as He}from"./RenderTexture-DbJC7CTU.js";import{y as Re}from"./LayerView-DMoB2q_T.js";class t extends e{constructor(e,s,i,r,a,n,o){super(e,0,0,0,s),this.nodesCached=i,this.vboMB=r,this.textureMB=a,this.vboMBCached=n,this.textureMBCached=o}}const Se={[ve.Points]:null,[ve.Lines]:null,[ve.LineStrip]:null,[ve.Triangles]:s.TRIANGLES,[ve.TriangleStrip]:s.TRIANGLE_STRIP,[ve.NotSet]:null},Fe={[we.Opaque]:i.Opaque,[we.Mask]:i.Mask,[we.Blend]:i.Blend},je={[_e.Back]:r.Back,[_e.Front]:r.Front,[_e.None]:r.None,[_e.NotSet]:r.Back},Le={[xe.WrapYBit]:{s:a.CLAMP_TO_EDGE,t:a.REPEAT},[xe.WrapXBit]:{s:a.REPEAT,t:a.CLAMP_TO_EDGE},[xe.WrapXy]:{s:a.REPEAT,t:a.REPEAT},[xe.None]:{s:a.CLAMP_TO_EDGE,t:a.CLAMP_TO_EDGE},[xe.NotSet]:{s:a.CLAMP_TO_EDGE,t:a.CLAMP_TO_EDGE}},De={[Ce.U8]:1,[Ce.I8]:1,[Ce.U16]:2,[Ce.I16]:2,[Ce.U32]:4,[Ce.I32]:4,[Ce.F32]:4,[Ce.F64]:8,[Ce.Utf8String]:1,[Ce.NotSet]:1};class l{constructor(e){this.layerUid=[],this.type=n.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,s,i,r,a,n){const h=e.results,m=e.options.store===o.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const p=this.layerView.view._stage.renderView.componentObjectCollection,b=new c(n??!1,e.options.normalRequired);this.layerView.objects.forEach((a=>{a.visible&&a.intersectionGeometry&&p.intersect(a,i,r,e.tolerance,null,b,((a,n,o,c)=>{if(n>=0){if(null!=s&&!s(i,r,n))return;const s4=e=>{const s=new u(this.layerView.layer.uid,(()=>this._createTiles3DGraphic(this.layerView.layer,{})));e.set(this.type,s,n,o)};if(this.isGround&&(null==h.ground.dist||n<h.ground.dist)&&s4(h.ground),e.options.isFiltered)return;if((null==h.min.dist||n<h.min.dist)&&s4(h.min),(null==h.max.dist||n>h.max.dist)&&s4(h.max),m){const s=d(e.ray);s4(s),e.results.all.push(s)}}}))}))}_createTiles3DGraphic(e,s){return new h({layer:e,sourceLayer:e,attributes:s})}}var Be,ke;(ke=Be||(Be={}))[ke.API=1]="API",ke[ke.VerboseAPI=2]="VerboseAPI",ke[ke.Error=3]="Error";class Pe{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function Oe(e){return Math.round(e/1048.576)/1e3}let Ge=class extends(Ve(Re)){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=m.WithoutRasterImage,this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(Be.Error),this._dbg(Be.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new p("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const e=b(this).then((e=>{this._intersectionHandler=new l(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add((()=>this.slicePlaneEnabled),(e=>this._slicePlaneEnabledChange(e))),this._elevationProvider=new be({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const s=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,(e=>this._onRemoveFromCache(e)));this._memCache=s,this.addHandles([g((()=>this.layer.elevationInfo),(e=>this._elevationInfoChanged(e)))]),this._suspendedHandle=g((()=>this.suspended),(e=>{const s=y(this.view);s&&s.setEnabled(this,!e)}),f)})).catch((e=>{if(v(this),this._wasmLayerId=-1,e===Te)throw new p("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===Me)throw new p("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})}));this.addResolvingPromise(e)}destroy(){this._dbg(Be.VerboseAPI,"Tiles3DLayerView3D destroy() called"),v(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach((e=>this.freeObject(e))),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=w(this._memCache),this._updatingHandles=w(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=_((()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})))}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),this.objects.forEach((s=>{const i=this._collection.getMaterial(s);i.commonMaterialParameters.hasSlicePlane=e,i.commonMaterialParameters.cullFace=e?r.None:this._initialCullFace.get(s)}))}_elevationInfoChanged(e){const s=y(this.view);s&&s.setLayerOffset(this,x(e))}get _obbs(){return this.objects.map((e=>this._collection.getComponentObb(e)))}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let e=0;return this._lyrHandleToObjects.forEach((s=>{s.isVisible&&(e+=s.totalMemory())})),e}get unloadedMemory(){let e=0;return this._lyrHandleToObjects.forEach((s=>{s.isVisible||(e+=s.totalMemory())})),e}get visibleAtCurrentScale(){return C(this.layer.effectiveScaleRange,this.view.terrainScale)}get performanceInfo(){let e=0,s=0,i=0,r=0,a=0,n=0;return this._lyrHandleToObjects.forEach((o=>{o.isVisible?(e+=o.texMemoryUsage,s+=o.vboMemoryUsage,a++):(i+=o.texMemoryUsage,r+=o.vboMemoryUsage,n++)})),new t(this.usedMemory,a,n,Oe(s),Oe(e),Oe(r),Oe(i))}_canProjectWithoutEngine(){var e,s;if(this.view.state.viewingMode===T.Local){const i=(null==(e=this.view.renderSpatialReference)?void 0:e.isWebMercator)?3857:(null==(s=this.view.renderSpatialReference)?void 0:s.wkid)??-1;if(3857!==i&&32662!==i)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return x(this.layer.elevationInfo)}get elevationRange(){const e=this.fullExtent;return(null==e?void 0:e.zmin)&&(null==e?void 0:e.zmax)?new P(e.zmin,e.zmax):null}getElevationRange(e){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce(((e,s)=>e.concat(s.components)),new Array)}isUpdating(){const e=y(this.view);return!(this._wasmLayerId<0||null==e)&&e.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(e){var s;const a=e.meshData;if(null==a.data)throw new Error("meshData.data undefined");if(a.desc=JSON.parse(a.desc),null==a.desc)throw new Error("meshData.desc undefined");const n=M(a.desc.origin),o=new Array,c=new Map,d=new Pe;d.handle=e.handle,this._lyrHandleToObjects.set(e.handle,d);const h=this.view.basemapTerrain.spatialReference;let u,m;if("global"===this.view.viewingMode){const e=pe();E(O,n,e,h),u=U(A(),e),m=I(A(),u)}else u=V,m=V;const p=pe();H(p,p,n);const b=R(S(),p);let g=null;const f=S();if(a.desc.obb){const e=a.desc.obb.quaternion;g=new F(a.desc.obb.center,a.desc.obb.halfSize,j(e[0],e[1],e[2],e[3]))}for(let y=0;y<a.desc.prims.length;y++){const e=a.desc.prims[y];if(this._dbg(Be.VerboseAPI,JSON.stringify(e)),e.ptype===ve.Lines)continue;if(null==Se[e.ptype]||null==a.data){this._dbg(Be.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+e.ptype+"). Skipping primitive.");continue}const p=(null==(s=a.desc)?void 0:s.materials)&&null!=e.materialId?a.desc.materials[e.materialId]:null,v=null!=p?p.lightingModel:Ee.Unlit,w=!L("disable-feature:im-shading"),{positionView:_,positionAttr:x,normalsView:C,normalsAttr:T,colorAttr:P,texCoord0Attr:M,indicesView:E}=this.getBufferViews(e,a.data.buffer,u,w);if(null==x||null==_||null==E)continue;const O={colors:null!=P,textureCoordinates:null!=M?D.Default:D.None,hasNormals:null!=C,needsNormals:w},U=x.data.length/x.size,I2=(e,s)=>!e||e.data.length/e.size===U||(this._dbg(Be.Error,`${s} !== numPos. Skipping primitive.`),!1);if(!I2(M,"numTexcoord")||!I2(P,"numColors")||!I2(T,"normals"))continue;const A=B(O);if(null!=g?g=g.clone():(g=k(x),G(f,g.center,n),g.center=f),u!==V)for(let s=0;s<_.count;s++)_.getVec(s,f),N(f,f,u),_.setVec(s,f);const I=A.createBuffer(x.data.length),H=new Map([[W.POSITION,x]]);null!=M&&H.set(W.UV0,M),null!=P&&H.set(W.COLOR,P),null!=T&&H.set(W.NORMALCOMPRESSED,T),H.forEach(((e,s)=>{null!=e&&z(s,e,null,null,I,0)}));const R=new Uint32Array([0,E.typedBuffer.length]),F={vertices:{data:I.buffer,count:I.byteLength/A.stride,layoutParameters:O},positionData:{positions:_.typedBuffer,indices:E.typedBuffer},indices:E.typedBuffer,componentOffsets:R};d.cpuMemoryUsage+=_.count,d.cpuMemoryUsage+=E.count;const j=this.view.renderSpatialReference,K=S(),Q=[1,1,1];ge(b,j,Q,h)||this._dbg(Be.Error,"Unsupported coordinate system for IM overlay"),q(b,j,K,h);const Y=this._collection.createObject(new fe($(K[0],K[1],Q[0],Q[1]),new ye(b,m),g,F));p&&this._collection.updateMaterial(Y,(e=>{e.baseColor=p.baseColorFactor,e.usePBR=v===Ee.Pbr,e.hasParametersFromSource=!1,e.baseColorTexture=this._getTexture(p.baseColorTex,a,c),e.usePBR&&(e.mrrFactors=[p.metallicFactor,p.roughnessFactor,0],e.emissiveFactor=p.emissiveFactor??[0,0,0],e.metallicRoughnessTexture=this._getTexture(p.metalTex,a,c),e.emissionTexture=this._getTexture(p.emissiveTex,a,c),e.occlusionTexture=this._getTexture(p.occlusionTex,a,c),e.normalTexture=this._getTexture(p.normalTex,a,c)),e.objectOpacity=0,e.alphaDiscardMode=i.Mask;const s=[];e.baseColorTexture&&s.push(e.baseColorTexture.loadPromise),e.usePBR&&e.metallicRoughnessTexture&&s.push(e.metallicRoughnessTexture.loadPromise),e.usePBR&&e.emissionTexture&&s.push(e.emissionTexture.loadPromise),e.usePBR&&e.occlusionTexture&&s.push(e.occlusionTexture.loadPromise),e.usePBR&&e.normalTexture&&s.push(e.normalTexture.loadPromise);const n=Promise.all(s);o.push(n),n.then((()=>{var s,i,r,a,n,o,c,h,u,m;e.alphaDiscardMode=Fe[p.alphaMode],e.objectOpacity=1,d.texMemoryUsage+=(null==(i=null==(s=e.baseColorTexture)?void 0:s.glTexture)?void 0:i.usedMemory)||0,e.usePBR&&(d.texMemoryUsage+=(null==(a=null==(r=e.metallicRoughnessTexture)?void 0:r.glTexture)?void 0:a.usedMemory)||0,d.texMemoryUsage+=(null==(o=null==(n=e.emissionTexture)?void 0:n.glTexture)?void 0:o.usedMemory)||0,d.texMemoryUsage+=(null==(h=null==(c=e.occlusionTexture)?void 0:c.glTexture)?void 0:h.usedMemory)||0,d.texMemoryUsage+=(null==(m=null==(u=e.normalTexture)?void 0:u.glTexture)?void 0:m.usedMemory)||0)})),e.commonMaterialParameters.doubleSided=p.isDoubleSided,e.commonMaterialParameters.cullFace=p.faceCulling?je[p.faceCulling]:r.Back,this._initialCullFace.set(Y,e.commonMaterialParameters.cullFace),e.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,e.componentParameters.castShadows=J.All,e.textureAlphaCutoff=p.alphaCutoff??.1,e.alphaDiscardMode=Fe[p.alphaMode],e.isIntegratedMesh=!0,e.polygonOffsetEnabled=!1,e.hasOccludees=!1,e.ellipsoidMode=X(this.view.spatialReference)})),d.components.push(Y),d.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(Y)}if(await Promise.all(o),c.forEach((e=>{d.textures.push(e)})),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${d.handle}`,d,d.totalMemory()),{memUsageBytes:d.totalMemory()}}freeRenderable(e){const s=this._lyrHandleToObjects.get(e);s&&(this.freeObject(s),this._lyrHandleToObjects.delete(e))}freeObject(e){this._memCache&&this._memCache.pop(`${e.handle}`),e.components.forEach((s=>{e.textures.forEach((e=>{this._stage.remove(e)})),this._collection.destroyObject(s),this._initialCullFace.delete(s)}))}setRenderableVisibility(e,s,i){if(this._memCache){for(let r=0;r<i;++r){const i=e[r],a=s[r];if(!a)continue;const n=this._lyrHandleToObjects.get(i);n&&(this._visibleGeometryChanged(),n.isVisible=a,n.components.forEach((e=>{this._collection.setObjectVisibility(e,a),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))})),this._memCache.pop(`${i}`))}for(let r=0;r<i;++r){const i=e[r],a=s[r];if(a)continue;const n=this._lyrHandleToObjects.get(i);n&&(this._visibleGeometryChanged(),n.isVisible=a,n.components.forEach((e=>{this._collection.setObjectVisibility(e,a),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))})),this._memCache.put(`${i}`,n,n.totalMemory()))}}}_getTexture(e,s,i){var r,a;let n=null;if(e&&(null==(r=s.desc)?void 0:r.images)&&(null==(a=s.data)?void 0:a.buffer)){const r=s.desc.images[null==e?void 0:e.imageId];if(n=i.get(r),!n&&r){const a=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,o=a>1,c=Le[e.wrapMode??xe.None];let d=r.alpha?4:3;const h=new Uint8Array(s.data.buffer,r.data.byteOffset,r.data.byteCount);let u=null,m=null,p=null;switch(r.format){case Ue.Raw:r.pixelFormat===Ae.R8?(u=h.buffer,d=1,m=""):r.pixelFormat===Ae.Rgb8?(u=h.buffer,d=3,m=""):r.pixelFormat===Ae.Rgba8&&(u=h.buffer,d=4,m="");break;case Ue.Dxt1:u=h.buffer,d=3,m=K.DDS_ENCODING;break;case Ue.Dxt5:u=h.buffer,d=4,m=K.DDS_ENCODING;break;case Ue.Png:m="image/png",p=document.createElement("img");break;case Ue.Jpeg:m="image/jpeg",p=document.createElement("img");break;case Ue.Etc2:m="image/ktx",p=document.createElement("img");break;case Ue.Astc:this._dbg(Be.Error,"Astc texture not supported");break;case Ue.Pvrtc:this._dbg(Be.Error,"Pvrtc texture not supported")}if(p&&m){const e=new Blob([h],{type:m});p.src=URL.createObjectURL(e),u=p}u&&null!=m&&(n=new Q(u,{mipmap:o,maxAnisotropy:a,encoding:m,wrap:c,components:d,noUnpackFlip:!0,width:r.mip0Width,height:r.mip0Height}),this._stage.add(n),i.set(r,n))}}return n?new He(this.view._stage.renderView.textures,n.id):null}getBufferViews(e,s,i,r){let a,n,o,c,d,h,u,m=null;for(let b=0;b<e.atrbs.length;b++){const u=e.atrbs[b],g=u.view,f=void 0,y=g.byteOffset+g.byteCount,v=g.byteCount/De[g.type],w=[...Array(v).keys()].map((e=>e));try{switch(u.sem){case Ie.Position:3!==g.ncomp||g.type!==Ce.F32?this._dbg(Be.Error,"[Unsupported Feature] Unsupported view for Position ("+g+")"):(a=new te(s,g.byteOffset,f,y),n=new re(a.typedBuffer,w,3));break;case Ie.Normal:if(3!==g.ncomp||g.type!==Ce.F32)this._dbg(Be.Error,"[Unsupported Feature] Unsupported view for Normal ("+g+")");else if(r){const e=new te(s,g.byteOffset,f,y),r=ne(e.typedBuffer,i);d=new oe(r),h=new re(d.typedBuffer,w,2)}break;case Ie.TexCoord:2!==g.ncomp||g.type!==Ce.F32?this._dbg(Be.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+g+")"):void 0===c&&(c=new re(new ae(s,g.byteOffset,f,y).typedBuffer,w,2));break;case Ie.Color:4===g.ncomp?(g.type===Ce.F32&&(m=new Y(s,g.byteOffset,f,y)),g.type===Ce.U8&&(m=new Z(s,g.byteOffset,f,y)),g.type===Ce.U16&&(m=new ee(s,g.byteOffset,f,y))):3===g.ncomp&&(g.type===Ce.F32&&(m=new te(s,g.byteOffset,f,y)),g.type===Ce.U8&&(m=new se(s,g.byteOffset,f,y)),g.type===Ce.U16&&(m=new ie(s,g.byteOffset,f,y))),null==m?this._dbg(Be.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+g+")"):o=new re(m.typedBuffer,w,g.ncomp);break;case Ie.FeatureIndex:break;default:this._dbg(Be.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+u.sem+"). Skipping vertex attribute.")}}catch(p){this._dbg(Be.VerboseAPI,"Error Creating buffer ("+p+"). Skipping vertex attribute.")}}if(e.index){const i=e.index.view,r=void 0,a=i.byteOffset+i.byteCount;switch(e.index.view.type){case Ce.U16:u=new ce(s,i.byteOffset,r,a);break;case Ce.U32:u=new le(s,i.byteOffset,r,a);break;case Ce.U8:default:this._dbg(Be.Error,"[Unsupported Feature] index type not supported ("+i.type+").")}}if(null==u&&null!=a){const e=a.count;if(e<65535){const s=new Uint16Array(e);u=new ce(s)}else{const s=new Uint32Array(e);u=new le(s)}for(let s=0;s<e;s++)u.set(s,s)}return{positionView:a,positionAttr:n,colorAttr:o,texCoord0Attr:c,indicesView:u,normalsView:d,normalsAttr:h}}_onRemoveFromCache(e){const s=y(this.view);s&&s.onRenderableEvicted(this,e.handle,e.totalMemory()),this.freeRenderable(e.handle)}_dbg(e,s){this._dbgFlags.has(e)&&(e===Be.Error?de.getLogger(this).error(s):de.getLogger(this).warn(s))}};he([ue()],Ge.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),he([ue()],Ge.prototype,"layer",void 0),he([ue({readOnly:!0})],Ge.prototype,"visibleAtCurrentScale",null),he([ue()],Ge.prototype,"elevationOffset",null),Ge=he([me("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],Ge);const Ne=Ge;export{Ne as default};
