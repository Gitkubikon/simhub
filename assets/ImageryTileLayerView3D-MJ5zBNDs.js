import{m0 as e,m1 as t,m2 as r,m3 as i,m4 as s,hq as a,m5 as n,m6 as o,m7 as u,m8 as h,e as d,y,a as g,b as x,af as b,v as T,ae as v,m9 as w}from"./index-DSIPxOWi.js";import{v as I,s as R}from"./rasterProjectionHelper-WTn80RSY.js";import{l as G}from"./LayerView3D-ApO6iJqK.js";import{p as z}from"./TiledLayerView3D-BIihePS5.js";import{i as E}from"./timeSupport-CU-EQyfu.js";import{y as S}from"./LayerView-DMoB2q_T.js";import{i as P}from"./RefreshableLayerView-MYyyoaX8.js";import{r as O}from"./drapedUtils-DOQFzwPw.js";function m$1(e,r){const o=new t;return o.internalFormat=i.RGBA,o.width=r.length/4,o.height=1,o.samplingMode=s.NEAREST,o.wrapMode=a.CLAMP_TO_EDGE,new n(e,o,r)}const L={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class m{constructor(e,t,r=null,i=null){this.lij=e,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=t,this.width=r||t.width,this.height=i||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=u(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...L,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||L}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){null!=e&&e.length>0?this._bandIds&&e.every(((e,t)=>{var r;return!!(null==(r=this._bandIds)?void 0:r[t])&&e===this._bandIds[t]}))||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,null!=this._rasterTexture){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode("bilinear"===t?s.LINEAR:s.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=u(this._transformGridTexture),this._memoryUsed=null}bind(i){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((null==this._rasterTexture||this._dirty)&&this._updateRasterTexture(i,this.bandIds),null!=this._rasterTexture&&(this._updateColormapTexture(i),this.transformGrid&&null==this._transformGridTexture&&(this._transformGridTexture=function c(i,o){const{spacing:u,offsets:h,coefficients:d,size:[y,g]}=o,x=u[0]>1,b=new t;b.width=x?4*y:y,b.height=g,b.internalFormat=r.RGBA32F,b.dataType=e.FLOAT,b.samplingMode=s.NEAREST,b.wrapMode=a.CLAMP_TO_EDGE;const T=new Float32Array(x?y*g*16:2*h.length);if(x&&null!=d)for(let e=0,t=0;e<d.length;e++)T[t++]=d[e],e%3==2&&(T[t++]=1);else for(let e=0;e<g;e++)for(let t=0;t<y;t++){const r=4*(e*y+t),i=2*(t*g+e);T[r]=h[i],T[r+1]=h[i+1],T[r+3]=-1===h[i]?0:1}return new n(i,b,T)}(i,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:e,transformGrid:t,width:r,height:i,opacity:s}=this,a=function l(e,t,r,i=1,s=!0){return{u_flipY:s,u_applyTransform:!!e,u_opacity:i,u_transformSpacing:e?e.spacing:o,u_transformGridSize:e?e.size:o,u_targetImageSize:t,u_srcImageSize:r}}(t,[r,i],[this.source.width,this.source.height],s),n=function _(e,t){return{u_colormapOffset:t||0,u_colormapMaxIndex:e?e.length/4-1:0}}(e.colormap,e.colormapOffset),u="stretch"===this.symbolizerParameters.type?function p(e){return{u_bandCount:e.bandCount,u_minOutput:e.outMin,u_maxOutput:e.outMax,u_minCutOff:e.minCutOff,u_maxCutOff:e.maxCutOff,u_factor:e.factor,u_useGamma:e.useGamma,u_gamma:e.gamma,u_gammaCorrection:e.gammaCorrection}}(this.symbolizerParameters):null,d="hillshade"===this.symbolizerParameters.type?function A(e){return{u_hillshadeType:e.hillshadeType,u_sinZcosAs:e.sinZcosAs,u_sinZsinAs:e.sinZsinAs,u_cosZs:e.cosZs,u_weights:e.weights,u_factor:e.factor,u_minValue:e.minValue,u_maxValue:e.maxValue}}(this.symbolizerParameters):null;return new h(a,n,u||d,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return"bilinear"===this.interpolation&&null!=e.colormap&&"stretch"===e.type}get memoryUsage(){if(null==this._memoryUsed){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map((e=>null!=e?e.descriptor.width*e.descriptor.height*4:0)).reduce(((e,t)=>e+t),0)}return this._memoryUsed}release(){return this._rasterTexture=u(this._rasterTexture),this._transformGridTexture=u(this._transformGridTexture),this._colormapTexture=u(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(o,h){const d=this.source?this.source.extractBands(h):null;if(!((null==d?void 0:d.pixels)&&d.pixels.length>0))return void(this._rasterTexture=u(this._rasterTexture));const y=null==h&&null==this.bandIds||null!=h&&null!=this.bandIds&&h.join("")===this.bandIds.join("");if(null!=this._rasterTexture&&y)return;this._rasterTexture=u(this._rasterTexture);const g=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=function f(o,u,h="nearest",d=!1){const y=!(d&&"u8"===u.pixelType),g=y?e.FLOAT:e.UNSIGNED_BYTE,x=null==u.pixels||0===u.pixels.length?null:y?u.getAsRGBAFloat():u.getAsRGBA(),b=o.capabilities.textureFloatLinear,T=new t;return T.width=u.width,T.height=u.height,T.internalFormat=y?r.RGBA32F:i.RGBA,T.samplingMode=!b||"bilinear"!==h&&"cubic"!==h?s.NEAREST:s.LINEAR,T.dataType=g,T.wrapMode=a.CLAMP_TO_EDGE,new n(o,T,x)}(o,d,g,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&"none"===this.symbolizerParameters.stretchType&&!this.symbolizerParameters.useGamma&&"u8"===this.source.pixelType}_getRasterTextureInterpolation(e){return"lut"===this.symbolizerParameters.type||"nearest"===e||"majority"===e||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,r=this.symbolizerParameters.colormap;return r?t?r.length!==t.length||r.some(((e,r)=>e!==t[r]))?(this._colormapTexture=u(this._colormapTexture),this._colormapTexture=m$1(e,r),void(this._colormap=r)):void 0:(this._colormapTexture=m$1(e,r),void(this._colormap=r)):(this._colormapTexture=u(this._colormapTexture),void(this._colormap=null))}}const u$1=e=>{let t=class extends e{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.tileInfo=null}get fullExtent(){return this._getfullExtent()}get timeExtent(){var e;return E(this.layer,null==(e=this.view)?void 0:e.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){return I(this.layer.fullExtent,this.view.spatialReference,!0)}supportsSpatialReference(e){return!!R(this.layer.serviceRasterInfo,e)}async fetchPopupFeaturesAtLocation(e,t){var r;const{layer:i}=this;if(!e)throw new x("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:i});const{popupEnabled:s}=i,a=b(i,t);if(!s||null==a)return[];const n=[],{value:o,magdirValue:u,processedValue:h}=await i.identify(e,{timeExtent:this.timeExtent,signal:null==t?void 0:t.signal});let d="";if(null==o?void 0:o.length){d="imagery-tile"===i.type&&i.hasStandardTime()&&null!=o[0]?o.map((e=>i.getStandardTimeValue(e))).join(", "):o.join(", ");const e={ObjectId:0},t="Raster.ServicePixelValue";e[t]="imagery-tile"===i.type&&"Function"===i.raster.datasetFormat?null==h?void 0:h.join(", "):d,e[t+".Raw"]=d;const s=(null==(r=i.raster)?void 0:r.rasterInfo)??i.serviceRasterInfo,a=null==s?void 0:s.attributeTable;if(null!=a){const{fields:r,features:i}=a,s=r.find((({name:e})=>"value"===e.toLowerCase())),n=e[t],o=s?i.find((e=>String(e.attributes[s.name])===n)):null;if(o)for(const t in o.attributes)o.attributes.hasOwnProperty(t)&&(e[this._rasterFieldPrefix+t]=o.attributes[t])}const y=null==s?void 0:s.dataType;"vector-magdir"!==y&&"vector-uv"!==y||(e["Raster.Magnitude"]=null==u?void 0:u[0],e["Raster.Direction"]=null==u?void 0:u[1]);const g=new T({geometry:this.fullExtent.clone(),attributes:e,layer:i,sourceLayer:i});n.push(g)}return n}_getfullExtent(){return R(this.layer.serviceRasterInfo,this.view.spatialReference)}};return d([y()],t.prototype,"fullExtent",null),d([y()],t.prototype,"layer",void 0),d([y({readOnly:!0})],t.prototype,"timeExtent",null),d([y()],t.prototype,"view",void 0),d([y()],t.prototype,"tileInfo",void 0),d([y({readOnly:!0})],t.prototype,"hasTilingEffects",null),d([y()],t.prototype,"datumTransformation",null),t=d([g("esri.views.layers.ImageryTileLayerView")],t),t};let C=class extends(u$1(P(z(G(S))))){constructor(){super(...arguments),this.type="imagery-tile-3d",this._isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage(),null==this.fullExtent&&this.addResolvingPromise(Promise.reject(new x("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const e=v((()=>{var e,t;return null==(t=null==(e=this.view)?void 0:e.basemapTerrain)?void 0:t.tilingSchemeLocked})).then((()=>{const e=this.view.basemapTerrain.tilingScheme,t=this.layer.tileInfo;this._isAlignedMapTile=["png","png24","png32","jpg","mixed"].includes(t.format)&&e.compatibleWith(t),this.tileInfo=this._isAlignedMapTile?t:e.toTileInfo(),this._updatingHandles.add((()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent]),(()=>this.refresh()))}));this.addResolvingPromise(e)}destroy(){this.layer.decreaseRasterJobHandlerUsage()}get _blankTile(){const e=document.createElement("canvas"),t=e.getContext("2d"),[r,i]=this.tileInfo.size;return e.width=r,e.height=i,t.clearRect(0,0,r,i),t.getImageData(0,0,r,i)}get imageFormatIsOpaque(){return"jpg"===this.layer.tileInfo.format}get hasMixedImageFormats(){return"mixed"===this.layer.tileInfo.format}get dataLevelRange(){var e,t;const r=this.layer.tileInfo,i=null==(e=this.tileInfo.lodAt(0))?void 0:e.scale,s=null==(t=this.layer.tileInfo.lodAt(r.lods.length-1))?void 0:t.scale;return this.levelRangeFromScaleRange(i,s)}_getfullExtent(){var e;return R(this.layer.serviceRasterInfo,(null==(e=this.view.basemapTerrain)?void 0:e.spatialReference)??this.view.spatialReference)}async fetchTile(e,t){const r=this.tileInfo,i=this._canSymbolizeInWebGL(),s={tileInfo:r,requestRawData:i,signal:t.signal,timeExtent:this.timeExtent,requestAsImageElement:this._isAlignedMapTile,noClip:!1},{layer:a}=this,[n,o,u]=e,h=await a.fetchTile(n,o,u,s);if(h instanceof HTMLImageElement)return h;let d=null==h?void 0:h.pixelBlock;if(null==d)return this._blankTile;if(!i&&(d=await a.applyRenderer(h),null==d))return this._blankTile;const y=new m([n,o,u],d,r.size[0],r.size[1]);return i?(y.symbolizerRenderer=a.symbolizer.rendererJSON,y.symbolizerParameters=a.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(n)),y.transformGrid=h.transformGrid,y.bandIds=a.bandIds):(y.isRendereredSource=!0,y.bandIds=null),y.interpolation=a.interpolation,y}_getSymbolizerOptions(e){var t;const r=this.tileInfo.lodAt(e).resolution;return{pixelBlock:null,isGCS:null!=(null==(t=this.view.basemapTerrain)?void 0:t.spatialReference)?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:r,y:r},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(e){this._canSymbolizeInWebGL()&&JSON.stringify(e.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(e.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e.lij[0])))}createFetchPopupFeaturesQueryGeometry(e,t){return O(e,t,this.view)}refresh(){this.emit("data-changed")}async doRefresh(){this.suspended||this.emit("data-changed")}_canSymbolizeInWebGL(){var e,t,r;const i=w(),{symbolizer:s}=this.layer,a=null==(t=null==(e=s.lookup)?void 0:e.colormapLut)?void 0:t.indexedColormap,n=!!(null==(r=this.layer.rasterFunction)?void 0:r.hasClipFunction),o=a&&a.length>4*(i.maxTextureSize||4906);return s.canRenderInWebGL&&!o&&!n}};d([y({readOnly:!0})],C.prototype,"_blankTile",null),d([y({readOnly:!0})],C.prototype,"imageFormatIsOpaque",null),d([y({readOnly:!0})],C.prototype,"hasMixedImageFormats",null),d([y({readOnly:!0})],C.prototype,"dataLevelRange",null),C=d([g("esri.views.3d.layers.ImageryTileLayerView3D")],C);const F=C;export{F as default};
