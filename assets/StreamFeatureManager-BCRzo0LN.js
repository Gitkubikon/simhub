import{aM as e}from"./index-DSIPxOWi.js";class t{constructor(e){this.size=0,this._start=0,this.maxSize=e,this._buffer=new Array(e)}get entries(){return this._buffer}enqueue(e){if(this.size===this.maxSize){const s=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,s}return this._buffer[(this._start+this.size++)%this.maxSize]=e,null}dequeue(){if(0===this.size)return null;const e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}peek(){return 0===this.size?null:this._buffer[this._start]}peekLast(){return 0===this.size?null:this._buffer[(this._start+(this.size-1))%this.maxSize]}find(e){if(0===this.size)return null;for(const s of this._buffer)if(null!=s&&e(s))return s;return null}clear(e){let s=this.dequeue();for(;null!=s;)e&&e(s),s=this.dequeue()}}const s="__esri_timestamp__";class o{constructor(e,s,i,r,h=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=i,this._purgeOptions=r,this.store=e,this.objectIdField=s,this.purgeInterval=h,this._useGeneratedIds="__esri_stream_id__"===this.objectIdField}removeById(e){this._removed.push(e)}removeByTrackId(e){const s=this._trackIdToObservations.get(e);if(s)for(const i of s.entries)this._removed.push(i)}add(s){var i;if(this._useGeneratedIds){const e=this._nextId();s.attributes[this.objectIdField]=e,s.objectId=e}else s.objectId=s.attributes[this.objectIdField];const r=s.objectId;if(this._addOrUpdated.set(r,s),this._maxAge=Math.max(this._maxAge,s.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return null==this._trackIdLessObservations&&(this._trackIdLessObservations=new t(1e5)),void this._trackIdLessObservations.enqueue(r);const h=s.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(h)){const s=null!=(null==(i=this._purgeOptions)?void 0:i.maxObservations)?this._purgeOptions.maxObservations:1e3,r=e(s,0,1e3);this._trackIdToObservations.set(h,new t(r))}const n=this._trackIdToObservations.get(h),a=null==n?void 0:n.enqueue(r);null!=a&&(this._addOrUpdated.has(a)?this._addOrUpdated.delete(a):this._removed.push(a))}checkForUpdates(){const e=this._getToAdd(),i=this._getToRemove(),r=performance.now();r-this._lastPurge>=this.purgeInterval&&(this._purge(r),this._lastPurge=r);const h=[];if(null!=i)for(const s of i){const e=this.store.removeById(s);null!=e&&h.push(e)}const n=[];if(null!=e){const h=new Set(i??[]);for(const i of e)h.has(i.objectId)||(i.attributes[s]=r,this.store.add(i),n.push(i))}return!(!n.length&&!(null==h?void 0:h.length)||(this.store.update(n,h),0))}_getToAdd(){if(!this._addOrUpdated.size)return null;const e=new Array(this._addOrUpdated.size);let s=0;return this._addOrUpdated.forEach((i=>e[s++]=i)),this._addOrUpdated.clear(),e}_getToRemove(){const e=this._removed;return this._removed.length?(this._removed=[],e):null}_nextId(){const e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}_purge(e){const s=this._purgeOptions;null!=s&&(this._purgeSomeByDisplayCount(s),this._purgeByAge(s),this._purgeByAgeReceived(e,s),this._purgeTracks())}_purgeSomeByDisplayCount(e){if(!e.displayCount)return;let s=this.store.size;if(s>e.displayCount){if(this._timeInfo.trackIdField)for(const i of this._trackIdToObservations.values())if(s>e.displayCount&&i.size){const e=i.dequeue();this._removed.push(e),s--}if(null!=this._trackIdLessObservations){let i=s-e.displayCount;for(;i-- >0;){const e=this._trackIdLessObservations.dequeue();null!=e&&this._removed.push(e)}}}}_purgeByAge(e){var s;const i=null==(s=this._timeInfo)?void 0:s.startTimeField;if(!e.age||!i)return;const r=60*e.age*1e3,h=this._maxAge-r;this.store.forEach((e=>{e.attributes[i]<h&&this._removed.push(e.objectId)}))}_purgeByAgeReceived(e,i){if(!i.ageReceived)return;const r=e-60*i.ageReceived*1e3;this.store.forEach((e=>{e.attributes[s]<r&&this._removed.push(e.objectId)}))}_purgeTracks(){this._trackIdToObservations.forEach(((e,s)=>{0===e.size&&this._trackIdToObservations.delete(s)}))}}export{o};
