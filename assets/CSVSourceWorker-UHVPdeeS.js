import{fo as e,fh as t,b as i,x as n,W as s,n as r,ej as o,bZ as l,fe as y,aY as F,fg as I,G as _,cM as w,id as x,ie as E,I as T,fq as v,fr as j,fd as S,ei as C}from"./index-DSIPxOWi.js";import{e as O,n as q}from"./date-Do_V47iR.js";import{t as D}from"./json-omtrO2vq.js";import{m as A}from"./FeatureStore-Dpo5Syxq.js";import{$ as V,x as L}from"./QueryEngine-DAD9skS_.js";import{c as Q}from"./number-DXNV0RYc.js";import{i as G,o as M}from"./clientSideDefaults-Cn_svm8L.js";import"./BoundsStore-BQ0MOdb7.js";import"./PooledRBush-DOZnXWx2.js";import"./quickselect-D9ta8ndX.js";import"./optimizedFeatureQueryEngineAdapter--U1rvwBV.js";import"./normalizeUtils-BrH-PrZy.js";import"./normalizeUtilsCommon-BU8xfl77.js";import"./WhereClause-DYd7Xwn9.js";import"./TimeOnly-C5lZbbIX.js";import"./QueryEngineCapabilities-CTDe3LlQ.js";import"./utils-B-uQJqPz.js";import"./utils-DEUXBrCj.js";import"./utils-1_4Re7um.js";import"./ClassBreaksDefinition-Dt1HCCB7.js";const B=/^\s*"([\S\s]*)"\s*$/,Y=/""/g,Z="\n",J=[","," ",";","|","\t"];function*u(e,t,i){let n=0;for(;n<=e.length;){const s=e.indexOf(t,n),r=e.substring(n,s>-1?s:void 0);n+=r.length+t.length,i&&!r.trim()||(yield r)}}function c(e){const t=e.includes("\r\n")?"\r\n":Z;return u(e,t,!0)}function d(e,t){return u(e,t,!1)}function*a(e,t,i,n=()=>Object.create(null)){const s=c(e);s.next();let r="",o="",l=0,y=n(),F=0;e:for(const I of s){const e=d(I,i);for(const s of e)if(r+=o+s,o="",l+=p(s),l%2==0){if(l>0){const e=B.exec(r);if(!e){y=n(),F=0,r="",l=0;continue e}y[t[F]]=e[1].replaceAll(Y,'"'),F++}else y[t[F]]=r,F++;r="",l=0}else o=i;0===l?(yield y,y=n(),F=0):o=Z}}function g(t,i){const n=m(t,i).filter((e=>null!=e)),s=n.map((t=>e(t)));for(let e=s.length-1;e>=0;e--)s[e]||(s.splice(e,1),n.splice(e,1));return{names:s,aliases:n}}function m(e,t){if(!(null==e?void 0:e.length))return[];const i=[];let n="",s="",r=0;const o=d(e,t);for(const l of o)if(n+=s+l,s="",r+=p(l),r%2==0){if(r>0){const e=B.exec(n);e&&i.push(e[1].replaceAll(Y,'"'))}else i.push(n);n="",r=0}else s=t;return i}function p(e){let t=0,i=0;for(i=e.indexOf('"',i);i>=0;)t++,i=e.indexOf('"',i+1);return t}function h(t,i,n){var s,r;i=null==(s=e(i))?void 0:s.toLowerCase(),n=null==(r=e(n))?void 0:r.toLowerCase();const o=t.map((e=>e.toLowerCase())),l=i?t[o.indexOf(i)]:null,y=n?t[o.indexOf(n)]:null;return{longitudeFieldName:l||t[o.indexOf(W.find((e=>o.includes(e))))],latitudeFieldName:y||t[o.indexOf(z.find((e=>o.includes(e))))]}}function N(e){if(!e.length)return"string";const t=/[^+\-.,0-9]/;return e.map((e=>{if(""!==e){if(!t.test(e)){let t=U(e);if(!isNaN(t))return/[.,]/.test(e)||!Number.isInteger(t)||t>214783647||t<-214783648?"double":"integer";if(e.includes("E")){if(t=Number(e),!Number.isNaN(t))return"double";if(e.includes(",")&&(e=e.replace(",","."),t=Number(e),!Number.isNaN(t)))return"double"}}return O(e)?"date":"string"}})).reduce(((e,t)=>void 0===e?t:void 0===t?e:e===t?t:"string"===e||"string"===t?"string":"double"===e||"double"===t?"double":void 0))}const U=function(){const e=Q(),t=new RegExp("^"+e.regexp+"$"),i=new RegExp("["+e.group+"\\s\\xa0]","g"),n=e.factor;return s=>{const r=t.exec(s);if(e.factor=n,!r)return NaN;let o=r[1];if(!r[1]){if(!r[2])return NaN;o=r[2],e.factor*=-1}return o=o.replace(i,"").replace(e.decimal,"."),+o*e.factor}}(),z=["lat","latitude","latitude83","latdecdeg","lat_dd","y","ycenter","point_y"],W=["lon","lng","long","longitude","longitude83","longdecdeg","long_dd","x","xcenter","point_x"],$=M("esriGeometryPoint"),H=["csv"],K=[0,0];class k{constructor(e,t){this.x=e,this.y=t}}class P{constructor(){this._queryEngine=null,this._snapshotFeatures=async e=>{const t=await this._fetch(e);return this._createFeatures(t)}}destroy(){var e;null==(e=this._queryEngine)||e.destroy(),this._queryEngine=null}async load(e,n={}){var s;this._loadOptions=e;const[r]=await Promise.all([this._fetch(n.signal),this._checkProjection(null==(s=null==e?void 0:e.parsingOptions)?void 0:s.spatialReference)]),o=function R(e,n){var s,r,o;const l=n.parsingOptions||{},I={delimiter:l.delimiter,layerDefinition:null,locationInfo:{latitudeFieldName:l.latitudeField,longitudeFieldName:l.longitudeField}},_=I.layerDefinition={name:C(n.url,H)||"csv",dateFieldsTimeReference:{timeZoneIANA:F},drawingInfo:$,geometryType:"esriGeometryPoint",objectIdField:null,fields:[],timeInfo:l.timeInfo,extent:{xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,ymax:Number.NEGATIVE_INFINITY,spatialReference:l.spatialReference||{wkid:4326}}},w=c(e),x=null==(s=w.next().value)?void 0:s.trim(),E=null==(r=w.next().value)?void 0:r.trim();if(!x)throw new i("csv-layer:empty-csv","CSV is empty",{csv:e});const{delimiter:T,locationInfo:v}=function f(e,t,i){e=e.trim(),t=null==t?void 0:t.trim();const n=[],s=Array.from(new Set([null==i?void 0:i.delimiter,...J])).filter((e=>null!=e));for(const o of s){const i=m(e,o).length,s=m(t,o).length??i;i>1&&n.push({weight:Math.min(i,s),delimiter:o})}const r=n.sort((({weight:e},{weight:t})=>t-e)).map((({delimiter:e})=>e));for(const o of r){const t=h(g(e,o).names,null==i?void 0:i.longitudeField,null==i?void 0:i.latitudeField);if(t.longitudeFieldName&&t.latitudeFieldName)return{delimiter:o,locationInfo:t}}return{delimiter:r[0],locationInfo:null}}(x,E,l);if(!T)throw new i("csv-layer:invalid-delimiter","Unable to detect the delimiter from CSV",{firstLine:x,secondLine:E,parsingOptions:l});if(!v)throw new i("csv-layer:location-fields-not-found","Unable to identify latitude and longitude fields from the CSV file",{firstLine:x,secondLine:E,parsingOptions:l});I.locationInfo=v,I.delimiter=T;const{names:j,aliases:S}=g(x,T),O=function b(e,i,n,s,r){const o=[],l=a(e,n,i),y=[];for(const t of l){if(10===y.length)break;y.push(t)}for(let F=0;F<n.length;F++){const e=n[F],i=s[F];if(e===r.longitudeFieldName||e===r.latitudeFieldName)o.push({name:e,type:"esriFieldTypeDouble",alias:i});else{let n;switch(N(y.map((t=>t[e])))){case"integer":n="esriFieldTypeInteger";break;case"double":n="esriFieldTypeDouble";break;case"date":n="esriFieldTypeDate";break;default:n="esriFieldTypeString"}o.push({name:e,type:n,alias:i,length:t(n)})}}return o}(e,I.delimiter,j,S,I.locationInfo);if(null==(o=l.fields)?void 0:o.length){const e=new y(l.fields);for(const t of O){const i=e.get(t.name);i&&Object.assign(t,i)}}if(!O.some((e=>"esriFieldTypeOID"===e.type&&(_.objectIdField=e.name,!0)))){const e={name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,nullable:!1};_.objectIdField=e.name,O.unshift(e)}_.fields=O;const q=new y(_.fields);if(I.locationInfo&&(I.locationInfo.latitudeFieldName=q.get(I.locationInfo.latitudeFieldName).name,I.locationInfo.longitudeFieldName=q.get(I.locationInfo.longitudeFieldName).name),_.timeInfo){const e=_.timeInfo;if(e.startTimeField){const t=q.get(e.startTimeField);t?(e.startTimeField=t.name,t.type="esriFieldTypeDate"):e.startTimeField=null}if(e.endTimeField){const t=q.get(e.endTimeField);t?(e.endTimeField=t.name,t.type="esriFieldTypeDate"):e.endTimeField=null}if(e.trackIdField){const t=q.get(e.trackIdField);e.trackIdField=t?t.name:null}e.startTimeField||e.endTimeField||(_.timeInfo=null)}return I}(r,e);this._locationInfo=o.locationInfo,this._delimiter=o.delimiter,this._queryEngine=this._createQueryEngine(o);const l=await this._createFeatures(r);this._queryEngine.featureStore.addMany(l);const{fullExtent:I,timeExtent:_}=await this._queryEngine.fetchRecomputedExtents();if(o.layerDefinition.extent=I,_){const{start:e,end:t}=_;o.layerDefinition.timeInfo.timeExtent=[e,t]}return o}async applyEdits(){throw new i("csv-layer:editing-not-supported","applyEdits() is not supported on CSVLayer")}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForSnapping(e,t.signal)}async refresh(e){var t;this._loadOptions.customParameters=e,null==(t=this._snapshotTask)||t.abort(),this._snapshotTask=n(this._snapshotFeatures),this._snapshotTask.promise.then((e=>{this._queryEngine.featureStore.clear(),e&&this._queryEngine.featureStore.addMany(e)}),(e=>{this._queryEngine.featureStore.clear(),s(e)||r.getLogger("esri.layers.CSVLayer").error(new i("csv-layer:refresh","An error occurred during refresh",{error:e}))})),await this._waitSnapshotComplete();const{fullExtent:o,timeExtent:l}=await this._queryEngine.fetchRecomputedExtents();return{extent:o,timeExtent:l}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _fetch(e){const{url:t,customParameters:n}=this._loadOptions;if(!t)throw new i("csv-layer:invalid-source","url not defined");const s=o(t);return(await l(s.path,{query:{...s.query,...n},responseType:"text",signal:e})).data}_createQueryEngine(e){const{objectIdField:t,fields:i,extent:n,timeInfo:s}=e.layerDefinition,r=new A({geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1});return new V({fieldsIndex:y.fromLayerJSON({fields:i,dateFieldsTimeReference:{timeZoneIANA:F}}),geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1,timeInfo:s,objectIdField:t,spatialReference:n.spatialReference||{wkid:4326},cacheSpatialQueries:!0,featureStore:r})}async _createFeatures(e){const{latitudeFieldName:t,longitudeFieldName:i}=this._locationInfo,{objectIdField:n,fieldsIndex:s,spatialReference:r}=this._queryEngine;let o=[];const l=[],y=s.fields.filter((e=>e.name!==n)).map((e=>e.name));let F=0;const S={};for(const _ of s.fields)if("esriFieldTypeOID"!==_.type&&"esriFieldTypeGlobalID"!==_.type){const e=I(_);void 0!==e&&(S[_.name]=e)}const C=a(e,y,this._delimiter,G(S,n));for(const I of C){const e=this._parseCoordinateValue(I[t]),r=this._parseCoordinateValue(I[i]);if(null!=r&&null!=e&&!isNaN(e)&&!isNaN(r)){I[t]=e,I[i]=r;for(const e in I)if(e!==t&&e!==i)if(s.isDateField(e))I[e]=q(I[e]);else if(s.isNumericField(e)){const t=U(I[e]);isNaN(t)?I[e]=null:I[e]=t}I[n]=F,F++,o.push(new k(r,e)),l.push(I)}}if(!_({wkid:4326},r))if(w(r))for(const I of o)[I.x,I.y]=x(I.x,I.y,K);else o=E(D,o,T.WGS84,r,null,null);const O=[];for(let I=0;I<o.length;I++){const{x:e,y:t}=o[I],i=l[I];i[n]=I+1,O.push(new v(new j([],[e,t]),i,null,i[n]))}return O}_parseCoordinateValue(e){if(null==e||""===e)return null;let t=U(e);return(isNaN(t)||Math.abs(t)>181)&&(t=parseFloat(e)),t}async _checkProjection(e){try{await L(S,e)}catch{throw new i("csv-layer:projection-not-supported","Projection not supported")}}}export{P as default};
