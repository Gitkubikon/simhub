import{a5 as e,a6 as t,r as i,P as r,a7 as s,u as l,n,a2 as a,a8 as o,a9 as d,v as u,aa as h,e as p,y,w as c,ab as g,a as m}from"./index-DSIPxOWi.js";import{s as v}from"./ReactiveSet-XbWJTkHf.js";import{O as _}from"./WhereClause-DYd7Xwn9.js";import{o as f}from"./floorFilterUtils-2NbRkqHK.js";import{A as j,u as F,n as b}from"./I3SMeshView3D-DvgHMyu_.js";import{l as w}from"./LayerView3D-ApO6iJqK.js";import{a as S,i as I,u as E,d as O,f as x,b as H,w as C}from"./SceneLayerView-DRJlFU-M.js";import{P as Q,d as V,h as q,o as D}from"./I3SQueryFeatureStore-BUMvs8o8.js";import{o as A}from"./I3SNode-mlgend4K.js";import{G as L}from"./I3SOverrides-CXcxzPSI.js";import{u as R,t as U}from"./TemporalSceneLayerView-BafFz-f2.js";import{i as P}from"./PopupSceneLayerView-Cv6_Wug9.js";import"./TimeOnly-C5lZbbIX.js";import"./Transform-A6X0mfYo.js";import"./RenderTexture-DbJC7CTU.js";import"./SceneModification-yCQPZUfb.js";import"./persistable-Bz3xp-b5.js";import"./resourceExtension-BScMZjEL.js";import"./Graphics3DObjectStates-B77mD6jz.js";import"./optimizedFeatureQueryEngineAdapter--U1rvwBV.js";import"./PooledRBush-DOZnXWx2.js";import"./quickselect-D9ta8ndX.js";import"./WorkerHandle-Bq2affGI.js";import"./SceneLayerWorker-B2gy9gVB.js";import"./HeatmapDensity.glsl-jGaN0eX9.js";import"./timeSupport-CU-EQyfu.js";import"./projectExtentUtils-KG39_WUt.js";import"./dehydratedFeatureComparison-dI04k89u.js";import"./queryForSymbologySnapping-CEKgwdf_.js";import"./hash-BjBdcEEU.js";import"./QueryEngine-DAD9skS_.js";import"./normalizeUtils-BrH-PrZy.js";import"./normalizeUtilsCommon-BU8xfl77.js";import"./json-omtrO2vq.js";import"./QueryEngineCapabilities-CTDe3LlQ.js";import"./utils-B-uQJqPz.js";import"./utils-DEUXBrCj.js";import"./utils-1_4Re7um.js";import"./ClassBreaksDefinition-Dt1HCCB7.js";import"./FeatureStore-Dpo5Syxq.js";import"./BoundsStore-BQ0MOdb7.js";import"./makeScheduleFunction-Cc-EjyuG.js";import"./LayerView-DMoB2q_T.js";import"./meshFeatureSet-BNHS2qnT.js";import"./Mesh-BS04vQSz.js";import"./MeshTransform-Y0ppddED.js";import"./vertexSpaceConversion-C_GU75pR.js";import"./External-Djr0rIk9.js";import"./infoFor3D-BTCPmnmy.js";import"./FeatureLayerView3D-C33G2_Ur.js";import"./FeatureLayerViewBase3D-BxcSlUqN.js";import"./query-C2USZ63O.js";import"./pbfQueryUtils-DUjEbwA9.js";import"./pbf-B53Txr8m.js";import"./EventedSet-D3TBRYG7.js";import"./RefreshableLayerView-MYyyoaX8.js";const G=H();let T=class extends(j(R(U(P(w(C)))))){constructor(){super(...arguments),this.type="scene-layer-3d",this._setVisibilityHiddenObjectIds=new v,this.progressiveLoadFactor=1,this._elevationContext="scene",this._isIntegratedMesh=!1,this._supportsLabeling=!0,this._pendingEditsQueue=Promise.resolve(),this._interactiveEditingSessions=new Map,this._queryEngine=null}get i3slayer(){return this.layer}tryRecycleWith(t,i){return t.url===this.layer.url&&this.i3sOverrides.isEmpty?t.load(i).then((()=>{var i;e(this.layer,t,this.i3sOverrides),this.layer=t,this.i3sOverrides.destroy();const r=null==(i=this.view.resourceController)?void 0:i.memoryController;this.i3sOverrides=new L({view:this.view,layer:t,memoryController:r}),this.resetHighlights()})):null}get layerPopupEnabledAndHasTemplate(){var e;return this.layer.popupEnabled&&t(this.layer,null==(e=this.view.popup)?void 0:e.defaultPopupTemplateEnabled)}get filter(){return this._get("filter")}set filter(e){this._set("filter",Q.checkSupport(e)?e:null)}get viewFilter(){const e=this.mergedFilter,t=this.layerFilter;if(null==e&&null==t)return null;const i=this._get("viewFilter");return null==i?new Q({layerFilter:t,viewFilter:e,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:e=>this._loadAsyncModule(e),addSqlFilter:(e,t)=>this.addSqlFilter(e,t,this.logError),addTimeFilter:(e,t)=>this.addTimeFilter(e,t)}):(i.viewFilter=e,i.layerFilter=t,i)}get requiredFields(){var e;return(null==(e=this._fieldsHelper)?void 0:e.requiredFields)??[]}get _floorFilterClause(){const e=f(this);return null!=e?_.create(e,this.layer.fieldsIndex):null}get _excludeObjectIdsSorted(){const e=this.layer.excludeObjectIds.toArray();return e.length?e.sort(((e,t)=>e-t)):null}get _setVisibilityHiddenObjectIdsSorted(){return this._setVisibilityHiddenObjectIds.size?Array.from(this._setVisibilityHiddenObjectIds).sort(((e,t)=>e-t)):null}get lodFactor(){var e,t,i,r;return(null==(r=null==(i=null==(t=null==(e=this.view)?void 0:e.qualitySettings)?void 0:t.sceneService)?void 0:i.object)?void 0:r.lodFactor)??1}get lodCrossfadeUncoveredDuration(){var e,t;return(null==(t=null==(e=this.view)?void 0:e.qualitySettings)?void 0:t.fadeDuration)??0}get updatingProgressValue(){var e;return(null==(e=this._controller)?void 0:e.updatingProgress)??0}get visibleAtCurrentScale(){return i(this.i3slayer.effectiveScaleRange,this.view.terrainScale)}initialize(){this._fieldsHelper=new S({layerView:this}),this._updatingHandles.add((()=>this.layer.rangeInfos),(e=>this._rangeInfosChanged(e)),r),this._updatingHandles.add((()=>this.layer.renderer),(e=>this._updatingHandles.addPromise(this._rendererChange(e))),r);const e2=()=>this._filterChange();this._updatingHandles.add((()=>this.parsedDefinitionExpression),e2),this._updatingHandles.add((()=>this.mergedFilter),e2),this._updatingHandles.add((()=>this._floorFilterClause),e2),this._updatingHandles.add((()=>this._excludeObjectIdsSorted),e2),this._updatingHandles.add((()=>this._setVisibilityHiddenObjectIdsSorted),e2),this._updatingHandles.add((()=>{var e;return null==(e=this.viewFilter)?void 0:e.sortedObjectIds}),e2),this._updatingHandles.add((()=>{var e;return null==(e=this.viewFilter)?void 0:e.parsedWhereClause}),e2),this._updatingHandles.add((()=>this.getTimeFilterDependencies()),e2),this._updatingHandles.add((()=>{var e,t,i;return[null==(e=this.viewFilter)?void 0:e.parsedGeometry,null==(t=this.mergedFilter)?void 0:t.spatialRelationship,null==(i=this.layer.filter)?void 0:i.spatialRelationship]}),(()=>this._geometryFilterChange())),s()&&this.i3sOverrides.is3DOFL&&this._updatingHandles.add((()=>this.i3sOverrides.sortedGeometryChangedObjectIds),e2),this.addHandles(this.layer.on("apply-edits",(e=>this._updatingHandles.addPromise(e.result)))),this.addHandles(this.layer.on("edits",(e=>{const t=this._pendingEditsQueue.then((()=>this._handleEdits(e))).then();this._pendingEditsQueue=t,this._updatingHandles.addPromise(t)})))}destroy(){this._fieldsHelper=l(this._fieldsHelper)}_rangeInfosChanged(e){null!=e&&e.length>0&&n.getLogger(this).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}createQuery(){var e;const t={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return(null==(e=this.mergedFilter)?void 0:e.createQuery(t))??new a(t)}queryExtent(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),null==t?void 0:t.signal)}queryFeatureCount(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),null==t?void 0:t.signal)}queryFeatures(e,t){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),null==t?void 0:t.signal).then((e=>{if(!(null==e?void 0:e.features))return e;const t=this.layer;for(const i of e.features)i.layer=t,i.sourceLayer=t;return e}))}queryObjectIds(e,t){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),null==t?void 0:t.signal)}_ensureQueryEngine(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine}_createQueryEngine(){const e=F(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new V({layerView:this,priority:o.FEATURE_QUERY_ENGINE,spatialIndex:new q({featureAdapter:new D({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo??[],getFeatureExtent:e}),forAllFeatures:(e,t)=>this._forAllFeatures(((t,i,r)=>e({id:t,index:i,meta:r})),t,b.QUERYABLE),getFeatureExtent:e,sourceSpatialReference:d(this.layer),viewSpatialReference:this.view.spatialReference})})}highlight(e){const t=this._highlights;if(e instanceof a){const{set:i,handle:r}=t.acquireSet();return this.queryObjectIds(e).then((e=>t.setFeatureIds(i,e))),r}return super.highlight(e)}createInteractiveEditSession(e){return I(this._attributeEditingContext,e)}_createLayerGraphic(e){return new u({attributes:e,layer:this.layer,sourceLayer:this.layer})}getFilters(){const e=super.getFilters();s()&&this.i3sOverrides.is3DOFL&&this.i3sOverrides.sortedGeometryChangedObjectIds.length>0&&e.push(((e,t)=>{t.node.index>=0&&h(this.i3sOverrides.sortedGeometryChangedObjectIds,!1,e)}));const t=this._setVisibilityHiddenObjectIdsSorted;null!=t&&e.push((e=>h(t,!1,e)));const i=this._excludeObjectIdsSorted;return null!=i&&e.push((e=>h(i,!1,e))),this._floorFilterClause&&this.addSqlFilter(e,this._floorFilterClause,this.logError),this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),null!=this.viewFilter&&this.viewFilter.addFilters(e,this.view,this._controller.crsIndex,this._collection),e}setVisibility(e,t){t?this._setVisibilityHiddenObjectIds.delete(e):this._setVisibilityHiddenObjectIds.add(e)}isUpdating(){return super.isUpdating()||this.layerFilterUpdating||null!=this.viewFilter&&this.viewFilter.updating||null!=this.i3sOverrides&&this.i3sOverrides.updating}_ensureQuery(e){return this._addDefinitionExpressionToQuery(null==e?this.createQuery():a.from(e))}get _attributeEditingContext(){return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),globalIdField:this._getGlobalIdField(),forEachNode:e=>this._forAllNodes((t=>null!=t?e(t.node,t.featureIds):null)),attributeStorageInfo:this.i3slayer.attributeStorageInfo??[],i3sOverrides:this.i3sOverrides,getAttributeData:e=>this.getAttributeData(e),setAttributeData:(e,t)=>this.setAttributeData(e,t),clearMemCache:()=>this.clearMemCache()}}async _handleEdits(e){const t=s(),i=this._attributeEditingContext,r=await E(i,e);t&&O(i,r),x(i,r)}get hasGeometryFilter(){const e=this.viewFilter;return null!=(null==e?void 0:e.parsedGeometry)}computeNodeFiltering(e){const t=this.viewFilter;return null==t||!this.view.spatialReference||t.isMBSGeometryVisible(e,this.view.spatialReference,this._controller.crsIndex)?A.Unmodified:A.Culled}};p([y()],T.prototype,"i3slayer",null),p([y(c)],T.prototype,"updatingProgress",void 0),p([y({type:g})],T.prototype,"filter",null),p([y({readOnly:!0})],T.prototype,"viewFilter",null),p([y(G.requiredFields)],T.prototype,"requiredFields",null),p([y(G.availableFields)],T.prototype,"availableFields",void 0),p([y()],T.prototype,"_fieldsHelper",void 0),p([y()],T.prototype,"_floorFilterClause",null),p([y()],T.prototype,"_excludeObjectIdsSorted",null),p([y()],T.prototype,"_setVisibilityHiddenObjectIds",void 0),p([y()],T.prototype,"_setVisibilityHiddenObjectIdsSorted",null),p([y()],T.prototype,"lodFactor",null),p([y()],T.prototype,"updatingProgressValue",null),p([y({readOnly:!0})],T.prototype,"visibleAtCurrentScale",null),T=p([m("esri.views.3d.layers.SceneLayerView3D")],T);const M=T;export{M as default};
