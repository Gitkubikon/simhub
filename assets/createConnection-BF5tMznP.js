const __vite__fileDeps=["assets/index-DSIPxOWi.js","assets/index-B_7YxLDX.css"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{bc as e,b as t,e as s,y as n,a as i,ib as a,fz as c,n as u,i8 as l,eX as h,bZ as g,gM as f,_ as y,a2 as _,I as p}from"./index-DSIPxOWi.js";import{c as m}from"./query-C2USZ63O.js";import"./normalizeUtils-BrH-PrZy.js";import"./normalizeUtilsCommon-BU8xfl77.js";import"./pbfQueryUtils-DUjEbwA9.js";import"./pbf-B53Txr8m.js";let w=class extends e.EventedAccessor{destroy(){this.emit("destroy")}get connectionError(){return this.errorString?new t("stream-connection",this.errorString):null}onFeature(e){this.emit("data-received",e)}onMessage(e){this.emit("message-received",e)}};s([n({readOnly:!0})],w.prototype,"connectionError",null),w=s([i("esri.layers.support.StreamConnection")],w);const S=w;var b,k;(k=b||(b={}))[k.CONNECTING=0]="CONNECTING",k[k.OPEN=1]="OPEN",k[k.CLOSING=2]="CLOSING",k[k.CLOSED=3]="CLOSED";let v=class d extends S{constructor(e){super({}),this._outstandingMessages=[],this.errorString=null;const{geometryType:t,spatialReference:s,sourceSpatialReference:n}=e;this._config=e,this._featureZScaler=a(t,n,s),this._open()}normalizeCtorArgs(){return{}}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){super.destroy(),null!=this._websocket&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(null==this._websocket)return"disconnected";switch(this._websocket.readyState){case b.CONNECTING:case b.OPEN:return"connected";case b.CLOSING:case b.CLOSED:return"disconnected"}}sendMessageToSocket(e){null!=this._websocket?this._websocket.send(JSON.stringify(e)):this._outstandingMessages.push(e)}sendMessageToClient(e){this._onMessage(e)}updateCustomParameters(e){this._config.customParameters=e,null!=this._websocket&&this._websocket.close()}async _tryCreateWebSocket(e=this._config.source.path,s=1e3,n=0){try{if(this.destroyed)return;const t=c(e,this._config.customParameters??{});this._websocket=await this._createWebSocket(t),this.notifyChange("connectionStatus")}catch(i){const a=s/1e3;return this._config.maxReconnectionAttempts&&n>=this._config.maxReconnectionAttempts?(u.getLogger(this).error(new t("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()):(u.getLogger(this).error(new t("websocket-connection",`Failed to connect. Attempting to reconnect in ${a}s`,i)),await l(s),this._tryCreateWebSocket(e,Math.min(1.5*s,1e3*this._config.maxReconnectionInterval),n+1))}}_setWebSocketJSONParseHandler(e){e.onmessage=e=>{try{const t=JSON.parse(e.data);this._onMessage(t)}catch(s){return void u.getLogger(this).error(new t("websocket-connection","Failed to parse message, invalid JSON",{error:s}))}}}_createWebSocket(e){return new Promise(((t,s)=>{const n=new WebSocket(e);n.onopen=()=>{if(n.onopen=null,this.destroyed)return n.onclose=null,void n.close();n.onclose=e=>this._onClose(e),n.onerror=e=>this._onError(e),this._setWebSocketJSONParseHandler(n),t(n)},n.onclose=e=>{n.onopen=n.onclose=null,s(e)}}))}async _handshake(e=1e4){const s=this._websocket;if(null==s)return;const n=h(),i=s.onmessage,{filter:a,outFields:c,spatialReference:l}=this._config;return n.timeout(e),s.onmessage=e=>{var h;let g=null;try{g=JSON.parse(e.data)}catch(f){}g&&"object"==typeof g||(u.getLogger(this).error(new t("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),n.reject(),this.destroy()),(null==(h=g.spatialReference)?void 0:h.wkid)!==(null==l?void 0:l.wkid)&&(u.getLogger(this).error(new t("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${l.wkid}`,e.data)),n.reject(),this.destroy()),"json"!==g.format&&(u.getLogger(this).error(new t("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),n.reject(),this.destroy()),a&&g.filter!==a&&u.getLogger(this).error(new t("websocket-connection","Tried to set filter, but server doesn't support it")),c&&g.outFields!==c&&u.getLogger(this).error(new t("websocket-connection","Tried to set outFields, but server doesn't support it")),s.onmessage=i;for(const t of this._outstandingMessages)s.send(JSON.stringify(t));this._outstandingMessages=[],n.resolve()},s.send(JSON.stringify({filter:a,outFields:c,format:"json",spatialReference:{wkid:l.wkid}})),n.promise}_onMessage(e){if(this.onMessage(e),"type"in e)switch(e.type){case"features":case"featureResult":for(const t of e.features)null!=this._featureZScaler&&this._featureZScaler(t.geometry),this.onFeature(t)}}_onError(e){const t="Encountered an error over WebSocket connection";this._set("errorString",t),u.getLogger(this).error("websocket-connection",t)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&u.getLogger(this).error("websocket-connection",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};s([n()],v.prototype,"connectionStatus",null),s([n()],v.prototype,"errorString",void 0),v=s([i("esri.layers.graphics.sources.connections.WebSocketConnection")],v);const F={maxQueryDepth:5,maxRecordCountFactor:3};let C=class extends v{constructor(e){super({...F,...e}),this._buddyServicesQuery=null,this._relatedFeatures=null}async _open(){const e=await this._fetchServiceDefinition(this._config.source);e.timeInfo.trackIdField||u.getLogger(this).warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const t=this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),await this._buddyServicesQuery,await this._tryCreateWebSocket(t);const{filter:s,outFields:n}=this._config;this.destroyed||this._setFilter(s,n)}_onMessage(e){if("attributes"in e){let n;try{n=this._enrich(e),null!=this._featureZScaler&&this._featureZScaler(n.geometry)}catch(s){return void u.getLogger(this).error(new t("geoevent-connection","Failed to parse message",s))}this.onFeature(n)}else this.onMessage(e)}async _fetchServiceDefinition(e){const t={f:"json",...this._config.customParameters},s=g(e.path,{query:t,responseType:"json"}),n=(await s).data;return this._serviceDefinition=n,n}_fetchWebSocketUrl(e,t){const s=e[0],{urls:n,token:i}=s,a=this._inferWebSocketBaseUrl(n);return c(`${a}/subscribe`,{outSR:""+t.wkid,token:i})}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(t.includes("wss"))return t;return u.getLogger(this).error(new t("geoevent-connection","Unable to infer WebSocket url",e)),null}async _setFilter(e,s){const n=this._websocket;if(null==n||null==e&&null==s)return;const i=JSON.stringify({filter:this._serializeFilter(e,s)});let a=!1;const c=h();return n.onmessage=e=>{const s=JSON.parse(e.data);s.filter&&(s.error&&(u.getLogger(this).error(new t("geoevent-connection","Failed to set service filter",s.error)),this._set("errorString",`Could not set service filter - ${s.error}`),c.reject(s.error)),this._setWebSocketJSONParseHandler(n),a=!0,c.resolve())},n.send(i),setTimeout((()=>{a||(this.destroyed||this._websocket!==n||u.getLogger(this).error(new t("geoevent-connection","Server timed out when setting filter")),c.reject())}),1e4),c.promise}_serializeFilter(e,s){const n={};if(null==e&&null==s)return n;if(null==e?void 0:e.geometry)try{const s=f(e.geometry);if("extent"!==s.type)throw new t(`Expected extent but found type ${s.type}`);n.geometry=JSON.stringify(s.shiftCentralMeridian())}catch(i){u.getLogger(this).error(new t("geoevent-connection","Encountered an error when setting connection geometryDefinition",i))}return(null==e?void 0:e.where)&&"1 = 1"!==e.where&&"1=1"!==e.where&&(n.where=e.where),null!=s&&(n.outFields=s.join(",")),n}_enrich(e){if(!this._relatedFeatures)return e;const s=this._serviceDefinition.relatedFeatures.joinField,n=e.attributes[s],i=this._relatedFeatures.get(n);if(!i)return u.getLogger(this).warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:a,geometry:c}=i;for(const t in a)e.attributes[t]=a[t];return c&&(e.geometry=c),e.geometry||e.centroid||u.getLogger(this).error(new t("geoevent-connection","Found malformed feature - no geometry found",e)),e}async _queryBuddyServices(){try{const{relatedFeatures:e,keepLatestArchive:t}=this._serviceDefinition,s=this._queryRelatedFeatures(e),n=this._queryArchive(t);await s;const i=await n;if(!i)return;for(const a of i.features)this.onFeature(this._enrich(a))}catch(k){u.getLogger(this).error(new t("geoevent-connection","Encountered an error when querying buddy services",{error:k}))}}async _queryRelatedFeatures(e){if(!e)return;const t=await this._queryBuddy(e.featuresUrl);this._addRelatedFeatures(t)}async _queryArchive(e){if(e)return this._queryBuddy(e.featuresUrl)}async _queryBuddy(e){var t;const s=new((await y((async()=>{const{default:e}=await import("./index-DSIPxOWi.js").then((e=>e.yI));return{default:e}}),__vite__mapDeps([0,1]))).default)({url:e}),{capabilities:n}=await s.load(),i=n.query.supportsMaxRecordCountFactor,a=n.query.supportsPagination,c=n.query.supportsCentroid,u=this._config.maxRecordCountFactor,l=s.capabilities.query.maxRecordCount,h=i?l*u:l,g=new _;if(g.outFields=this._config.outFields??["*"],g.where=(null==(t=this._config.filter)?void 0:t.where)??"1=1",g.returnGeometry=!0,g.returnExceededLimitFeatures=!0,g.outSpatialReference=p.fromJSON(this._config.spatialReference),c&&(g.returnCentroid=!0),i&&(g.maxRecordCountFactor=u),a)return g.num=h,s.destroy(),this._queryPages(e,g);const f=await m(e,g,this._config.sourceSpatialReference);return s.destroy(),f.data}async _queryPages(e,t,s=[],n=0){t.start=null!=t.num?n*t.num:null;const{data:i}=await m(e,t,this._config.sourceSpatialReference);return i.exceededTransferLimit&&n<(this._config.maxQueryDepth??0)?(i.features.forEach((e=>s.push(e))),this._queryPages(e,t,s,n+1)):(s.forEach((e=>i.features.push(e))),i)}_addRelatedFeatures(e){const t=new Map,s=e.features,n=this._serviceDefinition.relatedFeatures.joinField;for(const i of s){const e=i.attributes[n];t.set(e,i)}this._relatedFeatures=t}};C=s([i("esri.layers.graphics.sources.connections.GeoEventConnection")],C);const R=C;let L=class extends S{constructor(e){super({}),this.connectionStatus="connected",this.errorString=null;const{geometryType:t,spatialReference:s,sourceSpatialReference:n}=e;this._featureZScaler=a(t,n,s)}normalizeCtorArgs(){return{}}updateCustomParameters(e){}sendMessageToSocket(e){}sendMessageToClient(e){if("type"in e)switch(e.type){case"features":case"featureResult":for(const t of e.features)null!=this._featureZScaler&&this._featureZScaler(t.geometry),this.onFeature(t)}this.onMessage(e)}};function o(e,t){if(null==e&&null==t)return null;const s={};return null!=t&&(s.geometry=t),null!=e&&(s.where=e),s}function r(e,t,s,n,i,a,c,u,l){const h={source:e,sourceSpatialReference:t,spatialReference:s,geometryType:n,filter:o(i,a),maxReconnectionAttempts:c,maxReconnectionInterval:u,customParameters:l};return e?e.path.startsWith("wss://")||e.path.startsWith("ws://")?new v(h):new R(h):new L(h)}s([n()],L.prototype,"connectionStatus",void 0),s([n()],L.prototype,"errorString",void 0),L=s([i("esri.layers.support.ClientSideConnection")],L);export{r as createConnection};
