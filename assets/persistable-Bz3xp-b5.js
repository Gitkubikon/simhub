import{bs as e,bt as t,bu as r,bv as o,bw as s,bx as n,by as i,bz as u,bA as l,bB as c,bC as a,b as p,bD as d,bE as f,bF as m,bG as v,bH as y,bI as g}from"./index-DSIPxOWi.js";import{p as h}from"./resourceExtension-BScMZjEL.js";function j(a){const p=(null==a?void 0:a.origins)??[void 0];return(d,f)=>{const m=function U(e,a,p){if("resource"===(null==e?void 0:e.type))return function w(e,a,p){const d=t(a,p);return{type:String,read:(e,t,o)=>{const s=r(e,t,o);return d.type===String?s:"function"==typeof d.type?new d.type({url:s}):void 0},write:{writer(t,r,a,f){if(!(null==f?void 0:f.resources))return"string"==typeof t?void(r[a]=o(t,f)):void(r[a]=t.write({},f));const m=function x(e){return null==e?null:"string"==typeof e?e:e.url}(t),v=o(m,{...f,verifyItemRelativeUrls:(null==f?void 0:f.verifyItemRelativeUrls)?{writtenUrls:f.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},s.NO),g=d.type!==String&&(!n(this)||(null==f?void 0:f.origin)&&this.originIdOf(p)>i(f.origin)),A={object:this,propertyName:p,value:t,targetUrl:v,dest:r,targetPropertyName:a,context:f,params:e};(null==f?void 0:f.portalItem)&&v&&!u(v)?g&&(null==e?void 0:e.contentAddressed)?I(A):g?function N(e){const{context:t,targetUrl:r,params:o,value:s,dest:n,targetPropertyName:i}=e;if(!t.portalItem)return;const u=t.portalItem.resourceFromPath(r),l=S(s,r,t),c=h(l),a=y(u.path),p=(null==o?void 0:o.compress)??!1;c===a?(t.resources&&b({...e,resource:u,content:l,compress:p,updates:t.resources.toUpdate}),n[i]=r):I(e)}(A):function P({context:e,targetUrl:t,dest:r,targetPropertyName:o}){e.portalItem&&e.resources&&(e.resources.toKeep.push({resource:e.portalItem.resourceFromPath(t),compress:!1}),r[o]=t)}(A):(null==f?void 0:f.portalItem)&&(null==v||null!=l(v)||c(v)||g)?I(A):r[a]=v}}}}(e,a,p);switch((null==e?void 0:e.type)??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:e,write:t}=g;return{read:e,write:t}}}}(a,d,f);for(const t of p){const r=e(d,t,f);for(const e in m)r[e]=m[e]}}}function I(e){var t;const{targetUrl:r,params:o,value:s,context:n,dest:i,targetPropertyName:u}=e;if(!n.portalItem)return;const l=a(r),y=S(s,r,n);if((null==o?void 0:o.contentAddressed)&&"json"!==y.type)return void(null==(t=n.messages)||t.push(new p("persistable:contentAddressingUnsupported",`Property "${u}" is trying to serializing a resource with content of type ${y.type} with content addressing. Content addressing is only supported for json resources.`,{content:y})));const g=(null==o?void 0:o.contentAddressed)&&"json"===y.type?d(y.jsonString):(null==l?void 0:l.filename)??f(),A=m((null==o?void 0:o.prefix)??(null==l?void 0:l.prefix),g),R=`${A}.${h(y)}`;if((null==o?void 0:o.contentAddressed)&&n.resources&&"json"===y.type){const e=n.resources.toKeep.find((({resource:e})=>e.path===R))??n.resources.toAdd.find((({resource:e})=>e.path===R));if(e)return void(i[u]=e.resource.itemRelativeUrl)}const $=n.portalItem.resourceFromPath(R);c(r)&&n.resources&&n.resources.pendingOperations.push(v(r).then((e=>{$.path=`${A}.${h({type:"blob",blob:e})}`,i[u]=$.itemRelativeUrl})).catch((()=>{})));const F=(null==o?void 0:o.compress)??!1;n.resources&&b({...e,resource:$,content:y,compress:F,updates:n.resources.toAdd}),i[u]=$.itemRelativeUrl}function b({object:e,propertyName:t,updates:r,resource:o,content:s,compress:n}){r.push({resource:o,content:s,compress:n,finish:r=>{!function O(e,t,r){"string"==typeof e[t]?e[t]=r.url:e[t].url=r.url}(e,t,r)}})}function S(e,t,r){return"string"==typeof e?{type:"url",url:t}:{type:"json",jsonString:JSON.stringify(e.toJSON(r))}}export{j};
