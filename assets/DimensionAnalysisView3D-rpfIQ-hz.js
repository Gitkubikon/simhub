import{qK as e,qL as t,qM as i,mb as a,Q as s,du as o,e3 as l,qN as d,mY as c,ee as u,cy as m,gi as h,L as v,dB as _,p1 as y,e8 as S,N as w,bV as P,hM as C,qO as T,on as A,qt as x,ec as H,hP as R,e as k,y as L,a as j,S as U,pR as F,lc as q,g as Z,A as ee,aI as te,n as ne,ak as ie,oi as ae,oI as se,pg as oe,ol as re,dQ as le,dC as de,oN as ce,ql as ue,P as pe,qP as me,c5 as he,aO as ge,dL as fe,qQ as ve,dt as ye,ci as Se,O as we,dJ as be,dO as xe,bM as Ve,aw as je,dz as We,dx as Ye,cx as Xe,mW as tt,ea as nt,dW as it,eb as at,dy as st,ge as ot,ke as rt,h as lt,n0 as dt,i as ct,u as ut,p as pt,pO as mt,h6 as ht,a0 as gt,pZ as ft,hS as vt,mR as _t,e9 as yt,qR as St,kq as Mt,kr as wt,qS as Pt,m$ as Ct,qT as bt,qU as Ot,V as Dt,z as Tt}from"./index-DSIPxOWi.js";import{s as At}from"./AnalysisView3D-CNsY6W7Z.js";import{t as xt,r as Ht,u as Rt}from"./LengthDimension-CqUogCKq.js";import{e as zt,g as kt}from"./TextOverlayItem-BcN_gvXw.js";import{m as Et,f as Vt}from"./Segment-ByPzCwlk.js";import{m as Lt,d as Gt,p as jt,f as It,e as Ut,R as $t}from"./SnappingOperation-CpAicAwN.js";import{i as Ft}from"./geodesicLengthMeasurementUtils-Pq-FipkN.js";import{e as Bt,d as Nt,c as qt,i as Kt,p as Qt,O as Wt,k as Jt,h as Yt,a as Zt,w as Xt}from"./ShadedColorMaterial.glsl-C-XXTK_B.js";import{z as en,O as tn,q as nn}from"./dragEventPipeline3D-C-8mYpU2.js";import{g as an}from"./ImageMaterial.glsl-V3C9c4TG.js";import{t as sn}from"./memoize-Dzy0sPL8.js";import{l as on}from"./Factory-CfOltYNW.js";import{f as rn,a as ln}from"./LineVisualElement-EjMrPPob.js";import{E as dn,p as cn,P as un}from"./EditGeometryOperations-sseMUvB1.js";import{c as pn,N as mn}from"./SnappingManagerPool-BslN_FM5.js";import{o as hn,a as gn,v as fn,l as vn}from"./analysisViewUtils-9rYF9O9W.js";import{p as _n}from"./keybindings-DkkJsHdp.js";import{t as yn}from"./ToolIntersector-ChuFIaMQ.js";import{r as Sn,t as Mn}from"./vec4f32-APunXZaC.js";import{r as wn,t as Pn}from"./projectionUtils-B1mpMSec.js";import"./unitFormatUtils-B9MPZ1wj.js";import"./ExtendedLineVisualElement-C_fk7Jva.js";import"./EngineVisualElement-Cxk2Aaf7.js";import"./Laserlines.glsl-C_dc6leb.js";import"./PointVisualElement-kTFgcxXB.js";import"./RightAngleQuadVisualElement-CPtUkCyd.js";import"./PointSnappingHint-Ct-FTQTL.js";import"./dehydratedFeatureComparison-dI04k89u.js";import"./geometryEngine-Bp1TD6MM.js";import"./geometryEngineBase-9EI9fooq.js";import"./hydrated-DE1HcVsK.js";import"./geometry2dUtils-4c9qUvJ6.js";import"./floorFilterUtils-2NbRkqHK.js";function z(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,dimension:{offset:a,measureType:s,orientation:o}}=e;return{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,offset:a,measureType:s,orientation:o}}function C$1({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:i,measureType:a,orientation:l},d,c=null){if(null==e||null==t)return null;const u=V((null==c?void 0:c.directSegment)??new Et,{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t},d),m=(null==c?void 0:c.primaryOffsetAxis)??s();B(m,{measureType:a,elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,directSegment:u,orientation:l,renderCoordsHelper:d});const h=(null==c?void 0:c.dimensionSegment)??new Et;return G({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t})&&a===xt.Vertical?(o(h.startRenderSpace,u.startRenderSpace),o(h.endRenderSpace,u.endRenderSpace)):Y(h,{offsetAxis:m,offset:i,relativeToSegment:u,renderCoordsHelper:d}),{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,directSegment:u,dimensionSegment:h,primaryOffsetAxis:m,spatialReference:d.spatialReference}}function U$1(e,t,i,a){return t===Cn.Start?(o(e.startRenderSpace,i.startRenderSpace),o(e.endRenderSpace,a.startRenderSpace)):(o(e.startRenderSpace,i.endRenderSpace),o(e.endRenderSpace,a.endRenderSpace)),e}var Cn,bn;function k$1(e,t,i,a){switch(t){case xt.Direct:return V(e,i,a);case xt.Horizontal:case xt.Vertical:{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:o,dimension:d,geometry:c}=i;let u;d.measureType===xt.Direct?(u=function D$1(e,t){const i=e.directSegment.eval(.5,l.get()),a=t.worldUpAtPosition(i,l.get()),s=e.dimensionSegment.eval(.5,l.get()),o=h(l.get(),s,i);return!y(o,S)&&_(o,a)>0}(c,a)===s.z>o.z,t===xt.Horizontal&&(u=!u)):u=!function O$1(e){const{startRenderSpace:t,endRenderSpace:i}=e.dimensionSegment,{startRenderSpace:a,endRenderSpace:s}=e.directSegment;return x(a,t)<x(s,i)}(c);const[m,v]=u?[s,o]:[o,s],w=A(v,On);return t===xt.Horizontal?w.z=m.z:(w.x=m.x,w.y=m.y),a.toRenderCoords(m,e.startRenderSpace),a.toRenderCoords(w,e.endRenderSpace),e}}}function V(e,t,i){return i.toRenderCoords(t.elevationAlignedStartPoint,e.startRenderSpace),i.toRenderCoords(t.elevationAlignedEndPoint,e.endRenderSpace),e}(bn=Cn||(Cn={}))[bn.Start=0]="Start",bn[bn.End=1]="End";const On=H(0,0,0,null);const Dn=new Et;function B(e,t){const{measureType:i,elevationAlignedStartPoint:a,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:P,endRenderSpace:C},directSegment:T,renderCoordsHelper:A}=t,x=T.eval(.5,l.get()),H=A.worldUpAtPosition(x,l.get()),R=A.worldBasisAtPosition(x,d.Y,l.get());switch(i){case xt.Horizontal:o(e,H);break;case xt.Vertical:_(P,H)<_(C,H)?h(e,C,P):h(e,P,C),v(e,e,H),v(e,e,H);break;case xt.Direct:{const i=t.orientation??0;if(G({elevationAlignedStartPoint:a,elevationAlignedEndPoint:s}))c(Tn,-u(i),H),m(e,R,Tn);else{const t=h(l.get(),C,P),a=v(l.get(),t,H);v(a,a,t),c(Tn,u(i),t),m(e,a,Tn)}break}}return y(e,S)?o(e,R):w(e,e)}const Tn=P();function G({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}){return null!=e&&null!=t&&e.x===t.x&&e.y===t.y}function Y(e,t){const{offsetAxis:i,offset:a,relativeToSegment:{startRenderSpace:s,endRenderSpace:o},relativeToSegment:l,renderCoordsHelper:d}=t,c=a/d.unitInMeters,[u,m]=function J(e,t,i,a=0){const s=_(t,i),o=_(e,i),l=Math.abs(s-o)+a;return s>o?[l,a]:[a,l]}(s,o,i,c);return C(e.startRenderSpace,l.startRenderSpace,i,u),C(e.endRenderSpace,l.endRenderSpace,i,m),e}function K(e,t,i){const a=t.directSegment.eval(.5,l.get());return i.worldUpAtPosition(a,e)}function N(e,t){const{startRenderSpace:i,endRenderSpace:a}=t.directSegment;return h(e,a,i)}function Q(e,t,i={invert:!1}){const{startRenderSpace:a,endRenderSpace:s}=t.dimensionSegment;return i.invert?h(e,a,s):h(e,s,a)}function W(e,t){const i=e.directSegment.eval(.5,l.get());return t.headingAtPosition(i,e.primaryOffsetAxis)}const An=s();function $(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i}=e;if(null==t||null==i)return!1;const s=T(t,i);return null!=s&&a(s,"meters").value>Ft}function _$1(e){return null!=e.geometry}let xn=class g extends U{constructor(e){super(e)}initialize(){const e=F((()=>this.analysisViewData.computations),(({computation:e})=>this._watchComputation(e)));this.addHandles(q(e))}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return zt(this.view)}_watchComputation(s){return Z((()=>z(s)),(o=>{const{measureType:l}=o;if($(o)&&l!==xt.Direct){const e=Math.round(te(Ft,"meters","kilometers"));return ne.getLogger(this).warnOnce(`A ${l} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${e} km. Update the measureType of the affected dimension to "direct" to display it.`),void(s.geometry=null)}const d=C$1(o,this.view.renderCoordsHelper,s.geometry);s.geometry=d,s.result.length=function w$2(s,o,l){if(null==s)return null;let d;if(o===xt.Horizontal)d=Lt(s.elevationAlignedStartPoint,s.elevationAlignedEndPoint);else{const{startRenderSpace:t,endRenderSpace:i}=s.dimensionSegment;d=e(t,i,s.spatialReference)}if(null==d)return null;const c=o===xt.Vertical?t(d.value,d.unit,l):i(d.value,d.unit,l);return a(d,c)}(d,l,this._defaultUnit)}),ee)}};function n$1(e){return ae(e.accentColor,.5)}k([L({constructOnly:!0})],xn.prototype,"analysisViewData",void 0),k([L({constructOnly:!0})],xn.prototype,"view",void 0),k([L()],xn.prototype,"analysis",null),k([L()],xn.prototype,"_defaultUnit",null),xn=k([j("esri.views.3d.analysis.Dimension.DimensionController")],xn);const Hn=new ie([127,127,127,.5]),Rn=6,zn=5;class He{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find((t=>this.hasOwnProperty(t)&&e===this[t]))}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const t of Ht)e(this.manipulatorForMeasureType(t),t)}manipulatorForMeasureType(e){switch(e){case xt.Direct:return this.direct;case xt.Horizontal:return this.horizontal;case xt.Vertical:return this.vertical}}}class Me extends Bt{constructor(e,t){const i=Nt(ie.toUnitRGBA(n$1(e.effectiveTheme))),a=[new qt(re(i,1,32,32),Gn)];super({view:e,renderObjects:a,metadata:t.metadata,available:!1,grabCursor:"crosshair",radius:5,collisionPriority:1}),this._themeHandle=Z((()=>({color:ie.toUnitRGBA(n$1(e.effectiveTheme))})),(e=>i.setParameters(e)))}destroy(){this._themeHandle.remove(),super.destroy()}}class Ce extends Bt{constructor(e,{lineSizePt:t,material:i,metadata:a}){super({view:e,autoScaleRenderObjects:!1,collisionPriority:1,metadata:a}),this._options={calloutColor:ue(),lineSizePt:t,material:i},this._themeHandle=Z((()=>ie.toUnitRGBA(n$1(e.effectiveTheme))),(e=>{this._options.calloutColor=e,et(this,Te({...this._options,metadata:this.metadata}))}),pe)}update({lineSizePt:e,material:t}){this._options.lineSizePt=e,this._options.material=t,et(this,Te({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function Te({calloutColor:e,lineSizePt:t,material:i,metadata:a}){return{calloutLength:.25*me*.8*he(t)+18,calloutColor:e,calloutWidth:2,customStateMask:Gn,discScale:.3,focusMultiplier:2,material:i,metadata:a}}function Ae(e,{computation:t,view:i}){return[Qt(e,((e,a,s)=>{_e({cancel:s,computation:t,settingHeading:!1,steps:a,view:i})})),e.events.on("immediate-click",(e=>{!function De(e,t,i){const{dimension:a,geometry:s}=t;if(90===a.orientation||270===a.orientation)return a.orientation=0,void e.stopPropagation();if(null==s)return;const{renderCoordsHelper:o}=i,l=C$1({...z(t),orientation:90},o),d=C$1({...z(t),orientation:270},o);if(null==l||null==d)return;const c=W(l,o),u=W(d,o),m=Ee(s,i),h=ge.shortestSignedDiff(m,c),v=ge.shortestSignedDiff(m,u);a.orientation=Math.abs(h)<Math.abs(v)?90:270,e.stopPropagation()}(e,t,i)}))]}function _e(e){const{cancel:t,computation:i,settingHeading:a,steps:d,view:c}=e;if(!_$1(i))return;const{renderCoordsHelper:u}=c,{dimension:m,geometry:h}=i,v=s(),_=Je(s(),h,h.directSegment,u),y=Ke(l.get(),{forHeading:a,geometry:h,renderCoordsHelper:u}),S=We(_,y,Ye()),w=a?m.orientation??W(h,c.renderCoordsHelper):m.orientation??0;d.next(tn(c,S)).next((e=>{"start"===e.action&&o(v,e.renderStart);const t=st(S),i=Zt(v,e.renderEnd,_,t);let s=w-ot(i);a||(s=function Fe(e){const t=ge.normalize(e)%90;return t<zn?e-t:90-t<zn?e+(90-t):e}(s)),m.orientation=s})),t.next(Yt(m,["orientation"]))}function Le(e,{computation:t,manipulatorMeasureType:i,view:a}){let s=xt.Direct,d=0,c=0;return[e.events.on("grab-changed",(u=>{if("start"!==u.action||!_$1(t))return;const{dimension:m,geometry:v}=t;s=m.measureType,d=m.offset,c=m.orientation;const y=o(l.get(),e.renderLocation);m.measureType=i,m.offset=function I(e,t,i,a){const{directSegment:s}=i,o=B(l.get(),{measureType:t,directSegment:s,renderCoordsHelper:a}),d=Y(Dn,{offsetAxis:o,offset:0,relativeToSegment:s,renderCoordsHelper:a}).eval(.5,l.get()),c=h(l.get(),e,d);return _(c,o)*a.unitInMeters}(y,i,v,a.renderCoordsHelper),m.orientation=0})),Qt(e,((e,o,u)=>{if(!_$1(t))return;const{geometry:m,dimension:h}=t,{renderCoordsHelper:v}=a,_=k$1($n,i,t,v),y=B(l.get(),{measureType:i,directSegment:m.directSegment,renderCoordsHelper:v}),S=nn(e);o.next(S).next(ke(a,h,_,y)),u.next(S).next((e=>(h.measureType=s,h.offset=d,h.orientation=c,e)))}))]}function ke(e,t,i,a){const s=Xe(l.get(),i.endRenderSpace,i.startRenderSpace);v(s,s,a);const o=We(i.startRenderSpace,s,Ye()),d=We(i.startRenderSpace,a,Ye()),c=t.offset;let u,m=0;const h=new Xt;return h.next(tn(e,o)).next((i=>{"start"===i.action&&(m=tt(d,i.renderStart));const a=(tt(d,i.renderEnd)-m)*e.renderCoordsHelper.unitInMeters;t.offset=c+a,u=i})),e=>(h.execute(e),u)}function Ee(e,t){const{directSegment:i}=e,{renderCoordsHelper:a}=t,s=K(l.get(),e,a),o=N(l.get(),e),d=v(l.get(),o,s),{viewForward:c}=t.state.camera;_(d,c)>0&&de(d,d,-1);const u=i.eval(.5,l.get());return a.headingAtPosition(u,d)}function Ne(e,t,i,{forHeading:a}){const{dimension:s,geometry:o}=t,{primaryOffsetAxis:l}=o,d=de(kn,l,s.offset>=0?1:-1),c=Ke(En,{forHeading:a,geometry:o,renderCoordsHelper:i});v(c,c,d);const u=Wt(d,c,S,Un);e.modelTransform=u,e.renderLocation=Je(jn,o,o.dimensionSegment,i)}const kn=s(),En=s();function Je(e,t,i,a){const{startRenderSpace:s,endRenderSpace:l}=i,d=function Qe(e,t){const i=N(Vn,e),a=K(Ln,e,t);return _(i,a)>0}(t,a)?s:l;return o(e,d)}function Ke(e,{forHeading:t,geometry:i,renderCoordsHelper:a}){return t?K(e,i,a):Q(e,i,{invert:!0})}const Vn=s(),Ln=s();function $e(e){return he(e)+Rn}function et(e,t){var i;const a=t.material??new an({transparent:!0,writeDepth:!1,textureId:null==(i=t.texture)?void 0:i.id,renderOccluded:be.Opaque,isDecoration:!0}),s=t.focusMultiplier??Jt.focusMultiplier,o=t.calloutLength??Jt.calloutLength,l=Jt.discRadius*(t.discScale??1),d=l*s,s2=(e,t)=>{const i=[0,1,2,2,3,0];return new nt(t,[[it.POSITION,new at([o-e,-e,0,o+e,-e,0,o+e,e,0,o-e,e,0],i,3,!0)],[it.UV0,new at([0,0,1,0,1,1,0,1],i,2,!0)]])},c=t.calloutWidth??Jt.calloutWidth,u=new xe({width:c,color:t.calloutColor,renderOccluded:be.OccludeAndTransparent,isDecoration:!0}),m=le(u,[[0,0,0],[o-l,0,0]]),h=le(u,[[0,0,0],[o-d,0,0]]),v=t.customStateMask??oe.None;e.collisionType={type:"disc",direction:[0,0,1],offset:[o,0,0]},e.focusMultiplier=s,e.metadata=t.metadata,e.radius=l,e.renderObjects=[new qt(s2(l,a),ce.Unfocused|v),new qt(m,ce.Unfocused|v),new qt(s2(d,a),ce.Focused|v),new qt(h,ce.Focused|v)]}const Gn=oe.Custom1,jn=s(),In=s(),Un=P(),$n=new Et;var Fn;function S$1(e,t,i){const{constraint:a,elevationAlignedStartPoint:s,elevationAlignedEndPoint:o,unconstrainedGeometry:l,view:d}=i,{dimension:c,previousConstraint:u,preConstraintProperties:m}=e;if(null==s||null==o)return;const p2=()=>{"startPoint"in t?c.startPoint=t.startPoint:"endPoint"in t&&(c.endPoint=t.endPoint)};if(null==a)p2(),null!=u&&null!=m&&(c.measureType=m.measureType,c.orientation=m.orientation);else switch(c.measureType=xt.Direct,a){case Fn.Horizontal:if(a!==u&&(c.orientation=0),"startPoint"in t){const e=t.startPoint;null!=e&&(e.z=o.z),c.startPoint=e}else if("endPoint"in t){const e=t.endPoint;null!=e&&(e.z=s.z),c.endPoint=e}break;case Fn.Vertical:if(a!==u&&(c.orientation=Ee(l,d)),"startPoint"in t){const e=t.startPoint;null!=e&&(e.x=o.x,e.y=o.y),c.startPoint=e}else if("endPoint"in t){const e=t.endPoint;null!=e&&(e.x=s.x,e.y=s.y),c.endPoint=e}break;case Fn.Direct:a!==u&&null!=m&&(c.orientation=m.orientation),p2()}e.previousConstraint=a,e.unconstrainedGeometry=l}!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.Direct=2]="Direct"}(Fn||(Fn={}));let Bn=class extends U{constructor(e){super(e),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new rt,this._orientationManipulatorTexture=null,this._updatingHandles=new lt,this._getSnappingContext=sn((e=>new Ut({elevationInfo:{mode:"absolute-height",offset:0},pointer:e,editGeometryOperations:new dn(new cn("point",un(!0,!1,this.view.spatialReference)),this.view.state.viewingMode),visualizer:new $t})));const{view:t}=e;this._snappingManagerResult=pn(t),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._focusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:dt(2)}),this._constraintSnappingIndicator=new rn({view:t,attached:!0,width:1,renderOccluded:be.OccludeAndTransparent,stipplePattern:dt(5),isDecoration:!0});const i=ie.toUnitRGBA(Hn);this._stagedStartIndicator=new Gt({view:t,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:e.view.renderCoordsHelper.spatialReference,color:i,size:10,outlineSize:0,renderOccluded:be.OccludeAndTransparent,isDecoration:!0})}initialize(){var e;const{view:t}=this;this._snappingOperation=new jt({view:t});const i=!(null==(e=t._stage)?void 0:e.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result);this._orientationManipulatorMaterial=new an({transparent:!0,writeDepth:!1,renderOccluded:be.Opaque,isDecoration:!0}),this.addHandles(Z((()=>{return{accentColor:n$1(t.effectiveTheme),contrastColor:(e=t.effectiveTheme,se(e.accentColor))};var e}),(({accentColor:e,contrastColor:a})=>{const s=this._orientationManipulatorTexture,o=on(t.textures,{accentColor:e,contrastColor:a,preMultiplyAlpha:i});this._orientationManipulatorMaterial.setParameters({textureId:o.texture.id}),this._orientationManipulatorTexture=o,null==s||s.release();const l=ie.toUnitRGBA(e);this._unfocusedOffsetManipulatorMaterial.setParameters({color:l}),this._focusedOffsetManipulatorMaterial.setParameters({color:l}),this._thinOffsetManipulatorMaterial.setParameters({color:l}),this._constraintSnappingIndicator.color=l}),pe));const a=F((()=>this.analysisViewData.computations),(({computation:e})=>this._createManipulators(e)));this.addHandles(q(a)),this.addHandles([Z((()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation})),(({stagedPoint:e,stagedComputation:t})=>{if(null==t||null==e)return;const i=A(e,new je);this._applyPointUpdate(t,{endPoint:i})}),ct),Z((()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator})),((e,t)=>{const{stagedDimension:i,selectedComputation:a,firstGrabbedManipulator:s}=e;if(i===(null==t?void 0:t.stagedDimension)&&s===(null==t?void 0:t.firstGrabbedManipulator)){for(const o of[a,null==t?void 0:t.selectedComputation])if(null!=o){const t=this._computationManipulators.get(o);null!=t&&this._updateManipulators(o,t,e)}}else for(const[o,l]of this._computationManipulators)this._updateManipulators(o,l,e)}),ee),Z((()=>this.analysis.style.lineSize),(e=>{this._updateManipulatorStyle(e)}),pe),Z((()=>this.view.state.camera),(()=>{null!=this._stagedComputation&&this._updateStagedDimensionOffset(this._stagedComputation)})),Z((()=>{const e=this._stagedComputation;if(!e)return null;const t=e.elevationAlignedStartPoint,i=s();return null!=t&&this.view.renderCoordsHelper.toRenderCoords(t,i)?i:null}),(e=>{null!=e?(this._stagedStartIndicator.vertices=[e],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1}))]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),mn(this,(()=>{const e=this._activeComputation,t=this._stagedComputation;if(null==e||null!=t){const e=this.view.inputManager.latestPointerType??"mouse",t=this._getSnappingContext(e);this._updatingHandles.addPromise(ht(this._snappingOperation.snapAgainNearPreviousMapPoint(this._snappingManager,t)))}if(null!=e){const{start:t,end:i}=this._computationManipulators.get(e);if(t.grabbing||i.grabbing){!function g$2(e,t,{constraint:i,view:a}){const{unconstrainedGeometry:s}=e;if(null==s)return;const{renderCoordsHelper:o,spatialReference:l}=a,{startRenderSpace:d,endRenderSpace:c}=s.directSegment,u=o.fromRenderCoords(d,new je({spatialReference:l})),m=o.fromRenderCoords(c,new je({spatialReference:l}));let h;h="start"===t?{startPoint:u}:{endPoint:m},S$1(e,h,{constraint:i,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,unconstrainedGeometry:s,view:a})}(e,t.grabbing?"start":"end",{constraint:this._computeConstraint(e),view:this.view})}}}))}destroy(){var e;this._snappingOperation=ut(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),null==(e=this._orientationManipulatorTexture)||e.release()}get updating(){return this._updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(null!=this._stagedComputation)return this._stagedComputation;const{selectedComputation:e}=this.analysisViewData;return this.hasGrabbedManipulators&&null!=e?e:null}get _stagedComputation(){var e;const t=this._stagedDimension,i=null==(e=this.analysisViewData.computations.at(-1))?void 0:e.computation;return null==t||null==i||i.dimension!==t?null:i}get _constraintHandles(){return[pt((()=>this.analysisViewData.selectedComputation),(e=>{e.previousConstraint=this._computeConstraint(e)}),{...ee,equals:mt}),Z((()=>{const e=this._activeComputation;if(null==e)return null;const{measureType:t,orientation:i}=e.dimension;return{measureType:t,orientation:i,computation:e}}),((e,t)=>{if(null!=e&&null==t){const{measureType:t,orientation:i,computation:a}=e;switch(a.previousConstraint){case Fn.Horizontal:a.preConstraintProperties={measureType:xt.Horizontal,orientation:0};break;case Fn.Vertical:a.preConstraintProperties={measureType:xt.Vertical,orientation:0};break;case Fn.Direct:a.preConstraintProperties={measureType:xt.Direct,orientation:i};break;default:a.preConstraintProperties={measureType:t,orientation:i}}}null==e&&null!=t&&(t.computation.preConstraintProperties=null)}),ct)]}get _snappingIndicatorHandles(){const e="snapping-indicator-event-handles";return[Z((()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation})),(({stagedComputation:t,activeComputation:i})=>{const a=this._constraintSnappingIndicator;if(this.removeHandles(e),null!=i)if(i===t)a.attached=!0;else{const{start:t,end:s}=this._computationManipulators.get(i),s2=()=>{a.attached=t.grabbing||s.grabbing};s2(),this.addHandles([t.events.on("grab-changed",s2),s.events.on("grab-changed",s2)],e)}else a.attached=!1})),Z((()=>{const e=this._activeComputation;return null!=e?{geometry:e.geometry,constraint:e.previousConstraint}:{}}),(({geometry:e,constraint:t})=>{const i=this._constraintSnappingIndicator;null!=e&&null!=t&&t!==Fn.Direct?(i.visible=!0,i.setGeometryFromSegment(e.directSegment)):i.visible=!1}))]}removeStaged(){return null!=this._stagedDimension&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(e){const{_stagedDimension:t}=this;if(null==t){const t=this._onUnstagedClick(e);return this.analysis.dimensions.add(t),null}return this._onStagedClick(e),t}onPointerMove({mapPoint:e,pointerType:t}){if("touch"===t)return;const i=this._getSnappingContext(t);this._updatingHandles.addPromise(ht(this._snappingOperation.snap({point:e},this._snappingManager,i)))}onManipulatorSelectionChanged(){null!=this.analysisViewData.selectedComputation&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:e,pointerType:t}){let i=e;if("mouse"===t){const a=this._getSnappingContext(t);i=this._snappingManager.update({point:e,context:a})}const a=new Rt({startPoint:A(i,new je),endPoint:null,measureType:xt.Horizontal});return this._stagedDimension=a,this._resetSnappingState(),a}_onStagedClick({mapPoint:e,pointerType:t}){const i=this._stagedComputation;if(null==i)return;let a=e;if("mouse"===t){const i=this._getSnappingContext(t);a=this._snappingManager.update({point:e,context:i})}const s=A(a,new je);this._applyPointUpdate(i,{endPoint:s}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_createManipulators(e){const t=this._setupPointManipulator(e,{isStart:!0}),i=this._setupPointManipulator(e,{isStart:!1}),a=this._setupOffsetManipulator(e),s=this._setupHeadingManipulator(e),o=this._setupRotationManipulator(e),l=this._setupMeasureTypeManipulator(e,xt.Direct),d=this._setupMeasureTypeManipulator(e,xt.Horizontal),c=this._setupMeasureTypeManipulator(e,xt.Vertical),u=new He({start:t,end:i,offset:a,heading:s,rotation:o,direct:l,horizontal:d,vertical:c});return this._setupComputationToManipulatorsSync(e,u),this._computationManipulators.set(e,u),this.manipulators.addMany(u.values()),{manipulators:u,remove:()=>{this._computationHandles.remove(e),this._computationManipulators.delete(e);for(const e of u.values())this.manipulators.remove(e)}}}_setupComputationToManipulatorsSync(e,t){this._computationHandles.add([Z((()=>e.geometry),(()=>this._updateManipulators(e,t)),{...ee,equals:mt})],e)}_setupPointManipulator(e,t){const{view:i}=this,{dimension:a}=e,s=new Me(i,{metadata:a}),o=function Ue(e,{isStart:t,createSnappingPipelineStep:i,dimension:a,onUpdate:s,view:o}){const l=t?"startPoint":"endPoint";return[Qt(e,((e,t,d,c)=>{const u=nn(e),{snappingStep:m,cancelSnapping:h}=i(c);d=d.next(u).next(Yt(a,[l,"measureType","orientation"])).next(h),t.next(u).next(en(o)).next(...m).next((e=>{const t=A(e.mapEnd,new je);s("startPoint"===l?{startPoint:t}:{endPoint:t})}))}))]}(s,{isStart:t.isStart,createSnappingPipelineStep:e=>It({snappingContext:this._getSnappingContext(e),snappingManager:this._snappingManager,updatingHandles:this._updatingHandles}),dimension:a,onUpdate:t=>this._applyPointUpdate(e,t),view:i});return this._computationHandles.add(o,e),s}_setupOffsetManipulator(e){const{view:t}=this,i=function Pe(e,t){const i=[Ve(-.5,0,0),Ve(.5,0,0)],a=le(t.unfocusedMaterial,i.map((e=>de(s(),e,.5)))),o=a.instantiate({material:t.focusedMaterial});return new Bt({view:e,renderObjects:[new qt(a,ce.Unfocused|ce.Selected|Gn),new qt(o,ce.Focused|Gn)],collisionType:{type:"line",paths:[i]},radius:$e(t.lineSizePt)/2,metadata:t.metadata,available:!1,...Kt})}(t,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:e.dimension}),a=function Re(e,{computation:t,view:i}){return[Qt(e,((e,a,s)=>{if(!_$1(t)||!e.selected)return;const{geometry:o,dimension:l}=t,d=nn(e);a.next(d).next(ke(i,l,o.dimensionSegment,o.primaryOffsetAxis)),s.next(d).next(Yt(l,["offset"]))}))]}(i,{computation:e,view:t});return this._computationHandles.add(a,e),i}_setupHeadingManipulator(e){const{view:t}=this,i=new Ce(t,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:e.dimension}),a=function ze(e,{computation:t,view:i}){return[Qt(e,((e,a,s)=>{_e({cancel:s,computation:t,settingHeading:!0,steps:a,view:i})}))]}(i,{computation:e,view:t});return this._computationHandles.add(a,e),i}_setupRotationManipulator(e){const{view:t}=this,i=new Ce(t,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:e.dimension}),a=Ae(i,{computation:e,view:t});return this._computationHandles.add(a,e),i}_setupMeasureTypeManipulator(e,t){const{view:i}=this,a=function Oe(e,t){const i=[Ve(-.5,0,0),Ve(.5,0,0)],a=le(t.thinOffsetManipulatorMaterial,i),o=le(t.unfocusedMaterial,i.map((e=>de(s(),e,.5)))),l=o.instantiate({material:t.focusedMaterial});return new Bt({view:e,renderObjects:[new qt(o,ce.Unfocused|Gn),new qt(l,ce.Focused|Gn),new qt(a,Gn)],collisionType:{type:"line",paths:[i]},radius:$e(t.lineSizePt)/2,available:!1,metadata:t.metadata,...Kt})}(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:e.dimension}),o=Le(a,{computation:e,manipulatorMeasureType:t,view:i});return this._computationHandles.add(o,e),a}_updateManipulators(e,t,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:a,selectedComputation:s,firstGrabbedManipulator:o}=i,{start:l,end:d,offset:c,heading:u,rotation:m}=t,v=s===e,_=_$1(e),{dimension:y}=e;for(const h of t.values()){const e=_&&null==a&&(null==o||h===o);h===c?(h.available=e,h.selected=v):h.available=e&&v}if(!_)return;null!=this._computeConstraint(e)?t.forEachMeasureTypeManipulator((e=>e.available=!1)):t.manipulatorForMeasureType(y.measureType).available=!1;for(const h of[u,m])y.measureType===xt.Direct&&0!==y.offset||(h.available=!1);G(e)?m.available=!1:u.available=!1;const{geometry:w}=e;l.renderLocation=w.directSegment.startRenderSpace,d.renderLocation=w.directSegment.endRenderSpace;const{renderCoordsHelper:P}=this.view;(function Ie(e,t,i){const{dimensionSegment:a,primaryOffsetAxis:s}=t,o=Q(jn,t),l=fe(o,S)?ve(Un):Wt(o,s,S,Un),d=Math.max(ye(o),.1/i.unitInMeters);Se(l,l,we(jn,d,d,d)),e.modelTransform=l,e.renderLocation=a.eval(.5,jn)})(c,w,P),u.available&&function Ge(e,t,i){Ne(e,t,i,{forHeading:!0})}(u,e,P),m.available&&function Be(e,t,i){Ne(e,t,i,{forHeading:!1})}(m,e,P),t.forEachMeasureTypeManipulator(((t,i)=>{t.available&&function qe(e,t,i,a){const{geometry:s}=t,o=k$1($n,i,t,a),l=B(jn,{measureType:i,directSegment:s.directSegment,renderCoordsHelper:a}),d=h(In,o.endRenderSpace,o.startRenderSpace),c=Wt(d,l,S,Un),u=ye(d);Se(c,c,we(In,u,u,u)),e.modelTransform=c,e.renderLocation=o.eval(.5,In)}(t,e,i,P)}))}_updateManipulatorStyle(e){const t=function Ze(e){return he(e)+4}(e),i=$e(e),a={lineSizePt:e,material:this._orientationManipulatorMaterial};for(const{offset:s,heading:o,rotation:l}of this._computationManipulators.values())s.radius=i/2,o.update(a),l.update(a);this._unfocusedOffsetManipulatorMaterial.setParameters({width:t}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(e,t){const{view:i}=this,a=z(e);"startPoint"in t&&(a.elevationAlignedStartPoint=t.startPoint),"endPoint"in t&&(a.elevationAlignedEndPoint=t.endPoint);const s=C$1(a,i.renderCoordsHelper);if(null==s)return;const o=this._computeConstraint({...a,geometry:s});S$1(e,t,{...a,constraint:o,unconstrainedGeometry:s,view:i}),e===this._stagedComputation&&this._updateStagedDimensionOffset(e)}_updateStagedDimensionOffset(e){if(null==e.geometry)return;e.geometry.directSegment.eval(.5,Nn);const t=this.view.state.camera.computeScreenPixelSizeAt(Nn);e.dimension.offset=50*t}_computeConstraint(e){return function f(e,t){if($(e))return Fn.Direct;if(!e.enabled)return null;const{geometry:i}=e;if(null==i||fe(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{camera:a}=t.state,s=K(l.get(),i,t.renderCoordsHelper),o=N(l.get(),i),d=de(l.get(),s,_(o,s)),c=Xe(l.get(),o,d),u=R(c),m=R(d),{startRenderSpace:h,endRenderSpace:v}=i.directSegment,y=Math.max(10*a.computeScreenPixelSizeAt(h),10*a.computeScreenPixelSizeAt(v))**2;return u<y?Fn.Vertical:m<y?Fn.Horizontal:null}(function p(e,t){return{enabled:t.effectiveFeatureEnabled,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,geometry:e.geometry}}(e,this._snappingManager.options),this.view)}_createOffsetManipulatorMaterial(){return new xe({width:1,renderOccluded:be.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0,isDecoration:!0})}get testInfo(){}};k([L({constructOnly:!0})],Bn.prototype,"analysis",void 0),k([L({constructOnly:!0})],Bn.prototype,"analysisViewData",void 0),k([L({constructOnly:!0})],Bn.prototype,"manipulators",void 0),k([L({constructOnly:!0})],Bn.prototype,"parentTool",void 0),k([L({constructOnly:!0,nonNullable:!0})],Bn.prototype,"view",void 0),k([L({readOnly:!0})],Bn.prototype,"updating",null),k([L()],Bn.prototype,"firstGrabbedManipulator",null),k([L()],Bn.prototype,"hasGrabbedManipulators",null),k([L()],Bn.prototype,"snappingOptions",null),k([L()],Bn.prototype,"_stagedDimension",void 0),k([L()],Bn.prototype,"_activeComputation",null),k([L()],Bn.prototype,"_stagedComputation",null),Bn=k([j("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],Bn);const Nn=s();var qn;!function(e){e.Ready="ready",e.Creating="creating",e.Created="created"}(qn||(qn={}));let Kn=class extends hn{constructor(e){super(e),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=2500,this._prevPointerMoveTimeout=null}initialize(){this._intersector=yn(this.view.state.viewingMode),this._lengthDimensionSubTool=new Bn({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([q(this._lengthDimensionSubTool),gt((()=>this._clearPointerMoveTimeout())),Z((()=>this.state),(e=>{e===qn.Created&&this.finishToolCreation()}),ee),pt((()=>this.firstGrabbedManipulator),(e=>{this.selectedDimension=e.metadata}),ee),Z((()=>this.selectedDimension),(()=>this._resetPointerMoveTimeout()),ee)])}get state(){return this.analysis.dimensions.some((e=>"length"===e.type))?null!=this._activeSubTool?qn.Creating:qn.Created:qn.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(e){this.analysisViewData.selectedDimension=e}onInputEvent(e){switch(e.type){case"immediate-click":this._clickHandler(e);break;case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":if(_n.cancel===e.key){if(null!=this._activeSubTool&&this._activeSubTool.removeStaged())return void e.stopPropagation();this.active||(this.selectedDimension=null)}else _n.delete.includes(e.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){null!=this._activeSubTool&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(e){if(this.hasFocusedManipulators)return void e.stopPropagation();if(null==this._activeSubTool)return;const t=this._intersectScreen(e);null!=t&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:t,pointerType:e.pointerType}),e.stopPropagation())}_doubleClickHandler(e){this.active&&(this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(this._resetPointerMoveTimeout(),null==this._activeSubTool)return;if(this.hasFocusedManipulators)return;const t=this._intersectScreen(e);null!=t&&this._activeSubTool.onPointerMove({mapPoint:t,pointerType:e.pointerType})}_deleteKeyHandler(){null!=this._activeSubTool&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(e){const t=ft(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector);const i=this._intersector.results.min,a=l.get();return i.getIntersectionPoint(a)?this.view.renderCoordsHelper.fromRenderCoords(a,new je({spatialReference:this.view.spatialReference})):null}_removeSelected(){null!=this.selectedDimension&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=vt(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach((e=>e.manipulator.state|=Gn)),this._prevPointerMoveTimeout=_t.setTimeout((()=>{this.manipulators.forEach((e=>e.manipulator.state&=~Gn))}),this._pointerMoveTimerMs)}get testInfo(){}};k([L({constructOnly:!0})],Kn.prototype,"view",void 0),k([L({constructOnly:!0})],Kn.prototype,"analysis",void 0),k([L({readOnly:!0})],Kn.prototype,"state",null),k([L({readOnly:!0})],Kn.prototype,"updating",null),k([L({readOnly:!0})],Kn.prototype,"cursor",null),k([L({constructOnly:!0})],Kn.prototype,"analysisViewData",void 0),k([L()],Kn.prototype,"selectedDimension",null),k([L()],Kn.prototype,"automaticManipulatorSelection",void 0),k([L()],Kn.prototype,"_activeSubTool",void 0),k([L()],Kn.prototype,"_lengthDimensionSubTool",void 0),Kn=k([j("esri.views.3d.analysis.Dimension.DimensionTool")],Kn);class n extends ln{constructor(e,t){super(e),this._hasExternalMaterial=!1,this._renderOccluded=be.OccludeAndTransparent,this._width=1,this._color=Sn(1,0,1,1),this._placement="end",this._markerPrimitive="arrow",this._material=t,this._hasExternalMaterial=null!=t,this.applyProperties(e)}setGeometryFromSegment(e,t){const i=e.endRenderSpace;this.transform=yt(Qn,i),this._normal=t;const{points:a}=e.createRenderGeometry(i,this.view.renderCoordsHelper);this.geometry=[a]}get renderOccluded(){return null!=this._material?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,null!=this._material&&this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return null!=this._material?this._material.parameters.width:this._width}set width(e){this._width=e,null!=this._material&&this._material.setParameters({width:e})}get color(){return null!=this._material?this._material.parameters.color:this._color}set color(e){this._color=Mn(e),null!=this._material&&this._material.setParameters({color:this._color})}get placement(){return null!=this._material?this._material.parameters.placement:this._placement}set placement(e){this._placement=e,null!=this._material&&this._material.setParameters({placement:this._placement})}get markerPrimitive(){var e;return(null==(e=this._material)?void 0:e.parameters.markerPrimitive)??this._markerPrimitive}set markerPrimitive(e){this._markerPrimitive=e,null!=this._material&&this._material.setParameters({markerPrimitive:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new St({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,markerPrimitive:this._markerPrimitive,isDecoration:this.isDecoration}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const t of Mt(this.geometry,this.normal)){const i=wt(this._material,t);e.addGeometry(i)}}forEachExternalMaterial(e){this._hasExternalMaterial||e(this._material)}}const Qn=P();let Wn=class b{set visible(e){for(const t of this._visualElements.values())t.attached=e}constructor(e){this.destroyed=!1,this._handles=new rt,this._messages=null,this._labelSegment=new Et;const{analysis:t,computation:i,view:a,messages:s,isDecoration:o}=e;this.analysis=t,this.computation=i,this.view=a,this._messages=s;const l=e.visible,d={view:a,attached:l,isDecoration:o},{fontSize:c,textColor:u,textBackgroundColor:m}=t.style;this._visualElements=new E({marker:new n(d,e.markerMaterial),dimension:new rn(d,e.dimensionLineMaterial),startOffset:new rn(d,e.offsetLineMaterial),endOffset:new rn(d,e.offsetLineMaterial),dimensionSmall:new rn(d,e.smallDimensionLineMaterial),startOffsetSmall:new rn(d,e.smallOffsetLineMaterial),endOffsetSmall:new rn(d,e.smallOffsetLineMaterial),label:new Vt({view:a,attached:l,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:he(c),textColor:u.clone(),backgroundColor:m.clone(),isDecoration:o})}),this._handles.add([Z((()=>i.geometry),(e=>{this.updateCameraDependentElements(a.state.camera,e,t.style),null!=i.geometry&&this._updateLines(i.geometry)}),{...pe,equals:mt}),Z((()=>i.length),(e=>this._updateLabelContent(e)),pe)])}destroy(){this.destroyed=!0,this._handles=ut(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){}_updateLines(e){const t=U$1(Jn,Cn.Start,e.directSegment,e.dimensionSegment),i=U$1(Yn,Cn.End,e.directSegment,e.dimensionSegment),a=this._visualElements;a.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),a.dimension.setGeometryFromSegment(e.dimensionSegment),a.startOffset.setGeometryFromSegment(t),a.endOffset.setGeometryFromSegment(i),a.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),a.startOffsetSmall.setGeometryFromSegment(t),a.endOffsetSmall.setGeometryFromSegment(i)}updateCameraDependentElements(e,t,i){const a=this._visualElements;if(null==t){for(const e of a.values())e.visible=!1;return}const s=e.computeScreenPixelSizeAt(t.dimensionSegment.eval(.5,Zn)),o=function X(e,t){return R(Q(An,e))/t**2}(t,s),l=o<(2*he(i.lineSize))**2,d=!l;a.marker.visible=d,a.dimension.visible=d,a.startOffset.visible=d,a.endOffset.visible=d,a.dimensionSmall.visible=l,a.startOffsetSmall.visible=l,a.endOffsetSmall.visible=l;const c=5*he(i.fontSize),{label:u}=a;if(u.visible=o>=c**2,!u.visible)return;const{dimensionSegment:m,primaryOffsetAxis:h}=t,{offset:v}=this.computation.dimension,_=(Math.sign(v)>=0?1:-1)*function O(e){return 1.5*he(e.fontSize)+20+he(e.lineSize/2)}(i)*s;(function M(e,t,i,a){C(e.startRenderSpace,t.startRenderSpace,i,a),C(e.endRenderSpace,t.endRenderSpace,i,a)})(this._labelSegment,m,h,_),u.updateLabelPosition()}updateLabelStyle(e){const{label:t}=this._visualElements;t.fontSize=he(e.fontSize),t.textColor=e.textColor,t.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:t}=this.computation;this._updateLabelContent(t)}_updateLabelContent(e){const{label:t}=this._visualElements;null!=e&&null!=this._messages?t.text=kt(this._messages,e,e.unit):t.text=""}};const Jn=new Et,Yn=new Et,Zn=s();class E{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let Xn=class extends U{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(e){super(e),this.loadingMessages=!1,this._messages=null}initialize(){const e=this.isDecoration;this._markerMaterial=new St({width:1,anchor:Pt.Tip,color:Ct,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:be.OccludeAndTransparent,markerPrimitive:"triangle",isDecoration:e}),this._dimensionLineMaterial=new xe({width:1,color:Ct,renderOccluded:be.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters,isDecoration:e}),this._offsetLineMaterial=new xe({width:1,color:Ct,renderOccluded:be.OccludeAndTransparent,stipplePattern:dt(5),isDecoration:e}),this._smallDimensionLineMaterial=new xe({width:1,color:Ct,renderOccluded:be.OccludeAndTransparent,isDecoration:e}),this._smallOffsetLineMaterial=new xe({width:1,color:Ct,renderOccluded:be.OccludeAndTransparent,stipplePattern:dt(5),isDecoration:e});for(const i of this._lineMaterials())this.view._stage.add(i),this.addHandles(gt((()=>{var e;null==(e=this.view._stage)||e.remove(i)})));const t=F((()=>this.analysisViewData.computations),(({computation:e})=>this._createVisualization(e)));this._dimensionVisualizations=t,this.addHandles([q(t),Z((()=>ie.toUnitRGBA(this.analysis.style.color)),(e=>{for(const t of this._lineMaterials())t.setParameters({color:e})}),ee),Z((()=>this.analysis.style.lineSize),(e=>{const t=he(e);this._markerMaterial.setParameters({width:.8*t}),this._dimensionLineMaterial.setParameters({width:t,markerParameters:this._markerMaterial.parameters});const i=Math.max(.25*t,1);this._offsetLineMaterial.setParameters({width:i})}),ee),Z((()=>({camera:this.view.state.camera,style:D(this.analysis)})),(({camera:e,style:t})=>{for(const{visualization:i}of this._dimensionVisualizations)i.updateCameraDependentElements(e,i.computation.geometry,t),i.updateLabelStyle(t)})),Z((()=>this.visible),(e=>{for(const{visualization:t}of this._dimensionVisualizations)t.visible=e}))]),this.addHandles([bt((()=>this._updateMessageBundle())),pt((()=>!this.loadingMessages),(()=>{for(const{visualization:e}of this._dimensionVisualizations)e.updateUnitsMessages(this._messages)}),ct)]),this._updateMessageBundle()}get testInfo(){}_createVisualization(e){const t=new Wn({analysis:this.analysis,computation:e,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages,isDecoration:this.isDecoration});return{visualization:t,remove:()=>t.destroy()}}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Ot("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function D(e){const{fontSize:t,lineSize:i,textColor:a,textBackgroundColor:s}=e.style;return{fontSize:t,lineSize:i,textBackgroundColor:s.clone(),textColor:a.clone()}}k([L({constructOnly:!0})],Xn.prototype,"analysisViewData",void 0),k([L({constructOnly:!0,nonNullable:!0})],Xn.prototype,"view",void 0),k([L({constructOnly:!0})],Xn.prototype,"isDecoration",void 0),k([L()],Xn.prototype,"analysis",null),k([L()],Xn.prototype,"visible",null),k([L()],Xn.prototype,"loadingMessages",void 0),Xn=k([j("esri.views.3d.analysis.Dimension.DimensionVisualization")],Xn);let ei=class extends U{constructor(e){super(e),this.dimension=null,this.length=null}};k([L({constructOnly:!0,nonNullable:!0})],ei.prototype,"dimension",void 0),k([L()],ei.prototype,"length",void 0),ei=k([j("esri.views.analysis.LengthDimensionResult")],ei);const ti=ei;let ni=class extends U{constructor(e){super(e),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(e){const{dimension:t,...i}=e;return{result:new ti({dimension:t}),...i}}initialize(){this.addHandles([Z((()=>this.dimension.startPoint),(e=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(e)),ee),Z((()=>this.dimension.endPoint),(e=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(e)),ee)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};k([L({constructOnly:!0,nonNullable:!0})],ni.prototype,"result",void 0),k([L({constructOnly:!0,nonNullable:!0})],ni.prototype,"projectAndAlignPoint",void 0),k([L()],ni.prototype,"dimension",null),k([L()],ni.prototype,"length",null),k([L()],ni.prototype,"geometry",void 0),k([L()],ni.prototype,"unconstrainedGeometry",void 0),k([L()],ni.prototype,"elevationAlignedStartPoint",void 0),k([L()],ni.prototype,"elevationAlignedEndPoint",void 0),k([L()],ni.prototype,"preConstraintProperties",void 0),k([L()],ni.prototype,"previousConstraint",void 0),ni=k([j("esri.views.3d.analysis.Dimension.LengthDimensionComputation")],ni);const r=e=>{let t=class extends e{constructor(...e){super(...e),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new Dt}createLengthDimensions(e){throw new Error("Method not implemented.")}};return k([L({constructOnly:!0})],t.prototype,"view",void 0),k([L({constructOnly:!0,nonNullable:!0})],t.prototype,"analysis",void 0),k([L()],t.prototype,"tool",void 0),k([L({readOnly:!0})],t.prototype,"results",null),k([L()],t.prototype,"selectedDimension",void 0),k([L()],t.prototype,"interactive",void 0),k([L()],t.prototype,"visible",void 0),t=k([j("esri.views.analysis.DimensionAnalysisView")],t),t};let ii=class extends(r(At(U))){constructor(e){super(e),this.type="dimension-view-3d",this.tool=null,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=e=>{if(null==e)return null;const{spatialReference:t,elevationProvider:i}=this.view,a=wn(e,t,i);return null==a&&Pn(this.analysis,e.spatialReference,ne.getLogger(this)),a};const e=F((()=>this.analysis.dimensions),(e=>this._createComputation(e)));this.computations=e,this.addHandles([gn(this,Kn),q(e)]),this._analysisVisualization=new Xn({analysisViewData:this,view:this.view,isDecoration:!this.parent}),this._analysisController=new xn({analysisViewData:this,view:this.view})}destroy(){this._placementTask=Tt(this._placementTask),this._analysisVisualization=ut(this._analysisVisualization),fn(this)}get updating(){var e;return(null==(e=this._analysisVisualization)?void 0:e.loadingMessages)??!1}get results(){return this.analysis.dimensions.map((e=>this._dimensionsToComputations.get(e).result))}get selectedComputation(){const{selectedDimension:e}=this;return null==e?null:this._dimensionsToComputations.get(e)}get testInfo(){}async createLengthDimensions(e){return this.selectedDimension=null,this._placementTask=Tt(this._placementTask),this._placementTask=vn(this,e),this._placementTask.promise}_createComputation(e){const{_dimensionsToComputations:t}=this,i=new ni({dimension:e,projectAndAlignPoint:this._projectAndAlignPoint});return t.set(e,i),{computation:i,remove:()=>this._removeComputation(i)}}_removeComputation(e){const{dimension:t}=e;t===this.selectedDimension&&(this.selectedDimension=null),this._dimensionsToComputations.delete(t),e.destroy()}};k([L({readOnly:!0})],ii.prototype,"type",void 0),k([L()],ii.prototype,"tool",void 0),k([L()],ii.prototype,"updating",null),k([L({readOnly:!0})],ii.prototype,"results",null),k([L()],ii.prototype,"computations",void 0),k([L()],ii.prototype,"selectedDimension",void 0),k([L()],ii.prototype,"selectedComputation",null),k([L()],ii.prototype,"_analysisVisualization",void 0),k([L()],ii.prototype,"_analysisController",void 0),k([L()],ii.prototype,"_dimensionsToComputations",void 0),k([L()],ii.prototype,"_placementTask",void 0),ii=k([j("esri.views.3d.analysis.DimensionAnalysisView3D")],ii);const ai=ii;export{ai as default};
