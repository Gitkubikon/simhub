import{dI as n,dl as a,dx as s,aw as r,xi as l,bV as c,Q as _,pg as b,bc as E,dv as T,ki as A,a0 as L,km as P,on as C,xj as I,dD as N,dm as W,ii as k,dq as $,lm as B,hB as V,dz as q,dr as H,cy as X,xk as Z,dR as Y,e3 as Q,dC as J,xl as K,du as ne,e8 as ae,p3 as se,xm as re,tA as oe,kn as le,C as ce,J as he,u as de,dw as ue,pd as _e,q_ as ge,di as fe,oN as me,ko as ve,O as be,cx as ye,xn as Se,ch as Ee,lM as we,xo as Te,xp as Oe,ee as Ae,qQ as xe,cv as Le,xq as Re,wc as Me,w8 as ze,w5 as je,wf as Fe,w7 as De,w9 as Pe,we as Ce,w6 as Ie,xe as Ne,dW as We,xr as ke,wa as Ge,xs as $e,wd as Ue,xt as Be,ql as Ve,wg as qe,_ as He,e as Xe,wi as Ze,lf as Ye,wj as Qe,wk as Je,wl as Ke,xu as et,wm as tt,wn as it,kA as nt,wp as at,wq as st,wr as rt,ws as ot,xv as lt,wx as ct,xw as ht,kz as dt,xx as ut,xy as pt,xg as _t,wH as gt,br as ft,N as mt,xz as vt,xA as bt,pU as yt,lB as St,xB as Et,s2 as wt,xC as Tt,xD as Ot,e7 as At,dJ as xt,mZ as Lt,L as Rt,bU as Mt,sd as zt,nz as jt,ox as Ft,cD as Dt,bn as Pt,d8 as Ct,ds as It,aM as Nt,lZ as Wt,V as kt,y as Gt,a as $t,S as Ut,xE as Bt,eX as Vt}from"./index-DSIPxOWi.js";import{E as qt}from"./EditGeometryOperations-sseMUvB1.js";class ee{constructor(n){var a;this.metadata=void 0,this._camera=new l,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=new Array,this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=c(),this._worldFrame=null,this._renderLocation=_(),this._renderLocationDirty=!0,this._location=new r({x:0,y:0,z:0}),this._elevationAlignedLocation=new r,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.consumesClicks=!0,this.cursor=null,this.grabCursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=b.None,this._focused=!1,this.events=new E.EventEmitter,this._screenLocation={screenPointArray:T(),renderScreenPointArray:A(),pixelSize:0},this._screenLocationDirty=!0,this._engineResourcesAddedToStage=!1,this._attached=!1,this._location.spatialReference=n.view.spatialReference,Object.assign(this,n);const s=null==(a=this.view.state)?void 0:a.camera;s&&this._camera.copyFrom(s)}destroy(){this._applyObjectTransform=pe,this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this._camera=null}get _stage(){var n;return null==(n=this.view)?void 0:n._stage}get elevationInfo(){return this._elevationInfo}set elevationInfo(n){this._elevationInfo=n,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(n){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=n.slice(),this._updateEngineObject()}set available(n){n!==this._available&&(this._available=n,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,1===this._noDisplayCount&&this._updateEngineObject(),L((()=>{this._noDisplayCount--,0===this._noDisplayCount&&this._updateEngineObject()}))}set radius(n){n!==this._radius&&(this._radius=n,this._updateEngineObject())}get radius(){return this._radius}set worldSized(n){n!==this._worldSized&&(this._worldSized=n,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(n){te(n)&&(this._screenLocationDirty=!0),P(this._modelTransform,n),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=c()),function ie(n,a,s){switch(n.viewingMode){case"local":return xe(s),!0;case"global":{const r=we(n.renderCoordsHelper.spatialReference);return Te(a,0,ei,0,r.radius),Oe(Ae(ei[0]),Ae(ei[1]),s),!0}}}(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(n){this.view.renderCoordsHelper.fromRenderCoords(n,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(n){C(n,this._location),this._notifyLocationChanged()}_notifyLocationChanged(){this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(n){C(n,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){const n=null!=this._elevation.override?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y,this._elevationAlignedLocation.z=n+this._elevation.offset,this._elevationAlignedLocation.spatialReference=I(this.location.spatialReference),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(n){n!==this._grabbing&&(this._grabbing=n,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(n){n!==this._hovering&&(this._hovering=n,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(n){n!==this._selected&&(this._selected=n,this._updateEngineObject(),this.events.emit("select-changed",{action:n?"select":"deselect"}))}get state(){return this._state}set state(n){n!==this._state&&(this._state=n,this._updateEngineObject())}updateStateEnabled(n,a){a?this.state|=n:this.state&=~n}_setFocused(n){n!==this._focused&&(this._focused=n,this.events.emit("focus-changed",{action:!0===n?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this._ensureScreenLocation(),this._screenLocation}_ensureScreenLocation(){if(!this._screenLocationDirty)return;let n;if(this._screenLocation.pixelSize=this._camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1,te(this._modelTransform)){const a=this._calculateModelTransformOffset(si);n=N(a,a,this.renderLocation)}else n=this.renderLocation;this._camera.projectToRenderScreen(n,this._screenLocation.renderScreenPointArray),this._camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(n){this._applyObjectTransform=n,this._screenLocationDirty=!0,this._updateEngineObject()}get attached(){return this._attached}intersectionDistance(n,a){if(!this.available)return null;const s=W(n,Ht),r=this._getCollisionRadius(a),l=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(oe(this.screenLocation.screenPointArray,s)<r*r)return this.screenLocation.renderScreenPointArray[2]+l;break;case"line":{const n=this.collisionType.paths,a=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(a,Jt),_=r*this.screenLocation.pixelSize,b=$(this._camera,s,Zt);if(null==b)return null;for(const s of n){if(0===s.length)continue;const n=X(ei,s[0],c);for(let a=1;a<s.length;a++){const r=X(ti,s[a],c),E=re(Y(n,r,Xt),b);if(null!=E&&E<_*_){const a=N(Q.get(),n,r);J(a,a,.5);const s=K(Q.get());return this._camera.projectToRenderScreen(a,s),s[2]+l}ne(n,r)}}break}case"disc":{const n=this.collisionType.direction,a=this.collisionType.offset??ae,c=this._getWorldToScreenObjectScale(),_=this._calculateObjectTransform(c,Jt),b=r*this.screenLocation.pixelSize,E=$(this._camera,s,Zt);if(null==E)return null;const T=B(Yt,_),A=V(ni,n,T),L=X(ai,a,_);q(L,A,Kt);const P=ii;if(H(Kt,E,P)&&se(P,L)<b*b)return this.screenLocation.renderScreenPointArray[2]+l;break}case"ribbon":{const{paths:n,direction:a}=this.collisionType,c=this._getWorldToScreenObjectScale(),_=this._calculateObjectTransform(c,Jt),b=r*this._camera.computeScreenPixelSizeAt(this.renderLocation),E=$(this._camera,s,Zt);if(null==E)return null;const T=B(Yt,_),A=V(ni,a,T),L=this._calculateModelTransformPosition(ai);q(L,A,Kt);const P=ii;if(!H(Kt,E,P))break;for(const s of n){if(0===s.length)continue;const n=X(ei,s[0],_);for(let a=1;a<s.length;a++){const r=X(ti,s[a],_),c=Z(Y(n,r,Xt),P);if(null!=c&&c<b*b){const a=N(Q.get(),n,r);J(a,a,.5);const s=K(Q.get());return this._camera.projectToRenderScreen(a,s),s[2]+l}ne(n,r)}}break}default:k(this.collisionType)}return null}attach(n={manipulator3D:{}}){const a=this._stage;if(!a)return;const s=n.manipulator3D;null==s.engineLayerId?(this._engineLayer=new le(a,{pickable:!1,updatePolicy:ce.SYNC}),s.engineLayerId=this._engineLayer.id):(null==a?void 0:a.getObject)&&(this._engineLayer=a.getObject(s.engineLayerId)),s.engineLayerReferences=(s.engineLayerReferences||0)+1,this._materialIdReferences=s.materialIdReferences,null==this._materialIdReferences&&(this._materialIdReferences=new Map,s.materialIdReferences=this._materialIdReferences),this._camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),he(this._location.spatialReference,this.view.spatialReference)||(this.location=new r({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(n={manipulator3D:{}}){const a=n.manipulator3D;a.engineLayerReferences--;const s=0===a.engineLayerReferences;this._removeResourcesFromStage(),s&&(a.engineLayerId=null,de(this._engineLayer)),this._engineResources=null,this._engineLayer=null,this._materialIdReferences=null,this._attached=!1}onViewChange(){this._camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(n){ue(this.location,ri,n.spatialReference)&&_e(n.extent,ri)&&this._notifyLocationChanged()}_evaluateElevationAlignment(){if(null==this.elevationInfo)return;let n=null,a=0;const s=ge(this.elevationInfo,this.location.spatialReference??this.view.elevationProvider.spatialReference);switch(this.elevationInfo.mode){case"on-the-ground":n=fe(this.view.elevationProvider,this.location,"ground")??0;break;case"relative-to-ground":a=(fe(this.view.elevationProvider,this.location,"ground")??0)+s;break;case"relative-to-scene":a=(fe(this.view.elevationProvider,this.location,"scene")??0)+s;break;case"absolute-height":a=s}return a!==this._elevation.offset||n!==this._elevation.override?(this._elevation.offset=a,void(this._elevation.override=n)):void 0}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const n=this._getWorldToScreenObjectScale(),a=Jt;if(!0===this.autoScaleRenderObjects){const s=this._getFocusedSize(this._radius,this.focused)*n;this._calculateObjectTransform(s,a)}else this._calculateObjectTransform(n,a);const{objectsByState:s}=this._ensureEngineResources(),r=(this.focused?me.Focused:me.Unfocused)|(this.selected?me.Selected:me.Unselected),l=this._noDisplayCount>0;for(const{stateMask:c,objects:_}of s){if(l){for(const n of _)n.visible=!1;continue}const n=(c&me.All)!==me.None,s=(c&b.All)!==b.None,E=!n||(r&c)==(c&me.All),T=!s||(this.state&c)==(c&b.All);if(E&&T)for(const r of _)r.visible=!0,r.transformation=a;else for(const a of _)a.visible=!1}}_ensureEngineResources(){if(null==this._engineResources){const n=this._engineLayer,a=[],s=new Set;this.renderObjects.forEach((({geometry:{material:n}})=>{s.has(n)||(a.push(n),s.add(n))}));const r=new Map;this._renderObjects.forEach((n=>{const a=new ve({castShadow:!1,geometries:[n.geometry]}),s=r.get(n.stateMask)||[];s.push(a),r.set(n.stateMask,s)}));const l=[];r.forEach(((n,a)=>l.push({stateMask:a,objects:n}))),this._engineResources={objectsByState:l,layer:n,materials:a}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){const n=this._stage;if(this._engineResourcesAddedToStage||null==this._engineResources||!n)return;const{objectsByState:a,layer:s,materials:r}=this._engineResources;r.forEach((a=>{const s=this._materialIdReferences,r=s.get(a.id)||0;0===r&&n.add(a),s.set(a.id,r+1)})),a.forEach((({objects:a})=>{s.addMany(a),n.addMany(a)})),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(){const n=this._stage;if(!this._engineResourcesAddedToStage||null==this._engineResources||!n)return;const{objectsByState:a,layer:s,materials:r}=this._engineResources;a.forEach((({objects:a})=>{s.removeMany(a),n.removeMany(a)})),r.forEach((a=>{const s=this._materialIdReferences,r=s.get(a.id);1===r?(n.remove(a),s.delete(a.id)):s.set(a.id,r-1)})),this._engineResourcesAddedToStage=!1}_getCollisionRadius(n){return this._getFocusedSize(this.radius,!0)*("touch"===n?this.touchMultiplier:1)}_getFocusedSize(n,a){return n*(a?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(n){const a=this._getWorldToScreenObjectScale(),s=this._calculateObjectTransform(a,Qt);return be(n,s[12],s[13],s[14])}_calculateModelTransformOffset(n){const a=this._calculateModelTransformPosition(n);return ye(n,a,this.renderLocation)}_calculateObjectTransform(n,a){return Se(a,n,0,0,0,0,n,0,0,0,0,n,0,0,0,0,1),this._worldFrame&&Ee(a,a,this._worldFrame),Ee(a,a,this._modelTransform),a[12]+=this.renderLocation[0],a[13]+=this.renderLocation[1],a[14]+=this.renderLocation[2],a[15]=1,null!=this._applyObjectTransform&&this._applyObjectTransform(a),a}get test(){}}function te(n){return 0!==n[12]||0!==n[13]||0!==n[14]}const Ht=T(),Xt=n(),Zt=a(),Yt=Le(),Qt=c(),Jt=c(),Kt=s(),ei=_(),ti=_(),ii=_(),ni=_(),ai=_(),si=_(),ri=new r({x:0,y:0,z:0,spatialReference:null}),pe=()=>{};function t(n){var a;return null==(a=null==n?void 0:n.operations)?void 0:a.data.geometry}function o(n,a){if(!a.screenSizeEnabled)return;const s=n.vertex;Re(s,a),s.uniforms.add(new Me("perScreenPixelRatio",((n,a)=>a.camera.perScreenPixelRatio)),new Me("screenSizeScale",(n=>n.screenSizeScale))),s.code.add(ze`float computeRenderPixelSizeAt( vec3 pWorld ){
vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
float viewDirectionDistance = abs(dot(viewForward, pWorld - cameraPosition));
return viewDirectionDistance * perScreenPixelRatio;
}
vec3 screenSizeScaling(vec3 position, vec3 anchor){
return position * screenSizeScale * computeRenderPixelSizeAt(anchor) + anchor;
}`)}function u(n){const a=new je,s=n.multipassEnabled&&n.output===Fe.Color;a.include(De,n),a.include(o,n),a.include(Pe,n);const{vertex:r,fragment:l}=a;return l.include(Ce),Ie(r,n),l.uniforms.add(new Ne("uColor",(n=>n.color))),a.attributes.add(We.POSITION,"vec3"),a.varyings.add("vWorldPosition","vec3"),s&&a.varyings.add("depth","float"),n.screenSizeEnabled&&a.attributes.add(We.OFFSET,"vec3"),n.shadingEnabled&&(ke(r),a.attributes.add(We.NORMAL,"vec3"),a.varyings.add("vViewNormal","vec3")),r.code.add(ze`
    void main(void) {
      vWorldPosition = ${n.screenSizeEnabled?"screenSizeScaling(offset, position)":"position"};
  `),n.shadingEnabled&&r.code.add(ze`vec3 worldNormal = normal;
vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;`),r.code.add(ze`
    ${s?"depth = (view * vec4(vWorldPosition, 1.0)).z;":""}
    gl_Position = transformPosition(proj, view, vWorldPosition);
  }
  `),s&&a.include(Ge,n),l.code.add(ze`
    void main() {
      discardBySlice(vWorldPosition);
      ${s?"terrainDepthTest(depth);":""}
    `),n.shadingEnabled?(l.uniforms.add(new $e("shadingDirection",(n=>n.shadingDirection))),l.uniforms.add(new Ne("shadedColor",(n=>function w$3(n,a){const s=1-n[3],r=n[3]+a[3]*s;return 0===r?(oi[3]=r,oi):(oi[0]=(n[0]*n[3]+a[0]*a[3]*s)/r,oi[1]=(n[1]*n[3]+a[1]*a[3]*s)/r,oi[2]=(n[2]*n[3]+a[2]*a[3]*s)/r,oi[3]=a[3],oi)}(n.shadingTint,n.color)))),l.code.add(ze`vec3 viewNormalNorm = normalize(vViewNormal);
float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);
vec4 finalColor = mix(uColor, shadedColor, shadingFactor);`)):l.code.add(ze`vec4 finalColor = uColor;`),n.transparencyPassType===Ue.ColorAlpha&&(a.outputs.add("fragColor","vec4",0),a.outputs.add("fragAlpha","float",1)),l.code.add(ze`
      ${n.output===Fe.ObjectAndLayerIdColor?ze`finalColor.a = 1.0;`:""}
      if (finalColor.a < ${ze.float(Be)}) {
        discard;
      }

      ${n.output===Fe.Color?ze`fragColor = highlightSlice(finalColor, vWorldPosition); ${n.transparencyPassType===Ue.ColorAlpha?ze`
                    fragColor = premultiplyAlpha(fragColor);
                    fragAlpha = fragColor.a;`:""}`:""}
    }
    `),a}const oi=Ve(),li=Object.freeze(Object.defineProperty({__proto__:null,build:u},Symbol.toStringTag,{value:"Module"}));let ci=class j extends Qe{initializeProgram(n){return new Je(n.rctx,j.shader.get().build(this.configuration),di)}_setPipelineState(n){const a=this.configuration,s=n===Ue.NONE,r=n===Ue.FrontFace;return Ke({blending:a.output===Fe.Color&&a.transparent?s?et:tt(n):null,culling:it(a.cullFace),depthTest:{func:r?nt.LESS:a.shadingEnabled?nt.LEQUAL:nt.LESS},depthWrite:s?a.writeDepth?at:null:st(n),drawBuffers:rt(n),colorWrite:ot,polygonOffset:s||r?null:lt})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}};ci.shader=new qe(li,(()=>He((()=>Promise.resolve().then((()=>wi))),void 0)));let hi=class v extends ct{constructor(){super(...arguments),this.output=Fe.Color,this.cullFace=Ye.None,this.transparencyPassType=Ue.NONE,this.hasSlicePlane=!1,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.multipassEnabled=!1,this.cullAboveGround=!1}};Xe([Ze({count:Fe.COUNT})],hi.prototype,"output",void 0),Xe([Ze({count:Ye.COUNT})],hi.prototype,"cullFace",void 0),Xe([Ze({count:Ue.COUNT})],hi.prototype,"transparencyPassType",void 0),Xe([Ze()],hi.prototype,"hasSlicePlane",void 0),Xe([Ze()],hi.prototype,"transparent",void 0),Xe([Ze()],hi.prototype,"writeDepth",void 0),Xe([Ze()],hi.prototype,"screenSizeEnabled",void 0),Xe([Ze()],hi.prototype,"shadingEnabled",void 0),Xe([Ze()],hi.prototype,"multipassEnabled",void 0),Xe([Ze()],hi.prototype,"cullAboveGround",void 0),Xe([Ze({constValue:!1})],hi.prototype,"occlusionPass",void 0);const di=new Map([[We.POSITION,0],[We.NORMAL,1],[We.OFFSET,2]]);let ui=class w extends ht{constructor(n){super(n,new _i),this.supportsEdges=!0,this.produces=new Map([[dt.OPAQUE_MATERIAL,n=>n===Fe.Highlight||ut(n)&&!this._isTransparent],[dt.TRANSPARENT_MATERIAL,n=>ut(n)&&this._isTransparent&&this.parameters.writeDepth],[dt.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,n=>ut(n)&&this._isTransparent&&!this.parameters.writeDepth]]),this._configuration=new hi,this._vertexAttributeLocations=di}getConfiguration(n,a){return this._configuration.output=n,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._isTransparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.screenSizeEnabled=this.parameters.screenSizeEnabled,this._configuration.shadingEnabled=this.parameters.shadingEnabled,this._configuration.transparencyPassType=a.transparencyPassType,this._configuration.multipassEnabled=a.multipassEnabled,this._configuration.cullAboveGround=a.multipassTerrain.cullAboveGround,this._configuration}intersect(n,a,s,r,l,c){if(this.parameters.screenSizeEnabled){const a=n.attributes.get(We.OFFSET),_={applyToVertex:(n,r,l,c)=>{const _=be(fi,a.data[3*c],a.data[3*c+1],a.data[3*c+2]),b=be(mi,n,r,l);return J(_,_,this.parameters.screenSizeScale*s.camera.computeScreenPixelSizeAt(_)),N(b,b,_),[b[0],b[1],b[2]]},applyToAabb:n=>{const a=wt(n,fi);return Tt(n,this.parameters.screenSizeScale*s.camera.computeScreenPixelSizeAt(a))}};pt(n,s,r,l,_,c)}else pt(n,s,r,l,void 0,c)}createGLMaterial(n){return new pi(n)}createBufferWriter(){return new gi(this.parameters.screenSizeEnabled)}get _isTransparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}},pi=class v2 extends _t{beginSlot(n){return this.ensureTechnique(ci,n)}},_i=class x extends gt{constructor(){super(...arguments),this.color=ft(1,1,1,1),this.shadingTint=ft(0,0,0,.25),this.shadingDirection=mt(_(),[.5,-.5,-.5]),this.screenSizeScale=14,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=Ye.None,this.screenSizeEnabled=!1,this.shadingEnabled=!0}},gi=class z{constructor(n){this.screenSizeEnabled=n;const a=vt().vec3f(We.POSITION).vec3f(We.NORMAL);this.screenSizeEnabled&&a.vec3f(We.OFFSET),this.vertexBufferLayout=a}elementCount(n){return n.attributes.get(We.POSITION).indices.length}write(n,a,s,r,l){if(bt(s,this.vertexBufferLayout,n,a,r,l),this.screenSizeEnabled){if(!s.attributes.has(We.OFFSET))throw new Error(`${We.OFFSET} vertex attribute required for screenSizeEnabled ShadedColorMaterial`);{const n=s.attributes.get(We.OFFSET);yt(3===n.size);const c=r.getField(We.OFFSET,St);if(!c)throw new Error("unable to acquire view for "+We.OFFSET);Et(n,a,c,l)}}}};const fi=_(),mi=_();function f$1(n,a=xt.OccludeAndTransparent,s=!0){const r=Ot(n),l=!(n[3]<1);return s?new ui({color:r,writeDepth:l,cullFace:Ye.Back,renderOccluded:a,isDecoration:!0}):new At({color:r,writeDepth:l,cullFace:Ye.Back,renderOccluded:a,isDecoration:!0})}function h$1(n,a=xt.OccludeAndTransparent){const s=Ot(n);return new At({color:s,writeDepth:!0,cullFace:Ye.Front,renderOccluded:a,isDecoration:!0})}const vi=Object.freeze({calloutLength:40,calloutWidth:1,discRadius:27,focusMultiplier:1.1}),bi=Object.freeze({autoScaleRenderObjects:!1,worldSized:!0});function w$1(n,a,s,r){const l=ye(Q.get(),n,s),c=O(l,Rt(Q.get(),r,l),s,Lt.get());Mt(c,c);const _=X(Q.get(),a,c);return Math.atan2(_[1],_[0])}function O(n,a,s,r){const l=mt(Q.get(),n),c=mt(Q.get(),a),_=Rt(Q.get(),l,c);return r[0]=l[0],r[1]=l[1],r[2]=l[2],r[3]=0,r[4]=c[0],r[5]=c[1],r[6]=c[2],r[7]=0,r[8]=_[0],r[9]=_[1],r[10]=_[2],r[11]=0,r[12]=s[0],r[13]=s[1],r[14]=s[2],r[15]=1,r}function D$1(n,a){const s=n.getViewForGraphic(a);return null!=s&&"computeAttachmentOrigin"in s?s.computeAttachmentOrigin(a,n.spatialReference):null}function F(n,a){const s=a.origin;null==s?function y$1(n,a){if(null==a)return;const s="mesh"===a.type?a.anchor:zt(a);null!=s&&(n.location=jt(s))}(n,t(a)):n.elevationAlignedLocation=s}class e{constructor(n,a=me.None){this.geometry=n,this.stateMask=a}}function p(n,a){return n.events.on("drag",function i$1(n,a){let s=null,r=null;return l=>{if("cancel"===l.action)return void(null!=r&&(r.execute({action:"cancel"}),s=null,r=null));const c={action:l.action,screenStart:l.start,screenEnd:l.screenPoint};"start"===l.action&&null==s&&(s=new w2,r=new w2,a(n,s,r,l.pointerType,c)),null!=s&&s.execute(c),"end"===l.action&&null!=s&&(s=null,r=null)}}(n,a))}function m(n,a){const s=[n.x,n.y,n.z??0],r=a,l=[Math.cos(r),Math.sin(r)],c=Math.sqrt(l[0]*l[0]+l[1]*l[1]);if(0===c)return null;l[0]/=c,l[1]/=c;const l2=n=>{const a=(n.x-s[0])*l[0]+(n.y-s[1])*l[1];n.x=s[0]+a*l[0],n.y=s[1]+a*l[1]};return n=>(l2(n.mapStart),l2(n.mapEnd),{...n,axis:l})}function f(n){let a=null;return s=>{if("start"===s.action&&(a=function y(n,a){const s=n.operations;if(!s)return null;const r=s.data.geometry,l=I(a);if(r.spatialReference.equals(l))return x2(n,s,(()=>{}));if("mesh"!==r.type){const a=d(r,l);if(null==a)return null;const c=r.spatialReference;return x2(n,qt.fromGeometry(a,s.viewingMode),(()=>{const n=Ct(r,c);s.trySetGeometry(n)}))}if(Ft(r)){const a=d(r.origin,l);if(!a)return null;const c=r.spatialReference,_=qt.fromGeometry(a,s.viewingMode);return x2(n,s,(()=>{const n=Ct(_.data.geometry,c),a=n.x-r.origin.x,l=n.y-r.origin.y,b=(n.z??0)-(r.origin.z??0);s.move(a,l,b)}))}return null}(n,s.mapStart.spatialReference)),null==a)return null;const r=s.mapEnd.x-s.mapStart.x,l=s.mapEnd.y-s.mapStart.y,c=(s.mapEnd.z??0)-(s.mapStart.z??0);return a.move(r,l,c,s.action),{...s,translationX:r,translationY:l,translationZ:c}}}function d(n,a){return null==n?null:n.spatialReference.equals(a)?n.clone():Ct(n,a)}function x2(n,a,s){let r=0,l=0,c=0;return{move:(_,b,E,T)=>{var A;"start"===T&&(r=0,l=0,c=0);const L=_-r,P=b-l,C=E-c;a.move(L,P,C),r+=L,l+=P,c+=C,s(),"end"===T&&(null==(A=n.endInteraction)||A.call(n))}}}function S(n){const a=n.map((n=>f(n))).filter(Dt);return n=>{const s=n.mapEnd.x-n.mapStart.x,r=n.mapEnd.y-n.mapStart.y,l=n.mapEnd.z-n.mapStart.z;return a.forEach((a=>a(n))),{...n,translationX:s,translationY:r,translationZ:l}}}function h(n,a){const s=new Map;for(const r of a)s.set(r,Pt(n[r]));return a=>(s.forEach(((a,s)=>{n[s]=a})),a)}function g(n){var a;const s=null==(a=n.operations)?void 0:a.createResetState();return n=>(null==s||s.remove(),n)}function z2(n){const a=n.map((n=>g(n))).filter((n=>null!=n));return n=>(a.forEach((a=>a(n))),n)}function v3(){let n=0,a=0,s=0;return r=>{"start"===r.action&&(n=r.mapStart.x,a=r.mapStart.y,s=r.mapStart.z);const l=r.mapEnd.x-n,c=r.mapEnd.y-a,_=r.mapEnd.z-s;return n=r.mapEnd.x,a=r.mapEnd.y,s=r.mapEnd.z,{...r,mapDeltaX:l,mapDeltaY:c,mapDeltaZ:_,mapDeltaSpatialReference:r.mapStart.spatialReference}}}function j2(){let n=0,a=0;return s=>{"start"===s.action&&(n=s.screenStart.x,a=s.screenStart.y);const r=s.screenEnd.x-n,l=s.screenEnd.y-a;return n=s.screenEnd.x,a=s.screenEnd.y,{...s,screenDeltaX:r,screenDeltaY:l}}}function M(n,a){let s=null,r=0,l=0;return c=>{var _;if("start"===c.action&&(s=null==(_=n.toScreen)?void 0:_.call(n,a),null!=s&&(s.x<0||s.x>n.width||s.y<0||s.y>n.height?s=null:(r=c.screenStart.x-s.x,l=c.screenStart.y-s.y))),null==s)return null;const b=Nt(c.screenEnd.x-r,0,n.width),E=Nt(c.screenEnd.y-l,0,n.height),T=Wt(b,E);return c.screenStart=s,c.screenEnd=T,c}}const R=()=>{};class w2{constructor(){this.execute=R}next(n,a=new w2){return null!=n&&(this.execute=s=>{const r=n(s);null!=r&&a.execute(r)}),a}}function D(n,a,s=[]){if("2d"===n.type)return n=>n;let r=null;return l=>{"start"===l.action&&(r=n.toMap(l.screenStart,{exclude:s}),null!=r&&(r.z=It(r,n,a)));const c=n.toMap(l.screenEnd,{exclude:s});null!=c&&(c.z=It(c,n,a));const _=null!=r&&null!=c?{sceneStart:r,sceneEnd:c}:null;return{...l,scenePoints:_}}}function G(n,a,s){const r=a.elevationProvider.getElevation(n.x,n.y,n.z??0,n.spatialReference,"scene")??0,l=C(n);return l.z=r,l.hasZ=!0,l.z=It(l,a,s),l}function U(n,a){if("2d"===n.type)return n=>n;let s=null;return r=>{"start"===r.action&&(s=G(r.mapStart,n,a));const l=G(r.mapEnd,n,a),c=null!=s&&null!=l?{sceneStart:s,sceneEnd:l}:null;return{...r,scenePoints:c}}}var yi,Si;(Si=yi||(yi={}))[Si.WhenToolEditable=0]="WhenToolEditable",Si[Si.WhenToolNotEditable=1]="WhenToolNotEditable",Si[Si.Always=2]="Always";class i{constructor(){this._isToolEditable=!0,this._manipulators=new kt,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(n){this._isToolEditable=n}get length(){return this._manipulators.length}add(n,a=yi.WhenToolEditable){this.addMany([n],a)}addMany(n,a=yi.WhenToolEditable){for(const s of n){const n={manipulator:s,visibilityPredicate:a,attached:!1};this._manipulators.add(n),this._attached&&this._updateManipulatorAttachment(n)}}remove(n){for(let a=0;a<this._manipulators.length;a++)if(this._manipulators.at(a).manipulator===n){const n=this._manipulators.splice(a,1)[0];this._detachManipulator(n);break}}removeAll(){this._manipulators.forEach((n=>{this._detachManipulator(n)})),this._manipulators.removeAll()}attach(){this._manipulators.forEach((n=>{this._updateManipulatorAttachment(n)})),this._attached=!0}detach(){this._manipulators.forEach((n=>{this._detachManipulator(n)})),this._attached=!1}destroy(){this.detach(),this._manipulators.forEach((({manipulator:n})=>n.destroy())),this._manipulators.destroy(),this._resourceContexts=null}on(n,a){return this._manipulators.on(n,(n=>{a(n)}))}forEach(n){for(const a of this._manipulators.items)n(a)}some(n){return this._manipulators.items.some(n)}toArray(){const n=[];return this.forEach((a=>n.push(a.manipulator))),n}intersect(n,a){let s=null,r=Number.MAX_VALUE;return this._manipulators.forEach((({manipulator:l,attached:c})=>{if(!c||!l.interactive)return;const _=l.intersectionDistance(n,a);null!=_&&_<r&&(r=_,s=l)})),s}_updateManipulatorAttachment(n){this._isManipulatorItemVisible(n)?this._attachManipulator(n):this._detachManipulator(n)}_attachManipulator(n){n.attached||(n.manipulator.attach&&n.manipulator.attach(this._resourceContexts),n.attached=!0)}_detachManipulator(n){if(!n.attached)return;const a=n.manipulator;a.grabbing=!1,a.dragging=!1,a.hovering=!1,a.selected=!1,a.detach&&a.detach(this._resourceContexts),n.attached=!1}_isManipulatorItemVisible(n){return n.visibilityPredicate===yi.Always||(this._isToolEditable?n.visibilityPredicate===yi.WhenToolEditable:n.visibilityPredicate===yi.WhenToolNotEditable)}}let Ei=class extends Ut{constructor(n){super(n),this.manipulators=new i,this.automaticManipulatorSelection=!0,this.hasGrabbedManipulators=!1,this.hasHoveredManipulators=!1,this.firstGrabbedManipulator=null,this.created=!1,this.removeIncompleteOnCancel=!0,this._editableFlags=new Map([[Bt.MANAGER,!0],[Bt.USER,!0]]),this._creationFinishedResolver=Vt()}get active(){return null!=this.view&&this.view.activeTool===this}set visible(n){this._get("visible")!==n&&(this._set("visible",n),this._syncVisible())}get editable(){return this.getEditableFlag(Bt.USER)}set editable(n){this.setEditableFlag(Bt.USER,n)}get updating(){return!1}get cursor(){return null}get hasFocusedManipulators(){return this.hasGrabbedManipulators||this.hasHoveredManipulators}destroy(){this.manipulators.destroy(),this._set("view",null)}onAdd(){this._syncVisible()}activate(){null!=this.view&&(this.view.focus(),this.onActivate())}deactivate(){this.onDeactivate()}handleInputEvent(n){this.onInputEvent(n)}handleInputEventAfter(n){this.onInputEventAfter(n)}setEditableFlag(n,a){this._editableFlags.set(n,a),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),n===Bt.USER&&this.notifyChange("editable"),this.onEditableChange(),this.onManipulatorSelectionChanged()}getEditableFlag(n){return this._editableFlags.get(n)??!1}whenCreated(){return this._creationFinishedResolver.promise}onManipulatorSelectionChanged(){}onActivate(){}onDeactivate(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(n){}onInputEventAfter(n){}get internallyEditable(){return this.getEditableFlag(Bt.USER)&&this.getEditableFlag(Bt.MANAGER)}finishToolCreation(){this.created||this._creationFinishedResolver.resolve(this),this._set("created",!0)}_syncVisible(){if(this.initialized)if(this.visible)this._show();else if(this._hide(),this.active)return void(this.view.activeTool=null)}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.visible?this.manipulators.attach():this.manipulators.detach()}};Xe([Gt({constructOnly:!0})],Ei.prototype,"view",void 0),Xe([Gt({readOnly:!0})],Ei.prototype,"active",null),Xe([Gt({value:!0})],Ei.prototype,"visible",null),Xe([Gt({value:!0})],Ei.prototype,"editable",null),Xe([Gt({readOnly:!0})],Ei.prototype,"manipulators",void 0),Xe([Gt({readOnly:!0})],Ei.prototype,"updating",null),Xe([Gt()],Ei.prototype,"cursor",null),Xe([Gt({readOnly:!0})],Ei.prototype,"automaticManipulatorSelection",void 0),Xe([Gt()],Ei.prototype,"hasFocusedManipulators",null),Xe([Gt()],Ei.prototype,"hasGrabbedManipulators",void 0),Xe([Gt()],Ei.prototype,"hasHoveredManipulators",void 0),Xe([Gt()],Ei.prototype,"firstGrabbedManipulator",void 0),Xe([Gt({readOnly:!0})],Ei.prototype,"created",void 0),Xe([Gt({readOnly:!0})],Ei.prototype,"removeIncompleteOnCancel",void 0),Ei=Xe([$t("esri.views.interactive.InteractiveToolBase")],Ei);const wi=Object.freeze(Object.defineProperty({__proto__:null,build:u},Symbol.toStringTag,{value:"Module"}));export{D,F,M,O,S,U,w$1 as a,ui as b,e as c,f$1 as d,ee as e,f,g,h,bi as i,j2 as j,vi as k,h$1 as l,m,Ei as n,D$1 as o,p,t,v3 as v,w2 as w,z2 as z};
