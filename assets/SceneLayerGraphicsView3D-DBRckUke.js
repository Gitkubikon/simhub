const __vite__fileDeps=["assets/I3STreeDebugger-D_wyOLU3.js","assets/index-DSIPxOWi.js","assets/index-B_7YxLDX.css","assets/TileTreeDebugger-CDFY3SV7.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{bc as e,jR as t,a5 as i,u as o,jS as a,P as n,g as l,_ as d,hl as h,C as u,ib as c,jT as p,jU as g,$ as m,n as _,fE as y,jV as f,a6 as b,jW as v,H as I,hi as x,e8 as E,jX as w,O as j,jY as N,jZ as C,v as O,ec as D,j_ as F,j$ as S,k0 as A,k1 as G,a2 as L,a8 as R,d as P,e as V,y as M,ab as H,w as Q,a as q,k2 as T,Q as U,k3 as k}from"./index-DSIPxOWi.js";import{G as z,K as B}from"./I3SOverrides-CXcxzPSI.js";import{h as W}from"./WorkerHandle-Bq2affGI.js";import{l as Z}from"./LayerView3D-ApO6iJqK.js";import{P as $,l as K}from"./HeatmapDensity.glsl-jGaN0eX9.js";import{a as Y,i as X,u as J,f as ee,b as te,w as re}from"./SceneLayerView-DRJlFU-M.js";import{u as se,t as oe}from"./TemporalSceneLayerView-BafFz-f2.js";import{i as he}from"./PopupSceneLayerView-Cv6_Wug9.js";import"./RenderTexture-DbJC7CTU.js";import"./I3SNode-mlgend4K.js";import"./ReactiveSet-XbWJTkHf.js";import"./meshFeatureSet-BNHS2qnT.js";import"./Mesh-BS04vQSz.js";import"./MeshTransform-Y0ppddED.js";import"./vertexSpaceConversion-C_GU75pR.js";import"./External-Djr0rIk9.js";import"./infoFor3D-BTCPmnmy.js";import"./FeatureLayerView3D-C33G2_Ur.js";import"./FeatureLayerViewBase3D-BxcSlUqN.js";import"./query-C2USZ63O.js";import"./normalizeUtils-BrH-PrZy.js";import"./normalizeUtilsCommon-BU8xfl77.js";import"./pbfQueryUtils-DUjEbwA9.js";import"./pbf-B53Txr8m.js";import"./EventedSet-D3TBRYG7.js";import"./floorFilterUtils-2NbRkqHK.js";import"./LayerView-DMoB2q_T.js";import"./RefreshableLayerView-MYyyoaX8.js";import"./timeSupport-CU-EQyfu.js";import"./projectExtentUtils-KG39_WUt.js";import"./dehydratedFeatureComparison-dI04k89u.js";import"./queryForSymbologySnapping-CEKgwdf_.js";import"./hash-BjBdcEEU.js";import"./Graphics3DObjectStates-B77mD6jz.js";import"./optimizedFeatureQueryEngineAdapter--U1rvwBV.js";import"./PooledRBush-DOZnXWx2.js";import"./quickselect-D9ta8ndX.js";import"./QueryEngine-DAD9skS_.js";import"./WhereClause-DYd7Xwn9.js";import"./TimeOnly-C5lZbbIX.js";import"./json-omtrO2vq.js";import"./QueryEngineCapabilities-CTDe3LlQ.js";import"./utils-B-uQJqPz.js";import"./utils-DEUXBrCj.js";import"./utils-1_4Re7um.js";import"./ClassBreaksDefinition-Dt1HCCB7.js";import"./FeatureStore-Dpo5Syxq.js";import"./BoundsStore-BQ0MOdb7.js";class r extends W{constructor(e){super("SceneLayerWorker","dracoDecompressPointCloudData",{dracoDecompressPointCloudData:e=>[e.geometryBuffer]},e,{hasInitialize:!0})}}class s extends e{constructor(e,t){super(),this._updateAndCompare=e,this._notifyUpdated=t,this._nodes=new Map,this._graphics=new Map,this._duplicates=new Map}clear(){if(this._graphics.size>0){const e=this.toArray();this._graphics.clear(),this.emit("change",{added:[],removed:e})}this._nodes.clear()}get length(){return this._graphics.size}get(e){return this._graphics.get(e)}getNode(e){return this._nodes.get(e)}hasNode(e){return this._nodes.has(e)}nodes(){return this._nodes.values()}addNode(e,t){this._nodes.set(e,t);const i=t.graphics;if(0===i.length)return;const o=new Set;for(let n=0;n<i.length;n++){const t=i[n],a=t.objectId,l=this._graphics.get(a);if(l){o.add(a),t!==l&&(i[n]=l);const d=this._duplicates.get(a);d?d.push(e):this._duplicates.set(a,[l.nodeIndex,e])}else t.nodeIndex=e,this._graphics.set(a,t)}o.size&&this._updateForeignGraphics(t);const a=o.size>0?i.filter((e=>!o.has(e.objectId))):i;a.length>0&&this.emit("change",{added:a,removed:[]})}removeNode(e){const t=this._nodes.get(e);if(!t)return;this._nodes.delete(e);const i=new Set,o=[];for(const a of t.graphics){const t=a.objectId,n=this._graphics.get(t);if(!n)continue;const l=this._duplicates.get(t);if(l){const o=l.indexOf(e);if(-1===o)continue;if(l.splice(o,1),n.nodeIndex===e){let e=this.getNode(l[0]);for(let t=1;t<l.length;t++){const i=this.getNode(l[t]);(null==e||null!=i&&i.node.level>e.node.level)&&(e=i)}null!=e&&i.add(e)}1===l.length&&this._duplicates.delete(t)}else this._graphics.delete(t),o.push(a)}o.length>0&&this.emit("change",{added:[],removed:o}),i.forEach((e=>this._updateForeignGraphics(e)))}_updateForeignGraphics(e){const t=[],i=e.node.index,o=e.node.level;let a=0;for(;a<e.graphics.length;){const n=e.graphics[a].nodeIndex;if(n===i){a++;continue}let l=1;for(;a+l<e.graphics.length&&e.graphics[a+l].nodeIndex===n;)l++;const d=this.getNode(n);if(null!=d&&d.node.level>o)a+=l;else{for(let o=a;o<a+l;o++){const a=e.graphics[o];a.nodeIndex=i,this._updateAndCompare(a,e,o)&&t.push(a)}a+=l}}t.length>0&&this._notifyUpdated(t)}toArray(){return Array.from(this._graphics.values())}find(e){let i;return t(this._graphics,(t=>!!e(t)&&(i=t,!0))),i}forEach(e){this._graphics.forEach((t=>e(t)))}forEachNode(e){this._nodes.forEach(((t,i)=>e(t,i)))}get nodeCount(){return this._nodes.size}_checkInvariants(){const e=new Map;this._nodes.forEach(((t,i)=>{t.graphics.forEach((t=>{e.set(t.objectId,1+(e.get(t.objectId)??0)),this._duplicates.get(t.objectId)}))})),e.forEach(((e,t)=>{const i=this._graphics.get(t);if(!i)return;if(!this._nodes.get(i.nodeIndex))return;const o=this._duplicates.get(t);o&&o.forEach((e=>{this._nodes.get(e)}))}))}}const ce=te();class ie{constructor(e,t,i,o){this.graphics=e,this.featureIds=t,this.attributeInfo=i,this.node=o}}let pe=class extends(se(oe(he(Z(re))))){constructor(){super(...arguments),this.type="scene-layer-graphics-3d",this._queryEngine=null,this._memCache=null,this._interactiveEditingSessions=new Map,this._pendingEditsQueue=Promise.resolve(),this.loadedGraphics=new s(((e,t,i)=>function le(e,t,i){const o=t.attributeInfo;if(null==(null==o?void 0:o.loadedAttributes)||null==o.attributeData)return!1;let a=!1;for(const{name:n}of o.loadedAttributes)if(o.attributeData[n]){const t=T(o.attributeData[n],i);t!==e.attributes[n]&&(e.attributes[n]=t,a=!0)}return a}(e,t,i)),(e=>this.processor.graphicsCore.recreateGraphics(e))),this.holeFilling="always",this.progressiveLoadFactor=1,this.supportsHeightUnitConversion=!0,this._coordinatesOutsideExtentErrors=0,this._maxCoordinatesOutsideExtentErrors=20}tryRecycleWith(e,t){return e.url===this.layer.url&&this._i3sOverrides.isEmpty?e.load(t).then((()=>{var t;i(this.layer,e,this._i3sOverrides),this.layer=e,this._i3sOverrides.destroy();const a=null==(t=this.view.resourceController)?void 0:t.memoryController;this._i3sOverrides=new z({view:this.view,layer:e,memoryController:a}),o(this._queryEngine),this._setupQueryEngine(),this.processor.resetObjectStates()})):null}initialize(){var e,t;this.addResolvingPromise(this.layer.indexInfo);const i=null==(e=this.view.resourceController)?void 0:e.memoryController;this._i3sOverrides=new z({view:this.view,layer:this.layer,memoryController:i}),a(this.layer,this.view.spatialReference,this.view.viewingMode),this._fieldsHelper=new Y({layerView:this}),this._updatingHandles.add((()=>this.layer.rangeInfos),(e=>this._rangeInfosChanged(e)),n),this._updatingHandles.add((()=>this.layer.renderer),((e,t)=>this._rendererChange(e,t))),this._updatingHandles.add((()=>[this.parsedDefinitionExpression,this._excludeObjectIdsSorted]),(()=>this._filterChange())),this.addHandles(l((()=>h.I3S_TREE_SHOW_TILES),(e=>{if(e&&!this._treeDebugger){const e=this._controller.crsIndex;d((()=>import("./I3STreeDebugger-D_wyOLU3.js")),__vite__mapDeps([0,1,2,3])).then((({I3STreeDebugger:t})=>{!this._treeDebugger&&h.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new t({lv:this,view:this.view,nodeSR:e}))}))}else e||!this._treeDebugger||h.I3S_TREE_SHOW_TILES||(this._treeDebugger.destroy(),this._treeDebugger=null)}),n)),this._set("processor",new $({owner:this,preferredUpdatePolicy:u.ASYNC,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!1,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,setUidToIdOnAdd:!1,dataExtent:this.layer.fullExtent,updateClippingExtent:e=>this._updateClippingExtent(e)})),null==(t=this.processor.elevationAlignment)||t.events.on("invalidate-elevation",(({extent:e,spatialReference:t})=>this._controller.updateElevationChanged(e,t))),this.supportsHeightUnitConversion&&(this._verticalScale=c("point",this.layer.spatialReference,this.view.spatialReference)),this.addResolvingPromise(this.processor.initializePromise),this._memCache=this.view.resourceController.memoryController.newCache(`psl-${this.uid}`),this._controller=new B({layerView:this}),p(this.layer.geometryDefinitions)&&(this._worker=new r((e=>this.view.resourceController.immediate.schedule(e)))),this.addHandles(this.layer.on("apply-edits",(e=>this._updatingHandles.addPromise(e.result)))),this.addHandles(this.layer.on("edits",(e=>{const t=this._pendingEditsQueue.then((()=>this._handleEdits(e))).then();this._pendingEditsQueue=t,this._updatingHandles.addPromise(t)}))),this.when((()=>{this._setupQueryEngine(),this._updatingHandles.add((()=>this.maximumNumberOfFeatures),(e=>this._controller.featureTarget=e),n),this._updatingHandles.add((()=>this.suspended),(e=>{e&&this._removeAllNodeData()}))}))}destroy(){this._treeDebugger=o(this._treeDebugger),this._i3sOverrides=o(this._i3sOverrides),this._set("processor",o(this.processor)),this._controller=o(this._controller),this._queryEngine=o(this._queryEngine),this._worker=o(this._worker),this._memCache=o(this._memCache),this.loadedGraphics.clear(),this._fieldsHelper=o(this._fieldsHelper)}get i3slayer(){return this.layer}get updatingProgressValue(){var e;return(null==(e=this._controller)?void 0:e.updatingProgress)??1}get requiredFields(){var e;return(null==(e=this._fieldsHelper)?void 0:e.requiredFields)??[]}get maximumNumberOfFeatures(){var e,t;const i=null==(t=null==(e=this.processor)?void 0:e.graphicsCore)?void 0:t.displayFeatureLimit;return(null==i?void 0:i.maximumNumberOfFeatures)??0}set maximumNumberOfFeatures(e){null!=e?(this._override("maximumNumberOfFeatures",e),this._controller.fixedFeatureTarget=!0):(this._clearOverride("maximumNumberOfFeatures"),this._controller.fixedFeatureTarget=!1)}get maximumNumberOfFeaturesExceeded(){var e;return!this.suspended&&!!(null==(e=this._controller)?void 0:e.useMaximumNumberOfFeatures)&&!this._controller.leavesReached}get _excludeObjectIdsSorted(){const e=this.layer.excludeObjectIds;return e.length?e.toArray().sort(((e,t)=>e-t)):null}get lodFactor(){return"Labels"===this.layer.semantic?1:this.view.qualitySettings.sceneService.point.lodFactor}get hasM(){return!1}get hasZ(){return!0}get contentVisible(){var e;return!this.suspended&&!!(null==(e=this._controller)?void 0:e.rootNodeVisible)}get legendEnabled(){var e;return this.contentVisible&&!0===(null==(e=this.i3slayer)?void 0:e.legendEnabled)}async whenGraphicAttributes(e,t){return g(this.layer,e,this._getObjectIdField(),t,(()=>[...this.loadedGraphics.nodes()]))}getHit(e){var t;if(!this.loadedGraphics)return null;const i=m(this.loadedGraphics.find((t=>t.uid===e)),this.layer),o=this._getObjectIdField();return(null==(t=null==i?void 0:i.attributes)?void 0:t[o])?(i.layer=this.layer,i.sourceLayer=this.layer,{type:"graphic",graphic:i,layer:i.layer}):null}whenGraphicBounds(e,t){return this.processor.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.processor.computeAttachmentOrigin(e,t)}isUpdating(){var e,t,i;return!!((null==(e=this._controller)?void 0:e.updating)||(null==(t=this.processor)?void 0:t.updating)||(null==(i=this._fieldsHelper)?void 0:i.updating)||this.layerFilterUpdating)}highlight(e){return this.processor.highlight(e,this.layer.objectIdField)}get updatePolicy(){return this.processor.graphicsCore.effectiveUpdatePolicy}createInteractiveEditSession(e){return X(this._attributeEditingContext,e)}async _decompressBinaryPointData(e,t){const i={geometryBuffer:e.geometryBuffer};null==this._worker&&(this._worker=new r((e=>this.view.resourceController.immediate.schedule(e))));const o=await this._worker.invoke(i,t);if(null==o)throw new Error("Failed to decompress Draco point data");return{positionData:o.positions,featureIds:o.featureIds}}async addNode(e,t,i){var o;if(!ne(t)&&!function ae(e){return"pointData"in e}(t))throw new Error;if(this.loadedGraphics.hasNode(e.index))return void _.getLogger(this).error("I3S node "+e.id+" already added");const a=null!=this.layer.fullExtent?function ue(e,t){return e.xmin-=t,e.ymin-=t,e.xmax+=t,e.ymax+=t,null!=e.zmin&&null!=e.zmax&&(e.zmin-=t,e.zmax+=t),null!=e.mmin&&null!=e.mmax&&(e.mmin-=t,e.mmax+=t),e}(this.layer.fullExtent.clone(),.5):null,{featureIds:n,pointPositions:l}=ne(t)?await this._extractBinaryPointPositions(e,t,i):this._extractLegacyPointPositions(t),d=new Array;this._validatePositions(e,n,l,a,d);const h=this._controller.crsVertex,u=this.view.spatialReference;y(l,h,0,l,u,0,n.length);const c=ne(t)?e.level:0,p=this._createGraphics(n,l,e.index,c),g=new ie(p,n,t.attributeDataInfo,e);if(await this._i3sOverrides.applyAttributeOverrides(g.featureIds,t.attributeDataInfo,i),e.numFeatures=g.graphics.length,this._updateNodeMemory(e),de(g),d.length>0&&(this._computeObb(e,d,h),this._controller.updateVisibility(e.index)),!this._controller.isGeometryVisible(e))return void this._cacheNodeData(g);if(null!=this._verticalScale)for(const _ of g.graphics)this._verticalScale(_.geometry);const m=this.view._stage.renderView.objectAndLayerIdRenderHelper;if(null!=m){const e=f(this.view.map,this.layer.uid);for(let t=0;t<g.featureIds.length;t++){const i=g.featureIds[t];m.setUidToObjectAndLayerId(i,g.graphics[t].uid,this.layer.id,this.layer.uid,this.layer.popupEnabled&&!e&&b(this.layer,null==(o=this.view.popup)?void 0:o.defaultPopupTemplateEnabled),g.node.resources.attributes,t)}}this.loadedGraphics.addNode(e.index,g),this._controller.updateLoadStatus(e.index,!0),this._filterNode(g),this._treeDebugger&&this._treeDebugger.update()}_computeObb(e,t,i){const o=this._controller.crsIndex,a=o.isGeographic?this.view.renderSpatialReference:o;y(t,i,0,t,a,0,t.length/3),e.serviceObbInIndexSR=v(new k(t,3)),o.isGeographic&&(I(e.serviceObbInIndexSR.center,a,_e,o),e.serviceObbInIndexSR.center=_e)}isNodeLoaded(e){return this.loadedGraphics.hasNode(e)}isNodeReloading(){return!1}updateNodeState(){}async _extractBinaryPointPositions(e,t,i){const o=await this._decompressBinaryPointData(t,i),a=o.positionData,n=a.length/3,l=x(3*n),d=null!=e.serviceObbInIndexSR?e.serviceObbInIndexSR.center:E,h=Math.abs(d[2])*2**-20;for(let u=0;u<n;u++){const e=3*u;l[e]=a[e]+d[0],l[e+1]=a[e+1]+d[1],l[e+2]=a[e+2]+d[2],Math.abs(l[e+2])<h&&(l[e+2]=0)}return{featureIds:o.featureIds?w(o.featureIds):[],pointPositions:l}}_extractLegacyPointPositions(e){var t,i;const o=e.pointData.length,a=x(3*o),n=new Array;for(let l=0;l<o;l++){const o=e.pointData[l],d=o.featureDataPosition,h=d.length,u=(null==(t=o.geometries)?void 0:t[0])??me[h],c=o.featureIds[0];if("Embedded"!==u.type||"points"!==u.params.type||h<2||h>3)continue;const p=(null==(i=u.params.vertexAttributes)?void 0:i.position)??[0,0,0],g=3*n.length;a[g]=d[0]+p[0],a[g+1]=d[1]+p[1],a[g+2]=3===h?d[2]+p[2]:NaN,n.push(c)}return{featureIds:n,pointPositions:a}}_validatePositions(e,t,i,o,a){if(null==o&&e.serviceObbInIndexSR)return;const n=t.length;for(let l=0;l<n;l++){const t=3*l;j(_e,i[t],i[t+1],i[t+2]);const n=!Number.isNaN(i[2]);null==o||(n?N(o,_e):C(o,_e))||(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&_.getLogger(this).error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&_.getLogger(this).error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++),e.serviceObbInIndexSR||a.push(_e[0],_e[1],_e[2])}}_createGraphics(e,t,i,o){const a=e.length,n=this._getObjectIdField(),l=this.processor.graphicsCore,d=new Array,h=this.view.spatialReference;for(let u=0;u<a;u++){const a=e[u],c={};null!=a&&(c[n]=a);const p=a??O.generateUID(),g=3*u,m=isNaN(t[g+2])?void 0:t[g+2],_=D(t[g],t[g+1],m,h),y=this.loadedGraphics.get(p);if(null!=y)(null==y.level||y.level<o)&&(ye.property="geometry",ye.graphic=y,ye.oldValue=y.geometry,ye.newValue=_,y.geometry=_,y.level=o,l.graphicUpdateHandler(ye)),d.push(y);else{const e=O.generateUID();d.push({objectId:p,uid:e,geometry:_,attributes:c,visible:!0,nodeIndex:i,level:o})}}return d}_updateNodeMemory(e){e.memory=4096+(null!=e.numFeatures?e.numFeatures*this.processor.graphicsCore.usedMemoryPerGraphic:0)}_cacheNodeData(e){const t=e.graphics.reduce(((e,t)=>F(t)+e),S(e.featureIds)+1024);this._memCache.put(this._getMemCacheKey(e.node),e,t)}_getMemCacheKey(e){return`${e.index}`}_removeAllNodeData(){this.loadedGraphics.forEachNode(((e,t)=>{if(e){const t=e.node;this._updateNodeMemory(t),this._cacheNodeData(e)}this._controller.updateLoadStatus(t,!1)})),this._treeDebugger&&this._treeDebugger.update(),this.loadedGraphics.clear()}removeNode(e){const t=this._removeNodeStageData(e);t&&(this._updateNodeMemory(t.node),this._cacheNodeData(t))}_removeNodeStageData(e){const t=this.loadedGraphics.getNode(e);return null==t?null:(this._controller.updateLoadStatus(e,!1),this.loadedGraphics.removeNode(e),this._treeDebugger&&this._treeDebugger.update(),t)}async loadCachedNodeData(e){var t;return null==(t=this._memCache)?void 0:t.pop(this._getMemCacheKey(e))}async addCachedNodeData(e,t,i,o){this.loadedGraphics.hasNode(e.index)?_.getLogger(this).error("I3S node "+e.id+" already added"):(await this._i3sOverrides.applyAttributeOverrides(t.featureIds,i,o),t.attributeInfo=i,this.loadedGraphics.addNode(e.index,t),this._controller.updateLoadStatus(e.index,!0),this._updateNodeMemory(e),de(t),this._filterNode(t),this._treeDebugger&&this._treeDebugger.update())}getLoadedNodeIds(){const e=[];return this.loadedGraphics.forEachNode((t=>e.push(t.node.id))),e.sort()}getVisibleNodes(){const e=new Array;return this.loadedGraphics.forEachNode((t=>e.push(t.node))),e}getLoadedNodeIndices(e){this.loadedGraphics.forEachNode(((t,i)=>e.push(i)))}getLoadedAttributes(e){const t=this.loadedGraphics.getNode(e);if(null!=(null==t?void 0:t.attributeInfo))return t.attributeInfo.loadedAttributes}getAttributeData(e){const t=this.loadedGraphics.getNode(e);if(null!=(null==t?void 0:t.attributeInfo))return t.attributeInfo.attributeData}_setAttributeData(e,t){const i=this.loadedGraphics.getNode(e);null!=(null==i?void 0:i.attributeInfo)&&(i.attributeInfo.attributeData=t,this._attributeValuesChanged(i))}async updateAttributes(e,t,i){const o=this.loadedGraphics.getNode(e);null!=o&&(await this._i3sOverrides.applyAttributeOverrides(o.featureIds,t,i),o.attributeInfo=t,this._attributeValuesChanged(o))}_attributeValuesChanged(e){if(de(e),this._filterNode(e),this.processor.graphicsCore.labelsEnabled){const t=e.node.index,i=new Array;e.graphics.forEach((e=>e.nodeIndex===t&&i.push(e.uid))),this.processor.graphicsCore.updateLabelingInfo(i)}}_updateClippingExtent(e){return this._controller&&this._controller.updateClippingArea(e),!1}_getObjectIdField(){return this.layer.objectIdField||A}_getGlobalIdField(){var e;return null==(e=this.layer.associatedLayer)?void 0:e.globalIdField}async _rendererChange(e,t){const{layer:{fieldsIndex:i}}=this,o=new Set;let a,n;e?(await e.collectRequiredFields(o,i),a=Array.from(o).sort()):a=[],o.clear(),t?(await t.collectRequiredFields(o,i),n=Array.from(o).sort()):n=[],a.length===n.length&&a.every(((e,t)=>a[t]===n[t]))||this._reloadAllNodes()}_rangeInfosChanged(e){null!=e&&e.length>0&&_.getLogger(this).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}_filterChange(){this.loadedGraphics.forEachNode((e=>this._filterNode(e)))}_reloadAllNodes(){this._removeAllNodeData(),this._controller&&this._controller.restartNodeLoading()}_filterNode(e){const t=this.parsedDefinitionExpression,i=this._excludeObjectIdsSorted,o=this._getObjectIdField();for(const a of e.graphics){const e=a.visible,n=!t||this._evaluateClause(t,a),l=null==i||G(i,a.attributes[o])<0;a.visible=n&&l,e!==a.visible&&(ye.graphic=a,ye.property="visible",ye.oldValue=e,ye.newValue=a.visible,this.processor.graphicsCore.graphicUpdateHandler(ye))}}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return null!=this.filter?this.filter.createQuery(e):new L(e)}queryFeatures(e,t){return this._queryEngine.executeQuery(this._ensureQuery(e),null==t?void 0:t.signal)}queryObjectIds(e,t){return this._queryEngine.executeQueryForIds(this._ensureQuery(e),null==t?void 0:t.signal)}queryFeatureCount(e,t){return this._queryEngine.executeQueryForCount(this._ensureQuery(e),null==t?void 0:t.signal)}queryExtent(e,t){return this._queryEngine.executeQueryForExtent(this._ensureQuery(e),null==t?void 0:t.signal)}_ensureQuery(e){return this._addDefinitionExpressionToQuery(null==e?this.createQuery():L.from(e))}_setupQueryEngine(){const e2=()=>this.processor.featureStore;this._queryEngine=new K({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return e2()},hasZ:this.hasZ,hasM:this.hasM},priority:R.FEATURE_QUERY_ENGINE})}get usedMemory(){var e,t;return(null==(t=null==(e=this.processor)?void 0:e.graphicsCore)?void 0:t.usedMemory)??0}get unloadedMemory(){var e,t,i;return.8*(((null==(e=this._controller)?void 0:e.unloadedMemoryEstimate)??0)+((null==(i=null==(t=this.processor)?void 0:t.graphicsCore)?void 0:i.unprocessedMemoryEstimate)??0))}get ignoresMemoryFactor(){return this._controller&&this._controller.fixedFeatureTarget}async _handleEdits(e){const t=this._attributeEditingContext,i=await J(t,e);ee(t,i)}get _attributeEditingContext(){const e=this._getObjectIdField(),t=this._getGlobalIdField();return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:e,globalIdField:t,forEachNode:e=>this.loadedGraphics.forEachNode((t=>e(t.node,t.featureIds))),attributeStorageInfo:this.i3slayer.attributeStorageInfo??[],i3sOverrides:this._i3sOverrides,getAttributeData:e=>this.getAttributeData(e),setAttributeData:(t,i,o)=>{this._setAttributeData(t,i);const a=this.loadedGraphics.getNode(t);if(null!=o){const t=this.loadedGraphics.get(o.attributes[e]);null!=t&&this.processor.graphicsCore.recreateGraphics([t])}else null!=a&&this.processor.graphicsCore.recreateGraphics(a.graphics)},clearMemCache:()=>{}}}get performanceInfo(){return new P(this.usedMemory,this.loadedGraphics.length,-1,this.maximumNumberOfFeatures,this.loadedGraphics.nodeCount,this.processor.graphicsCore.performanceInfo)}get test(){}};V([M()],pe.prototype,"processor",void 0),V([M({type:H})],pe.prototype,"filter",void 0),V([M()],pe.prototype,"loadedGraphics",void 0),V([M()],pe.prototype,"i3slayer",null),V([M()],pe.prototype,"_controller",void 0),V([M()],pe.prototype,"updating",void 0),V([M()],pe.prototype,"suspended",void 0),V([M()],pe.prototype,"holeFilling",void 0),V([M(Q)],pe.prototype,"updatingProgress",void 0),V([M()],pe.prototype,"updatingProgressValue",null),V([M(ce.requiredFields)],pe.prototype,"requiredFields",null),V([M(ce.availableFields)],pe.prototype,"availableFields",void 0),V([M()],pe.prototype,"_fieldsHelper",void 0),V([M({type:Number})],pe.prototype,"maximumNumberOfFeatures",null),V([M({readOnly:!0})],pe.prototype,"maximumNumberOfFeaturesExceeded",null),V([M()],pe.prototype,"_excludeObjectIdsSorted",null),V([M({readOnly:!0})],pe.prototype,"lodFactor",null),V([M({readOnly:!0})],pe.prototype,"hasM",null),V([M({readOnly:!0})],pe.prototype,"hasZ",null),V([M()],pe.prototype,"contentVisible",null),V([M({readOnly:!0})],pe.prototype,"legendEnabled",null),pe=V([q("esri.views.3d.layers.SceneLayerGraphicsView3D")],pe);const ge=pe;function ne(e){return"geometryBuffer"in e&&null!==e.geometryBuffer}function de(e){const t=e.attributeInfo,i=e.node.index;if(null!=(null==t?void 0:t.loadedAttributes)&&null!=t.attributeData)for(let o=0;o<e.graphics.length;o++){const a=e.graphics[o];if(a.nodeIndex===i){a.attributes||(a.attributes={});for(const{name:e}of t.loadedAttributes)t.attributeData[e]&&(a.attributes[e]=T(t.attributeData[e],o))}}}const me={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},_e=U(),ye={graphic:null,property:null,oldValue:null,newValue:null};export{ge as default};
