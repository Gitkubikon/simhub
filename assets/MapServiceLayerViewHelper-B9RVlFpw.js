const __vite__fileDeps=["assets/index-DSIPxOWi.js","assets/index-B_7YxLDX.css"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{fk as e,gr as t,gq as r,cJ as i,e as s,y as n,mD as u,gM as y,bj as c,az as d,I as h,gs as g,a as v,bk as w,fY as b,v as S,et as j,ja as F,a$ as E,fX as O,fW as I,bZ as P,S as N,h5 as _,bd as G,b as M,a0 as L,V as H,cD as J,gb as Q,_ as z,bJ as $,d9 as D,m as q,mE as k,ah as B,b3 as Z,mF as W,c4 as C,af as X}from"./index-DSIPxOWi.js";import{n as Y}from"./floorFilterUtils-2NbRkqHK.js";import{o as K}from"./drapedUtils-DOQFzwPw.js";import{R as ee}from"./normalizeUtils-BrH-PrZy.js";import{n as te}from"./sublayerUtils-DIUcTD2L.js";function o(s,n){const{dpi:u,gdbVersion:y,geometry:c,geometryPrecision:d,height:h,historicMoment:g,layerOption:v,mapExtent:w,maxAllowableOffset:b,returnFieldName:S,returnGeometry:j,returnUnformattedValues:F,returnZ:E,spatialReference:O,timeExtent:I,tolerance:P,width:N}=s.toJSON(),{dynamicLayers:_,layerDefs:G,layerIds:M}=function l(e){var t,s;const{mapExtent:n,floors:u,width:y,sublayers:c,layerIds:d,layerOption:h,gdbVersion:g}=e,v=null==(s=null==(t=null==c?void 0:c.find((e=>null!=e.layer)))?void 0:t.layer)?void 0:s.serviceSublayers,w="popup"===h,b={},S=r({extent:n,width:y,spatialReference:null==n?void 0:n.spatialReference}),j=[],x=e=>{const t=0===S,r=0===e.minScale||S<=e.minScale,i=0===e.maxScale||S>=e.maxScale;if(e.visible&&(t||r&&i))if(e.sublayers)e.sublayers.forEach(x);else{if(!1===(null==d?void 0:d.includes(e.id))||w&&(!e.popupTemplate||!e.popupEnabled))return;j.unshift(e)}};if(null==c||c.forEach(x),c&&!j.length)b.layerIds=[];else{const e=te(j,v,g),t=j.map((e=>{const t=Y(u,e);return e.toExportImageJSON(t)}));if(e)b.dynamicLayers=JSON.stringify(t);else{if(c){let e=j.map((({id:e})=>e));d&&(e=e.filter((e=>d.includes(e)))),b.layerIds=e}else(null==d?void 0:d.length)&&(b.layerIds=d);const e=function a$2(e,t){const r=!!(null==e?void 0:e.length),s=t.filter((e=>null!=e.definitionExpression||r&&null!=e.floorInfo));return s.length?s.map((t=>{const r=Y(e,t),s=i(r,t.definitionExpression);return{id:t.id,definitionExpression:s??void 0}})):null}(u,j);if(null!=e&&e.length){const t={};for(const r of e)r.definitionExpression&&(t[r.id]=r.definitionExpression);Object.keys(t).length&&(b.layerDefs=JSON.stringify(t))}}}return b}(s),L=null!=(null==n?void 0:n.geometry)?n.geometry:null,H={historicMoment:g,geometryPrecision:d,maxAllowableOffset:b,returnFieldName:S,returnGeometry:j,returnUnformattedValues:F,returnZ:E,tolerance:P},J=(null==L?void 0:L.toJSON())||c;H.imageDisplay=`${N},${h},${u}`,y&&(H.gdbVersion=y),J&&(delete J.spatialReference,H.geometry=JSON.stringify(J),H.geometryType=e(J));const Q=O??(null==J?void 0:J.spatialReference)??(null==w?void 0:w.spatialReference);if(Q&&(H.sr=t(Q)),H.time=I?[I.start,I.end].join(","):null,w){const{xmin:e,ymin:t,xmax:r,ymax:i}=w;H.mapExtent=`${e},${t},${r},${i}`}return G&&(H.layerDefs=G),_&&!G&&(H.dynamicLayers=_),H.layers="popup"===v?"visible":v,M&&!_&&(H.layers+=`:${M.join(",")}`),H}var re;let ie=re=class extends w{static from(e){return b(re,e)}constructor(e){super(e),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.historicMoment=null,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}writeHistoricMoment(e,t){t.historicMoment=e&&e.getTime()}};s([n({type:Number,json:{write:!0}})],ie.prototype,"dpi",void 0),s([n()],ie.prototype,"floors",void 0),s([n({type:String,json:{write:!0}})],ie.prototype,"gdbVersion",void 0),s([n({types:u,json:{read:y,write:!0}})],ie.prototype,"geometry",void 0),s([n({type:Number,json:{write:!0}})],ie.prototype,"geometryPrecision",void 0),s([n({type:Number,json:{write:!0}})],ie.prototype,"height",void 0),s([n({type:Date})],ie.prototype,"historicMoment",void 0),s([c("historicMoment")],ie.prototype,"writeHistoricMoment",null),s([n({type:[Number],json:{write:!0}})],ie.prototype,"layerIds",void 0),s([n({type:["top","visible","all","popup"],json:{write:!0}})],ie.prototype,"layerOption",void 0),s([n({type:d,json:{write:!0}})],ie.prototype,"mapExtent",void 0),s([n({type:Number,json:{write:!0}})],ie.prototype,"maxAllowableOffset",void 0),s([n({type:Boolean,json:{write:!0}})],ie.prototype,"returnFieldName",void 0),s([n({type:Boolean,json:{write:!0}})],ie.prototype,"returnGeometry",void 0),s([n({type:Boolean,json:{write:!0}})],ie.prototype,"returnM",void 0),s([n({type:Boolean,json:{write:!0}})],ie.prototype,"returnUnformattedValues",void 0),s([n({type:Boolean,json:{write:!0}})],ie.prototype,"returnZ",void 0),s([n({type:h,json:{write:!0}})],ie.prototype,"spatialReference",void 0),s([n()],ie.prototype,"sublayers",void 0),s([n({type:g,json:{write:!0}})],ie.prototype,"timeExtent",void 0),s([n({type:Number,json:{write:!0}})],ie.prototype,"tolerance",void 0),s([n({type:Number,json:{write:!0}})],ie.prototype,"width",void 0),ie=re=s([v("esri.rest.support.IdentifyParameters")],ie);const se=ie;let oe=class extends w{constructor(e){super(e),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(e,t){return S.fromJSON({attributes:{...t.attributes},geometry:{...t.geometry}})}writeFeature(e,t){if(!e)return;const{attributes:r,geometry:i}=e;r&&(t.attributes={...r}),null!=i&&(t.geometry=i.toJSON(),t.geometryType=F.toJSON(i.type))}};s([n({type:String,json:{write:!0}})],oe.prototype,"displayFieldName",void 0),s([n({type:S})],oe.prototype,"feature",void 0),s([j("feature",["attributes","geometry"])],oe.prototype,"readFeature",null),s([c("feature")],oe.prototype,"writeFeature",null),s([n({type:Number,json:{write:!0}})],oe.prototype,"layerId",void 0),s([n({type:String,json:{write:!0}})],oe.prototype,"layerName",void 0),oe=s([v("esri.rest.support.IdentifyResult")],oe);const ne=oe;async function f(e,t,r){const i=(t=function a(e){return se.from(e)}(t)).geometry?[t.geometry]:[],s=E(e);return s.path+="/identify",ee(i).then((e=>{const i=o(t,{geometry:null==e?void 0:e[0]}),n=O({...s.query,f:"json",...i}),u=I(n,r);return P(s.path,u).then(m).then((e=>function p(e,t){if(!(null==t?void 0:t.length))return e;const r=new Map;function o2(e){r.set(e.id,e),e.sublayers&&e.sublayers.forEach(o2)}t.forEach(o2);for(const i of e.results)i.feature.sourceLayer=r.get(i.layerId);return e}(e,t.sublayers)))}))}function m(e){const t=e.data;return t.results=t.results||[],t.exceededTransferLimit=Boolean(t.exceededTransferLimit),t.results=t.results.map((e=>ne.fromJSON(e))),t}let ae=null;function U(e,t){return"tile"===t.type||"map-image"===t.type}let le=class extends N{constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=_((async e=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch((()=>{})))}))}initialize(){const e2=e=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch((()=>{}))),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([G((()=>this.highlightGraphics),"change",(e=>e2(e.added)),{onListenerAdd:e=>e2(e)})])}async fetchPopupFeaturesAtLocation(e,t){var r,i;const{layerView:{layer:s,view:{scale:n}}}=this;if(!e)throw new M("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:s});const u=function R(e,t,r){const i=[];if(!e)return i;const i2=e=>{const s=0===e.minScale||t<=e.minScale,n=0===e.maxScale||t>=e.maxScale;if(e.visible&&s&&n)if(e.sublayers)e.sublayers.forEach(i2);else if(e.popupEnabled){const t=X(e,{...r,defaultPopupTemplateEnabled:!1});null!=t&&i.unshift({sublayer:e,popupTemplate:t})}};return e.map(i2),i}(s.sublayers,n,t);if(!u.length)return[];const y=await async function T(e,t){var r,i;if(null==(i=null==(r=e.capabilities)?void 0:r.operations)?void 0:i.supportsQuery)return!0;try{return await Promise.any(t.map((({sublayer:e})=>e.load().then((()=>e.capabilities.operations.supportsQuery)))))}catch{return!1}}(s,u);if(!(((null==(i=null==(r=s.capabilities)?void 0:r.operations)?void 0:i.supportsIdentify)??1)&&s.version>=10.5||y))throw new M("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:s});return y?this._fetchPopupFeaturesUsingQueries(e,u,t):this._fetchPopupFeaturesUsingIdentify(e,u,t)}clearHighlights(){var e;null==(e=this.highlightGraphics)||e.removeAll()}highlight(e){const t=this.highlightGraphics;if(!t)return L();let r=null;if(e instanceof S?r=[e]:H.isCollection(e)&&e.length>0?r=e.toArray():Array.isArray(e)&&e.length>0&&(r=e),r=null==r?void 0:r.filter(J),!(null==r?void 0:r.length))return L();for(const i of r){const e=i.sourceLayer;null!=e&&"geometryType"in e&&"point"===e.geometryType&&(i.visible=!1)}return t.addMany(r),L((()=>t.removeMany(r??[])))}async _updateHighlightedFeaturesSymbols(e){const{layerView:{view:t},highlightGraphics:r,highlightGraphicUpdated:i}=this;if(r&&i)for(const s of e){const e=s.sourceLayer&&"renderer"in s.sourceLayer&&s.sourceLayer.renderer;s.sourceLayer&&"geometryType"in s.sourceLayer&&"point"===s.sourceLayer.geometryType&&e&&"getSymbolAsync"in e&&e.getSymbolAsync(s).then((async n=>{var u;n||(n=new Q);let y=null;const c="visualVariables"in e?null==(u=e.visualVariables)?void 0:u.find((e=>"size"===e.type)):void 0;c&&(ae||(ae=(await z((async()=>{const{getSize:e}=await import("./index-DSIPxOWi.js").then((e=>e.yD));return{getSize:e}}),__vite__mapDeps([0,1]))).getSize),y=ae(c,s,{view:t.type,scale:t.scale,shape:"simple-marker"===n.type?n.style:null})),y||(y="width"in n&&"height"in n&&null!=n.width&&null!=n.height?Math.max(n.width,n.height):"size"in n?n.size:16),r.includes(s)&&(s.symbol=new Q({style:"square",size:y,xoffset:"xoffset"in n?n.xoffset:0,yoffset:"yoffset"in n?n.yoffset:0}),i(s,"symbol"),s.visible=!0)}))}}async _updateHighlightedFeaturesGeometries(e){const{layerView:{layer:t,view:r},highlightGraphics:i,highlightGraphicUpdated:s}=this;if(this._highlightGeometriesResolution=e,!s||!(null==i?void 0:i.length)||!t.capabilities.operations.supportsQuery)return;const n=this._getTargetResolution(e),u=new Map;for(const d of i)if(!this._featuresResolutions.has(d)||this._featuresResolutions.get(d)>n){const e=d.sourceLayer;$(u,e,(()=>new Map)).set(d.getObjectId(),d)}const y=Array.from(u,(([e,t])=>{const i=e.createQuery();return i.objectIds=[...t.keys()],i.outFields=[e.objectIdField],i.returnGeometry=!0,i.maxAllowableOffset=n,i.outSpatialReference=r.spatialReference,e.queryFeatures(i)})),c=await Promise.all(y);if(!this.destroyed)for(const{features:d}of c)for(const e of d){const t=e.sourceLayer,r=u.get(t).get(e.getObjectId());r&&i.includes(r)&&(r.geometry=e.geometry,s(r,"geometry"),this._featuresResolutions.set(r,n))}}_getTargetResolution(e){const t=e*D(this.layerView.view.spatialReference),r=t/16;return r<=10?0:e/t*r}async _fetchPopupFeaturesUsingIdentify(e,t,r){const i=await this._createIdentifyParameters(e,t,r);if(null==i)return[];const{results:s}=await f(this.layerView.layer.parsedUrl,i,r);return s.map((e=>e.feature))}async _createIdentifyParameters(e,t,r){const{floors:i,layer:s,timeExtent:n,view:{spatialReference:u,scale:y}}=this.layerView;if(!t.length)return null;await Promise.all(t.map((({sublayer:e})=>e.load(r).catch((()=>{})))));const c=Math.min(q("mapservice-popup-identify-max-tolerance"),s.allSublayers.reduce(((e,t)=>t.renderer?K({renderer:t.renderer,pointerType:null==r?void 0:r.pointerType}):e),2)),h=this.createFetchPopupFeaturesQueryGeometry(e,c),g=k(y,u),v=Math.round(h.width/g),w=new d({xmin:h.center.x-g*v,ymin:h.center.y-g*v,xmax:h.center.x+g*v,ymax:h.center.y+g*v,spatialReference:h.spatialReference});return new se({floors:i,gdbVersion:"gdbVersion"in s?s.gdbVersion:void 0,geometry:e,height:v,layerOption:"popup",mapExtent:w,returnGeometry:!0,spatialReference:u,sublayers:s.sublayers,timeExtent:n,tolerance:c,width:v})}async _fetchPopupFeaturesUsingQueries(e,t,r){const{layerView:{floors:s,timeExtent:n}}=this,u=t.map((async({sublayer:t,popupTemplate:u})=>{var y;if(await t.load(r).catch((()=>{})),t.capabilities&&!t.capabilities.operations.supportsQuery)return[];const c=t.createQuery(),d=K({renderer:t.renderer,pointerType:null==r?void 0:r.pointerType}),h=this.createFetchPopupFeaturesQueryGeometry(e,d),g=new Set,[v]=await Promise.all([B(t,u),null==(y=t.renderer)?void 0:y.collectRequiredFields(g,t.fieldsIndex)]);Z(r),W(g,t.fieldsIndex,v);const w=Array.from(g).sort();c.geometry=h,c.outFields=w,c.timeExtent=n;const b=Y(s,t);c.where=i(c.where,b);const S=this._getTargetResolution(h.width/d),j=await function A(e){var t;return(null==(t=e.expressionInfos)?void 0:t.length)||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type))?C():Promise.resolve()}(u);Z(r);const F="point"===t.geometryType||j&&j.arcadeUtils.hasGeometryOperations(u);F||(c.maxAllowableOffset=S);let{features:E}=await t.queryFeatures(c,r);const O=F?0:S;E=await async function V(e,t,r){const i=e.renderer;return i&&"defaultSymbol"in i&&!i.defaultSymbol&&(t=i.valueExpression?await Promise.all(t.map((e=>i.getSymbolAsync(e,r).then((t=>t?e:null))))).then((e=>e.filter((e=>null!=e)))):t.filter((e=>null!=i.getSymbol(e)))),t}(t,E,r);for(const e of E)this._featuresResolutions.set(e,O);return E}));return(await Promise.allSettled(u)).reduce(((e,t)=>"fulfilled"===t.status?[...e,...t.value]:e),[]).filter(J)}};s([n({constructOnly:!0})],le.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),s([n({constructOnly:!0})],le.prototype,"layerView",void 0),s([n({constructOnly:!0})],le.prototype,"highlightGraphics",void 0),s([n({constructOnly:!0})],le.prototype,"highlightGraphicUpdated",void 0),s([n({constructOnly:!0})],le.prototype,"updatingHandles",void 0),le=s([v("esri.views.layers.support.MapServiceLayerViewHelper")],le);export{U,le as _};
