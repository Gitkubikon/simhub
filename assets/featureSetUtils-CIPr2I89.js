const __vite__fileDeps=["assets/meshFeatureSet-BNHS2qnT.js","assets/index-DSIPxOWi.js","assets/index-B_7YxLDX.css","assets/Mesh-BS04vQSz.js","assets/MeshTransform-Y0ppddED.js","assets/vertexSpaceConversion-C_GU75pR.js","assets/External-Djr0rIk9.js","assets/infoFor3D-BTCPmnmy.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{I as i,g$ as r,hX as n,v as o,fe as u,fP as h,bD as _,q0 as y,m as w,a_ as S,gQ as C,_ as R,a2 as x,ia as U,b as W,q1 as V,gx as Q,l3 as Z,gr as z,bZ as J,gM as K,jP as X,jb as $,g_ as Y,jO as H,Z as ee,eO as te,i1 as ie}from"./index-DSIPxOWi.js";import{ay as se,az as ae,T as re,ap as ne,aq as le,ar as oe,as as ue,at as de,au as he,aF as ce,aG as fe,aH as pe,aI as _e,N as ye,aJ as ge,aK as me,B as we,aL as Fe,aM as be}from"./arcadeUtils-CHsZDnQG.js";import{O as Se,s as Ie,a as ve,n as Ce,t as Te,r as De}from"./WhereClause-DYd7Xwn9.js";import{x as ke,t as Re,g as xe,m as Ne,p as Le,y as Ae,A as Oe,w as Pe,E as Ee,T as je,S as qe,F as Ge,v as Ue,a as Be,D as Me,L as We,d as Ve,b as Qe,f as Ze,c as ze}from"./SpatialFilter-DZhILkSk.js";import{c as Je,a as Ke,n as Xe}from"./TimeOnly-C5lZbbIX.js";import{u as $e,i as Ye}from"./infoFor3D-BTCPmnmy.js";import{a as He,s as et}from"./executeQueryJSON-DDi8KdIf.js";import{n as tt}from"./executeQueryPBF-71YCUWAF.js";import"./AttachmentInfo-u2TyaLjZ.js";import{s as it,a as st}from"./executeForIds-vkxYbvNq.js";import"./normalizeUtilsCommon-BU8xfl77.js";import"./pbf-B53Txr8m.js";let at=class e{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(i,r,n){this._layerById[r]=n,this._layerByName[i]=n}async featureSetByName(i,r=!0,n=["*"]){return void 0===this._layerByName[i]?null:this._layerByName[i]}async featureSetById(i,r=!0,n=["*"]){return void 0===this._layerById[i]?null:this._layerById[i]}castToText(i=!1){return"object, FeatureSetCollection"}},rt=class c extends ke{constructor(i){super(i),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=i.parentfeatureset,i.whereclause instanceof Se?(this._whereclause=i.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=i.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types,this.subtypeField=this._parent.subtypeField,this.subtypes=this._parent.subtypes):(this.fields=[],this.typeIdField="",this.subtypeField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new i({wkid:4326}),this.geometryType=se.point)}async _getSet(i){if(null===this._wset){await this._ensureLoaded();const r=await this._parent._getFilteredSet("",null,this._whereclause,null,i);return this._checkCancelled(i),null!==this._whereClauseFunction?this._wset=new Re(r._candidates.slice(0).concat(r._known.slice(0)),[],r._ordered,this._clonePageDefinition(r.pagesDefinition)):this._wset=new Re(r._candidates.slice(0),r._known.slice(0),r._ordered,this._clonePageDefinition(r.pagesDefinition)),this._wset}return this._wset}_isInFeatureSet(i){var r;let n=null==(r=this._parent)?void 0:r._isInFeatureSet(i);return n===ae.NotInFeatureSet?n:(n=this._idstates[i],void 0===n?ae.Unknown:n)}_getFeature(i,r,n){return this._parent._getFeature(i,r,n)}_getFeatures(i,r,n,o){return this._parent._getFeatures(i,r,n,o)}_featureFromCache(i){return this._parent._featureFromCache(i)}executeWhereClause(i){var r;return(null==(r=this._whereclause)?void 0:r.testFeature(i))??!1}async executeWhereClauseDeferred(i){if(null!==this._whereClauseFunction){const n=this._whereClauseFunction(i);return r(n),n}return this.executeWhereClause(i)}async _fetchAndRefineFeatures(i,r,n){var o,u,h;const _=new Re([],i,!1,null),y=Math.min(r,i.length);if(await(null==(o=this._parent)?void 0:o._getFeatures(_,-1,y,n)),this._checkCancelled(n),null==this._whereClauseFunction){for(let r=0;r<y;r++){const n=null==(u=this._parent)?void 0:u._featureFromCache(i[r]);!0===this.executeWhereClause(n)?this._idstates[i[r]]=ae.InFeatureSet:this._idstates[i[r]]=ae.NotInFeatureSet}return"success"}const w=[];for(let S=0;S<y;S++){const r=null==(h=this._parent)?void 0:h._featureFromCache(i[S]);w.push(await this.executeWhereClauseDeferred(r))}for(let S=0;S<r;S++)!0===w[S]?this._idstates[i[S]]=ae.InFeatureSet:this._idstates[i[S]]=ae.NotInFeatureSet;return"success"}async _getFilteredSet(i,r,n,o,u){null!==this._whereClauseFunction||(null!==n?null!==this._whereclause&&(n=xe(this._whereclause,n)):n=this._whereclause),await this._ensureLoaded();const h=await this._parent._getFilteredSet(i,r,n,o,u);let _;return this._checkCancelled(u),_=null!==this._whereClauseFunction?new Re(h._candidates.slice(0).concat(h._known.slice(0)),[],h._ordered,this._clonePageDefinition(h.pagesDefinition)):new Re(h._candidates.slice(0),h._known.slice(0),h._ordered,this._clonePageDefinition(h.pagesDefinition)),_}async _stat(i,r,n,o,u,h,_){if(null!==this._whereClauseFunction)return null===u&&""===n&&null===o?this._manualStat(i,r,h,_):{calculated:!1};let y=this._whereclause;null!==u&&null!==this._whereclause&&(y=xe(this._whereclause,u));const w=await this._parent._stat(i,r,n,o,y,h,_);return!1===w.calculated?null===u&&""===n&&null===o?this._manualStat(i,r,h,_):{calculated:!1}:w}async _canDoAggregates(i,r,n,o,u){return null===this._whereClauseFunction&&(null!==u?null!==this._whereclause&&(u=xe(this._whereclause,u)):u=this._whereclause,null!==this._parent&&this._parent._canDoAggregates(i,r,n,o,u))}async _getAggregatePagesDataSourceDefinition(i,r,n,o,u,h,_){if(null===this._parent)throw new Ie(ve.NeverReach);return null!==u?null!==this._whereclause&&(u=xe(this._whereclause,u)):u=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(i,r,n,o,u,h,_)}static registerAction(){ke._featuresetFunctions.filter=function(i){if("function"==typeof i)return new c({parentfeatureset:this,whereclause:i});let r=null;return i instanceof Se&&(r=i),new c({parentfeatureset:this,whereclause:r})}}getFieldsIndex(){return this._parent.getFieldsIndex()}},nt=class D{constructor(i){this.field=i,this.sqlRewritable=!1}postInitialization(i,r){}};class I extends nt{constructor(i){super(i),this.sqlRewritable=!0}extractValue(i){return i.attributes[this.field.name]}rewriteSql(i){return{rewritten:this.sqlRewritable,where:i}}}let lt=class k extends nt{constructor(i,r,n){super(re(i)),this.originalField=i,this.sqlRewritable=!0,this.field.name=r,this.field.alias=n}rewriteSql(i,r){return{rewritten:this.sqlRewritable,where:Ne(i,this.field.name,this.originalField.name,r.getFieldsIndex())}}extractValue(i){return i.attributes[this.originalField.name]}},ot=class b extends nt{constructor(i,r,n){super(i),this.codefield=r,this.lkp=n,this.reverseLkp={};for(const o in n)this.reverseLkp[n[o]]=o;this.sqlRewritable=!0}rewriteSql(i,r){const n=this.evaluateNodeToWhereClause(i.parseTree,ne.Standardised,this.field.name,this.codefield instanceof Se?Le(this.codefield,ne.Standardised):this.codefield,i.parameters);return n.includes(b.BADNESS)?{rewritten:!1,where:i}:{rewritten:this.sqlRewritable,where:Se.create(n,r._parent.getFieldsIndex(),r.dateFieldsTimeZoneDefaultUTC)}}evaluateNodeToWhereClause(i,r,n=null,o=null,u){let h,_,y,w;switch(i.type){case"interval":return Ge(this.evaluateNodeToWhereClause(i.value,r,n,o,u),i.qualifier,i.op);case"case-expression":{let o=" CASE ";"simple"===i.format&&(o+=this.evaluateNodeToWhereClause(i.operand,r,n,b.BADNESS,u));for(let h=0;h<i.clauses.length;h++)o+=" WHEN "+this.evaluateNodeToWhereClause(i.clauses[h].operand,r,n,b.BADNESS,u)+" THEN "+this.evaluateNodeToWhereClause(i.clauses[h].value,r,n,b.BADNESS,u);return null!==i.else&&(o+=" ELSE "+this.evaluateNodeToWhereClause(i.else,r,n,b.BADNESS,u)),o+=" END ",o}case"parameter":{const n=u[i.value.toLowerCase()];if("string"==typeof n)return"'"+n.toString().replaceAll("'","''")+"'";if(le(n))return Pe(n,r);if(oe(n))return Pe(n,r);if(ue(n))return Ee(n,r);if(de(n))return je(n,r);if(he(n))return qe(n,r);if(Array.isArray(n)){const i=[];for(let o=0;o<n.length;o++)"string"==typeof n[o]?i.push("'"+n[o].toString().replaceAll("'","''")+"'"):le(n[o])||oe(n[o])?i.push(Pe(n[o],r)):ue(n[o])?i.push(Ee(n[o],r)):de(n[o])?i.push(je(n[o],r)):he(n[o])?i.push(qe(n[o],r)):i.push(n[o].toString());return i}return n.toString()}case"expression-list":_=[];for(const h of i.value)_.push(this.evaluateNodeToWhereClause(h,r,n,o,u));return _;case"unary-expression":return" ( NOT "+this.evaluateNodeToWhereClause(i.expr,r,n,b.BADNESS,u)+" ) ";case"binary-expression":switch(i.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(i.left,r,n,o,u)+" AND "+this.evaluateNodeToWhereClause(i.right,r,n,o,u)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(i.left,r,n,o,u)+" OR "+this.evaluateNodeToWhereClause(i.right,r,n,o,u)+") ";case"IS":if("null"!==i.right.type)throw new Ce(Te.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(i.left,r,n,o,u)+" IS NULL )";case"ISNOT":if("null"!==i.right.type)throw new Ce(Te.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(i.left,r,n,o,u)+" IS NOT NULL )";case"IN":if(h=[],"expression-list"===i.right.type){if("column-reference"===i.left.type&&i.left.column.toUpperCase()===this.field.name.toUpperCase()){const h=[];let _=!0;for(const r of i.right.value){if("string"!==r.type){_=!1;break}if(void 0===this.lkp[r.value]){_=!1;break}h.push(this.lkp[r.value].toString())}if(_)return" ("+this.evaluateNodeToWhereClause(i.left,r,n,o,u)+" IN ("+h.join(",")+")) "}return h=this.evaluateNodeToWhereClause(i.right,r,n,o,u)," ("+this.evaluateNodeToWhereClause(i.left,r,n,o,u)+" IN ("+h.join(",")+")) "}return w=this.evaluateNodeToWhereClause(i.right,r,n,o,u),Array.isArray(w)?" ("+this.evaluateNodeToWhereClause(i.left,r,n,o,u)+" IN ("+w.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(i.left,r,n,o,u)+" IN ("+w+")) ";case"NOT IN":if(h=[],"expression-list"===i.right.type){if("column-reference"===i.left.type&&i.left.column.toUpperCase()===this.field.name.toUpperCase()){const h=[];let _=!0;for(const r of i.right.value){if("string"!==r.type){_=!1;break}if(void 0===this.lkp[r.value]){_=!1;break}h.push(this.lkp[r.value].toString())}if(_)return" ("+this.evaluateNodeToWhereClause(i.left,r,n,o,u)+" NOT IN ("+h.join(",")+")) "}return h=this.evaluateNodeToWhereClause(i.right,r,n,o,u)," ("+this.evaluateNodeToWhereClause(i.left,r,n,o,u)+" NOT IN ("+h.join(",")+")) "}return w=this.evaluateNodeToWhereClause(i.right,r,n,o,u),Array.isArray(w)?" ("+this.evaluateNodeToWhereClause(i.left,r,n,o,u)+" NOT IN ("+w.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(i.left,r,n,o,u)+" NOT IN ("+w+")) ";case"BETWEEN":return y=this.evaluateNodeToWhereClause(i.right,r,n,b.BADNESS,u)," ("+this.evaluateNodeToWhereClause(i.left,r,n,b.BADNESS,u)+" BETWEEN "+y[0]+" AND "+y[1]+" ) ";case"NOTBETWEEN":return y=this.evaluateNodeToWhereClause(i.right,r,n,b.BADNESS,u)," ("+this.evaluateNodeToWhereClause(i.left,r,n,b.BADNESS,u)+" NOT BETWEEN "+y[0]+" AND "+y[1]+" ) ";case"LIKE":return""!==i.escape?" ("+this.evaluateNodeToWhereClause(i.left,r,n,b.BADNESS,u)+" LIKE "+this.evaluateNodeToWhereClause(i.right,r,n,b.BADNESS,u)+" ESCAPE '"+i.escape+"') ":" ("+this.evaluateNodeToWhereClause(i.left,r,n,b.BADNESS,u)+" LIKE "+this.evaluateNodeToWhereClause(i.right,r,n,b.BADNESS,u)+") ";case"NOT LIKE":return""!==i.escape?" ("+this.evaluateNodeToWhereClause(i.left,r,n,b.BADNESS,u)+" NOT LIKE "+this.evaluateNodeToWhereClause(i.right,r,n,b.BADNESS,u)+" ESCAPE '"+i.escape+"') ":" ("+this.evaluateNodeToWhereClause(i.left,r,n,b.BADNESS,u)+" NOT LIKE "+this.evaluateNodeToWhereClause(i.right,r,n,b.BADNESS,u)+") ";case"<>":case"=":if("column-reference"===i.left.type&&"string"===i.right.type){if(i.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[i.right.value.toString()])return" ("+o+" "+i.operator+" "+this.lkp[i.right.value.toString()].toString()+") "}else if("column-reference"===i.right.type&&"string"===i.left.type&&i.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[i.right.value.toString()].toString()+" "+i.operator+" "+o+") ";return" ("+this.evaluateNodeToWhereClause(i.left,r,n,b.BADNESS,u)+" "+i.operator+" "+this.evaluateNodeToWhereClause(i.right,r,n,b.BADNESS,u)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":case"||":return" ("+this.evaluateNodeToWhereClause(i.left,r,n,b.BADNESS,u)+" "+i.operator+" "+this.evaluateNodeToWhereClause(i.right,r,n,b.BADNESS,u)+") "}case"null":return"null";case"boolean":return!0===i.value?"1":"0";case"string":return"'"+i.value.toString().replaceAll("'","''")+"'";case"timestamp":return`timestamp '${i.value}'`;case"date":return`date '${i.value}'`;case"time":return`time '${i.value}'`;case"number":return i.value.toString();case"current-time":return Oe("date"===i.mode,r);case"column-reference":return n&&n.toLowerCase()===i.column.toLowerCase()?"("+o+")":i.column;case"data-type":return i.value;case"function":{const o=this.evaluateNodeToWhereClause(i.args,r,n,b.BADNESS,u);return Ae(i.name,o,r)}}throw new Ce(Te.UnsupportedSyntax,{node:i.type})}extractValue(i){return this.codefield instanceof Se?this.reverseLkp[Se.convertValueToStorageFormat(this.codefield.calculateValueCompiled(i))]:this.reverseLkp[i.attributes[this.codefield]]}};ot.BADNESS="_!!!_BAD_LKP_!!!!";class B extends nt{constructor(i,r){super(i),this._sql=r}rewriteSql(i,r){return{rewritten:!0,where:Ne(i,this.field.name,Le(this._sql,ne.Standardised),r.getFieldsIndex())}}extractValue(i){return Se.convertValueToStorageFormat(this._sql.calculateValueCompiled(i),this.field.type)}}class L extends ke{static findField(i,r){for(const n of i)if(n.name.toLowerCase()===r.toString().toLowerCase())return n;return null}constructor(i){super(i),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=[],this._extraFilter=null,this._extraFilter=i.extraFilter,this._parent=i.parentfeatureset,this._maxProcessing=30,this.adaptedFields=i.adaptedFields}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new i({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=se.point,this.typeIdField="",this.types=null,this.subtypeField=null,this.subtypes=null),this.fields=[];for(const i of this.adaptedFields)i.postInitialization(this,this._parent),this.fields.push(i.field)}async _getSet(i){var r;if(null===this._wset){await this._ensureLoaded();let o=null;return o=this._extraFilter?await this._getFilteredSet("",null,null,null,i):await(null==(r=this._parent)?void 0:r._getSet(i)),this._checkCancelled(i),n(o),this._wset=new Re(o._candidates.slice(0),o._known.slice(0),o._ordered,this._clonePageDefinition(o.pagesDefinition)),this._wset}return this._wset}_isInFeatureSet(i){return this._parent._isInFeatureSet(i)}async _getFeatures(i,r,n,u){var h,_;const y=[];-1!==r&&void 0===this._featureCache[r]&&y.push(r);const w=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(i,w))return await this._expandPagedSet(i,w,0,0,u),this._getFeatures(i,r,n,u);let S=0;for(let o=i._lastFetchedIndex;o<i._known.length&&(S++,S<=n&&(i._lastFetchedIndex+=1),!(void 0===this._featureCache[i._known[o]]&&(i._known[o]!==r&&y.push(i._known[o]),y.length>=w)));o++);if(0===y.length)return"success";i=new Re([],y,i._ordered,null);const C=Math.min(y.length,n);await(null==(h=this._parent)?void 0:h._getFeatures(i,-1,C,u)),this._checkCancelled(u);const R=[];for(let o=0;o<C;o++){const i=null==(_=this._parent)?void 0:_._featureFromCache(y[o]);void 0!==i&&R.push({geometry:i.geometry,attributes:i.attributes,id:y[o]})}for(const x of R){const i=[];for(const r of this.adaptedFields)i[r.field.name]=r.extractValue(x);this._featureCache[x.id]=new o({attributes:i,geometry:Je(x.geometry)})}return"success"}async _fetchAndRefineFeatures(){throw new Ie(ve.NeverReach)}async _getFilteredSet(i,r,n,o,u){let h=!1;const _=this._reformulateWithoutAdaptions(n);h=_.cannot,n=_.where;let y=!1;if(null!==o){y=!0;const i=[];for(const r of this.adaptedFields)if(!(r instanceof I)&&!0===o.scanForField(r.field.name)){if(!(r instanceof lt)){o=null,y=!1;break}i.push({field:r.field.name,newfield:r.originalField.name})}o&&i.length>0&&(o=o.replaceFields(i))}null!==n?null!==this._extraFilter&&(n=xe(this._extraFilter,n)):n=this._extraFilter,await this._ensureLoaded();const w=await this._parent._getFilteredSet(i,r,n,o,u);let S;return this._checkCancelled(u),S=!0===h?new Re(w._candidates.slice(0).concat(w._known.slice(0)),[],!0===y&&w._ordered,this._clonePageDefinition(w.pagesDefinition)):new Re(w._candidates.slice(0),w._known.slice(0),!0===y&&w._ordered,this._clonePageDefinition(w.pagesDefinition)),S}_reformulateWithoutAdaptions(i){const r={cannot:!1,where:i};if(null!==i)for(const n of this.adaptedFields)if(!0===Ue(i,n.field.name)){const o=n.rewriteSql(i,this);if(!0!==o.rewritten){r.cannot=!0,r.where=null;break}r.where=o.where}return r}async _stat(i,r,n,o,u,h,_){let y=!1,w=this._reformulateWithoutAdaptions(r);if(y=w.cannot,r=w.where,w=this._reformulateWithoutAdaptions(u),y=y||w.cannot,null!==(u=w.where)?null!==this._extraFilter&&(u=xe(this._extraFilter,u)):u=this._extraFilter,!0===y)return null===u&&""===n&&null===o?this._manualStat(i,r,h,_):{calculated:!1};const S=await this._parent._stat(i,r,n,o,u,h,_);return!1===S.calculated?null===u&&""===n&&null===o?this._manualStat(i,r,h,_):{calculated:!1}:S}async _canDoAggregates(i,r,n,o,u){if(null===this._parent)return!1;for(let y=0;y<i.length;y++)for(const r of this.adaptedFields)if(i[y].toLowerCase()===r.field.name.toLowerCase()&&!(r instanceof I))return!1;const h=[];for(let y=0;y<r.length;y++){const i=r[y];if(null!==i.workingexpr){const r=this._reformulateWithoutAdaptions(i.workingexpr);if(r.cannot)return!1;const n=i.clone();n.workingexpr=r.where,h.push(n)}else h.push(i)}const _=this._reformulateWithoutAdaptions(u);return!_.cannot&&(null!==(u=_.where)?null!==this._extraFilter&&(u=xe(this._extraFilter,u)):u=this._extraFilter,this._parent._canDoAggregates(i,h,n,o,u))}async _getAggregatePagesDataSourceDefinition(i,r,n,o,u,h,_){if(null===this._parent)throw new Ie(ve.NeverReach);const y=[];for(let S=0;S<r.length;S++){const i=r[S];if(null!==i.workingexpr){const r=this._reformulateWithoutAdaptions(i.workingexpr);if(r.cannot)throw new Ie(ve.NeverReach);const n=i.clone();n.workingexpr=r.where,y.push(n)}else y.push(i)}const w=this._reformulateWithoutAdaptions(u);if(w.cannot)throw new Ie(ve.NeverReach);return null!==(u=w.where)?null!==this._extraFilter&&(u=xe(this._extraFilter,u)):u=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(i,y,n,o,u,h,_)}}function t(i,r){return i===r?0:null===i?-1:null===r?1:i<r?-1:1}class e2{constructor(i){const r=i.split(",");this._fields=[],this._directions=[];for(let n=0;n<r.length;n++){const i=r[n].match(/\S+/g);this._fields.push(i[0]),2===i.length?"asc"===i[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let i="";for(let r=0;r<this._fields.length;r++)0!==r&&(i+=","),i+=this._fields[r],1===this._directions[r]?i+=" ASC":i+=" DESC";return i}order(i){i.sort(((i,r)=>{for(let n=0;n<this._fields.length;n++){const o=this.featureValue(i.feature,this._fields[n],n),u=this.featureValue(r.feature,this._fields[n],n);let h=0;if(h=1===this._directions[n]?t(o,u):-1*t(o,u),0!==h)return h}return 0}))}scanForField(i){for(let r=0;r<this._fields.length;r++)if(this._fields[r].toLowerCase().trim()===i.toLowerCase().trim())return!0;return!1}replaceFields(i){let r="";for(let n=0;n<this._fields.length;n++){0!==n&&(r+=",");let o=this._fields[n];for(const r of i)if(o.toLowerCase()===r.field.toLowerCase()){o=r.newfield;break}r+=o,1===this._directions[n]?r+=" ASC":r+=" DESC"}return new e2(r)}featureValue(i,r,n){const o=i.attributes[r];if(void 0!==o)return o;for(const u in i.attributes)if(r.toLowerCase()===u.toLowerCase())return this._fields[n]=u,i.attributes[u];return null}}let ut=class a extends ke{constructor(i){super(i),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=i.orderbyclause,this._parent=i.parentfeatureset}async _getSet(i){if(null===this._wset){await this._ensureLoaded();const r=await this._getFilteredSet("",null,null,this._orderbyclause,i);return this._checkCancelled(i),this._wset=r,this._wset}return this._wset}async manualOrderSet(i,r){var n;const o=await this.getIdColumnDictionary(i,[],-1,r);null==(n=this._orderbyclause)||n.order(o);const u=new Re([],[],!0,null);for(let h=0;h<o.length;h++)u._known.push(o[h].id);return u}async getIdColumnDictionary(i,r,n,o){if(n<i._known.length-1){const u=this._maxQueryRate();if("GETPAGES"===i._known[n+1])return await ce(this._parent._expandPagedSet(i,u,0,0,o)),this.getIdColumnDictionary(i,r,n,o);let h=n+1;const _=[];for(;h<i._known.length&&"GETPAGES"!==i._known[h];)_.push(i._known[h]),h++;n+=_.length;const y=await ce(this._parent._getFeatureBatch(_,o));this._checkCancelled(o);for(const i of y)r.push({id:i.attributes[this.objectIdField],feature:i});return this.getIdColumnDictionary(i,r,n,o)}return i._candidates.length>0?(await ce(this._refineSetBlock(i,this._maxProcessingRate(),o)),this._checkCancelled(o),this.getIdColumnDictionary(i,r,n,o)):r}_isInFeatureSet(i){return this._parent._isInFeatureSet(i)}_getFeatures(i,r,n,o){return this._parent._getFeatures(i,r,n,o)}_featureFromCache(i){if(void 0===this._featureCache[i]){const r=this._parent._featureFromCache(i);if(void 0===r)return;return null===r?null:(this._featureCache[i]=r,r)}return this._featureCache[i]}async _fetchAndRefineFeatures(){throw new Ie(ve.NeverReach)}async _getFilteredSet(i,r,n,o,u){await this._ensureLoaded();const h=await this._parent._getFilteredSet(i,r,n,null===o?this._orderbyclause:o,u);this._checkCancelled(u);const _=new Re(h._candidates.slice(0),h._known.slice(0),h._ordered,this._clonePageDefinition(h.pagesDefinition));let y=!0;if(h._candidates.length>0&&(y=!1),!1===_._ordered){let i=await this.manualOrderSet(_,u);return!1===y&&(null===r&&null===n||(i=new Re(i._candidates.slice(0).concat(i._known.slice(0)),[],i._ordered,this._clonePageDefinition(i.pagesDefinition)))),i}return _}static registerAction(){ke._featuresetFunctions.orderBy=function(i){return""===i?this:new a({parentfeatureset:this,orderbyclause:new e2(i)})}}getFieldsIndex(){return this._parent.getFieldsIndex()}};let dt=class a2{constructor(){this.field="",this.tofieldname="",this.typeofstat="MIN",this.workingexpr=null}clone(){const i=new a2;return i.field=this.field,i.tofieldname=this.tofieldname,i.typeofstat=this.typeofstat,i.workingexpr=this.workingexpr,i}static parseStatField(i,r,n,o){const u=new a2;u.field=i;const h=Se.create(r,n,o),_=function s(i){if("function"===i.parseTree.type){if(0===i.parseTree.args.value.length)return{name:i.parseTree.name,expr:null};if(i.parseTree.args.value.length>1)throw new Ce(Te.MissingStatisticParameters);const r=Se.create(Be(i.parseTree.args.value[0],ne.Standardised,i.parameters),i.fieldsIndex,i.timeZone);return{name:i.parseTree.name,expr:r}}return null}(h);if(null===_)throw new Ce(Te.UnsupportedSqlFunction,{function:""});const y=_.name.toUpperCase().trim();if("MIN"===y){if(u.typeofstat="MIN",u.workingexpr=_.expr,null===h)throw new Ce(Te.InvalidFunctionParameters,{function:"min"})}else if("MAX"===y){if(u.typeofstat="MAX",u.workingexpr=_.expr,null===h)throw new Ce(Te.InvalidFunctionParameters,{function:"max"})}else if("COUNT"===y)u.typeofstat="COUNT",u.workingexpr=_.expr;else if("STDEV"===y){if(u.typeofstat="STDDEV",u.workingexpr=_.expr,null===h)throw new Ce(Te.InvalidFunctionParameters,{function:"stdev"})}else if("SUM"===y){if(u.typeofstat="SUM",u.workingexpr=_.expr,null===h)throw new Ce(Te.InvalidFunctionParameters,{function:"sum"})}else if("MEAN"===y){if(u.typeofstat="AVG",u.workingexpr=_.expr,null===h)throw new Ce(Te.InvalidFunctionParameters,{function:y})}else if("AVG"===y){if(u.typeofstat="AVG",u.workingexpr=_.expr,null===h)throw new Ce(Te.InvalidFunctionParameters,{function:"avg"})}else{if("VAR"!==y)throw new Ce(Te.UnsupportedSqlFunction,{function:y});if(u.typeofstat="VAR",u.workingexpr=_.expr,null===h)throw new Ce(Te.InvalidFunctionParameters,{function:"var"})}return u}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}};function G$1(i){if(!i)return"COUNT";switch(i.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class a3 extends ke{constructor(i){super(i),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=i.topnum,this._parent=i.parentfeatureset}async _getSet(i){if(null===this._wset){await this._ensureLoaded();const r=await this._parent._getSet(i);return this._wset=new Re(r._candidates.slice(0),r._known.slice(0),!1,this._clonePageDefinition(r.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset}return this._wset}_setKnownLength(i){return i._known.length>0&&"GETPAGES"===i._known[i._known.length-1]?i._known.length-1:i._known.length}_isInFeatureSet(i){const r=this._parent._isInFeatureSet(i);if(r===ae.NotInFeatureSet)return r;const n=this._idstates[i];return n===ae.InFeatureSet||n===ae.NotInFeatureSet?n:r===ae.InFeatureSet&&void 0===n?this._countedin<this._topnum?(this._idstates[i]=ae.InFeatureSet,this._countedin++,ae.InFeatureSet):(this._idstates[i]=ae.NotInFeatureSet,ae.NotInFeatureSet):ae.Unknown}async _expandPagedSet(i,r,n,o,u){if(null===this._parent)throw new Ie(ve.NotImplemented);if(r>this._topnum&&(r=this._topnum),this._countedin>=this._topnum&&i.pagesDefinition.internal.set.length<=i.pagesDefinition.resultOffset){let r=i._known.length;return r>0&&"GETPAGES"===i._known[r-1]&&(i._known.length=r-1),r=i._candidates.length,r>0&&"GETPAGES"===i._candidates[r-1]&&(i._candidates.length=r-1),"success"}const h=await this._parent._expandPagedSet(i,r,n,o,u);return this._setKnownLength(i)>this._topnum&&(i._known.length=this._topnum),this._setKnownLength(i)>=this._topnum&&(i._candidates.length=0),h}async _getFeatures(i,r,n,o){const u=[],h=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(i,h))return await this._expandPagedSet(i,h,0,0,o),this._getFeatures(i,r,n,o);-1!==r&&void 0===this._featureCache[r]&&u.push(r);let _=0;for(let S=i._lastFetchedIndex;S<i._known.length&&(_++,_<=n&&(i._lastFetchedIndex+=1),!(void 0===this._featureCache[i._known[S]]&&(i._known[S]!==r&&u.push(i._known[S]),u.length>h)));S++);if(0===u.length)return"success";const y=new Re([],u,!1,null),w=Math.min(u.length,n);await this._parent._getFeatures(y,-1,w,o);for(let S=0;S<w;S++){const i=this._parent._featureFromCache(u[S]);void 0!==i&&(this._featureCache[u[S]]=i)}return"success"}async _getFilteredSet(i,r,n,o,u){await this._ensureLoaded();const h=await this._getSet(u);return new Re(h._candidates.slice(0).concat(h._known.slice(0)),[],!1,this._clonePageDefinition(h.pagesDefinition))}_refineKnowns(i,r){let n=0,o=null;const u=[];for(let h=0;h<i._candidates.length;h++){const _=this._isInFeatureSet(i._candidates[h]);if(_===ae.InFeatureSet){if(i._known.push(i._candidates[h]),n+=1,null===o?o={start:h,end:h}:o.end===h-1?o.end=h:(u.push(o),o={start:h,end:h}),i._known.length>=this._topnum)break}else if(_===ae.NotInFeatureSet)null===o?o={start:h,end:h}:o.end===h-1?o.end=h:(u.push(o),o={start:h,end:h}),n+=1;else if(_===ae.Unknown)break;if(n>=r)break}null!==o&&u.push(o);for(let h=u.length-1;h>=0;h--)i._candidates.splice(u[h].start,u[h].end-u[h].start+1);this._setKnownLength(i)>this._topnum&&(i._known=i._known.slice(0,this._topnum)),this._setKnownLength(i)>=this._topnum&&(i._candidates=[])}async _stat(){return{calculated:!1}}async _canDoAggregates(){return!1}static registerAction(){ke._featuresetFunctions.top=function(i){return new a3({parentfeatureset:this,topnum:i})}}getFieldsIndex(){return this._parent.getFieldsIndex()}}async function f(i,r,n,o){return async function m(i,r,n,o){var u;const h=null==n?void 0:n.infoFor3D;if(!d$2(i,h)||null==h||!r.assetMaps||!(null==(u=r.features)?void 0:u.length))return S.fromJSON(r);const{meshFeatureSetFromJSON:_}=await C(R((()=>import("./meshFeatureSet-BNHS2qnT.js")),__vite__mapDeps([0,1,2,3,4,5,6,7])),o);return _(i,h,r)}(r,await async function c2(i,r,n,o){var u;const h={...o},_=function p(i,r){let n=x.from(i);n.sourceSpatialReference=n.sourceSpatialReference??(null==r?void 0:r.sourceSpatialReference)??null,((null==r?void 0:r.gdbVersion)||(null==r?void 0:r.dynamicDataSource))&&(n=n===i?n.clone():n,n.gdbVersion=i.gdbVersion||r.gdbVersion,n.dynamicDataSource=i.dynamicDataSource?U.from(i.dynamicDataSource):r.dynamicDataSource);const o=null==r?void 0:r.infoFor3D;if(null!=o&&d$2(i,o)){n=n===i?n.clone():n,n.formatOf3DObjects=null;const{supportedFormats:r,queryFormats:u}=o,h=$e("model/gltf-binary",r)??Ye("glb",r),_=$e("model/gltf+json",r)??Ye("gtlf",r);for(const i of u){if(i===h){n.formatOf3DObjects=i;break}i!==_||n.formatOf3DObjects||(n.formatOf3DObjects=i)}if(!n.formatOf3DObjects)throw new W("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(null==n.outFields||!n.outFields.includes("*")){n=n===i?n.clone():n,null==n.outFields&&(n.outFields=[]);const{originX:r,originY:u,originZ:h,translationX:_,translationY:y,translationZ:w,scaleX:S,scaleY:C,scaleZ:R,rotationX:x,rotationY:U,rotationZ:W,rotationDeg:V}=o.transformFieldRoles;n.outFields.push(r,u,h,_,y,w,S,C,R,x,U,W,V)}}return n}(r,n),y=null!=(null==(u=r.outStatistics)?void 0:u[0]),S=w("featurelayer-pbf-statistics"),C=!y||S;let R;if("pbf"===(null==n?void 0:n.format)&&C)try{R=await tt(i,_,h)}catch(V){if("query:parsing-pbf"!==V.name)throw V;n.format="json"}return"json"!==(null==n?void 0:n.format)&&C||(R=await He(i,_,h)),function l(i,r){if(null!=i&&null!=r)for(const n of r){const r=i.get(n.name);r&&Object.assign(n,r.toJSON())}}(null==n?void 0:n.fieldsIndex,R.fields),R}(i,r,n,o),n,o)}function d$2(i,r){return null!=r&&!0===i.returnGeometry&&"xyFootprint"!==i.multipatchOption&&!i.outStatistics}class P extends ke{constructor(i){super(i),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,i.spatialReference&&(this.spatialReference=i.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=i.layer,this._wset=null,void 0!==i.outFields&&(this._overrideFields=i.outFields),void 0!==i.includeGeometry&&(this._removeGeometry=!1===i.includeGeometry)}_maxQueryRate(){return fe}end(){return this._layer}optimisePagingFeatureQueries(i){this._pageJustIds=i}get urlQueryPath(){return this._layer.parsedUrl.path||""}convertQueryToLruCacheKey(i){const r=this.urlQueryPath+","+pe(i.toJSON());return _(r,y.String)}async loadImpl(){return!0===this._layer.loaded?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}_initialiseFeatureSet(){var i,r,n,o,u,h;if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this.hasZ=!0===(null==(n=null==(r=null==(i=this._layer)?void 0:i.capabilities)?void 0:r.data)?void 0:n.supportsZ),this.hasM=!0===(null==(h=null==(u=null==(o=this._layer)?void 0:o.capabilities)?void 0:u.data)?void 0:h.supportsM),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const i=[],r=[];for(const n of this.fields)if("oid"===n.type)i.push(n),r.push(n.name);else for(const o of this._overrideFields)if(o.toLowerCase()===n.name.toLowerCase()){i.push(n),r.push(n.name);break}this.fields=i,this._overrideFields=r}if(this._layer.source&&this._layer.source.sourceJSON){const i=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=ne.StandardisedNoInterval,null!=i&&i>=10.61&&(this._databaseType=ne.Standardised)):null!=i&&(i>=10.5&&(this._databaseType=ne.StandardisedNoInterval,this._requestStandardised=!0),i>=10.61&&(this._databaseType=ne.Standardised))}this.objectIdField=this._layer.objectIdField;for(const _ of this.fields)"global-id"===_.type&&(this.globalIdField=_.name);"subtype-group"===this._layer.type?(this.subtypeField=this._layer.subtypeField??"",this.subtypes=this._layer.subtypes,this.types=null,this.typeIdField=null):"oriented-imagery"===this._layer.type?(this.subtypeField=null,this.subtypes=null,this.typeIdField=this._layer.typeIdField??"",this.types=this._layer.types):(this.subtypeField=this._layer.subtypeField,this.subtypes=this._layer.subtypes,this.typeIdField=this._layer.typeIdField??"",this.types=this._layer.types)}_isInFeatureSet(){return ae.InFeatureSet}async _refineSetBlock(i){return i}_candidateIdTransform(i){return i}async _getSet(i){if(null===this._wset){await this._ensureLoaded();const r=await this._getFilteredSet("",null,null,null,i);return this._wset=r,r}return this._wset}async _runDatabaseProbe(i){await this._ensureLoaded();const r=new x;this.datesInUnknownTimezone&&(r.timeReferenceUnknownClient=!0),r.where=i.replace("OBJECTID",this._layer.objectIdField);try{return await this._layer.queryObjectIds(r),!0}catch(n){return!1}}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(i){var r,n;const o=null==(n=null==(r=this._layer)?void 0:r.capabilities)?void 0:n.query;return!i.outStatistics&&!0===(null==o?void 0:o.supportsFormatPBF)&&!0===(null==o?void 0:o.supportsQuantizationEditMode)}async queryPBF(i){return i.quantizationParameters={mode:"edit"},(await f(this._layer.parsedUrl,i,{format:"pbf"},{})).unquantize()}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion||"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title??"",source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(i,r){i.returnZ=this.hasZ,i.returnM=this.hasM;const n="execute"===r?et:"executeForCount"===r?it:st,o="execute"===r&&this.pbfSupportedForQuery(i);let u=null;if(this.recentlyUsedQueries){const r=this.convertQueryToLruCacheKey(i);u=this.recentlyUsedQueries.getFromCache(r),null===u&&(u=!0!==o?n(this._layer.parsedUrl.path,i):this.queryPBF(i),this.recentlyUsedQueries.addToCache(r,u),u=u.catch((i=>{var n;throw null==(n=this.recentlyUsedQueries)||n.removeFromCache(r),i})))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:i,method:r}),null===u&&(u=!0!==o?n(this._layer.parsedUrl.path,i):this.queryPBF(i)),u}async _getFilteredSet(i,r,n,o,u){const h=await this.databaseType();if(this.isTable()&&r&&null!==i&&""!==i)return new Re([],[],!0,null);if(this._canUsePagination())return this._getFilteredSetUsingPaging(i,r,n,o,u);let _="",y=!1;null!==o&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(_=o.constructClause(),y=!0);const w=new x;this.datesInUnknownTimezone&&(w.timeReferenceUnknownClient=!0),w.where=null===n?null===r?"1=1":"":Le(n,h),this._requestStandardised&&(w.sqlFormat="standard"),w.spatialRelationship=this._makeRelationshipEnum(i),w.outSpatialReference=this.spatialReference,w.orderByFields=""!==_?_.split(","):null,w.geometry=null===r?null:r,w.relationParameter=this._makeRelationshipParam(i);let S=await this.executeQuery(w,"executeForIds");return null===S&&(S=[]),this._checkCancelled(u),new Re([],S,y,null)}_expandPagedSet(i,r,n,o,u){return this._expandPagedSetFeatureSet(i,r,n,o,u)}async _getFilteredSetUsingPaging(i,r,n,o,u){var h;let _="",y=!1;null!==o&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(_=o.constructClause(),y=!0);const w=await this.databaseType();let S=null===n?null===r?"1=1":"":Le(n,w);this._layer.definitionExpression&&this._useDefinitionExpression&&(S=""!==S?"(("+this._layer.definitionExpression+") AND ("+S+"))":this._layer.definitionExpression);let C=this._maxQueryRate();const R=null==(h=this._layer.capabilities)?void 0:h.query.maxRecordCount;null!=R&&R<C&&(C=R);let x=null;if(!0===this._pageJustIds)x=new Re([],["GETPAGES"],y,{spatialRel:this._makeRelationshipEnum(i),relationParam:this._makeRelationshipParam(i),outFields:this._layer.objectIdField,resultRecordCount:C,resultOffset:0,geometry:null===r?null:r,where:S,orderByFields:_,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let n=!0;!0===this._removeGeometry&&(n=!1);const o=this._overrideFields??this._fieldsIncludingObjectId(["*"]);x=new Re([],["GETPAGES"],y,{spatialRel:this._makeRelationshipEnum(i),relationParam:this._makeRelationshipParam(i),outFields:o.join(","),resultRecordCount:C,resultOffset:0,geometry:null===r?null:r,where:S,orderByFields:_,returnGeometry:n,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return await this._expandPagedSet(x,C,0,1,u),x}_clonePageDefinition(i){return null===i?null:!0!==i.groupbypage?{groupbypage:!1,spatialRel:i.spatialRel,relationParam:i.relationParam,outFields:i.outFields,resultRecordCount:i.resultRecordCount,resultOffset:i.resultOffset,geometry:i.geometry,where:i.where,orderByFields:i.orderByFields,returnGeometry:i.returnGeometry,returnIdsOnly:i.returnIdsOnly,internal:i.internal}:{groupbypage:!0,spatialRel:i.spatialRel,relationParam:i.relationParam,outFields:i.outFields,resultRecordCount:i.resultRecordCount,useOIDpagination:i.useOIDpagination,generatedOid:i.generatedOid,groupByFieldsForStatistics:i.groupByFieldsForStatistics,resultOffset:i.resultOffset,outStatistics:i.outStatistics,geometry:i.geometry,where:i.where,orderByFields:i.orderByFields,returnGeometry:i.returnGeometry,returnIdsOnly:i.returnIdsOnly,internal:i.internal}}async _getPhysicalPage(i,r,n){const o=i.pagesDefinition.internal.lastRetrieved,u=o,h=i.pagesDefinition.internal.lastPage,_=new x;this._requestStandardised&&(_.sqlFormat="standard"),this.datesInUnknownTimezone&&(_.timeReferenceUnknownClient=!0),_.spatialRelationship=i.pagesDefinition.spatialRel,_.relationParameter=i.pagesDefinition.relationParam,_.outFields=i.pagesDefinition.outFields.split(","),_.num=i.pagesDefinition.resultRecordCount,_.start=i.pagesDefinition.internal.lastPage,_.geometry=i.pagesDefinition.geometry,_.where=i.pagesDefinition.where,_.orderByFields=""!==i.pagesDefinition.orderByFields?i.pagesDefinition.orderByFields.split(","):null,_.returnGeometry=i.pagesDefinition.returnGeometry,_.outSpatialReference=this.spatialReference;const y=await this.executeQuery(_,"execute");if(this._checkCancelled(n),i.pagesDefinition.internal.lastPage!==h)return"done";const w=this._layer.objectIdField;for(let S=0;S<y.features.length;S++)i.pagesDefinition.internal.set[u+S]=y.features[S].attributes[w];if(!1===this._pageJustIds)for(let S=0;S<y.features.length;S++)this._featureCache[y.features[S].attributes[w]]=y.features[S];return(void 0===y.exceededTransferLimit&&y.features.length!==i.pagesDefinition.resultRecordCount||!1===y.exceededTransferLimit)&&(i.pagesDefinition.internal.fullyResolved=!0),i.pagesDefinition.internal.lastRetrieved=o+y.features.length,i.pagesDefinition.internal.lastPage+=i.pagesDefinition.resultRecordCount,"done"}_fieldsIncludingObjectId(i){if(null===i)return[this.objectIdField];const r=i.slice(0);if(r.includes("*"))return r;let n=!1;for(const o of r)if(o.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&r.push(this.objectIdField),r}async _getFeatures(i,r,n,o){const u=[];if(-1!==r&&void 0===this._featureCache[r]&&u.push(r),!0===this._checkIfNeedToExpandKnownPage(i,this._maxProcessingRate()))return await this._expandPagedSet(i,this._maxProcessingRate(),0,0,o),this._getFeatures(i,r,n,o);let h=0;for(let S=i._lastFetchedIndex;S<i._known.length;S++){if(i._lastFetchedIndex+=1,h++,void 0===this._featureCache[i._known[S]]){let n=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){const r=this._layer._mode;if(void 0!==r._featureMap[i._known[S]]){const o=r._featureMap[i._known[S]];null!==o&&(n=!0,this._featureCache[i._known[S]]=o)}}if(!1===n&&(i._known[S]!==r&&u.push(i._known[S]),u.length>=this._maxProcessingRate()-1))break}if(h>=n&&0===u.length)break}if(0===u.length)return"success";const _=new x;this._requestStandardised&&(_.sqlFormat="standard"),this.datesInUnknownTimezone&&(_.timeReferenceUnknownClient=!0),_.objectIds=u,_.outFields=this._overrideFields??this._fieldsIncludingObjectId(["*"]),_.returnGeometry=!0,!0===this._removeGeometry&&(_.returnGeometry=!1),_.outSpatialReference=this.spatialReference;const y=await this.executeQuery(_,"execute");if(this._checkCancelled(o),void 0!==y.error)throw new Ie(ve.RequestFailed,{reason:y.error});const w=this._layer.objectIdField;for(let S=0;S<y.features.length;S++)this._featureCache[y.features[S].attributes[w]]=y.features[S];return"success"}async _getDistinctPages(i,r,n,o,u,h,_,y,w){var S;await this._ensureLoaded();const C=await this.databaseType();let R=n.parseTree.column;const U=this._layer.fields??[];for(let x=0;x<U.length;x++)if(U[x].name.toLowerCase()===R.toLowerCase()){R=U[x].name;break}const W=new x;this._requestStandardised&&(W.sqlFormat="standard"),this.datesInUnknownTimezone&&(W.timeReferenceUnknownClient=!0);let V=null===h?null===u?"1=1":"":Le(h,C);this._layer.definitionExpression&&this._useDefinitionExpression&&(V=""!==V?"(("+this._layer.definitionExpression+") AND ("+V+"))":this._layer.definitionExpression),W.where=V,W.spatialRelationship=this._makeRelationshipEnum(o),W.relationParameter=this._makeRelationshipParam(o),W.geometry=null===u?null:u,W.returnDistinctValues=!0,W.returnGeometry=!1,W.outFields=[R];const Q=await this.executeQuery(W,"execute");if(this._checkCancelled(w),!Q.hasOwnProperty("features"))throw new Ie(ve.InvalidStatResponse);let Z=!1;for(let x=0;x<U.length;x++)if(U[x].name===R){"date"===U[x].type&&(Z=!0);break}for(let x=0;x<Q.features.length;x++){if(Z){const i=Q.features[x].attributes[R];null!==i?y.push(new Date(i)):y.push(i)}else y.push(Q.features[x].attributes[R]);if(y.length>=_)break}return 0===Q.features.length?y:Q.features.length===(null==(S=this._layer.capabilities)?void 0:S.query.maxRecordCount)&&y.length<_?{calculated:!0,result:await this._getDistinctPages(i+Q.features.length,r,n,o,u,h,_,y,w)}:y}async _distinctStat(i,r,n,o,u,h,_){return{calculated:!0,result:await this._getDistinctPages(0,i,r,n,o,u,h,[],_)}}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType||"esriGeometryNull"===this._layer.geometryType}async _countstat(i,r,n,o){const u=await this.databaseType(),h=new x;if(this._requestStandardised&&(h.sqlFormat="standard"),this.isTable()&&n&&null!==r&&""!==r)return{calculated:!0,result:0};let _=null===o?null===n?"1=1":"":Le(o,u);return this._layer.definitionExpression&&this._useDefinitionExpression&&(_=""!==_?"(("+this._layer.definitionExpression+") AND ("+_+"))":this._layer.definitionExpression),h.where=_,this.datesInUnknownTimezone&&(h.timeReferenceUnknownClient=!0),h.where=_,h.spatialRelationship=this._makeRelationshipEnum(r),h.relationParameter=this._makeRelationshipParam(r),h.geometry=null===n?null:n,h.returnGeometry=!1,{calculated:!0,result:await this.executeQuery(h,"executeForCount")}}async _stats(i,r,n,o,u,h,_){await this._ensureLoaded();const y=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,w=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,S=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;if("count"===i)return S?this._countstat(i,n,o,u):{calculated:!1};if(!1===w||!1===Me(r)&&!1===y||!1===r.isStandardized)return""!==n||null!==u?{calculated:!1}:this._manualStat(i,r,h,_);if("distinct"===i)return!1===S?""!==n||null!==u?{calculated:!1}:this._manualStat(i,r,h,_):this._distinctStat(i,r,n,o,u,h,_);const C=await this.databaseType();if(this.isTable()&&o&&null!==n&&""!==n)return{calculated:!0,result:null};const R=new x;this._requestStandardised&&(R.sqlFormat="standard");let U=null===u?null===o?"1=1":"":Le(u,C);this._layer.definitionExpression&&this._useDefinitionExpression&&(U=""!==U?"(("+this._layer.definitionExpression+") AND ("+U+"))":this._layer.definitionExpression),R.where=U,R.spatialRelationship=this._makeRelationshipEnum(n),R.relationParameter=this._makeRelationshipParam(n),R.geometry=null===o?null:o,this.datesInUnknownTimezone&&(R.timeReferenceUnknownClient=!0);const W=new V;W.statisticType=Qe(i),W.onStatisticField=Le(r,C),W.outStatisticFieldName="ARCADE_STAT_RESULT",R.returnGeometry=!1;let Q="ARCADE_STAT_RESULT";R.outStatistics=[W];const Z=await this.executeQuery(R,"execute");if(!Z.hasOwnProperty("features")||0===Z.features.length)throw new Ie(ve.InvalidStatResponse);let z=!1;const J=Z.fields??[];for(let x=0;x<J.length;x++)if("ARCADE_STAT_RESULT"===J[x].name.toUpperCase()){Q=J[x].name,"date"===J[x].type&&(z=!0);break}if(z){let i=Z.features[0].attributes[Q];return null!==i&&(i=new Date(Z.features[0].attributes[Q])),{calculated:!0,result:i}}return{calculated:!0,result:Z.features[0].attributes[Q]}}_stat(i,r,n,o,u,h,_){return this._stats(i,r,n,o,u,h,_)}async _canDoAggregates(i,r){var n,o;await this._ensureLoaded();let u=!1;const h=null==(n=this._layer.capabilities)?void 0:n.query,_=!0===(null==h?void 0:h.supportsSqlExpression);if(null!=h&&!0===h.supportsStatistics&&!0===h.supportsOrderBy&&(u=!0),u)for(let y=0;y<r.length-1;y++)(!1===(null==(o=r[y].workingexpr)?void 0:o.isStandardized)||!1===Me(r[y].workingexpr)&&!1===_)&&(u=!1);return!1!==u}_makeRelationshipEnum(i){if(i.includes("esriSpatialRelRelation"))return"relation";switch(i){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return i}_makeRelationshipParam(i){return i.includes("esriSpatialRelRelation")?i.split(":")[1]:""}async _getAggregatePagesDataSourceDefinition(i,r,n,o,u,h,_){var y;await this._ensureLoaded();const w=await this.databaseType();let S="",C=!1,R=!1;null!==h&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(S=h.constructClause(),R=!0),this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(R=!1,C=!0,S=this._layer.objectIdField);const x=[];for(let Z=0;Z<r.length;Z++){const i=new V;i.onStatisticField=null!==r[Z].workingexpr?Le(r[Z].workingexpr,w):"",i.outStatisticFieldName=r[Z].field,i.statisticType=r[Z].toStatisticsName(),x.push(i)}""===S&&(S=i.join(","));let U=this._maxQueryRate();const W=null==(y=this._layer.capabilities)?void 0:y.query.maxRecordCount;null!=W&&W<U&&(U=W);let Q=null===u?null===o?"1=1":"":Le(u,w);return this._layer.definitionExpression&&this._useDefinitionExpression&&(Q=""!==Q?"(("+this._layer.definitionExpression+") AND ("+Q+"))":this._layer.definitionExpression),new Re([],["GETPAGES"],R,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(n),relationParam:this._makeRelationshipParam(n),outFields:["*"],useOIDpagination:C,generatedOid:_,resultRecordCount:U,resultOffset:0,groupByFieldsForStatistics:i,outStatistics:x,geometry:null===o?null:o,where:Q,orderByFields:S,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}async _getAgregagtePhysicalPage(i,r,n){let u=i.pagesDefinition.where;!0===i.pagesDefinition.useOIDpagination&&(u=""!==u?"("+u+") AND ("+i.pagesDefinition.generatedOid+">"+i.pagesDefinition.internal.lastMaxId.toString()+")":i.pagesDefinition.generatedOid+">"+i.pagesDefinition.internal.lastMaxId.toString());const h=i.pagesDefinition.internal.lastRetrieved,_=h,y=i.pagesDefinition.internal.lastPage,w=new x;if(this._requestStandardised&&(w.sqlFormat="standard"),w.where=u,w.spatialRelationship=i.pagesDefinition.spatialRel,w.relationParameter=i.pagesDefinition.relationParam,w.outFields=i.pagesDefinition.outFields,w.outStatistics=i.pagesDefinition.outStatistics,w.geometry=i.pagesDefinition.geometry,w.groupByFieldsForStatistics=i.pagesDefinition.groupByFieldsForStatistics,w.num=i.pagesDefinition.resultRecordCount,w.start=i.pagesDefinition.internal.lastPage,w.returnGeometry=i.pagesDefinition.returnGeometry,this.datesInUnknownTimezone&&(w.timeReferenceUnknownClient=!0),w.orderByFields=""!==i.pagesDefinition.orderByFields?i.pagesDefinition.orderByFields.split(","):null,this.isTable()&&w.geometry&&w.spatialRelationship)return[];const S=await this.executeQuery(w,"execute");if(this._checkCancelled(n),!S.hasOwnProperty("features"))throw new Ie(ve.InvalidStatResponse);const C=[];if(i.pagesDefinition.internal.lastPage!==y)return[];S.features.length>0&&void 0===S.features[0].attributes[i.pagesDefinition.generatedOid]&&(i.pagesDefinition.generatedOid=i.pagesDefinition.generatedOid.toLowerCase());for(let o=0;o<S.features.length;o++)i.pagesDefinition.internal.set[_+o]=S.features[o].attributes[i.pagesDefinition.generatedOid];for(let R=0;R<S.features.length;R++)C.push(new o({attributes:S.features[R].attributes,geometry:null}));return!0===i.pagesDefinition.useOIDpagination?0===S.features.length?i.pagesDefinition.internal.fullyResolved=!0:i.pagesDefinition.internal.lastMaxId=S.features[S.features.length-1].attributes[i.pagesDefinition.generatedOid]:(void 0===S.exceededTransferLimit&&S.features.length!==i.pagesDefinition.resultRecordCount||!1===S.exceededTransferLimit)&&(i.pagesDefinition.internal.fullyResolved=!0),i.pagesDefinition.internal.lastRetrieved=h+S.features.length,i.pagesDefinition.internal.lastPage+=i.pagesDefinition.resultRecordCount,C}static create(i,r,n,o,u){const h=new Q({url:i,outFields:null===r?["*"]:r});return new P({layer:h,spatialReference:n,lrucache:o,interceptor:u})}relationshipMetaData(){var i;return this._layer&&this._layer.source&&(null==(i=this._layer.source.sourceJSON)?void 0:i.relationships)?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return _e(this._layer.parsedUrl.path)}async queryAttachments(i,r,n,o,u){const h=this._layer;if(function l2(i){const r=i.capabilities;return(null==r?void 0:r.data.supportsAttachment)&&(null==r?void 0:r.operations.supportsQueryAttachments)}(h)){const _={objectIds:[i],returnMetadata:u};(r&&r>0||n&&n>0)&&(_.size=[r&&r>0?r:0,n&&n>0?n:r+1]),o&&o.length>0&&(_.attachmentTypes=o),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:h,query:_,method:"attachments"});const y=await h.queryAttachments(new Z(_)),w=[];return y&&y[i]&&y[i].forEach((r=>{const n=this._layer.parsedUrl.path+"/"+i.toString()+"/attachments/"+r.id.toString();let o=null;u&&r.exifInfo&&(o=ye.convertJsonToArcade(r.exifInfo,"system",!0)),w.push(new ge(r.id,r.name,r.contentType,r.size,n,o,r.keywords??null))})),w}return[]}async queryRelatedFeatures(i){var r;const n={f:"json",relationshipId:i.relationshipId.toString(),definitionExpression:i.where,outFields:null==(r=i.outFields)?void 0:r.join(","),returnGeometry:i.returnGeometry.toString()};void 0!==i.resultOffset&&null!==i.resultOffset&&(n.resultOffset=i.resultOffset.toString()),void 0!==i.resultRecordCount&&null!==i.resultRecordCount&&(n.resultRecordCount=i.resultRecordCount.toString()),i.orderByFields&&(n.orderByFields=i.orderByFields.join(",")),i.objectIds&&i.objectIds.length>0&&(n.objectIds=i.objectIds.join(",")),i.outSpatialReference&&(n.outSR=z(i.outSpatialReference)),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:n,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"});const u=await J(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:n});if(u.data){const i={},r=u.data;if(null==r?void 0:r.relatedRecordGroups){const n=r.spatialReference;for(const u of r.relatedRecordGroups){const h=u.objectId,_=[];for(const i of u.relatedRecords){i.geometry&&(i.geometry.spatialReference=n);const r=new o({geometry:i.geometry?K(i.geometry):null,attributes:i.attributes});_.push(r)}i[h]={features:_,exceededTransferLimit:!0===r.exceededTransferLimit}}}return i}throw new Ie(ve.InvalidRequest)}async getFeatureByObjectId(i,r){const n=new x;n.outFields=r,n.returnGeometry=!1,n.outSpatialReference=this.spatialReference,n.where=this.objectIdField+"="+i.toString(),this.datesInUnknownTimezone&&(n.timeReferenceUnknownClient=!0),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:n,method:"execute"});const o=await et(this._layer.parsedUrl.path,n);return 1===o.features.length?o.features[0]:null}async getIdentityUser(){var i;await this.load();const r=null==(i=X)?void 0:i.findCredential(this._layer.url);return r?r.userId:null}async getOwningSystemUrl(){var i,r;await this.load();const n=null==(i=X)?void 0:i.findServerInfo(this._layer.url);if(n)return n.owningSystemUrl;let o=this._layer.url;const u=o.toLowerCase().indexOf("/rest/services");if(o=u>-1?o.substring(0,u):o,o){o+="/rest/info";try{const i=await J(o,{query:{f:"json"}});let n="";return(null==(r=i.data)?void 0:r.owningSystemUrl)&&(n=i.data.owningSystemUrl),n}catch(h){return""}}return""}getDataSourceFeatureSet(){const i=new P({layer:this._layer,spatialReference:this.spatialReference??void 0,outFields:this._overrideFields??void 0,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries??void 0,interceptor:this.featureSetQueryInterceptor??void 0});return i._useDefinitionExpression=!1,i}get preferredTimeZone(){return this._layer.preferredTimeZone??null}get dateFieldsTimeZone(){return this._layer.dateFieldsTimeZone??null}get datesInUnknownTimezone(){return this._layer.datesInUnknownTimezone??!1}get editFieldsInfo(){return this._layer.editFieldsInfo??null}get timeInfo(){return this._layer.timeInfo??null}async getFeatureSetInfo(){var i,r;if(this.fsetInfo)return this.fsetInfo;let n=null,o=this._layer.serviceItemId??null;const u=this._layer.parsedUrl.path;if(u){const h=await J(u,{responseType:"json",query:{f:"json"}});n=(null==(i=null==h?void 0:h.data)?void 0:i.name)??null,o=(null==(r=null==h?void 0:h.data)?void 0:r.serviceItemId)??null}const h=this._layer.title&&null!==(this._layer.parent??null);return this.featureSetInfo={layerId:this._layer.layerId,layerName:""===n?null:n,itemId:""===o?null:o,serviceLayerUrl:""===u?null:u,webMapLayerId:h?this._layer.id??null:null,webMapLayerTitle:h?this._layer.title??null:null,className:null,objectClassId:null},this.fsetInfo}}let ht=class d extends ke{constructor(i){super(i),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,i.spatialReference&&(this.spatialReference=i.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=i.layer,this._wset=null,!0===i.isTable&&(this._forceIsTable=!0),void 0!==i.outFields&&(this._overrideFields=i.outFields),void 0!==i.includeGeometry&&(this._removeGeometry=!1===i.includeGeometry)}_maxQueryRate(){return fe}end(){return this._layer}optimisePagingFeatureQueries(){}async loadImpl(){return!0===this._layer.loaded?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}get gdbVersion(){return""}_initialiseFeatureSet(){var i,r,n,o,u,h;if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const i=[],r=[];for(const n of this.fields)if("oid"===n.type)i.push(n),r.push(n.name);else for(const o of this._overrideFields)if(o.toLowerCase()===n.name.toLowerCase()){i.push(n),r.push(n.name);break}this.fields=i,this._overrideFields=r}this.objectIdField=this._layer.objectIdField;for(const _ of this.fields)"global-id"===_.type&&(this.globalIdField=_.name);this._databaseType=ne.Standardised,this.hasZ=!0===(null==(n=null==(r=null==(i=this._layer)?void 0:i.capabilities)?void 0:r.data)?void 0:n.supportsZ),this.hasM=!0===(null==(h=null==(u=null==(o=this._layer)?void 0:o.capabilities)?void 0:u.data)?void 0:h.supportsM),"subtype-group"===this._layer.type?(this.subtypeField=this._layer.subtypeField??"",this.subtypes=this._layer.subtypes,this.types=null,this.typeIdField=null):"oriented-imagery"===this._layer.type?(this.subtypeField=null,this.subtypes=null,this.typeIdField=this._layer.typeIdField??"",this.types=this._layer.types):(this.subtypeField=this._layer.subtypeField,this.subtypes=this._layer.subtypes,this.typeIdField=this._layer.typeIdField??"",this.types=this._layer.types)}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return ae.InFeatureSet}_candidateIdTransform(i){return i}async _getSet(i){if(null===this._wset){await this._ensureLoaded();const r=await this._getFilteredSet("",null,null,null,i);return this._wset=r,r}return this._wset}_changeFeature(i){const r={};for(const n of this.fields)r[n.name]=i.attributes[n.name];return new o({geometry:!0===this._removeGeometry?null:i.geometry,attributes:r})}async _getFilteredSet(i,r,n,o,u){let h="",_=!1;if(null!==o&&(h=o.constructClause(),_=!0),this.isTable()&&r&&null!==i&&""!==i)return new Re([],[],!0,null);const y=new x;y.returnZ=this.hasZ,y.returnM=this.hasM,y.where=null===n?null===r?"1=1":"":Le(n,ne.Standardised),y.spatialRelationship=this._makeRelationshipEnum(i),y.outSpatialReference=this.spatialReference,y.orderByFields=""!==h?h.split(","):null,y.geometry=null===r?null:r,y.returnGeometry=!0,y.relationParameter=this._makeRelationshipParam(i);const w=await this._layer.queryFeatures(y);if(null===w)return new Re([],[],_,null);this._checkCancelled(u);const S=[];return w.features.forEach((i=>{const r=i.attributes[this._layer.objectIdField];S.push(r),this._featureCache[r]=this._changeFeature(i)})),new Re([],S,_,null)}_makeRelationshipEnum(i){if(i.includes("esriSpatialRelRelation"))return"relation";switch(i){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return i}_makeRelationshipParam(i){return i.includes("esriSpatialRelRelation")?i.split(":")[1]:""}async _queryAllFeatures(){if(this._wset)return this._wset;const i=new x;if(i.where="1=1",await this._ensureLoaded(),this._layer.source&&this._layer.source.items){const i=[];return this._layer.source.items.forEach((r=>{const n=r.attributes[this._layer.objectIdField];i.push(n),this._featureCache[n]=this._changeFeature(r)})),this._wset=new Re([],i,!1,null),this._wset}i.returnZ=this.hasZ,i.returnM=this.hasM;const r=await this._layer.queryFeatures(i),n=[];return r.features.forEach((i=>{const r=i.attributes[this._layer.objectIdField];n.push(r),this._featureCache[r]=this._changeFeature(i)})),this._wset=new Re([],n,!1,null),this._wset}async _getFeatures(i,r,n){const o=[];-1!==r&&void 0===this._featureCache[r]&&o.push(r);for(let u=i._lastFetchedIndex;u<i._known.length&&(i._lastFetchedIndex+=1,!(void 0===this._featureCache[i._known[u]]&&(i._known[u]!==r&&o.push(i._known[u]),o.length>n)));u++);if(0===o.length)return"success";throw new Ie(ve.MissingFeatures)}async _refineSetBlock(i){return i}async _stat(){return{calculated:!1}}async _canDoAggregates(){return!1}relationshipMetaData(){return[]}static _cloneAttr(i){const r={};for(const n in i)r[n]=i[n];return r}nativeCapabilities(){return{title:this._layer.title??"",canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(i,r){var n,o,u,_,y,w;let S=i.layerDefinition.objectIdField;const C=i.layerDefinition.typeIdField??"",R=[];if(i.layerDefinition.types)for(const h of i.layerDefinition.types)R.push($.fromJSON(h));let x=i.layerDefinition.geometryType;void 0===x&&(x=i.featureSet.geometryType||"");let U=i.featureSet.features;const W=r.toJSON();if(!S){let r=!1;for(const n of i.layerDefinition.fields)if("oid"===n.type||"esriFieldTypeOID"===n.type){S=n.name,r=!0;break}if(!1===r){let r="FID",n=!0,o=0;for(;n;){let u=!0;for(const n of i.layerDefinition.fields)if(n.name===r){u=!1;break}!0===u?n=!1:(o++,r="FID"+o.toString())}i.layerDefinition.fields.push({type:"esriFieldTypeOID",name:r,alias:r});const u=[];for(let h=0;h<U.length;h++)u.push({geometry:i.featureSet.features[h].geometry,attributes:i.featureSet.features[h].attributes?this._cloneAttr(i.featureSet.features[h].attributes):{}}),u[h].attributes[r]=h;U=u,S=r}}const V=[];for(const Q of i.layerDefinition.fields)Q instanceof h?V.push(Q):V.push(h.fromJSON(Q));let Z=x;switch(Z||(Z=""),Z){case"esriGeometryPoint":Z="point";break;case"esriGeometryPolyline":Z="polyline";break;case"esriGeometryPolygon":Z="polygon";break;case"esriGeometryEnvelope":Z="extent";break;case"esriGeometryMultipoint":Z="multipoint";break;case"":case"esriGeometryNull":Z="esriGeometryNull"}if("esriGeometryNull"!==Z)for(const h of U)h.geometry&&h.geometry instanceof Y==0&&(h.geometry.type=Z,void 0===h.geometry.spatialReference&&(h.geometry.spatialReference=W));else for(const h of U)h.geometry&&(h.geometry=null);const z={outFields:["*"],source:U,fields:V,hasZ:!0===(null==(n=null==i?void 0:i.layerDefinition)?void 0:n.hasZ)||!0===(null==(o=null==i?void 0:i.featureSet)?void 0:o.hasZ),hasM:!0===(null==(u=null==i?void 0:i.layerDefinition)?void 0:u.hasM)||!0===(null==(_=null==i?void 0:i.featureSet)?void 0:_.hasM),types:R,typeIdField:C,objectIdField:S,spatialReference:r},J="esriGeometryNull"===Z||null===Z;J||(z.geometryType=Z);const K=new Q(z);return(null==(y=null==i?void 0:i.layerDefinition)?void 0:y.subtypeField)&&(null==(w=null==i?void 0:i.layerDefinition)?void 0:w.subtypes)&&K.read({subtypes:i.layerDefinition.subtypes,subtypeField:i.layerDefinition.subtypeField}),new d({layer:K,spatialReference:r,isTable:J})}async queryAttachments(){return[]}async getFeatureByObjectId(i){const r=new x;r.where=this.objectIdField+"="+i.toString(),r.returnZ=this.hasZ,r.returnM=this.hasM;const n=await this._layer.queryFeatures(r);return 1===n.features.length?n.features[0]:null}async getOwningSystemUrl(){return""}async getIdentityUser(){return""}get preferredTimeZone(){return this._layer.preferredTimeZone??null}get dateFieldsTimeZone(){return this._layer.dateFieldsTimeZone??null}get datesInUnknownTimezone(){return this._layer.datesInUnknownTimezone??!1}get editFieldsInfo(){return this._layer.editFieldsInfo}get timeInfo(){var i;return null==(i=this._layer)?void 0:i.timeInfo}async getFeatureSetInfo(){const i=this._layer.title&&this._layer.parent;return this.fsetInfo??{layerId:null,layerName:null,itemId:null,serviceLayerUrl:null,webMapLayerId:i?this._layer.id??null:null,webMapLayerTitle:i?this._layer.title??null:null,className:null,objectClassId:null}}};class d2 extends ke{constructor(i){super(i),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,i.spatialReference&&(this.spatialReference=i.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=i.layer,this._wset=null,this._findObjectId=i.objectId,this.featureObjectId=i.objectId,this.relationship=i.relationship,this._relatedLayer=i.relatedLayer,void 0!==i.outFields&&(this._overrideFields=i.outFields),void 0!==i.includeGeometry&&(this._removeGeometry=!1===i.includeGeometry)}_maxQueryRate(){return fe}end(){return this._layer}optimisePagingFeatureQueries(){}async loadImpl(){var i;return await Promise.all([this._layer.load(),null==(i=this._relatedLayer)?void 0:i.load()]),this._initialiseFeatureSet(),this}nativeCapabilities(){return this._relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._relatedLayer.geometryType,this.fields=this._relatedLayer.fields.slice(0),this.hasZ=this._relatedLayer.hasZ,this.hasM=this._relatedLayer.hasM,null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const i=[],r=[];for(const n of this.fields)if("oid"===n.type)i.push(n),r.push(n.name);else for(const o of this._overrideFields)if(o.toLowerCase()===n.name.toLowerCase()){i.push(n),r.push(n.name);break}this.fields=i,this._overrideFields=r}const i=this._layer.nativeCapabilities();i&&(this._databaseType=i.databaseType,this._requestStandardised=i.requestStandardised),this.objectIdField=this._relatedLayer.objectIdField,this.globalIdField=this._relatedLayer.globalIdField,this.hasM=this._relatedLayer.supportsM,this.hasZ=this._relatedLayer.supportsZ,this.typeIdField=this._relatedLayer.typeIdField,this.types=this._relatedLayer.types,this.subtypeField=this._relatedLayer.subtypeField,this.subtypes=this._relatedLayer.subtypes}async databaseType(){return await this._relatedLayer.databaseType(),this._databaseType=this._relatedLayer._databaseType,this._databaseType}isTable(){return this._relatedLayer.isTable()}_isInFeatureSet(){return ae.InFeatureSet}_candidateIdTransform(i){return i}async _getSet(i){if(null===this._wset){await this._ensureLoaded();const r=await this._getFilteredSet("",null,null,null,i);return this._wset=r,r}return this._wset}_changeFeature(i){const r={};for(const n of this.fields)r[n.name]=i.attributes[n.name];return new o({geometry:!0===this._removeGeometry?null:i.geometry,attributes:r})}async _getFilteredSet(i,r,n,o,u){var h,_;if(await this.databaseType(),this.isTable()&&r&&null!==i&&""!==i)return new Re([],[],!0,null);const y=this._layer.nativeCapabilities();if(!1===y.canQueryRelated)return new Re([],[],!0,null);if(null==(h=y.capabilities)?void 0:h.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(i,r,n,o,u);let w="",S=!1;null!==o&&!0===(null==(_=y.capabilities)?void 0:_.queryRelated.supportsOrderBy)&&(w=o.constructClause(),S=!0);const C=new H;C.objectIds=[this._findObjectId];const R=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map((i=>i.name)):["*"]);C.outFields=R,C.relationshipId=this.relationship.id,C.where="1=1";let x=!0;!0===this._removeGeometry&&(x=!1),C.returnGeometry=x,this._requestStandardised&&(C.sqlFormat="standard"),C.outSpatialReference=this.spatialReference,C.orderByFields=""!==w?w.split(","):null;const U=await y.source.queryRelatedFeatures(C);this._checkCancelled(u);const W=U[this._findObjectId]?U[this._findObjectId].features:[],V=[];for(let z=0;z<W.length;z++)this._featureCache[W[z].attributes[this._relatedLayer.objectIdField]]=W[z],V.push(W[z].attributes[this._relatedLayer.objectIdField]);const Q=r&&null!==i&&""!==i,Z=null!=n;return new Re(Q||Z?V:[],Q||Z?[]:V,S,null)}_fieldsIncludingObjectId(i){if(null===i)return[this.objectIdField];const r=i.slice(0);if(r.includes("*"))return r;let n=!1;for(const o of r)if(o.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&r.push(this.objectIdField),r}async _getFilteredSetUsingPaging(i,r,n,o,u){var h,_;let y="",w=!1;const S=this._layer.nativeCapabilities();null!==o&&!0===(null==(h=S.capabilities)?void 0:h.queryRelated.supportsOrderBy)&&(y=o.constructClause(),w=!0),await this.databaseType();let C=this._maxQueryRate();const R=null==(_=S.capabilities)?void 0:_.query.maxRecordCount;null!=R&&R<C&&(C=R);const x=r&&null!==i&&""!==i,U=null!=n;let W=null,V=!0;!0===this._removeGeometry&&(V=!1);const Q=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map((i=>i.name)):["*"]);return W=new Re(x||U?["GETPAGES"]:[],x||U?[]:["GETPAGES"],w,{outFields:Q.join(","),resultRecordCount:C,resultOffset:0,objectIds:[this._findObjectId],where:"1=1",orderByFields:y,returnGeometry:V,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),await this._expandPagedSet(W,C,0,0,u),W}_expandPagedSet(i,r,n,o,u){return this._expandPagedSetFeatureSet(i,r,n,o,u)}_clonePageDefinition(i){return null===i?null:!0!==i.groupbypage?{groupbypage:!1,outFields:i.outFields,resultRecordCount:i.resultRecordCount,resultOffset:i.resultOffset,where:i.where,objectIds:i.objectIds,orderByFields:i.orderByFields,returnGeometry:i.returnGeometry,returnIdsOnly:i.returnIdsOnly,internal:i.internal}:{groupbypage:!0,outFields:i.outFields,resultRecordCount:i.resultRecordCount,useOIDpagination:i.useOIDpagination,generatedOid:i.generatedOid,groupByFieldsForStatistics:i.groupByFieldsForStatistics,resultOffset:i.resultOffset,outStatistics:i.outStatistics,geometry:i.geometry,where:i.where,objectIds:i.objectIds,orderByFields:i.orderByFields,returnGeometry:i.returnGeometry,returnIdsOnly:i.returnIdsOnly,internal:i.internal}}async _getPhysicalPage(i,r,n){const o=i.pagesDefinition.internal.lastRetrieved,u=o,h=i.pagesDefinition.internal.lastPage,_=this._layer.nativeCapabilities(),y=new H;!0===this._requestStandardised&&(y.sqlFormat="standard"),y.relationshipId=this.relationship.id,y.objectIds=i.pagesDefinition.objectIds,y.resultOffset=i.pagesDefinition.internal.lastPage,y.resultRecordCount=i.pagesDefinition.resultRecordCount,y.outFields=i.pagesDefinition.outFields.split(","),y.where=i.pagesDefinition.where,y.orderByFields=""!==i.pagesDefinition.orderByFields?i.pagesDefinition.orderByFields.split(","):null,y.returnGeometry=i.pagesDefinition.returnGeometry,y.outSpatialReference=this.spatialReference;const w=await _.source.queryRelatedFeatures(y);if(this._checkCancelled(n),i.pagesDefinition.internal.lastPage!==h)return 0;const S=w[this._findObjectId]?w[this._findObjectId].features:[];for(let R=0;R<S.length;R++)i.pagesDefinition.internal.set[u+R]=S[R].attributes[this._relatedLayer.objectIdField];for(let R=0;R<S.length;R++)this._featureCache[S[R].attributes[this._relatedLayer.objectIdField]]=S[R];const C=!w[this._findObjectId]||!1===w[this._findObjectId].exceededTransferLimit;return S.length!==i.pagesDefinition.resultRecordCount&&C&&(i.pagesDefinition.internal.fullyResolved=!0),i.pagesDefinition.internal.lastRetrieved=o+S.length,i.pagesDefinition.internal.lastPage+=i.pagesDefinition.resultRecordCount,S.length}async _getFeatures(i,r,n,o){const u=[];-1!==r&&void 0===this._featureCache[r]&&u.push(r);const h=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(i,h))return await this._expandPagedSet(i,h,0,0,o),this._getFeatures(i,r,n,o);let _=0;for(let y=i._lastFetchedIndex;y<i._known.length&&(_++,_<=n&&(i._lastFetchedIndex+=1),!("GETPAGES"!==i._known[y]&&void 0===this._featureCache[i._known[y]]&&(i._known[y]!==r&&u.push(i._known[y]),u.length>n)))&&!(_>=n&&0===u.length);y++);if(0===u.length)return"success";throw new Ie(ve.MissingFeatures)}async _refineSetBlock(i,r,n){return i}async _stat(i,r,n,o,u,h,_){return{calculated:!1}}get gdbVersion(){return this._relatedLayer.gdbVersion}async _canDoAggregates(i,r,n,o,u){return!1}relationshipMetaData(){return this._relatedLayer.relationshipMetaData()}serviceUrl(){return this._relatedLayer.serviceUrl()}queryAttachments(i,r,n,o,u){return this._relatedLayer.queryAttachments(i,r,n,o,u)}getFeatureByObjectId(i,r){return this._relatedLayer.getFeatureByObjectId(i,r)}getOwningSystemUrl(){return this._relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this._relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this._relatedLayer}get preferredTimeZone(){var i;return(null==(i=this._relatedLayer)?void 0:i.preferredTimeZone)??null}get dateFieldsTimeZone(){var i;return(null==(i=this._relatedLayer)?void 0:i.dateFieldsTimeZone)??null}get datesInUnknownTimezone(){var i;return null==(i=this._relatedLayer)?void 0:i.datesInUnknownTimezone}get editFieldsInfo(){var i;return(null==(i=this._relatedLayer)?void 0:i.editFieldsInfo)??null}get timeInfo(){var i;return(null==(i=this._relatedLayer)?void 0:i.timeInfo)??null}async getFeatureSetInfo(){return this.fsetInfo??this._layer.featureSetInfo}}async function g(i,r,n){if(ze.applicationCache){const n=ze.applicationCache.getLayerInfo(i);if(n){const o=await n;return new Q({url:i,outFields:r,sourceJSON:o})}const u=new Q({url:i,outFields:r}),h=(async()=>(await u.load(),u.sourceJSON))();if(ze.applicationCache){ze.applicationCache.setLayerInfo(i,h);try{return await h,u}catch(o){throw ze.applicationCache.clearLayerInfo(i),o}}return await h,u}if(null!=n){const o=n.getCachedLayerMetadata(i);if(o){const n=await o;return new Q({url:i,outFields:r,sourceJSON:n})}const h=new Q({url:i,outFields:r}),_=(async()=>(await h.load(),h.sourceJSON))();n.setCachedLayerMetadata(i,_);try{return await _,h}catch(u){throw n.removeCachedLayerMetadata(i,_),u}}return new Q({url:i,outFields:r})}async function N(i,r,n,o,u,h=null){return T(await g(i,["*"],u),r,n,o,u,h)}function T(i,r=null,n=null,o=!0,u=null,h=null){if("catalog-footprint"===i.type)return T(i.parent,r,n,o,u,h);if("subtype-sublayer"===i.type){const _=T(i.parent,r,n,o,u,h);return _.filter(Se.create(i.parent.subtypeField+"="+i.subtypeCode.toString(),i.parent.fieldsIndex,_.dateFieldsTimeZoneDefaultUTC))}if(me(i)){const _={layer:i,spatialReference:r,outFields:n,includeGeometry:o,lrucache:u,interceptor:h};return 1==!(i.url||!i.source)?new ht(_):new P(_)}throw new Error(`Unsupported layer type: ${i.type}`)}async function k2(i,r){if(null!==ze.applicationCache){const r=ze.applicationCache.getLayerInfo(i);if(null!==r)return r}if(null!=r){const n=r.getCachedServiceMetadata(i);if(null!=n)return n}const n=(async()=>{const r=await J(i,{responseType:"json",query:{f:"json"}});if(r.data){const i=r.data;return i.layers||(i.layers=[]),i.tables||(i.tables=[]),i}return{layers:[],tables:[]}})();if(null!==ze.applicationCache){ze.applicationCache.setLayerInfo(i,n);try{return await n}catch(o){throw ze.applicationCache.clearLayerInfo(i),o}}if(null!=r){r.setCachedServiceMetadata(i,n);try{return await n}catch(u){throw r.removeCachedServiceMetadata(i,n),u}}return n}async function O2(i,r){var n,o,u;const h={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null},_=await k2(i,null);if(h.metadata=_,void 0!==(null==(n=_.controllerDatasetLayers)?void 0:n.utilityNetworkLayerId)&&null!==_.controllerDatasetLayers.utilityNetworkLayerId){if(_.layers)for(const i of _.layers)h.layerNameLkp[i.id]=i.name;if(_.tables)for(const i of _.tables)h.layerNameLkp[i.id]=i.name;const n=_.controllerDatasetLayers.utilityNetworkLayerId;h.networkId=n;const y=await async function b2(i,r){const n="QUERYDATAELEMTS:"+r.toString()+":"+i;if(null!==ze.applicationCache){const i=ze.applicationCache.getLayerInfo(n);if(null!==i)return i}const o=(async()=>{var n;const o=await J(i+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([r.toString()]),f:"json"}});if(o.data){const i=o.data;if(null==(n=i.layerDataElements)?void 0:n[0])return i.layerDataElements[0]}throw new Ie(ve.DataElementsNotFound)})();if(null!==ze.applicationCache){ze.applicationCache.setLayerInfo(n,o);try{return await o}catch(y){throw ze.applicationCache.clearLayerInfo(n),y}}return o}(i,n);if(y){h.queryelem=y,(null==(o=h.queryelem)?void 0:o.dataElement)&&void 0!==h.queryelem.dataElement.schemaGeneration&&(h.unVersion=h.queryelem.dataElement.schemaGeneration),h.lkp={},h.queryelem.dataElement.domainNetworks||(h.queryelem.dataElement.domainNetworks=[]);for(const i of h.queryelem.dataElement.domainNetworks){for(const r of i.edgeSources??[]){const i={layerId:r.layerId,sourceId:r.sourceId,className:h.layerNameLkp[r.layerId]??null};i.className&&(h.lkp[i.className]=i)}for(const r of i.junctionSources??[]){const i={layerId:r.layerId,sourceId:r.sourceId,className:h.layerNameLkp[r.layerId]??null};i.className&&(h.lkp[i.className]=i)}}if(h.queryelem.dataElement.terminalConfigurations)for(const i of h.queryelem.dataElement.terminalConfigurations)for(const r of i.terminals)h.terminals.push({terminalId:r.terminalId,terminalName:r.terminalName});const w=await async function A(i){if(null!==ze.applicationCache){const r=ze.applicationCache.getLayerInfo(i);if(null!==r)return r}const r=(async()=>{const r=await J(i,{responseType:"json",query:{f:"json"}});return r.data?r.data:null})();if(null!==ze.applicationCache){ze.applicationCache.setLayerInfo(i,r);try{return await r}catch(_){throw ze.applicationCache.clearLayerInfo(i),_}}return r}(i+"/"+n);if(void 0!==(null==(u=w.systemLayers)?void 0:u.associationsTableId)&&null!==w.systemLayers.associationsTableId){const n=[];h.unVersion>=4&&(n.push("STATUS"),n.push("PERCENTALONG"));let o=await N(i+"/"+w.systemLayers.associationsTableId.toString(),r,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...n],!1,null,null);return await o.load(),h.unVersion>=4&&(o=o.filter(Se.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62, 63)",o.getFieldsIndex(),o.dateFieldsTimeZoneDefaultUTC)),await o.load()),{lkp:h.lkp,associations:o,unVersion:h.unVersion,terminals:h.terminals}}return{associations:null,unVersion:h.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:h.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:h.unVersion,lkp:null,terminals:[]}}async function E(i,r,n,o=null,u=null,h=!0,_=null,y=null){let w=i.serviceUrl();if(!w)return null;w="/"===w.charAt(w.length-1)?w+r.relatedTableId.toString():w+"/"+r.relatedTableId.toString();const S=await N(w,o,u,h,_,y);return new d2({layer:i,relatedLayer:S,relationship:r,objectId:n,spatialReference:o,outFields:u,includeGeometry:h,lrucache:_,interceptor:y})}rt.registerAction(),class O extends ke{constructor(i){super(i),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=i.parentfeatureset,this._config=i}isTable(){return!0}async _getSet(i){if(null===this._wset){const r=await this._getFilteredSet("",null,null,null,i);return this._wset=r,this._wset}return this._wset}_isInFeatureSet(){return ae.InFeatureSet}_nextUniqueName(i){for(;1===i["T"+this._uniqueIds.toString()];)this._uniqueIds++;const r="T"+this._uniqueIds.toString();return i[r]=1,r}_convertToEsriFieldType(i){return i}_initialiseFeatureSet(){const r={};let n=!1,o=1;const _=this._parent?this._parent.getFieldsIndex():new u([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===n;){let i=!1;for(let r=0;r<this._config.groupbyfields.length;r++)if(this._config.groupbyfields[r].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}if(!1===i)for(let r=0;r<this._config.statsfields.length;r++)if(this._config.statsfields[r].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}!1===i?n=!0:(this.objectIdField="ROW__ID"+o.toString(),o++)}for(const i of this._config.statsfields){const r=new dt;r.field=i.name,r.tofieldname=i.name,r.workingexpr=i.expression instanceof Se?i.expression:Se.create(i.expression,_,this.dateFieldsTimeZoneDefaultUTC),r.typeofstat=G$1(i.statistic),this._decodedStatsfield.push(r)}this._decodedGroupbyfield=[];for(const i of this._config.groupbyfields){const r={name:i.name,singlefield:null,tofieldname:i.name,expression:i.expression instanceof Se?i.expression:Se.create(i.expression,_,this.dateFieldsTimeZoneDefaultUTC),sqlType:null};this._decodedGroupbyfield.push(r)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const i of this._parent.fields)r[i.name.toUpperCase()]=1;this.types=null,this.subtypes=null,this.subtypeField=""}else this.geometryType=se.point,this.typeIdField="",this.types=null,this.subtypes=null,this.subtypeField="",this.spatialReference=new i({wkid:4326});this.fields=[];const y=new dt;y.field=this._nextUniqueName(r),y.tofieldname=this.objectIdField,y.workingexpr=Se.create(this._parent.objectIdField,this._parent.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC),y.typeofstat="MIN",this._decodedStatsfield.push(y);for(const i of this._decodedGroupbyfield){const n=new h;if(i.name=this._nextUniqueName(r),n.name=i.tofieldname,n.alias=n.name,Me(i.expression)){const r=this._parent.getField(Le(i.expression,ne.Standardised));if(!r)throw new Ie(ve.AggregationFieldNotFound);i.name=r.name,i.singlefield=r.name,this.phsyicalgroupbyfields.push(r.name),n.type=r.type,i.sqlType=r.type}else{n.type=this._convertToEsriFieldType(We(i.expression,this._parent.fields));const r=new h;r.name=i.name,r.alias=r.name,this.phsyicalgroupbyfields.push(i.name),this._adaptedFields.push(new B(r,i.expression)),this._candosimplegroupby=!1,i.sqlType=n.type}this.fields.push(n)}if(this._adaptedFields.length>0)for(const i of this._parent.fields)this._adaptedFields.push(new I(i));for(let i=0;i<this._decodedStatsfield.length;i++){const n=new h;let o=null;const u=this._decodedStatsfield[i];u.field=this._nextUniqueName(r),u.tofieldname===this.objectIdField&&(this._internalObjectIdField=u.field),n.name=u.tofieldname,n.alias=n.name;const _=null!==u.workingexpr&&Me(u.workingexpr)?Le(u.workingexpr,ne.Standardised):"";switch(this._decodedStatsfield[i].typeofstat){case"SUM":if(""!==_){if(o=this._parent.getField(_),!o)throw new Ie(ve.AggregationFieldNotFound);n.type=o.type}else n.type="double";break;case"MIN":case"MAX":if(""!==_){if(o=this._parent.getField(_),!o)throw new Ie(ve.AggregationFieldNotFound);n.type=o.type}else n.type="double";break;case"COUNT":n.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==_&&(o=this._parent.getField(_),!o))throw new Ie(ve.AggregationFieldNotFound);n.type="double"}this.fields.push(n)}}async _canDoAggregates(){return!1}async _getFeatures(i,r,n,o){-1!==r&&this._featureCache[r];const u=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(i,u)?(await this._expandPagedSet(i,u,0,0,o),this._getFeatures(i,r,n,o)):"success"}async _getFilteredSet(i,r,n,o,u){if(""!==i)return new Re([],[],!0,null);let h=null;const _={ordered:!1,nowhereclause:!1};if(await this._ensureLoaded(),null!==n)for(let w=0;w<this._decodedStatsfield.length;w++)if(!0===Ue(n,this._decodedStatsfield[w].tofieldname)){_.nowhereclause=!0,n=null;break}if(null!==o){_.ordered=!0;for(let i=0;i<this._decodedStatsfield.length;i++)if(!0===o.scanForField(this._decodedStatsfield[i].tofieldname)){o=null,_.ordered=!1;break}if(null!==o)for(const i of this._decodedGroupbyfield)if(null===i.singlefield&&!0===o.scanForField(i.tofieldname)){o=null,_.ordered=!1;break}}if(!1!==this._candosimplegroupby&&await this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null)){let i=null;n&&(i=this._reformulateWhereClauseWithoutGroupByFields(n));let r=null;o&&(r=this._reformulateOrderClauseWithoutGroupByFields(o));const y=await this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,i,r,this._internalObjectIdField);return this._checkCancelled(u),h=!0===_.nowhereclause?new Re(y._candidates.slice(0).concat(y._known.slice(0)),[],!0===_.ordered&&y._ordered,this._clonePageDefinition(y.pagesDefinition)):new Re(y._candidates.slice(0),y._known.slice(0),!0===_.ordered&&y._ordered,this._clonePageDefinition(y.pagesDefinition)),h}let y=this._parent;if(this._adaptedFields.length>0&&(y=new L({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null})),!0===_.nowhereclause)h=new Re(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new ut({parentfeatureset:y,orderbyclause:new e2(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}});else{let i=y;if(null!==n){let r=null;n&&(r=this._reformulateWhereClauseWithoutGroupByFields(n)),i=new rt({parentfeatureset:i,whereclause:r})}h=new Re(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new ut({parentfeatureset:i,orderbyclause:new e2(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}})}return h}_reformulateWhereClauseWithoutStatsFields(i){for(const r of this._decodedStatsfield)i=Ne(i,r.tofieldname,Le(r.workingexpr,ne.Standardised),this._parent.getFieldsIndex());return i}_reformulateWhereClauseWithoutGroupByFields(i){for(const r of this._decodedGroupbyfield)r.tofieldname!==r.name&&(i=Ne(i,r.tofieldname,Le(r.expression,ne.Standardised),this._parent.getFieldsIndex()));return i}_reformulateOrderClauseWithoutGroupByFields(i){const r=[];for(const n of this._decodedGroupbyfield)n.tofieldname!==n.name&&r.push({field:n.tofieldname,newfield:n.name});return r.length>0?i.replaceFields(r):i}_clonePageDefinition(i){return null===i?null:!0===i.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:i.resultRecordCount,resultOffset:i.resultOffset,internal:i.internal}:this._parent._clonePageDefinition(i)}async _refineSetBlock(i,r,n){return!0===this._checkIfNeedToExpandCandidatePage(i,this._maxQuery)?(await this._expandPagedSet(i,this._maxQuery,0,0,n),this._refineSetBlock(i,r,n)):(this._checkCancelled(n),i._candidates.length,this._refineKnowns(i,r),i._candidates.length,i._candidates.length,i)}_expandPagedSet(i,r,n,o,u){return this._expandPagedSetFeatureSet(i,r,n,o,u)}async _getPhysicalPage(i,r,n){if(!0===i.pagesDefinition.aggregatefeaturesetpagedefinition)return this._sequentialGetPhysicalItem(i,i.pagesDefinition.resultRecordCount,n,[]);const u=await this._getAgregagtePhysicalPage(i,r,n);for(const h of u){const i={geometry:h.geometry,attributes:{}},r={};for(const n in h.attributes)r[n.toLowerCase()]=h.attributes[n];for(const n of this._decodedGroupbyfield)i.attributes[n.tofieldname]=r[n.name.toLowerCase()];for(const n of this._decodedStatsfield)i.attributes[n.tofieldname]=r[n.field.toLowerCase()];this._featureCache[i.attributes[this.objectIdField]]=new o(i)}return u.length}_sequentialGetPhysicalItem(i,r,n,o){return new Promise(((u,h)=>{null===i.pagesDefinition.internal.iterator&&(i.pagesDefinition.internal.iterator=i.pagesDefinition.internal.subfeatureset.iterator(n)),!0===i.pagesDefinition.internal.fullyResolved||0===r?u(o.length):this._nextAggregateItem(i,r,n,o,(h=>{null===h?u(o.length):(r-=1,u(this._sequentialGetPhysicalItem(i,r,n,o)))}),h)}))}_nextAggregateItem(i,r,n,o,u,h){try{ce(i.pagesDefinition.internal.iterator.next()).then((_=>{if(null===_)if(null!==i.pagesDefinition.internal.workingItem){const r=this._calculateAndAppendAggregateItem(i.pagesDefinition.internal.workingItem);o.push(r),i.pagesDefinition.internal.workingItem=null,i.pagesDefinition.internal.set.push(r.attributes[this.objectIdField]),i.pagesDefinition.internal.fullyResolved=!0,u(null)}else i.pagesDefinition.internal.fullyResolved=!0,u(null);else{const y=this._generateAggregateHash(_);if(null===i.pagesDefinition.internal.workingItem)i.pagesDefinition.internal.workingItem={features:[_],id:y};else{if(y!==i.pagesDefinition.internal.workingItem.id){const n=this._calculateAndAppendAggregateItem(i.pagesDefinition.internal.workingItem);return o.push(n),i.pagesDefinition.internal.workingItem=null,i.pagesDefinition.internal.set.push(n.attributes[this.objectIdField]),r-=1,i.pagesDefinition.internal.workingItem={features:[_],id:y},void u(n)}i.pagesDefinition.internal.workingItem.features.push(_)}this._nextAggregateItem(i,r,n,o,u,h)}}),h)}catch(_){h(_)}}_calculateFieldStat(i,r,n){const o=[];for(let u=0;u<i.features.length;u++)if(null!==r.workingexpr){const n=r.workingexpr.calculateValue(i.features[u]);null!==n&&(n instanceof Ke||n instanceof Xe?o.push(n.toNumber()):n instanceof De?o.push(n.toMilliseconds()):o.push(n))}else o.push(null);switch(r.typeofstat){case"MIN":n.attributes[r.tofieldname]=Ve("min",o,-1);break;case"MAX":n.attributes[r.tofieldname]=Ve("max",o,-1);break;case"SUM":n.attributes[r.tofieldname]=Ve("sum",o,-1);break;case"COUNT":n.attributes[r.tofieldname]=o.length;break;case"VAR":n.attributes[r.tofieldname]=Ve("var",o,-1);break;case"STDDEV":n.attributes[r.tofieldname]=Ve("stddev",o,-1);break;case"AVG":n.attributes[r.tofieldname]=Ve("avg",o,-1)}return!0}_calculateAndAppendAggregateItem(i){const r={attributes:{},geometry:null};for(const o of this._decodedGroupbyfield){const n=o.singlefield?i.features[0].attributes[o.singlefield]:Se.convertValueToStorageFormat(o.expression.calculateValue(i.features[0]),o.sqlType);r.attributes[o.tofieldname]=n}for(const o of this._decodedStatsfield)this._calculateFieldStat(i,o,r);const n=[];for(let o=0;o<this._decodedStatsfield.length;o++)n.push(this._calculateFieldStat(i,this._decodedStatsfield[o],r));return this._featureCache[r.attributes[this.objectIdField]]=new o({attributes:r.attributes,geometry:r.geometry}),r}_generateAggregateHash(i){let r="";for(const n of this._decodedGroupbyfield){const o=n.singlefield?i.attributes[n.singlefield]:n.expression.calculateValue(i);r+=null==o?":":":"+o.toString()}return _(r,y.String)}async _stat(){return{calculated:!1}}async getFeatureByObjectId(){return null}static registerAction(){ke._featuresetFunctions.groupby=function(i,r){return new O({parentfeatureset:this,groupbyfields:i,statsfields:r})}}}.registerAction(),ut.registerAction(),Ze.registerAction(),a3.registerAction();class j extends at{constructor(i,r=null,n=null,o=null){super(),this._map=i,this._overridespref=r,this._lrucache=n,this._interceptor=o,this._instantLayers=[]}_makeAndAddFeatureSet(i,r=!0,n=null){const o=T(i,this._overridespref,null===n?["*"]:n,r,this._lrucache,this._interceptor);return this._instantLayers.push({featureset:o,opitem:i,includeGeometry:r,outFields:JSON.stringify(n)}),o}async featureSetByName(i,r=!0,n=null){if(ie.isLoadable(this._map)&&!this._map.loaded)return await this._map.load(),this.featureSetByName(i,r,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const o=JSON.stringify(n);for(let h=0;h<this._instantLayers.length;h++){const n=this._instantLayers[h];if(n.opitem.title===i&&n.includeGeometry===r&&n.outFields===o)return this._instantLayers[h].featureset}const u=this._map.allLayers.find((r=>be(r)&&r.title===i));if(null!=u)return this._makeAndAddFeatureSet(u,r,n);if(this._map.tables){const o=this._map.tables.find((r=>r.title===i));if(null!=o){if(o instanceof Q)return this._makeAndAddFeatureSet(o,r,n);if(null==o._materializedTable){const i=o.outFields?o:{...o,outFields:["*"]};o._materializedTable=new Q(i)}return await o._materializedTable.load(),this._makeAndAddFeatureSet(o._materializedTable,r,n)}}return null}async featureSetById(i,r=!0,n=["*"]){if(ie.isLoadable(this._map)&&!this._map.loaded)return await this._map.load(),this.featureSetById(i,r,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const o=JSON.stringify(n);for(let h=0;h<this._instantLayers.length;h++){const n=this._instantLayers[h];if(n.opitem.id===i&&n.includeGeometry===r&&n.outFields===o)return this._instantLayers[h].featureset}const u=this._map.allLayers.find((r=>be(r)&&r.id===i));if(u)return this._makeAndAddFeatureSet(u,r,n);if(this._map.tables){const o=this._map.tables.find((r=>r.id===i));if(null!=o){if(o instanceof Q)return this._makeAndAddFeatureSet(o,r,n);if(null==o._materializedTable){const i={...o,outFields:["*"]};o._materializedTable=new Q(i)}return await o._materializedTable.load(),this._makeAndAddFeatureSet(o._materializedTable,r,n)}}return null}}class D2 extends at{constructor(i,r=null,n=null,o=null){super(),this._url=i,this._overridespref=r,this._lrucache=n,this._interceptor=o,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(i,r=!0,n=null){const o=T(i,this._overridespref,null===n?["*"]:n,r,this._lrucache);return this._instantLayers.push({featureset:o,opitem:i,includeGeometry:r,outFields:JSON.stringify(n)}),o}async _loadMetaData(){const i=await k2(this._url,this._lrucache);return this.metadata=i,i}load(){return this._loadMetaData()}clone(){return new D2(this._url,this._overridespref,this._lrucache,this._interceptor)}async featureSetByName(i,r=!0,n=null){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const o=JSON.stringify(n);for(let _=0;_<this._instantLayers.length;_++){const n=this._instantLayers[_];if(n.opitem.title===i&&n.includeGeometry===r&&n.outFields===o)return this._instantLayers[_].featureset}const u=await this._loadMetaData();let h=null;for(const _ of u.layers??[])_.name===i&&(h=_);if(!h)for(const _ of u.tables??[])_.name===i&&(h=_);if(h){const i=await g(this._url+"/"+h.id,["*"],this._lrucache);return this._makeAndAddFeatureSet(i,r,n)}return null}async featureSetById(i,r=!0,n=["*"]){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const o=JSON.stringify(n);i=null!=i?i.toString():"";for(let _=0;_<this._instantLayers.length;_++){const n=this._instantLayers[_];if(n.opitem.id===i&&n.includeGeometry===r&&n.outFields===o)return this._instantLayers[_].featureset}const u=await this._loadMetaData();let h=null;for(const _ of u.layers??[])null!==_.id&&void 0!==_.id&&_.id.toString()===i&&(h=_);if(!h)for(const _ of u.tables??[])null!==_.id&&void 0!==_.id&&_.id.toString()===i&&(h=_);if(h){const i=await g(this._url+"/"+h.id,["*"],this._lrucache);return this._makeAndAddFeatureSet(i,r,n)}return null}}function q(i,r,n,o,u){if(null===i)return null;if(we(i)){switch(r){case"datasource":return i.getDataSourceFeatureSet();case"parent":return i;case"root":return i.getRootFeatureSet()}return null}if(i instanceof ee&&me(i)){const h=i;switch(r){case"datasource":return T(h,u,h.outFields,!0,n,o).getDataSourceFeatureSet();case"parent":case"root":return T(h,u,h.outFields,!0,n,o)}return null}if(Fe(i)){switch(r){case"datasource":return T(i.parent,u,i.parent.outFields,!0,n,o).getDataSourceFeatureSet();case"parent":case"root":return T(i,u,i.parent.outFields,!0,n,o)}return null}return null}async function G(i,r,n,o,u,h,_,y=null){if(ze.applicationCache){const w=ze.applicationCache.getLayerInfo(i+":"+h.url);if(w){const i=await w;return T(await g(_e(i.url??"")+"/"+r,["*"],_),n,o,u,_,y)}}if(null!=_){const w=_.getCachedPortalItem(h.url,i);if(null!=w){const i=await w;return T(await g(_e(i.url??"")+"/"+r,["*"],_),n,o,u,_,y)}}const w=new te({id:i,portal:h}).load();ze.applicationCache?ze.applicationCache.setLayerInfo(i+":"+h.url,w):null!=_&&_.setCachedPortalItem(h.url,i,w);try{const i=await w;return T(await g(_e(i.url??"")+"/"+r,["*"],_),n,o,u,_,y)}catch(S){throw ze.applicationCache&&ze.applicationCache.clearLayerInfo(i+":"+h.url),null!=_&&_.removeCachedPortalItem(h.url,i,w),S}}const ct=Object.freeze(Object.defineProperty({__proto__:null,constructAssociationMetaDataFeatureSetFromUrl:O2,constructFeatureSet:T,constructFeatureSetFromPortalItem:G,constructFeatureSetFromRelationship:E,constructFeatureSetFromUrl:N,convertToFeatureSet:q,createFeatureSetCollectionFromMap:function v(i,r,n=null,o=null){return new j(i,r,n,o)},createFeatureSetCollectionFromService:function M(i,r,n=null,o=null){return new D2(i,r,n,o)},initialiseMetaDataCache:function F(){null===ze.applicationCache&&(ze.applicationCache=new ze)}},Symbol.toStringTag,{value:"Module"}));export{B,E,G,I,L,N,O2 as O,T,ut as a,a3 as b,rt as c,ht as d,e2 as e,ot as f,ct as g,lt as k,q};
