const __vite__fileDeps=["assets/ManipulatedObject3DMediaElement-CD7GSP77.js","assets/index-DSIPxOWi.js","assets/index-B_7YxLDX.css","assets/EditGeometryOperations-sseMUvB1.js","assets/geometry2dUtils-4c9qUvJ6.js","assets/VideoElement-BA4EzDol.js","assets/resourceExtension-BScMZjEL.js","assets/MediaElementView-DU1VM6lV.js","assets/normalizeUtilsSync-B5F66Zka.js","assets/normalizeUtilsCommon-BU8xfl77.js","assets/editingTools-CkSu_5JF.js","assets/TextOverlayItem-BcN_gvXw.js","assets/unitFormatUtils-B9MPZ1wj.js","assets/SnappingOperation-CpAicAwN.js","assets/geodesicLengthMeasurementUtils-Pq-FipkN.js","assets/geometryEngine-Bp1TD6MM.js","assets/geometryEngineBase-9EI9fooq.js","assets/hydrated-DE1HcVsK.js","assets/ExtendedLineVisualElement-C_fk7Jva.js","assets/vec4f32-APunXZaC.js","assets/EngineVisualElement-Cxk2Aaf7.js","assets/LineVisualElement-EjMrPPob.js","assets/Laserlines.glsl-C_dc6leb.js","assets/PointVisualElement-kTFgcxXB.js","assets/RightAngleQuadVisualElement-CPtUkCyd.js","assets/SnappingManagerPool-BslN_FM5.js","assets/floorFilterUtils-2NbRkqHK.js","assets/keybindings-DkkJsHdp.js","assets/PointSnappingHint-Ct-FTQTL.js","assets/ShadedColorMaterial.glsl-C-XXTK_B.js","assets/dehydratedFeatureComparison-dI04k89u.js","assets/MoveManipulation-4UnOjdbg.js","assets/dragEventPipeline3D-C-8mYpU2.js","assets/MeshTransform-Y0ppddED.js","assets/euclideanAreaMeasurementUtils-D_-Y3voK.js","assets/memoize-Dzy0sPL8.js","assets/ReactiveSet-XbWJTkHf.js","assets/manipulatorUtils-ypp-R_oV.js","assets/SlicePlaneMaterial.glsl-AaZx_lGc.js","assets/sliceToolConfig-Doq59PhP.js","assets/ImageMaterial.glsl-V3C9c4TG.js","assets/persistable-Bz3xp-b5.js","assets/projectionUtils-B1mpMSec.js","assets/Factory-CfOltYNW.js","assets/drapedUtils-DOQFzwPw.js","assets/LayerView3D-ApO6iJqK.js","assets/LayerView-DMoB2q_T.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{e,y as a,a as o,S as l,h as d,h5 as c,a0 as h,c_ as p,z as _,lc as m,P as u,cV as y,u as g,_ as v,d9 as f,mG as E,ee as T,hD as w,mH as b,r as D,T as M,C as O,g as R,A,bd as P,ef as I,cU as j,g$ as H,ea as S,dW as x,eb as C,dP as V,ho as L,mI as z,dX as G,b as k,hp as U,hq as W,cv as N}from"./index-DSIPxOWi.js";import{m as $,j as Y}from"./MediaElementView-DU1VM6lV.js";import{l as q}from"./LayerView3D-ApO6iJqK.js";import{d as F,h as K}from"./keybindings-DkkJsHdp.js";import{c as B}from"./SnappingManagerPool-BslN_FM5.js";import{g as Q}from"./ImageMaterial.glsl-V3C9c4TG.js";import{y as X}from"./LayerView-DMoB2q_T.js";function e$1(){return[1,0,0,1,0,0]}function r(e){return[e[0],e[1],e[2],e[3],e[4],e[5]]}const Z=[1,0,0,1,0,0];Object.freeze(Object.defineProperty({__proto__:null,IDENTITY:Z,clone:r,create:e$1,createView:function n(e,a){return new Float64Array(e,a,6)},fromValues:function t(e,a,o,l,d,c){return[e,a,o,l,d,c]}},Symbol.toStringTag,{value:"Module"}));const J=Symbol(),ee=Symbol();let te=class extends l{get updating(){return this._updatingHandles.updating}get _preferredInteractionTool(){var e;return(null==(e=this.options)?void 0:e.tool)??"transform"}get _toolType(){switch(this._preferredInteractionTool){case"transform":return"transform-3d";case"reshape":return"reshape-3d"}}get _validatedSelectedElement(){const e=this.selectedElement;if(!e)return null;const{layer:{source:a}}=this;return a?"hasElement"in a?a.hasElement(e)?e:null:a===e?e:null:null}constructor(e){super(e),this.enabled=!1,this._updatingHandles=new d,this._isOpacityToggled=!1,this._factor=1,this._tool=null,this._object=null,this._createToolAbortController=null,this._onPointerMove=c((async e=>{const a=await this._updatingHandles.addPromise(this._findElementAtScreenPoint(e));this.destroyed||(this.removeHandles(ee),a&&a!==this.selectedElement&&(this.view.cursor="pointer",this.addHandles(h((()=>this.view.cursor=null)),ee)))})),this._tmpMat2=[1,0,0,1,0,0],this._tmpVec2=p()}destroy(){this._createToolAbortController=_(this._createToolAbortController)}initialize(){this.addHandles([m(this._updatingHandles),this._updatingHandles.add((()=>this.enabled),(e=>this._enableDisable(e)),u),this._updatingHandles.add((()=>this._preferredInteractionTool),(e=>this._preferredInteractionToolChanged(e)))])}_enableDisable(e){if(!e)return void this.removeHandles(J);this._dynamicImports();const{view:a}=this,o=new K;o.add(F.undo,(()=>{var e,a,o;null==(a=null==(e=this._object)?void 0:e.operations)||a.undo(),null==(o=this._object)||o.emit("modified-externally")})),o.add(F.redo,(()=>{var e,a,o;null==(a=null==(e=this._object)?void 0:e.operations)||a.redo(),null==(o=this._object)||o.emit("modified-externally")})),o.addToggle(F.preserveAspectRatio,(e=>{var a;"transform-3d"===(null==(a=this._tool)?void 0:a.type)&&(this._tool.preserveAspectRatio="key-down"===e.type)})),o.addToggle(F.rotateIncrements,(e=>{var a;"transform-3d"===(null==(a=this._tool)?void 0:a.type)&&(this._tool.snapRotation="key-down"===e.type)})),o.add(F.toggleOpacity,(()=>{var e;const a=null==(e=this._object)?void 0:e.element;a&&(a.opacity*=this._isOpacityToggled?2:.5,this._isOpacityToggled=!this._isOpacityToggled)})),o.add(F.moveUp,(()=>this._move(0,this._factor))),o.add(F.moveDown,(()=>this._move(0,-this._factor))),o.add(F.moveRight,(()=>this._move(this._factor,0))),o.add(F.moveLeft,(()=>this._move(-this._factor,0))),o.addToggle(F.factorModifier,(e=>this._factor="key-down"===e.type?10:1)),this._isOpacityToggled=!1,this.addHandles([o.register(a,y.TOOL),h((()=>{this._isOpacityToggled&&this.selectedElement&&(this.selectedElement.opacity*=2,this._isOpacityToggled=!1)})),a.on("immediate-click",(e=>this._onClick(e)),y.TOOL),a.on("pointer-move",(e=>this._onPointerMove(e).catch((()=>{}))),y.TOOL),this._updatingHandles.add((()=>this._validatedSelectedElement),((e,a)=>{a&&e!==a&&this._isOpacityToggled&&(a.opacity*=2,this._isOpacityToggled=!1),this._selectedElementChanged(e)}),u),h((()=>{a.cursor=null,this._removeTool()}))],J)}async _onClick(e){await this._updatingHandles.addPromise(e.async((async()=>{const a=await this._findElementAtScreenPoint(e);this.destroyed||(a&&e.stopPropagation(),this.selectedElement=a,this.selectedElement&&(this.view.cursor=null))})))}async _selectedElementChanged(e){var a;(null==e?void 0:e.georeference)?(null==(a=this._object)?void 0:a.element)!==e&&await this._updatingHandles.addPromise(this._recreateTool()):this._removeTool()}async _recreateTool(){this._createToolAbortController=_(this._createToolAbortController),this._removeTool();const e=this._validatedSelectedElement;if(!e)return;const a=new AbortController;this._createToolAbortController=a;const{ManipulatedObject3DMediaElement:o,ExtentTransformTool:l,ReshapeTool3D:d}=await this._dynamicImports();if(a.signal.aborted)return;const{view:c,layer:p,_toolType:m}=this;switch(this._object=new o({view:c,layer:p,element:e,tool:this._preferredInteractionTool}),m){case"transform-3d":{this._tool=new l({view:c,object:this._object});const e=c.inputManager;e.isModifierKeyDown(F.rotateIncrements.key)&&(this._tool.snapRotation=!0),e.isModifierKeyDown(F.preserveAspectRatio.key)&&(this._tool.preserveAspectRatio=!0)}break;case"reshape-3d":{const e=B(c);this.addHandles(e,this._tool);const{snappingManager:a}=e;this._tool=new d({view:c,object:this._object,enableMidpoints:!1,enableZShape:!1,snappingManager:a,enableMoveObject:!1,autoHideManipulators:!0,enableDeleteVertices:!1})}}this.addHandles([h((()=>{this._object=g(this._object),this._tool&&(c.tools.remove(this._tool),this._tool=null)}))],this._tool),c.addAndActivateTool(this._tool)}_preferredInteractionToolChanged(e){const{_tool:a}=this;if(!a)return;if(this._toolType!==a.type)return void this._updatingHandles.addPromise(this._recreateTool());const{_object:o}=this;o&&(o.tool=e)}async _dynamicImports(){const[{ManipulatedObject3DMediaElement:e},{ExtentTransformTool:a,ReshapeTool3D:o}]=await Promise.all([v((()=>import("./ManipulatedObject3DMediaElement-CD7GSP77.js")),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])),v((()=>import("./editingTools-CkSu_5JF.js")),__vite__mapDeps([10,1,2,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,4,26,27,28,29,3,30,31,32,33,34,35,36,37,38,39,40,41,6,42,43,44,7,8,9,45,46]))]);return{ManipulatedObject3DMediaElement:e,ExtentTransformTool:a,ReshapeTool3D:o}}async _findElementAtScreenPoint(e){const a=(await this.view.hitTest(e,{include:[this.layer]})).results[0];return"media"===(null==a?void 0:a.type)?a.element:null}_removeTool(){this._tool&&this.removeHandles(this._tool)}_move(e,a){const{view:o,_object:l}=this,d=null==l?void 0:l.operations;if(!d)return;const c=o.overlayPixelSizeInMapUnits(o.pointsOfInterest.focus.location)*f(o.spatialReference)/f(d.data.spatialReference),{_tmpMat2:h,_tmpVec2:p}=this,_=E(h,T(360-this.view.camera.heading)),m=w(p,c*e,c*a);b(m,m,_),d.move(m[0],m[1],0),l.emit("modified-externally")}};e([a({constructOnly:!0})],te.prototype,"view",void 0),e([a({constructOnly:!0})],te.prototype,"layer",void 0),e([a()],te.prototype,"selectedElement",void 0),e([a()],te.prototype,"enabled",void 0),e([a()],te.prototype,"options",void 0),e([a()],te.prototype,"updating",null),e([a()],te.prototype,"_preferredInteractionTool",null),e([a()],te.prototype,"_validatedSelectedElement",null),te=e([o("esri.views.3d.layers.support.MediaLayerInteraction")],te);let ie=class extends l{constructor(){super(...arguments),this.tool="transform"}};e([a()],ie.prototype,"tool",void 0),ie=e([o("esri.views.3d.layers.support.MediaLayerInteractionOptions")],ie);const s=l=>{let d=class extends l{constructor(...e){super(...e),this.layer=null,this.interactive=!1,this.interactionOptions=new ie,this.selectedElement=null}};return e([a()],d.prototype,"layer",void 0),e([a()],d.prototype,"interactive",void 0),e([a()],d.prototype,"interactionOptions",void 0),e([a()],d.prototype,"selectedElement",void 0),d=e([o("esri.views.layers.MediaLayerView")],d),d};let ne=class extends(q(s(X))){get interactive(){return this._interaction.enabled}set interactive(e){this._interaction&&(this._interaction.enabled=e)}get selectedElement(){return this._interaction.selectedElement}set selectedElement(e){this._interaction&&(this._interaction.selectedElement=e)}get visibleAtCurrentScale(){return D(this.layer.effectiveScaleRange,this.view.terrainScale)}constructor(e){super(e),this.type="media-3d",this.drapeSourceType=M.RasterImage,this.updatePolicy=O.ASYNC,this._uidToElement=new Map,this._renderedElements=new Map,this._lastDrapingExtent=null,this._update=c((async(e,a,o)=>{const l=await this._collectMediaElements(e,a,o);this._synchronizeRenderElements(l)}),0);const{view:a,layer:o}=e;this._interaction=new te({view:a,layer:o}),this.addHandles(R((()=>this.interactionOptions),(e=>this._interaction.options=e),A))}initialize(){const{view:e,layer:a}=this;this._renderer=e.basemapTerrain.overlayManager.registerGeometryDrapeSource(this);const i=()=>this._updateWithLastDrapingExtent();this.addHandles([h((()=>e.basemapTerrain.overlayManager.unregisterDrapeSource(this))),P((()=>a.effectiveSource),"change",i),P((()=>a.effectiveSource),"refresh",i)]),this._updatingHandles.add((()=>this.suspended),i)}setDrapingExtent(e,a){this._lastDrapingExtent={overlays:e,spatialReference:a},this._updateWithLastDrapingExtent()}getHit(e){const a=this._uidToElement.get(e);return a?{type:"media",element:a,layer:this.layer}:null}isUpdating(){return super.isUpdating()||this._interaction.updating}_updateWithLastDrapingExtent(){if(null==this._lastDrapingExtent||this.suspended)return void(this._renderer&&this._synchronizeRenderElements(new Set));const{overlays:e,spatialReference:a}=this._lastDrapingExtent;this._updatingHandles.addPromise(this._update(e,a).catch((()=>{})))}async _collectMediaElements(e,a,o){const l=this.layer.effectiveSource;return null==l?new Set:new Set((await Promise.all(e.map((e=>l.queryElements(I(e.extent,a),{signal:o}))))).flat())}_synchronizeRenderElements(e){this._synchronizeRenderElementsRemove(e),this._synchronizeRenderElementsAdd(e)}_synchronizeRenderElementsRemove(e){const a=[];this._renderedElements.forEach(((o,l)=>{e.has(l)||(null!=o.renderData&&a.push(o.renderData.renderGeometry),this._removeElement(l,o),this.emit("element-render-changed",{element:l}))}))}_synchronizeRenderElementsAdd(e){for(const a of e)this._renderedElements.has(a)||this._createRenderElement(a)}_removeElement(e,{renderData:a,handle:o}){this._destroyRenderData(e,a),this._renderedElements.delete(e),this._uidToElement.delete(e.uid),o.remove()}async _createRenderElement(e){const a=new $({spatialReference:this.view.spatialReference,element:e}),o={renderData:null,handle:j([this._updatingHandles.add((()=>e.opacity),(e=>{null!=o.renderData&&o.renderData.material.setParameters({opacity:e})})),this._updatingHandles.add((()=>a.coords),(()=>{null!=o.renderData?this._updateGeometry(a,o,o.renderData):this._initializeRenderData(a,o)})),this._updatingHandles.add((()=>e.content),(()=>this._initializeRenderData(a,o))),m(a)])};this._renderedElements.set(e,o),this._uidToElement.set(e.uid,e),this._updatingHandles.addPromise(e.load().catch((()=>{}))),this._initializeRenderData(a,o)}_initializeRenderData(e,a){const{coords:o,element:l}=e,{contentWidth:d,contentHeight:c}=l;if(null==o||null==l.content)return void(a.renderData=this._destroyRenderData(l,a.renderData));if(null!=a.renderData)return;const h=this._createTexture(l.content),p=h.load(this.view._stage.renderView.renderingContext);this.view._stage.add(h),H(p)&&this._updatingHandles.addPromise(p);const _=new Q({initTextureTransparent:!0,textureId:h.id,opacity:l.opacity,transparent:!0,perspectiveInterpolation:!0}),m=this._getPositionAttributeArray(o),u=this._getPerspectiveDivideAttributeArray(m,d,c),y=[0,1,2,0,2,3],g=new S(_,[[x.POSITION,new C(m,y,3,!0)],[x.UV0,new C([0,0,1,0,1,1,0,1],y,2,!0)],[x.PERSPECTIVEDIVIDE,new C(u,y,1,!0)]]),v=new V(g,{layerUid:this.layer.uid,graphicUid:l.uid});this._renderer.addGeometries([v],L.ADD),a.renderData={renderGeometry:v,texture:h,material:_},this.emit("element-render-changed",{element:l})}_updateGeometry(e,a,o){const{coords:l,element:d}=e;if(null==l||null==d.content)return void(a.renderData=this._destroyRenderData(d,a.renderData));const c=this._getPositionAttributeArray(l);o.renderGeometry.geometry.setAttributeData(x.POSITION,c);const h=this._getPerspectiveDivideAttributeArray(c,d.contentWidth,d.contentHeight);o.renderGeometry.geometry.setAttributeData(x.PERSPECTIVEDIVIDE,h),o.renderGeometry.geometry.invalidateBoundingInfo(),this._renderer.modifyGeometries([o.renderGeometry],z.GEOMETRY),this.emit("element-render-changed",{element:d})}_getPositionAttributeArray(e){const[a,o,l,d]=e.rings[0];return[a[0],a[1],G,d[0],d[1],G,l[0],l[1],G,o[0],o[1],G]}_getPerspectiveDivideAttributeArray(e,a,o){Y(re,[0,0,a,0,a,o,0,o],[e[0],e[1],e[3],e[4],e[6],e[7],e[9],e[10]]);const l=re[6]/re[8]*a,d=re[7]/re[8]*o;return[1,1+l,1+l+d,1+d]}_destroyRenderData(e,a){if(null==a)return null;const o=a.texture;return o.unload(),this.view._stage.remove(o),this._renderer.removeGeometries([a.renderGeometry],L.REMOVE),this.emit("element-render-changed",{element:e}),null}_createTexture(e){const a=e instanceof HTMLImageElement?e.naturalWidth:e.width,o=e instanceof HTMLImageElement?e.naturalHeight:e.height;if("getFrame"in e)throw new k("media-layer-view-3d","animation is not supported");return new U(e,{wrap:{s:W.CLAMP_TO_EDGE,t:W.CLAMP_TO_EDGE},preMultiplyAlpha:!0,width:a,height:o,mipmap:!0,updateCallback:()=>this.view.basemapTerrain.overlayManager.setDrawTexturesDirty()})}get test(){}};e([a({readOnly:!0})],ne.prototype,"type",void 0),e([a()],ne.prototype,"layer",void 0),e([a()],ne.prototype,"interactive",null),e([a()],ne.prototype,"selectedElement",null),e([a({readOnly:!0})],ne.prototype,"visibleAtCurrentScale",null),ne=e([o("esri.views.3d.layers.MediaLayerView3D")],ne);const re=N(),se=ne,ae=Object.freeze(Object.defineProperty({__proto__:null,default:se},Symbol.toStringTag,{value:"Module"}));export{ae as M,e$1 as e,r};
