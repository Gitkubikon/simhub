import{e,y as t,a as r,u as i,b as a,b3 as s,az as o}from"./index-DSIPxOWi.js";import{N as n}from"./DynamicLayerView3D-C51-uYFg.js";import{a as p}from"./ExportWMSImageParameters-QCOpDXr6.js";import{i as h}from"./timeSupport-CU-EQyfu.js";import"./LayerView3D-ApO6iJqK.js";import"./projectExtentUtils-KG39_WUt.js";import"./ImageMaterial.glsl-V3C9c4TG.js";import"./LayerView-DMoB2q_T.js";import"./RefreshableLayerView-MYyyoaX8.js";const m=o=>{let n=class extends o{initialize(){this.exportImageParameters=new p({layer:this.layer})}destroy(){this.exportImageParameters=i(this.exportImageParameters)}get exportImageVersion(){var e;return null==(e=this.exportImageParameters)||e.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}get timeExtent(){var e;return h(this.layer,null==(e=this.view)?void 0:e.timeExtent,this._get("timeExtent"))}async fetchPopupFeaturesAtLocation(e,t){const{layer:r}=this;if(!e)throw new a("wmslayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:r});const{popupEnabled:i}=r;if(!i)throw new a("wmslayerview:fetchPopupFeatures","popupEnabled should be true",{popupEnabled:i});const o=this.createFetchPopupFeaturesQuery(e);if(!o)return[];const{extent:n,width:p,height:h,x:l,y:u}=o;if(!(n&&p&&h))throw new a("wmslayerview:fetchPopupFeatures","WMSLayer does not support fetching features.",{extent:n,width:p,height:h});const c=await r.fetchFeatureInfo(n,p,h,l,u);return s(t),c}};return e([t()],n.prototype,"exportImageParameters",void 0),e([t({readOnly:!0})],n.prototype,"exportImageVersion",null),e([t()],n.prototype,"layer",void 0),e([t({readOnly:!0})],n.prototype,"timeExtent",null),n=e([r("esri.views.layers.WMSLayerView")],n),n};let l=class extends(m(n)){constructor(){super(...arguments),this.type="wms-3d"}initialize(){this.layer.serviceSupportsSpatialReference(this.view.spatialReference)||this.addResolvingPromise(Promise.reject(new a("layerview:spatial-reference-incompatible","The spatial references supported by this WMS layer are incompatible with the spatial reference of the view"))),this._updatingHandles.add((()=>{var e;return null==(e=this.exportImageParameters)?void 0:e.version}),(()=>{this._updatingHandles.addPromise(this.refreshDebounced())}))}createFetchPopupFeaturesQuery(e){const t=this.findExtentInfoAt(e),r=t.extent,i=new o(r[0],r[1],r[2],r[3],this._spatialReference),a=t.imageSize,s=a.width,n=a.height,p=i.width/s;return{extent:i,width:s,height:n,x:Math.round((e.x-i.xmin)/p),y:Math.round((i.ymax-e.y)/p)}}getFetchOptions(){return{timeExtent:this.timeExtent}}};l=e([r("esri.views.3d.layers.WMSLayerView3D")],l);const u=l;export{u as default};
