import{s as e,S as r,T as s,C as o,ks as i,e as a,y as u,a as h,ho as n,kt as _,kn as l,ko as y,g as p,P as R}from"./index-DSIPxOWi.js";import{t as v}from"./LineVisualElement-EjMrPPob.js";class d{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1,this._renderGroup=i.Outline}destroy(){this._destroyResources()}get resources(){return null!=this._resources?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}get renderGroup(){return this._renderGroup}set renderGroup(e){var r;this._renderGroup=e;const s=null==(r=this._resources)?void 0:r.layerView;s&&(s.renderGroup=e)}recreate(){this.attached&&this._createResources()}recreateGeometry(){this._resourceFactory.recreateGeometry?null!=this._resources&&(this._ensureRenderGeometriesRemoved(),this._resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?null==this._resources&&this._createResources():this._destroyResources()}_createResources(){var e;this._destroyResources();const r=this._resourceFactory.createResources(),s=new m({view:this._resourceFactory.view,renderGroup:this._renderGroup}),o=null==(e=this._resourceFactory.view.basemapTerrain)?void 0:e.overlayManager;this._resources={layerView:new m({view:this._resourceFactory.view,renderGroup:this._renderGroup}),external:r,geometriesAdded:!1},o&&(this._resources.drapeSourceRenderer=o.registerGeometryDrapeSource(s)),this._syncGeometriesToRenderer()}_destroyResources(){var e;if(null==this._resources)return;this._ensureRenderGeometriesRemoved();const r=null==(e=this._resourceFactory.view.basemapTerrain)?void 0:e.overlayManager;r&&r.unregisterDrapeSource(this._resources.layerView),this._resourceFactory.destroyResources(this._resources.external),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){var e;null!=(null==(e=this._resources)?void 0:e.drapeSourceRenderer)&&this._resources.geometriesAdded&&(this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,n.UPDATE),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){var e;null!=(null==(e=this._resources)?void 0:e.drapeSourceRenderer)&&(this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,n.UPDATE),this._resources.geometriesAdded=!0))}}let m=class extends(e(r)){constructor(e){super(e),this.drapeSourceType=s.Features,this.updatePolicy=o.SYNC,this.renderGroup=i.Outline}};a([u({constructOnly:!0})],m.prototype,"view",void 0),a([u({readOnly:!0})],m.prototype,"drapeSourceType",void 0),a([u()],m.prototype,"renderGroup",void 0),m=a([h("esri.views.3d.interactive.visualElements.DrapedVisualElementResources")],m);class c{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return null!=this._resources?this._resources.object:null}get resources(){return null!=this._resources?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this._resourceFactory.recreateGeometry)return void this.recreate();const e=this._resourceFactory.view._stage;if(null==this._resources||!e)return;const r=this._resources.object;this._resources.external.forEach((r=>{r.type!==_.Mesh&&r.type!==_.Line&&r.type!==_.Point||e.remove(r)})),r.removeAllGeometries(),this._resourceFactory.recreateGeometry(this._resources.external,r,this._resources.layer),this._resources.external.forEach((r=>{r.type!==_.Mesh&&r.type!==_.Line&&r.type!==_.Point||e.add(r)}))}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this._resourceFactory,r=e.view,s=r._stage;if(!s)return;const i=new l(s,{pickable:!1,updatePolicy:o.SYNC}),a=new y({castShadow:!1}),u=e.createResources(a,i);u.forEach((e=>{s.add(e),e.type===_.Texture&&e.load(s.renderView.renderingContext)})),s.add(a),i.add(a);const h=e.cameraChanged,n=h?p((()=>r.state.camera),(e=>h(e)),R):null;this._resources={layer:i,object:a,external:u,cameraHandle:n},this._syncVisible()}_destroyResources(){var e;if(null==this._resources)return;const r=this._resourceFactory.view._stage;r&&(r.remove(this._resources.object),this._resources.layer.destroy(),this._resources.external.forEach((e=>{r.remove(e),e.type===_.Texture&&e.unload()}))),this._resources.object.dispose(),null==(e=this._resources.cameraHandle)||e.remove(),this._resourceFactory.destroyResources(this._resources.external),this._resources=null}_syncVisible(){null!=this._resources&&(this._resources.object.visible=this._visible)}}class t extends v{constructor(e){super(e),this._isDraped=!1,this.object3dResources=new c(this.createObject3DResourceFactory(e.view)),this.drapedResources=new d(this.createDrapedResourceFactory(e.view)),this.isDraped=e.isDraped??!1}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this.object3dResources.attached=this.attached&&!e,this.drapedResources.attached=this.attached&&e)}get renderGroup(){return this.drapedResources.renderGroup}set renderGroup(e){this.drapedResources.renderGroup=e}createResources(){this.object3dResources.attached=!this._isDraped,this.drapedResources.attached=this._isDraped}destroyResources(){this.object3dResources.attached=!1,this.drapedResources.attached=!1}recreate(){this.object3dResources.recreate(),this.drapedResources.recreate()}recreateGeometry(){this.object3dResources.recreateGeometry(),this.drapedResources.recreateGeometry()}destroy(){this.object3dResources.destroy(),this.drapedResources.destroy(),super.destroy()}updateVisibility(e){this.object3dResources.visible=e,this.drapedResources.visible=e}}export{t};
